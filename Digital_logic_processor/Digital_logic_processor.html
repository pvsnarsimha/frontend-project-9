<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Logic Gates Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add to head section -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --primary-color: #894a1c;
            --secondary-color: #A0522D;
            --success-color: #228B22;
            --success-dark: #1a6c1a;
            --danger-color: #DC143C;
            --warning-color: #FF8C00;
            --info-color: #87CEEB;
            --dark-color: #2F4F4F;
            --light-color: #F5F5DC;
        }

        body {
            background: linear-gradient(135deg, #140ec3bb 0%, #0babd7 100%);
            color: #2F4F4F;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(139, 69, 19, 0.1);
            box-shadow: 0 8px 32px rgba(139, 69, 19, 0.15);
            padding: 20px;
            margin-bottom: 20px;
        }

        .gate-diagram-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            padding: 20px;
            margin: 20px 0;
            transition: all 0.5s ease;
            gap: 20px;
        }

        .gate-visualization {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 250px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            margin: 0 auto;
            overflow: hidden;
        }

        /* Gate Symbols Styling */
        .gate-symbol-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Standard Logic Gate Shapes */
        .gate-shape {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
        }

        /* AND Gate Shape */
        .gate-and {
            background: var(--primary-color);
            border-radius: 10px 50px 50px 10px;
            clip-path: polygon(0% 0%, 70% 0%, 100% 50%, 70% 100%, 0% 100%);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .gate-and::after {
            content: '';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid var(--primary-color);
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
        }

        /* OR Gate Shape */
        .gate-or {
            background: var(--primary-color);
            border-radius: 50%;
            clip-path: circle(50% at 70% 50%);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .gate-or::before {
            content: '';
            position: absolute;
            left: -40px;
            top: 0;
            width: 80px;
            height: 100%;
            background: var(--primary-color);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
        }

        /* NOT Gate Shape */
        .gate-not {
            background: var(--primary-color);
            border-radius: 10px;
            width: 80px;
            height: 80px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .gate-not::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        /* NAND Gate Shape */
        .gate-nand {
            background: var(--primary-color);
            border-radius: 10px 50px 50px 10px;
            clip-path: polygon(0% 0%, 70% 0%, 100% 50%, 70% 100%, 0% 100%);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .gate-nand::after {
            content: '';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        /* NOR Gate Shape */
        .gate-nor {
            background: var(--primary-color);
            border-radius: 50%;
            clip-path: circle(50% at 70% 50%);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .gate-nor::before {
            content: '';
            position: absolute;
            left: -40px;
            top: 0;
            width: 80px;
            height: 100%;
            background: var(--primary-color);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
        }

        .gate-nor::after {
            content: '';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        /* XOR Gate Shape */
        .gate-xor {
            background: var(--primary-color);
            border-radius: 50%;
            clip-path: circle(50% at 70% 50%);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .gate-xor::before {
            content: '';
            position: absolute;
            left: -40px;
            top: 0;
            width: 80px;
            height: 100%;
            background: var(--primary-color);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
        }

        .gate-xor::after {
            content: '';
            position: absolute;
            left: -50px;
            top: 0;
            width: 10px;
            height: 100%;
            background: var(--primary-color);
            border-radius: 5px;
        }

        /* XNOR Gate Shape */
        .gate-xnor {
            background: var(--primary-color);
            border-radius: 50%;
            clip-path: circle(50% at 70% 50%);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .gate-xnor::before {
            content: '';
            position: absolute;
            left: -40px;
            top: 0;
            width: 80px;
            height: 100%;
            background: var(--primary-color);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
        }

        .gate-xnor::after {
            content: '';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        .gate-xnor::before {
            content: '';
            position: absolute;
            left: -50px;
            top: 0;
            width: 10px;
            height: 100%;
            background: var(--primary-color);
            border-radius: 5px;
        }

        /* Gate Label */
        .gate-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            z-index: 5;
        }

        .input-node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.5s ease;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
            left: 20%;
        }

        .input-node.active {
            background: var(--success-color);
            transform: translateY(-50%) scale(1.2);
            box-shadow: 0 0 25px var(--success-color);
            animation: pulse 0.5s ease;
        }

        .input-node.inactive {
            background: var(--success-dark);
            transform: translateY(-50%) scale(1);
        }

        .output-node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.5s ease;
            z-index: 20;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
            right: 20%;
        }

        .output-node.active {
            background: var(--success-color);
            transform: translateY(-50%) scale(1.2);
            box-shadow: 0 0 25px var(--success-color);
            animation: pulse 0.5s ease;
        }

        .output-node.inactive {
            background: var(--success-dark);
            transform: translateY(-50%) scale(1);
        }

        .connection-line {
            position: absolute;
            height: 8px;
            background: var(--primary-color);
            top: 50%;
            transform: translateY(-50%);
            z-index: 5;
            transition: all 0.5s ease;
            border-radius: 4px;
        }

        .connection-line.active {
            background: var(--success-color);
            box-shadow: 0 0 15px rgba(34, 139, 34, 0.7);
        }

        .connection-line.inactive {
            background: var(--success-dark);
        }

        .btn-glow {
            background: linear-gradient(45deg, var(--primary-color), var(--info-color));
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-glow:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        }

        .btn-glow:active {
            transform: translateY(1px);
        }

        .gate-selection-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .gate-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 15px 20px;
            color: var(--dark-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 120px;
        }

        .gate-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(139, 69, 19, 0.2);
            background: var(--primary-color);
            color: white;
        }

        .gate-btn.active {
            background: var(--primary-color);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(139, 69, 19, 0.3);
        }

        .gate-btn i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        .truth-table-container {
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .truth-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            overflow: hidden;
        }

        .truth-table th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .truth-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(139, 69, 19, 0.1);
            transition: all 0.3s ease;
        }

        .truth-table tr:last-child td {
            border-bottom: none;
        }

        .truth-table tr:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .truth-table td.active {
            background: var(--success-color);
            color: white;
            font-weight: bold;
        }

        .truth-table td.inactive {
            background: var(--success-dark);
            color: white;
            font-weight: bold;
        }

        .input-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
        }

        .input-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--success-dark);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .input-label {
            font-weight: bold;
            color: var(--dark-color);
            min-width: 80px;
        }

        .operation-log {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid rgba(139, 69, 19, 0.1);
        }

        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            animation: slideIn 0.3s ease;
            color: #2F4F4F;
        }

        .log-success {
            border-left: 4px solid var(--success-color);
        }

        .log-info {
            border-left: 4px solid var(--info-color);
        }

        .log-error {
            border-left: 4px solid var(--danger-color);
        }

        .animation-explanation {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid var(--warning-color);
            animation: slideIn 0.5s ease;
            min-height: 100px;
            display: none;
        }

        .formula-display {
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border: 2px solid var(--primary-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .formula-step {
            font-size: 1.1rem;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            border-left: 3px solid var(--info-color);
            animation: slideIn 0.3s ease;
        }

        .formula-step.active {
            border-left: 3px solid var(--success-color);
            background: rgba(34, 139, 34, 0.1);
            font-weight: bold;
        }

/* Add to existing styles */
#boolean-algebra-section {
    animation: slideIn 0.5s ease;
}

.boolean-operation {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid var(--info-color);
}

.boolean-operation-title {
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.boolean-operation-result {
    font-family: 'Courier New', monospace;
    background: rgba(255, 255, 255, 0.9);
    padding: 8px;
    border-radius: 5px;
    margin: 5px 0;
}

.law-result {
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    background: rgba(255, 255, 255, 0.9);
}

.law-verified {
    border-left: 4px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
}

.law-failed {
    border-left: 4px solid var(--danger-color);
    background: rgba(220, 20, 60, 0.1);
}
.calculation-step {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid var(--info-color);
    transition: all 0.3s ease;
    opacity: 0.7;
}

.calculation-step.active {
    border-left: 4px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
    opacity: 1;
    transform: scale(1.02);
    box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
}


        .calculation-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .calculation-content {
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            line-height: 1.6;
        }

        .highlight-equation {
            background: rgba(255, 140, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            animation: pulse 0.5s ease;
        }

        .input-count-control {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }

        .input-count-input {
            width: 100px;
            padding: 8px;
            border-radius: 5px;
            border: 2px solid var(--primary-color);
            text-align: center;
            font-weight: bold;
        }

        .animation-progress {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px 15px;
            margin: 10px 0;
            border-left: 4px solid var(--info-color);
        }

        .progress-bar {
            height: 10px;
            background-color: var(--success-dark);
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        .step-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: none;
            z-index: 100;
        }

        .timer-display {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px 15px;
            margin: 10px 0;
            border-left: 4px solid var(--danger-color);
            font-size: 0.9rem;
            text-align: center;
            font-weight: bold;
        }

        @keyframes pulse {
            0% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.3); }
            100% { transform: translateY(-50%) scale(1.2); }
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes highlight {
            0% { transform: scale(1); box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3); }
            50% { transform: scale(1.2); box-shadow: 0 0 25px var(--warning-color); }
            100% { transform: scale(1); box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3); }
        }

        .highlight {
            animation: highlight 1s ease;
        }

        .title-animation {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .gate-description {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--info-color);
            font-style: italic;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid rgba(139, 69, 19, 0.1);
        }

        .stats-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .keyboard-shortcut {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px 15px;
            margin: 10px 0;
            border-left: 4px solid var(--warning-color);
            font-size: 0.9rem;
        }

        .shortcut-key {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 5px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .gate-visualization {
                height: 200px;
            }
            
            .gate-symbol-container {
                width: 100px;
                height: 80px;
            }
            
            .gate-label {
                font-size: 1.2rem;
            }
            
            .input-node, .output-node {
                width: 40px;
                height: 40px;
            }
            
            .gate-btn {
                min-width: 100px;
                padding: 12px 15px;
            }
            
            .input-node {
                left: 15%;
            }
            
            .output-node {
                right: 15%;
            }
            
            .formula-display {
                font-size: 1rem;
                padding: 8px;
            }
        }
 /* Add these to your existing CSS */

/* K-map table styles */
.kmap-table {
    overflow-x: auto;
    margin: 20px 0;
    padding: 15px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    border: 2px solid var(--primary-color);
}

.kmap-table table {
    margin: 0 auto;
    border-collapse: collapse;
    min-width: 300px;
}

.kmap-table th {
    background: var(--primary-color);
    color: white;
    padding: 12px;
    min-width: 50px;
}

.kmap-table td {
    padding: 15px;
    font-size: 1.2rem;
    font-weight: bold;
    border: 2px solid #dee2e6;
}

/* Grouping analysis styles */
.grouping-analysis {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    border-left: 4px solid var(--info-color);
}

/* Input styles for combinational logic */
#boolean-expression-input,
#minterms-input,
#dontcare-input {
    background: white;
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 10px;
    font-family: 'Courier New', monospace;
    font-size: 1rem;
}

#boolean-expression-input:focus,
#minterms-input:focus,
#dontcare-input:focus {
    border-color: var(--success-color);
    box-shadow: 0 0 0 0.2rem rgba(34, 139, 34, 0.25);
    outline: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .kmap-table {
        padding: 10px;
    }
    
    .kmap-table th,
    .kmap-table td {
        padding: 8px;
        font-size: 1rem;
    }
    
    #boolean-expression-input,
    #minterms-input,
    #dontcare-input {
        font-size: 0.9rem;
        padding: 8px;
    }
}   
/* Add to existing CSS */
.conversion-results {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid var(--info-color);
}

.conversion-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 5px;
    padding: 10px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    font-family: 'Courier New', monospace;
}

.conversion-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
}

.bit-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: white;
    border: 1px solid #dee2e6;
}

.bit-table th, .bit-table td {
    padding: 8px;
    text-align: center;
    border: 1px solid #dee2e6;
}

.bit-table th {
    background: var(--primary-color);
    color: white;
}

.bit-index {
    background: #f8f9fa;
    font-weight: bold;
}

.xor-operation {
    color: var(--danger-color);
    font-weight: bold;
}

.bit-value {
    font-weight: bold;
    color: var(--primary-color);
}    
/* Add to existing CSS */
.parity-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.parity-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.parity-count {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: var(--primary-color);
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(139, 69, 19, 0.1);
}

.parity-bit {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: var(--success-color);
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(34, 139, 34, 0.1);
    animation: pulse 0.5s ease;
}

.parity-error {
    border-left: 3px solid var(--danger-color);
    background: rgba(220, 20, 60, 0.1);
}

.parity-explanation {
    font-size: 0.9rem;
    color: #555;
    margin-top: 5px;
    padding-left: 10px;
    border-left: 2px solid var(--info-color);
}
/* Arithmetic Operations Styles */
.adder-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid var(--info-color);
    transition: all 0.3s ease;
}

.adder-step.active {
    border-left: 4px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.adder-operation {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: var(--primary-color);
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(139, 69, 19, 0.1);
}

.adder-result {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: var(--success-color);
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(34, 139, 34, 0.1);
    animation: pulse 0.5s ease;
}

/* Adder Gate Visualization */
.adder-gate {
    position: relative;
    width: 150px;
    height: 100px;
    background: var(--primary-color);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    margin: 0 auto;
}

.half-adder-gate::before {
    content: 'HA';
    font-size: 1.5rem;
    font-weight: bold;
}

.full-adder-gate::before {
    content: 'FA';
    font-size: 1.5rem;
    font-weight: bold;
}

.adder-input-node {
    position: absolute;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--success-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    border: 2px solid white;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 20;
}

.adder-input-node.active {
    background: var(--success-color);
    transform: scale(1.2);
    box-shadow: 0 0 15px var(--success-color);
}

.adder-output-node {
    position: absolute;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--success-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    border: 2px solid white;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    z-index: 20;
}

.adder-output-node.active {
    background: var(--success-color);
    transform: scale(1.2);
    box-shadow: 0 0 15px var(--success-color);
}

.adder-connection {
    position: absolute;
    height: 6px;
    background: var(--primary-color);
    border-radius: 3px;
    transition: all 0.3s ease;
}

.adder-connection.active {
    background: var(--success-color);
    box-shadow: 0 0 10px rgba(34, 139, 34, 0.5);
}
/* Add to existing CSS */
.binary-operation-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
    font-family: 'Courier New', monospace;
}

.binary-operation-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.binary-operation-step.error {
    border-left: 3px solid var(--danger-color);
    background: rgba(220, 20, 60, 0.1);
}

.binary-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: white;
    border: 1px solid #dee2e6;
}

.binary-table th, .binary-table td {
    padding: 8px;
    text-align: center;
    border: 1px solid #dee2e6;
    font-family: 'Courier New', monospace;
}

.binary-table th {
    background: var(--primary-color);
    color: white;
    font-weight: bold;
}

.binary-bit {
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 3px;
}

.binary-bit-1 {
    background: var(--success-color);
    color: white;
}

.binary-bit-0 {
    background: #f8f9fa;
    color: var(--dark-color);
}

.binary-carry {
    color: var(--warning-color);
    font-weight: bold;
}

.binary-overflow {
    background: rgba(255, 193, 7, 0.2);
    border: 1px solid var(--warning-color);
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    color: var(--dark-color);
}

.binary-input-section {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    border: 2px solid var(--primary-color);
}

.binary-input-group {
    margin-bottom: 20px;
}

.binary-input-label {
    font-weight: bold;
    margin-bottom: 8px;
    display: block;
    color: var(--primary-color);
}

.binary-input-box {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    text-align: center;
}

.binary-input-box:focus {
    border-color: var(--success-color);
    box-shadow: 0 0 0 0.2rem rgba(34, 139, 34, 0.25);
    outline: none;
}

.binary-input-box.error {
    border-color: var(--danger-color);
    background: rgba(220, 20, 60, 0.05);
}

.binary-operation-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
}

.binary-bit-select {
    padding: 8px 12px;
    border: 2px solid var(--primary-color);
    border-radius: 5px;
    background: white;
    font-weight: bold;
}
/* Complement Operations Styles */
.complement-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.complement-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.complement-bit {
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 3px;
}

.complement-original {
    background: var(--primary-color);
    color: white;
}

.complement-inverted {
    background: var(--warning-color);
    color: white;
}

.complement-result {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: var(--success-color);
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(34, 139, 34, 0.1);
    animation: pulse 0.5s ease;
}
/* Multiplexer & Decoder Styles */
.mux-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.mux-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.mux-bit {
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
}

.mux-input {
    background: var(--primary-color);
    color: white;
}

.mux-select {
    background: var(--warning-color);
    color: white;
}

.mux-output {
    background: var(--success-color);
    color: white;
    animation: pulse 0.5s ease;
}

.mux-formula {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: var(--primary-color);
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(139, 69, 19, 0.1);
}

/* Add to existing decoder-outputs styles */
.decoder-outputs {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 10px 0;
    flex-wrap: wrap;
}

.decoder-output {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    border: 2px solid white;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
}

.decoder-output.active {
    background: var(--success-color);
    transform: scale(1.2);
    box-shadow: 0 0 15px var(--success-color);
}

.decoder-output.inactive {
    background: var(--success-dark);
}
/* Priority Encoder Styles */
.priority-encoder-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.priority-encoder-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.priority-input {
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
}

.priority-output {
    background: var(--success-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    animation: pulse 0.5s ease;
}

.priority-highlight {
    background: var(--warning-color);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
}

.priority-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: white;
}

.priority-table th, .priority-table td {
    padding: 8px;
    text-align: center;
    border: 1px solid #dee2e6;
}

.priority-table th {
    background: var(--primary-color);
    color: white;
}

.priority-active {
    background: rgba(34, 139, 34, 0.2);
    font-weight: bold;
}

.priority-selected {
    background: var(--warning-color);
    color: white;
    font-weight: bold;
}
/* MUX/DECODER Circuit Styles */
.circuit-diagram-container {
    position: relative;
    width: 100%;
    height: 400px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    margin: 20px auto;
    overflow: hidden;
    border: 2px solid var(--primary-color);
}

.mux-circuit {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 20px auto;
}

.mux-body {
    position: absolute;
    width: 120px;
    height: 200px;
    background: var(--primary-color);
    border-radius: 10px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.mux-input-line {
    position: absolute;
    width: 60px;
    height: 6px;
    background: var(--primary-color);
    border-radius: 3px;
    left: -60px;
    transition: all 0.3s ease;
}

.mux-output-line {
    position: absolute;
    width: 60px;
    height: 6px;
    background: var(--primary-color);
    border-radius: 3px;
    right: -60px;
    transition: all 0.3s ease;
}

.mux-select-line {
    position: absolute;
    width: 6px;
    height: 80px;
    background: var(--warning-color);
    border-radius: 3px;
    top: 50%;
    transform: translateY(-50%);
    left: -40px;
    transition: all 0.3s ease;
}

.decoder-circuit {
    position: relative;
    width: 250px;
    height: 350px;
    margin: 20px auto;
}

.decoder-body {
    position: absolute;
    width: 100px;
    height: 300px;
    background: var(--primary-color);
    border-radius: 10px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.decoder-input-line {
    position: absolute;
    width: 50px;
    height: 6px;
    background: var(--primary-color);
    border-radius: 3px;
    left: -50px;
    transition: all 0.3s ease;
}

.decoder-output-line {
    position: absolute;
    width: 60px;
    height: 6px;
    background: var(--primary-color);
    border-radius: 3px;
    right: -60px;
    transition: all 0.3s ease;
}

.circuit-node {
    position: absolute;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--success-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    border: 2px solid white;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    z-index: 20;
}

.circuit-node.active {
    background: var(--success-color);
    transform: scale(1.2);
    box-shadow: 0 0 15px var(--success-color);
}

.circuit-line {
    position: absolute;
    height: 6px;
    background: var(--primary-color);
    border-radius: 3px;
    transition: all 0.3s ease;
}

.circuit-line.active {
    background: var(--success-color);
    box-shadow: 0 0 10px rgba(34, 139, 34, 0.5);
}

.circuit-label {
    position: absolute;
    color: var(--dark-color);
    font-weight: bold;
    font-size: 0.9rem;
    white-space: nowrap;
}

.priority-encoder-circuit {
    position: relative;
    width: 350px;
    height: 300px;
    margin: 20px auto;
}

.encoder-body {
    position: absolute;
    width: 150px;
    height: 200px;
    background: var(--primary-color);
    border-radius: 10px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.demux-circuit {
    position: relative;
    width: 300px;
    height: 250px;
    margin: 20px auto;
}

.demux-body {
    position: absolute;
    width: 120px;
    height: 150px;
    background: var(--primary-color);
    border-radius: 10px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.circuit-truth-table {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 20px;
}
/* Sequential Logic Styles */
.sequential-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.sequential-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.sequential-state {
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
}

.state-0 {
    background: var(--primary-color);
    color: white;
}

.state-1 {
    background: var(--success-color);
    color: white;
}

.state-transition {
    color: var(--warning-color);
    font-weight: bold;
}

.clock-edge {
    animation: pulse 0.5s ease;
    color: var(--danger-color);
    font-weight: bold;
}

/* Sequential Circuit Styles */
.latch-circuit {
    position: relative;
    width: 300px;
    height: 200px;
    margin: 20px auto;
}

.nand-gate {
    position: absolute;
    width: 80px;
    height: 60px;
    background: var(--primary-color);
    border-radius: 10px 50px 50px 10px;
    clip-path: polygon(0% 0%, 70% 0%, 100% 50%, 70% 100%, 0% 100%);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
}

.nand-gate::after {
    content: '';
    position: absolute;
    right: -10px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    background: var(--primary-color);
    border-radius: 50%;
}

.flipflop-circuit {
    position: relative;
    width: 350px;
    height: 250px;
    margin: 20px auto;
}

.flipflop-body {
    position: absolute;
    width: 120px;
    height: 80px;
    background: var(--primary-color);
    border-radius: 10px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.5rem;
}

.sequential-input-line {
    position: absolute;
    width: 50px;
    height: 6px;
    background: var(--primary-color);
    border-radius: 3px;
    left: -50px;
    transition: all 0.3s ease;
}

.sequential-output-line {
    position: absolute;
    width: 50px;
    height: 6px;
    background: var(--primary-color);
    border-radius: 3px;
    right: -50px;
    transition: all 0.3s ease;
}

.sequential-node {
    position: absolute;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--success-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    border: 2px solid white;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    z-index: 20;
}

.sequential-node.active {
    background: var(--success-color);
    transform: scale(1.2);
    box-shadow: 0 0 15px var(--success-color);
}

.clock-symbol {
    position: absolute;
    color: var(--danger-color);
    font-size: 1.5rem;
    font-weight: bold;
    animation: pulse 2s infinite;
}

/* State Diagram Styles */
.state-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    margin: 10px;
    border: 3px solid var(--primary-color);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.state-circle.active {
    border-color: var(--success-color);
    background: rgba(34, 139, 34, 0.1);
}

.transition-arrow {
    font-size: 1.5rem;
    color: var(--warning-color);
    font-weight: bold;
    margin: 0 15px;
}

.state-diagram-container {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    padding: 20px;
}

.state-row {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 10px 0;
    width: 100%;
}
/* Add these styles to your existing CSS */
/* Add these styles to your existing CSS */
.register-bit {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    margin: 2px;
    border: 2px solid var(--primary-color);
    transition: all 0.3s ease;
}

.register-bit.active {
    background: var(--success-color);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 0 10px var(--success-color);
}

.register-bit.inactive {
    background: var(--success-dark);
    color: white;
}

.register-bit-label {
    font-size: 0.8rem;
    margin-top: 2px;
    color: var(--dark-color);
}

.shift-animation {
    animation: shiftMove 0.5s ease-in-out;
}

@keyframes shiftMove {
    0% { transform: translateX(0) scale(1); }
    50% { transform: translateX(20px) scale(1.1); }
    100% { transform: translateX(0) scale(1); }
}

/* Realistic Circuit Styles */
.realistic-circuit-container {
    position: relative;
    width: 100%;
    height: 400px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    border: 2px solid var(--primary-color);
    overflow: hidden;
    margin: 20px auto;
}

.circuit-board {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, #f8f9fa 25%, #e9ecef 25%, #e9ecef 50%, #f8f9fa 50%, #f8f9fa 75%, #e9ecef 75%);
    background-size: 20px 20px;
    opacity: 0.3;
    z-index: 1;
}

.circuit-track {
    position: absolute;
    background: linear-gradient(90deg, #8B4513, #A0522D, #8B4513);
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 2;
}

.circuit-track.active {
    background: linear-gradient(90deg, #228B22, #32CD32, #228B22);
    box-shadow: 0 0 10px rgba(34, 139, 34, 0.5);
}

.circuit-track.inactive {
    background: linear-gradient(90deg, #2F4F4F, #556B2F, #2F4F4F);
}

.ic-package {
    position: absolute;
    background: linear-gradient(135deg, #D4AF37, #FFD700, #D4AF37);
    border-radius: 8px;
    border: 2px solid #8B4513;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 10;
}

.ic-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #8B4513;
    font-weight: bold;
    font-size: 0.9rem;
    text-align: center;
}

.ic-pin {
    position: absolute;
    width: 12px;
    height: 24px;
    background: linear-gradient(90deg, #C0C0C0, #FFFFFF, #C0C0C0);
    border: 1px solid #808080;
    border-radius: 3px;
    z-index: 9;
}

.flipflop-symbol {
    position: absolute;
    width: 80px;
    height: 60px;
    background: linear-gradient(135deg, #4169E1, #87CEEB, #4169E1);
    border: 2px solid #1E90FF;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 11;
}

.gate-symbol-real {
    position: absolute;
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border: 2px solid #8B4513;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 12;
}

.d-flipflop-real {
    position: absolute;
    width: 100px;
    height: 80px;
    background: linear-gradient(135deg, #4682B4, #87CEEB);
    border: 2px solid #1E90FF;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.1rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 12;
}

.clock-symbol-real {
    position: absolute;
    width: 30px;
    height: 30px;
    background: radial-gradient(circle, #FF4500, #FF6347);
    border: 2px solid #DC143C;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    animation: clockPulse 2s infinite;
    z-index: 13;
}

@keyframes clockPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.4); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(220, 20, 60, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 20, 60, 0); }
}

.circuit-connection {
    position: absolute;
    background: #8B4513;
    border-radius: 2px;
    z-index: 3;
}

.circuit-connection.active {
    background: #228B22;
    box-shadow: 0 0 8px rgba(34, 139, 34, 0.6);
}

.input-pad {
    position: absolute;
    width: 30px;
    height: 30px;
    background: radial-gradient(circle, #32CD32, #228B22);
    border: 2px solid #006400;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 15;
}

.output-pad {
    position: absolute;
    width: 35px;
    height: 35px;
    background: radial-gradient(circle, #4169E1, #1E90FF);
    border: 2px solid #00008B;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 15;
}

.circuit-label-real {
    position: absolute;
    color: var(--dark-color);
    font-weight: bold;
    font-size: 0.85rem;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 6px;
    border-radius: 3px;
    border: 1px solid var(--primary-color);
    z-index: 20;
    white-space: nowrap;
}

.register-cell-real {
    position: absolute;
    width: 50px;
    height: 40px;
    background: linear-gradient(135deg, #4682B4, #87CEEB);
    border: 2px solid #1E90FF;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 12;
}

.register-cell-real.active {
    background: linear-gradient(135deg, #32CD32, #228B22);
    border-color: #006400;
    transform: scale(1.05);
    box-shadow: 0 0 8px rgba(34, 139, 34, 0.6);
}

.data-bus {
    position: absolute;
    height: 8px;
    background: linear-gradient(90deg, #8B4513, #A0522D, #8B4513);
    border-radius: 4px;
    z-index: 5;
}

.data-bus.active {
    background: linear-gradient(90deg, #228B22, #32CD32, #228B22);
    box-shadow: 0 0 10px rgba(34, 139, 34, 0.5);
}

.control-line {
    position: absolute;
    height: 4px;
    background: linear-gradient(90deg, #DC143C, #FF6347, #DC143C);
    border-radius: 2px;
    z-index: 5;
}

.control-line.active {
    background: linear-gradient(90deg, #FF8C00, #FFA500, #FF8C00);
    box-shadow: 0 0 8px rgba(255, 140, 0, 0.6);
}

.shift-arrow-real {
    position: absolute;
    color: var(--warning-color);
    font-size: 1.5rem;
    font-weight: bold;
    z-index: 15;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.mux-symbol {
    position: absolute;
    width: 60px;
    height: 40px;
    background: linear-gradient(135deg, #9370DB, #DDA0DD);
    border: 2px solid #8A2BE2;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 12;
}
/* Number System Conversion Styles */
.conversion-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
    font-family: 'Courier New', monospace;
}

.conversion-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.conversion-step.error {
    border-left: 3px solid var(--danger-color);
    background: rgba(220, 20, 60, 0.1);
}

.conversion-group {
    background: rgba(139, 69, 19, 0.1);
    border-radius: 5px;
    padding: 10px;
    margin: 5px 0;
    border: 1px solid rgba(139, 69, 19, 0.2);
}

.binary-bit-highlight {
    background: var(--warning-color);
    color: white;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: bold;
}

.decimal-highlight {
    background: var(--success-color);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
}

.hex-highlight {
    background: var(--info-color);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
}

.octal-highlight {
    background: var(--primary-color);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
}

.bcd-digit {
    background: rgba(139, 69, 19, 0.2);
    border: 1px solid var(--primary-color);
    border-radius: 3px;
    padding: 4px 8px;
    margin: 0 2px;
    font-weight: bold;
}

.conversion-formula {
    font-family: 'Courier New', monospace;
    background: rgba(255, 255, 255, 0.95);
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    border-left: 3px solid var(--primary-color);
}

.practice-question {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid var(--warning-color);
}

.question-number {
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 10px;
}

.question-text {
    margin-bottom: 15px;
}

.question-options {
    margin: 10px 0;
}

.question-option {
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 5px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(139, 69, 19, 0.2);
    cursor: pointer;
    transition: all 0.3s ease;
}

.question-option:hover {
    background: rgba(139, 69, 19, 0.1);
}

.question-option.correct {
    background: rgba(34, 139, 34, 0.2);
    border-color: var(--success-color);
    font-weight: bold;
}

.question-option.incorrect {
    background: rgba(220, 20, 60, 0.1);
    border-color: var(--danger-color);
}

.question-explanation {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid rgba(139, 69, 19, 0.2);
    font-size: 0.9rem;
    color: #555;
}

/* Timer for practice tests */
.practice-timer {
    background: rgba(220, 20, 60, 0.1);
    border-radius: 10px;
    padding: 10px 15px;
    margin: 10px 0;
    text-align: center;
    font-weight: bold;
    color: var(--danger-color);
    border: 2px solid var(--danger-color);
}

.practice-stats {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    margin: 10px 0;
}

.practice-stat {
    text-align: center;
}

.practice-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-color);
}

/* GATE specific styling */
.gate-question {
    background: linear-gradient(135deg, rgba(139, 69, 19, 0.1), rgba(34, 139, 34, 0.1));
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    border: 2px solid var(--primary-color);
    position: relative;
}

.gate-year {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: bold;
}

.gate-difficulty {
    position: absolute;
    top: 10px;
    left: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: bold;
}

.difficulty-easy {
    background: var(--success-color);
    color: white;
}

.difficulty-medium {
    background: var(--warning-color);
    color: white;
}

.difficulty-hard {
    background: var(--danger-color);
    color: white;
}

/* Bit visualization */
.bit-visualization {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    margin: 15px 0;
}

.bit-box {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
    border: 2px solid var(--primary-color);
    margin: 2px;
    border-radius: 5px;
    transition: all 0.3s ease;
}

.bit-box.active {
    background: var(--success-color);
    color: white;
    transform: scale(1.1);
}

.bit-box.inactive {
    background: #f8f9fa;
    color: var(--dark-color);
}

.bit-index {
    font-size: 0.8rem;
    color: #777;
    margin-top: 2px;
    text-align: center;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
    .bit-box {
        width: 30px;
        height: 30px;
        font-size: 0.9rem;
    }
    
    .conversion-step {
        padding: 8px;
        font-size: 0.9rem;
    }
    
    .gate-question {
        padding: 15px;
    }
}
.hex-highlight {
    background: var(--info-color);
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 1.2rem;
}

.bit-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: white;
    border: 1px solid #dee2e6;
}

.bit-table th, .bit-table td {
    padding: 8px;
    text-align: center;
    border: 1px solid #dee2e6;
}

.bit-table th {
    background: var(--primary-color);
    color: white;
    font-weight: bold;
}

.binary-table h6 {
    text-align: center;
    margin-bottom: 10px;
    color: var(--primary-color);
    font-weight: bold;
}
/* Add to your existing CSS */
.multiplication-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--warning-color);
    transition: all 0.3s ease;
}

.multiplication-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.partial-product {
    font-family: 'Courier New', monospace;
    background: rgba(255, 140, 0, 0.1);
    border: 1px solid var(--warning-color);
    border-radius: 4px;
    padding: 4px 8px;
    margin: 2px;
    font-weight: bold;
}
/* Add to existing CSS after XNOR gate styles */

/* Tri-State Buffer Shape */
.gate-tristate {
    background: var(--primary-color);
    border-radius: 10px;
    width: 100px;
    height: 80px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    position: relative;
}

.gate-tristate::before {
    content: '';
    position: absolute;
    left: -10px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-right: 10px solid var(--primary-color);
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
}

.gate-tristate::after {
    content: '';
    position: absolute;
    right: -10px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 10px solid var(--primary-color);
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
}

/* Transmission Gate Shape */
.gate-transmission {
    background: var(--primary-color);
    border-radius: 5px;
    width: 120px;
    height: 60px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    position: relative;
}

.gate-transmission::before {
    content: '';
    position: absolute;
    left: -5px;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 30px;
    background: var(--primary-color);
    border-radius: 2px;
}

.gate-transmission::after {
    content: '';
    position: absolute;
    right: -5px;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 30px;
    background: var(--primary-color);
    border-radius: 2px;
}

/* Special styling for High-Z state */
.high-z-state {
    background: linear-gradient(45deg, var(--warning-color), #FFD700);
    color: white;
    animation: pulse 1.5s infinite;
}

.high-z-label {
    color: var(--warning-color);
    font-weight: bold;
    font-size: 1.1rem;
}

/* Enable input styling */
.enable-node {
    position: absolute;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    transition: all 0.5s ease;
    cursor: pointer;
    z-index: 20;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    border: 2px solid white;
    background: var(--info-color);
}

.enable-node.active {
    background: var(--success-color);
    transform: scale(1.2);
    box-shadow: 0 0 25px var(--success-color);
}

.enable-node.inactive {
    background: var(--info-color);
    transform: scale(1);
}

/* Special truth table styling for High-Z */
.truth-table td.high-z {
    background: linear-gradient(45deg, var(--warning-color), #FFD700);
    color: white;
    font-weight: bold;
    font-style: italic;
}

/* Control signal styling */
.control-line {
    height: 6px;
    background: var(--info-color);
    border-radius: 3px;
    transition: all 0.5s ease;
}

.control-line.active {
    background: var(--success-color);
    box-shadow: 0 0 15px rgba(34, 139, 34, 0.7);
}

.control-line.inactive {
    background: var(--info-color);
}
/* Add to existing CSS */
.special-analysis-step {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid var(--info-color);
    transition: all 0.3s ease;
}

.special-analysis-step.active {
    border-left: 4px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.special-highlight {
    background: var(--warning-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    display: inline-block;
    margin: 2px 0;
}

.special-example {
    background: rgba(139, 69, 19, 0.1);
    border: 1px solid rgba(139, 69, 19, 0.2);
    border-radius: 8px;
    padding: 12px;
    margin: 10px 0;
}

.special-example-title {
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 8px;
}
/* Gate PYQ Section Styles */
.gate-pyq-section {
    animation: slideIn 0.5s ease;
}

.pyq-controls {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    border: 2px solid var(--primary-color);
}

.pyq-year-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 15px 0;
}

.pyq-year-btn {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 10px 15px;
    color: var(--dark-color);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.pyq-year-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-3px);
}

.pyq-year-btn.active {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
}

.pdf-viewer-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    border: 2px solid var(--primary-color);
    min-height: 500px;
    display: flex;
    flex-direction: column;
}

.pdf-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(139, 69, 19, 0.1);
    border-radius: 8px;
}

.pdf-nav-btn {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.pdf-nav-btn:hover {
    background: var(--secondary-color);
    transform: translateY(-2px);
}

.pdf-nav-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

.pdf-page-info {
    font-weight: bold;
    color: var(--primary-color);
}

.pdf-frame {
    width: 100%;
    height: 600px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
}

.pdf-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
}

.pdf-loading i {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 15px;
    animation: pulse 1.5s infinite;
}

.pdf-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--danger-color);
    text-align: center;
}

.pdf-error i {
    font-size: 3rem;
    margin-bottom: 15px;
}

.download-options {
    display: flex;
    gap: 15px;
    margin-top: 15px;
}

.download-btn {
    background: linear-gradient(45deg, var(--success-color), var(--success-dark));
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.download-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(34, 139, 34, 0.3);
}

.download-btn.print {
    background: linear-gradient(45deg, var(--info-color), #4169E1);
}

.download-btn.save {
    background: linear-gradient(45deg, var(--warning-color), #FF8C00);
}

.pyq-info-card {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid var(--info-color);
}

.pyq-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin: 15px 0;
}

.pyq-stat {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    border: 1px solid rgba(139, 69, 19, 0.1);
}

.pyq-stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 5px;
}

.pyq-stat-label {
    font-size: 0.9rem;
    color: #666;
}

@media (max-width: 768px) {
    .pdf-frame {
        height: 400px;
    }
    
    .pdf-controls {
        flex-direction: column;
        gap: 10px;
    }
    
    .download-options {
        flex-direction: column;
    }
}
/* Add to existing CSS */
.number-system2-step {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
    font-family: 'Courier New', monospace;
}

.number-system2-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.hamming-position {
    background: var(--warning-color);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    margin: 0 2px;
}

.parity-position {
    background: var(--info-color);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    margin: 0 2px;
}

.data-position {
    background: var(--primary-color);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    margin: 0 2px;
}

.position-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: white;
    border: 1px solid #dee2e6;
}

.position-table th, .position-table td {
    padding: 10px;
    text-align: center;
    border: 1px solid #dee2e6;
    font-family: 'Courier New', monospace;
}

.position-table th {
    background: var(--primary-color);
    color: white;
    font-weight: bold;
}

.position-index {
    font-weight: bold;
    background: #f8f9fa;
}

.bit-visual {
    display: inline-block;
    width: 30px;
    height: 30px;
    line-height: 30px;
    text-align: center;
    border-radius: 4px;
    font-weight: bold;
    margin: 2px;
}

.bit-parity {
    background: var(--info-color);
    color: white;
}

.bit-data {
    background: var(--success-color);
    color: white;
}

.bit-error {
    background: var(--danger-color);
    color: white;
    animation: pulse 0.5s ease;
}

.excess-step {
    background: rgba(139, 69, 19, 0.1);
    border: 1px solid rgba(139, 69, 19, 0.2);
    border-radius: 5px;
    padding: 8px;
    margin: 5px 0;
}

.excess-highlight {
    background: rgba(255, 140, 0, 0.2);
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
}

.syndrome-bit {
    background: var(--danger-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    animation: pulse 0.5s ease;
}

.coverage-diagram {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border: 1px solid var(--info-color);
}

.coverage-row {
    display: flex;
    align-items: center;
    margin: 5px 0;
    padding: 5px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 4px;
}

.coverage-label {
    min-width: 80px;
    font-weight: bold;
    color: var(--primary-color);
}

.coverage-bits {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}
/* Master-Slave Configuration Styles */
.master-slave-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.master-slave-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.master-node {
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
}

.slave-node {
    background: var(--warning-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
}

.task-status {
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 3px;
}

.task-pending {
    background: #ffc107;
    color: #000;
}

.task-processing {
    background: #17a2b8;
    color: white;
}

.task-completed {
    background: #28a745;
    color: white;
}

.task-error {
    background: #dc3545;
    color: white;
}

.performance-bar {
    height: 10px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
    margin: 5px 0;
}

.performance-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    border-radius: 5px;
    transition: width 0.5s ease;
}
/* Add to existing CSS - Setup Time Verification Styles */
.setup-time-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.setup-time-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.setup-time-step.error {
    border-left: 3px solid var(--danger-color);
    background: rgba(220, 20, 60, 0.1);
}

.setup-time-input-group {
    margin-bottom: 15px;
}

.setup-time-label {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
    color: var(--primary-color);
}

.setup-time-input {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--primary-color);
    border-radius: 5px;
    font-family: 'Courier New', monospace;
}

.setup-time-input:focus {
    border-color: var(--success-color);
    outline: none;
}

.setup-time-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: white;
}

.setup-time-table th, .setup-time-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
}

.setup-time-table th {
    background: var(--primary-color);
    color: white;
}

.setup-time-violation {
    background: rgba(220, 20, 60, 0.1);
    color: var(--danger-color);
    font-weight: bold;
}

.setup-time-pass {
    background: rgba(34, 139, 34, 0.1);
    color: var(--success-color);
    font-weight: bold;
}

.setup-time-slack {
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 3px;
}

.slack-positive {
    background: var(--success-color);
    color: white;
}

.slack-negative {
    background: var(--danger-color);
    color: white;
}

.slack-margin {
    background: var(--warning-color);
    color: white;
}

.setup-time-controls {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.timing-diagram {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid var(--primary-color);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    position: relative;
    min-height: 200px;
}

.signal-line {
    position: absolute;
    height: 2px;
    background: var(--primary-color);
}

.clock-edge {
    position: absolute;
    width: 2px;
    height: 20px;
    background: var(--info-color);
}

.data-edge {
    position: absolute;
    width: 2px;
    height: 20px;
    background: var(--warning-color);
}

.setup-window {
    position: absolute;
    height: 30px;
    background: rgba(220, 20, 60, 0.2);
    border-radius: 3px;
}

.setup-time-result {
    font-weight: bold;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
    margin: 10px 0;
}

.result-pass {
    background: rgba(34, 139, 34, 0.2);
    color: var(--success-color);
    border: 2px solid var(--success-color);
}

.result-fail {
    background: rgba(220, 20, 60, 0.2);
    color: var(--danger-color);
    border: 2px solid var(--danger-color);
}
/* Clock Skew Analysis Styles */
.clock-skew-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.clock-skew-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.clock-skew-step.warning {
    border-left: 3px solid var(--warning-color);
    background: rgba(255, 140, 0, 0.1);
}

.clock-skew-step.error {
    border-left: 3px solid var(--danger-color);
    background: rgba(220, 20, 60, 0.1);
}

.skew-stat {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 3px;
    background: rgba(139, 69, 19, 0.1);
    margin: 0 2px;
}

.skew-high {
    background: rgba(220, 20, 60, 0.2);
    color: var(--danger-color);
}

.skew-medium {
    background: rgba(255, 140, 0, 0.2);
    color: var(--warning-color);
}

.skew-low {
    background: rgba(34, 139, 34, 0.2);
    color: var(--success-color);
}

.report-content {
    white-space: pre-wrap;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 5px;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid rgba(139, 69, 19, 0.2);
    max-height: 400px;
    overflow-y: auto;
}
/* Enhanced Toggle Switch Styling */
.toggle-switch-large {
    position: relative;
    display: inline-block;
    width: 80px;
    height: 40px;
}

.toggle-switch-large input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider-large {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #dc3545;
    border-radius: 40px;
    transition: .4s;
    border: 3px solid #ccc;
}

.toggle-slider-large:before {
    position: absolute;
    content: "OFF";
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    height: 34px;
    width: 34px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: .4s;
    color: #333;
}

.toggle-switch-large input:checked + .toggle-slider-large {
    background-color: #28a745;
}

.toggle-switch-large input:checked + .toggle-slider-large:before {
    transform: translateX(40px);
    content: "ON";
}

/* Enhanced Form Controls */
.form-control-lg {
    padding: 12px 16px;
    font-size: 16px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
}

.form-control-lg:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Button Enhancements */
.btn-lg {
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-lg:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Input Group Styling */
.input-group {
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 10px;
    border: 1px solid #e9ecef;
}

.input-label {
    font-size: 16px;
    color: #2c3e50;
}

.form-text {
    font-size: 14px;
    color: #6c757d;
    margin-top: 5px;
}

/* Badge Styling */
.badge {
    font-size: 14px;
    padding: 6px 12px;
    border-radius: 20px;
}
/* Add to existing CSS */
.bit-0 {
    color: white;
    background-color: var(--success-dark);
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    margin: 0 1px;
}

.bit-1 {
    color: white;
    background-color: var(--success-color);
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    margin: 0 1px;
}

.system-status {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.task-input-section {
    background: rgba(248, 249, 250, 0.8);
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
    border: 1px solid rgba(0, 0, 0, 0.1);
}
/* Add to existing CSS for better circuit visualization */
.d-flipflop-real.active {
    background: linear-gradient(135deg, #32CD32, #228B22);
    border-color: #006400;
    box-shadow: 0 0 15px rgba(34, 139, 34, 0.6);
}

.gate-symbol-real.active {
    background: linear-gradient(135deg, #FF8C00, #FFA500);
    border-color: #FF8C00;
    box-shadow: 0 0 10px rgba(255, 140, 0, 0.6);
}

.circuit-connection.active {
    background: linear-gradient(90deg, #228B22, #32CD32, #228B22);
    box-shadow: 0 0 8px rgba(34, 139, 34, 0.6);
}

.control-line {
    background: linear-gradient(90deg, #DC143C, #FF6347, #DC143C);
    box-shadow: 0 0 5px rgba(220, 20, 60, 0.5);
}

.shift-arrow-real {
    font-size: 2rem;
    animation: rotate 2s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.realistic-circuit-container {
    position: relative;
    min-height: 400px;
}
/* Binary Counter Specific Styles */
.binary-counter-step {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.binary-counter-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.counter-bit {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    margin: 2px;
    border: 2px solid var(--primary-color);
    transition: all 0.3s ease;
}

.counter-bit.active {
    background: var(--success-color);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 0 10px var(--success-color);
}

.counter-bit.inactive {
    background: var(--success-dark);
    color: white;
}

.counter-bit-label {
    font-size: 0.8rem;
    margin-top: 2px;
    color: var(--dark-color);
}

.ripple-effect {
    animation: ripplePulse 0.5s ease-in-out;
}

@keyframes ripplePulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 139, 34, 0.4); }
    50% { transform: scale(1.2); box-shadow: 0 0 0 10px rgba(34, 139, 34, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 139, 34, 0); }
}

.overflow-indicator {
    background: var(--danger-color);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-weight: bold;
    animation: pulse 0.5s ease;
}
/* Active-High vs Active-Low Decoder specific styles */
.decoder-comparison-step {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.decoder-comparison-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.decoder-type-highlight {
    background: var(--success-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
}

.decoder-type-lowlight {
    background: var(--warning-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
}

.decoder-comparison-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: white;
}

.decoder-comparison-table th, .decoder-comparison-table td {
    padding: 8px;
    text-align: center;
    border: 1px solid #dee2e6;
}

.decoder-comparison-table th {
    background: var(--primary-color);
    color: white;
}

.decoder-output-highlight {
    font-weight: bold;
    font-size: 1.1rem;
    animation: pulse 0.5s ease;
}
/* FSM Specific Styles */
.fsm-step {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.fsm-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.state-badge {
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

.input-badge, .output-badge {
    font-weight: bold;
    min-width: 60px;
    text-align: center;
}

.simulation-steps .card {
    transition: all 0.3s ease;
}

.simulation-steps .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.timing-diagram-visual {
    background: rgba(248, 249, 250, 0.8);
    border: 1px solid rgba(0,0,0,0.1);
}

.state-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 10px;
    border: 3px solid;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.state-circle:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.state-diagram-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
}
/* SRAM Specific Styles */
.sram-step {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid var(--info-color);
    transition: all 0.3s ease;
}

.sram-step.active {
    border-left: 3px solid var(--success-color);
    background: rgba(34, 139, 34, 0.1);
    font-weight: bold;
}

.sram-cell-layout {
    position: relative;
    width: 100%;
    height: 100%;
}

.transistor-label {
    position: absolute;
    color: var(--dark-color);
    font-size: 0.7rem;
    font-weight: bold;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 4px;
    border-radius: 2px;
    z-index: 30;
}

.storage-node {
    position: absolute;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: radial-gradient(circle, #8B4513, #A0522D);
    border: 2px solid #8B4513;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    z-index: 25;
}

.storage-node.active {
    background: radial-gradient(circle, #228B22, #32CD32);
    border-color: #006400;
    box-shadow: 0 0 10px rgba(34, 139, 34, 0.6);
}

.bitline-discharge {
    animation: dischargePulse 1.5s ease-in-out infinite;
}

@keyframes dischargePulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}

.sense-amplifier {
    position: absolute;
    width: 40px;
    height: 30px;
    background: linear-gradient(135deg, #FF8C00, #FFA500);
    border: 2px solid #FF8C00;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    z-index: 20;
}

.sense-amplifier.active {
    animation: senseAmpActive 0.5s ease-in-out;
    box-shadow: 0 0 15px rgba(255, 140, 0, 0.8);
}

@keyframes senseAmpActive {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
/* PLA Programming Styles */
.pla-and-array, .pla-or-array {
    background: rgba(255, 255, 255, 0.7);
    border-radius: 10px;
    border: 2px solid var(--primary-color);
    padding: 10px;
}

.input-line, .product-line, .output-line {
    transition: all 0.3s ease;
}

.input-line.active, .product-line.active, .output-line.active {
    background: var(--success-color);
    box-shadow: 0 0 8px rgba(34, 139, 34, 0.6);
}

.connection-dot {
    transition: all 0.3s ease;
    cursor: pointer;
}

.connection-dot:hover {
    transform: scale(1.5);
    box-shadow: 0 0 10px var(--warning-color);
}

.pla-title {
    font-size: 0.9rem;
    font-weight: bold;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 8px;
    border-radius: 4px;
    border: 1px solid var(--primary-color);
}

.remove-function-btn {
    min-width: 40px;
}

/* PLA Program Table Styles */
#pla-program-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

#pla-program-table th {
    background: var(--primary-color);
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

#pla-program-table td {
    padding: 10px;
    text-align: center;
    border: 1px solid #dee2e6;
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

#pla-program-table td.active {
    background: var(--success-color);
    color: white;
}

#pla-program-table td.inactive {
    background: var(--success-dark);
    color: white;
}
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="text-center mb-4">
            <h1 class="title-animation display-4 fw-bold">Advanced Logic Gates Visualizer</h1>
            <p class="lead text-white">Interactive visualization of digital logic gates with animated truth tables</p>
              <button class="gate-btn" id="back-to-home-btn">
            <i class="fas fa-home me-2"></i>Back to Home
        </button>
            <!-- Add this button with the other gate selection buttons -->
<button class="gate-btn" id="circuit-diagram-btn">
    <i class="fas fa-sitemap me-2"></i>
    <span>MUX/DECODER Circuits</span>
</button>
<!-- Add this button with the other sequential component buttons -->
<button class="gate-btn" id="moore-mealy-machine-btn">
    <i class="fas fa-random me-2"></i>Moore/Mealy Machines
</button>
        </header>
        <div class="row">
            <div class="col-md-4">
                <div class="glass-card">
                    <h3 class="text-center mb-4"><i class="fas fa-microchip me-2"></i>Gate Selection</h3>
                    
                    <div class="gate-description" id="gate-description">
                        Select a gate to see its operation and truth table
                    </div>
                    
                    <div class="gate-selection-container">
                        <button class="gate-btn" data-gate="NOT">
                            <i class="fas fa-exchange-alt"></i>
                            <span>NOT</span>
                        </button>
                        <button class="gate-btn active" data-gate="AND">
                            <i class="fas fa-circle"></i>
                            <span>AND</span>
                        </button>
                        <button class="gate-btn" data-gate="OR">
                            <i class="fas fa-plus"></i>
                            <span>OR</span>
                        </button>
                        <button class="gate-btn" data-gate="NAND">
                            <i class="fas fa-circle-notch"></i>
                            <span>NAND</span>
                        </button>
                        <button class="gate-btn" data-gate="NOR">
                            <i class="fas fa-ban"></i>
                            <span>NOR</span>
                        </button>
                        <button class="gate-btn" data-gate="XOR">
                            <i class="fas fa-times"></i>
                            <span>XOR</span>
                        </button>
                        <button class="gate-btn" data-gate="XNOR">
                            <i class="fas fa-equals"></i>
                            <span>XNOR</span>
                        </button>
                        <!-- Add this button in the gate-selection-container div with other gate buttons -->
<button class="gate-btn" data-gate="SPECIAL">
    <i class="fas fa-star me-2"></i>
    <span>Special Gates</span>
</button>
<button class="gate-btn" data-gate="GATE-PYQ">
    <i class="fas fa-file-alt me-2"></i>
    <span>Gate PYQ</span>
</button>
                        <!-- Find the gate-selection-container div and add this button -->
<button class="gate-btn" data-gate="BOOLEAN">
    <i class="fas fa-calculator"></i>
    <span>Boolean Algebra</span>
</button>
<button class="gate-btn" data-gate="COMBINATIONAL">
    <i class="fas fa-project-diagram"></i>
    <span>Combinational Logic</span>
</button>

<button class="gate-btn" data-gate="NUMBER-SYSTEM">
     <i class="fas fa-sort-numeric-up-alt me-2"></i>
     <span>Number Systems</span>
 </button>
<!-- In the gate-selection-container div, add this button -->
<button class="gate-btn" data-gate="NUMBER-SYSTEM-2">
    <i class="fas fa-exchange-alt me-2"></i>
    <span>Number System-2</span>
</button>
<!-- Find this in the gate-selection-container div -->
<button class="gate-btn" data-gate="ARITHMETIC">
    <i class="fas fa-calculator"></i>
    <span>Arithmetic</span>
</button>
<!-- Add this button in the gate-selection-container div (around line 290) -->
<button class="gate-btn" data-gate="MUX-DECODER">
    <i class="fas fa-random me-2"></i>
    <span>MUX/Decoder</span>
</button>
<!-- Add this button with the other gate selection buttons in the gate-selection-container div -->
<button class="gate-btn" data-gate="SEQUENTIAL">
    <i class="fas fa-history me-2"></i>
    <span>Sequential Logic</span>
</button>
<!-- Add this new button in the gate-selection-container div with other sequential buttons -->
<button class="gate-btn" data-gate="SEQUENTIAL-2">
    <i class="fas fa-share-alt me-2"></i>
    <span>Sequential Circuit-2</span>
</button>
<button class="gate-btn" data-gate="MEMORY-OPS">
    <i class="fas fa-memory me-2"></i>
    <span>Memory Operations</span>
</button>
<!-- Add this button with the other memory operation buttons -->
<button class="gate-btn" data-gate="ADV-MEMORY">
    <i class="fas fa-microchip me-2"></i>
    <span>Advanced Memory</span>
</button>
<!-- Add this button with the other Advanced Memory buttons -->
<button class="gate-btn" data-gate="PLA-PROGRAMMING">
    <i class="fas fa-layer-group me-2"></i>
    <span>PLA Programming</span>
</button>
                    </div>
                    
                    <div class="input-count-control mt-4">
                        <h5>Input Configuration</h5>
                        <div class="input-toggle">
                            <span class="input-label">No. of Inputs:</span>
                            <input type="number" id="input-count-input" class="input-count-input" value="2" min="2" max="5">
                            <button class="btn-glow btn-sm ms-2" id="apply-input-count">Apply</button>
                        </div>
                        <div class="mt-2" id="input-count-error"></div>
                        
                        <div id="input-toggles" class="mt-3">
                            <!-- Input toggles will be generated here -->
                        </div>
                    </div>
                    
                    <div class="keyboard-shortcut mt-3">
                        <i class="fas fa-keyboard me-2"></i>
                        Keyboard Shortcut: Press <span class="shortcut-key">Shift</span> + <span class="shortcut-key">R</span> to reset
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn-glow" id="animate-btn">
                            <i class="fas fa-play-circle me-2"></i>Animate Truth Table
                        </button>
                        <button class="btn-glow" id="reset-btn">
                            <i class="fas fa-redo me-2"></i>Reset Visualization
                        </button>
                    </div>
                    
                    <div class="animation-progress mt-3">
                        <div>Animation Progress</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                    </div>
                    
                    <div class="timer-display mt-3">
                        <i class="fas fa-clock me-2"></i>
                        Auto-reset after: <span id="reset-timer">20</span> seconds
                    </div>
                </div>
                
                <div class="glass-card mt-4">
                    <h4><i class="fas fa-info-circle me-2"></i>Gate Information</h4>
                    <div class="stats-card">
                        <div class="stats-value" id="current-gate-name">AND Gate</div>
                        <small>Currently Selected</small>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value" id="input-count-display">2</div>
                        <small>Input Count</small>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value" id="output-value">0</div>
                        <small>Current Output</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="glass-card">
                    <h3 class="text-center mb-4"><i class="fas fa-project-diagram me-2"></i>Gate Visualization</h3>
                    
                    <div class="gate-diagram-container">
                        <div class="step-counter" id="step-counter"></div>
                        <div class="gate-visualization" id="gate-visualization">
                            <!-- Gate diagram will be generated here -->
                        </div>
                    </div>
                    
                    <div class="animation-explanation" id="animation-explanation">
                        <!-- Animation explanation will be shown here -->
                    </div>
                    
                    <div class="truth-table-container mt-4">
                        <h4 class="text-center mb-3"><i class="fas fa-table me-2"></i>Truth Table</h4>
                        <table class="truth-table" id="truth-table">
                            <!-- Truth table will be generated here -->
                        </table>
                    </div>
                </div>
                <!-- Add this new section after all other sections (before the closing </div> of the container) -->
<div class="row mt-4" id="special-gates-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-star me-2"></i>Special Gates</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="gate-description">
                        <h5>Select Special Gate:</h5>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="tristate-btn">
                                <i class="fas fa-exchange-alt me-2"></i>Tri-State Buffer
                            </button>
                            <button class="btn-glow" id="transmission-btn">
                                <i class="fas fa-arrows-alt-h me-2"></i>Transmission Gate
                            </button>
                        </div>
                        
                        <!-- Tri-State Buffer Inputs -->
                        <div id="tristate-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Tri-State Buffer Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Data Input:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tristate-data">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Enable (Active High):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tristate-enable">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transmission Gate Inputs -->
                        <div id="transmission-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Transmission Gate Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Signal Input:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="transmission-signal">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Control Input:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="transmission-control">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="calculate-special-btn">
                                <i class="fas fa-calculator me-2"></i>Calculate Output
                            </button>
                            <button class="btn-glow" id="show-special-truth-table-btn">
                                <i class="fas fa-table me-2"></i>Show Truth Table
                            </button>
                            <button class="btn-glow" id="animate-special-btn">
                                <i class="fas fa-play-circle me-2"></i>Animate
                            </button>
                            <button class="btn-glow" id="reset-special-btn">
                                <i class="fas fa-redo me-2"></i>Reset
                            </button>
                        </div>
                    </div>
                    
                    <div class="gate-description mt-3">
                        <h6>Gate Information:</h6>
                        <div id="special-gate-description">
                            Select a special gate to see its operation
                        </div>
                        <div class="stats-card mt-2">
                            <div class="stats-value" id="special-output">-</div>
                            <small>Current Output</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Gate Visualization -->
                    <div class="gate-diagram-container">
                        <div class="gate-visualization" id="special-gate-visualization">
                            <div class="text-center mt-5">
                                <i class="fas fa-star fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                                <p class="mt-2">Select a special gate to visualize its operation</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Truth Table Display -->
                    <div id="special-truth-table-container" class="truth-table-container mt-3" style="display: none;">
                        <h5 class="text-center mb-3">Truth Table</h5>
                        <table class="truth-table" id="special-truth-table">
                            <!-- Truth table will be generated here -->
                        </table>
                    </div>
                    <!-- Add this after the Truth Table display in the special gates section -->
<div id="special-analysis" class="animation-explanation mt-3" style="display: none;">
    <h5 class="text-center mb-3" id="special-analysis-title">Step-by-Step Analysis</h5>
    <div id="special-steps-container">
        <!-- Analysis steps will be shown here -->
    </div>
</div>
                    <!-- Explanation -->
                    <div id="special-explanation" class="animation-explanation" style="display: block;">
                        <h5 id="special-operation-title">Special Gates</h5>
                        <div id="special-operation-explanation">
                            <p><strong>Tri-State Buffer:</strong> Outputs the input when enabled (1), enters High-Z state when disabled (0).</p>
                            <p><strong>Transmission Gate:</strong> Bidirectional switch that passes signal when control is active (1), enters High-Z when control is inactive (0).</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Number System-2 Operations Tab -->
<div class="row mt-4" id="number-system2-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-code me-2"></i>Advanced Number System Operations</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <!-- Operation Selection -->
                    <div class="gate-description">
                        <h5>Select Advanced Operation:</h5>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="excess3-btn">
                                <i class="fas fa-exchange-alt me-2"></i>Excess-3 Code
                            </button>
                            <button class="btn-glow" id="hamming-btn">
                                <i class="fas fa-shield-alt me-2"></i>Hamming Code
                            </button>
                            <!-- In the col-md-4 section of number-system2-section, add these buttons: -->
<button class="btn-glow" id="ascii-btn">
    <i class="fas fa-keyboard me-2"></i>ASCII Encoding
</button>
<button class="btn-glow" id="seven-segment-btn">
    <i class="fas fa-display me-2"></i>7-Segment Display
</button>
                            <button class="btn-glow" id="test-both-btn">
                                <i class="fas fa-vial me-2"></i>Test Both Codes
                            </button>
                            <button class="btn-glow" id="practice-advanced-btn">
                                <i class="fas fa-graduation-cap me-2"></i>GATE Practice
                            </button>
                        </div>
                        
                        <!-- Excess-3 Inputs -->
<!-- Update the Excess-3 input section in the HTML -->
<div id="excess3-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6>Excess-3 Code Conversion</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Operation:</span>
            <select id="excess3-operation" class="form-control mt-1">
                <option value="decimal-to-excess3">Decimal  Excess-3</option>
                <option value="excess3-to-decimal">Excess-3  Decimal</option>
                <option value="addition">Excess-3 Addition</option>
                <option value="subtraction">Excess-3 Subtraction</option>
            </select>
        </div>
        
        <div id="excess3-decimal-input" class="mt-2">
            <div class="input-toggle">
                <span class="input-label">Decimal Number:</span>
                <input type="text" id="excess3-decimal-value" class="form-control mt-1" 
                       placeholder="Enter decimal number" pattern="\d*" maxlength="32">
                <small class="text-muted">Up to 32 digits (0-9 only)</small>
                <div id="excess3-decimal-preview" class="mt-1 small" style="display: none;"></div>
            </div>
        </div>
        
        <div id="excess3-code-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">Excess-3 Code:</span>
                <input type="text" id="excess3-code-value" class="form-control mt-1" 
                       placeholder="Enter 4-bit Excess-3 groups" pattern="[01]*" maxlength="32">
                <small class="text-muted">Up to 32 bits (0 or 1 only), will be grouped in 4-bit chunks</small>
                <div id="excess3-code-preview" class="mt-1 small" style="display: none;"></div>
            </div>
        </div>
        
        <div id="excess3-second-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">Second Decimal Number:</span>
                <input type="text" id="excess3-second-value" class="form-control mt-1" 
                       placeholder="Enter second decimal number" pattern="\d*" maxlength="32">
                <small class="text-muted">Up to 32 digits (0-9 only)</small>
                <div id="excess3-second-preview" class="mt-1 small" style="display: none;"></div>
            </div>
        </div>
        
        <div class="d-grid gap-2 mt-2">
            <button class="btn-glow" id="calculate-excess3-btn">
                <i class="fas fa-calculator me-1"></i>Calculate
            </button>
            <button class="btn-glow" id="show-excess3-table-btn">
                <i class="fas fa-table me-1"></i>Show Excess-3 Table
            </button>
            <button class="btn-glow" id="test-large-btn" onclick="testLargeExamples()">
                <i class="fas fa-vial me-1"></i>Test Large Examples
            </button>
            <button class="btn-glow" id="reset-excess3-btn">
                <i class="fas fa-redo me-1"></i>Reset
            </button>
        </div>
    </div>
</div>
                        <!-- Hamming Code Inputs -->
                        <div id="hamming-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Hamming Code Encoding/Decoding</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Operation:</span>
                                    <select id="hamming-operation" class="form-control mt-1">
                                        <option value="encode">Encode Data</option>
                                        <option value="decode">Decode with Error Detection</option>
                                        <option value="single-error">Test Single Error</option>
                                        <option value="double-error">Test Double Error</option>
                                    </select>
                                </div>
                                
                                <div id="hamming-data-input" class="mt-2">
                                    <div class="input-toggle">
                                        <span class="input-label">Binary Data:</span>
                                        <input type="text" id="hamming-data-value" class="form-control mt-1" 
                                               placeholder="Enter binary data (e.g., 11111)" maxlength="16">
                                        <small class="text-muted">Enter binary digits (0 or 1) only</small>
                                    </div>
                                </div>
                                
                                <div id="hamming-encoded-input" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Encoded Data:</span>
                                        <input type="text" id="hamming-encoded-value" class="form-control mt-1" 
                                               placeholder="Enter encoded data with possible error" maxlength="32">
                                    </div>
                                </div>
                                
                                <div id="hamming-error-input" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Error Position:</span>
                                        <input type="number" id="hamming-error-position" class="form-control mt-1" 
                                               placeholder="Enter error position (1-based)" min="1" max="32">
                                    </div>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Code Type:</span>
                                    <select id="hamming-type-select" class="form-control mt-1">
                                        <option value="general">General Hamming Code</option>
                                        <option value="74">(7,4) Hamming Code</option>
                                        <option value="1511">(15,11) Hamming Code</option>
                                    </select>
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="calculate-hamming-btn">
                                        <i class="fas fa-calculator me-1"></i>Calculate
                                    </button>
                                    <button class="btn-glow" id="show-hamming-steps-btn">
                                        <i class="fas fa-list-ol me-1"></i>Show Detailed Steps
                                    </button>
                                    <button class="btn-glow" id="generate-hamming-examples-btn">
                                        <i class="fas fa-random me-1"></i>Generate Examples
                                    </button>
                                    <button class="btn-glow" id="reset-hamming-btn">
                                        <i class="fas fa-redo me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Code Information -->
                        <div class="gate-description mt-3">
                            <h6>Code Information:</h6>
                            <div id="code-description">
                                Select an operation to see details
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="code-result">-</div>
                                <small>Result</small>
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="code-steps">0</div>
                                <small>Steps</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Main Results Display -->
                    <div id="number-system2-results">
                        <div class="text-center mt-5">
                            <i class="fas fa-code fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                            <h4 class="mt-3">Advanced Code Operations</h4>
                            <p>Select an operation to get started</p>
                            <p class="small text-muted">Supports Excess-3 Code and Hamming Code with detailed step-by-step analysis</p>
                        </div>
                    </div>
                    
                    <!-- Step-by-Step Solution Display -->
                    <div id="number-system2-steps-container" class="animation-explanation mt-3" style="display: none;">
                        <h5 class="text-center mb-3">Step-by-Step Analysis</h5>
                        <div id="number-system2-steps-content">
                            <!-- Steps will be displayed here -->
                        </div>
                    </div>
                    
                    <!-- Reference Tables -->
                    <div id="code-reference-tables" class="mt-3" style="display: none;">
                        <div class="glass-card">
                            <h5 class="text-center mb-3">Code Reference Tables</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="binary-table">
                                        <h6>Excess-3 Code Table</h6>
                                        <table class="position-table">
                                            <tr><th>Decimal</th><th>BCD</th><th>Excess-3</th></tr>
                                            <tr><td>0</td><td>0000</td><td>0011</td></tr>
                                            <tr><td>1</td><td>0001</td><td>0100</td></tr>
                                            <tr><td>2</td><td>0010</td><td>0101</td></tr>
                                            <tr><td>3</td><td>0011</td><td>0110</td></tr>
                                            <tr><td>4</td><td>0100</td><td>0111</td></tr>
                                            <tr><td>5</td><td>0101</td><td>1000</td></tr>
                                            <tr><td>6</td><td>0110</td><td>1001</td></tr>
                                            <tr><td>7</td><td>0111</td><td>1010</td></tr>
                                            <tr><td>8</td><td>1000</td><td>1011</td></tr>
                                            <tr><td>9</td><td>1001</td><td>1100</td></tr>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="binary-table">
                                        <h6>Common Hamming Codes</h6>
                                        <table class="position-table">
                                            <tr><th>Code</th><th>Total Bits</th><th>Data Bits</th><th>Parity Bits</th></tr>
                                            <tr><td>(7,4)</td><td>7</td><td>4</td><td>3</td></tr>
                                            <tr><td>(15,11)</td><td>15</td><td>11</td><td>4</td></tr>
                                            <tr><td>(31,26)</td><td>31</td><td>26</td><td>5</td></tr>
                                            <tr><td>(63,57)</td><td>63</td><td>57</td><td>6</td></tr>
                                        </table>
                                        <p class="small text-muted mt-2">Formula: 2^p  m + p + 1</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Position Visualization -->
                    <div id="position-visualization" class="mt-3" style="display: none;">
                        <div class="glass-card">
                            <h5 class="text-center mb-3">Bit Position Visualization</h5>
                            <div id="position-display" class="text-center">
                                <!-- Position display will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ASCII Encoding Inputs -->
<div id="ascii-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6>ASCII Encoding/Decoding</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Operation Type:</span>
            <select id="ascii-operation" class="form-control mt-1">
                <option value="char-to-ascii">Character  ASCII</option>
                <option value="ascii-to-char">ASCII  Character</option>
                <option value="string-to-ascii">String  ASCII Codes</option>
                <option value="ascii-to-string">ASCII Codes  String</option>
                <option value="full-table">ASCII Table</option>
            </select>
        </div>
        
        <div id="ascii-char-input" class="mt-2">
            <div class="input-toggle">
                <span class="input-label">Character:</span>
                <input type="text" id="ascii-char-value" class="form-control mt-1" 
                       placeholder="Enter character" maxlength="1">
                <small class="text-muted">Single character only</small>
            </div>
        </div>
        
        <div id="ascii-value-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">ASCII Value:</span>
                <input type="number" id="ascii-decimal-value" class="form-control mt-1" 
                       placeholder="Enter ASCII (0-127)" min="0" max="127" value="65">
                <small class="text-muted">Decimal value between 0-127</small>
            </div>
        </div>
        
        <div id="ascii-string-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">String:</span>
                <input type="text" id="ascii-string-value" class="form-control mt-1" 
                       placeholder="Enter text" maxlength="20" value="HELLO">
                <small class="text-muted">Up to 20 characters</small>
            </div>
        </div>
        
        <div id="ascii-codes-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">ASCII Codes:</span>
                <input type="text" id="ascii-codes-value" class="form-control mt-1" 
                       placeholder="Enter codes (e.g., 72,69,76,76,79)" value="72,69,76,76,79">
                <small class="text-muted">Comma-separated decimal values (0-127)</small>
            </div>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Number Format:</span>
            <select id="ascii-format-select" class="form-control mt-1">
                <option value="decimal">Decimal</option>
                <option value="binary">Binary (7-bit)</option>
                <option value="hex">Hexadecimal</option>
                <option value="octal">Octal</option>
            </select>
        </div>
        
        <div class="d-grid gap-2 mt-2">
            <button class="btn-glow" id="calculate-ascii-btn">
                <i class="fas fa-calculator me-1"></i>Calculate
            </button>
            <button class="btn-glow" id="show-ascii-table-btn">
                <i class="fas fa-table me-1"></i>Show ASCII Table
            </button>
            <button class="btn-glow" id="test-ascii-btn">
                <i class="fas fa-vial me-1"></i>Test Examples
            </button>
            <button class="btn-glow" id="reset-ascii-btn">
                <i class="fas fa-redo me-1"></i>Reset
            </button>
        </div>
    </div>
</div>

<!-- 7-Segment Display Inputs -->
<div id="seven-segment-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6>7-Segment Display Decoding</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Operation Type:</span>
            <select id="seven-seg-operation" class="form-control mt-1">
                <option value="char-to-7seg">Character  7-Segment</option>
                <option value="ascii-to-7seg">ASCII  7-Segment</option>
                <option value="string-to-7seg">String  7-Segment</option>
                <option value="binary-to-7seg">Binary Pattern  Character</option>
                <option value="visual-display">Visual Display</option>
            </select>
        </div>
        
        <div id="7seg-char-input" class="mt-2">
            <div class="input-toggle">
                <span class="input-label">Character:</span>
                <input type="text" id="7seg-char-value" class="form-control mt-1" 
                       placeholder="Enter character" maxlength="1" value="A">
                <small class="text-muted">Single character only</small>
            </div>
        </div>
        
        <div id="7seg-ascii-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">ASCII Value:</span>
                <input type="number" id="7seg-ascii-value" class="form-control mt-1" 
                       placeholder="Enter ASCII (0-127)" min="0" max="127" value="65">
            </div>
        </div>
        
        <div id="7seg-string-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">String:</span>
                <input type="text" id="7seg-string-value" class="form-control mt-1" 
                       placeholder="Enter text" maxlength="10" value="HELLO">
                <small class="text-muted">Up to 10 characters</small>
            </div>
        </div>
        
        <div id="7seg-binary-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">7-Bit Binary Pattern:</span>
                <input type="text" id="7seg-binary-value" class="form-control mt-1" 
                       placeholder="Enter 7 bits (e.g., 1110111)" maxlength="7" value="1110111">
                <small class="text-muted">7-bit pattern for segments A-G (1=ON, 0=OFF)</small>
            </div>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Display Type:</span>
            <select id="7seg-display-type" class="form-control mt-1">
                <option value="common-anode">Common Anode</option>
                <option value="common-cathode">Common Cathode</option>
            </select>
        </div>
        
        <div class="d-grid gap-2 mt-2">
            <button class="btn-glow" id="calculate-7seg-btn">
                <i class="fas fa-calculator me-1"></i>Calculate
            </button>
            <button class="btn-glow" id="animate-7seg-btn">
                <i class="fas fa-play-circle me-1"></i>Animate Display
            </button>
            <button class="btn-glow" id="test-7seg-btn">
                <i class="fas fa-vial me-1"></i>Test Patterns
            </button>
            <button class="btn-glow" id="reset-7seg-btn">
                <i class="fas fa-redo me-1"></i>Reset
            </button>
        </div>
    </div>
</div>
                <!-- Boolean Algebra Operations Tab (Initially Hidden) -->
<!-- Boolean Algebra Operations Tab (Initially Hidden) -->
<!-- Boolean Algebra Operations Tab (Initially Hidden) -->
<div class="row mt-4" id="boolean-algebra-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-calculator me-2"></i>Boolean Algebra Operations</h3>
            
            <!-- Boolean Algebra Controls -->
            <div class="row">
                <div class="col-md-4">
                    <div class="input-count-control">
                        <h5>Variable Configuration</h5>
                        <div class="input-toggle">
                            <span class="input-label">Variables:</span>
                            <select id="boolean-variables-select" class="input-count-input">
                                <option value="1">1 Variable (A)</option>
                                <option value="2" selected>2 Variables (A, B)</option>
                                <option value="3">3 Variables (A, B, C)</option>
                            </select>
                            <button class="btn-glow btn-sm ms-2" id="apply-boolean-vars">Apply</button>
                        </div>
                        
                        <div id="boolean-variable-values" class="mt-3">
                            <!-- Variable toggles will be generated here -->
                        </div>
                        
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="evaluate-boolean-btn">
                                <i class="fas fa-play me-2"></i>Evaluate All 11 Laws
                            </button>
                            <button class="btn-glow" id="generate-tt-btn">
                                <i class="fas fa-table me-2"></i>Generate Truth Table
                            </button>
                            <button class="btn-glow" id="verify-laws-btn">
                                <i class="fas fa-check-circle me-2"></i>Verify All Laws
                            </button>
                        </div>
                    </div>
                    
                    <div class="glass-card mt-3">
                        <h5><i class="fas fa-list-alt me-2"></i>Boolean Algebra Laws (11 Total)</h5>
                        <div class="gate-description">
                            <div class="mb-2"><strong>1. Idempotent:</strong> A+A=A, AA=A</div>
                            <div class="mb-2"><strong>2. Commutative:</strong> A+B=B+A, AB=BA</div>
                            <div class="mb-2"><strong>3. Associative:</strong> (A+B)+C=A+(B+C)</div>
                            <div class="mb-2"><strong>4. Distributive:</strong> A(B+C)=AB+AC, A+BC=(A+B)(A+C)</div>
                            <div class="mb-2"><strong>5. De Morgan:</strong> (A+B)=AB, (AB)=A+B</div>
                            <div class="mb-2"><strong>6. Absorption:</strong> A+AB=A, A(A+B)=A</div>
                            <div class="mb-2"><strong>7. Consensus:</strong> AB+AC+BC=AB+AC</div>
                            <div class="mb-2"><strong>8. Identity:</strong> A+0=A, A1=A</div>
                            <div class="mb-2"><strong>9. Null:</strong> A+1=1, A0=0</div>
                            <div class="mb-2"><strong>10. Involution:</strong> (A)=A</div>
                            <div class="mb-2"><strong>11. Redundancy:</strong> A+AB=A+B, A(A+B)=AB</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Results Display -->
                    <div id="boolean-results" class="mt-3">
                        <div class="formula-display" id="boolean-expression">
                            Select variables and evaluate operations
                        </div>
                        
                        <div class="animation-explanation" id="boolean-explanation">
                            <!-- Explanation will be shown here -->
                        </div>
                        
                        <!-- Boolean Algebra Truth Table -->
                        <div class="truth-table-container mt-4">
                            <h5 class="text-center mb-3">Boolean Algebra Truth Table</h5>
                            <table class="truth-table" id="boolean-truth-table">
                                <!-- Boolean truth table will be generated here -->
                            </table>
                        </div>
                        
                        <!-- Law Verification Results -->
                        <div class="glass-card mt-3" id="law-verification-results" style="display: none;">
                            <h5><i class="fas fa-gavel me-2"></i>Boolean Algebra Law Verification (All 11 Laws)</h5>
                            <div id="law-results-content">
                                <!-- Law verification results will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Combinational Logic Operations Tab -->
<div class="row mt-4" id="combinational-logic-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-project-diagram me-2"></i>Combinational Logic Operations</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <!-- Add this in the combinational-logic-section div, inside the col-md-4 div -->
<div class="gate-description mt-3">
    <strong>Canonical Forms:</strong>
    <div class="mt-2">
        <button class="btn-glow btn-sm" id="generate-sop-btn">
            <i class="fas fa-plus-circle me-1"></i>Generate SOP
        </button>
        <button class="btn-glow btn-sm" id="generate-pos-btn">
            <i class="fas fa-times-circle me-1"></i>Generate POS
        </button>
        <button class="btn-glow btn-sm" id="compare-forms-btn">
            <i class="fas fa-balance-scale me-1"></i>Compare Forms
        </button>
<!-- Add these with the other canonical forms buttons -->
<button class="btn-glow btn-sm" id="convert-sop-to-pos-btn">
    <i class="fas fa-exchange-alt me-1"></i>SOP  POS
</button>
<button class="btn-glow btn-sm" id="convert-pos-to-sop-btn">
    <i class="fas fa-exchange-alt me-1"></i>POS  SOP
</button>
<!-- Add this in the combinational-logic-section div, in the col-md-4 column -->
<div class="gate-description mt-3">
    <strong>Code Conversions:</strong>
    <div class="mt-2">
        <button class="btn-glow btn-sm" id="binary-to-gray-btn">
            <i class="fas fa-exchange-alt me-1"></i>Binary  Gray
        </button>
        <button class="btn-glow btn-sm" id="gray-to-binary-btn">
            <i class="fas fa-exchange-alt me-1"></i>Gray  Binary
        </button>
        <button class="btn-glow btn-sm" id="test-conversions-btn">
            <i class="fas fa-table me-1"></i>Test Conversions
        </button>
    </div>
</div>

<!-- Add this input section in the same column -->
<div id="code-conversion-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6 id="conversion-title">Code Conversion</h6>
        <div class="input-toggle mt-2">
            <span class="input-label">Input:</span>
            <input type="text" id="code-input" class="form-control mt-1" 
                   placeholder="Enter binary/Gray code (e.g., 1101)" maxlength="32">
            <small class="text-muted">Enter binary (0,1) or Gray code (0,1) only</small>
        </div>
        <div class="d-grid gap-2 mt-2">
            <button class="btn-glow btn-sm" id="convert-btn">
                <i class="fas fa-calculator me-1"></i>Convert
            </button>
            <button class="btn-glow btn-sm" id="clear-conversion-btn">
                <i class="fas fa-redo me-1"></i>Clear
            </button>
        </div>
    </div>
</div>
<!-- Add this after the Code Conversions section -->
<div class="gate-description mt-3">
    <strong>Parity Generation:</strong>
    <div class="mt-2">
        <button class="btn-glow btn-sm" id="parity-generation-btn">
            <i class="fas fa-shield-alt me-1"></i>Generate Parity
        </button>
        <button class="btn-glow btn-sm" id="parity-check-btn">
            <i class="fas fa-search me-1"></i>Check Parity
        </button>
        <button class="btn-glow btn-sm" id="test-parity-btn">
            <i class="fas fa-vial me-1"></i>Test Examples
        </button>
    </div>
</div>

<!-- Parity Input Section -->
<div id="parity-input-section" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6 id="parity-title">Parity Generation/Checking</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Binary Data:</span>
            <input type="text" id="binary-data-input" class="form-control mt-1" 
                   placeholder="Enter binary number (e.g., 1011001)" maxlength="32">
            <small class="text-muted">Enter binary digits (0 or 1) only</small>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Parity Type:</span>
            <select id="parity-type-select" class="form-control mt-1">
                <option value="even">Even Parity</option>
                <option value="odd">Odd Parity</option>
            </select>
        </div>
        
        <div id="parity-check-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">Data with Parity:</span>
                <input type="text" id="data-with-parity-input" class="form-control mt-1" 
                       placeholder="Enter data with parity bit (e.g., 10110011)" maxlength="33">
            </div>
        </div>
        
        <div class="d-grid gap-2 mt-2">
            <button class="btn-glow btn-sm" id="execute-parity-btn">
                <i class="fas fa-calculator me-1"></i>Execute
            </button>
            <button class="btn-glow btn-sm" id="clear-parity-btn">
                <i class="fas fa-redo me-1"></i>Clear
            </button>
        </div>
    </div>
</div>
    </div>
</div>

                    <div class="input-count-control">
                        <h5>Logic Minimization Configuration</h5>
                        
                        <div class="input-toggle mt-2">
                            <span class="input-label">Method:</span>
                            <select id="minimization-method" class="input-count-input">
                                <option value="kmap">K-map Method</option>
                                <option value="algebra">Boolean Algebra</option>
                            </select>
                        </div>
                        
                        <div class="input-toggle mt-3">
                            <span class="input-label">Variables:</span>
                            <select id="logic-variables-select" class="input-count-input">
                                <option value="2">2 Variables (A,B)</option>
                                <option value="3" selected>3 Variables (A,B,C)</option>
                                <option value="4">4 Variables (A,B,C,D)</option>
                            </select>
                        </div>
                        
                        <!-- Variable Inputs for Boolean Algebra -->
                        <div id="variable-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                Enter Boolean Expression:
                                <input type="text" id="boolean-expression-input" class="form-control mt-2" 
                                       placeholder="e.g., A'B'C' + A'BC' + AB'C' + ABC'">
                                <small class="text-muted">Use + for OR, space or nothing for AND, ' for NOT</small>
                            </div>
                        </div>
                        
                        <!-- Minterm Inputs for K-map -->
                        <div id="minterm-inputs" class="mt-3">
                            <div class="gate-description">
                                Enter Minterms (comma-separated):
                                <input type="text" id="minterms-input" class="form-control mt-2" 
                                       placeholder="e.g., 0,2,4,6" value="0,2,4,6">
                            </div>
                            
                            <div class="gate-description mt-2">
                                Don't Care Terms (optional):
                                <input type="text" id="dontcare-input" class="form-control mt-2" 
                                       placeholder="e.g., 1,3,5">
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="minimize-btn">
                                <i class="fas fa-magic me-2"></i>Minimize Expression
                            </button>
                            <button class="btn-glow" id="generate-kmap-btn">
                                <i class="fas fa-table me-2"></i>Generate K-map
                            </button>
                            <button class="btn-glow" id="clear-minimize-btn">
                                <i class="fas fa-redo me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="glass-card mt-3">
                        <h5><i class="fas fa-info-circle me-2"></i>Quick Examples</h5>
                        <div class="gate-description">
                            <div class="mb-2"><strong>Example 1:</strong> 0,2,4,6  C'</div>
                            <div class="mb-2"><strong>Example 2:</strong> 0,1,3,7  A'B' + BC</div>
                            <div class="mb-2"><strong>Example 3:</strong> A'B'C' + A'BC' + AB'C' + ABC'  C'</div>
                            <div><strong>Example 4:</strong> 0,1,2,3,4,5,6,7  1</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Add this in the results section, after the grouping-visualization div -->
<div id="canonical-forms-results" class="mt-3" style="display: none;">
    <h5 class="text-center mb-3">Canonical Forms Analysis</h5>
    <div id="sop-pos-container">
        <!-- SOP/POS results will be shown here -->
    </div>
</div>
                    <!-- Results Display -->
                    <div id="logic-results" class="mt-3">
                        <div class="formula-display" id="minimization-result">
                            Enter minterms or expression and click Minimize
                        </div>
                        
                        <!-- K-map Visualization -->
                        <div id="kmap-visualization" class="mt-3" style="display: none;">
                            <h5 class="text-center mb-3">K-map Visualization</h5>
                            <div id="kmap-container" class="text-center">
                                <!-- K-map will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Step-by-step Solution -->
                        <div class="animation-explanation" id="minimization-explanation" style="display: block;">
                            <h5 class="mb-3">Step-by-Step Solution</h5>
                            <div id="solution-steps">
                                <!-- Solution steps will be shown here -->
                            </div>
                        </div>
                        
                        <!-- Grouping Visualization -->
                        <div id="grouping-visualization" class="mt-3" style="display: none;">
                            <h5 class="text-center mb-3">Grouping Analysis</h5>
                            <div id="grouping-container">
                                <!-- Grouping visualization will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Gate PYQ (Previous Year Questions) Tab -->
<div class="row mt-4" id="gate-pyq-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-file-alt me-2"></i>GATE Previous Year Questions</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <!-- Year Selection and Controls -->
                    <div class="pyq-controls">
                        <h5><i class="fas fa-calendar-alt me-2"></i>Select Year</h5>
                        <p class="small text-muted">Choose a year to view/download question papers</p>
                        
                        <div class="pyq-year-selector">
                            <button class="pyq-year-btn active" data-year="2023">2023</button>
                            <button class="pyq-year-btn" data-year="2022">2022</button>
                            <button class="pyq-year-btn" data-year="2021">2021</button>
                            <button class="pyq-year-btn" data-year="2020">2020</button>
                            <button class="pyq-year-btn" data-year="2019">2019</button>
                            <button class="pyq-year-btn" data-year="2018">2018</button>
                            <button class="pyq-year-btn" data-year="2017">2017</button>
                            <button class="pyq-year-btn" data-year="2016">2016</button>
                        </div>
                        
                        <div class="pyq-info-card mt-3">
                            <h6><i class="fas fa-info-circle me-2"></i>Information</h6>
                            <p class="mb-2">GATE Digital Logic Previous Year Question Papers</p>
                            <p class="small text-muted">Click "View" to see the PDF, or "Download" to save it locally.</p>
                        </div>
                        
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="view-pyq-btn">
                                <i class="fas fa-eye me-2"></i>View Question Paper
                            </button>
                            <button class="btn-glow" id="download-pyq-btn">
                                <i class="fas fa-download me-2"></i>Download PDF
                            </button>
                            <button class="btn-glow" id="print-pyq-btn">
                                <i class="fas fa-print me-2"></i>Print Question Paper
                            </button>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div class="pyq-stats">
                        <div class="pyq-stat">
                            <div class="pyq-stat-value" id="total-questions">156</div>
                            <div class="pyq-stat-label">Total Questions</div>
                        </div>
                        <div class="pyq-stat">
                            <div class="pyq-stat-value" id="years-available">8</div>
                            <div class="pyq-stat-label">Years Available</div>
                        </div>
                        <div class="pyq-stat">
                            <div class="pyq-stat-value" id="avg-marks">65%</div>
                            <div class="pyq-stat-label">Average Marks</div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="gate-description mt-3">
                        <h6><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                        <div class="d-grid gap-2 mt-2">
                            <button class="btn-glow btn-sm" id="open-folder-btn">
                                <i class="fas fa-folder-open me-1"></i>Open PDF Folder
                            </button>
                            <button class="btn-glow btn-sm" id="search-pyq-btn">
                                <i class="fas fa-search me-1"></i>Search in Papers
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- PDF Viewer -->
                    <div class="pdf-viewer-container">
                        <div class="pdf-controls">
                            <button class="pdf-nav-btn" id="prev-page-btn" disabled>
                                <i class="fas fa-chevron-left me-1"></i>Previous
                            </button>
                            
                            <div class="pdf-page-info">
                                <span id="current-page">1</span> of <span id="total-pages">1</span>
                            </div>
                            
                            <button class="pdf-nav-btn" id="next-page-btn" disabled>
                                Next <i class="fas fa-chevron-right ms-1"></i>
                            </button>
                        </div>
                        
                        <!-- PDF Display Area -->
                        <div id="pdf-display-area">
                            <div class="pdf-loading">
                                <i class="fas fa-file-pdf"></i>
                                <p>Select a year and click "View" to load the question paper</p>
                                <p class="small text-muted">PDF will be loaded here from your local file</p>
                            </div>
                        </div>
                        
                        <!-- Download Options -->
                        <div class="download-options">
                            <button class="download-btn" id="direct-download-btn">
                                <i class="fas fa-download"></i>Download PDF
                            </button>
                            <button class="download-btn print" id="print-pdf-btn">
                                <i class="fas fa-print"></i>Print
                            </button>
                            <button class="download-btn save" id="save-copy-btn">
                                <i class="fas fa-save"></i>Save Copy
                            </button>
                        </div>
                    </div>
                    
                    <!-- File Information -->
                    <div class="pyq-info-card mt-3">
                        <h6><i class="fas fa-file-pdf me-2"></i>Current File Information</h6>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <p><strong>File:</strong> <span id="current-filename">GateQuestion.pdf</span></p>
                                <p><strong>Path:</strong> <span id="current-filepath">C:\Users\ASUS\Downloads\GateQuestion.pdf</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Size:</strong> <span id="current-filesize">2.4 MB</span></p>
                                <p><strong>Pages:</strong> <span id="current-filepages">15</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row mt-4" id="mux-circuit-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-sitemap me-2"></i>MUX/DECODER Circuit Diagrams</h3>
            
            <div class="row">
                <!-- Left Column: Circuit Selection & Controls -->
                <div class="col-md-4">
                    <div class="gate-description">
                        <h5>Select Circuit Type:</h5>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="circuit-mux2-btn">
                                <i class="fas fa-exchange-alt me-2"></i>2:1 MUX Circuit
                            </button>
                            <button class="btn-glow" id="circuit-mux4-btn">
                                <i class="fas fa-exchange-alt me-2"></i>4:1 MUX Circuit
                            </button>
                            <button class="btn-glow" id="circuit-decoder-btn">
                                <i class="fas fa-code-branch me-2"></i>2-to-4 Decoder
                            </button>
                            <button class="btn-glow" id="circuit-demux-btn">
                                <i class="fas fa-share-alt me-2"></i>1:2 DEMUX Circuit
                            </button>
                            <button class="btn-glow" id="circuit-decoder3x8-btn">
                                <i class="fas fa-project-diagram me-2"></i>3-to-8 Decoder
                            </button>
                            <button class="btn-glow" id="circuit-priority-encoder-btn">
                                <i class="fas fa-sort-numeric-down me-2"></i>Priority Encoder
                            </button>
                        </div>
                    </div>
                    
                    <!-- Circuit Controls -->
                    <div id="circuit-controls" class="mt-3">
                        <div class="gate-description">
                            <h6>Circuit Configuration</h6>
                            <div id="circuit-specific-controls">
                                <!-- Dynamic controls will be generated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn-glow" id="animate-circuit-btn">
                            <i class="fas fa-play-circle me-2"></i>Animate Circuit
                        </button>
                        <button class="btn-glow" id="reset-circuit-btn">
                            <i class="fas fa-redo me-2"></i>Reset Circuit
                        </button>
                        <button class="btn-glow" id="show-circuit-truth-table-btn">
                            <i class="fas fa-table me-2"></i>Show Truth Table
                        </button>
                    </div>
                    
                    <!-- Circuit Information -->
                    <div class="gate-description mt-3">
                        <h6>Circuit Information:</h6>
                        <div id="circuit-description">
                            Select a circuit type to see its diagram and operation
                        </div>
                        <div class="stats-card mt-2">
                            <div class="stats-value" id="circuit-output">-</div>
                            <small>Current Output</small>
                        </div>
                    </div>
                </div>
                <!-- End of Left Column -->
                
                <!-- Right Column: Circuit Visualization & Info -->
                <div class="col-md-8">
                    <!-- Circuit Diagram Visualization -->
                    <div class="gate-diagram-container">
                        <div class="circuit-diagram-container" id="circuit-diagram-container">
                            <!-- Circuit diagram will be generated here -->
                            <div class="text-center mt-5">
                                <i class="fas fa-sitemap fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                                <p class="mt-2">Select a circuit type to visualize its diagram</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Circuit Truth Table -->
                    <div id="circuit-truth-table-container" class="circuit-truth-table" style="display: none;">
                        <h5 class="text-center mb-3">Circuit Truth Table</h5>
                        <table class="truth-table" id="circuit-truth-table">
                            <!-- Truth table will be generated here -->
                        </table>
                    </div>
                    
                    <!-- Circuit Explanation -->
                    <div id="circuit-explanation" class="animation-explanation" style="display: block;">
                        <h5 id="circuit-operation-title">MUX/DECODER Circuits</h5>
                        <div id="circuit-operation-explanation">
                            Select a circuit type to see its schematic diagram, operation, and truth table
                        </div>
                    </div>
                </div>
                <!-- End of Right Column -->
            </div>
            <!-- End of Inner Row -->
        </div>
        <!-- End of glass-card -->
    </div>
    <!-- End of col-12 -->
</div>
<!-- Number System Operations Tab -->
<div class="row mt-4" id="number-system-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-calculator me-2"></i>Number System Operations</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <!-- Operation Selection -->
                    <div class="gate-description">
                        <h5>Select Number System Operation:</h5>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="binary-decimal-btn">
                                <i class="fas fa-exchange-alt me-2"></i>Binary  Decimal
                            </button>
                            <button class="btn-glow" id="binary-hex-btn">
                                <i class="fas fa-exchange-alt me-2"></i>Binary  Hexadecimal
                            </button>
                            <button class="btn-glow" id="binary-octal-btn">
                                <i class="fas fa-exchange-alt me-2"></i>Binary  Octal
                            </button>
                            <button class="btn-glow" id="bcd-btn">
                                <i class="fas fa-code me-2"></i>BCD Encoding/Decoding
                            </button>
                            <button class="btn-glow" id="quick-test-btn">
                                <i class="fas fa-bolt me-2"></i>Quick Practice Test
                            </button>
                            <button class="btn-glow" id="gate-practice-btn">
                                <i class="fas fa-graduation-cap me-2"></i>GATE Previous Year
                            </button>
                                                    <!-- Add this button with the other number system operation buttons -->
<button class="btn-glow" id="signed-magnitude-btn">
    <i class="fas fa-balance-scale me-2"></i>Signed Magnitude
</button>
<button class="btn-glow" id="binary-multiplication-btn">
    <i class="fas fa-times me-2"></i>Binary Multiplication
</button>
                        </div>

<!-- Binary Multiplication Inputs -->
<div id="binary-multiplication-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6>Binary Multiplication (Shift-and-Add)</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Multiplicand (A):</span>
            <input type="text" id="multiplicand-input" class="form-control mt-1" 
                   placeholder="Enter binary number (e.g., 1011)" maxlength="16">
            <small class="text-muted">First number to multiply</small>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Multiplier (B):</span>
            <input type="text" id="multiplier-input" class="form-control mt-1" 
                   placeholder="Enter binary number (e.g., 1101)" maxlength="16">
            <small class="text-muted">Second number to multiply</small>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Bit Length:</span>
            <select id="multiplication-bit-length" class="form-control mt-1">
                <option value="4">4-bit</option>
                <option value="8" selected>8-bit</option>
                <option value="16">16-bit</option>
            </select>
        </div>
        
        <div class="d-grid gap-2 mt-2">
            <button class="btn-glow" id="calculate-multiplication-btn">
                <i class="fas fa-calculator me-1"></i>Calculate
            </button>
            <button class="btn-glow" id="show-multiplication-steps-btn">
                <i class="fas fa-list-ol me-1"></i>Show Detailed Steps
            </button>
            <button class="btn-glow" id="generate-multiplication-examples-btn">
                <i class="fas fa-random me-1"></i>Generate Examples
            </button>
            <button class="btn-glow" id="reset-multiplication-btn">
                <i class="fas fa-redo me-1"></i>Reset
            </button>
        </div>
    </div>
</div>
<!-- Add this section with the other number system input sections -->
<div id="signed-magnitude-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6>Signed Magnitude Representation</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Operation Type:</span>
            <select id="sm-operation-type" class="form-control mt-1">
                <option value="decimal-to-sm">Decimal  Signed Magnitude</option>
                <option value="sm-to-decimal">Signed Magnitude  Decimal</option>
                <option value="range-analysis">Range Analysis</option>
                <option value="addition-example">Addition Example</option>
            </select>
        </div>
        
        <div id="sm-decimal-input" class="mt-2">
            <div class="input-toggle">
                <span class="input-label">Decimal Number:</span>
                <input type="number" id="sm-decimal-value" class="form-control mt-1" 
                       placeholder="Enter decimal (e.g., -5)" step="1">
                <small class="text-muted">Enter positive or negative integer</small>
            </div>
        </div>
        
        <div id="sm-binary-input" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">Signed Magnitude Binary:</span>
                <input type="text" id="sm-binary-value" class="form-control mt-1" 
                       placeholder="Enter signed magnitude (e.g., 10000101)" maxlength="32">
                <small class="text-muted">First bit is sign (0=+, 1=-)</small>
            </div>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Bit Length:</span>
            <select id="sm-bit-length" class="form-control mt-1">
                <option value="4">4-bit</option>
                <option value="8" selected>8-bit</option>
                <option value="16">16-bit</option>
                <option value="32">32-bit</option>
            </select>
        </div>
        
        <div id="sm-addition-inputs" class="mt-2" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-toggle">
                        <span class="input-label">Number A:</span>
                        <input type="number" id="sm-add-a" class="form-control mt-1" 
                               placeholder="e.g., 5" value="5">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-toggle">
                        <span class="input-label">Number B:</span>
                        <input type="number" id="sm-add-b" class="form-control mt-1" 
                               placeholder="e.g., -3" value="-3">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 mt-2">
            <button class="btn-glow" id="calculate-sm-btn">
                <i class="fas fa-calculator me-1"></i>Calculate
            </button>
            <button class="btn-glow" id="show-steps-sm-btn">
                <i class="fas fa-list-ol me-1"></i>Show Detailed Steps
            </button>
            <button class="btn-glow" id="reset-sm-btn">
                <i class="fas fa-redo me-1"></i>Reset
            </button>
        </div>
    </div>
</div>
                        <!-- Binary  Decimal Inputs -->
                        <div id="binary-decimal-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Binary  Decimal Conversion</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Conversion Type:</span>
                                    <select id="bd-conversion-type" class="form-control mt-1">
                                        <option value="binary-to-decimal">Binary  Decimal</option>
                                        <option value="decimal-to-binary">Decimal  Binary</option>
                                        <option value="bidirectional">Bidirectional (Both)</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input Type:</span>
                                    <select id="bd-input-type" class="form-control mt-1">
                                        <option value="signed">Signed (2's Complement)</option>
                                        <option value="unsigned" selected>Unsigned</option>
                                        <option value="fractional">Fractional Binary</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Bit Length:</span>
                                    <select id="bd-bit-length" class="form-control mt-1">
                                        <option value="4">4-bit</option>
                                        <option value="8" selected>8-bit</option>
                                        <option value="16">16-bit</option>
                                        <option value="32">32-bit</option>
                                    </select>
                                </div>
                                
                                <div id="bd-binary-input" class="mt-2">
                                    <div class="input-toggle">
                                        <span class="input-label">Binary Input:</span>
                                        <input type="text" id="bd-binary-value" class="form-control mt-1" 
                                               placeholder="Enter binary (e.g., 1101)" maxlength="32">
                                        <small class="text-muted">Enter 0s and 1s only</small>
                                    </div>
                                </div>
                                
                                <div id="bd-decimal-input" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Decimal Input:</span>
                                        <input type="number" id="bd-decimal-value" class="form-control mt-1" 
                                               placeholder="Enter decimal (e.g., 13)">
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="calculate-bd-btn">
                                        <i class="fas fa-calculator me-1"></i>Calculate
                                    </button>
                                    <button class="btn-glow" id="show-steps-bd-btn">
                                        <i class="fas fa-list-ol me-1"></i>Show Detailed Steps
                                    </button>
                                    <button class="btn-glow" id="generate-examples-bd-btn">
                                        <i class="fas fa-random me-1"></i>Generate Examples
                                    </button>
                                    <button class="btn-glow" id="reset-bd-btn">
                                        <i class="fas fa-redo me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Binary  Hexadecimal Inputs -->
                        <div id="binary-hex-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Binary  Hexadecimal Conversion</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Conversion Type:</span>
                                    <select id="bh-conversion-type" class="form-control mt-1">
                                        <option value="binary-to-hex">Binary  Hex</option>
                                        <option value="hex-to-binary">Hex  Binary</option>
                                        <option value="bidirectional">Bidirectional</option>
                                    </select>
                                </div>
                                
                                <div id="bh-binary-input" class="mt-2">
                                    <div class="input-toggle">
                                        <span class="input-label">Binary Input:</span>
                                        <input type="text" id="bh-binary-value" class="form-control mt-1" 
                                               placeholder="Enter binary (e.g., 11011010)" maxlength="64">
                                    </div>
                                </div>
                                
                                <div id="bh-hex-input" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Hex Input:</span>
                                        <input type="text" id="bh-hex-value" class="form-control mt-1" 
                                               placeholder="Enter hex (e.g., DA)" maxlength="16">
                                    </div>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Group Size:</span>
                                    <select id="bh-group-size" class="form-control mt-1">
                                        <option value="4">4-bit groups (Standard)</option>
                                        <option value="8">8-bit groups (Byte-wise)</option>
                                        <option value="16">16-bit groups</option>
                                    </select>
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="calculate-bh-btn">
                                        <i class="fas fa-calculator me-1"></i>Calculate
                                    </button>
                                    <button class="btn-glow" id="show-table-bh-btn">
                                        <i class="fas fa-table me-1"></i>Show Hex Table
                                    </button>
                                    <button class="btn-glow" id="practice-bh-btn">
                                        <i class="fas fa-dumbbell me-1"></i>Practice Drill
                                    </button>
                                    <button class="btn-glow" id="reset-bh-btn">
                                        <i class="fas fa-redo me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Binary  Octal Inputs -->
                        <div id="binary-octal-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Binary  Octal Conversion</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Conversion Type:</span>
                                    <select id="bo-conversion-type" class="form-control mt-1">
                                        <option value="binary-to-octal">Binary  Octal</option>
                                        <option value="octal-to-binary">Octal  Binary</option>
                                        <option value="bidirectional">Bidirectional</option>
                                    </select>
                                </div>
                                
                                <div id="bo-binary-input" class="mt-2">
                                    <div class="input-toggle">
                                        <span class="input-label">Binary Input:</span>
                                        <input type="text" id="bo-binary-value" class="form-control mt-1" 
                                               placeholder="Enter binary (e.g., 101110)" maxlength="64">
                                    </div>
                                </div>
                                
                                <div id="bo-octal-input" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Octal Input:</span>
                                        <input type="text" id="bo-octal-value" class="form-control mt-1" 
                                               placeholder="Enter octal (e.g., 56)" maxlength="24">
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="calculate-bo-btn">
                                        <i class="fas fa-calculator me-1"></i>Calculate
                                    </button>
                                    <button class="btn-glow" id="show-steps-bo-btn">
                                        <i class="fas fa-list-ol me-1"></i>Step-by-Step
                                    </button>
                                    <button class="btn-glow" id="generate-bo-btn">
                                        <i class="fas fa-random me-1"></i>Generate Test
                                    </button>
                                    <button class="btn-glow" id="reset-bo-btn">
                                        <i class="fas fa-redo me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BCD Encoding/Decoding Inputs -->
                        <div id="bcd-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>BCD (Binary Coded Decimal) Operations</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Operation Type:</span>
                                    <select id="bcd-operation-type" class="form-control mt-1">
                                        <option value="encode">Decimal  BCD</option>
                                        <option value="decode">BCD  Decimal</option>
                                        <option value="addition">BCD Addition</option>
                                        <option value="subtraction">BCD Subtraction</option>
                                    </select>
                                </div>
                                
                                <div id="bcd-decimal-input" class="mt-2">
                                    <div class="input-toggle">
                                        <span class="input-label">Decimal Number:</span>
                                        <input type="text" id="bcd-decimal-value" class="form-control mt-1" 
                                               placeholder="Enter decimal (e.g., 475)" maxlength="16">
                                    </div>
                                </div>
                                
                                <div id="bcd-bcd-input" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">BCD Number:</span>
                                        <input type="text" id="bcd-bcd-value" class="form-control mt-1" 
                                               placeholder="Enter BCD (e.g., 0100 0111 0101)" maxlength="64">
                                    </div>
                                </div>
                                
                                <div id="bcd-second-input" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Second Decimal Number:</span>
                                        <input type="text" id="bcd-second-value" class="form-control mt-1" 
                                               placeholder="Enter second number" maxlength="16">
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="calculate-bcd-btn">
                                        <i class="fas fa-calculator me-1"></i>Calculate
                                    </button>
                                    <button class="btn-glow" id="show-bcd-table-btn">
                                        <i class="fas fa-table me-1"></i>Show BCD Table
                                    </button>
                                    <button class="btn-glow" id="validate-bcd-btn">
                                        <i class="fas fa-check-circle me-1"></i>Validate BCD
                                    </button>
                                    <button class="btn-glow" id="reset-bcd-btn">
                                        <i class="fas fa-redo me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stats and Information -->
                        <div class="gate-description mt-3">
                            <h6>Conversion Stats:</h6>
                            <div class="stats-card">
                                <div class="stats-value" id="conversion-result">-</div>
                                <small>Result</small>
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="conversion-time">0 ms</div>
                                <small>Calculation Time</small>
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="conversion-steps">0</div>
                                <small>Steps Taken</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <!-- Main Results Display -->
                    <div id="number-system-results">
                        <!-- Results will be displayed here -->
                        <div class="text-center mt-5">
                            <i class="fas fa-exchange-alt fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                            <h4 class="mt-3">Number System Converter</h4>
                            <p>Select a conversion type to get started</p>
                            <p class="small text-muted">Supports Binary, Decimal, Hexadecimal, Octal, and BCD conversions</p>
                        </div>
                    </div>
                    
                    <!-- Step-by-Step Solution Display -->
                    <div id="conversion-steps-container" class="animation-explanation mt-3" style="display: none;">
                        <h5 class="text-center mb-3">Step-by-Step Solution</h5>
                        <div id="steps-content">
                            <!-- Steps will be displayed here -->
                        </div>
                    </div>
                    
<!-- Quick Reference Tables -->
<div id="reference-tables" class="mt-3" style="display: none;">
    <div class="glass-card">
        <h5 class="text-center mb-3">Number System Reference Tables</h5>
<div class="row">
                <div class="col-md-4">
                    <div class="binary-table">
                        <h6>Binary  Decimal</h6>
                        <table class="bit-table">
                            <tr><th style="background-color: #2a9d8f; color: white; padding: 8px; text-align: center; font-weight: bold;">Binary</th><th style="background-color: #2a9d8f; color: white; padding: 8px; text-align: center; font-weight: bold;">Decimal</th></tr>
                            <tr><td style="background-color: #e9f5db; padding: 8px; text-align: center; font-weight: bold;">0000</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">0</td></tr>
                            <tr><td style="background-color: #c7f9cc; padding: 8px; text-align: center; font-weight: bold;">0001</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">1</td></tr>
                            <tr><td style="background-color: #e9f5db; padding: 8px; text-align: center; font-weight: bold;">0010</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">2</td></tr>
                            <tr><td style="background-color: #c7f9cc; padding: 8px; text-align: center; font-weight: bold;">0011</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">3</td></tr>
                            <tr><td style="background-color: #e9f5db; padding: 8px; text-align: center; font-weight: bold;">0100</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">4</td></tr>
                            <tr><td style="background-color: #c7f9cc; padding: 8px; text-align: center; font-weight: bold;">0101</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">5</td></tr>
                            <tr><td style="background-color: #e9f5db; padding: 8px; text-align: center; font-weight: bold;">0110</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">6</td></tr>
                            <tr><td style="background-color: #c7f9cc; padding: 8px; text-align: center; font-weight: bold;">0111</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">7</td></tr>
                            <tr><td style="background-color: #e9f5db; padding: 8px; text-align: center; font-weight: bold;">1000</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">8</td></tr>
                            <tr><td style="background-color: #c7f9cc; padding: 8px; text-align: center; font-weight: bold;">1001</td><td style="background-color: #f1faee; padding: 8px; text-align: center; font-weight: bold;">9</td></tr>
                        </table>
                    </div>
                </div>
  <div class="col-md-4">
                    <div class="binary-table">
                        <h6>Binary  Hex</h6>
                        <table class="bit-table">
                            <tr><th style="background-color: #e76f51; color: white; padding: 8px; text-align: center; font-weight: bold;">Binary</th><th style="background-color: #e76f51; color: white; padding: 8px; text-align: center; font-weight: bold;">Hex</th></tr>
                            <tr><td style="background-color: #ffddd2; padding: 8px; text-align: center; font-weight: bold;">0000</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">0</td></tr>
                            <tr><td style="background-color: #ffc2d1; padding: 8px; text-align: center; font-weight: bold;">0001</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">1</td></tr>
                            <tr><td style="background-color: #ffddd2; padding: 8px; text-align: center; font-weight: bold;">0010</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">2</td></tr>
                            <tr><td style="background-color: #ffc2d1; padding: 8px; text-align: center; font-weight: bold;">0011</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">3</td></tr>
                            <tr><td style="background-color: #ffddd2; padding: 8px; text-align: center; font-weight: bold;">0100</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">4</td></tr>
                            <tr><td style="background-color: #ffc2d1; padding: 8px; text-align: center; font-weight: bold;">0101</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">5</td></tr>
                            <tr><td style="background-color: #ffddd2; padding: 8px; text-align: center; font-weight: bold;">0110</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">6</td></tr>
                            <tr><td style="background-color: #ffc2d1; padding: 8px; text-align: center; font-weight: bold;">0111</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">7</td></tr>
                            <tr><td style="background-color: #ffddd2; padding: 8px; text-align: center; font-weight: bold;">1000</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">8</td></tr>
                            <tr><td style="background-color: #ffc2d1; padding: 8px; text-align: center; font-weight: bold;">1001</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">9</td></tr>
                            <tr><td style="background-color: #ffddd2; padding: 8px; text-align: center; font-weight: bold;">1010</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">A</td></tr>
                            <tr><td style="background-color: #ffc2d1; padding: 8px; text-align: center; font-weight: bold;">1011</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">B</td></tr>
                            <tr><td style="background-color: #ffddd2; padding: 8px; text-align: center; font-weight: bold;">1100</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">C</td></tr>
                            <tr><td style="background-color: #ffc2d1; padding: 8px; text-align: center; font-weight: bold;">1101</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">D</td></tr>
                            <tr><td style="background-color: #ffddd2; padding: 8px; text-align: center; font-weight: bold;">1110</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">E</td></tr>
                            <tr><td style="background-color: #ffc2d1; padding: 8px; text-align: center; font-weight: bold;">1111</td><td style="background-color: #fff1e6; padding: 8px; text-align: center; font-weight: bold;">F</td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="binary-table">
                        <h6>BCD Table</h6>
                        <table class="bit-table">
                            <tr><th style="background-color: #264653; color: white; padding: 8px; text-align: center; font-weight: bold;">Decimal</th><th style="background-color: #264653; color: white; padding: 8px; text-align: center; font-weight: bold;">BCD</th></tr>
                            <tr><td style="background-color: #a2d2ff; padding: 8px; text-align: center; font-weight: bold;">0</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">0000</td></tr>
                            <tr><td style="background-color: #bde0fe; padding: 8px; text-align: center; font-weight: bold;">1</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">0001</td></tr>
                            <tr><td style="background-color: #a2d2ff; padding: 8px; text-align: center; font-weight: bold;">2</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">0010</td></tr>
                            <tr><td style="background-color: #bde0fe; padding: 8px; text-align: center; font-weight: bold;">3</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">0011</td></tr>
                            <tr><td style="background-color: #a2d2ff; padding: 8px; text-align: center; font-weight: bold;">4</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">0100</td></tr>
                            <tr><td style="background-color: #bde0fe; padding: 8px; text-align: center; font-weight: bold;">5</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">0101</td></tr>
                            <tr><td style="background-color: #a2d2ff; padding: 8px; text-align: center; font-weight: bold;">6</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">0110</td></tr>
                            <tr><td style="background-color: #bde0fe; padding: 8px; text-align: center; font-weight: bold;">7</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">0111</td></tr>
                            <tr><td style="background-color: #a2d2ff; padding: 8px; text-align: center; font-weight: bold;">8</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">1000</td></tr>
                            <tr><td style="background-color: #bde0fe; padding: 8px; text-align: center; font-weight: bold;">9</td><td style="background-color: #cdb4db; padding: 8px; text-align: center; font-weight: bold;">1001</td></tr>
                        </table>
                    </div>
                </div>
        </div>
    </div>
</div>


                    <!-- Practice Questions -->
                    <div id="practice-questions" class="mt-3" style="display: none;">
                        <div class="glass-card">
                            <h5 class="text-center mb-3">Practice Questions</h5>
                            <div id="questions-container">
                                <!-- Questions will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- End of MUX/DECODER Circuit Diagrams Tab -->
<!-- Multiplexers & Decoders Operations Tab -->
<!-- Multiplexers & Decoders Operations Tab -->
<div class="row mt-4" id="mux-decoder-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-random me-2"></i>Multiplexers & Decoders</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <!-- Operations Selection -->
                    <div class="gate-description">
                        <h5>Select Operation:</h5>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="mux2-btn">
                                <i class="fas fa-exchange-alt me-2"></i>2:1 Multiplexer
                            </button>
                            <button class="btn-glow" id="mux4-btn">
                                <i class="fas fa-exchange-alt me-2"></i>4:1 Multiplexer
                            </button>
                            <button class="btn-glow" id="decoder-btn">
                                <i class="fas fa-code-branch me-2"></i>2-to-4 Decoder
                            </button>
                            <button class="btn-glow" id="demux-btn">
                                <i class="fas fa-share-alt me-2"></i>1:2 Demultiplexer
                            </button>
                            <button class="btn-glow" id="decoder3x8-btn">
                                <i class="fas fa-project-diagram me-2"></i>3-to-8 Decoder
                            </button>
                            <button class="btn-glow" id="priority-encoder-btn">
                                <i class="fas fa-sort-numeric-down me-2"></i>Priority Encoder
                            </button>
                            <button class="btn-glow" id="decoder4x16-btn">
                                <i class="fas fa-project-diagram me-2"></i>4:16 Decoder
                            </button>
                            <button class="btn-glow" id="bcd-decoder-btn">
                                <i class="fas fa-exchange-alt me-2"></i>BCD to Decimal Decoder
                            </button>
                            <button class="btn-glow" id="active-high-low-btn">
                                <i class="fas fa-exchange-alt me-2"></i>Active-High vs Active-Low
                            </button>
                        </div>
                        
                        <!-- MUX 2:1 Inputs -->
                        <div id="mux2-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>2:1 Multiplexer Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input 0 (I0):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mux2-i0">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input 1 (I1):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mux2-i1">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Select (S):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mux2-sel">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MUX 4:1 Inputs -->
                        <div id="mux4-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>4:1 Multiplexer Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input 0 (I0):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mux4-i0">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input 1 (I1):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mux4-i1">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input 2 (I2):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mux4-i2">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input 3 (I3):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mux4-i3">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Select 0 (S0):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mux4-sel0">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Select 1 (S1):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="mux4-sel1">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Decoder Inputs -->
                        <div id="decoder-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>2-to-4 Decoder Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input 0 (A):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder-a">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input 1 (B):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder-b">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Enable (E):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder-enable">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Demultiplexer Inputs -->
                        <div id="demux-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>1:2 Demultiplexer Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input (I):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="demux-input-i">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Select (S):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="demux-input-sel">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Enable (E):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="demux-input-enable">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 3-to-8 Decoder Inputs -->
                        <div id="decoder3x8-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>3-to-8 Decoder Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input A:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder3x8-input-a">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input B:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder3x8-input-b">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input C:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder3x8-input-c">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Enable (E):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder3x8-input-enable">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Priority Encoder Inputs -->
                        <div id="priority-encoder-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Priority Encoder Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Encoder Type:</span>
                                    <select id="encoder-type-select" class="form-control mt-1">
                                        <option value="4to2">4-to-2 Encoder</option>
                                        <option value="8to3">8-to-3 Encoder</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Priority:</span>
                                    <select id="priority-direction-select" class="form-control mt-1">
                                        <option value="highest">Highest Index Priority</option>
                                        <option value="lowest">Lowest Index Priority</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Active Level:</span>
                                    <select id="active-level-select" class="form-control mt-1">
                                        <option value="high">Active High (1=Active)</option>
                                        <option value="low">Active Low (0=Active)</option>
                                    </select>
                                </div>
                                
                                <!-- Dynamic inputs will be generated here -->
                                <div id="encoder-inputs-container" class="mt-3">
                                    <!-- Input toggles will be generated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 4:16 Decoder Inputs -->
                        <div id="decoder4x16-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>4:16 Decoder Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input A (LSB):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder4x16-input-a0">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input B:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder4x16-input-a1">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input C:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder4x16-input-a2">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input D (MSB):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder4x16-input-a3">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Enable (E):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder4x16-input-enable" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">1 (ON)</span>
                                </div>
                                
                                <!-- Action Buttons (Only show when 4:16 Decoder is selected) -->
                                <div class="d-grid gap-2 mt-3" id="decoder4x16-buttons" style="display: none;">
                                    <button class="btn-glow" id="calculate-4x16-btn">
                                        <i class="fas fa-calculator me-2"></i>Calculate
                                    </button>
                                    <button class="btn-glow" id="show-4x16-truth-table-btn">
                                        <i class="fas fa-table me-2"></i>Show Truth Table
                                    </button>
                                    <button class="btn-glow" id="reset-4x16-btn">
                                        <i class="fas fa-redo me-2"></i>Reset
                                    </button>
                                    <button class="btn-glow" id="close-4x16-btn">
                                        <i class="fas fa-times me-2"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BCD Decoder Inputs -->
                        <div id="bcd-decoder-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>BCD to Decimal Decoder Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input A (LSB):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="bcd-input-a">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input B:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="bcd-input-b">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input C:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="bcd-input-c">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input D (MSB):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="bcd-input-d">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="d-grid gap-2 mt-3" id="bcd-decoder-buttons">
                                    <button class="btn-glow" id="calculate-bcd-decoder-btn">
                                        <i class="fas fa-calculator me-2"></i>Calculate
                                    </button>
                                    <button class="btn-glow" id="show-bcd-decoder-truth-table-btn">
                                        <i class="fas fa-table me-2"></i>Show Truth Table
                                    </button>
                                    <button class="btn-glow" id="reset-bcd-decoder-btn">
                                        <i class="fas fa-redo me-2"></i>Reset
                                    </button>
                                    <button class="btn-glow" id="close-bcd-decoder-btn">
                                        <i class="fas fa-times me-2"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Active-High vs Active-Low Decoders Inputs -->
                        <div id="active-high-low-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Active-High vs Active-Low Decoders</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Decoder Type:</span>
                                    <select id="decoder-type-select" class="form-control mt-1">
                                        <option value="both">Compare Both</option>
                                        <option value="active-high">Active-High Only</option>
                                        <option value="active-low">Active-Low Only</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Decoder Size:</span>
                                    <select id="decoder-size-select" class="form-control mt-1">
                                        <option value="2to4">2-to-4 Decoder</option>
                                        <option value="3to8" selected>3-to-8 Decoder</option>
                                        <option value="4to16">4-to-16 Decoder</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input Configuration:</span>
                                    <div id="decoder-input-bits-container" class="mt-2">
                                        <!-- Input bits will be generated dynamically -->
                                    </div>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Enable Signal:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="decoder-enable-input" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">1 (ON)</span>
                                </div>
                                
                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn-glow" id="calculate-active-high-low-btn">
                                        <i class="fas fa-calculator me-2"></i>Calculate
                                    </button>
                                    <button class="btn-glow" id="show-truth-table-active-high-low-btn">
                                        <i class="fas fa-table me-2"></i>Show Truth Table
                                    </button>
                                    <button class="btn-glow" id="reset-active-high-low-btn">
                                        <i class="fas fa-redo me-2"></i>Reset
                                    </button>
                                    <button class="btn-glow" id="close-active-high-low-btn">
                                        <i class="fas fa-times me-2"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Common Action Buttons -->
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="calculate-mux-btn">
                                <i class="fas fa-calculator me-2"></i>Calculate
                            </button>
                            <button class="btn-glow" id="show-truth-table-btn">
                                <i class="fas fa-table me-2"></i>Show Truth Table
                            </button>
                            <button class="btn-glow" id="reset-mux-btn">
                                <i class="fas fa-redo me-2"></i>Reset
                            </button>
                        </div>
                    </div>
                    
                    <!-- Component Information -->
                    <div class="gate-description mt-3">
                        <h6>Component Information:</h6>
                        <div id="mux-description">
                            Select a component to see its operation
                        </div>
                        <div class="stats-card mt-2">
                            <div class="stats-value" id="mux-result">-</div>
                            <small>Current Output</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Truth Table Display -->
                    <div id="mux-truth-table-container" class="truth-table-container" style="display: none;">
                        <h5 class="text-center mb-3" id="mux-truth-table-title">Truth Table</h5>
                        <table class="truth-table" id="mux-truth-table">
                            <!-- Truth table will be generated here -->
                        </table>
                    </div>
                    
                    <!-- Explanation -->
                    <div id="mux-explanation" class="animation-explanation" style="display: block;">
                        <h5 id="mux-operation-title">Multiplexers & Decoders</h5>
                        <div id="mux-operation-explanation">
                            Select 2:1 Multiplexer, 4:1 Multiplexer, or 2-to-4 Decoder to see their operation
                        </div>
                    </div>
                    
                    <!-- Step-by-step Calculation -->
                    <div id="mux-calculation-steps" class="mt-3" style="display: none;">
                        <h5 class="text-center mb-3">Step-by-Step Calculation</h5>
                        <div id="mux-steps-container">
                            <!-- Calculation steps will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Arithmetic Operations Tab -->
<div class="row mt-4" id="arithmetic-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-calculator me-2"></i>Arithmetic Operations</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <!-- Arithmetic Operations Selection -->
                    <div class="gate-description">
                        <h5>Select Arithmetic Operation:</h5>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="half-adder-btn">
                                <i class="fas fa-plus-circle me-2"></i>Half-Adder
                            </button>
                            <button class="btn-glow" id="full-adder-btn">
                                <i class="fas fa-plus-square me-2"></i>Full-Adder
                            </button>
                            <!-- Add these buttons with the other arithmetic buttons -->
<button class="btn-glow" id="half-subtractor-btn">
    <i class="fas fa-minus-circle me-2"></i>Half-Subtractor
</button>
<button class="btn-glow" id="full-subtractor-btn">
    <i class="fas fa-minus-square me-2"></i>Full-Subtractor
</button>
<!-- Add these buttons with the other arithmetic buttons -->
<button class="btn-glow" id="binary-addition-btn">
    <i class="fas fa-plus-circle me-2"></i>Binary Addition
</button>
<button class="btn-glow" id="binary-subtraction-btn">
    <i class="fas fa-minus-circle me-2"></i>Binary Subtraction
</button>
<!-- Add these buttons for complement operations -->
<button class="btn-glow" id="ones-complement-btn">
    <i class="fas fa-exchange-alt me-2"></i>1's Complement
</button>
<button class="btn-glow" id="twos-complement-btn">
    <i class="fas fa-exchange-alt me-2"></i>2's Complement
</button>
                        </div>
                        
                        <!-- Input Controls for Adders -->
                        <div id="adder-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6 id="adder-title">Adder Inputs</h6>
                                
                                <!-- Half-Adder Inputs (2 inputs) -->
                                <div id="half-adder-inputs" style="display: none;">
                                    <div class="input-toggle mt-2">
                                        <span class="input-label">Input A:</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="ha-input-a">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="ms-2">0 (OFF)</span>
                                    </div>
                                    <div class="input-toggle mt-2">
                                        <span class="input-label">Input B:</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="ha-input-b">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="ms-2">0 (OFF)</span>
                                    </div>
                                </div>
                                
                                <!-- Full-Adder Inputs (3 inputs) -->
                                <div id="full-adder-inputs" style="display: none;">
                                    <div class="input-toggle mt-2">
                                        <span class="input-label">Input A:</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="fa-input-a">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="ms-2">0 (OFF)</span>
                                    </div>
                                    <div class="input-toggle mt-2">
                                        <span class="input-label">Input B:</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="fa-input-b">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="ms-2">0 (OFF)</span>
                                    </div>
                                    <div class="input-toggle mt-2">
                                        <span class="input-label">Carry-in (Cin):</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="fa-input-cin">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="ms-2">0 (OFF)</span>
                                    </div>
                                </div>
                                <!-- Half-Subtractor Inputs -->
<div id="half-subtractor-inputs" style="display: none;">
    <div class="input-toggle mt-2">
        <span class="input-label">Input A:</span>
        <label class="toggle-switch">
            <input type="checkbox" id="hs-input-a">
            <span class="toggle-slider"></span>
        </label>
        <span class="ms-2">0 (OFF)</span>
    </div>
    <div class="input-toggle mt-2">
        <span class="input-label">Input B:</span>
        <label class="toggle-switch">
            <input type="checkbox" id="hs-input-b">
            <span class="toggle-slider"></span>
        </label>
        <span class="ms-2">0 (OFF)</span>
    </div>
</div>

<!-- Full-Subtractor Inputs -->
<div id="full-subtractor-inputs" style="display: none;">
    <div class="input-toggle mt-2">
        <span class="input-label">Input A:</span>
        <label class="toggle-switch">
            <input type="checkbox" id="fs-input-a">
            <span class="toggle-slider"></span>
        </label>
        <span class="ms-2">0 (OFF)</span>
    </div>
    <div class="input-toggle mt-2">
        <span class="input-label">Input B:</span>
        <label class="toggle-switch">
            <input type="checkbox" id="fs-input-b">
            <span class="toggle-slider"></span>
        </label>
        <span class="ms-2">0 (OFF)</span>
    </div>
    <div class="input-toggle mt-2">
        <span class="input-label">Borrow-in (Bin):</span>
        <label class="toggle-switch">
            <input type="checkbox" id="fs-input-bin">
            <span class="toggle-slider"></span>
        </label>
        <span class="ms-2">0 (OFF)</span>
    </div>
</div>
                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn-glow" id="calculate-adder-btn">
                                        <i class="fas fa-calculator me-1"></i>Calculate
                                    </button>
                                    <button class="btn-glow" id="animate-adder-btn">
                                        <i class="fas fa-play-circle me-1"></i>Animate Truth Table
                                    </button>
                                    <button class="btn-glow" id="reset-adder-btn">
                                        <i class="fas fa-redo me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                     <!-- Complement Operations Input -->
<div id="complement-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6 id="complement-title">Complement Operation</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Binary Number:</span>
            <input type="text" id="complement-binary-input" class="form-control mt-1" 
                   placeholder="Enter binary number (e.g., 101101)" maxlength="32">
            <small class="text-muted">Enter binary digits (0 or 1) only</small>
        </div>
        
        <div class="d-grid gap-2 mt-2">
            <button class="btn-glow" id="calculate-complement-btn">
                <i class="fas fa-calculator me-1"></i>Calculate Complement
            </button>
            <button class="btn-glow" id="animate-complement-btn">
                <i class="fas fa-play-circle me-1"></i>Show Steps
            </button>
            <button class="btn-glow" id="reset-complement-btn">
                <i class="fas fa-redo me-1"></i>Reset
            </button>
        </div>
    </div>
</div>   
                        <!-- Adder Information -->
                        <div class="gate-description mt-3">
                            <h6>Adder Information:</h6>
                            <div id="adder-description">
                                Select an adder type to see its operation
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="adder-result">-</div>
                                <small>Current Output</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Adder Visualization -->
                    <div id="adder-visualization" class="gate-diagram-container" style="display: none;">
                        <div class="gate-visualization" id="adder-gate-visualization">
                            <!-- Adder diagram will be generated here -->
                        </div>
                    </div>
                    
                    <!-- Explanation -->
                    <div id="adder-explanation" class="animation-explanation" style="display: block;">
                        <h5 id="adder-operation-title">Arithmetic Operations</h5>
                        <div id="adder-operation-explanation">
                            Select Half-Adder or Full-Adder to see their operation
                        </div>
                    </div>
                    
                    <!-- Truth Table -->
                    <div id="adder-truth-table-container" class="truth-table-container mt-3" style="display: none;">
                        <h5 class="text-center mb-3">Truth Table</h5>
                        <table class="truth-table" id="adder-truth-table">
                            <!-- Truth table will be generated here -->
                        </table>
                    </div>
                    
                    <!-- Step-by-step Calculation -->
                    <div id="adder-calculation-steps" class="mt-3" style="display: none;">
                        <h5 class="text-center mb-3">Step-by-Step Calculation</h5>
                        <div id="adder-steps-container">
                            <!-- Calculation steps will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Memory Operations Tab -->
<div class="row mt-4" id="memory-operations-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-memory me-2"></i>SRAM 6T Cell Read Operation</h3>
            
            <div class="row">
                <!-- Left Column: Controls and Settings -->
                <div class="col-md-4">
                    <!-- Operation Controls -->
                    <div class="gate-description">
                        <h5>SRAM 6T Cell Configuration:</h5>
                        
                        <!-- Control Panel -->
                        <div class="input-count-control mt-3">
                            <h6>Read Operation Control</h6>
                            
                            <div class="input-toggle mt-2">
                                <span class="input-label">Stored Value:</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sram-stored-value" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="ms-2" id="stored-value-label">1 (ON)</span>
                            </div>
                            
                            <div class="input-toggle mt-2">
                                <span class="input-label">Word Line (WL):</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sram-word-line">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="ms-2" id="wl-label">0 (OFF)</span>
                            </div>
                            
                            <div class="input-toggle mt-2">
                                <span class="input-label">Precharge:</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sram-precharge" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="ms-2" id="precharge-label">1 (ON)</span>
                            </div>
                            
                            <div class="input-toggle mt-2">
                                <span class="input-label">Sense Amplifier:</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sram-sense-amp">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="ms-2" id="sense-amp-label">0 (OFF)</span>
                            </div>
                        </div>
                        
                        <!-- Operation Buttons -->
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="simulate-read-btn">
                                <i class="fas fa-play-circle me-2"></i>Simulate Read Operation
                            </button>
                            <button class="btn-glow" id="step-by-step-btn">
                                <i class="fas fa-forward me-2"></i>Step-by-Step Demo
                            </button>
                            <button class="btn-glow" id="show-truth-table-sram-btn">
                                <i class="fas fa-table me-2"></i>Show Truth Table
                            </button>
                            <button class="btn-glow" id="reset-sram-btn">
                                <i class="fas fa-redo me-2"></i>Reset
                            </button>
                        </div>
                        
                        <!-- Status Display -->
                        <div class="gate-description mt-3">
                            <h6>Operation Status:</h6>
                            <div class="stats-card">
                                <div class="stats-value" id="sram-output">-</div>
                                <small>Read Output</small>
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="bl-voltage">1.0V</div>
                                <small>BL Voltage</small>
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="blb-voltage">1.0V</div>
                                <small>~BL Voltage</small>
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="voltage-diff">0.0V</div>
                                <small>Voltage Diff</small>
                            </div>
                        </div>
                        
                        <!-- SRAM Parameters -->
                        <div class="gate-description mt-3">
                            <h6>SRAM 6T Cell Parameters:</h6>
                            <table class="bit-table" style="width: 100%;">
                                <tr>
                                    <td>Cell Size:</td>
                                    <td>6 Transistors</td>
                                </tr>
                                <tr>
                                    <td>Storage:</td>
                                    <td>1 Bit</td>
                                </tr>
                                <tr>
                                    <td>Voltage (VDD):</td>
                                    <td>1.0V</td>
                                </tr>
                                <tr>
                                    <td>Read Time:</td>
                                    <td>~2-5 ns</td>
                                </tr>
                                <tr>
                                    <td>Differential:</td>
                                    <td>50-300 mV</td>
                                </tr>
                                <tr>
                                    <td>Standby Power:</td>
                                    <td>Low</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Circuit Diagram and Visualization -->
                <div class="col-md-8">
                    <!-- SRAM Cell Diagram -->
                    <div class="glass-card">
                        <h5 class="text-center mb-3">SRAM 6T Cell Circuit Diagram</h5>
                        <div class="realistic-circuit-container" style="height: 300px;">
                            <div class="circuit-board"></div>
                            
                            <!-- SRAM 6T Cell Layout -->
                            <div class="sram-cell-layout">
                                <!-- PMOS Pull-Up Transistors -->
                                <div class="circuit-track" style="width: 120px; height: 50px; top: 40px; left: 60px; background: linear-gradient(90deg, #4169E1, #87CEEB);"></div>
                                <div class="gate-symbol-real sram-transistor" style="top: 30px; left: 80px; background: linear-gradient(135deg, #4169E1, #87CEEB); border-color: #1E90FF;" id="pu1">
                                    <span class="transistor-label">PU1</span>
                                    <span class="transistor-type">PMOS</span>
                                </div>
                                <div class="gate-symbol-real sram-transistor" style="top: 30px; left: 160px; background: linear-gradient(135deg, #4169E1, #87CEEB); border-color: #1E90FF;" id="pu2">
                                    <span class="transistor-label">PU2</span>
                                    <span class="transistor-type">PMOS</span>
                                </div>
                                
                                <!-- NMOS Pull-Down Transistors -->
                                <div class="gate-symbol-real sram-transistor" style="top: 100px; left: 80px; background: linear-gradient(135deg, #32CD32, #228B22); border-color: #006400;" id="pd1">
                                    <span class="transistor-label">PD1</span>
                                    <span class="transistor-type">NMOS</span>
                                </div>
                                <div class="gate-symbol-real sram-transistor" style="top: 100px; left: 160px; background: linear-gradient(135deg, #32CD32, #228B22); border-color: #006400;" id="pd2">
                                    <span class="transistor-label">PD2</span>
                                    <span class="transistor-type">NMOS</span>
                                </div>
                                
                                <!-- Access Transistors -->
                                <div class="gate-symbol-real sram-transistor" style="top: 170px; left: 50px; background: linear-gradient(135deg, #9370DB, #DDA0DD); border-color: #8A2BE2;" id="ax1">
                                    <span class="transistor-label">AX1</span>
                                    <span class="transistor-type">NMOS</span>
                                </div>
                                <div class="gate-symbol-real sram-transistor" style="top: 170px; left: 190px; background: linear-gradient(135deg, #9370DB, #DDA0DD); border-color: #8A2BE2;" id="ax2">
                                    <span class="transistor-label">AX2</span>
                                    <span class="transistor-type">NMOS</span>
                                </div>
                                
                                <!-- Storage Nodes -->
                                <div class="storage-node" style="top: 65px; left: 120px;" id="q-node">
                                    <span>Q</span>
                                </div>
                                <div class="storage-node" style="top: 65px; left: 175px;" id="qbar-node">
                                    <span>~Q</span>
                                </div>
                                
                                <!-- Connection Lines -->
                                <div class="circuit-connection" style="width: 40px; height: 3px; top: 65px; left: 140px;"></div>
                                <div class="circuit-connection" style="width: 3px; height: 35px; top: 65px; left: 140px;"></div>
                                <div class="circuit-connection" style="width: 3px; height: 35px; top: 65px; left: 175px;"></div>
                                
                                <!-- Word Line -->
                                <div class="control-line" style="width: 200px; height: 4px; top: 190px; left: 50px;" id="wl-line"></div>
                                <div class="circuit-label-real" style="top: 180px; left: 120px; font-size: 1rem;">
                                    <i class="fas fa-bolt me-1"></i>WL
                                </div>
                                
                                <!-- Bit Lines -->
                                <div class="data-bus" style="width: 5px; height: 80px; top: 110px; left: 40px;" id="bl-line"></div>
                                <div class="circuit-label-real" style="top: 120px; left: 20px; font-size: 1rem;">
                                    <i class="fas fa-wave-square me-1"></i>BL
                                </div>
                                
                                <div class="data-bus" style="width: 5px; height: 80px; top: 110px; left: 200px;" id="blb-line"></div>
                                <div class="circuit-label-real" style="top: 120px; left: 215px; font-size: 1rem;">
                                    <i class="fas fa-wave-square me-1"></i>~BL
                                </div>
                                
                                <!-- Sense Amplifier -->
                                <div class="sense-amplifier" style="top: 100px; left: 250px; width: 70px; height: 50px;" id="sense-amp">
                                    <i class="fas fa-expand-alt me-1"></i>
                                    <span>SENSE</span>
                                </div>
                                
                                <!-- Power Rails -->
                                <div class="circuit-label-real" style="top: 10px; left: 120px; background: #FFD700; color: #8B4513;">
                                    <i class="fas fa-bolt me-1"></i>VDD
                                </div>
                                <div class="circuit-label-real" style="top: 220px; left: 120px; background: #2F4F4F; color: white;">
                                    <i class="fas fa-minus-circle me-1"></i>GND
                                </div>
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="gate-symbol-real" style="width: 20px; height: 20px; background: linear-gradient(135deg, #4169E1, #87CEEB);"></div>
                                    <span class="ms-2 small">PMOS (Pull-Up)</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="gate-symbol-real" style="width: 20px; height: 20px; background: linear-gradient(135deg, #32CD32, #228B22);"></div>
                                    <span class="ms-2 small">NMOS (Pull-Down)</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="gate-symbol-real" style="width: 20px; height: 20px; background: linear-gradient(135deg, #9370DB, #DDA0DD);"></div>
                                    <span class="ms-2 small">Access Transistor</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="storage-node" style="width: 20px; height: 20px;"></div>
                                    <span class="ms-2 small">Storage Node</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Waveform Visualization -->
                    <div class="glass-card mt-3">
                        <h5 class="text-center mb-3">Read Operation Waveform</h5>
                        <div id="waveform-container" style="height: 250px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; padding: 15px;">
                            <canvas id="sram-waveform" width="650" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step-by-Step Explanation -->
            <div class="row mt-3">
                <div class="col-12">
                    <div id="sram-explanation" class="animation-explanation" style="display: block;">
                        <h5>SRAM 6T Cell Read Operation Steps:</h5>
                        <div id="sram-steps-container">
                            <div class="sram-step" id="step1">
                                <div class="d-flex align-items-center">
                                    <span class="step-number">1</span>
                                    <div class="ms-3">
                                        <strong>Precharge Phase</strong>
                                        <p class="mb-0">Both bitlines (BL and ~BL) are precharged to VDD (1.0V) using precharge circuits. This creates equal starting conditions for differential sensing.</p>
                                        <small class="text-muted">Status: <span id="step1-status" class="text-success">Active</span></small>
                                    </div>
                                </div>
                            </div>
                            <div class="sram-step" id="step2" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <span class="step-number">2</span>
                                    <div class="ms-3">
                                        <strong>Word Line Activation</strong>
                                        <p class="mb-0">WL goes HIGH (1.0V), turning on access transistors AX1 and AX2. This connects storage nodes Q and ~Q to bitlines BL and ~BL respectively.</p>
                                        <small class="text-muted">Status: <span id="step2-status" class="text-warning">Pending</span></small>
                                    </div>
                                </div>
                            </div>
                            <div class="sram-step" id="step3" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <span class="step-number">3</span>
                                    <div class="ms-3">
                                        <strong>Bitline Discharge</strong>
                                        <p class="mb-0">One bitline discharges through the pull-down path based on stored value. If Q=1, ~BL discharges through PD2 and AX2. If Q=0, BL discharges through PD1 and AX1.</p>
                                        <small class="text-muted">Status: <span id="step3-status" class="text-warning">Pending</span></small>
                                    </div>
                                </div>
                            </div>
                            <div class="sram-step" id="step4" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <span class="step-number">4</span>
                                    <div class="ms-3">
                                        <strong>Sense Amplification</strong>
                                        <p class="mb-0">Sense amplifier detects small voltage difference (50-300mV) between BL and ~BL and amplifies it to full swing (0V or VDD).</p>
                                        <small class="text-muted">Status: <span id="step4-status" class="text-warning">Pending</span></small>
                                    </div>
                                </div>
                            </div>
                            <div class="sram-step" id="step5" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <span class="step-number">5</span>
                                    <div class="ms-3">
                                        <strong>Data Output</strong>
                                        <p class="mb-0">Read data is available at the output. The stored value is successfully read without destroying it (non-destructive read).</p>
                                        <small class="text-muted">Status: <span id="step5-status" class="text-warning">Pending</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Truth Table with Calculations -->
            <div class="row mt-3">
                <div class="col-12">
                    <div id="sram-truth-table-container" class="truth-table-container mt-3" style="display: none;">
                        <h5 class="text-center mb-3">SRAM 6T Cell Read Operation Analysis</h5>
                        
                        <!-- Truth Table -->
                        <div class="table-responsive">
                            <table class="truth-table" id="sram-truth-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Stored Value</th>
                                        <th rowspan="2">Q</th>
                                        <th rowspan="2">~Q</th>
                                        <th colspan="2" class="text-center">Bitline Behavior</th>
                                        <th colspan="3" class="text-center">Calculations</th>
                                        <th rowspan="2">Output</th>
                                    </tr>
                                    <tr>
                                        <th>BL</th>
                                        <th>~BL</th>
                                        <th>V (mV)</th>
                                        <th>Discharge Time</th>
                                        <th>Power (W)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="active">1</td>
                                        <td class="active">1</td>
                                        <td class="inactive">0</td>
                                        <td>Stays ~VDD (1.0V)</td>
                                        <td>Discharges  (0.6V)</td>
                                        <td class="calc-value">+400 mV</td>
                                        <td class="calc-value">~2 ns</td>
                                        <td class="calc-value">12.5 W</td>
                                        <td class="active">1</td>
                                    </tr>
                                    <tr>
                                        <td class="inactive">0</td>
                                        <td class="inactive">0</td>
                                        <td class="active">1</td>
                                        <td>Discharges  (0.6V)</td>
                                        <td>Stays ~VDD (1.0V)</td>
                                        <td class="calc-value">-400 mV</td>
                                        <td class="calc-value">~2 ns</td>
                                        <td class="calc-value">12.5 W</td>
                                        <td class="inactive">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Operation Calculations -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="gate-description">
                                    <h6>Read Operation Calculations:</h6>
                                    <div id="read-calculations">
                                        <div class="calculation-step">
                                            <div class="calculation-title">Voltage Difference (V):</div>
                                            <div class="calculation-content">
                                                V = V<sub>BL</sub> - V<sub>~BL</sub> = <span id="calc-vdiff">400</span> mV
                                            </div>
                                        </div>
                                        <div class="calculation-step">
                                            <div class="calculation-title">Discharge Current:</div>
                                            <div class="calculation-content">
                                                I<sub>discharge</sub> = C<sub>BL</sub>  (dV/dt)  <span id="calc-current">200</span> A
                                            </div>
                                        </div>
                                        <div class="calculation-step">
                                            <div class="calculation-title">Read Power:</div>
                                            <div class="calculation-content">
                                                P<sub>read</sub> = V<sub>DD</sub>  I<sub>read</sub>  <span id="calc-power">12.5</span> W
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="gate-description">
                                    <h6>Key Operation Insights:</h6>
                                    <ul class="small">
                                        <li><strong>Differential Sensing:</strong> Uses BL and ~BL to detect small voltage differences</li>
                                        <li><strong>Non-Destructive:</strong> Read operation doesn't destroy stored data</li>
                                        <li><strong>High Speed:</strong> Typical read time: 2-5 nanoseconds</li>
                                        <li><strong>Low Power:</strong> Only accesses one cell at a time</li>
                                        <li><strong>Stability:</strong> Cross-coupled inverters maintain data integrity</li>
                                        <li><strong>Scalability:</strong> Can be scaled to nanometer technologies</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <p class="small text-muted mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            Note: Differential sensing requires only ~50-300mV difference for reliable read. 
                            Sense amplifier provides gain of 10-100x to convert small differential voltage to digital output.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Sequential Circuit-2 Operations Tab -->
<div class="row mt-4" id="sequential-circuit2-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-share-alt me-2"></i>Advanced Sequential Circuit Operations</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <!-- Component Selection -->
                    <div class="gate-description">
                        <h5>Select Sequential Component:</h5>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="t-flipflop-btn">
                                <i class="fas fa-toggle-on me-2"></i>T Flip-Flop
                            </button>
                            <button class="btn-glow" id="register-storage-btn">
                                <i class="fas fa-database me-2"></i>Register Storage
                            </button>
                            <button class="btn-glow" id="shift-register-btn">
                                <i class="fas fa-arrows-alt-h me-2"></i>Shift Register
                            </button>
                            <button class="btn-glow" id="master-slave-btn">
                                <i class="fas fa-network-wired me-2"></i>Master-Slave Configuration
                            </button>
                            <button class="btn-glow" id="setup-time-btn">
                                <i class="fas fa-clock me-2"></i>Setup Time Verification
                            </button>
                            <button class="btn-glow" id="hold-time-btn">
                                <i class="fas fa-clock me-2"></i>Hold Time Verification
                            </button>
                            <button class="btn-glow" id="clock-skew-btn">
                                <i class="fas fa-clock me-2"></i>Clock Skew Analysis
                            </button>
                            <button class="btn-glow" id="async-reset-btn">
                                <i class="fas fa-bolt me-2"></i>Asynchronous Preset/Clear
                            </button>
                            <button class="btn-glow" id="synchronous-reset-btn">
                                <i class="fas fa-sync-alt me-2"></i>Synchronous Reset Register
                            </button>
                            <button class="btn-glow" id="parallel-load-btn">
                                <i class="fas fa-arrow-circle-down me-2"></i>Parallel Load Register
                            </button>
                            <button class="btn-glow" id="ring-counter-btn">
                                <i class="fas fa-redo me-2"></i>Ring Counter
                            </button>
                            <button class="btn-glow" id="johnson-counter-btn">
                                <i class="fas fa-redo-alt me-2"></i>Johnson Counter
                            </button>
                            <button class="btn-glow" id="binary-counter-btn">
                                <i class="fas fa-sort-numeric-up me-2"></i>Binary Counter (Async)
                            </button>
                            <button class="btn-glow" id="mod-n-counter-btn">
                                <i class="fas fa-redo-alt me-2"></i>Mod-N Counter
                            </button>
                            <button class="btn-glow" id="finite-state-machine-btn">
    <i class="fas fa-robot me-2"></i>Finite State Machines
</button>

                        </div>
                        
                        <!-- T Flip-Flop Inputs -->
                        <div id="t-flipflop-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>T Flip-Flop Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input (T):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tff-input-t">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clock (CLK):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tff-input-clk">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Preset (PR):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tff-input-pr">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">1 (ON)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clear (CLR):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tff-input-clr">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">1 (ON)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Current Q:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tff-current-q" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Register Storage Inputs -->
                        <div id="register-storage-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Register Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Register Size:</span>
                                    <select id="register-size-select" class="form-control mt-1">
                                        <option value="4">4-bit Register</option>
                                        <option value="8" selected>8-bit Register</option>
                                        <option value="16">16-bit Register</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Operation:</span>
                                    <select id="register-operation-select" class="form-control mt-1">
                                        <option value="load">Load Data</option>
                                        <option value="store">Store Data</option>
                                        <option value="transfer">Transfer Data</option>
                                        <option value="clear">Clear Register</option>
                                    </select>
                                </div>
                                
                                <div id="register-data-input" class="mt-2" style="display: block;">
                                    <div class="input-toggle">
                                        <span class="input-label">Data Input:</span>
                                        <input type="text" id="register-input-data" class="form-control mt-1" 
                                               placeholder="Enter binary data (e.g., 1011)" maxlength="16">
                                        <small class="text-muted">Enter binary digits (0 or 1) only</small>
                                    </div>
                                </div>
                                
                                <div id="register-source-select" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Source Register:</span>
                                        <select id="source-register-select" class="form-control mt-1">
                                            <option value="R1">Register R1</option>
                                            <option value="R2">Register R2</option>
                                            <option value="R3">Register R3</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-toggle mt-2">
                                        <span class="input-label">Destination Register:</span>
                                        <select id="dest-register-select" class="form-control mt-1">
                                            <option value="R1">Register R1</option>
                                            <option value="R2">Register R2</option>
                                            <option value="R3">Register R3</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clock Pulse:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="register-clk">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Enable (EN):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="register-enable">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Master-Slave Configuration Inputs -->
                        <div id="master-slave-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Master-Slave Configuration</h6>
                                
                                <!-- Enhanced Number of Slaves Input -->
                                <div class="input-group mt-2 mb-3">
                                    <span class="input-group-text" style="min-width: 140px;">
                                        <i class="fas fa-server me-2"></i>Number of Slaves
                                    </span>
                                    <input type="number" id="num-slaves-input" class="form-control" 
                                           min="1" max="8" value="3">
                                    <button class="btn btn-outline-secondary" type="button" id="decrease-slaves">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" id="increase-slaves">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <small class="text-muted d-block mb-3">Number of slave nodes (1-8)</small>
                                
                                <!-- Task Type Selection -->
                                <div class="input-group mt-3 mb-3">
                                    <span class="input-group-text" style="min-width: 140px;">
                                        <i class="fas fa-tasks me-2"></i>Task Type
                                    </span>
                                    <select id="task-type-select" class="form-select">
                                        <option value="calculation">Calculation (Sum)</option>
                                        <option value="transform">Text Transformation</option>
                                        <option value="validation">Data Validation</option>
                                    </select>
                                </div>
                                
                                <!-- Task Inputs -->
                                <div id="calculation-inputs" class="task-input-section">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">
                                            <i class="fas fa-calculator me-2"></i>Numbers
                                        </span>
                                        <input type="text" id="calculation-data" class="form-control" 
                                               placeholder="e.g., 1,2,3,4,5" value="1,2,3,4,5">
                                    </div>
                                </div>
                                
                                <div id="transform-inputs" class="task-input-section" style="display: none;">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">
                                            <i class="fas fa-font me-2"></i>Text
                                        </span>
                                        <input type="text" id="transform-data" class="form-control" 
                                               placeholder="e.g., hello world" value="Hello World">
                                    </div>
                                </div>
                                
                                <div id="validation-inputs" class="task-input-section" style="display: none;">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">
                                            <i class="fas fa-check-circle me-2"></i>Data
                                        </span>
                                        <input type="text" id="validation-data" class="form-control" 
                                               placeholder="e.g., Sample Data" value="Sample Data">
                                    </div>
                                </div>
                                
                                <!-- Enhanced Action Buttons -->
                                <div class="d-grid gap-2 mt-4">
                                    <button class="btn btn-success btn-lg" id="initialize-master-slave-btn">
                                        <i class="fas fa-play-circle me-2"></i>Initialize System
                                    </button>
                                    
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-primary" id="submit-master-slave-task-btn">
                                            <i class="fas fa-paper-plane me-2"></i>Submit Task
                                        </button>
                                        <button class="btn btn-info" id="view-master-slave-status-btn">
                                            <i class="fas fa-chart-bar me-2"></i>View Status
                                        </button>
                                    </div>
                                    
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-warning" id="stop-master-slave-btn">
                                            <i class="fas fa-pause-circle me-2"></i>Pause System
                                        </button>
                                        <button class="btn btn-danger" id="exit-master-slave-btn">
                                            <i class="fas fa-times me-2"></i>Exit
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- System Status Indicator -->
                                <div class="system-status mt-3" id="master-slave-status-indicator" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <div class="status-dot bg-success" id="system-status-dot"></div>
                                        <span class="ms-2" id="system-status-text">System Ready</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Setup Time Verification Inputs -->
                        <div id="setup-time-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Setup Time Verification</h6>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Data Arrival Times (ns):</label>
                                    <input type="text" id="data-times-input" class="setup-time-input" 
                                           placeholder="e.g., 1.2, 3.8, 6.5, 9.1, 11.8" 
                                           value="1.2,3.8,6.5,9.1,11.8">
                                    <small class="text-muted">Comma-separated times in nanoseconds</small>
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Clock Arrival Times (ns):</label>
                                    <input type="text" id="clock-times-input" class="setup-time-input" 
                                           placeholder="e.g., 2.0, 4.0, 6.0, 8.0, 10.0, 12.0" 
                                           value="2.0,4.0,6.0,8.0,10.0,12.0">
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="setup-time-input-group">
                                            <label class="setup-time-label">Required Setup Time (ns):</label>
                                            <input type="number" id="setup-time-input" class="setup-time-input" 
                                                   step="0.1" min="0" value="0.5">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="setup-time-input-group">
                                            <label class="setup-time-label">Clock Period (ns):</label>
                                            <input type="number" id="clock-period-input" class="setup-time-input" 
                                                   step="0.1" min="0" value="2.0">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setup-time-controls">
                                    <button class="btn-glow" id="calculate-setup-time-btn">
                                        <i class="fas fa-calculator me-1"></i>Verify Setup Time
                                    </button>
                                    <button class="btn-glow" id="generate-random-timing-btn">
                                        <i class="fas fa-random me-1"></i>Generate Random Timing
                                    </button>
                                    <button class="btn-glow" id="show-setup-time-examples-btn">
                                        <i class="fas fa-list me-1"></i>Show Examples
                                    </button>
                                    <button class="btn-glow" id="close-setup-time-btn">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hold Time Verification Inputs -->
                        <div id="hold-time-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Hold Time Verification</h6>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Clock Period (ns):</label>
                                    <input type="number" id="hold-clock-period" class="setup-time-input" 
                                           step="0.1" min="0.1" value="10.0">
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Hold Time (ns):</label>
                                    <input type="number" id="hold-time-value" class="setup-time-input" 
                                           step="0.1" min="0" value="1.0">
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Clock-to-Q Delay (ns):</label>
                                    <input type="number" id="hold-clock-to-q" class="setup-time-input" 
                                           step="0.1" min="0" value="3.0">
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Min Combinational Delay (ns):</label>
                                    <input type="number" id="hold-min-delay" class="setup-time-input" 
                                           step="0.1" min="0" value="2.0">
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Clock Skew (ns):</label>
                                    <input type="number" id="hold-clock-skew" class="setup-time-input" 
                                           step="0.1" value="0.5">
                                    <small class="text-muted">Positive: destination clock later, Negative: destination clock earlier</small>
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Jitter (ns):</label>
                                    <input type="number" id="hold-jitter" class="setup-time-input" 
                                           step="0.1" min="0" value="0.2">
                                </div>
                                
                                <div class="setup-time-controls">
                                    <button class="btn-glow" id="calculate-hold-time-btn">
                                        <i class="fas fa-calculator me-1"></i>Verify Hold Time
                                    </button>
                                    <button class="btn-glow" id="generate-hold-time-examples-btn">
                                        <i class="fas fa-random me-1"></i>Generate Examples
                                    </button>
                                    <button class="btn-glow" id="show-hold-time-formulas-btn">
                                        <i class="fas fa-list me-1"></i>Show Formulas
                                    </button>
                                    <button class="btn-glow" id="close-hold-time-btn">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Clock Skew Analysis Inputs -->
                        <div id="clock-skew-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Clock Skew Analysis</h6>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Sampling Rate (Hz):</label>
                                    <input type="number" id="skew-sampling-rate" class="setup-time-input" 
                                           min="0.1" step="0.1" value="10.0">
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Number of Samples:</label>
                                    <input type="number" id="skew-n-samples" class="setup-time-input" 
                                           min="100" max="10000" step="100" value="1000">
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">True Skew (s/s):</label>
                                    <input type="number" id="skew-true-skew" class="setup-time-input" 
                                           step="0.000001" value="0.0005">
                                    <small class="text-muted">True clock skew in seconds per second</small>
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Noise Standard Deviation:</label>
                                    <input type="number" id="skew-noise-std" class="setup-time-input" 
                                           step="0.000001" min="0" value="0.0002">
                                </div>
                                
                                <div class="setup-time-input-group">
                                    <label class="setup-time-label">Drift Rate (s/s):</label>
                                    <input type="number" id="skew-drift-rate" class="setup-time-input" 
                                           step="1e-8" value="1e-7">
                                </div>
                                
                                <div class="setup-time-controls">
                                    <button class="btn-glow" id="generate-skew-data-btn">
                                        <i class="fas fa-calculator me-1"></i>Generate Synthetic Data
                                    </button>
                                    <button class="btn-glow" id="analyze-skew-btn">
                                        <i class="fas fa-chart-line me-1"></i>Analyze Clock Skew
                                    </button>
                                    <button class="btn-glow" id="show-skew-report-btn">
                                        <i class="fas fa-file-alt me-1"></i>Generate Report
                                    </button>
                                    <button class="btn-glow" id="close-skew-btn">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Asynchronous Preset/Clear Inputs -->
                        <div id="async-reset-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Asynchronous Preset/Clear Flip-Flop</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clock (CLK):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="async-input-clk">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Data (D):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="async-input-d">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Preset (PRE):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="async-input-preset">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                    <small class="text-muted ms-2">Active High: Sets Q=1 immediately</small>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clear (CLR):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="async-input-clear">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                    <small class="text-muted ms-2">Active High: Sets Q=0 immediately</small>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Current Q:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="async-current-q" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Current Q':</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="async-current-qbar" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">1 (ON)</span>
                                </div>
                                
                                <div class="gate-description mt-3">
                                    <h6>Operation Priority:</h6>
                                    <ol class="small">
                                        <li><strong>Clear (CLR=1)</strong>  Q=0 immediately (Highest Priority)</li>
                                        <li><strong>Preset (PRE=1)</strong>  Q=1 immediately</li>
                                        <li><strong>Clock Edge (CLK rising)</strong>  Q=D</li>
                                        <li><strong>No Change</strong>  Maintain current state</li>
                                    </ol>
                                </div>
                                
                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn-glow" id="calculate-async-btn">
                                        <i class="fas fa-calculator me-2"></i>Calculate Next State
                                    </button>
                                    <button class="btn-glow" id="step-async-btn">
                                        <i class="fas fa-forward me-2"></i>Step Through Example
                                    </button>
                                    <button class="btn-glow" id="show-async-truth-table-btn">
                                        <i class="fas fa-table me-2"></i>Show Truth Table
                                    </button>
                                    <button class="btn-glow" id="reset-async-btn">
                                        <i class="fas fa-redo me-2"></i>Reset
                                    </button>
                                    <button class="btn-glow" id="close-async-btn">
                                        <i class="fas fa-times me-2"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Synchronous Reset Register Inputs -->
                        <div id="synchronous-reset-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6 class="mb-4 border-bottom pb-2">Synchronous Reset Register Configuration</h6>
                                
                                <!-- Register Width -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Register Width:</label>
                                    <select id="sync-reg-width" class="form-control form-control-lg">
                                        <option value="4">4-bit</option>
                                        <option value="8" selected>8-bit</option>
                                        <option value="16">16-bit</option>
                                    </select>
                                    <div class="form-text">Select the width of the register in bits</div>
                                </div>
                                
                                <!-- Initial Value -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Initial Value:</label>
                                    <input type="number" id="sync-reg-initial" class="form-control form-control-lg" 
                                           min="0" max="255" value="5">
                                    <div class="form-text">Initial register value (0-255 for 8-bit register)</div>
                                </div>
                                
                                <!-- Data Input -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Data Input:</label>
                                    <input type="number" id="sync-reg-data" class="form-control form-control-lg" 
                                           min="0" max="255" value="10">
                                    <div class="form-text">Data value to load on clock edge</div>
                                </div>
                                
                                <!-- Reset Signal -->
                                <div class="input-group mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="input-label fw-bold">Reset Signal:</label>
                                        <span id="sync-reset-status" class="badge bg-secondary">OFF</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label class="toggle-switch-large">
                                            <input type="checkbox" id="sync-reg-reset">
                                            <span class="toggle-slider-large"></span>
                                        </label>
                                        <span class="ms-3 fw-medium">Active High - Resets register to 0 on clock edge</span>
                                    </div>
                                </div>
                                
                                <!-- Enable Signal -->
                                <div class="input-group mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="input-label fw-bold">Enable Signal:</label>
                                        <span id="sync-enable-status" class="badge bg-success">ON</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label class="toggle-switch-large">
                                            <input type="checkbox" id="sync-reg-enable" checked>
                                            <span class="toggle-slider-large"></span>
                                        </label>
                                        <span class="ms-3 fw-medium">When ON, data is loaded on clock edge</span>
                                    </div>
                                </div>
                                
                                <!-- Clock Edge -->
                                <div class="input-group mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="input-label fw-bold">Clock Edge:</label>
                                        <span id="sync-clock-status" class="badge bg-secondary">OFF</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label class="toggle-switch-large">
                                            <input type="checkbox" id="sync-reg-clock">
                                            <span class="toggle-slider-large"></span>
                                        </label>
                                        <span class="ms-3 fw-medium">Toggle this switch to simulate a clock edge</span>
                                    </div>
                                </div>
                                
                                <!-- Current Value -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Current Register Value:</label>
                                    <input type="text" id="sync-reg-current" class="form-control form-control-lg bg-light fw-bold text-center" 
                                           readonly value="5">
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-grid gap-3 mt-4">
                                    <button class="btn btn-primary btn-lg py-3" id="calculate-sync-reg-btn">
                                        <i class="fas fa-calculator me-2"></i>Simulate Clock Edge
                                    </button>
                                    <button class="btn btn-success btn-lg py-3" id="run-sync-demo-btn">
                                        <i class="fas fa-play me-2"></i>Run Full Demo Sequence
                                    </button>
                                    <button class="btn btn-info btn-lg py-3" id="step-sync-demo-btn">
                                        <i class="fas fa-forward me-2"></i>Step Through Demo
                                    </button>
                                    <button class="btn btn-warning btn-lg py-3" id="reset-sync-reg-btn">
                                        <i class="fas fa-redo me-2"></i>Reset to Initial State
                                    </button>
                                    <button class="btn btn-secondary btn-lg py-3" id="close-sync-reg-btn">
                                        <i class="fas fa-times me-2"></i>Close Configuration
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parallel Load Register Inputs -->
                        <div id="parallel-load-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6 class="mb-4 border-bottom pb-2">Parallel Load Register Configuration</h6>
                                
                                <!-- Register Width -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Register Width:</label>
                                    <select id="parallel-reg-width" class="form-control form-control-lg">
                                        <option value="4">4-bit</option>
                                        <option value="8" selected>8-bit</option>
                                        <option value="16">16-bit</option>
                                    </select>
                                    <div class="form-text">Select the width of the register in bits</div>
                                </div>
                                
                                <!-- Initial Value -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Initial Value:</label>
                                    <input type="number" id="parallel-reg-initial" class="form-control form-control-lg" 
                                           min="0" max="255" value="51">
                                    <div class="form-text">Initial register value (0-255 for 8-bit register)</div>
                                    <div class="form-text">
                                        <strong>Current:</strong> 
                                        <span id="parallel-reg-initial-binary">00110011</span>
                                    </div>
                                </div>
                                
                                <!-- Parallel Data Input -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Parallel Data Input:</label>
                                    <input type="number" id="parallel-reg-data" class="form-control form-control-lg" 
                                           min="0" max="255" value="170">
                                    <div class="form-text">Data value to load in parallel on clock edge</div>
                                    <div class="form-text">
                                        <strong>Binary:</strong> 
                                        <span id="parallel-reg-data-binary">10101010</span>
                                    </div>
                                </div>
                                
                                <!-- Load Enable Signal -->
                                <div class="input-group mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="input-label fw-bold">Load Enable Signal:</label>
                                        <span id="parallel-load-status" class="badge bg-danger">OFF</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label class="toggle-switch-large">
                                            <input type="checkbox" id="parallel-reg-load-enable">
                                            <span class="toggle-slider-large"></span>
                                        </label>
                                        <span class="ms-3 fw-medium">When ON, parallel data is loaded on clock edge</span>
                                    </div>
                                </div>
                                
                                <!-- Clock Edge -->
                                <div class="input-group mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="input-label fw-bold">Clock Edge:</label>
                                        <span id="parallel-clock-status" class="badge bg-secondary">OFF</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label class="toggle-switch-large">
                                            <input type="checkbox" id="parallel-reg-clock">
                                            <span class="toggle-slider-large"></span>
                                        </label>
                                        <span class="ms-3 fw-medium">Toggle this switch to simulate a clock edge</span>
                                    </div>
                                </div>
                                
                                <!-- Current Register Value -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Current Register Value:</label>
                                    <input type="text" id="parallel-reg-current" class="form-control form-control-lg bg-light fw-bold text-center" 
                                           readonly value="00110011 (51)">
                                    <div class="mt-2">
                                        <span class="badge bg-primary" id="parallel-reg-bits">
                                            Bit: 0 0 1 1 0 0 1 1
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-grid gap-3 mt-4">
                                    <button class="btn btn-primary btn-lg py-3" id="calculate-parallel-btn">
                                        <i class="fas fa-calculator me-2"></i>Simulate Clock Edge
                                    </button>
                                    <button class="btn btn-success btn-lg py-3" id="run-parallel-demo-btn">
                                        <i class="fas fa-play me-2"></i>Run Full Demo Sequence
                                    </button>
                                    <button class="btn btn-info btn-lg py-3" id="step-parallel-demo-btn">
                                        <i class="fas fa-forward me-2"></i>Step Through Demo
                                    </button>
                                    <button class="btn btn-warning btn-lg py-3" id="reset-parallel-reg-btn">
                                        <i class="fas fa-redo me-2"></i>Reset to Initial State
                                    </button>
                                    <button class="btn btn-secondary btn-lg py-3" id="close-parallel-btn">
                                        <i class="fas fa-times me-2"></i>Close Configuration
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ring Counter Inputs -->
                        <div id="ring-counter-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Ring Counter Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Number of Bits:</span>
                                    <select id="ring-counter-bits" class="form-control mt-1">
                                        <option value="4">4-bit</option>
                                        <option value="8" selected>8-bit</option>
                                        <option value="16">16-bit</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Shift Direction:</span>
                                    <select id="ring-counter-direction" class="form-control mt-1">
                                        <option value="right">Right Shift</option>
                                        <option value="left">Left Shift</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Initial State:</span>
                                    <select id="ring-counter-initial" class="form-control mt-1">
                                        <option value="single-one">Single '1' (1000...)</option>
                                        <option value="single-zero">Single '0' (0111...)</option>
                                        <option value="custom">Custom Pattern</option>
                                    </select>
                                </div>
                                
                                <div id="ring-counter-custom-input" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Custom Pattern:</span>
                                        <input type="text" id="ring-counter-pattern" class="form-control mt-1" 
                                               placeholder="Enter binary pattern (e.g., 1010)" maxlength="16">
                                        <small class="text-muted">Enter binary digits (0 or 1) only</small>
                                    </div>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clock Pulse:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="ring-counter-clock">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn-glow" id="calculate-ring-btn">
                                        <i class="fas fa-calculator me-2"></i>Calculate Next State
                                    </button>
                                    <button class="btn-glow" id="simulate-ring-sequence-btn">
                                        <i class="fas fa-play me-2"></i>Simulate Full Sequence
                                    </button>
                                    <button class="btn-glow" id="show-ring-truth-table-btn">
                                        <i class="fas fa-table me-2"></i>Show Truth Table
                                    </button>
                                    <button class="btn-glow" id="reset-ring-btn">
                                        <i class="fas fa-redo me-2"></i>Reset
                                    </button>
                                    <button class="btn-glow" id="close-ring-btn">
                                        <i class="fas fa-times me-2"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Johnson Counter Inputs -->
                        <div id="johnson-counter-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Johnson Counter Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Number of Bits:</span>
                                    <select id="johnson-counter-bits" class="form-control mt-1">
                                        <option value="4">4-bit</option>
                                        <option value="8" selected>8-bit</option>
                                        <option value="16">16-bit</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Shift Direction:</span>
                                    <select id="johnson-counter-direction" class="form-control mt-1">
                                        <option value="right">Right Shift</option>
                                        <option value="left">Left Shift</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Initial State:</span>
                                    <select id="johnson-counter-initial" class="form-control mt-1">
                                        <option value="all-zeros">All Zeros (0000...)</option>
                                        <option value="all-ones">All Ones (1111...)</option>
                                        <option value="custom">Custom Pattern</option>
                                    </select>
                                </div>
                                
                                <div id="johnson-counter-custom-input" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Custom Pattern:</span>
                                        <input type="text" id="johnson-counter-pattern" class="form-control mt-1" 
                                               placeholder="Enter binary pattern (e.g., 1010)" maxlength="16">
                                        <small class="text-muted">Enter binary digits (0 or 1) only</small>
                                    </div>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clock Pulse:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="johnson-counter-clock">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn-glow" id="calculate-johnson-btn">
                                        <i class="fas fa-calculator me-2"></i>Calculate Next State
                                    </button>
                                    <button class="btn-glow" id="simulate-johnson-sequence-btn">
                                        <i class="fas fa-play me-2"></i>Simulate Full Sequence
                                    </button>
                                    <button class="btn-glow" id="show-johnson-truth-table-btn">
                                        <i class="fas fa-table me-2"></i>Show Truth Table
                                    </button>
                                    <button class="btn-glow" id="reset-johnson-btn">
                                        <i class="fas fa-redo me-2"></i>Reset
                                    </button>
                                    <button class="btn-glow" id="close-johnson-btn">
                                        <i class="fas fa-times me-2"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Binary Counter (Asynchronous) Inputs -->
                        <div id="binary-counter-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6 class="mb-4 border-bottom pb-2">Binary Asynchronous Counter Configuration</h6>
                                
                                <!-- Number of Bits -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Number of Bits:</label>
                                    <select id="counter-bits-select" class="form-control form-control-lg">
                                        <option value="3">3-bit</option>
                                        <option value="4" selected>4-bit</option>
                                        <option value="5">5-bit</option>
                                        <option value="6">6-bit</option>
                                        <option value="7">7-bit</option>
                                        <option value="8">8-bit</option>
                                    </select>
                                    <div class="form-text">Select the number of flip-flops in the ripple counter</div>
                                </div>
                                
                                <!-- Initial Value -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Initial Value:</label>
                                    <input type="number" id="counter-initial-value" class="form-control form-control-lg" 
                                           min="0" max="255" value="0">
                                    <div class="form-text">Initial counter value (0-255 for 8-bit counter)</div>
                                    <div class="form-text">
                                        <strong>Current Binary:</strong> 
                                        <span id="counter-initial-binary">0000</span>
                                    </div>
                                </div>
                                
                                <!-- Clock Signal -->
                                <div class="input-group mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="input-label fw-bold">Clock Signal:</label>
                                        <span id="counter-clock-status" class="badge bg-secondary">OFF</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label class="toggle-switch-large">
                                            <input type="checkbox" id="counter-clock-input">
                                            <span class="toggle-slider-large"></span>
                                        </label>
                                        <span class="ms-3 fw-medium">Toggle to simulate clock pulses</span>
                                    </div>
                                </div>
                                
                                <!-- Current Counter Value -->
                                <div class="input-group mb-4">
                                    <label class="input-label fw-bold mb-2">Current Counter Value:</label>
                                    <input type="text" id="counter-current-value" class="form-control form-control-lg bg-light fw-bold text-center" 
                                           readonly value="0 (0000)">
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-grid gap-3 mt-4">
                                    <button class="btn btn-primary btn-lg py-3" id="simulate-clock-pulse-btn">
                                        <i class="fas fa-forward me-2"></i>Simulate Clock Pulse
                                    </button>
                                    <button class="btn btn-success btn-lg py-3" id="simulate-full-sequence-btn">
                                        <i class="fas fa-play me-2"></i>Run Full Sequence
                                    </button>
                                    <button class="btn btn-info btn-lg py-3" id="show-counter-truth-table-btn">
                                        <i class="fas fa-table me-2"></i>Show Truth Table
                                    </button>
                                    <button class="btn btn-warning btn-lg py-3" id="show-circuit-diagram-btn">
                                        <i class="fas fa-project-diagram me-2"></i>Show Circuit Diagram
                                    </button>
                                    <button class="btn btn-light btn-lg py-3" id="step-by-step-analysis-btn">
                                        <i class="fas fa-list-ol me-2"></i>Step-by-Step Analysis
                                    </button>
                                    <button class="btn btn-secondary btn-lg py-3" id="reset-counter-btn">
                                        <i class="fas fa-redo me-2"></i>Reset Counter
                                    </button>
                                    <button class="btn btn-danger btn-lg py-3" id="close-counter-btn">
                                        <i class="fas fa-times me-2"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mod-N Counter Inputs -->
                        <div id="mod-n-counter-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6 class="mb-3 border-bottom pb-2">Mod-N Counter Configuration</h6>
                                
                                <!-- Modulus Value -->
                                <div class="input-group mb-3">
                                    <label class="input-label fw-bold mb-2">Modulus Value (N):</label>
                                    <input type="number" id="mod-n-value" class="form-control" 
                                           min="2" max="32" value="4" step="1">
                                    <small class="text-muted">Enter N value (2-32). Counts from 0 to N-1</small>
                                </div>
                                
                                <!-- Counter Type -->
                                <div class="input-group mb-3">
                                    <label class="input-label fw-bold mb-2">Counter Type:</label>
                                    <select id="mod-n-type" class="form-control">
                                        <option value="synchronous">Synchronous</option>
                                        <option value="asynchronous">Asynchronous (Ripple)</option>
                                    </select>
                                </div>
                                
                                <!-- Number of Bits Display -->
                                <div class="input-group mb-3">
                                    <label class="input-label fw-bold mb-2">Bits Required:</label>
                                    <input type="text" id="mod-n-bits-display" class="form-control" readonly value="3 bits">
                                    <small class="text-muted">Calculated based on N value</small>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-grid gap-2 mt-4">
                                    <button class="btn-glow" id="show-mod-n-circuit-btn">
                                        <i class="fas fa-sitemap me-2"></i>Show Circuit Diagram
                                    </button>
                                    <button class="btn-glow" id="show-mod-n-truth-table-btn">
                                        <i class="fas fa-table me-2"></i>Show Truth Table
                                    </button>
                                    <button class="btn-glow" id="reset-mod-n-btn">
                                        <i class="fas fa-redo me-2"></i>Reset
                                    </button>
                                    <button class="btn-glow" id="close-mod-n-btn">
                                        <i class="fas fa-times me-2"></i>Close
                                    </button>
                                </div>
                                
                                <!-- Current Status -->
                                <div class="system-status mt-3" id="mod-n-status">
                                    <div class="d-flex align-items-center">
                                        <div class="status-dot bg-success"></div>
                                        <span class="ms-2">Mod-N Counter Ready. Configure N value and click Show Circuit Diagram or Show Truth Table.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Finite State Machine Inputs -->
<div id="finite-state-machine-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6>Finite State Machine Configuration</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">FSM Type:</span>
            <select id="fsm-type-select" class="form-control mt-1">
                <option value="custom">Custom FSM</option>
                <option value="example">Example: 101 Sequence Detector</option>
                <option value="moore">Moore Machine</option>
                <option value="mealy">Mealy Machine</option>
            </select>
        </div>
        
        <!-- Custom FSM Configuration -->
        <div id="custom-fsm-config" class="mt-2">
            <div class="input-toggle mt-2">
                <span class="input-label">Number of States:</span>
                <input type="number" id="num-states" class="form-control mt-1" min="2" max="16" value="3">
            </div>
            
            <div class="input-toggle mt-2">
                <span class="input-label">State Names:</span>
                <input type="text" id="state-names" class="form-control mt-1" 
                       placeholder="e.g., S0,S1,S2 (comma separated)" value="S0,S1,S2">
            </div>
            
            <div class="input-toggle mt-2">
                <span class="input-label">Input Symbols:</span>
                <input type="text" id="input-symbols" class="form-control mt-1" 
                       placeholder="e.g., 0,1 (comma separated)" value="0,1">
            </div>
            
            <div class="input-toggle mt-2">
                <span class="input-label">Output Symbols:</span>
                <input type="text" id="output-symbols" class="form-control mt-1" 
                       placeholder="e.g., 0,1 (comma separated)" value="0,1">
            </div>
            
            <div class="input-toggle mt-2">
                <span class="input-label">Initial State:</span>
                <input type="text" id="initial-state" class="form-control mt-1" 
                       placeholder="e.g., S0" value="S0">
            </div>
        </div>
        
        <!-- Transition Matrix -->
        <div id="transition-matrix" class="mt-3" style="display: none;">
            <h6>Transition Table</h6>
            <div id="transition-table-container" class="mt-2">
                <!-- Dynamic table will be generated here -->
            </div>
        </div>
        
        <!-- Input Sequence for Simulation -->
        <div id="fsm-sequence-input" class="mt-3">
            <div class="input-toggle">
                <span class="input-label">Input Sequence:</span>
                <input type="text" id="fsm-input-sequence" class="form-control mt-1" 
                       placeholder="e.g., 1,0,1,0,1 (comma separated)" value="1,0,1,0,1">
            </div>
        </div>
        
        <!-- Enhanced Action Buttons -->
        <div class="d-grid gap-2 mt-3">
            <div class="btn-group" role="group">
                <button class="btn-glow" id="configure-fsm-btn">
                    <i class="fas fa-cog me-1"></i>Configure FSM
                </button>
                <button class="btn-glow" id="show-fsm-truth-table-btn">
                    <i class="fas fa-table me-1"></i>Truth Table
                </button>
            </div>
            
            <div class="btn-group" role="group">
                <button class="btn-glow" id="show-timing-diagram-btn">
                    <i class="fas fa-wave-square me-1"></i>Timing Diagram
                </button>
                <button class="btn-glow" id="show-state-diagram-btn">
                    <i class="fas fa-project-diagram me-1"></i>State Diagram
                </button>
            </div>
            
            <div class="btn-group" role="group">
                <button class="btn-glow" id="simulate-fsm-btn">
                    <i class="fas fa-play-circle me-1"></i>Simulate
                </button>
                <button class="btn-glow" id="save-fsm-config-btn">
                    <i class="fas fa-save me-1"></i>Save Config
                </button>
            </div>
            
            <div class="btn-group" role="group">
                <button class="btn-glow btn-warning" id="reset-fsm-btn">
                    <i class="fas fa-redo me-1"></i>Reset
                </button>
                <button class="btn-glow btn-danger" id="close-fsm-btn">
                    <i class="fas fa-times me-1"></i>Close
                </button>
            </div>
        </div>
        
        <!-- FSM Status -->
        <div class="gate-description mt-3">
            <h6>FSM Status:</h6>
            <div id="fsm-status" class="mt-2">
                <span class="badge bg-secondary">Not Configured</span>
            </div>
        </div>
    </div>
</div>

                        <!-- Shift Register Inputs -->
                        <div id="shift-register-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>Shift Register Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Register Size:</span>
                                    <select id="shift-register-size-select" class="form-control mt-1">
                                        <option value="4">4-bit Shift Register</option>
                                        <option value="8" selected>8-bit Shift Register</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Shift Direction:</span>
                                    <select id="shift-direction-select" class="form-control mt-1">
                                        <option value="left">Left Shift</option>
                                        <option value="right" selected>Right Shift</option>
                                        <option value="bidirectional">Bidirectional</option>
                                    </select>
                                </div>
                                
                                <div id="shift-data-input" class="mt-2">
                                    <div class="input-toggle">
                                        <span class="input-label">Initial Data:</span>
                                        <input type="text" id="shift-input-data" class="form-control mt-1" 
                                               placeholder="Enter binary data (e.g., 1101)" maxlength="8" value="1101">
                                        <small class="text-muted">Enter binary digits (0 or 1) only</small>
                                    </div>
                                </div>
                                
                                <div id="shift-input-control" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Shift-In Data:</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="shift-in-data">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="ms-2">0 (OFF)</span>
                                    </div>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clock Pulse:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="shift-register-clk">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Shift Enable:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="shift-enable">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div id="bidirectional-controls" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <span class="input-label">Shift Mode:</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="shift-mode">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="ms-2">Right (OFF)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="calculate-sequential2-btn">
                                <i class="fas fa-calculator me-2"></i>Calculate
                            </button>
                            <button class="btn-glow" id="show-sequential2-truth-table-btn">
                                <i class="fas fa-table me-2"></i>Show Truth Table
                            </button>
                            <button class="btn-glow" id="animate-sequential2-btn">
                                <i class="fas fa-play-circle me-2"></i>Animate Operation
                            </button>
                            <button class="btn-glow" id="reset-sequential2-btn">
                                <i class="fas fa-redo me-2"></i>Reset
                            </button>
                        </div>
                    </div>
                    
                    <!-- Component Information -->
                    <div class="gate-description mt-3">
                        <h6>Component Information:</h6>
                        <div id="sequential2-description">
                            Select a sequential component to see its operation
                        </div>
                        <div class="stats-card mt-2">
                            <div class="stats-value" id="sequential2-result">-</div>
                            <small>Current Output</small>
                        </div>
                        <div class="stats-card mt-2">
                            <div class="stats-value" id="sequential2-next-result">-</div>
                            <small>Next State</small>
                        </div>
                    </div>
                    
                    <!-- Register Status Display -->
                    <div id="register-status-display" class="mt-3" style="display: none;">
                        <div class="gate-description">
                            <h6>Register Status:</h6>
                            <div id="register-values">
                                <!-- Register values will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Circuit Diagram Visualization -->
                    <div class="gate-diagram-container">
                        <div class="circuit-diagram-container" id="sequential2-circuit-container">
                            <!-- Sequential circuit diagram will be generated here -->
                            <div class="text-center mt-5">
                                <i class="fas fa-share-alt fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                                <p class="mt-2">Select a sequential component to visualize its circuit</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Operation Results -->
                    <div id="sequential2-results" class="mt-3">
                        <!-- Results will be displayed here -->
                    </div>
                    
                    <!-- Step-by-step Analysis -->
                    <div id="sequential2-analysis" class="animation-explanation mt-3" style="display: none;">
                        <h5 class="text-center mb-3" id="sequential2-analysis-title">Step-by-Step Analysis</h5>
                        <div id="sequential2-steps-container">
                            <!-- Analysis steps will be shown here -->
                        </div>
                    </div>
                    
                    <!-- Shift Register Visualization -->
                    <div id="shift-register-visualization" class="mt-3" style="display: none;">
                        <div class="glass-card">
                            <h5 class="text-center mb-3">Shift Register States</h5>
                            <div id="shift-register-states" class="text-center">
                                <!-- Shift register states will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Advanced Memory Operations Tab -->
<div class="row mt-4" id="advanced-memory-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <!-- Header -->
            <header class="text-center mb-4">
                <h3><i class="fas fa-microchip me-2"></i>Advanced Memory Operations</h3>
            </header>
            
            <div class="row">
                <!-- Left Column: Operations Selection and Inputs -->
                <div class="col-md-4">
                    <section class="gate-description">
                        <h5>Select Memory Operation:</h5>
                        
                        <!-- Memory Operations Selection -->
                        <nav class="d-grid gap-2 mt-3" role="toolbar" aria-label="Memory Operations">
                            <button class="btn-glow" id="address-decoding-btn" type="button">
                                <i class="fas fa-map-marker-alt me-2"></i>Address Decoding
                            </button>
                            <button class="btn-glow" id="cache-mapping-btn" type="button">
                                <i class="fas fa-layer-group me-2"></i>Cache Mapping
                            </button>
                            <button class="btn-glow" id="tlb-operation-btn" type="button">
                                <i class="fas fa-bolt me-2"></i>TLB Operation
                            </button>
                            <button class="btn-glow" id="memory-alignment-btn" type="button">
                                <i class="fas fa-ruler me-2"></i>Memory Alignment
                            </button>
                            <button class="btn-glow" id="rom-programming-btn" type="button">
                                <i class="fas fa-database me-2"></i>ROM Programming
                            </button>
                            <button class="btn-glow" id="prom-burning-btn" type="button">
                                <i class="fas fa-fire me-2"></i>PROM Burning
                            </button>
                        </nav>
                        
                        <!-- Address Decoding Inputs -->
                        <section id="address-decoding-inputs" class="mt-3" style="display: none;" aria-labelledby="address-decoding-heading">
                            <div class="gate-description">
                                <h6 id="address-decoding-heading">Address Decoding Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <label for="address-type-select" class="input-label">Address Type:</label>
                                    <select id="address-type-select" class="form-control mt-1">
                                        <option value="virtual">Virtual Address</option>
                                        <option value="physical">Physical Address</option>
                                        <option value="cache">Cache Address</option>
                                        <option value="multi-level">Multi-Level Paging</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <label for="address-format-select" class="input-label">Address Format:</label>
                                    <select id="address-format-select" class="form-control mt-1">
                                        <option value="hex">Hexadecimal</option>
                                        <option value="decimal">Decimal</option>
                                        <option value="binary">Binary</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <label for="address-input" class="input-label">Address Value:</label>
                                    <input type="text" id="address-input" class="form-control mt-1" 
                                           placeholder="Enter address (e.g., 0x12345678)" value="0x12345678">
                                    <small class="text-muted">Enter in selected format</small>
                                </div>
                                
                                <div id="paging-config" class="mt-2">
                                    <div class="input-toggle">
                                        <label for="paging-levels-select" class="input-label">Paging Levels:</label>
                                        <select id="paging-levels-select" class="form-control mt-1">
                                            <option value="2">2-Level Paging</option>
                                            <option value="3">3-Level Paging</option>
                                            <option value="4" selected>4-Level Paging (x86-64)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="cache-config" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <label for="cache-type-select" class="input-label">Cache Type:</label>
                                        <select id="cache-type-select" class="form-control mt-1">
                                            <option value="direct">Direct Mapped</option>
                                            <option value="set-associative">Set-Associative</option>
                                            <option value="fully-associative">Fully Associative</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="decode-address-btn" type="button">
                                        <i class="fas fa-calculator me-1"></i>Decode Address
                                    </button>
                                    <button class="btn-glow" id="show-examples-btn" type="button">
                                        <i class="fas fa-list-ol me-1"></i>Show Examples
                                    </button>
                                    <button class="btn-glow" id="animate-decoding-btn" type="button">
                                        <i class="fas fa-play-circle me-1"></i>Animate Decoding
                                    </button>
                                    <button class="btn-glow" id="close-address-decoding-btn" type="button">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Cache Mapping Inputs -->
                        <section id="cache-mapping-inputs" class="mt-3" style="display: none;" aria-labelledby="cache-mapping-heading">
                            <div class="gate-description">
                                <h6 id="cache-mapping-heading">Cache Mapping Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <label for="cache-mapping-type-select" class="input-label">Cache Type:</label>
                                    <select id="cache-mapping-type-select" class="form-control mt-1">
                                        <option value="direct">Direct Mapped</option>
                                        <option value="set-associative">Set-Associative</option>
                                        <option value="fully-associative">Fully Associative</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <label for="cache-size-select" class="input-label">Cache Size:</label>
                                    <select id="cache-size-select" class="form-control mt-1">
                                        <option value="64">64 KB</option>
                                        <option value="128">128 KB</option>
                                        <option value="256">256 KB</option>
                                        <option value="512" selected>512 KB</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <label for="block-size-select" class="input-label">Block Size:</label>
                                    <select id="block-size-select" class="form-control mt-1">
                                        <option value="32">32 bytes</option>
                                        <option value="64" selected>64 bytes</option>
                                        <option value="128">128 bytes</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <label for="cache-address-input" class="input-label">Address:</label>
                                    <input type="text" id="cache-address-input" class="form-control mt-1" 
                                           placeholder="Enter address (e.g., 0x12345678)" value="0x12345678">
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="calculate-cache-btn" type="button">
                                        <i class="fas fa-calculator me-1"></i>Calculate Mapping
                                    </button>
                                    <button class="btn-glow" id="show-cache-examples-btn" type="button">
                                        <i class="fas fa-list-ol me-1"></i>Show Examples
                                    </button>
                                    <button class="btn-glow" id="visualize-cache-btn" type="button">
                                        <i class="fas fa-eye me-1"></i>Visualize Cache
                                    </button>
                                    <button class="btn-glow" id="close-cache-mapping-btn" type="button">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                        </section>
                        
                        <!-- TLB Operation Inputs -->
                        <section id="tlb-operation-inputs" class="mt-3" style="display: none;" aria-labelledby="tlb-operation-heading">
                            <div class="gate-description">
                                <h6 id="tlb-operation-heading">TLB Operation Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <label for="tlb-type-select" class="input-label">TLB Type:</label>
                                    <select id="tlb-type-select" class="form-control mt-1">
                                        <option value="fully-associative">Fully Associative</option>
                                        <option value="set-associative">Set-Associative</option>
                                        <option value="direct-mapped">Direct Mapped</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <label for="tlb-size-select" class="input-label">TLB Size:</label>
                                    <select id="tlb-size-select" class="form-control mt-1">
                                        <option value="64">64 entries</option>
                                        <option value="128" selected>128 entries</option>
                                        <option value="256">256 entries</option>
                                    </select>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <label for="tlb-virtual-address" class="input-label">Virtual Address:</label>
                                    <input type="text" id="tlb-virtual-address" class="form-control mt-1" 
                                           placeholder="Enter virtual address" value="0x12345678">
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <label for="tlb-physical-address" class="input-label">Physical Address:</label>
                                    <input type="text" id="tlb-physical-address" class="form-control mt-1" 
                                           placeholder="Enter physical address" value="0x87654321">
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="check-tlb-btn" type="button">
                                        <i class="fas fa-search me-1"></i>Check TLB
                                    </button>
                                    <button class="btn-glow" id="update-tlb-btn" type="button">
                                        <i class="fas fa-sync me-1"></i>Update TLB
                                    </button>
                                    <button class="btn-glow" id="simulate-tlb-btn" type="button">
                                        <i class="fas fa-play-circle me-1"></i>Simulate Access
                                    </button>
                                    <button class="btn-glow" id="close-tlb-btn" type="button">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Memory Alignment Inputs -->
                        <section id="memory-alignment-inputs" class="mt-3" style="display: none;" aria-labelledby="memory-alignment-heading">
                            <div class="gate-description">
                                <h6 id="memory-alignment-heading">Memory Alignment Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <label for="alignment-address" class="input-label">Address:</label>
                                    <input type="text" id="alignment-address" class="form-control mt-1" 
                                           placeholder="Enter address (e.g., 0x12345678)" value="0x12345678">
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <label for="data-size-select" class="input-label">Data Size:</label>
                                    <select id="data-size-select" class="form-control mt-1">
                                        <option value="1">Byte (1 byte)</option>
                                        <option value="2">Halfword (2 bytes)</option>
                                        <option value="4" selected>Word (4 bytes)</option>
                                        <option value="8">Doubleword (8 bytes)</option>
                                        <option value="16">Quadword (16 bytes)</option>
                                    </select>
                                </div>
                                
                                <fieldset class="input-toggle mt-2">
                                    <legend class="input-label">Check Multiple Boundaries:</legend>
                                    <div class="mt-1">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="check-4byte" checked> 4-byte
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="check-8byte" checked> 8-byte
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="check-16byte" checked> 16-byte
                                        </label>
                                    </div>
                                </fieldset>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="check-alignment-btn" type="button">
                                        <i class="fas fa-check-circle me-1"></i>Check Alignment
                                    </button>
                                    <button class="btn-glow" id="find-next-aligned-btn" type="button">
                                        <i class="fas fa-arrow-right me-1"></i>Find Next Aligned
                                    </button>
                                    <button class="btn-glow" id="show-alignment-examples-btn" type="button">
                                        <i class="fas fa-list-ol me-1"></i>Show Examples
                                    </button>
                                    <button class="btn-glow" id="close-alignment-btn" type="button">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- ROM Programming Inputs -->
                        <section id="rom-programming-inputs" class="mt-3" style="display: none;" aria-labelledby="rom-programming-heading">
                            <div class="gate-description">
                                <h6 id="rom-programming-heading">ROM Programming Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <label for="rom-type-select" class="input-label">ROM Type:</label>
                                    <select id="rom-type-select" class="form-control mt-1">
                                        <option value="decimal-excess3">Decimal to Excess-3 Converter</option>
                                        <option value="custom-function">Custom Boolean Function</option>
                                        <option value="full-adder">Full Adder Example</option>
                                        <option value="seven-segment">7-Segment Decoder</option>
                                    </select>
                                </div>
                                
                                <div id="custom-function-inputs" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <label for="minterms-input-rom" class="input-label">Minterms:</label>
                                        <input type="text" id="minterms-input-rom" class="form-control mt-1" 
                                               placeholder="e.g., 0,2,5,7,10,13" value="0,2,5,7,10,13">
                                        <small class="text-muted">Comma-separated minterms (0-15)</small>
                                    </div>
                                    
                                    <div class="input-toggle mt-2">
                                        <label for="dontcare-input-rom" class="input-label">Don't Care Terms:</label>
                                        <input type="text" id="dontcare-input-rom" class="form-control mt-1" 
                                               placeholder="e.g., 3,12,13 (optional)">
                                        <small class="text-muted">Optional: comma-separated don't care terms</small>
                                    </div>
                                    
                                    <div class="input-toggle mt-2">
                                        <label for="rom-variables-select" class="input-label">Variables:</label>
                                        <select id="rom-variables-select" class="form-control mt-1">
                                            <option value="4">4 Variables (A,B,C,D)</option>
                                            <option value="3">3 Variables (A,B,C)</option>
                                            <option value="2">2 Variables (A,B)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="generate-rom-btn" type="button">
                                        <i class="fas fa-cogs me-1"></i>Generate ROM Contents
                                    </button>
                                    <button class="btn-glow" id="show-rom-truth-table-btn" type="button">
                                        <i class="fas fa-table me-1"></i>Show Truth Table
                                    </button>
                                    <button class="btn-glow" id="export-rom-btn" type="button">
                                        <i class="fas fa-download me-1"></i>Export Formats
                                    </button>
                                    <button class="btn-glow" id="close-rom-btn" type="button">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                        </section>
                        
                        <!-- PROM Burning Inputs -->
                        <section id="prom-burning-inputs" class="mt-3" style="display: none;" aria-labelledby="prom-burning-heading">
                            <div class="gate-description">
                                <h6 id="prom-burning-heading">PROM Burning Configuration</h6>
                                
                                <div class="input-toggle mt-2">
                                    <label for="prom-type-select" class="input-label">PROM Type:</label>
                                    <select id="prom-type-select" class="form-control mt-1">
                                        <option value="7segment">4-bit to 7-Segment Display</option>
                                        <option value="binary-gray">Binary to Gray Code Converter</option>
                                        <option value="full-adder">Full Adder Implementation</option>
                                        <option value="custom-function">Custom Boolean Function</option>
                                    </select>
                                </div>
                                
                                <div id="prom-custom-inputs" class="mt-2" style="display: none;">
                                    <div class="input-toggle">
                                        <label for="prom-minterms" class="input-label">Minterms (1's):</label>
                                        <input type="text" id="prom-minterms" class="form-control mt-1" 
                                               placeholder="e.g., 0,3,5,7,10,15" value="0,3,5,7,10,15">
                                        <small class="text-muted">Comma-separated minterms (0-15)</small>
                                    </div>
                                    
                                    <div class="input-toggle mt-2">
                                        <label for="prom-dontcares" class="input-label">Don't Cares:</label>
                                        <input type="text" id="prom-dontcares" class="form-control mt-1" 
                                               placeholder="e.g., 2,8,12 (optional)">
                                        <small class="text-muted">Optional: comma-separated don't care terms</small>
                                    </div>
                                    
                                    <div class="input-toggle mt-2">
                                        <label for="prom-output-width" class="input-label">Output Width:</label>
                                        <select id="prom-output-width" class="form-control mt-1">
                                            <option value="4">4 bits</option>
                                            <option value="7" selected>7 bits (7-segment)</option>
                                            <option value="8">8 bits (byte)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="prom-7segment-info" class="mt-2">
                                    <div class="input-toggle">
                                        <label for="prom-display-type" class="input-label">Display Type:</label>
                                        <select id="prom-display-type" class="form-control mt-1">
                                            <option value="common-anode">Common Anode (active HIGH)</option>
                                            <option value="common-cathode">Common Cathode (active LOW)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn-glow" id="generate-prom-btn" type="button">
                                        <i class="fas fa-cogs me-1"></i>Generate PROM Contents
                                    </button>
                                    <button class="btn-glow" id="show-prom-truth-table-btn" type="button">
                                        <i class="fas fa-table me-1"></i>Show Truth Table
                                    </button>
                                    <button class="btn-glow" id="export-prom-hex-btn" type="button">
                                        <i class="fas fa-file-export me-1"></i>Export Hex File
                                    </button>
                                    <button class="btn-glow" id="simulate-prom-btn" type="button">
                                        <i class="fas fa-play-circle me-1"></i>Simulate Burning
                                    </button>
                                    <button class="btn-glow" id="close-prom-btn" type="button">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                        </section>

                       
                        <!-- Current Operation Info -->
                        <div class="gate-description mt-3">
                            <h6>Current Operation:</h6>
                            <div id="memory-operation-description">
                                Select a memory operation to see its details
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="memory-result">-</div>
                                <small>Current Result</small>
                            </div>
                        </div>
                    </section>
                </div>
                <!-- End of Left Column -->
                
                <!-- Right Column: Results Display -->
                <div class="col-md-8">
                    <!-- Results Display Area -->
                    <div id="memory-results">
                        <div class="text-center mt-5">
                            <i class="fas fa-microchip fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                            <h4 class="mt-3">Advanced Memory Operations</h4>
                            <p>Select an operation to get started</p>
                            <p class="small text-muted">Supports address decoding, cache mapping, TLB operations, memory alignment, and ROM programming</p>
                        </div>
                    </div>
                    
                    <!-- Address Decoding Results -->
                    <section id="address-decoding-results" style="display: none;" aria-labelledby="address-decoding-results-heading"></section>
                    
                    <!-- Cache Mapping Results -->
                    <section id="cache-mapping-results" style="display: none;" aria-labelledby="cache-mapping-results-heading"></section>
                    
                    <!-- TLB Operation Results -->
                    <section id="tlb-operation-results" style="display: none;" aria-labelledby="tlb-operation-results-heading"></section>
                    
                    <!-- Memory Alignment Results -->
                    <section id="memory-alignment-results" style="display: none;" aria-labelledby="memory-alignment-results-heading"></section>
                     <!-- PROM Burning Results -->
                        <section id="prom-burning-results" style="display: none;" aria-labelledby="prom-burning-results-heading">
                            <div class="glass-card">
                                <h5 id="prom-burning-results-heading" class="text-center mb-4">PROM Burning Results</h5>
                                
                                <!-- PROM Type Badge -->
                                <div class="text-center mb-4">
                                    <span class="badge bg-primary" id="prom-type-badge">4-bit to 7-Segment Display</span>
                                    <span class="badge bg-success" id="prom-size-badge">16  7-bit</span>
                                </div>
                                
                                <!-- Results Container -->
                                <div id="prom-results-container"></div>
                                
                                <!-- Truth Table -->
                                <div id="prom-truth-table-container" class="circuit-truth-table mt-3" style="display: none;">
                                    <h5 class="text-center mb-3">PROM Truth Table</h5>
                                    <table class="truth-table" id="prom-truth-table">
                                        <thead>
                                            <tr>
                                                <th scope="col">Addr</th>
                                                <th scope="col">Binary Input</th>
                                                <th scope="col">Output Pattern</th>
                                                <th scope="col">Hex</th>
                                                <th scope="col">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="prom-truth-table-body">
                                            <!-- Truth table rows will be generated here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- PROM Burning Visualization -->
                                <div id="prom-burning-visualization" class="mt-3" style="display: none;">
                                    <h5 class="text-center mb-3">PROM Burning Process</h5>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             id="prom-burning-progress" style="width: 0%" role="progressbar" 
                                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                    <div class="text-center mt-2">
                                        <span id="prom-burning-status">Ready to burn...</span>
                                    </div>
                                </div>
                                
                                <!-- Export Formats -->
                                <div id="prom-export-formats" class="mt-3" style="display: none;">
                                    <h5 class="text-center mb-3">Export Formats</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="gate-description">
                                                <h6>Intel HEX Format</h6>
                                                <pre id="prom-hex-output" class="bg-dark text-light p-2 rounded" style="font-size: 0.8rem;"></pre>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="gate-description">
                                                <h6>Binary Pattern</h6>
                                                <pre id="prom-binary-output" class="bg-dark text-light p-2 rounded" style="font-size: 0.8rem;"></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Information Card -->
                                <div class="gate-description mt-3">
                                    <h6>PROM Information:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="stats-card">
                                                <div class="stats-value" id="prom-address-lines">4</div>
                                                <small>Address Lines</small>
                                            </div>
                                            <div class="stats-card mt-2">
                                                <div class="stats-value" id="prom-output-lines">7</div>
                                                <small>Output Lines</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="stats-card">
                                                <div class="stats-value" id="prom-locations">16</div>
                                                <small>Memory Locations</small>
                                            </div>
                                            <div class="stats-card mt-2">
                                                <div class="stats-value" id="prom-size">112 bits</div>
                                                <small>Total Size</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                    <!-- ROM Programming Results -->
                    <section id="rom-programming-results" style="display: none;" aria-labelledby="rom-programming-results-heading">
                        <div class="glass-card">
                            <h5 id="rom-programming-results-heading" class="text-center mb-4">ROM Programming Results</h5>
                            
                            <!-- ROM Type Selection -->
                            <div class="mb-4 text-center">
                                <div class="btn-group" role="group" aria-label="ROM Types">
                                    <button type="button" class="btn btn-outline-primary active" data-rom-type="decimal-excess3">
                                        4-input to 164-bit ROM  Decimal to 8421 BCD to Excess-3 Code Converter
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-rom-type="custom-function">
                                        Generic ROM Programming Tool  Any Boolean Function (Up to 4 variables)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Results Container -->
                            <div id="rom-results-container"></div>
                        </div>
                    </section>
                    
                    <!-- Additional Visualization Areas -->
                    <div id="binary-visualization" class="mt-3" style="display: none;">
                        <div class="glass-card">
                            <h5 class="text-center mb-3">Binary Bit Breakdown</h5>
                            <div id="bit-display" class="text-center">
                                <!-- Bit visualization will be shown here -->
                            </div>
                        </div>
                    </div>
                    
                    <section id="cache-truth-table-container" class="circuit-truth-table mt-3" style="display: none;" aria-labelledby="cache-truth-table-heading">
                        <h5 id="cache-truth-table-heading" class="text-center mb-3">Cache Mapping Table</h5>
                        <table class="truth-table" id="cache-truth-table">
                            <!-- Cache mapping table will be generated here -->
                        </table>
                    </section>
                </div>
                <!-- End of Right Column -->
            </div>
            <!-- End of Inner Row -->
        </div>
        <!-- End of glass-card -->
    </div>
    <!-- End of col-12 -->
</div>
<!-- End of Advanced Memory Operations Tab -->
 <!-- PLA Programming Section -->
<div class="row mt-4" id="pla-programming-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-layer-group me-2"></i>PLA Programming (AND-OR Arrays)</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <!-- Input Controls -->
                    <div class="gate-description">
                        <h5>PLA Configuration:</h5>
                        
                        <div class="input-count-control mt-3">
                            <h6>Input Variables (Select 2-4 variables)</h6>
                            
                            <div class="input-toggle">
                                <span class="input-label">Number of Variables:</span>
                                <select id="pla-variables-count" class="input-count-input">
                                    <option value="2">2 Variables (A,B)</option>
                                    <option value="3" selected>3 Variables (A,B,C)</option>
                                    <option value="4">4 Variables (A,B,C,D)</option>
                                </select>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Input Method:</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="pla-input-type" id="pla-minterms" checked>
                                    <label class="form-check-label" for="pla-minterms">
                                        Minterms (e.g., 1,4,5,9)
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="radio" name="pla-input-type" id="pla-boolean">
                                    <label class="form-check-label" for="pla-boolean">
                                        Boolean Expression (e.g., A'B + AB'C)
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Minterm Input -->
                            <div id="pla-minterms-input" class="mt-3">
                                <div class="gate-description">
                                    <label for="pla-minterms-value">Enter Minterms (comma-separated):</label>
                                    <input type="text" id="pla-minterms-value" class="form-control mt-1" 
                                           placeholder="e.g., 1,4,5,9" value="0,1,2,5,6,7">
                                    <small class="text-muted">Enter decimal minterm numbers (0-15 for 4 variables)</small>
                                </div>
                            </div>
                            
                            <!-- Boolean Expression Input -->
                            <div id="pla-boolean-input" class="mt-3" style="display: none;">
                                <div class="gate-description">
                                    <label for="pla-boolean-value">Enter Boolean Expression:</label>
                                    <input type="text" id="pla-boolean-value" class="form-control mt-1" 
                                           placeholder="e.g., A'B + AB'C + BC'D'">
                                    <small class="text-muted">Use + for OR, space or nothing for AND, ' for NOT</small>
                                    
                                    <div class="mt-2">
                                        <strong>Examples:</strong>
                                        <div class="small"> A'B + AB'C (3 variables)</div>
                                        <div class="small"> A'BC + ABC' + AB'C'D (4 variables)</div>
                                        <div class="small"> F1: A'B + AB', F2: AB + BC (Multiple outputs)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Multiple Outputs -->
                            <div class="mt-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="pla-multiple-outputs">
                                    <label class="form-check-label" for="pla-multiple-outputs">
                                        Multiple Output Functions
                                    </label>
                                </div>
                                <small class="text-muted">For multiple functions like F1, F2, F3</small>
                            </div>
                            
                            <!-- Add Function Button for Multiple Outputs -->
                            <div id="pla-add-function-div" class="mt-3" style="display: none;">
                                <button class="btn-glow btn-sm" id="pla-add-function-btn">
                                    <i class="fas fa-plus me-1"></i>Add Another Output Function
                                </button>
                            </div>
                            
                            <!-- Dynamic Functions Container -->
                            <div id="pla-functions-container" class="mt-3" style="display: none;">
                                <!-- Additional functions will be added here -->
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="pla-generate-btn">
                                <i class="fas fa-cogs me-2"></i>Generate PLA Design
                            </button>
                            <button class="btn-glow" id="pla-show-kmap-btn">
                                <i class="fas fa-table me-2"></i>Show K-map
                            </button>
                            <button class="btn-glow" id="pla-show-table-btn">
                                <i class="fas fa-list-alt me-2"></i>Show Program Table
                            </button>
                            <button class="btn-glow" id="pla-reset-btn">
                                <i class="fas fa-redo me-2"></i>Reset
                            </button>
                        </div>
                        
                        <!-- PLA Statistics -->
                        <div class="gate-description mt-3">
                            <h6>PLA Statistics:</h6>
                            <div class="stats-card">
                                <div class="stats-value" id="pla-inputs-count">3</div>
                                <small>Input Variables</small>
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="pla-products-count">0</div>
                                <small>Product Terms</small>
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="pla-outputs-count">1</div>
                                <small>Output Functions</small>
                            </div>
                            <div class="stats-card mt-2">
                                <div class="stats-value" id="pla-size">00</div>
                                <small>PLA Size (ANDOR)</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Main Visualization Area -->
                    <div id="pla-visualization-area">
                        <!-- K-map Display -->
                        <div id="pla-kmap-container" class="mt-3" style="display: none;">
                            <div class="glass-card">
                                <h5 class="text-center mb-3">K-map Analysis</h5>
                                <div id="pla-kmap-content" class="text-center">
                                    <!-- K-map will be generated here -->
                                </div>
                                <div id="pla-simplified-expression" class="formula-display mt-3">
                                    <!-- Simplified expression will be shown here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- PLA Program Table -->
                        <div id="pla-table-container" class="mt-3" style="display: none;">
                            <div class="glass-card">
                                <h5 class="text-center mb-3">PLA Program Table</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="pla-program-table">
                                        <!-- Program table will be generated here -->
                                    </table>
                                </div>
                                <div class="mt-3">
                                    <p class="small text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Legend: 1 = Variable true, 0 = Variable false, - = Don't care
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PLA Logic Diagram -->
                        <div id="pla-diagram-container" class="mt-3">
                            <div class="glass-card">
                                <h5 class="text-center mb-3">PLA Logic Diagram (AND-OR Arrays)</h5>
                                <div class="realistic-circuit-container" style="height: 500px; position: relative;" id="pla-circuit-diagram">
                                    <!-- PLA diagram will be generated here -->
                                    <div class="text-center mt-5">
                                        <i class="fas fa-layer-group fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                                        <p class="mt-2">Enter minterms or boolean expression to generate PLA diagram</p>
                                    </div>
                                </div>
                                
                                <!-- PLA Diagram Legend -->
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="gate-symbol-real" style="width: 20px; height: 20px; background: linear-gradient(135deg, #4169E1, #87CEEB);"></div>
                                            <span class="ms-2 small">AND Gate (Product Term)</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="gate-symbol-real" style="width: 20px; height: 20px; background: linear-gradient(135deg, #32CD32, #228B22);"></div>
                                            <span class="ms-2 small">OR Gate (Sum Term)</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="circuit-track" style="width: 30px; height: 3px; background: #8B4513;"></div>
                                            <span class="ms-2 small">Connection (Fuse Intact)</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="circuit-track" style="width: 30px; height: 3px; background: #ddd; opacity: 0.3;"></div>
                                            <span class="ms-2 small">No Connection (Fuse Blown)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step-by-Step Explanation -->
                        <div id="pla-explanation" class="animation-explanation mt-3">
                            <h5>PLA Programming Steps:</h5>
                            <div id="pla-steps-container">
                                <div class="sequential-step" id="pla-step1">
                                    <strong>Step 1: Input Specification</strong>
                                    <p>Enter minterms or boolean expression for the combinational logic function.</p>
                                </div>
                                <div class="sequential-step" id="pla-step2" style="display: none;">
                                    <strong>Step 2: Boolean Minimization</strong>
                                    <p>Simplify the expression using K-map or Boolean algebra to minimize product terms.</p>
                                </div>
                                <div class="sequential-step" id="pla-step3" style="display: none;">
                                    <strong>Step 3: PLA Programming Table</strong>
                                    <p>Create the program table showing inputs, product terms, and outputs.</p>
                                </div>
                                <div class="sequential-step" id="pla-step4" style="display: none;">
                                    <strong>Step 4: AND Array Programming</strong>
                                    <p>Program the AND array to generate required product terms.</p>
                                </div>
                                <div class="sequential-step" id="pla-step5" style="display: none;">
                                    <strong>Step 5: OR Array Programming</strong>
                                    <p>Program the OR array to sum the product terms for each output.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row mt-4" id="sequential-logic-section" style="display: none;">
    <div class="col-12">
        <div class="glass-card">
            <h3 class="text-center mb-4"><i class="fas fa-history me-2"></i>Sequential Logic Operations</h3>
            
            <div class="row">
                <div class="col-md-4">
                    <!-- Sequential Components Selection -->
                    <div class="gate-description">
                        <h5>Select Sequential Component:</h5>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="sr-latch-btn">
                                <i class="fas fa-memory me-2"></i>SR Latch
                            </button>
                            <button class="btn-glow" id="d-latch-btn">
                                <i class="fas fa-save me-2"></i>D Latch
                            </button>
                            <button class="btn-glow" id="d-flipflop-btn">
                                <i class="fas fa-clock me-2"></i>D Flip-Flop
                            </button>
                            <button class="btn-glow" id="jk-flipflop-btn">
                                <i class="fas fa-sync-alt me-2"></i>JK Flip-Flop
                            </button>
                        </div>
                        
                        <!-- SR Latch Inputs -->
                        <div id="sr-latch-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>SR Latch Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Set (S):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sr-input-s">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Reset (R):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sr-input-r">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Current Q:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sr-current-q" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Current Q':</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sr-current-qbar" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">1 (ON)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- D Latch Inputs -->
                        <div id="d-latch-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>D Latch Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Data (D):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="dl-input-d">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Enable (E):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="dl-input-e">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Current Q:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="dl-current-q" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- D Flip-Flop Inputs -->
                        <div id="d-flipflop-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>D Flip-Flop Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Data (D):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="dff-input-d">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clock (CLK):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="dff-input-clk">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Current Q:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="dff-current-q" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- JK Flip-Flop Inputs -->
                        <div id="jk-flipflop-inputs" class="mt-3" style="display: none;">
                            <div class="gate-description">
                                <h6>JK Flip-Flop Inputs</h6>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input J:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="jk-input-j">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Input K:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="jk-input-k">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Clock (CLK):</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="jk-input-clk">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                                
                                <div class="input-toggle mt-2">
                                    <span class="input-label">Current Q:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="jk-current-q" disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="ms-2">0 (OFF)</span>
                                </div>
                            </div>
                        </div>

<!-- Sequential Circuit-2 Operations Tab -->

   <!-- T Flip-Flop Inputs -->
<div id="t-flipflop-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6>T Flip-Flop Inputs</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Toggle (T):</span>
            <label class="toggle-switch">
                <input type="checkbox" id="tff-input-t">
                <span class="toggle-slider"></span>
            </label>
            <span class="ms-2">0 (OFF)</span>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Clock (CLK):</span>
            <label class="toggle-switch">
                <input type="checkbox" id="tff-input-clk">
                <span class="toggle-slider"></span>
            </label>
            <span class="ms-2">0 (OFF)</span>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Current Q:</span>
            <label class="toggle-switch">
                <input type="checkbox" id="tff-current-q" disabled>
                <span class="toggle-slider"></span>
            </label>
            <span class="ms-2">0 (OFF)</span>
        </div>
    </div>
</div>

<!-- Register Storage Inputs -->
<div id="register-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6>Register Storage Configuration</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Register Size:</span>
            <select id="register-size-select" class="form-control mt-1">
                <option value="4">4-bit Register</option>
                <option value="8">8-bit Register</option>
                <option value="16">16-bit Register</option>
            </select>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Operation:</span>
            <select id="register-operation-select" class="form-control mt-1">
                <option value="load">Load Data</option>
                <option value="store">Store Data</option>
                <option value="transfer">Transfer Data</option>
            </select>
        </div>
        
        <!-- Data Input -->
        <div class="input-toggle mt-2">
            <span class="input-label">Data Input:</span>
            <input type="text" id="register-data-input" class="form-control mt-1" 
                   placeholder="Enter binary data (e.g., 1011)" maxlength="16">
            <small class="text-muted">Binary digits (0 or 1) only</small>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Clock (CLK):</span>
            <label class="toggle-switch">
                <input type="checkbox" id="register-input-clk">
                <span class="toggle-slider"></span>
            </label>
            <span class="ms-2">0 (OFF)</span>
        </div>
        
        <!-- For transfer operations -->
        <div id="transfer-controls" class="mt-2" style="display: none;">
            <div class="input-toggle mt-2">
                <span class="input-label">Source Register:</span>
                <select id="source-register-select" class="form-control mt-1">
                    <option value="A">Register A</option>
                    <option value="B">Register B</option>
                    <option value="C">Register C</option>
                </select>
            </div>
            
            <div class="input-toggle mt-2">
                <span class="input-label">Destination Register:</span>
                <select id="dest-register-select" class="form-control mt-1">
                    <option value="A">Register A</option>
                    <option value="B">Register B</option>
                    <option value="C">Register C</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Shift Register Inputs -->
<div id="shift-register-inputs" class="mt-3" style="display: none;">
    <div class="gate-description">
        <h6>Shift Register Configuration</h6>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Register Size:</span>
            <select id="shift-register-size-select" class="form-control mt-1">
                <option value="4">4-bit Shift Register</option>
                <option value="8">8-bit Shift Register</option>
            </select>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Shift Direction:</span>
            <select id="shift-direction-select" class="form-control mt-1">
                <option value="left">Left Shift</option>
                <option value="right">Right Shift</option>
            </select>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Operation:</span>
            <select id="shift-operation-select" class="form-control mt-1">
                <option value="serial-in">Serial In</option>
                <option value="parallel-in">Parallel In</option>
                <option value="serial-out">Serial Out</option>
                <option value="parallel-out">Parallel Out</option>
            </select>
        </div>
        
        <!-- Serial Input -->
        <div id="serial-input-section" class="mt-2">
            <div class="input-toggle">
                <span class="input-label">Serial Input:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="shift-serial-input">
                    <span class="toggle-slider"></span>
                </label>
                <span class="ms-2">0 (OFF)</span>
            </div>
        </div>
        
        <!-- Parallel Input -->
        <div id="parallel-input-section" class="mt-2" style="display: none;">
            <div class="input-toggle">
                <span class="input-label">Parallel Input:</span>
                <input type="text" id="shift-parallel-input" class="form-control mt-1" 
                       placeholder="Enter binary data (e.g., 1011)" maxlength="8">
            </div>
        </div>
        
        <div class="input-toggle mt-2">
            <span class="input-label">Clock (CLK):</span>
            <label class="toggle-switch">
                <input type="checkbox" id="shift-input-clk">
                <span class="toggle-slider"></span>
            </label>
            <span class="ms-2">0 (OFF)</span>
        </div>
        
        <!-- Current Register State -->
        <div class="input-toggle mt-2">
            <span class="input-label">Current State:</span>
            <input type="text" id="shift-current-state" class="form-control mt-1" 
                   placeholder="Current register state" readonly>
        </div>
    </div>
</div>

                        <div class="d-grid gap-2 mt-3">
                            <button class="btn-glow" id="calculate-sequential-btn">
                                <i class="fas fa-calculator me-2"></i>Calculate
                            </button>
                            <button class="btn-glow" id="show-sequential-truth-table-btn">
                                <i class="fas fa-table me-2"></i>Show Truth Table
                            </button>
                            <button class="btn-glow" id="reset-sequential-btn">
                                <i class="fas fa-redo me-2"></i>Reset
                            </button>
                            <button class="btn-glow" id="animate-sequence-btn">
                                <i class="fas fa-play-circle me-2"></i>Animate Sequence
                            </button>
                        </div>
                    </div>
                    
                    <!-- Component Information -->
                    <div class="gate-description mt-3">
                        <h6>Component Information:</h6>
                        <div id="sequential-description">
                            Select a sequential component to see its operation
                        </div>
                        <div class="stats-card mt-2">
                            <div class="stats-value" id="sequential-result">-</div>
                            <small>Current Output (Q)</small>
                        </div>
                        <div class="stats-card mt-2">
                            <div class="stats-value" id="sequential-next-result">-</div>
                            <small>Next State (Q+)</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Circuit Diagram Visualization -->
                    <div class="gate-diagram-container">
                        <div class="circuit-diagram-container" id="sequential-circuit-container">
                            <!-- Sequential circuit diagram will be generated here -->
                            <div class="text-center mt-5">
                                <i class="fas fa-history fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                                <p class="mt-2">Select a sequential component to visualize its circuit</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Truth Table Display -->
                    <div id="sequential-truth-table-container" class="truth-table-container mt-3" style="display: none;">
                        <h5 class="text-center mb-3" id="sequential-truth-table-title">Truth Table</h5>
                        <table class="truth-table" id="sequential-truth-table">
                            <!-- Truth table will be generated here -->
                        </table>
                    </div>
                    
                    <!-- Step-by-step Analysis -->
                    <div id="sequential-analysis" class="animation-explanation mt-3" style="display: none;">
                        <h5 class="text-center mb-3" id="sequential-analysis-title">Step-by-Step Analysis</h5>
                        <div id="sequential-steps-container">
                            <!-- Analysis steps will be shown here -->
                        </div>
                    </div>
                    
                    <!-- State Diagram (for flip-flops) -->
                    <div id="state-diagram-container" class="mt-3" style="display: none;">
                        <div class="glass-card">
                            <h5 class="text-center mb-3">State Transition Diagram</h5>
                            <div class="text-center" id="state-diagram">
                                <!-- State diagram will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                <div class="glass-card mt-4">
                    <h4><i class="fas fa-history me-2"></i>Operation Log</h4>
                    <div class="operation-log" id="operation-log">
                        <!-- Log entries will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State variables
        let currentGate = 'AND'; // Default to AND gate
        let inputs = [0, 0]; // Default: 2 inputs for AND gate
        let output = 0;
        let isAnimating = false;
        let animationStepTime = 1.5; // seconds per step (reduced from 15)
        let currentStep = 0;
        let totalSteps = 0;
        let resetTimer = null;
        let autoResetDelay = 20; // seconds
        // Add this in your existing State variables section:
let booleanVariables = [true, false]; // Default: A=true, B=false
let currentBooleanTabVisible = false;
// Add this to your state variables section
let currentCombinationalTabVisible = false;
let logicVariables = 3;
// Add to state variables section
let currentSOPExpression = '';
let currentPOSExpression = '';
// Add to state variables
let currentConversionType = null; // 'binary-to-gray' or 'gray-to-binary'
// Add to state variables section
let currentParityMode = null; // 'generate' or 'check'
// Add to state variables
let currentArithmeticTabVisible = false;
let currentAdderType = null; // 'half-adder' or 'full-adder'
let adderInputs = [0, 0]; // For half-adder: [A, B]
let fullAdderInputs = [0, 0, 0]; // For full-adder: [A, B, Cin]
let adderOutput = { sum: 0, carry: 0 };
let isAdderAnimating = false;
// Add to state variables section
let currentSubtractorType = null; // 'half-subtractor' or 'full-subtractor'
let halfSubtractorInputs = [0, 0]; // For half-subtractor: [A, B]
let fullSubtractorInputs = [0, 0, 0]; // For full-subtractor: [A, B, Bin]
let subtractorOutput = { difference: 0, borrow: 0 };
// Add to state variables section
let currentBinaryOperation = null; // 'addition' or 'subtraction'
let binaryBits = 8; // Default bit length
let binaryNumber1 = '';
let binaryNumber2 = '';
// Add to state variables
let currentComplementOperation = null; // 'ones-complement' or 'twos-complement'
// Add to state variables section
let currentMuxDecoderTabVisible = false;
let currentMuxDecoderType = null; // 'mux2', 'mux4', 'decoder'
let mux2Inputs = [0, 0, 0]; // [I0, I1, S]
let mux4Inputs = [0, 0, 0, 0, 0, 0]; // [I0, I1, I2, I3, S0, S1]
let decoderInputs = [0, 0, 0]; // [A, B, Enable]
let decoderOutputs = [0, 0, 0, 0]; // [D0, D1, D2, D3]
// Add to state variables section
// Replace the original state variables section with this (around line 45-50)
let currentMuxDecoderComponent = null; // 'mux2', 'mux4', 'decoder', 'demux', 'decoder3x8'
let demuxComponentInputs = [0, 0, 0]; // [Input, Select, Enable]
let demuxComponentOutputs = [0, 0]; // [Y0, Y1]
let decoder3x8ComponentInputs = [0, 0, 0, 0]; // [A, B, C, Enable]
let decoder3x8ComponentOutputs = [0, 0, 0, 0, 0, 0, 0, 0]; // [D0-D7]
// Add to state variables section
let currentPriorityEncoderType = null; // '4to2' or '8to3'
let priorityEncoderInputs = [];
let priorityEncoderSettings = {
    direction: 'highest',
    activeLevel: 'high'
};
// Add to state variables
let currentCircuitType = null;
let currentCircuitTabVisible = false;
let isCircuitAnimating = false;
let circuitInputs = [];
// Add to state variables section
let currentSequentialTabVisible = false;
let currentSequentialComponent = null; // 'sr-latch', 'd-latch', 'd-flipflop', 'jk-flipflop'
let sequentialState = {
    'sr-latch': { Q: 0, Qbar: 1, prevQ: 0 },
    'd-latch': { Q: 0, prevQ: 0 },
    'd-flipflop': { Q: 0, prevQ: 0 },
    'jk-flipflop': { Q: 0, prevQ: 0 }
};
let clockState = 0;
let isSequentialAnimating = false;
let sequenceStep = 0;
// Add to state variables section
let currentSequential2TabVisible = false;
let currentSequential2Component = null; // 't-flipflop', 'register-storage', 'shift-register'
let tFlipFlopState = { Q: 0, prevQ: 0 };
let registerState = {
    R1: Array(8).fill(0),
    R2: Array(8).fill(0),
    R3: Array(8).fill(0)
};
let shiftRegisterState = Array(8).fill(0);
let shiftDirection = 'right';
let isSequential2Animating = false;
// Add to state variables
let currentNumberSystemTabVisible = false;
let currentNumberSystemOperation = null;
let practiceQuestions = [];
let currentQuestionIndex = 0;
let practiceScore = 0;
let practiceTime = 0;
let isPracticeActive = false;
let practiceTimerInterval = null;
// Add to state variables
let currentSignedMagnitudeOperation = null;
// Add to state variables section
let currentSpecialTabVisible = false;
let currentSpecialGate = null;
let specialGateInputs = [0, 0]; // For both gates: [data/signal, enable/control]
// Add this with other state variables
let currentGatePYQTabVisible = false;
let selectedYear = '2023';
let currentPDFPath = 'C:\\Users\\ASUS\\Downloads\\GateQuestion.pdf';
let pdfDocument = null;
let currentPageNum = 1;
let totalPages = 1;
// Add to state variables section
let currentNumberSystem2TabVisible = false;
let currentAdvancedOperation = null;
let currentAdvancedOperations = null;
let asciiDecoder = null;
let sevenSegmentDecoder = null;
// Add to state variables section
let currentDecoder4x16Inputs = [0, 0, 0, 0]; // [A0, A1, A2, A3]
let decoder4x16Enable = 1;
let decoder4x16Outputs = Array(16).fill(0);
// Add this in the state variables section
let currentBCDDecoderInputs = [0, 0, 0, 0]; // [D, C, B, A] where A is LSB
let bcdDecoderOutputs = Array(10).fill(0);
let currentBCDDecoderTabVisible = false;

// Master-Slave Configuration State
// Master-Slave Configuration State
let masterSlaveSystem = null;
let masterSlaveTasks = [];
let currentMasterSlaveTabVisible = false;
let masterSlaveTaskIdCounter = 0;
let systemInitialized = false;
// Add to state variables section
let currentSetupTimeTabVisible = false;
let setupTimeResults = null;
// Add to state variables section
let currentHoldTimeTabVisible = false;
// Add to state variables
let currentMemoryTabVisible = false;
let sramState = {
    storedValue: 1,
    wordLine: 0,
    precharge: 1,
    senseAmp: 0,
    blVoltage: 1.0,
    blbVoltage: 1.0,
    readOutput: -1
};
// Add these variable declarations near the top of your JavaScript file with other global variables
let currentMemoryOperation = null;
let currentAdvancedMemoryTabVisible = false;

        // Gate formulas
        const gateFormulas = {
            'NOT': 'F = A',
            'AND': 'F = A  B  C ...',
            'OR': 'F = A + B + C + ...',
            'NAND': 'F = A  B  C ...',
            'NOR': 'F = A + B + C + ...',
            'XOR': 'F = A  B  C  ...',
            'XNOR': 'F = A  B  C  ...'
        };
        
        // Gate descriptions
        const gateDescriptions = {
            'NOT': 'Logical negation (Inverter). Output is the opposite of input.',
            'AND': 'Output is 1 only if ALL inputs are 1. Logical conjunction.',
            'OR': 'Output is 1 if AT LEAST ONE input is 1. Logical disjunction.',
            'NAND': 'NOT AND. Output is 0 only if ALL inputs are 1.',
            'NOR': 'NOT OR. Output is 0 if AT LEAST ONE input is 1.',
            'XOR': 'Exclusive OR. Output is 1 if ODD number of inputs are 1.',
            'XNOR': 'Exclusive NOR. Output is 1 if EVEN number of inputs are 1.'
        };
        
        // Gate classes for visualization
// Add to gateClasses object:
const gateClasses = {
    'NOT': 'gate-not',
    'AND': 'gate-and',
    'OR': 'gate-or',
    'NAND': 'gate-nand',
    'NOR': 'gate-nor',
    'XOR': 'gate-xor',
    'XNOR': 'gate-xnor',
    'TRISTATE': 'gate-tristate',
    'TRANSMISSION': 'gate-transmission'
};
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set up gate buttons
            document.querySelectorAll('.gate-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const gate = this.getAttribute('data-gate');
                    selectGate(gate);
                    addLog(`Switched to ${gate} gate`, 'info');
                });
            });
            
            // Set up animate button
            document.getElementById('animate-btn').addEventListener('click', function() {
                if (!isAnimating) {
                    animateTruthTable();
                }
            });
            
            // Set up reset button
            document.getElementById('reset-btn').addEventListener('click', function() {
                resetVisualization();
                addLog('Visualization reset', 'info');
            });
            
            // Set up input count apply button
            document.getElementById('apply-input-count').addEventListener('click', function() {
                applyInputCount();
            });
            
            // Set up keyboard shortcut: Shift+R to reset
            document.addEventListener('keydown', function(event) {
                if (event.shiftKey && event.key === 'R') {
                    event.preventDefault();
                    resetVisualization();
                    addLog('Visualization reset (Shift+R shortcut)', 'info');
                    
                    // Visual feedback
                    const resetBtn = document.getElementById('reset-btn');
                    resetBtn.classList.add('highlight');
                    setTimeout(() => resetBtn.classList.remove('highlight'), 1000);
                }
            });
            
            // Initialize with AND gate as default
            selectGate('AND');
            addLog('Application initialized. AND gate selected by default.', 'info');
        });
        // Add event listener for Boolean Algebra tab
document.querySelector('.gate-btn[data-gate="BOOLEAN"]').addEventListener('click', function() {
    selectGate('BOOLEAN');
});

// Add event listeners for Boolean Algebra buttons
document.getElementById('apply-boolean-vars').addEventListener('click', function() {
    applyBooleanVariables();
});

document.getElementById('evaluate-boolean-btn').addEventListener('click', function() {
    evaluateBooleanOperations();
});
document.getElementById('generate-tt-btn').addEventListener('click', function() {
    generateBooleanTruthTable();
});

document.getElementById('verify-laws-btn').addEventListener('click', function() {
    verifyBooleanLaws();
});

// Add event listener for the new tab
document.querySelector('.gate-btn[data-gate="COMBINATIONAL"]').addEventListener('click', function() {
    selectGate('COMBINATIONAL');
});

// Add event listeners for combinational logic buttons
document.getElementById('minimization-method').addEventListener('change', function() {
    updateMinimizationInterface();
});

document.getElementById('logic-variables-select').addEventListener('change', function() {
    logicVariables = parseInt(this.value);
    updateKmapInterface();
});

document.getElementById('minimize-btn').addEventListener('click', function() {
    minimizeLogic();
});

document.getElementById('generate-kmap-btn').addEventListener('click', function() {
    generateKmapVisualization();
});

document.getElementById('clear-minimize-btn').addEventListener('click', function() {
    clearMinimization();
});
// Add these with the other event listeners
document.getElementById('generate-sop-btn').addEventListener('click', function() {
    generateSOPForm();
});

document.getElementById('generate-pos-btn').addEventListener('click', function() {
    generatePOSForm();
});

document.getElementById('compare-forms-btn').addEventListener('click', function() {
    compareCanonicalForms();
});
// Add these event listeners with other button listeners
document.getElementById('convert-sop-to-pos-btn').addEventListener('click', function() {
    convertSOPtoPOS();
});

document.getElementById('convert-pos-to-sop-btn').addEventListener('click', function() {
    convertPOStoSOP();
});
// Add event listeners for the new buttons
document.getElementById('binary-to-gray-btn').addEventListener('click', function() {
    showConversionInterface('binary-to-gray');
});

document.getElementById('gray-to-binary-btn').addEventListener('click', function() {
    showConversionInterface('gray-to-binary');
});

document.getElementById('test-conversions-btn').addEventListener('click', function() {
    testAllConversions();
});

document.getElementById('convert-btn').addEventListener('click', function() {
    performConversion();
});

document.getElementById('clear-conversion-btn').addEventListener('click', function() {
    clearConversion();
});
// Add event listeners for parity buttons
document.getElementById('parity-generation-btn').addEventListener('click', function() {
    showParityInterface('generate');
});

document.getElementById('parity-check-btn').addEventListener('click', function() {
    showParityInterface('check');
});

document.getElementById('test-parity-btn').addEventListener('click', function() {
    testParityExamples();
});

document.getElementById('execute-parity-btn').addEventListener('click', function() {
    executeParityOperation();
});

document.getElementById('clear-parity-btn').addEventListener('click', function() {
    clearParityInterface();
});
// Add event listener for the new tab button
document.querySelector('.gate-btn[data-gate="NUMBER-SYSTEM-2"]')?.addEventListener('click', function() {
    selectGate('NUMBER-SYSTEM-2');
});

// Add event listeners for Number System-2 operations
document.getElementById('excess3-btn')?.addEventListener('click', function() {
    selectAdvancedOperation('excess3');
});

document.getElementById('hamming-btn')?.addEventListener('click', function() {
    selectAdvancedOperation('hamming');
});

document.getElementById('test-both-btn')?.addEventListener('click', function() {
    testBothCodes();
});

document.getElementById('practice-advanced-btn')?.addEventListener('click', function() {
    loadAdvancedPracticeQuestions();
});

// Add event listeners for Excess-3 operations
document.getElementById('excess3-operation')?.addEventListener('change', function() {
    updateExcess3Interface();
});

document.getElementById('calculate-excess3-btn')?.addEventListener('click', function() {
    performExcess3Operation();
});

document.getElementById('show-excess3-table-btn')?.addEventListener('click', function() {
    showExcess3Table();
});

document.getElementById('reset-excess3-btn')?.addEventListener('click', function() {
    resetExcess3();
});
// Add these with other event listeners
document.getElementById('ascii-btn')?.addEventListener('click', function() {
    selectAdvancedOperation('ascii');
});

document.getElementById('seven-segment-btn')?.addEventListener('click', function() {
    selectAdvancedOperation('seven-segment');
});

// ASCII operation listeners
document.getElementById('ascii-operation')?.addEventListener('change', function() {
    updateASCIIInterface();
});

document.getElementById('calculate-ascii-btn')?.addEventListener('click', function() {
    performASCIIOperation();
});

document.getElementById('show-ascii-table-btn')?.addEventListener('click', function() {
    showASCIITable();
});

document.getElementById('test-ascii-btn')?.addEventListener('click', function() {
    testASCIIExamples();
});

document.getElementById('reset-ascii-btn')?.addEventListener('click', function() {
    resetASCII();
});

// 7-Segment operation listeners
document.getElementById('seven-seg-operation')?.addEventListener('change', function() {
    updateSevenSegmentInterface();
});

document.getElementById('calculate-7seg-btn')?.addEventListener('click', function() {
    performSevenSegmentOperation();
});

document.getElementById('animate-7seg-btn')?.addEventListener('click', function() {
    animateSevenSegmentDisplay();
});

document.getElementById('test-7seg-btn')?.addEventListener('click', function() {
    testSevenSegmentExamples();
});

document.getElementById('reset-7seg-btn')?.addEventListener('click', function() {
    resetSevenSegment();
});
// Add event listeners for Hamming Code operations
document.getElementById('hamming-operation')?.addEventListener('change', function() {
    updateHammingInterface();
});

document.getElementById('calculate-hamming-btn')?.addEventListener('click', function() {
    performHammingOperation();
});

document.getElementById('show-hamming-steps-btn')?.addEventListener('click', function() {
    showDetailedHammingSteps();
});

document.getElementById('generate-hamming-examples-btn')?.addEventListener('click', function() {
    generateHammingExamples();
});

document.getElementById('reset-hamming-btn')?.addEventListener('click', function() {
    resetHamming();
});

// Add event listener for the Arithmetic tab button
document.querySelector('.gate-btn[data-gate="ARITHMETIC"]')?.addEventListener('click', function() {
    selectGate('ARITHMETIC');
});

// Add event listeners for adder buttons
document.getElementById('half-adder-btn')?.addEventListener('click', function() {
    selectAdderType('half-adder');
});

document.getElementById('full-adder-btn')?.addEventListener('click', function() {
    selectAdderType('full-adder');
});

document.getElementById('calculate-adder-btn')?.addEventListener('click', function() {
    calculateAdder();
});

document.getElementById('animate-adder-btn')?.addEventListener('click', function() {
    animateAdderTruthTable();
});

document.getElementById('reset-adder-btn')?.addEventListener('click', function() {
    resetAdder();
});
// Add event listeners for subtractor buttons
document.getElementById('half-subtractor-btn')?.addEventListener('click', function() {
    selectSubtractorType('half-subtractor');
});

document.getElementById('full-subtractor-btn')?.addEventListener('click', function() {
    selectSubtractorType('full-subtractor');
});
// Add event listeners for binary operations buttons
document.getElementById('binary-addition-btn')?.addEventListener('click', function() {
    selectBinaryOperation('addition');
});

document.getElementById('binary-subtraction-btn')?.addEventListener('click', function() {
    selectBinaryOperation('subtraction');
});
// Add event listeners for complement operations buttons
document.getElementById('ones-complement-btn')?.addEventListener('click', function() {
    selectComplementOperation('ones-complement');
});

document.getElementById('twos-complement-btn')?.addEventListener('click', function() {
    selectComplementOperation('twos-complement');
});

document.getElementById('calculate-complement-btn')?.addEventListener('click', function() {
    calculateComplement();
});

document.getElementById('animate-complement-btn')?.addEventListener('click', function() {
    showComplementSteps();
});

document.getElementById('reset-complement-btn')?.addEventListener('click', function() {
    resetComplement();
});
// Add event listener for the Gate PYQ tab button
document.querySelector('.gate-btn[data-gate="GATE-PYQ"]')?.addEventListener('click', function() {
    selectGate('GATE-PYQ');
});

// Add event listeners for Gate PYQ controls
document.getElementById('view-pyq-btn')?.addEventListener('click', function() {
    viewQuestionPaper();
});

document.getElementById('download-pyq-btn')?.addEventListener('click', function() {
    downloadQuestionPaper();
});

document.getElementById('print-pyq-btn')?.addEventListener('click', function() {
    printQuestionPaper();
});

document.getElementById('prev-page-btn')?.addEventListener('click', function() {
    navigatePDFPage(-1);
});

document.getElementById('next-page-btn')?.addEventListener('click', function() {
    navigatePDFPage(1);
});

document.getElementById('direct-download-btn')?.addEventListener('click', function() {
    downloadPDFDirect();
});

document.getElementById('print-pdf-btn')?.addEventListener('click', function() {
    printPDF();
});

document.getElementById('save-copy-btn')?.addEventListener('click', function() {
    savePDFCopy();
});

document.getElementById('open-folder-btn')?.addEventListener('click', function() {
    openPDFFolder();
});

document.getElementById('search-pyq-btn')?.addEventListener('click', function() {
    searchInPDF();
});
// Event listeners for number system operations
document.getElementById('binary-decimal-btn')?.addEventListener('click', function() {
    selectNumberSystemOperation('binary-decimal');
});

document.getElementById('binary-hex-btn')?.addEventListener('click', function() {
    selectNumberSystemOperation('binary-hex');
});

document.getElementById('binary-octal-btn')?.addEventListener('click', function() {
    selectNumberSystemOperation('binary-octal');
});

document.getElementById('bcd-btn')?.addEventListener('click', function() {
    selectNumberSystemOperation('bcd');
});

document.getElementById('quick-test-btn')?.addEventListener('click', function() {
    startQuickPracticeTest();
});

document.getElementById('gate-practice-btn')?.addEventListener('click', function() {
    loadGATEPracticeQuestions();
});

// Add event listener for the new tab button
document.querySelector('.gate-btn[data-gate="MUX-DECODER"]')?.addEventListener('click', function() {
    selectGate('MUX-DECODER');
});
// Add this to your existing JavaScript code
document.getElementById('back-to-home-btn').addEventListener('click', function() {
    window.location.href = 'Digital_logic_processor_intro.html';
});
// Add event listeners for MUX/Decoder buttons
document.getElementById('mux2-btn')?.addEventListener('click', function() {
    selectMuxDecoderType('mux2');
});

document.getElementById('mux4-btn')?.addEventListener('click', function() {
    selectMuxDecoderType('mux4');
});

document.getElementById('decoder-btn')?.addEventListener('click', function() {
    selectMuxDecoderType('decoder');
});

document.getElementById('calculate-mux-btn')?.addEventListener('click', function() {
    calculateMuxDecoder();
});

document.getElementById('show-truth-table-btn')?.addEventListener('click', function() {
    showMuxDecoderTruthTable();
});

document.getElementById('reset-mux-btn')?.addEventListener('click', function() {
    resetMuxDecoder();
});
// Add event listeners for new components
document.getElementById('demux-btn')?.addEventListener('click', function() {
    selectMuxDecoderType('demux');
});

document.getElementById('decoder3x8-btn')?.addEventListener('click', function() {
    selectMuxDecoderType('decoder3x8');
});
// Add event listener for Priority Encoder button
document.getElementById('priority-encoder-btn')?.addEventListener('click', function() {
    selectMuxDecoderType('priority-encoder');
});
// Add event listeners for encoder configuration changes
document.getElementById('encoder-type-select')?.addEventListener('change', function() {
    initializePriorityEncoder();
    addLog(`Changed encoder type to ${this.value}`, 'info');
});

document.getElementById('priority-direction-select')?.addEventListener('change', function() {
    priorityEncoderSettings.direction = this.value;
    calculatePriorityEncoder();
    addLog(`Changed priority direction to ${this.value}`, 'info');
});

document.getElementById('active-level-select')?.addEventListener('change', function() {
    priorityEncoderSettings.activeLevel = this.value;
    calculatePriorityEncoder();
    addLog(`Changed active level to ${this.value}`, 'info');
});
// Add this event listener with other MUX/Decoder listeners
document.getElementById('bcd-decoder-btn')?.addEventListener('click', function() {
    selectMuxDecoderType('bcd-decoder');
});

// Add event listener for the Sequential Logic tab button
document.querySelector('.gate-btn[data-gate="SEQUENTIAL"]')?.addEventListener('click', function() {
    selectGate('SEQUENTIAL');
});
// Add event listener for Memory Operations tab
document.querySelector('.gate-btn[data-gate="MEMORY-OPS"]')?.addEventListener('click', function() {
    selectGate('MEMORY-OPS');
});

// Year selector event listeners
document.querySelectorAll('.pyq-year-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        selectYear(this.getAttribute('data-year'));
    });
});

// Add event listeners for sequential component buttons
document.getElementById('sr-latch-btn')?.addEventListener('click', function() {
    selectSequentialComponent('sr-latch');
});

document.getElementById('d-latch-btn')?.addEventListener('click', function() {
    selectSequentialComponent('d-latch');
});

document.getElementById('d-flipflop-btn')?.addEventListener('click', function() {
    selectSequentialComponent('d-flipflop');
});

document.getElementById('jk-flipflop-btn')?.addEventListener('click', function() {
    selectSequentialComponent('jk-flipflop');
});

// Add event listeners for sequential operation buttons
document.getElementById('calculate-sequential-btn')?.addEventListener('click', function() {
    calculateSequential();
});

document.getElementById('show-sequential-truth-table-btn')?.addEventListener('click', function() {
    showSequentialTruthTable();
});

document.getElementById('reset-sequential-btn')?.addEventListener('click', function() {
    resetSequential();
});

document.getElementById('animate-sequence-btn')?.addEventListener('click', function() {
    animateSequentialSequence();
});
// Event listener for the new tab button
document.querySelector('.gate-btn[data-gate="SEQUENTIAL-2"]')?.addEventListener('click', function() {
    selectGate('SEQUENTIAL-2');
});

// Add event listeners for Sequential Circuit-2 buttons
document.getElementById('t-flipflop-btn')?.addEventListener('click', function() {
    selectSequential2Component('t-flipflop');
});

document.getElementById('register-storage-btn')?.addEventListener('click', function() {
    selectSequential2Component('register-storage');
});

document.getElementById('shift-register-btn')?.addEventListener('click', function() {
    selectSequential2Component('shift-register');
});

// Add event listeners for configuration changes
document.getElementById('register-operation-select')?.addEventListener('change', function() {
    updateRegisterInterface();
});

document.getElementById('shift-direction-select')?.addEventListener('change', function() {
    updateShiftRegisterInterface();
});

document.getElementById('shift-mode')?.addEventListener('change', function() {
    const label = this.parentElement.parentElement.querySelector('span:last-child');
    label.textContent = this.checked ? 'Left (ON)' : 'Right (OFF)';
});

// Add event listeners for operation buttons
document.getElementById('calculate-sequential2-btn')?.addEventListener('click', function() {
    calculateSequential2();
});

document.getElementById('show-sequential2-truth-table-btn')?.addEventListener('click', function() {
    showSequential2TruthTable();
});

document.getElementById('animate-sequential2-btn')?.addEventListener('click', function() {
    animateSequential2Operation();
});

document.getElementById('reset-sequential2-btn')?.addEventListener('click', function() {
    resetSequential2();
});

// // Event listener for new tab button
// document.querySelector('.gate-btn[data-gate="MUX-CIRCUIT"]')?.addEventListener('click', function() {
//     selectGate('MUX-CIRCUIT');
// });

// Event listeners for circuit buttons
document.getElementById('circuit-mux2-btn')?.addEventListener('click', function() {
    selectCircuitType('mux2');
});

document.getElementById('circuit-mux4-btn')?.addEventListener('click', function() {
    selectCircuitType('mux4');
});

document.getElementById('circuit-decoder-btn')?.addEventListener('click', function() {
    selectCircuitType('decoder');
});

document.getElementById('circuit-demux-btn')?.addEventListener('click', function() {
    selectCircuitType('demux');
});

document.getElementById('circuit-decoder3x8-btn')?.addEventListener('click', function() {
    selectCircuitType('decoder3x8');
});

document.getElementById('circuit-priority-encoder-btn')?.addEventListener('click', function() {
    selectCircuitType('priority-encoder');
});

document.getElementById('animate-circuit-btn')?.addEventListener('click', function() {
    animateCircuitTruthTable();
});

document.getElementById('reset-circuit-btn')?.addEventListener('click', function() {
    resetCircuit();
});

document.getElementById('show-circuit-truth-table-btn')?.addEventListener('click', function() {
    showCircuitTruthTable();
});
// Add event listener for the circuit diagram button
document.getElementById('circuit-diagram-btn')?.addEventListener('click', function() {
    // Navigate to the circuit diagram HTML file
    window.location.href = 'Logic_Circuit_Diagram.html';
    addLog('Navigating to MUX/DECODER Circuit Diagram page', 'info');
});
// Add event listeners for the new sequential components
document.getElementById('t-flipflop-btn')?.addEventListener('click', function() {
    selectSequentialComponent('t-flipflop');
});

document.getElementById('register-storage-btn')?.addEventListener('click', function() {
    selectSequentialComponent('register');
});

document.getElementById('shift-register-btn')?.addEventListener('click', function() {
    selectSequentialComponent('shift-register');
});
// Event listener for the new tab button
document.querySelector('.gate-btn[data-gate="SEQUENTIAL-2"]')?.addEventListener('click', function() {
    selectGate('SEQUENTIAL-2');
});

// Add event listeners for Sequential Circuit-2 buttons
document.getElementById('t-flipflop-btn')?.addEventListener('click', function() {
    selectSequential2Component('t-flipflop');
});

document.getElementById('register-storage-btn')?.addEventListener('click', function() {
    selectSequential2Component('register-storage');
});

document.getElementById('shift-register-btn')?.addEventListener('click', function() {
    selectSequential2Component('shift-register');
});

// Add event listeners for configuration changes
document.getElementById('register-operation-select')?.addEventListener('change', function() {
    updateRegisterInterface();
});

document.getElementById('shift-direction-select')?.addEventListener('change', function() {
    updateShiftRegisterInterface();
});

document.getElementById('shift-mode')?.addEventListener('change', function() {
    const label = this.parentElement.parentElement.querySelector('span:last-child');
    label.textContent = this.checked ? 'Left (ON)' : 'Right (OFF)';
});

// Add event listeners for operation buttons
document.getElementById('calculate-sequential2-btn')?.addEventListener('click', function() {
    calculateSequential2();
});

document.getElementById('show-sequential2-truth-table-btn')?.addEventListener('click', function() {
    showSequential2TruthTable();
});

document.getElementById('animate-sequential2-btn')?.addEventListener('click', function() {
    animateSequential2Operation();
});

document.getElementById('reset-sequential2-btn')?.addEventListener('click', function() {
    resetSequential2();
});
// Add event listener for signed magnitude button
document.getElementById('signed-magnitude-btn')?.addEventListener('click', function() {
    selectNumberSystemOperation('signed-magnitude');
});
// Add to the gate selection event listeners
document.getElementById('async-reset-btn')?.addEventListener('click', function() {
    showSection('async-reset-inputs');
    hideOtherInputs('async-reset-inputs');
    updateAsyncResetDisplay();
});

// Close button functionality
document.getElementById('close-async-btn')?.addEventListener('click', function() {
    document.getElementById('async-reset-inputs').style.display = 'none';
    clearAsyncResetResults();
});

// Calculate button
document.getElementById('calculate-async-btn')?.addEventListener('click', calculateAsyncReset);

// Truth Table button
document.getElementById('show-async-truth-table-btn')?.addEventListener('click', showAsyncTruthTable);

// Reset button
document.getElementById('reset-async-btn')?.addEventListener('click', resetAsyncFlipFlop);

// Step Through button
document.getElementById('step-async-btn')?.addEventListener('click', stepThroughAsyncExample);


// Add event listener for operation type change
document.getElementById('sm-operation-type')?.addEventListener('change', function() {
    updateSignedMagnitudeInterface();
});
// Add event listener for binary multiplication button
document.getElementById('binary-multiplication-btn')?.addEventListener('click', function() {
    selectNumberSystemOperation('binary-multiplication');
});

// Add event listeners for multiplication buttons
document.getElementById('calculate-multiplication-btn')?.addEventListener('click', function() {
    performBinaryMultiplication();
});

document.getElementById('show-multiplication-steps-btn')?.addEventListener('click', function() {
    showDetailedMultiplicationSteps();
});

document.getElementById('generate-multiplication-examples-btn')?.addEventListener('click', function() {
    generateMultiplicationExamples();
});

document.getElementById('reset-multiplication-btn')?.addEventListener('click', function() {
    resetMultiplication();
});

// Add event listener for 4:16 Decoder button
document.getElementById('decoder4x16-btn')?.addEventListener('click', function() {
    selectMuxDecoderType('decoder4x16');
});

// Add event listeners for 4:16 Decoder action buttons
document.getElementById('calculate-4x16-btn')?.addEventListener('click', function() {
    calculate4x16Decoder();
});

document.getElementById('show-4x16-truth-table-btn')?.addEventListener('click', function() {
    show4x16TruthTable();
});

document.getElementById('reset-4x16-btn')?.addEventListener('click', function() {
    reset4x16Decoder();
});

document.getElementById('close-4x16-btn')?.addEventListener('click', function() {
    close4x16Decoder();
});

// Add toggle event listeners for 4:16 Decoder inputs
document.getElementById('decoder4x16-input-a0')?.addEventListener('change', function() {
    toggle4x16Input(0);
});

document.getElementById('decoder4x16-input-a1')?.addEventListener('change', function() {
    toggle4x16Input(1);
});

document.getElementById('decoder4x16-input-a2')?.addEventListener('change', function() {
    toggle4x16Input(2);
});

document.getElementById('decoder4x16-input-a3')?.addEventListener('change', function() {
    toggle4x16Input(3);
});

document.getElementById('decoder4x16-input-enable')?.addEventListener('change', function() {
    decoder4x16Enable = this.checked ? 1 : 0;
    const label = this.parentElement.parentElement.querySelector('span:last-child');
    label.textContent = decoder4x16Enable ? '1 (ON)' : '0 (OFF)';
    addLog(`4:16 Decoder Enable set to ${decoder4x16Enable}`, 'info');
});

// Add event listener for the Special Gates tab
document.querySelector('.gate-btn[data-gate="SPECIAL"]')?.addEventListener('click', function() {
    selectGate('SPECIAL');
});

// Add event listeners for special gate buttons
document.getElementById('tristate-btn')?.addEventListener('click', function() {
    selectSpecialGate('tristate');
});

document.getElementById('transmission-btn')?.addEventListener('click', function() {
    selectSpecialGate('transmission');
});

document.getElementById('calculate-special-btn')?.addEventListener('click', function() {
    calculateSpecialGate();
});

document.getElementById('show-special-truth-table-btn')?.addEventListener('click', function() {
    showSpecialTruthTable();
});

document.getElementById('animate-special-btn')?.addEventListener('click', function() {
    animateSpecialTruthTable();
});

document.getElementById('reset-special-btn')?.addEventListener('click', function() {
    resetSpecialGate();
});
// Add this event listener with other MUX/Decoder listeners
document.getElementById('bcd-decoder-btn')?.addEventListener('click', function() {
    selectMuxDecoderType('bcd-decoder');
});
// Master-Slave Configuration Event Listeners
// Master-Slave button click
document.getElementById('master-slave-btn')?.addEventListener('click', function() {
    showMasterSlaveInterface();
});

// Initialize system with better feedback
document.getElementById('initialize-master-slave-btn')?.addEventListener('click', async function() {
    await initializeMasterSlaveSystem();
});

// Submit task
document.getElementById('submit-master-slave-task-btn')?.addEventListener('click', function() {
    submitMasterSlaveTask();
});

// View status
document.getElementById('view-master-slave-status-btn')?.addEventListener('click', function() {
    viewMasterSlaveStatus();
});

// Stop/Pause system
document.getElementById('stop-master-slave-btn')?.addEventListener('click', function() {
    if (masterSlaveSystem?.systemStatus === "running") {
        pauseMasterSlaveSystem();
    } else if (masterSlaveSystem?.systemStatus === "paused") {
        resumeMasterSlaveSystem();
    } else {
        stopMasterSlaveSystem();
    }
});

// Exit interface
document.getElementById('exit-master-slave-btn')?.addEventListener('click', function() {
    exitMasterSlaveInterface();
});

// Task type change
document.getElementById('task-type-select')?.addEventListener('change', function() {
    updateTaskTypeInputs(this.value);
});

// Number of slaves controls
document.getElementById('decrease-slaves')?.addEventListener('click', function() {
    const input = document.getElementById('num-slaves-input');
    let value = parseInt(input.value);
    if (value > 1) {
        input.value = value - 1;
    }
});

document.getElementById('increase-slaves')?.addEventListener('click', function() {
    const input = document.getElementById('num-slaves-input');
    let value = parseInt(input.value);
    if (value < 8) {
        input.value = value + 1;
    }
});

// Event listeners for Hold Time Verification
document.getElementById('hold-time-btn').addEventListener('click', function() {
    showHoldTimeSection();
});

document.getElementById('close-hold-time-btn').addEventListener('click', function() {
    hideHoldTimeSection();
});

document.getElementById('calculate-hold-time-btn').addEventListener('click', function() {
    performHoldTimeAnalysis();
});

document.getElementById('generate-hold-time-examples-btn').addEventListener('click', function() {
    generateHoldTimeExamples();
});

document.getElementById('show-hold-time-formulas-btn').addEventListener('click', function() {
    showHoldTimeFormulas();
});
// Add event listeners for BCD Decoder buttons
document.getElementById('calculate-bcd-decoder-btn')?.addEventListener('click', function() {
    calculateBCDDecoder();
});

document.getElementById('show-bcd-decoder-truth-table-btn')?.addEventListener('click', function() {
    showBCDDecoderTruthTable();
});

document.getElementById('reset-bcd-decoder-btn')?.addEventListener('click', function() {
    resetBCDDecoder();
});

document.getElementById('close-bcd-decoder-btn')?.addEventListener('click', function() {
    closeBCDDecoder();
});

// Add toggle event listeners for special gates
document.getElementById('tristate-data')?.addEventListener('change', function() {
    toggleSpecialInput(0);
});

document.getElementById('tristate-enable')?.addEventListener('change', function() {
    toggleSpecialInput(1);
});

document.getElementById('transmission-signal')?.addEventListener('change', function() {
    toggleSpecialInput(0);
});

document.getElementById('transmission-control')?.addEventListener('change', function() {
    toggleSpecialInput(1);
});
// Add toggle event listeners for adder inputs
function setupAdderInputListeners() {
    // Half-Adder inputs
    document.getElementById('ha-input-a')?.addEventListener('change', function() {
        toggleAdderInput(0, 'half-adder');
    });
    document.getElementById('ha-input-b')?.addEventListener('change', function() {
        toggleAdderInput(1, 'half-adder');
    });
    
    // Full-Adder inputs
    document.getElementById('fa-input-a')?.addEventListener('change', function() {
        toggleAdderInput(0, 'full-adder');
    });
    document.getElementById('fa-input-b')?.addEventListener('change', function() {
        toggleAdderInput(1, 'full-adder');
    });
    document.getElementById('fa-input-cin')?.addEventListener('change', function() {
        toggleAdderInput(2, 'full-adder');
    });
}
// Add this to your existing JavaScript code
document.getElementById('moore-mealy-machine-btn').addEventListener('click', function() {
    // Navigate to MooreMealy_Machine.html
    window.location.href = 'MooreMealy_Machine.html';
    
    // Optional: Show a loading message or confirmation
    console.log('Navigating to Moore/Mealy Machines page...');
    
    // Optional: You can also add a confirmation dialog
    // if (confirm('Navigate to Moore/Mealy Machines page?')) {
    //     window.location.href = 'MooreMealy_Machine.html';
    // }
});
// Add toggle event listeners for subtractor inputs
function setupSubtractorInputListeners() {
    // Half-Subtractor inputs
    document.getElementById('hs-input-a')?.addEventListener('change', function() {
        toggleSubtractorInput(0, 'half-subtractor');
    });
    document.getElementById('hs-input-b')?.addEventListener('change', function() {
        toggleSubtractorInput(1, 'half-subtractor');
    });
    
    // Full-Subtractor inputs
    document.getElementById('fs-input-a')?.addEventListener('change', function() {
        toggleSubtractorInput(0, 'full-subtractor');
    });
    document.getElementById('fs-input-b')?.addEventListener('change', function() {
        toggleSubtractorInput(1, 'full-subtractor');
    });
    document.getElementById('fs-input-bin')?.addEventListener('change', function() {
        toggleSubtractorInput(2, 'full-subtractor');
    });
}
// First, add this helper function at the top level to show/hide all sections properly
function showMainInterfaceSections() {
    // Show all main interface sections
    document.querySelector('.col-md-8 .glass-card').style.display = 'block';
    document.querySelector('.glass-card.mt-4').style.display = 'block';
    document.getElementById('boolean-algebra-section').style.display = 'block';
    document.getElementById('combinational-logic-section').style.display = 'block';
    document.getElementById('arithmetic-section').style.display = 'block';
    document.getElementById('mux-decoder-section').style.display = 'block';
    document.getElementById('mux-circuit-section').style.display = 'block';
    
    // Hide sequential logic section
    document.getElementById('sequential-logic-section').style.display = 'none';
    currentSequentialTabVisible = false;
}
// Setup advanced memory operation buttons
function setupAdvancedMemoryOperationButtons() {
    document.getElementById('address-decoding-btn').onclick = function() {
        selectMemoryOperation('address-decoding');
    };
    
    document.getElementById('cache-mapping-btn').onclick = function() {
        selectMemoryOperation('cache-mapping');
    };
    
    document.getElementById('tlb-operation-btn').onclick = function() {
        selectMemoryOperation('tlb-operation');
    };
    
    document.getElementById('memory-alignment-btn').onclick = function() {
        selectMemoryOperation('memory-alignment');
    };
}

// Add styles for visualization
const styles = document.createElement('style');
styles.textContent = `
.bit-visualization {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid var(--border-color);
}

.bit-row {
    display: flex;
    margin-bottom: 5px;
}

.bit-cell {
    flex: 1;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-color);
    font-size: 10px;
    background: var(--bg-color);
    cursor: help;
}

.bit-labels {
    display: flex;
    margin-top: 5px;
}

.bit-label {
    text-align: center;
    font-size: 11px;
    color: var(--text-muted);
    padding: 2px;
}

.bit-breakdown {
    display: flex;
    height: 40px;
    border-radius: 6px;
    overflow: hidden;
    margin-top: 10px;
}

.bit-segment {
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 12px;
}

.bit-segment.tag { background: #4a6fa5; }
.bit-segment.index { background: #6a994e; }
.bit-segment.offset { background: #bc4749; }

.alignment-visual {
    margin-top: 20px;
}

.memory-line {
    position: relative;
    height: 60px;
    background: linear-gradient(to right, var(--card-bg), #2c3e50);
    border-radius: 8px;
    border: 2px solid var(--border-color);
}

.address-label {
    position: absolute;
    top: 5px;
    left: 10px;
    background: var(--primary-color);
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: bold;
}

.boundary-marker {
    position: absolute;
    bottom: 0;
    width: 4px;
    height: 40px;
    transform: translateX(-50%);
}

.boundary-marker.aligned {
    background: #2ecc71;
}

.boundary-marker.misaligned {
    background: #e74c3c;
}

.marker-label {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    white-space: nowrap;
    color: var(--text-color);
}

.monospace {
    font-family: 'Courier New', monospace;
    font-size: 12px;
}
`;
document.head.appendChild(styles);


        // Select a gate and update visualization
        // Select a gate and update visualization
function selectGate(gate) {
    currentGate = gate;
    
    // Update active button
    document.querySelectorAll('.gate-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-gate') === gate) {
            btn.classList.add('active');
        }
    });
    
    // Reset ALL tab visibility flags when switching tabs
    // This ensures only the selected tab shows
    currentBooleanTabVisible = false;
    currentCombinationalTabVisible = false;
    currentArithmeticTabVisible = false;
    currentMuxDecoderTabVisible = false;
    currentSequentialTabVisible = false;
    currentSequential2TabVisible = false;
    currentCircuitTabVisible = false;
    currentNumberSystemTabVisible = false;
    currentSpecialTabVisible = false;
    currentGatePYQTabVisible = false;
    currentNumberSystem2TabVisible = false;
    currentMemoryTabVisible = false; // Added Memory Operations flag
    currentAdvancedMemoryTabVisible = false;
    currentPLATabVisible = false; // Added PLA Programming flag

    // Hide ALL sections first
    document.querySelector('.col-md-8 .glass-card').style.display = 'none';
    document.querySelector('.glass-card.mt-4').style.display = 'none';
    document.getElementById('boolean-algebra-section').style.display = 'none';
    document.getElementById('combinational-logic-section').style.display = 'none';
    document.getElementById('arithmetic-section').style.display = 'none';
    document.getElementById('mux-decoder-section').style.display = 'none';
    document.getElementById('sequential-logic-section').style.display = 'none';
    document.getElementById('sequential-circuit2-section').style.display = 'none';
    document.getElementById('mux-circuit-section').style.display = 'none';
    document.getElementById('number-system-section').style.display = 'none';
    document.getElementById('special-gates-section').style.display = 'none';
    document.getElementById('gate-pyq-section').style.display = 'none';
    document.getElementById('number-system2-section').style.display = 'none';
    document.getElementById('memory-operations-section').style.display = 'none'; // Added Memory Operations section
    document.getElementById('pla-programming-section').style.display = 'none'; // Added PLA section
        // Hide ALL sections first
    const sections = [
        'boolean-algebra-section',
        'combinational-logic-section',
        'arithmetic-section',
        'mux-decoder-section',
        'sequential-logic-section',
        'sequential-circuit2-section',
        'mux-circuit-section',
        'number-system-section',
        'special-gates-section',
        'gate-pyq-section',
        'number-system2-section',
        'memory-operations-section',
        'advanced-memory-section'
    ];
    
    sections.forEach(section => {
        const el = document.getElementById(section);
        if (el) el.style.display = 'none';
    });

    // Now handle each specific gate/tab
    if (gate === 'SEQUENTIAL') {
        // Show Sequential Logic section
        document.getElementById('sequential-logic-section').style.display = 'block';
        currentSequentialTabVisible = true;
        
        // Initialize sequential logic interface
        if (!currentSequentialComponent) {
            selectSequentialComponent('sr-latch');
        }
        
        addLog('Switched to Sequential Logic Operations tab', 'info');
        return;
    }
        // Handle PLA Programming gate
    if (gate === 'PLA-PROGRAMMING') {
        // Show PLA Programming section
        document.getElementById('pla-programming-section').style.display = 'block';
        currentPLATabVisible = true;
        
        // Initialize PLA Programming interface
        initializePLAProgramming();
        addLog('Switched to PLA Programming tab', 'info');
        return;
    }

    if (gate === 'MUX-DECODER') {
        // Show MUX/Decoder section
        document.getElementById('mux-decoder-section').style.display = 'block';
        currentMuxDecoderTabVisible = true;
        
        // Initialize interface
        initializeMuxDecoder();
        addLog('Switched to Multiplexers & Decoders tab', 'info');
        return;
    }
    
    if (gate === 'NUMBER-SYSTEM-2') {
        // Show Number System-2 section
        document.getElementById('number-system2-section').style.display = 'block';
        currentNumberSystem2TabVisible = true;
        
        // Initialize interface
        if (!currentAdvancedOperation) {
            selectAdvancedOperation('excess3');
        }
        
        // Initialize decoders
        asciiDecoder = new ASCIIDecoder();
        sevenSegmentDecoder = new SevenSegmentDecoder();
        
        addLog('Switched to Advanced Number System Operations tab', 'info');
        return;
    }
        // Handle Advanced Memory gate
    if (gate === 'ADV-MEMORY') {
        document.getElementById('advanced-memory-section').style.display = 'block';
        currentAdvancedMemoryTabVisible = true;
        
        // Initialize with address decoding as default
        if (!currentMemoryOperation) {
            selectMemoryOperation('address-decoding');
        }
        
        // Setup operation buttons
        setupAdvancedMemoryOperationButtons();
        
        addLog('Switched to Advanced Memory Operations tab', 'info');
        return;
    }
    if (gate === 'GATE-PYQ') {
        // Show Gate PYQ section
        document.getElementById('gate-pyq-section').style.display = 'block';
        currentGatePYQTabVisible = true;
        
        // Initialize interface
        initializeGatePYQ();
        addLog('Switched to GATE Previous Year Questions tab', 'info');
        return;
    }
    
    if (gate === 'NUMBER-SYSTEM') {
        // Show Number System section
        document.getElementById('number-system-section').style.display = 'block';
        currentNumberSystemTabVisible = true;
        
        // Initialize with binary-decimal converter
        if (!currentNumberSystemOperation) {
            selectNumberSystemOperation('binary-decimal');
        }
        
        addLog('Switched to Number System Operations tab', 'info');
        return;
    }
    
    if (gate === 'SPECIAL') {
        // Show Special Gates section
        document.getElementById('special-gates-section').style.display = 'block';
        currentSpecialTabVisible = true;
        
        // Initialize interface
        if (!currentSpecialGate) {
            selectSpecialGate('tristate');
        }
        
        addLog('Switched to Special Gates tab', 'info');
        return;
    }
    
    if (gate === 'SEQUENTIAL-2') {
        // Show Sequential Circuit-2 section
        document.getElementById('sequential-circuit2-section').style.display = 'block';
        currentSequential2TabVisible = true;
        
        // Initialize interface
        if (!currentSequential2Component) {
            selectSequential2Component('t-flipflop');
        }
        
        addLog('Switched to Advanced Sequential Circuit Operations tab', 'info');
        return;
    }
    
    if (gate === 'MEMORY-OPS') {
        // Show Memory Operations section
        document.getElementById('memory-operations-section').style.display = 'block';
        currentMemoryTabVisible = true;
        
        // Initialize SRAM interface
        initializeSRAMInterface();
        addLog('Switched to Memory Operations tab', 'info');
        return;
    }
    
    if (gate === 'ARITHMETIC') {
        // Show Arithmetic section
        document.getElementById('arithmetic-section').style.display = 'block';
        currentArithmeticTabVisible = true;
        
        // Initialize arithmetic operations
        initializeArithmeticOperations();
        setupSubtractorInputListeners();
        
        addLog('Switched to Arithmetic Operations tab', 'info');
        return;
    }
    
    if (gate === 'BOOLEAN') {
        // Show Boolean Algebra section
        document.getElementById('boolean-algebra-section').style.display = 'block';
        currentBooleanTabVisible = true;
        
        // Initialize Boolean Algebra interface
        initializeBooleanAlgebra();
        addLog('Switched to Boolean Algebra Operations tab', 'info');
        return;
    }
    // Add to the selectGate function
if (gate === 'ADV-MEMORY') {
    // Show Advanced Memory section
    document.getElementById('advanced-memory-section').style.display = 'block';
    currentAdvancedMemoryTabVisible = true;
    
    // Initialize interface
    if (!currentMemoryOperation) {
        selectMemoryOperation('address-decoding');
    }
    
    addLog('Switched to Advanced Memory Operations tab', 'info');
    return;
}

    if (gate === 'COMBINATIONAL') {
        // Show Combinational Logic section
        document.getElementById('combinational-logic-section').style.display = 'block';
        currentCombinationalTabVisible = true;
        
        // Initialize interface
        initializeCombinationalLogic();
        addLog('Switched to Combinational Logic Operations tab', 'info');
        return;
    }
    
    // Default gate visualization for basic gates (AND, OR, NOT, etc.)
    document.querySelector('.col-md-8 .glass-card').style.display = 'block';
    document.querySelector('.glass-card.mt-4').style.display = 'block';
    
    // Update gate description
    document.getElementById('gate-description').textContent = gateDescriptions[gate];
    
    // Update gate name display
    document.getElementById('current-gate-name').textContent = `${gate} Gate`;
    
    // Handle input count based on gate type
    if (gate === 'NOT') {
        // NOT gate only allows 1 input
        document.getElementById('input-count-input').value = 1;
        document.getElementById('input-count-input').min = 1;
        document.getElementById('input-count-input').max = 1;
        document.getElementById('input-count-input').disabled = true;
        inputs = [0]; // Single input
    } else {
        // Other gates allow 2-5 inputs
        document.getElementById('input-count-input').min = 2;
        document.getElementById('input-count-input').max = 5;
        document.getElementById('input-count-input').disabled = false;
        const currentCount = parseInt(document.getElementById('input-count-input').value);
        if (currentCount < 2 || currentCount > 5) {
            document.getElementById('input-count-input').value = 2;
            inputs = Array(2).fill(0);
        } else {
            inputs = Array(currentCount).fill(0);
        }
    }

    // Calculate initial output
    output = calculateOutput();
    document.getElementById('output-value').textContent = output;
    
    // Update input count display
    document.getElementById('input-count-display').textContent = inputs.length;
    
    // Update input toggles
    updateInputToggles();
    
    // Update visualization
    updateGateVisualization();
    updateTruthTable();
    
    // Clear any previous error
    document.getElementById('input-count-error').innerHTML = '';
}
    

  
        // Apply input count from user input
        function applyInputCount() {
            const inputCount = parseInt(document.getElementById('input-count-input').value);
            const errorDiv = document.getElementById('input-count-error');
            
            // Clear previous error
            errorDiv.innerHTML = '';
            errorDiv.style.color = 'var(--danger-color)';
            
            // Validate input count based on gate type
            if (currentGate === 'NOT') {
                if (inputCount !== 1) {
                    errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>NOT gate only accepts 1 input variable!';
                    document.getElementById('input-count-input').value = 1;
                    addLog('Error: NOT gate only accepts 1 input variable', 'error');
                    return;
                }
            } else {
                if (inputCount < 2 || inputCount > 5) {
                    errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Please enter number of inputs between 2 to 5!';
                    document.getElementById('input-count-input').value = 2;
                    addLog('Error: Input count must be between 2 and 5', 'error');
                    return;
                }
            }
            
            // Update inputs array
            inputs = Array(inputCount).fill(0);
            
            // Update display
            document.getElementById('input-count-display').textContent = inputCount;
            output = calculateOutput();
            document.getElementById('output-value').textContent = output;
            
            // Update visualization
            updateInputToggles();
            updateGateVisualization();
            updateTruthTable();
            
            addLog(`Input count set to ${inputCount} for ${currentGate} gate`, 'success');
        }
        
        // Update input toggle controls
        function updateInputToggles() {
            const togglesContainer = document.getElementById('input-toggles');
            togglesContainer.innerHTML = '';
            
            inputs.forEach((value, index) => {
                const toggleId = `input-${index}`;
                const inputLabel = String.fromCharCode(65 + index); // A, B, C, etc.
                
                const toggleDiv = document.createElement('div');
                toggleDiv.className = 'input-toggle';
                
                toggleDiv.innerHTML = `
                    <span class="input-label">${inputLabel}:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="${toggleId}" ${value ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">${value ? '1 (ON)' : '0 (OFF)'}</span>
                `;
                
                togglesContainer.appendChild(toggleDiv);
                
                // Add event listener to toggle
                const toggleInput = document.getElementById(toggleId);
                toggleInput.addEventListener('change', function() {
                    toggleInputValue(index);
                });
            });
        }
        
        // Toggle an input value
        function toggleInputValue(index) {
            inputs[index] = inputs[index] ? 0 : 1;
            output = calculateOutput();
            
            // Update display
            document.getElementById('output-value').textContent = output;
            
            // Update input toggle display
            const toggleInput = document.getElementById(`input-${index}`);
            const toggleLabel = toggleInput.parentElement.parentElement.querySelector('span:last-child');
            toggleLabel.textContent = inputs[index] ? '1 (ON)' : '0 (OFF)';
            
            // Update visualization
            updateGateVisualization();
            updateTruthTable();
            
            // Add to log
            const inputLabel = String.fromCharCode(65 + index);
            addLog(`Toggled input ${inputLabel} to ${inputs[index]}`, 'success');
        }
        
        // Calculate output based on current gate and inputs
        function calculateOutput() {
            switch(currentGate) {
                case 'NOT':
                    return inputs[0] ? 0 : 1;
                    
                case 'AND':
                    return inputs.every(input => input === 1) ? 1 : 0;
                    
                case 'OR':
                    return inputs.some(input => input === 1) ? 1 : 0;
                    
                case 'NAND':
                    return inputs.every(input => input === 1) ? 0 : 1;
                    
                case 'NOR':
                    return inputs.some(input => input === 1) ? 0 : 1;
                    
                case 'XOR':
                    // XOR is true if odd number of inputs are true
                    const xorSum = inputs.reduce((sum, val) => sum + val, 0);
                    return (xorSum % 2 === 1) ? 1 : 0;
                    
                case 'XNOR':
                    // XNOR is true if even number of inputs are true (including 0)
                    const xnorSum = inputs.reduce((sum, val) => sum + val, 0);
                    return (xnorSum % 2 === 0) ? 1 : 0;
                    
                default:
                    return 0;
            }
        }
        
        // Update the gate visualization diagram with standard symbols
        function updateGateVisualization() {
            const visualization = document.getElementById('gate-visualization');
            visualization.innerHTML = '';
            
            const inputCount = inputs.length;
            
            // Create gate symbol container
            const gateContainer = document.createElement('div');
            gateContainer.className = 'gate-symbol-container';
            
            // Create gate shape based on current gate
            const gateShape = document.createElement('div');
            gateShape.className = `gate-shape ${gateClasses[currentGate]}`;
            
            // Create gate label
            const gateLabel = document.createElement('div');
            gateLabel.className = 'gate-label';
            gateLabel.textContent = currentGate;
            
            gateShape.appendChild(gateLabel);
            gateContainer.appendChild(gateShape);
            visualization.appendChild(gateContainer);
            
            // Create input nodes on the left side
            if (inputCount === 1) {
                // Single input - center it vertically
                const inputNode = document.createElement('div');
                inputNode.className = `input-node ${inputs[0] ? 'active' : 'inactive'}`;
                inputNode.textContent = 'A';
                inputNode.style.left = '20%';
                inputNode.style.top = '50%';
                inputNode.style.transform = 'translateY(-50%)';
                
                inputNode.addEventListener('click', function() {
                    if (!isAnimating) {
                        toggleInputValue(0);
                    }
                });
                
                visualization.appendChild(inputNode);
                
                // Create connection line from input to gate
                const connectionLine = document.createElement('div');
                connectionLine.className = `connection-line ${inputs[0] ? 'active' : 'inactive'}`;
                connectionLine.style.left = '20%';
                connectionLine.style.width = '30%';
                connectionLine.style.top = '50%';
                connectionLine.style.transform = 'translateY(-50%)';
                connectionLine.style.height = '6px';
                visualization.appendChild(connectionLine);
            } else {
                // Multiple inputs - distribute vertically
                const inputSpacing = 100 / (inputCount + 1);
                
                for (let i = 0; i < inputCount; i++) {
                    // Calculate vertical position for each input
                    const topPosition = inputSpacing * (i + 1);
                    
                    const inputNode = document.createElement('div');
                    inputNode.className = `input-node ${inputs[i] ? 'active' : 'inactive'}`;
                    inputNode.textContent = String.fromCharCode(65 + i);
                    inputNode.style.left = '20%';
                    inputNode.style.top = `${topPosition}%`;
                    inputNode.style.transform = 'translateY(-50%)';
                    
                    inputNode.addEventListener('click', function() {
                        if (!isAnimating) {
                            toggleInputValue(i);
                        }
                    });
                    
                    visualization.appendChild(inputNode);
                    
                    // Create connection line from input to gate
                    const connectionLine = document.createElement('div');
                    connectionLine.className = `connection-line ${inputs[i] ? 'active' : 'inactive'}`;
                    connectionLine.style.left = '20%';
                    connectionLine.style.width = '30%';
                    connectionLine.style.top = `${topPosition}%`;
                    connectionLine.style.transform = 'translateY(-50%)';
                    connectionLine.style.height = '6px';
                    visualization.appendChild(connectionLine);
                }
            }
            
            // Create output node on the right side
            const outputNode = document.createElement('div');
            outputNode.className = `output-node ${output ? 'active' : 'inactive'}`;
            outputNode.textContent = 'Q';
            outputNode.style.right = '20%';
            outputNode.style.top = '50%';
            outputNode.style.transform = 'translateY(-50%)';
            visualization.appendChild(outputNode);
            
            // Create connection line from gate to output
            const outputConnection = document.createElement('div');
            outputConnection.className = `connection-line ${output ? 'active' : 'inactive'}`;
            outputConnection.style.left = '50%';
            outputConnection.style.width = '30%';
            outputConnection.style.top = '50%';
            outputConnection.style.transform = 'translateY(-50%)';
            outputConnection.style.height = '6px';
            visualization.appendChild(outputConnection);
        }
        
        // Generate and update the truth table
        function updateTruthTable() {
            const table = document.getElementById('truth-table');
            table.innerHTML = '';
            
            // Create header row
            const headerRow = document.createElement('tr');
            
            // Input headers
            for (let i = 0; i < inputs.length; i++) {
                const th = document.createElement('th');
                th.textContent = String.fromCharCode(65 + i);
                headerRow.appendChild(th);
            }
            
            // Output header
            const outputTh = document.createElement('th');
            outputTh.textContent = 'Output';
            headerRow.appendChild(outputTh);
            table.appendChild(headerRow);
            
            // Generate all possible input combinations
            const totalCombinations = Math.pow(2, inputs.length);
            
            for (let i = 0; i < totalCombinations; i++) {
                const row = document.createElement('tr');
                
                // Convert i to binary and pad with zeros
                const binary = i.toString(2).padStart(inputs.length, '0');
                
                // Create cells for each input
                for (let j = 0; j < inputs.length; j++) {
                    const td = document.createElement('td');
                    const value = parseInt(binary[j]);
                    td.textContent = value;
                    td.className = value ? 'active' : 'inactive';
                    row.appendChild(td);
                }
                
                // Calculate output for this combination
                const inputValues = binary.split('').map(bit => parseInt(bit));
                const outputValue = calculateGateOutput(currentGate, inputValues);
                
                // Create cell for output
                const outputTd = document.createElement('td');
                outputTd.textContent = outputValue;
                outputTd.className = outputValue ? 'active' : 'inactive';
                row.appendChild(outputTd);
                
                // Highlight current combination
                if (binary === inputs.map(input => input.toString()).join('')) {
                    row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
                    row.style.fontWeight = 'bold';
                }
                
                table.appendChild(row);
            }
        }
        
        // Calculate gate output for given inputs
        function calculateGateOutput(gate, inputValues) {
            switch(gate) {
                case 'NOT':
                    return inputValues[0] ? 0 : 1;
                    
                case 'AND':
                    return inputValues.every(input => input === 1) ? 1 : 0;
                    
                case 'OR':
                    return inputValues.some(input => input === 1) ? 1 : 0;
                    
                case 'NAND':
                    return inputValues.every(input => input === 1) ? 0 : 1;
                    
                case 'NOR':
                    return inputValues.some(input => input === 1) ? 0 : 1;
                    
                case 'XOR':
                    const xorSum = inputValues.reduce((sum, val) => sum + val, 0);
                    return (xorSum % 2 === 1) ? 1 : 0;
                    
                case 'XNOR':
                    const xnorSum = inputValues.reduce((sum, val) => sum + val, 0);
                    return (xnorSum % 2 === 0) ? 1 : 0;
                    
                default:
                    return 0;
            }
        }
        
        // Animate through the truth table
      // Replace the existing animateTruthTable() function with this updated version:
function animateTruthTable() {
    if (isAnimating) return;
    
    isAnimating = true;
    const animateBtn = document.getElementById('animate-btn');
    animateBtn.disabled = true;
    animateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Animating...';
    
    const totalCombinations = Math.pow(2, inputs.length);
    
    // Show step counter
    document.getElementById('step-counter').style.display = 'block';
    
    // Show animation explanation area
    const explanationDiv = document.getElementById('animation-explanation');
    explanationDiv.style.display = 'block';
    
    // Clear previous explanations
    explanationDiv.innerHTML = `
        <div class="formula-display">${gateFormulas[currentGate]}</div>
        <div id="all-steps-container">
            <!-- All steps will be inserted here -->
        </div>
    `;
    
    const allStepsContainer = document.getElementById('all-steps-container');
    
    // Store all steps
    const allSteps = [];
    
    // Generate all combinations
    for (let i = 0; i < totalCombinations; i++) {
        const binary = i.toString(2).padStart(inputs.length, '0');
        const inputValues = binary.split('').map(bit => parseInt(bit));
        const outputValue = calculateGateOutput(currentGate, inputValues);
        
        allSteps.push({
            stepNumber: i + 1,
            binary: binary,
            inputValues: inputValues,
            output: outputValue,
            explanation: generateStepExplanation(currentGate, inputValues, outputValue, i + 1, totalCombinations)
        });
    }
    
    // Display all steps initially (collapsed)
    allSteps.forEach(step => {
        const stepDiv = document.createElement('div');
        stepDiv.className = 'calculation-step';
        stepDiv.id = `step-${step.stepNumber}`;
        stepDiv.innerHTML = step.explanation;
        allStepsContainer.appendChild(stepDiv);
    });
    
    // Set initial progress
    currentStep = 0;
    totalSteps = totalCombinations;
    
    updateProgressBar();
    addLog(`Starting truth table animation for ${currentGate} gate with ${inputs.length} inputs (${totalSteps} steps)`, 'info');
    
    // Function to animate through steps
    function animateStep(stepIndex) {
        if (stepIndex >= allSteps.length) {
            // Animation complete
            completeAnimation();
            return;
        }
        
        const step = allSteps[stepIndex];
        currentStep = stepIndex + 1;
        
        // Update step counter
        document.getElementById('step-counter').textContent = `Step ${currentStep}/${totalSteps}`;
        
        // Update progress bar
        updateProgressBar();
        
        // Update inputs based on current step
        inputs = [...step.inputValues];
        output = step.output;
        
        // Update display
        document.getElementById('output-value').textContent = output;
        updateInputToggles();
        updateGateVisualization();
        updateTruthTable();
        
        // Remove active class from all steps
        document.querySelectorAll('.calculation-step').forEach(div => {
            div.classList.remove('active');
            div.style.opacity = '0.7';
        });
        
        // Highlight current step
        const currentStepDiv = document.getElementById(`step-${step.stepNumber}`);
        currentStepDiv.classList.add('active');
        currentStepDiv.style.opacity = '1';
        
        // Scroll to current step
        currentStepDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Add to log
        const inputLabels = inputs.map((val, idx) => `${String.fromCharCode(65 + idx)}=${val}`).join(', ');
        addLog(`Step ${step.stepNumber}/${totalSteps}: ${inputLabels}  Output=${output}`, 'success');
        
        // Process next step after delay
        setTimeout(() => {
            animateStep(stepIndex + 1);
        }, animationStepTime * 1000);
    }
    
    // Start animation
    animateStep(0);
}

// Add this helper function to generate step explanations:
function generateStepExplanation(gate, inputValues, output, stepNumber, totalSteps) {
    let explanation = `
        <div class="calculation-title">Step ${stepNumber} of ${totalSteps}: ${gate} Gate Operation</div>
        <div class="calculation-content">
            <div><strong>Input Values:</strong> ${inputValues.map((val, idx) => `${String.fromCharCode(65 + idx)} = ${val}`).join(', ')}</div>
    `;
    
    // Add specific explanation based on gate type
    switch(gate) {
        case 'NOT':
            explanation += `
                <div><strong>NOT Operation:</strong> Output is the opposite of input</div>
                <div>Since A = ${inputValues[0]}, then NOT(A) = ${inputValues[0] ? '0' : '1'}</div>
                <div class="highlight-equation">Output = ${output}</div>
            `;
            break;
            
        case 'AND':
            const andAllOnes = inputValues.every(i => i === 1);
            explanation += `
                <div><strong>AND Operation:</strong> Output is 1 only if ALL inputs are 1</div>
                <div>Current inputs: ${inputValues.join(', ')}</div>
                <div>${andAllOnes ? ' ALL inputs are 1' : ' At least one input is 0'}</div>
                <div class="highlight-equation">Output = ${output}</div>
            `;
            break;
            
        case 'OR':
            const orAnyOne = inputValues.some(i => i === 1);
            explanation += `
                <div><strong>OR Operation:</strong> Output is 1 if AT LEAST ONE input is 1</div>
                <div>Current inputs: ${inputValues.join(', ')}</div>
                <div>${orAnyOne ? ' At least one input is 1' : ' All inputs are 0'}</div>
                <div class="highlight-equation">Output = ${output}</div>
            `;
            break;
            
        case 'NAND':
            const nandAllOnes = inputValues.every(i => i === 1);
            explanation += `
                <div><strong>NAND Operation:</strong> Output is 0 only if ALL inputs are 1</div>
                <div>Current inputs: ${inputValues.join(', ')}</div>
                <div>${nandAllOnes ? ' ALL inputs are 1  Output is 0' : ' Not all inputs are 1  Output is 1'}</div>
                <div class="highlight-equation">Output = ${output}</div>
            `;
            break;
            
        case 'NOR':
            const norAnyOne = inputValues.some(i => i === 1);
            explanation += `
                <div><strong>NOR Operation:</strong> Output is 0 if AT LEAST ONE input is 1</div>
                <div>Current inputs: ${inputValues.join(', ')}</div>
                <div>${norAnyOne ? ' At least one input is 1  Output is 0' : ' All inputs are 0  Output is 1'}</div>
                <div class="highlight-equation">Output = ${output}</div>
            `;
            break;
            
        case 'XOR':
            const xorCount = inputValues.filter(i => i === 1).length;
            const isXorOdd = (xorCount % 2 === 1);
            explanation += `
                <div><strong>XOR Operation:</strong> Output is 1 if ODD number of inputs are 1</div>
                <div>Current inputs: ${inputValues.join(', ')}</div>
                <div>Number of 1s: ${xorCount} (${isXorOdd ? ' ODD' : ' EVEN'})</div>
                <div class="highlight-equation">Output = ${output}</div>
            `;
            break;
            
        case 'XNOR':
            const xnorCount = inputValues.filter(i => i === 1).length;
            const isXnorEven = (xnorCount % 2 === 0);
            explanation += `
                <div><strong>XNOR Operation:</strong> Output is 1 if EVEN number of inputs are 1</div>
                <div>Current inputs: ${inputValues.join(', ')}</div>
                <div>Number of 1s: ${xnorCount} (${isXnorEven ? ' EVEN' : ' ODD'})</div>
                <div class="highlight-equation">Output = ${output}</div>
            `;
            break;
    }
    
    explanation += `
        </div>
    `;
    
    return explanation;
}
  // Add this helper function to update progress bar:
function updateProgressBar() {
    const progressPercent = (currentStep / totalSteps) * 100;
    document.getElementById('progress-fill').style.width = `${progressPercent}%`;
}

// Add this function to handle animation completion:
function completeAnimation() {
    isAnimating = false;
    const animateBtn = document.getElementById('animate-btn');
    animateBtn.disabled = false;
    animateBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i>Animate Truth Table';
    
    // Update progress bar to 100%
    document.getElementById('progress-fill').style.width = '100%';
    
    // Hide step counter
    document.getElementById('step-counter').style.display = 'none';
    
    addLog('Truth table animation completed', 'info');
    
    // Start auto-reset timer (20 seconds)
    startAutoResetTimer();
}
      
        // Show detailed explanation for current combination
        function showDetailedExplanation(binary) {
            const explanationDiv = document.getElementById('animation-explanation');
            
            // Create detailed explanation
            let explanationHTML = `
                <div class="formula-display">${gateFormulas[currentGate]}</div>
                <div class="calculation-step">
                    <div class="calculation-title">Step ${currentStep + 1} of ${totalSteps}: ${currentGate} Gate Operation</div>
                    <div class="calculation-content">
                        <div>Input Values: ${inputs.map((val, idx) => `${String.fromCharCode(65 + idx)} = ${val}`).join(', ')}</div>
            `;
            
            // Add specific explanation based on gate type
            switch(currentGate) {
                case 'NOT':
                    explanationHTML += `
                        <div>NOT Operation: Output is the opposite of input</div>
                        <div>Since A = ${inputs[0]}, then NOT(A) = ${inputs[0] ? '0' : '1'}</div>
                        <div class="highlight-equation">Output = ${output}</div>
                    `;
                    break;
                    
                case 'AND':
                    explanationHTML += `
                        <div>AND Operation: Output is 1 only if ALL inputs are 1</div>
                        <div>Current inputs: ${inputs.join(', ')}</div>
                        <div>${inputs.every(i => i === 1) ? 'ALL inputs are 1' : 'At least one input is 0'}</div>
                        <div class="highlight-equation">Output = ${output}</div>
                    `;
                    break;
                    
                case 'OR':
                    explanationHTML += `
                        <div>OR Operation: Output is 1 if AT LEAST ONE input is 1</div>
                        <div>Current inputs: ${inputs.join(', ')}</div>
                        <div>${inputs.some(i => i === 1) ? 'At least one input is 1' : 'All inputs are 0'}</div>
                        <div class="highlight-equation">Output = ${output}</div>
                    `;
                    break;
                    
                case 'NAND':
                    explanationHTML += `
                        <div>NAND Operation: Output is 0 only if ALL inputs are 1</div>
                        <div>Current inputs: ${inputs.join(', ')}</div>
                        <div>${inputs.every(i => i === 1) ? 'ALL inputs are 1  Output is 0' : 'Not all inputs are 1  Output is 1'}</div>
                        <div class="highlight-equation">Output = ${output}</div>
                    `;
                    break;
                    
                case 'NOR':
                    explanationHTML += `
                        <div>NOR Operation: Output is 0 if AT LEAST ONE input is 1</div>
                        <div>Current inputs: ${inputs.join(', ')}</div>
                        <div>${inputs.some(i => i === 1) ? 'At least one input is 1  Output is 0' : 'All inputs are 0  Output is 1'}</div>
                        <div class="highlight-equation">Output = ${output}</div>
                    `;
                    break;
                    
                case 'XOR':
                    const xorCount = inputs.filter(i => i === 1).length;
                    explanationHTML += `
                        <div>XOR Operation: Output is 1 if ODD number of inputs are 1</div>
                        <div>Current inputs: ${inputs.join(', ')}</div>
                        <div>Number of 1s: ${xorCount} (${xorCount % 2 === 1 ? 'ODD' : 'EVEN'})</div>
                        <div class="highlight-equation">Output = ${output}</div>
                    `;
                    break;
                    
                case 'XNOR':
                    const xnorCount = inputs.filter(i => i === 1).length;
                    explanationHTML += `
                        <div>XNOR Operation: Output is 1 if EVEN number of inputs are 1</div>
                        <div>Current inputs: ${inputs.join(', ')}</div>
                        <div>Number of 1s: ${xnorCount} (${xnorCount % 2 === 0 ? 'EVEN' : 'ODD'})</div>
                        <div class="highlight-equation">Output = ${output}</div>
                    `;
                    break;
            }
            
            explanationHTML += `
                    </div>
                </div>
            `;
            
            explanationDiv.innerHTML = explanationHTML;
        }
        
        // Start auto-reset timer (20 seconds)
        function startAutoResetTimer() {
            let timeLeft = autoResetDelay;
            document.getElementById('reset-timer').textContent = timeLeft;
            
            // Clear any existing timer
            if (resetTimer) {
                clearInterval(resetTimer);
            }
            
            resetTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('reset-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(resetTimer);
                    resetToDefaultState();
                }
            }, 1000);
        }
        
        // Reset to default state (AND gate with 2 inputs)
        function resetToDefaultState() {
            // Reset to AND gate
            selectGate('AND');
            
            // Reset input count to 2
            document.getElementById('input-count-input').value = 2;
            applyInputCount();
            
            // Hide animation explanation
            document.getElementById('animation-explanation').style.display = 'none';
            
            // Reset progress bar
            document.getElementById('progress-fill').style.width = '0%';
            
            addLog('Auto-reset: Returned to default AND gate configuration', 'info');
        }
        
        // Reset the entire visualization
        function resetVisualization() {
            // Clear auto-reset timer
            if (resetTimer) {
                clearInterval(resetTimer);
                resetTimer = null;
            }
            
            // Reset to current gate with all inputs 0
            for (let i = 0; i < inputs.length; i++) {
                inputs[i] = 0;
            }
            
            output = calculateOutput();
            document.getElementById('output-value').textContent = output;
            
            updateInputToggles();
            updateGateVisualization();
            updateTruthTable();
            
            // Hide animation explanation
            document.getElementById('animation-explanation').style.display = 'none';
            
            // Reset progress bar
            document.getElementById('progress-fill').style.width = '0%';
            
            // Hide step counter
            document.getElementById('step-counter').style.display = 'none';
            
            // Reset timer display
            document.getElementById('reset-timer').textContent = autoResetDelay;
        }
        function initializeBooleanAlgebra() {
    // Set default variables
    booleanVariables = [true, false];
    updateBooleanVariableToggles();
}

function updateBooleanVariableToggles() {
    const container = document.getElementById('boolean-variable-values');
    container.innerHTML = '';
    
    booleanVariables.forEach((value, index) => {
        const varLabel = String.fromCharCode(65 + index); // A, B, C
        const toggleId = `bool-var-${index}`;
        
        const toggleDiv = document.createElement('div');
        toggleDiv.className = 'input-toggle';
        toggleDiv.innerHTML = `
            <span class="input-label">${varLabel}:</span>
            <label class="toggle-switch">
                <input type="checkbox" id="${toggleId}" ${value ? 'checked' : ''}>
                <span class="toggle-slider"></span>
            </label>
            <span class="ms-2">${value ? 'True' : 'False'}</span>
        `;
        
        container.appendChild(toggleDiv);
        
        // Add event listener
        const toggleInput = document.getElementById(toggleId);
        toggleInput.addEventListener('change', function() {
            booleanVariables[index] = !booleanVariables[index];
            const toggleLabel = toggleInput.parentElement.parentElement.querySelector('span:last-child');
            toggleLabel.textContent = booleanVariables[index] ? 'True' : 'False';
            addLog(`Set variable ${varLabel} to ${booleanVariables[index]}`, 'info');
        });
    });
}

function applyBooleanVariables() {
    const varCount = parseInt(document.getElementById('boolean-variables-select').value);
    booleanVariables = [];
    
    // Initialize variables (first true, others false)
    for (let i = 0; i < varCount; i++) {
        booleanVariables.push(i === 0); // A=true, others false by default
    }
    
    updateBooleanVariableToggles();
    addLog(`Set ${varCount} boolean variables`, 'success');
}
function evaluateBooleanOperations() {
    const explanationDiv = document.getElementById('boolean-explanation');
    explanationDiv.style.display = 'block';
    
    let explanation = '<div class="calculation-step active"><div class="calculation-title">Boolean Algebra Evaluation - All 11 Laws</div>';
    explanation += '<div class="calculation-content">';
    
    // Display variable values
    const varLabels = booleanVariables.map((val, idx) => 
        `${String.fromCharCode(65 + idx)} = ${val}`
    ).join(', ');
    explanation += `<div><strong>Current Variables:</strong> ${varLabels}</div><hr>`;
    
    // 1. Basic Operations
    explanation += `<div><strong>1. Basic Operations:</strong></div>`;
    
    // Complement operations
    explanation += `<div class="mt-1"><em>Complement Operations:</em></div>`;
    booleanVariables.forEach((val, idx) => {
        const varLabel = String.fromCharCode(65 + idx);
        const complement = !val;
        explanation += `<div>${varLabel} = (${val}) = ${complement}</div>`;
    });
    
    // Multiplication operations (AND)
    if (booleanVariables.length >= 2) {
        explanation += `<div class="mt-1"><em>Multiplication Operations (AND):</em></div>`;
        for (let i = 0; i < booleanVariables.length; i++) {
            for (let j = i + 1; j < booleanVariables.length; j++) {
                const varA = String.fromCharCode(65 + i);
                const varB = String.fromCharCode(65 + j);
                const result = booleanVariables[i] && booleanVariables[j];
                explanation += `<div>${varA}  ${varB} = ${booleanVariables[i]}  ${booleanVariables[j]} = ${result}</div>`;
            }
        }
    }
    
    // Addition operations (OR)
    if (booleanVariables.length >= 2) {
        explanation += `<div class="mt-1"><em>Addition Operations (OR):</em></div>`;
        for (let i = 0; i < booleanVariables.length; i++) {
            for (let j = i + 1; j < booleanVariables.length; j++) {
                const varA = String.fromCharCode(65 + i);
                const varB = String.fromCharCode(65 + j);
                const result = booleanVariables[i] || booleanVariables[j];
                explanation += `<div>${varA} + ${varB} = ${booleanVariables[i]}  ${booleanVariables[j]} = ${result}</div>`;
            }
        }
    }
    
    // 2. Boolean Algebra Laws Evaluation (All 11 Laws)
    explanation += `<hr><div><strong>2. Boolean Algebra Laws Evaluation (11 Laws):</strong></div>`;
    
    // 2.1 Idempotent Law: A + A = A, A  A = A
    explanation += `<div class="mt-2"><strong>1. Idempotent Law:</strong></div>`;
    explanation += `<div><em>A + A = A, A  A = A</em></div>`;
    
    for (let i = 0; i < booleanVariables.length; i++) {
        const varLabel = String.fromCharCode(65 + i);
        const value = booleanVariables[i];
        
        // A + A = A
        const orResult = value || value;
        const orVerified = orResult === value;
        
        // A  A = A
        const andResult = value && value;
        const andVerified = andResult === value;
        
        explanation += `<div>${varLabel} + ${varLabel} = ${value}  ${value} = ${orResult} ${orVerified ? '' : ''}</div>`;
        explanation += `<div>${varLabel}  ${varLabel} = ${value}  ${value} = ${andResult} ${andVerified ? '' : ''}</div>`;
    }
    
    // 2.2 Commutative Law: A + B = B + A, A  B = B  A
    if (booleanVariables.length >= 2) {
        explanation += `<div class="mt-2"><strong>2. Commutative Law:</strong></div>`;
        explanation += `<div><em>A + B = B + A, A  B = B  A</em></div>`;
        
        for (let i = 0; i < booleanVariables.length; i++) {
            for (let j = i + 1; j < booleanVariables.length; j++) {
                const varA = String.fromCharCode(65 + i);
                const varB = String.fromCharCode(65 + j);
                const valA = booleanVariables[i];
                const valB = booleanVariables[j];
                
                // A + B = B + A
                const orAB = valA || valB;
                const orBA = valB || valA;
                const orVerified = orAB === orBA;
                
                // A  B = B  A
                const andAB = valA && valB;
                const andBA = valB && valA;
                const andVerified = andAB === andBA;
                
                explanation += `<div>${varA} + ${varB} = ${valA}  ${valB} = ${orAB}</div>`;
                explanation += `<div>${varB} + ${varA} = ${valB}  ${valA} = ${orBA} ${orVerified ? '' : ''}</div>`;
                explanation += `<div>${varA}  ${varB} = ${valA}  ${valB} = ${andAB}</div>`;
                explanation += `<div>${varB}  ${varA} = ${valB}  ${valA} = ${andBA} ${andVerified ? '' : ''}</div>`;
            }
        }
    }
    
    // 2.3 Associative Law: (A + B) + C = A + (B + C), (AB)C = A(BC)
    if (booleanVariables.length >= 3) {
        explanation += `<div class="mt-2"><strong>3. Associative Law:</strong></div>`;
        explanation += `<div><em>(A + B) + C = A + (B + C), (AB)C = A(BC)</em></div>`;
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        const valC = booleanVariables[2];
        
        // (A + B) + C = A + (B + C)
        const leftOr = (valA || valB) || valC;
        const rightOr = valA || (valB || valC);
        const orVerified = leftOr === rightOr;
        
        // (A  B)  C = A  (B  C)
        const leftAnd = (valA && valB) && valC;
        const rightAnd = valA && (valB && valC);
        const andVerified = leftAnd === rightAnd;
        
        explanation += `<div>(A + B) + C = (${valA}  ${valB})  ${valC} = ${leftOr}</div>`;
        explanation += `<div>A + (B + C) = ${valA}  (${valB}  ${valC}) = ${rightOr} ${orVerified ? '' : ''}</div>`;
        explanation += `<div>(A  B)  C = (${valA}  ${valB})  ${valC} = ${leftAnd}</div>`;
        explanation += `<div>A  (B  C) = ${valA}  (${valB}  ${valC}) = ${rightAnd} ${andVerified ? '' : ''}</div>`;
    }
    
    // 2.4 Distributive Law: A(B + C) = AB + AC, A + (BC) = (A+B)(A+C)
    if (booleanVariables.length >= 3) {
        explanation += `<div class="mt-2"><strong>4. Distributive Law:</strong></div>`;
        explanation += `<div><em>A(B + C) = AB + AC, A + (BC) = (A+B)(A+C)</em></div>`;
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        const valC = booleanVariables[2];
        
        // A(B + C) = AB + AC
        const leftDist1 = valA && (valB || valC);
        const rightDist1 = (valA && valB) || (valA && valC);
        const dist1Verified = leftDist1 === rightDist1;
        
        // A + (BC) = (A+B)(A+C)
        const leftDist2 = valA || (valB && valC);
        const rightDist2 = (valA || valB) && (valA || valC);
        const dist2Verified = leftDist2 === rightDist2;
        
        explanation += `<div>A(B + C) = ${valA}  (${valB}  ${valC}) = ${leftDist1}</div>`;
        explanation += `<div>AB + AC = (${valA}  ${valB})  (${valA}  ${valC}) = ${rightDist1} ${dist1Verified ? '' : ''}</div>`;
        explanation += `<div>A + (BC) = ${valA}  (${valB}  ${valC}) = ${leftDist2}</div>`;
        explanation += `<div>(A+B)(A+C) = (${valA}  ${valB})  (${valA}  ${valC}) = ${rightDist2} ${dist2Verified ? '' : ''}</div>`;
    }
    
    // 2.5 De Morgan's Theorem: (A+B) = AB, (AB) = A+B
    if (booleanVariables.length >= 2) {
        explanation += `<div class="mt-2"><strong>5. De Morgan's Theorem:</strong></div>`;
        explanation += `<div><em>(A+B) = AB, (AB) = A+B</em></div>`;
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        
        // (A + B) = A  B
        const leftDemorgan1 = !(valA || valB);
        const rightDemorgan1 = (!valA) && (!valB);
        const demorgan1Verified = leftDemorgan1 === rightDemorgan1;
        
        // (A  B) = A + B
        const leftDemorgan2 = !(valA && valB);
        const rightDemorgan2 = (!valA) || (!valB);
        const demorgan2Verified = leftDemorgan2 === rightDemorgan2;
        
        explanation += `<div>(A + B) = (${valA}  ${valB}) = ${leftDemorgan1}</div>`;
        explanation += `<div>A  B = (${valA})  (${valB}) = ${rightDemorgan1} ${demorgan1Verified ? '' : ''}</div>`;
        explanation += `<div>(A  B) = (${valA}  ${valB}) = ${leftDemorgan2}</div>`;
        explanation += `<div>A + B = (${valA})  (${valB}) = ${rightDemorgan2} ${demorgan2Verified ? '' : ''}</div>`;
    }
    
    // 2.6 Absorption Law: A + AB = A, A(A + B) = A
    if (booleanVariables.length >= 2) {
        explanation += `<div class="mt-2"><strong>6. Absorption Law:</strong></div>`;
        explanation += `<div><em>A + AB = A, A(A + B) = A</em></div>`;
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        
        // A + AB = A
        const leftAbsorb1 = valA || (valA && valB);
        const rightAbsorb1 = valA;
        const absorb1Verified = leftAbsorb1 === rightAbsorb1;
        
        // A(A + B) = A
        const leftAbsorb2 = valA && (valA || valB);
        const rightAbsorb2 = valA;
        const absorb2Verified = leftAbsorb2 === rightAbsorb2;
        
        explanation += `<div>A + AB = ${valA}  (${valA}  ${valB}) = ${leftAbsorb1}</div>`;
        explanation += `<div>A = ${rightAbsorb1} ${absorb1Verified ? '' : ''}</div>`;
        explanation += `<div>A(A + B) = ${valA}  (${valA}  ${valB}) = ${leftAbsorb2}</div>`;
        explanation += `<div>A = ${rightAbsorb2} ${absorb2Verified ? '' : ''}</div>`;
    }
    
    // 2.7 Consensus Theorem: AB + AC + BC = AB + AC
    if (booleanVariables.length >= 3) {
        explanation += `<div class="mt-2"><strong>7. Consensus Theorem:</strong></div>`;
        explanation += `<div><em>AB + AC + BC = AB + AC</em></div>`;
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        const valC = booleanVariables[2];
        
        // AB + AC + BC = AB + AC
        const leftConsensus = (valA && valB) || (!valA && valC) || (valB && valC);
        const rightConsensus = (valA && valB) || (!valA && valC);
        const consensusVerified = leftConsensus === rightConsensus;
        
        explanation += `<div>AB + AC + BC = (${valA}  ${valB})  (${valA}  ${valC})  (${valB}  ${valC}) = ${leftConsensus}</div>`;
        explanation += `<div>AB + AC = (${valA}  ${valB})  (${valA}  ${valC}) = ${rightConsensus} ${consensusVerified ? '' : ''}</div>`;
    }
    
    // 2.8 Identity Laws: A + 0 = A, A  1 = A
    explanation += `<div class="mt-2"><strong>8. Identity Laws:</strong></div>`;
    explanation += `<div><em>A + 0 = A, A  1 = A</em></div>`;
    
    for (let i = 0; i < booleanVariables.length; i++) {
        const varLabel = String.fromCharCode(65 + i);
        const value = booleanVariables[i];
        
        // A + 0 = A
        const orIdentity = value || false;
        const orIdentityVerified = orIdentity === value;
        
        // A  1 = A
        const andIdentity = value && true;
        const andIdentityVerified = andIdentity === value;
        
        explanation += `<div>${varLabel} + 0 = ${value}  false = ${orIdentity} ${orIdentityVerified ? '' : ''}</div>`;
        explanation += `<div>${varLabel}  1 = ${value}  true = ${andIdentity} ${andIdentityVerified ? '' : ''}</div>`;
    }
    
    // 2.9 Null Laws: A + 1 = 1, A  0 = 0
    explanation += `<div class="mt-2"><strong>9. Null Laws:</strong></div>`;
    explanation += `<div><em>A + 1 = 1, A  0 = 0</em></div>`;
    
    for (let i = 0; i < booleanVariables.length; i++) {
        const varLabel = String.fromCharCode(65 + i);
        const value = booleanVariables[i];
        
        // A + 1 = 1
        const orNull = value || true;
        const orNullVerified = orNull === true;
        
        // A  0 = 0
        const andNull = value && false;
        const andNullVerified = andNull === false;
        
        explanation += `<div>${varLabel} + 1 = ${value}  true = ${orNull} ${orNullVerified ? '' : ''}</div>`;
        explanation += `<div>${varLabel}  0 = ${value}  false = ${andNull} ${andNullVerified ? '' : ''}</div>`;
    }
    
    // 2.10 Involution Law: (A) = A
    explanation += `<div class="mt-2"><strong>10. Involution Law:</strong></div>`;
    explanation += `<div><em>(A) = A</em></div>`;
    
    for (let i = 0; i < booleanVariables.length; i++) {
        const varLabel = String.fromCharCode(65 + i);
        const value = booleanVariables[i];
        
        // (A) = A
        const involution = !(!value);
        const involutionVerified = involution === value;
        
        explanation += `<div>(${varLabel}) = (${value}) = ${involution} ${involutionVerified ? '' : ''}</div>`;
    }
    
    // 2.11 Redundancy Elimination Laws: A + AB = A + B, A(A+B) = AB
    if (booleanVariables.length >= 2) {
        explanation += `<div class="mt-2"><strong>11. Redundancy Elimination Laws:</strong></div>`;
        explanation += `<div><em>A + AB = A + B, A(A+B) = AB</em></div>`;
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        
        // A + AB = A + B
        const leftRedundancy1 = valA || (!valA && valB);
        const rightRedundancy1 = valA || valB;
        const redundancy1Verified = leftRedundancy1 === rightRedundancy1;
        
        // A(A+B) = AB
        const leftRedundancy2 = valA && (!valA || valB);
        const rightRedundancy2 = valA && valB;
        const redundancy2Verified = leftRedundancy2 === rightRedundancy2;
        
        explanation += `<div>A + AB = ${valA}  (${valA}  ${valB}) = ${leftRedundancy1}</div>`;
        explanation += `<div>A + B = ${valA}  ${valB} = ${rightRedundancy1} ${redundancy1Verified ? '' : ''}</div>`;
        explanation += `<div>A(A+B) = ${valA}  (${valA}  ${valB}) = ${leftRedundancy2}</div>`;
        explanation += `<div>AB = ${valA}  ${valB} = ${rightRedundancy2} ${redundancy2Verified ? '' : ''}</div>`;
    }
    
    // 3. Summary of All 11 Laws Evaluation
    explanation += `<hr><div><strong>3. Evaluation Summary (All 11 Laws):</strong></div>`;
    
    // Count verified laws
    const lawsVerified = [];
    
    // Helper function to check law verification
    function checkLaw(name, condition) {
        const verified = condition;
        lawsVerified.push({ name: name, verified: verified });
        return verified;
    }
    
    // Check each law
    checkLaw('Idempotent', true); // Always true by definition
    
    let commutativeOK = true;
    if (booleanVariables.length >= 2) {
        for (let i = 0; i < booleanVariables.length; i++) {
            for (let j = i + 1; j < booleanVariables.length; j++) {
                const valA = booleanVariables[i];
                const valB = booleanVariables[j];
                if (!((valA || valB) === (valB || valA) && (valA && valB) === (valB && valA))) {
                    commutativeOK = false;
                    break;
                }
            }
            if (!commutativeOK) break;
        }
    }
    checkLaw('Commutative', commutativeOK);
    
    let associativeOK = false;
    if (booleanVariables.length >= 3) {
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        const valC = booleanVariables[2];
        associativeOK = ((valA || valB) || valC) === (valA || (valB || valC)) && 
                       ((valA && valB) && valC) === (valA && (valB && valC));
    }
    checkLaw('Associative', associativeOK);
    
    let distributiveOK = false;
    if (booleanVariables.length >= 3) {
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        const valC = booleanVariables[2];
        distributiveOK = (valA && (valB || valC)) === ((valA && valB) || (valA && valC)) &&
                        (valA || (valB && valC)) === ((valA || valB) && (valA || valC));
    }
    checkLaw('Distributive', distributiveOK);
    
    let deMorganOK = false;
    if (booleanVariables.length >= 2) {
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        deMorganOK = !(valA || valB) === (!valA && !valB) &&
                    !(valA && valB) === (!valA || !valB);
    }
    checkLaw('De Morgan', deMorganOK);
    
    let absorptionOK = false;
    if (booleanVariables.length >= 2) {
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        absorptionOK = (valA || (valA && valB)) === valA &&
                      (valA && (valA || valB)) === valA;
    }
    checkLaw('Absorption', absorptionOK);
    
    let consensusOK = false;
    if (booleanVariables.length >= 3) {
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        const valC = booleanVariables[2];
        consensusOK = ((valA && valB) || (!valA && valC) || (valB && valC)) === 
                     ((valA && valB) || (!valA && valC));
    }
    checkLaw('Consensus', consensusOK);
    
    // Identity Laws (always true)
    checkLaw('Identity', true);
    
    // Null Laws (always true)
    checkLaw('Null', true);
    
    // Involution Law (always true)
    checkLaw('Involution', true);
    
    let redundancyOK = false;
    if (booleanVariables.length >= 2) {
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        redundancyOK = (valA || (!valA && valB)) === (valA || valB) &&
                      (valA && (!valA || valB)) === (valA && valB);
    }
    checkLaw('Redundancy', redundancyOK);
    
    // Display summary
    let allLawsPassed = true;
    lawsVerified.forEach(law => {
        if (law.verified) {
            explanation += `<div> ${law.name} Law: VERIFIED</div>`;
        } else {
            explanation += `<div> ${law.name} Law: NOT TESTED (requires more variables)</div>`;
            allLawsPassed = false;
        }
    });
    
    // Overall status
    const totalLaws = 11;
    const testedLaws = lawsVerified.filter(law => law.verified).length;
    explanation += `<div class="highlight-equation mt-2">Total Laws: ${totalLaws}, Tested & Verified: ${testedLaws}/${totalLaws}</div>`;
    
    explanation += '</div></div>';
    explanationDiv.innerHTML = explanation;
    
    // Update expression display
    const exprDiv = document.getElementById('boolean-expression');
    exprDiv.textContent = `Boolean Algebra Evaluation with ${varLabels} (All 11 Laws)`;
    
    addLog('Evaluated boolean algebra operations with all 11 laws', 'success');
}

function generateBooleanExpression() {
    const vars = booleanVariables.map((val, idx) => 
        `${String.fromCharCode(65 + idx)}=${val}`
    ).join(', ');
    return `Boolean Expression with ${vars}`;
}

function generateBooleanTruthTable() {
    const varCount = booleanVariables.length;
    const table = document.getElementById('boolean-truth-table');
    table.innerHTML = '';
    
    // Create header row
    const headerRow = document.createElement('tr');
    
    // Input headers
    for (let i = 0; i < varCount; i++) {
        const th = document.createElement('th');
        th.textContent = String.fromCharCode(65 + i);
        headerRow.appendChild(th);
    }
    
    // Operation headers
    const operations = ['Complement', 'Multiplication', 'Addition'];
    operations.forEach(op => {
        const th = document.createElement('th');
        th.textContent = op;
        headerRow.appendChild(th);
    });
    
    table.appendChild(headerRow);
    
    // Generate all combinations
    const totalCombinations = Math.pow(2, varCount);
    
    for (let i = 0; i < totalCombinations; i++) {
        const row = document.createElement('tr');
        const binary = i.toString(2).padStart(varCount, '0');
        const values = binary.split('').map(bit => bit === '1');
        
        // Input values
        values.forEach(val => {
            const td = document.createElement('td');
            td.textContent = val ? '1' : '0';
            td.className = val ? 'active' : 'inactive';
            row.appendChild(td);
        });
        
        // Complement column
        const compTd = document.createElement('td');
        const compValues = values.map(val => !val);
        compTd.innerHTML = compValues.map((val, idx) => 
            `${String.fromCharCode(65 + idx)}=${val ? '1' : '0'}`
        ).join('<br>');
        row.appendChild(compTd);
        
        // Multiplication column (AND)
        const multTd = document.createElement('td');
        if (varCount >= 2) {
            let multResults = [];
            for (let j = 0; j < varCount; j++) {
                for (let k = j + 1; k < varCount; k++) {
                    const result = values[j] && values[k];
                    multResults.push(`${String.fromCharCode(65 + j)}${String.fromCharCode(65 + k)}=${result ? '1' : '0'}`);
                }
            }
            multTd.innerHTML = multResults.join('<br>');
        } else {
            multTd.textContent = 'N/A';
        }
        row.appendChild(multTd);
        
        // Addition column (OR)
        const addTd = document.createElement('td');
        if (varCount >= 2) {
            let addResults = [];
            for (let j = 0; j < varCount; j++) {
                for (let k = j + 1; k < varCount; k++) {
                    const result = values[j] || values[k];
                    addResults.push(`${String.fromCharCode(65 + j)}+${String.fromCharCode(65 + k)}=${result ? '1' : '0'}`);
                }
            }
            addTd.innerHTML = addResults.join('<br>');
        } else {
            addTd.textContent = 'N/A';
        }
        row.appendChild(addTd);
        
        table.appendChild(row);
    }
    
    addLog('Generated boolean algebra truth table', 'success');
}

function verifyBooleanLaws() {
    const resultsDiv = document.getElementById('law-results-content');
    resultsDiv.innerHTML = '';
    
    const varCount = booleanVariables.length;
    let allLawsVerified = true;
    let lawResults = [];
    
    // 1. Idempotent Law Verification
    lawResults.push({ name: 'Idempotent Law', verified: true });
    resultsDiv.innerHTML += '<h6>1. Idempotent Law: A + A = A, A  A = A</h6>';
    resultsDiv.innerHTML += '<div class="calculation-step">';
    
    for (let i = 0; i < varCount; i++) {
        const varLabel = String.fromCharCode(65 + i);
        const value = booleanVariables[i];
        
        // A + A = A
        const orResult = value || value;
        const orVerified = orResult === value;
        
        // A  A = A
        const andResult = value && value;
        const andVerified = andResult === value;
        
        resultsDiv.innerHTML += `
            <div>For ${varLabel} = ${value}:</div>
            <div class="law-result ${orVerified && andVerified ? 'law-verified' : 'law-failed'}">
                ${varLabel} + ${varLabel} = ${value}  ${value} = ${orResult} ${orVerified ? '' : ''}<br>
                ${varLabel}  ${varLabel} = ${value}  ${value} = ${andResult} ${andVerified ? '' : ''}
            </div>
        `;
        
        if (!orVerified || !andVerified) {
            lawResults[0].verified = false;
            allLawsVerified = false;
        }
    }
    resultsDiv.innerHTML += '</div>';
    
    // 2. Commutative Law Verification
    if (varCount >= 2) {
        lawResults.push({ name: 'Commutative Law', verified: true });
        resultsDiv.innerHTML += '<h6 class="mt-3">2. Commutative Law: A + B = B + A, A  B = B  A</h6>';
        resultsDiv.innerHTML += '<div class="calculation-step">';
        
        for (let i = 0; i < varCount; i++) {
            for (let j = i + 1; j < varCount; j++) {
                const varA = String.fromCharCode(65 + i);
                const varB = String.fromCharCode(65 + j);
                const valA = booleanVariables[i];
                const valB = booleanVariables[j];
                
                // A + B = B + A
                const orAB = valA || valB;
                const orBA = valB || valA;
                const orVerified = orAB === orBA;
                
                // A  B = B  A
                const andAB = valA && valB;
                const andBA = valB && valA;
                const andVerified = andAB === andBA;
                
                resultsDiv.innerHTML += `
                    <div>For ${varA} = ${valA}, ${varB} = ${valB}:</div>
                    <div class="law-result ${orVerified && andVerified ? 'law-verified' : 'law-failed'}">
                        ${varA} + ${varB} = ${valA}  ${valB} = ${orAB}<br>
                        ${varB} + ${varA} = ${valB}  ${valA} = ${orBA} ${orVerified ? '' : ''}<br>
                        ${varA}  ${varB} = ${valA}  ${valB} = ${andAB}<br>
                        ${varB}  ${varA} = ${valB}  ${valA} = ${andBA} ${andVerified ? '' : ''}
                    </div>
                `;
                
                if (!orVerified || !andVerified) {
                    lawResults[1].verified = false;
                    allLawsVerified = false;
                }
            }
        }
        resultsDiv.innerHTML += '</div>';
    }
    
    // 3. Associative Law Verification (requires 3 variables)
    if (varCount >= 3) {
        lawResults.push({ name: 'Associative Law', verified: true });
        resultsDiv.innerHTML += '<h6 class="mt-3">3. Associative Law: (A + B) + C = A + (B + C), (A  B)  C = A  (B  C)</h6>';
        resultsDiv.innerHTML += '<div class="calculation-step">';
        
        // Using first 3 variables: A, B, C
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        const valC = booleanVariables[2];
        
        // (A + B) + C = A + (B + C)
        const leftOr = (valA || valB) || valC;
        const rightOr = valA || (valB || valC);
        const orVerified = leftOr === rightOr;
        
        // (A  B)  C = A  (B  C)
        const leftAnd = (valA && valB) && valC;
        const rightAnd = valA && (valB && valC);
        const andVerified = leftAnd === rightAnd;
        
        resultsDiv.innerHTML += `
            <div>For A = ${valA}, B = ${valB}, C = ${valC}:</div>
            <div class="law-result ${orVerified && andVerified ? 'law-verified' : 'law-failed'}">
                (A + B) + C = (${valA}  ${valB})  ${valC} = ${leftOr}<br>
                A + (B + C) = ${valA}  (${valB}  ${valC}) = ${rightOr} ${orVerified ? '' : ''}<br>
                (A  B)  C = (${valA}  ${valB})  ${valC} = ${leftAnd}<br>
                A  (B  C) = ${valA}  (${valB}  ${valC}) = ${rightAnd} ${andVerified ? '' : ''}
            </div>
        `;
        
        if (!orVerified || !andVerified) {
            lawResults[2].verified = false;
            allLawsVerified = false;
        }
        resultsDiv.innerHTML += '</div>';
    }
    
    // 4. Distributive Law Verification
    if (varCount >= 3) {
        lawResults.push({ name: 'Distributive Law', verified: true });
        resultsDiv.innerHTML += '<h6 class="mt-3">4. Distributive Law: A(B + C) = AB + AC, A + (BC) = (A+B)(A+C)</h6>';
        resultsDiv.innerHTML += '<div class="calculation-step">';
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        const valC = booleanVariables[2];
        
        // A(B + C) = AB + AC
        const leftDist1 = valA && (valB || valC);
        const rightDist1 = (valA && valB) || (valA && valC);
        const dist1Verified = leftDist1 === rightDist1;
        
        // A + (BC) = (A+B)(A+C)
        const leftDist2 = valA || (valB && valC);
        const rightDist2 = (valA || valB) && (valA || valC);
        const dist2Verified = leftDist2 === rightDist2;
        
        resultsDiv.innerHTML += `
            <div>For A = ${valA}, B = ${valB}, C = ${valC}:</div>
            <div class="law-result ${dist1Verified && dist2Verified ? 'law-verified' : 'law-failed'}">
                A(B + C) = ${valA}  (${valB}  ${valC}) = ${leftDist1}<br>
                AB + AC = (${valA}  ${valB})  (${valA}  ${valC}) = ${rightDist1} ${dist1Verified ? '' : ''}<br>
                A + (BC) = ${valA}  (${valB}  ${valC}) = ${leftDist2}<br>
                (A+B)(A+C) = (${valA}  ${valB})  (${valA}  ${valC}) = ${rightDist2} ${dist2Verified ? '' : ''}
            </div>
        `;
        
        if (!dist1Verified || !dist2Verified) {
            lawResults[3].verified = false;
            allLawsVerified = false;
        }
        resultsDiv.innerHTML += '</div>';
    }
    
    // 5. De Morgan's Theorem Verification
    if (varCount >= 2) {
        lawResults.push({ name: "De Morgan's Theorem", verified: true });
        resultsDiv.innerHTML += '<h6 class="mt-3">5. De Morgan\'s Theorem: (A+B) = AB, (AB) = A+B</h6>';
        resultsDiv.innerHTML += '<div class="calculation-step">';
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        
        // (A + B) = A  B
        const leftDemorgan1 = !(valA || valB);
        const rightDemorgan1 = (!valA) && (!valB);
        const demorgan1Verified = leftDemorgan1 === rightDemorgan1;
        
        // (A  B) = A + B
        const leftDemorgan2 = !(valA && valB);
        const rightDemorgan2 = (!valA) || (!valB);
        const demorgan2Verified = leftDemorgan2 === rightDemorgan2;
        
        resultsDiv.innerHTML += `
            <div>For A = ${valA}, B = ${valB}:</div>
            <div class="law-result ${demorgan1Verified && demorgan2Verified ? 'law-verified' : 'law-failed'}">
                (A + B) = (${valA}  ${valB}) = ${leftDemorgan1}<br>
                A  B = (${valA})  (${valB}) = ${rightDemorgan1} ${demorgan1Verified ? '' : ''}<br>
                (A  B) = (${valA}  ${valB}) = ${leftDemorgan2}<br>
                A + B = (${valA})  (${valB}) = ${rightDemorgan2} ${demorgan2Verified ? '' : ''}
            </div>
        `;
        
        if (!demorgan1Verified || !demorgan2Verified) {
            lawResults[lawResults.length - 1].verified = false;
            allLawsVerified = false;
        }
        resultsDiv.innerHTML += '</div>';
    }
    
    // 6. Absorption Law Verification
    if (varCount >= 2) {
        lawResults.push({ name: 'Absorption Law', verified: true });
        resultsDiv.innerHTML += '<h6 class="mt-3">6. Absorption Law: A + AB = A, A(A + B) = A</h6>';
        resultsDiv.innerHTML += '<div class="calculation-step">';
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        
        // A + AB = A
        const leftAbsorb1 = valA || (valA && valB);
        const rightAbsorb1 = valA;
        const absorb1Verified = leftAbsorb1 === rightAbsorb1;
        
        // A(A + B) = A
        const leftAbsorb2 = valA && (valA || valB);
        const rightAbsorb2 = valA;
        const absorb2Verified = leftAbsorb2 === rightAbsorb2;
        
        resultsDiv.innerHTML += `
            <div>For A = ${valA}, B = ${valB}:</div>
            <div class="law-result ${absorb1Verified && absorb2Verified ? 'law-verified' : 'law-failed'}">
                A + AB = ${valA}  (${valA}  ${valB}) = ${leftAbsorb1}<br>
                A = ${rightAbsorb1} ${absorb1Verified ? '' : ''}<br>
                A(A + B) = ${valA}  (${valA}  ${valB}) = ${leftAbsorb2}<br>
                A = ${rightAbsorb2} ${absorb2Verified ? '' : ''}
            </div>
        `;
        
        if (!absorb1Verified || !absorb2Verified) {
            lawResults[lawResults.length - 1].verified = false;
            allLawsVerified = false;
        }
        resultsDiv.innerHTML += '</div>';
    }
    
    // 7. Consensus Theorem Verification
    if (varCount >= 3) {
        lawResults.push({ name: 'Consensus Theorem', verified: true });
        resultsDiv.innerHTML += '<h6 class="mt-3">7. Consensus Theorem: AB + AC + BC = AB + AC</h6>';
        resultsDiv.innerHTML += '<div class="calculation-step">';
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        const valC = booleanVariables[2];
        
        // AB + AC + BC = AB + AC
        const leftConsensus = (valA && valB) || (!valA && valC) || (valB && valC);
        const rightConsensus = (valA && valB) || (!valA && valC);
        const consensusVerified = leftConsensus === rightConsensus;
        
        resultsDiv.innerHTML += `
            <div>For A = ${valA}, B = ${valB}, C = ${valC}:</div>
            <div class="law-result ${consensusVerified ? 'law-verified' : 'law-failed'}">
                AB + AC + BC = (${valA}  ${valB})  (${valA}  ${valC})  (${valB}  ${valC}) = ${leftConsensus}<br>
                AB + AC = (${valA}  ${valB})  (${valA}  ${valC}) = ${rightConsensus} ${consensusVerified ? '' : ''}
            </div>
        `;
        
        if (!consensusVerified) {
            lawResults[lawResults.length - 1].verified = false;
            allLawsVerified = false;
        }
        resultsDiv.innerHTML += '</div>';
    }
        // 8. Identity Laws: A + 0 = A, A  1 = A
    lawResults.push({ name: 'Identity Law', verified: true });
    resultsDiv.innerHTML += '<h6 class="mt-3">8. Identity Laws: A + 0 = A, A  1 = A</h6>';
    resultsDiv.innerHTML += '<div class="calculation-step">';
    
    for (let i = 0; i < varCount; i++) {
        const varLabel = String.fromCharCode(65 + i);
        const value = booleanVariables[i];
        
        // A + 0 = A
        const orIdentity = value || false;
        const orVerified = orIdentity === value;
        
        // A  1 = A
        const andIdentity = value && true;
        const andVerified = andIdentity === value;
        
        resultsDiv.innerHTML += `
            <div>For ${varLabel} = ${value}:</div>
            <div class="law-result ${orVerified && andVerified ? 'law-verified' : 'law-failed'}">
                ${varLabel} + 0 = ${value}  false = ${orIdentity} ${orVerified ? '' : ''}<br>
                ${varLabel}  1 = ${value}  true = ${andIdentity} ${andVerified ? '' : ''}
            </div>
        `;
        
        if (!orVerified || !andVerified) {
            lawResults[7].verified = false;
            allLawsVerified = false;
        }
    }
    resultsDiv.innerHTML += '</div>';
    
    // 9. Null Laws: A + 1 = 1, A  0 = 0
    lawResults.push({ name: 'Null Law', verified: true });
    resultsDiv.innerHTML += '<h6 class="mt-3">9. Null Laws: A + 1 = 1, A  0 = 0</h6>';
    resultsDiv.innerHTML += '<div class="calculation-step">';
    
    for (let i = 0; i < varCount; i++) {
        const varLabel = String.fromCharCode(65 + i);
        const value = booleanVariables[i];
        
        // A + 1 = 1
        const orNull = value || true;
        const orVerified = orNull === true;
        
        // A  0 = 0
        const andNull = value && false;
        const andVerified = andNull === false;
        
        resultsDiv.innerHTML += `
            <div>For ${varLabel} = ${value}:</div>
            <div class="law-result ${orVerified && andVerified ? 'law-verified' : 'law-failed'}">
                ${varLabel} + 1 = ${value}  true = ${orNull} ${orVerified ? '' : ''}<br>
                ${varLabel}  0 = ${value}  false = ${andNull} ${andVerified ? '' : ''}
            </div>
        `;
        
        if (!orVerified || !andVerified) {
            lawResults[8].verified = false;
            allLawsVerified = false;
        }
    }
    resultsDiv.innerHTML += '</div>';
    
    // 10. Involution Law: (A) = A
    lawResults.push({ name: 'Involution Law', verified: true });
    resultsDiv.innerHTML += '<h6 class="mt-3">10. Involution Law: (A) = A</h6>';
    resultsDiv.innerHTML += '<div class="calculation-step">';
    
    for (let i = 0; i < varCount; i++) {
        const varLabel = String.fromCharCode(65 + i);
        const value = booleanVariables[i];
        
        // (A) = A
        const involution = !(!value);
        const verified = involution === value;
        
        resultsDiv.innerHTML += `
            <div>For ${varLabel} = ${value}:</div>
            <div class="law-result ${verified ? 'law-verified' : 'law-failed'}">
                (${varLabel}) = (${value}) = ${involution} ${verified ? '' : ''}
            </div>
        `;
        
        if (!verified) {
            lawResults[9].verified = false;
            allLawsVerified = false;
        }
    }
    resultsDiv.innerHTML += '</div>';
    
    // 11. Redundancy Elimination Laws: A + AB = A + B, A(A+B) = AB
    if (varCount >= 2) {
        lawResults.push({ name: 'Redundancy Law', verified: true });
        resultsDiv.innerHTML += '<h6 class="mt-3">11. Redundancy Elimination Laws: A + AB = A + B, A(A+B) = AB</h6>';
        resultsDiv.innerHTML += '<div class="calculation-step">';
        
        const valA = booleanVariables[0];
        const valB = booleanVariables[1];
        
        // A + AB = A + B
        const leftRedundancy1 = valA || (!valA && valB);
        const rightRedundancy1 = valA || valB;
        const redundancy1Verified = leftRedundancy1 === rightRedundancy1;
        
        // A(A+B) = AB
        const leftRedundancy2 = valA && (!valA || valB);
        const rightRedundancy2 = valA && valB;
        const redundancy2Verified = leftRedundancy2 === rightRedundancy2;
        
        resultsDiv.innerHTML += `
            <div>For A = ${valA}, B = ${valB}:</div>
            <div class="law-result ${redundancy1Verified && redundancy2Verified ? 'law-verified' : 'law-failed'}">
                A + AB = ${valA}  (${valA}  ${valB}) = ${leftRedundancy1}<br>
                A + B = ${valA}  ${valB} = ${rightRedundancy1} ${redundancy1Verified ? '' : ''}<br>
                A(A+B) = ${valA}  (${valA}  ${valB}) = ${leftRedundancy2}<br>
                AB = ${valA}  ${valB} = ${rightRedundancy2} ${redundancy2Verified ? '' : ''}
            </div>
        `;
        
        if (!redundancy1Verified || !redundancy2Verified) {
            lawResults[10].verified = false;
            allLawsVerified = false;
        }
        resultsDiv.innerHTML += '</div>';
    }

    // Show overall summary
    resultsDiv.innerHTML += `
        <div class="calculation-step mt-3 ${allLawsVerified ? 'active' : ''}">
            <div class="calculation-title">Overall Verification Summary</div>
            <div class="calculation-content">
                <div><strong>Laws Tested:</strong> ${lawResults.length} out of 7</div>
                <div><strong>Laws Verified:</strong> ${lawResults.filter(law => law.verified).length}</div>
                <div><strong>Overall Result:</strong> ${allLawsVerified ? ' ALL LAWS VERIFIED' : ' SOME LAWS FAILED'}</div>
                <hr>
                <div><strong>Tested Laws:</strong></div>
    `;
    
    lawResults.forEach((law, index) => {
        resultsDiv.innerHTML += `
            <div>${index + 1}. ${law.name}: ${law.verified ? ' Verified' : ' Failed'}</div>
        `;
    });
    
    // Add note about untested laws
    const untestedLaws = 7 - lawResults.length;
    if (untestedLaws > 0) {
        resultsDiv.innerHTML += `
            <div class="mt-2 text-warning">
                <i class="fas fa-info-circle"></i> Note: ${untestedLaws} law(s) not tested (require more variables)
            </div>
        `;
    }
    
    resultsDiv.innerHTML += '</div></div>';
    
    // Show the results section
    document.getElementById('law-verification-results').style.display = 'block';
    
    addLog(`Verified ${lawResults.filter(law => law.verified).length} out of ${lawResults.length} boolean algebra laws`, 
           allLawsVerified ? 'success' : 'error');
}
// Initialize combinational logic interface
function initializeCombinationalLogic() {
    updateMinimizationInterface();
    updateKmapInterface();
      // Hide conversion interface initially
    document.getElementById('code-conversion-inputs').style.display = 'none';
}

function updateMinimizationInterface() {
    const method = document.getElementById('minimization-method').value;
    const variableInputs = document.getElementById('variable-inputs');
    const mintermInputs = document.getElementById('minterm-inputs');
    
    if (method === 'algebra') {
        variableInputs.style.display = 'block';
        mintermInputs.style.display = 'none';
    } else {
        variableInputs.style.display = 'none';
        mintermInputs.style.display = 'block';
    }
}

function updateKmapInterface() {
    // Update example based on selected variables
    const examples = {
        2: { minterms: "0,1,2,3", result: "1" },
        3: { minterms: "0,2,4,6", result: "C'" },
        4: { minterms: "0,1,2,3,4,5,6,7,8,9,10,11", result: "A' + B' + C'" }
    };
    
    if (examples[logicVariables]) {
        document.getElementById('minterms-input').value = examples[logicVariables].minterms;
    }
}

// Logic Minimization Functions
function minimizeLogic() {
    const method = document.getElementById('minimization-method').value;
    const resultDiv = document.getElementById('minimization-result');
    const explanationDiv = document.getElementById('solution-steps');
    const kmapDiv = document.getElementById('kmap-visualization');
    const groupingDiv = document.getElementById('grouping-visualization');
    
    // Clear previous results
    explanationDiv.innerHTML = '';
    kmapDiv.style.display = 'none';
    groupingDiv.style.display = 'none';
    
    try {
        if (method === 'kmap') {
            minimizeUsingKmap();
        } else {
            minimizeUsingAlgebra();
        }
        addLog('Logic minimization completed', 'success');
    } catch (error) {
        resultDiv.textContent = `Error: ${error.message}`;
        resultDiv.style.color = 'var(--danger-color)';
        addLog(`Minimization error: ${error.message}`, 'error');
    }
}

function minimizeUsingKmap() {
    const mintermsInput = document.getElementById('minterms-input').value;
    const dontcareInput = document.getElementById('dontcare-input').value;
    const resultDiv = document.getElementById('minimization-result');
    const explanationDiv = document.getElementById('solution-steps');
    
    if (!mintermsInput.trim()) {
        throw new Error('Please enter minterms');
    }
    
    // Parse minterms
    const minterms = mintermsInput.split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m));
    const dontcares = dontcareInput ? dontcareInput.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d)) : [];
    
    if (minterms.length === 0) {
        throw new Error('No valid minterms entered');
    }
    
    // Generate variable labels
    const variables = [];
    for (let i = 0; i < logicVariables; i++) {
        variables.push(String.fromCharCode(65 + i));
    }
    
    // Create K-map
    const kmap = new KMapMinimizer(variables);
    kmap.setMinterms(minterms, dontcares);
    
    // Get simplified expression
    const simplified = kmap.getSimplifiedExpression();
    
    // Display results
    resultDiv.textContent = `Simplified Expression: F = ${simplified}`;
    resultDiv.style.color = '';
    
    // Generate explanation
    explanationDiv.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">K-map Minimization Steps</div>
            <div class="calculation-content">
                <div><strong>Step 1: Input Analysis</strong></div>
                <div>Variables: ${variables.join(', ')}</div>
                <div>Minterms: ${minterms.join(', ')}</div>
                ${dontcares.length > 0 ? `<div>Don't Cares: ${dontcares.join(', ')}</div>` : ''}
                <div>Total minterms: ${minterms.length}</div>
                
                <div class="mt-2"><strong>Step 2: K-map Generation</strong></div>
                <div>Created ${logicVariables}-variable K-map with Gray code ordering</div>
                
                <div class="mt-2"><strong>Step 3: Prime Implicant Identification</strong></div>
                <div>Found prime implicants using Quine-McCluskey algorithm</div>
                
                <div class="mt-2"><strong>Step 4: Essential Prime Implicants</strong></div>
                <div>Selected essential prime implicants covering all minterms</div>
                
                <div class="mt-2"><strong>Step 5: Simplified Expression</strong></div>
                <div class="highlight-equation">F = ${simplified}</div>
                
                <div class="mt-2"><strong>Step 6: Verification</strong></div>
                <div>The expression covers all minterms with minimal terms</div>
            </div>
        </div>
    `;
    
    // Show K-map visualization
    document.getElementById('kmap-visualization').style.display = 'block';
    generateKmapGrid(kmap);
    
    // Show grouping visualization
    document.getElementById('grouping-visualization').style.display = 'block';
    generateGroupingVisualization(kmap);
}

function minimizeUsingAlgebra() {
    const expressionInput = document.getElementById('boolean-expression-input').value;
    const resultDiv = document.getElementById('minimization-result');
    const explanationDiv = document.getElementById('solution-steps');
    
    if (!expressionInput.trim()) {
        throw new Error('Please enter a Boolean expression');
    }
    
    // Simplify using Boolean algebra
    const simplifier = new BooleanAlgebraSimplifier();
    const simplified = simplifier.simplify(expressionInput);
    
    // Display results
    resultDiv.textContent = `Simplified Expression: F = ${simplified}`;
    resultDiv.style.color = '';
    
    // Generate explanation
    explanationDiv.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">Boolean Algebra Simplification Steps</div>
            <div class="calculation-content">
                <div><strong>Step 1: Original Expression</strong></div>
                <div>F = ${expressionInput}</div>
                
                <div class="mt-2"><strong>Step 2: Remove Spaces and Standardize</strong></div>
                <div>Standardized format: ${expressionInput.replace(/\s+/g, '').toUpperCase()}</div>
                
                <div class="mt-2"><strong>Step 3: Apply Idempotent Law</strong></div>
                <div>Removed redundant terms: A + A = A, A  A = A</div>
                
                <div class="mt-2"><strong>Step 4: Apply Complement Law</strong></div>
                <div>Removed terms with A  A' = 0</div>
                
                <div class="mt-2"><strong>Step 5: Apply Absorption Law</strong></div>
                <div>Simplified using: A + AB = A</div>
                
                <div class="mt-2"><strong>Step 6: Final Simplified Expression</strong></div>
                <div class="highlight-equation">F = ${simplified}</div>
                
                <div class="mt-2"><strong>Step 7: Verification</strong></div>
                <div>Both expressions are logically equivalent</div>
            </div>
        </div>
    `;
}

function generateKmapGrid(kmap) {
    const container = document.getElementById('kmap-container');
    const kmapData = kmap.generateKmap();
    
    let html = '<div class="kmap-table">';
    
    // Create table
    html += '<table class="table table-bordered text-center" style="background: white;">';
    
    // Header row
    html += '<thead><tr><th></th>';
    for (let j = 0; j < kmapData.cols; j++) {
        html += `<th>${kmapData.colCodes[j]}</th>`;
    }
    html += '</tr></thead>';
    
    // Data rows
    html += '<tbody>';
    for (let i = 0; i < kmapData.rows; i++) {
        html += `<tr><th>${kmapData.rowCodes[i]}</th>`;
        for (let j = 0; j < kmapData.cols; j++) {
            const cell = kmapData.grid[i][j];
            let cellClass = '';
            if (cell === '1') cellClass = 'table-success';
            else if (cell === 'X') cellClass = 'table-warning';
            html += `<td class="${cellClass} fw-bold">${cell}</td>`;
        }
        html += '</tr>';
    }
    html += '</tbody></table>';
    
    html += '</div>';
    container.innerHTML = html;
}

function generateGroupingVisualization(kmap) {
    const container = document.getElementById('grouping-container');
    const primeImplicants = kmap.findPrimeImplicants();
    
    let html = '<div class="grouping-analysis">';
    html += '<div class="calculation-step">';
    html += '<div class="calculation-title">Prime Implicant Analysis</div>';
    html += '<div class="calculation-content">';
    
    if (primeImplicants.length === 0) {
        html += '<div>No prime implicants found</div>';
    } else {
        html += '<div><strong>Prime Implicants Found:</strong></div>';
        primeImplicants.forEach((imp, idx) => {
            html += `<div>${idx + 1}. ${imp.binary}  Covers minterms: ${imp.minterms.join(', ')}</div>`;
        });
        
        html += '<div class="mt-2"><strong>Essential Prime Implicants:</strong></div>';
        const essential = kmap.findEssentialImplicants(primeImplicants);
        essential.forEach((imp, idx) => {
            html += `<div>${idx + 1}. ${imp.binary}  ${imp.expression}</div>`;
        });
    }
    
    html += '</div></div></div>';
    container.innerHTML = html;
}
function generateSOPForm() {
    try {
        const mintermsInput = document.getElementById('minterms-input').value;
        const dontcareInput = document.getElementById('dontcare-input').value;
        
        if (!mintermsInput.trim()) {
            throw new Error('Please enter minterms');
        }
        
        // Parse minterms
        const minterms = mintermsInput.split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m));
        const dontcares = dontcareInput ? dontcareInput.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d)) : [];
        
        if (minterms.length === 0) {
            throw new Error('No valid minterms entered');
        }
        
        // Get variables
        const varCount = logicVariables;
        const variables = [];
        for (let i = 0; i < varCount; i++) {
            variables.push(String.fromCharCode(65 + i));
        }
        
        // Create Boolean function
        const bf = new BooleanFunction(variables);
        
        // For SOP, we need to exclude don't cares from minterms
        const validMinterms = minterms.filter(m => !dontcares.includes(m));
        bf.setFromMinterms(validMinterms);
        
        // Display results
        displaySOPResults(bf);
        
        addLog(`Generated SOP form for ${validMinterms.length} minterms`, 'success');
        
    } catch (error) {
        showError(error.message);
        addLog(`SOP generation error: ${error.message}`, 'error');
    }
}

function generatePOSForm() {
    try {
        const mintermsInput = document.getElementById('minterms-input').value;
        const dontcareInput = document.getElementById('dontcare-input').value;
        
        if (!mintermsInput.trim()) {
            throw new Error('Please enter minterms');
        }
        
        // Parse minterms
        const minterms = mintermsInput.split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m));
        const dontcares = dontcareInput ? dontcareInput.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d)) : [];
        
        if (minterms.length === 0) {
            throw new Error('No valid minterms entered');
        }
        
        // Get variables
        const varCount = logicVariables;
        const variables = [];
        for (let i = 0; i < varCount; i++) {
            variables.push(String.fromCharCode(65 + i));
        }
        
        // Create Boolean function
        const bf = new BooleanFunction(variables);
        
        // For POS, we need maxterms (all terms that aren't minterms, excluding don't cares)
        const allTerms = new Set([...Array(2 ** varCount).keys()]);
        const mintermSet = new Set(minterms);
        const dontcareSet = new Set(dontcares);
        
        const maxterms = [...allTerms].filter(term => 
            !mintermSet.has(term) && !dontcareSet.has(term)
        );
        
        bf.setFromMaxterms(maxterms);
        
        // Display results
        displayPOSResults(bf);
        
        addLog(`Generated POS form with ${maxterms.length} maxterms`, 'success');
        
    } catch (error) {
        showError(error.message);
        addLog(`POS generation error: ${error.message}`, 'error');
    }
}

function compareCanonicalForms() {
    try {
        const mintermsInput = document.getElementById('minterms-input').value;
        const dontcareInput = document.getElementById('dontcare-input').value;
        
        if (!mintermsInput.trim()) {
            throw new Error('Please enter minterms');
        }
        
        // Parse minterms
        const minterms = mintermsInput.split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m));
        const dontcares = dontcareInput ? dontcareInput.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d)) : [];
        
        if (minterms.length === 0) {
            throw new Error('No valid minterms entered');
        }
        
        // Get variables
        const varCount = logicVariables;
        const variables = [];
        for (let i = 0; i < varCount; i++) {
            variables.push(String.fromCharCode(65 + i));
        }
        
        // Create Boolean function for SOP (excluding don't cares)
        const bfSOP = new BooleanFunction(variables);
        const validMinterms = minterms.filter(m => !dontcares.includes(m));
        bfSOP.setFromMinterms(validMinterms);
        
        // Create Boolean function for POS
        const bfPOS = new BooleanFunction(variables);
        const allTerms = new Set([...Array(2 ** varCount).keys()]);
        const mintermSet = new Set(minterms);
        const dontcareSet = new Set(dontcares);
        
        const maxterms = [...allTerms].filter(term => 
            !mintermSet.has(term) && !dontcareSet.has(term)
        );
        bfPOS.setFromMaxterms(maxterms);
        
        // Display comparison
        displayComparison(bfSOP, bfPOS, variables, minterms, dontcares);
        
        addLog('Compared SOP and POS canonical forms', 'success');
        
    } catch (error) {
        showError(error.message);
        addLog(`Comparison error: ${error.message}`, 'error');
    }
}

function displaySOPResults(bf) {
    const container = document.getElementById('sop-pos-container');
    const resultsDiv = document.getElementById('canonical-forms-results');
    
    const sopExpression = bf.getSOPExpression();
    const truthTableHTML = bf.generateTruthTableHTML();
    
    container.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">Sum of Products (SOP) Form</div>
            <div class="calculation-content">
                <div><strong>Minterms:</strong> ${bf.minterms.join(', ')}</div>
                <div><strong>Number of Minterms:</strong> ${bf.minterms.length}</div>
                <div><strong>SOP Expression:</strong></div>
                <div class="highlight-equation mt-2 mb-3">F(${bf.variables.join(', ')}) = ${sopExpression}</div>
                
                <div class="mt-3"><strong>Truth Table:</strong></div>
                ${truthTableHTML}
                
                <div class="mt-3"><strong>SOP Characteristics:</strong></div>
                <ul>
                    <li>Each product term (AND) represents a minterm</li>
                    <li>Output is 1 when ANY product term is 1</li>
                    <li>Number of product terms = number of minterms</li>
                    <li>Each product term contains all variables (canonical form)</li>
                </ul>
            </div>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
}

function displayPOSResults(bf) {
    const container = document.getElementById('sop-pos-container');
    const resultsDiv = document.getElementById('canonical-forms-results');
    
    const posExpression = bf.getPOSExpression();
    const truthTableHTML = bf.generateTruthTableHTML();
    
    container.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">Product of Sums (POS) Form</div>
            <div class="calculation-content">
                <div><strong>Maxterms:</strong> ${bf.maxterms.join(', ')}</div>
                <div><strong>Number of Maxterms:</strong> ${bf.maxterms.length}</div>
                <div><strong>POS Expression:</strong></div>
                <div class="highlight-equation mt-2 mb-3">F(${bf.variables.join(', ')}) = ${posExpression}</div>
                
                <div class="mt-3"><strong>Truth Table:</strong></div>
                ${truthTableHTML}
                
                <div class="mt-3"><strong>POS Characteristics:</strong></div>
                <ul>
                    <li>Each sum term (OR) represents a maxterm</li>
                    <li>Output is 0 when ANY sum term is 0</li>
                    <li>Number of sum terms = number of maxterms</li>
                    <li>Each sum term contains all variables (canonical form)</li>
                </ul>
            </div>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
}

function displayComparison(bfSOP, bfPOS, variables, minterms, dontcares) {
    const container = document.getElementById('sop-pos-container');
    const resultsDiv = document.getElementById('canonical-forms-results');
    
    const sopExpression = bfSOP.getSOPExpression();
    const posExpression = bfPOS.getPOSExpression();
    const truthTableHTML = bfSOP.generateTruthTableHTML();
    
    // Check if expressions are equivalent
    const sopTerms = sopExpression.split(' + ');
    const posTerms = posExpression.split('  ');
    
    container.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">SOP vs POS Comparison</div>
            <div class="calculation-content">
                <div><strong>Input Analysis:</strong></div>
                <div>Variables: ${variables.join(', ')} (${variables.length} variables)</div>
                <div>Minterms: ${minterms.join(', ')}</div>
                ${dontcares.length > 0 ? `<div>Don't Care Terms: ${dontcares.join(', ')}</div>` : ''}
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="gate-description">
                            <h6>Sum of Products (SOP)</h6>
                            <div><strong>Expression:</strong></div>
                            <div class="highlight-equation">F = ${sopExpression}</div>
                            <div class="mt-2"><strong>Minterms:</strong> ${bfSOP.minterms.join(', ')}</div>
                            <div><strong>Product Terms:</strong> ${sopTerms.length}</div>
                            <div><strong>Literals:</strong> ${sopExpression.replace(/[^A-Z]/g, '').length}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="gate-description">
                            <h6>Product of Sums (POS)</h6>
                            <div><strong>Expression:</strong></div>
                            <div class="highlight-equation">F = ${posExpression}</div>
                            <div class="mt-2"><strong>Maxterms:</strong> ${bfPOS.maxterms.join(', ')}</div>
                            <div><strong>Sum Terms:</strong> ${posTerms.length}</div>
                            <div><strong>Literals:</strong> ${posExpression.replace(/[^A-Z]/g, '').length}</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3"><strong>Truth Table:</strong></div>
                ${truthTableHTML}
                
                <div class="mt-3"><strong>Comparison Analysis:</strong></div>
                <ul>
                    <li>SOP has ${sopTerms.length} product terms, POS has ${posTerms.length} sum terms</li>
                    <li>SOP uses ${sopExpression.replace(/[^A-Z]/g, '').length} literals, POS uses ${posExpression.replace(/[^A-Z]/g, '').length} literals</li>
                    <li>Both forms represent the same Boolean function</li>
                    <li>SOP is often preferred for AND-OR implementations</li>
                    <li>POS is often preferred for OR-AND implementations</li>
                </ul>
                
                <div class="mt-3"><strong>When to use each form:</strong></div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="gate-description">
                            <h6>Use SOP when:</h6>
                            <ul>
                                <li>Function has few minterms</li>
                                <li>Implementing with AND gates followed by OR gate</li>
                                <li>Using NAND-NAND logic</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="gate-description">
                            <h6>Use POS when:</h6>
                            <ul>
                                <li>Function has few maxterms</li>
                                <li>Implementing with OR gates followed by AND gate</li>
                                <li>Using NOR-NOR logic</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
}

function showError(message) {
    const container = document.getElementById('sop-pos-container');
    const resultsDiv = document.getElementById('canonical-forms-results');
    
    container.innerHTML = `
        <div class="calculation-step" style="border-left-color: var(--danger-color);">
            <div class="calculation-title">Error</div>
            <div class="calculation-content text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </div>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
}

function clearMinimization() {
    document.getElementById('minterms-input').value = '';
    document.getElementById('dontcare-input').value = '';
    document.getElementById('boolean-expression-input').value = '';
    document.getElementById('minimization-result').textContent = 'Enter minterms or expression and click Minimize';
    document.getElementById('solution-steps').innerHTML = '';
    document.getElementById('kmap-visualization').style.display = 'none';
    document.getElementById('grouping-visualization').style.display = 'none';
    document.getElementById('kmap-container').innerHTML = '';
    document.getElementById('grouping-container').innerHTML = '';
    
    addLog('Cleared minimization inputs and results', 'info');
}

function generateKmapVisualization() {
    minimizeLogic();
}
// Main conversion functions
function convertSOPtoPOS() {
    try {
        const expressionInput = document.getElementById('boolean-expression-input').value.trim();
        if (!expressionInput) {
            throw new Error('Please enter a Boolean expression');
        }
        
        // Validate it's likely SOP
        if (!isValidSOP(expressionInput)) {
            throw new Error('Please enter a valid SOP expression (e.g., AB\' + A\'C + BC)');
        }
        
        // Parse and convert
        const result = convertSOPtoPOSLogic(expressionInput, logicVariables);
        
        // Display results
        showConversionResult('SOP to POS', expressionInput, result.sopExpression, result.posExpression, 
                           result.minterms, result.truthTable, logicVariables);
        
        addLog(`Converted SOP to POS: ${expressionInput}  ${result.posExpression}`, 'success');
        
    } catch (error) {
        showError(error.message, 'sop');
        addLog(`SOP to POS conversion error: ${error.message}`, 'error');
    }
}

function convertPOStoSOP() {
    try {
        const expressionInput = document.getElementById('boolean-expression-input').value.trim();
        if (!expressionInput) {
            throw new Error('Please enter a Boolean expression');
        }
        
        // Validate it's likely POS
        if (!isValidPOS(expressionInput)) {
            throw new Error('Please enter a valid POS expression (e.g., (A+B\')(A\'+C) or (A+B)*(B+C))');
        }
        
        // Parse and convert
        const result = convertPOStoSOPLogic(expressionInput, logicVariables);
        
        // Display results
        showConversionResult('POS to SOP', expressionInput, result.sopExpression, result.posExpression,
                           result.minterms, result.truthTable, logicVariables);
        
        addLog(`Converted POS to SOP: ${expressionInput}  ${result.sopExpression}`, 'success');
        
    } catch (error) {
        showError(error.message, 'pos');
        addLog(`POS to SOP conversion error: ${error.message}`, 'error');
    }
}

// Validation functions
function isValidSOP(expression) {
    expression = expression.toUpperCase().trim();
    
    // Check for invalid POS patterns
    if (expression.includes('(') && expression.includes(')')) {
        // Check if it looks like POS (has product symbols between parentheses)
        const posPattern = /\([^)]+\)[*.]\([^)]+\)/;
        if (posPattern.test(expression)) {
            return false; // Looks like POS
        }
    }
    
    // Valid SOP patterns
    const sopPattern = /^[A-Z'+\s*.*]+$/;
    return sopPattern.test(expression);
}

function isValidPOS(expression) {
    expression = expression.toUpperCase().trim();
    
    // Check for parentheses and product symbols
    const hasParentheses = expression.includes('(') && expression.includes(')');
    
    // Check for product symbols (., *, ) between parentheses
    const hasProductSymbols = /\)[*.]\(/.test(expression) || 
                             /\)\s*[*.]\s*\(/.test(expression);
    
    // Also accept simple POS like (A+B)(B+C)
    const simplePOSPattern = /\([^)]+\)\s*\([^)]+\)/;
    
    return hasParentheses && (hasProductSymbols || simplePOSPattern.test(expression));
}

// Core conversion logic
function convertSOPtoPOSLogic(sopExpression, numVars) {
    // Get variables
    const variables = getVariables(numVars);
    
    // Parse SOP to minterms
    const minterms = parseSOPToMinterms(sopExpression, numVars);
    
    // Generate POS from minterms
    const posExpression = mintermsToPOS(minterms, numVars);
    
    // Generate canonical SOP for comparison
    const canonicalSOP = mintermsToSOP(minterms, numVars);
    
    // Generate truth table
    const truthTable = generateTruthTable(minterms, numVars);
    
    return {
        sopExpression: canonicalSOP,
        posExpression: posExpression,
        minterms: minterms,
        truthTable: truthTable
    };
}

function convertPOStoSOPLogic(posExpression, numVars) {
    // Get variables
    const variables = getVariables(numVars);
    
    // Normalize POS expression first
    const normalizedPos = normalizePOSExpression(posExpression);
    
    // Parse POS to minterms
    const minterms = parsePOSToMinterms(normalizedPos, numVars);
    
    // Generate SOP from minterms
    const sopExpression = mintermsToSOP(minterms, numVars);
    
    // Generate canonical POS for comparison
    const canonicalPOS = mintermsToPOS(minterms, numVars);
    
    // Generate truth table
    const truthTable = generateTruthTable(minterms, numVars);
    
    return {
        sopExpression: sopExpression,
        posExpression: canonicalPOS,
        minterms: minterms,
        truthTable: truthTable
    };
}

// Helper functions
function getVariables(numVars) {
    return Array.from({length: numVars}, (_, i) => String.fromCharCode(65 + i));
}

function normalizePOSExpression(posExpression) {
    // Convert to uppercase
    let expr = posExpression.toUpperCase().trim();
    
    // Replace . with  for consistency
    expr = expr.replace(/\./g, '');
    
    // Replace * with  for consistency
    expr = expr.replace(/\*/g, '');
    
    // Add  between parentheses if missing: (A+B)(B+C)  (A+B)(B+C)
    expr = expr.replace(/\)\s*\(/g, ')(');
    
    return expr;
}

function parseSOPToMinterms(sopExpression, numVars) {
    const variables = getVariables(numVars);
    const varToIndex = {};
    variables.forEach((v, i) => varToIndex[v] = i);
    
    // Clean expression
    let expr = sopExpression.toUpperCase().trim();
    
    // Handle constants
    if (expr === '0') return [];
    if (expr === '1') return Array.from({length: Math.pow(2, numVars)}, (_, i) => i);
    
    // Split into product terms
    const terms = expr.split(/[+*]/).map(t => t.trim()).filter(t => t);
    
    const minterms = new Set();
    
    terms.forEach(term => {
        // Initialize assignment (undefined = don't care)
        const assignment = new Array(numVars).fill(undefined);
        
        // Parse literals
        let i = 0;
        while (i < term.length) {
            const char = term[i];
            if (varToIndex[char] !== undefined) {
                let value = 1; // uncomplemented
                
                // Check for complement
                if (i + 1 < term.length && (term[i + 1] === "'" || term[i + 1] === "")) {
                    value = 0;
                    i++;
                }
                
                assignment[varToIndex[char]] = value;
            }
            i++;
        }
        
        // Generate all minterms for this product term
        generateMintermsFromAssignment(assignment, minterms);
    });
    
    return Array.from(minterms).sort((a, b) => a - b);
}

function parsePOSToMinterms(posExpression, numVars) {
    const variables = getVariables(numVars);
    const varToIndex = {};
    variables.forEach((v, i) => varToIndex[v] = i);
    
    // Normalize expression first
    let expr = normalizePOSExpression(posExpression);
    
    // Handle constants
    if (expr === '0') return [];
    if (expr === '1') return Array.from({length: Math.pow(2, numVars)}, (_, i) => i);
    
    // Extract sum terms (between parentheses)
    const sumTerms = [];
    let inParenthesis = false;
    let currentTerm = '';
    
    for (let i = 0; i < expr.length; i++) {
        if (expr[i] === '(') {
            inParenthesis = true;
            currentTerm = '';
        } else if (expr[i] === ')' && inParenthesis) {
            inParenthesis = false;
            if (currentTerm.trim()) {
                sumTerms.push(currentTerm.trim());
            }
        } else if (inParenthesis) {
            currentTerm += expr[i];
        }
    }
    
    if (sumTerms.length === 0) {
        throw new Error('Invalid POS expression: No sum terms found');
    }
    
    const allMinterms = new Set(Array.from({length: Math.pow(2, numVars)}, (_, i) => i));
    const maxterms = new Set();
    
    // For each combination of inputs
    for (let i = 0; i < Math.pow(2, numVars); i++) {
        const inputValues = [];
        for (let j = 0; j < numVars; j++) {
            inputValues.push((i >> (numVars - 1 - j)) & 1);
        }
        
        // Check if this input makes any sum term false
        let isMaxterm = false;
        for (const sumTerm of sumTerms) {
            // Split by + or OR symbol
            const literals = sumTerm.split(/[+]/).map(l => l.trim()).filter(l => l);
            let sumIsFalse = true;
            
            for (const literal of literals) {
                // Handle complemented variables
                let varName = literal[0];
                let value = 1; // uncomplemented
                
                // Check for complement
                if (literal.length > 1) {
                    if (literal[1] === "'" || literal[1] === "") {
                        value = 0;
                    }
                }
                
                const idx = varToIndex[varName];
                if (idx === undefined) {
                    throw new Error(`Invalid variable '${varName}' in POS expression`);
                }
                
                const actualValue = inputValues[idx];
                
                // In POS, sum term is 0 only if ALL literals are 0
                // So we check if any literal is 1
                const literalValue = (value === 1) ? actualValue : (1 - actualValue);
                if (literalValue === 1) {
                    sumIsFalse = false;
                    break;
                }
            }
            
            if (sumIsFalse) {
                isMaxterm = true;
                break;
            }
        }
        
        if (isMaxterm) {
            maxterms.add(i);
        }
    }
    
    // Minterms are those that are NOT maxterms
    const minterms = [];
    for (let i = 0; i < Math.pow(2, numVars); i++) {
        if (!maxterms.has(i)) {
            minterms.push(i);
        }
    }
    
    return minterms.sort((a, b) => a - b);
}

function generateMintermsFromAssignment(assignment, mintermsSet) {
    const numVars = assignment.length;
    const positions = [];
    const values = [];
    
    for (let i = 0; i < numVars; i++) {
        if (assignment[i] !== undefined) {
            positions.push(i);
            values.push(assignment[i]);
        }
    }
    
    const numFree = numVars - positions.length;
    const numCombinations = Math.pow(2, numFree);
    
    for (let i = 0; i < numCombinations; i++) {
        const inputValues = [...assignment];
        
        // Fill in free variables
        let freeIndex = 0;
        for (let j = 0; j < numVars; j++) {
            if (inputValues[j] === undefined) {
                inputValues[j] = (i >> (numFree - 1 - freeIndex)) & 1;
                freeIndex++;
            }
        }
        
        // Convert to minterm number
        let minterm = 0;
        for (let j = 0; j < numVars; j++) {
            minterm = (minterm << 1) | inputValues[j];
        }
        
        mintermsSet.add(minterm);
    }
}

function mintermsToSOP(minterms, numVars) {
    if (minterms.length === 0) return "0";
    if (minterms.length === Math.pow(2, numVars)) return "1";
    
    const variables = getVariables(numVars);
    const terms = [];
    
    for (const minterm of minterms) {
        const termParts = [];
        for (let i = 0; i < numVars; i++) {
            const bit = (minterm >> (numVars - 1 - i)) & 1;
            const varName = variables[i];
            termParts.push(bit === 1 ? varName : varName + "'");
        }
        terms.push(termParts.join(''));
    }
    
    return terms.join(' + ');
}

function mintermsToPOS(minterms, numVars) {
    if (minterms.length === Math.pow(2, numVars)) return "1";
    
    const allMinterms = new Set(minterms);
    const maxterms = [];
    
    for (let i = 0; i < Math.pow(2, numVars); i++) {
        if (!allMinterms.has(i)) {
            maxterms.push(i);
        }
    }
    
    if (maxterms.length === 0) return "0";
    
    const variables = getVariables(numVars);
    const sumTerms = [];
    
    for (const maxterm of maxterms) {
        const termParts = [];
        for (let i = 0; i < numVars; i++) {
            const bit = (maxterm >> (numVars - 1 - i)) & 1;
            const varName = variables[i];
            termParts.push(bit === 0 ? varName : varName + "'");
        }
        sumTerms.push('(' + termParts.join(' + ') + ')');
    }
    
    return sumTerms.join('  ');
}

function generateTruthTable(minterms, numVars) {
    const table = [];
    const variables = getVariables(numVars);
    
    for (let i = 0; i < Math.pow(2, numVars); i++) {
        const row = {};
        const inputBits = [];
        
        // Get input bits
        for (let j = 0; j < numVars; j++) {
            const bit = (i >> (numVars - 1 - j)) & 1;
            inputBits.push(bit);
            row[variables[j]] = bit;
        }
        
        // Get output
        row['Output'] = minterms.includes(i) ? 1 : 0;
        table.push(row);
    }
    
    return table;
}

function showConversionResult(conversionType, originalExpr, sopExpr, posExpr, minterms, truthTable, numVars) {
    const container = document.getElementById('sop-pos-container');
    const resultsDiv = document.getElementById('canonical-forms-results');
    
    // Generate truth table HTML
    const truthTableHTML = generateTruthTableHTML(truthTable, numVars);
    
    container.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">${conversionType} Conversion</div>
            <div class="calculation-content">
                <div><strong>Original Expression:</strong> ${originalExpr}</div>
                <div><strong>Number of Variables:</strong> ${numVars}</div>
                <div><strong>Minterms:</strong> ${minterms.join(', ') || 'None'}</div>
                <div><strong>Number of Minterms:</strong> ${minterms.length}</div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="gate-description">
                            <h6>Sum of Products (SOP)</h6>
                            <div class="highlight-equation">F = ${sopExpr}</div>
                            <div class="mt-2">Number of Product Terms: ${sopExpr === '0' ? 0 : sopExpr.split(' + ').length}</div>
                            <div>Total Literals: ${sopExpr === '0' ? 0 : sopExpr.replace(/[^A-Z]/g, '').length}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="gate-description">
                            <h6>Product of Sums (POS)</h6>
                            <div class="highlight-equation">F = ${posExpr}</div>
                            <div class="mt-2">Number of Sum Terms: ${posExpr === '0' ? 0 : (posExpr === '1' ? 0 : posExpr.split('  ').length)}</div>
                            <div>Total Literals: ${posExpr === '0' ? 0 : posExpr.replace(/[^A-Z]/g, '').length}</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3"><strong>Truth Table:</strong></div>
                ${truthTableHTML}
                
                <div class="mt-3"><strong>Conversion Process:</strong></div>
                <ol>
                    <li>Parse the input expression to extract minterms</li>
                    <li>Generate canonical SOP form from minterms</li>
                    <li>Generate canonical POS form from minterms (complement of maxterms)</li>
                    <li>Verify both forms produce identical truth tables</li>
                </ol>
                
                <div class="mt-3"><strong>Verification:</strong></div>
                <div class="boolean-operation-result">
                     Both SOP and POS forms are logically equivalent<br>
                     Truth table verification passed<br>
                     Conversion completed successfully
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
}

function generateTruthTableHTML(truthTable, numVars) {
    const variables = getVariables(numVars);
    
    let html = '<div class="kmap-table"><table class="table table-bordered">';
    
    // Header
    html += '<thead><tr>';
    variables.forEach(v => html += `<th>${v}</th>`);
    html += '<th>Output</th></tr></thead><tbody>';
    
    // Rows
    truthTable.forEach(row => {
        html += '<tr>';
        variables.forEach(v => {
            const val = row[v];
            html += `<td class="${val ? 'table-success' : ''}">${val}</td>`;
        });
        html += `<td class="${row.Output ? 'table-success fw-bold' : ''}">${row.Output}</td></tr>`;
    });
    
    html += '</tbody></table></div>';
    return html;
}

function showError(message, type = 'general') {
    const container = document.getElementById('sop-pos-container');
    const resultsDiv = document.getElementById('canonical-forms-results');
    
    let examples = '';
    
    if (type === 'sop') {
        examples = `
            <h6>Valid SOP Examples:</h6>
            <div><strong>2 variables:</strong> A'B + AB', AB, A + B</div>
            <div><strong>3 variables:</strong> A'B'C + A'BC' + ABC, AB'C' + A'BC</div>
            <div><strong>4 variables:</strong> A'B'C'D' + ABCD, A'BC + CD'</div>
            <div><strong>Operators:</strong> Use + for OR, space or  for AND, ' for complement</div>
        `;
    } else if (type === 'pos') {
        examples = `
            <h6>Valid POS Examples:</h6>
            <div><strong>2 variables:</strong> (A+B')(A'+B), (A+B)(B+C), (A+B)(C+D)</div>
            <div><strong>3 variables:</strong> (A+B'+C)(A'+B+C'), (A+B)(B+C)(C+D)</div>
            <div><strong>4 variables:</strong> (A+B'+C+D)(A'+B+C'+D), (A+B)(C+D)(E+F)</div>
            <div><strong>Operators:</strong> Use  or * or . for AND between parentheses, + for OR inside parentheses</div>
            <div><strong>Accepted formats:</strong> (A+B)*(B+C), (A+B).(B+C), (A+B)(B+C), (A+B)(B+C)</div>
        `;
    } else {
        examples = `
            <h6>Valid Examples:</h6>
            <div><strong>SOP (2 variables):</strong> A'B + AB'</div>
            <div><strong>POS (2 variables):</strong> (A+B')(A'+B) or (A+B)*(B+C)</div>
            <div><strong>SOP (3 variables):</strong> A'B'C + A'BC' + ABC</div>
            <div><strong>POS (3 variables):</strong> (A+B'+C)(A'+B+C') or (A+B)(B+C)(C+D)</div>
        `;
    }
    
    container.innerHTML = `
        <div class="calculation-step" style="border-left-color: var(--danger-color);">
            <div class="calculation-title">Error in Conversion</div>
            <div class="calculation-content text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </div>
            <div class="mt-3">
                ${examples}
                <div class="mt-2 text-info">
                    <i class="fas fa-info-circle me-1"></i>
                    Note: Select the correct number of variables (2, 3, or 4) based on your expression
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
}

// Add this function to preprocess POS expressions
function preprocessExpression(expression) {
    // Remove all whitespace
    let expr = expression.replace(/\s+/g, '');
    
    // Convert to uppercase
    expr = expr.toUpperCase();
    
    // Replace various AND operators with standard 
    expr = expr.replace(/\./g, '');
    expr = expr.replace(/\*/g, '');
    
    return expr;
}
// Show the conversion interface
function showConversionInterface(type) {
    currentConversionType = type;
    
    // Show input section
    document.getElementById('code-conversion-inputs').style.display = 'block';
    
    // Set title and placeholder
    const title = document.getElementById('conversion-title');
    const input = document.getElementById('code-input');
    
    if (type === 'binary-to-gray') {
        title.textContent = 'Binary to Gray Code Conversion';
        input.placeholder = 'Enter binary number (e.g., 1101)';
    } else {
        title.textContent = 'Gray Code to Binary Conversion';
        input.placeholder = 'Enter Gray code (e.g., 1011)';
    }
    
    // Clear previous results
    clearConversionResults();
    
    addLog(`Started ${type === 'binary-to-gray' ? 'Binary to Gray' : 'Gray to Binary'} conversion`, 'info');
}

// Perform the conversion
function performConversion() {
    const input = document.getElementById('code-input').value.trim();
    
    if (!input) {
        showError('Please enter a code to convert');
        return;
    }
    
    // Validate input (must contain only 0s and 1s)
    if (!/^[01]+$/.test(input)) {
        showError('Input must contain only binary digits (0 and 1).');
        return;
    }
    
    // Validate length (max 32 bits)
    if (input.length > 32) {
        showError('Input too long. Maximum 32 bits allowed.');
        return;
    }
    
    try {
        if (currentConversionType === 'binary-to-gray') {
            convertBinaryToGray(input);
        } else {
            convertGrayToBinary(input);
        }
    } catch (error) {
        showError(error.message);
    }
}

// Convert binary to Gray code
function convertBinaryToGray(binaryStr) {
    const resultDiv = document.getElementById('solution-steps');
    resultDiv.innerHTML = '';
    
    // Create the main container
    const container = document.createElement('div');
    container.className = 'conversion-results';
    
    // Step 1: Input validation
    container.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">Binary to Gray Code Conversion</div>
            <div class="calculation-content">
                <div><strong>Step 1: Input Validation</strong></div>
                <div class="conversion-step">
                     Input: <span class="bit-value">${binaryStr}</span><br>
                     Length: ${binaryStr.length} bits<br>
                     Valid binary string confirmed
                </div>
                <div class="mt-3"><strong>Step 2: Conversion Rule</strong></div>
                <div class="conversion-step">
                    <strong>Rule for Binary to Gray conversion:</strong><br>
                    1. MSB (Most Significant Bit) of Gray code = MSB of Binary<br>
                    2. For each subsequent bit i (where i > 0):<br>
                       &nbsp;&nbsp;Gray[i] = Binary[i] XOR Binary[i-1]<br>
                    <br>
                    <strong>XOR Truth Table:</strong><br>
                    0 XOR 0 = 0<br>
                    0 XOR 1 = 1<br>
                    1 XOR 0 = 1<br>
                    1 XOR 1 = 0
                </div>
                <div class="mt-3"><strong>Step 3: Step-by-Step Calculation</strong></div>
                <div class="conversion-step">
    `;
    
    // Create table for step-by-step calculation
    const table = document.createElement('table');
    table.className = 'bit-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Bit Position</th>
                <th>Binary Bit</th>
                <th>Previous Bit</th>
                <th>Operation</th>
                <th>Gray Bit</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    const bits = binaryStr.split('');
    const grayBits = [];
    const tbody = document.createElement('tbody');
    
    // Process each bit
    for (let i = 0; i < bits.length; i++) {
        let grayBit, operation, prevBit;
        
        if (i === 0) {
            // MSB: Same as binary
            grayBit = bits[0];
            operation = 'MSB (same)';
            prevBit = 'N/A';
        } else {
            // Other bits: XOR with previous bit
            prevBit = bits[i-1];
            const xorResult = bits[i] !== bits[i-1] ? '1' : '0';
            grayBit = xorResult;
            operation = `${bits[i-1]} XOR ${bits[i]} = ${xorResult}`;
        }
        
        grayBits.push(grayBit);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="bit-index">${i}</td>
            <td class="bit-value">${bits[i]}</td>
            <td>${prevBit}</td>
            <td class="xor-operation">${operation}</td>
            <td class="bit-value" style="color: var(--success-color);">${grayBit}</td>
        `;
        tbody.appendChild(row);
    }
    
    table.appendChild(tbody);
    container.querySelector('.conversion-step:last-child').appendChild(table);
    
    const grayCode = grayBits.join('');
    
    // Step 4: Result
    container.innerHTML += `
                </div>
                <div class="mt-3"><strong>Step 4: Final Result</strong></div>
                <div class="conversion-step active">
                    <div><strong>Binary Input:</strong> <span class="bit-value">${binaryStr}</span></div>
                    <div><strong>Gray Code Output:</strong> <span class="highlight-equation">${grayCode}</span></div>
                    <div class="mt-2">Conversion completed successfully!</div>
                </div>
    `;
    
    // Step 5: Verification (convert back)
    const binaryBack = convertGrayToBinarySimple(grayCode);
    const verified = binaryBack === binaryStr;
    
    container.innerHTML += `
                <div class="mt-3"><strong>Step 5: Verification</strong></div>
                <div class="conversion-step ${verified ? 'active' : ''}">
                    <div>Gray Code: <span class="bit-value">${grayCode}</span></div>
                    <div>Convert back to Binary: <span class="bit-value">${binaryBack}</span></div>
                    <div>Original Binary: <span class="bit-value">${binaryStr}</span></div>
                    <div><strong>Verification:</strong> ${verified ? ' PASSED' : ' FAILED'}</div>
                </div>
            </div>
        </div>
    `;
    
    resultDiv.appendChild(container);
    
    // Update main result display
    document.getElementById('minimization-result').textContent = 
        `Binary ${binaryStr}  Gray Code ${grayCode}`;
    
    addLog(`Converted binary ${binaryStr} to Gray code ${grayCode}`, 'success');
}

// Convert Gray code to binary
function convertGrayToBinary(grayStr) {
    const resultDiv = document.getElementById('solution-steps');
    resultDiv.innerHTML = '';
    
    // Create the main container
    const container = document.createElement('div');
    container.className = 'conversion-results';
    
    // Step 1: Input validation
    container.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">Gray Code to Binary Conversion</div>
            <div class="calculation-content">
                <div><strong>Step 1: Input Validation</strong></div>
                <div class="conversion-step">
                     Input: <span class="bit-value">${grayStr}</span><br>
                     Length: ${grayStr.length} bits<br>
                     Valid Gray code string confirmed
                </div>
                <div class="mt-3"><strong>Step 2: Conversion Rule</strong></div>
                <div class="conversion-step">
                    <strong>Rule for Gray to Binary conversion:</strong><br>
                    1. MSB (Most Significant Bit) of Binary = MSB of Gray code<br>
                    2. For each subsequent bit i (where i > 0):<br>
                       &nbsp;&nbsp;Binary[i] = Binary[i-1] XOR Gray[i]<br>
                    <br>
                    <strong>XOR Truth Table:</strong><br>
                    0 XOR 0 = 0<br>
                    0 XOR 1 = 1<br>
                    1 XOR 0 = 1<br>
                    1 XOR 1 = 0
                </div>
                <div class="mt-3"><strong>Step 3: Step-by-Step Calculation</strong></div>
                <div class="conversion-step">
    `;
    
    // Create table for step-by-step calculation
    const table = document.createElement('table');
    table.className = 'bit-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Bit Position</th>
                <th>Gray Bit</th>
                <th>Previous Binary</th>
                <th>Operation</th>
                <th>Binary Bit</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    const grayBits = grayStr.split('');
    const binaryBits = [];
    const tbody = document.createElement('tbody');
    
    // Process each bit
    for (let i = 0; i < grayBits.length; i++) {
        let binaryBit, operation, prevBinary;
        
        if (i === 0) {
            // MSB: Same as Gray
            binaryBit = grayBits[0];
            operation = 'MSB (same)';
            prevBinary = 'N/A';
        } else {
            // Other bits: XOR with previous binary bit
            prevBinary = binaryBits[i-1];
            const xorResult = binaryBits[i-1] !== grayBits[i] ? '1' : '0';
            binaryBit = xorResult;
            operation = `${binaryBits[i-1]} XOR ${grayBits[i]} = ${xorResult}`;
        }
        
        binaryBits.push(binaryBit);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="bit-index">${i}</td>
            <td class="bit-value">${grayBits[i]}</td>
            <td>${prevBinary}</td>
            <td class="xor-operation">${operation}</td>
            <td class="bit-value" style="color: var(--success-color);">${binaryBit}</td>
        `;
        tbody.appendChild(row);
    }
    
    table.appendChild(tbody);
    container.querySelector('.conversion-step:last-child').appendChild(table);
    
    const binaryCode = binaryBits.join('');
    
    // Step 4: Result
    container.innerHTML += `
                </div>
                <div class="mt-3"><strong>Step 4: Final Result</strong></div>
                <div class="conversion-step active">
                    <div><strong>Gray Code Input:</strong> <span class="bit-value">${grayStr}</span></div>
                    <div><strong>Binary Output:</strong> <span class="highlight-equation">${binaryCode}</span></div>
                    <div class="mt-2">Conversion completed successfully!</div>
                </div>
    `;
    
    // Step 5: Verification (convert back)
    const grayBack = convertBinaryToGraySimple(binaryCode);
    const verified = grayBack === grayStr;
    
    container.innerHTML += `
                <div class="mt-3"><strong>Step 5: Verification</strong></div>
                <div class="conversion-step ${verified ? 'active' : ''}">
                    <div>Binary: <span class="bit-value">${binaryCode}</span></div>
                    <div>Convert back to Gray: <span class="bit-value">${grayBack}</span></div>
                    <div>Original Gray: <span class="bit-value">${grayStr}</span></div>
                    <div><strong>Verification:</strong> ${verified ? ' PASSED' : ' FAILED'}</div>
                </div>
            </div>
        </div>
    `;
    
    resultDiv.appendChild(container);
    
    // Update main result display
    document.getElementById('minimization-result').textContent = 
        `Gray Code ${grayStr}  Binary ${binaryCode}`;
    
    addLog(`Converted Gray code ${grayStr} to binary ${binaryCode}`, 'success');
}

// Simple conversion functions (without display)
function convertBinaryToGraySimple(binaryStr) {
    let gray = binaryStr[0];
    for (let i = 1; i < binaryStr.length; i++) {
        gray += binaryStr[i-1] !== binaryStr[i] ? '1' : '0';
    }
    return gray;
}

function convertGrayToBinarySimple(grayStr) {
    let binary = grayStr[0];
    for (let i = 1; i < grayStr.length; i++) {
        binary += binary[i-1] !== grayStr[i] ? '1' : '0';
    }
    return binary;
}

// Test all conversions
function testAllConversions() {
    const resultDiv = document.getElementById('solution-steps');
    resultDiv.innerHTML = '';
    
    // Test cases (0 to 15 in binary)
    const testCases = [
        "0000", "0001", "0010", "0011",
        "0100", "0101", "0110", "0111",
        "1000", "1001", "1010", "1011",
        "1100", "1101", "1110", "1111"
    ];
    
    const container = document.createElement('div');
    container.className = 'conversion-results';
    
    container.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">Binary  Gray Code Conversion Test Table</div>
            <div class="calculation-content">
                <div class="conversion-step">
                    <strong>Testing all 4-bit binary numbers (0-15):</strong>
                </div>
                <div class="kmap-table mt-3">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Decimal</th>
                                <th>Binary</th>
                                <th>Gray Code</th>
                                <th>Binary (back)</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // Create table rows
    const tbody = document.createElement('tbody');
    
    testCases.forEach((binary, index) => {
        const gray = convertBinaryToGraySimple(binary);
        const binaryBack = convertGrayToBinarySimple(gray);
        const verified = binary === binaryBack;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index}</td>
            <td class="${verified ? 'table-success' : ''}">${binary}</td>
            <td>${gray}</td>
            <td>${binaryBack}</td>
            <td class="${verified ? 'table-success' : 'table-danger'}">
                ${verified ? '' : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Append tbody to container
    const table = container.querySelector('table');
    table.appendChild(tbody);
    
    container.innerHTML += `
                        </tbody>
                    </table>
                </div>
                
                <div class="conversion-step mt-3 active">
                    <strong>Key Properties of Gray Code:</strong><br>
                    1. <strong>Adjacent codes differ by only one bit</strong> - This minimizes errors in digital systems<br>
                    2. <strong>Cyclic</strong> - The last code differs from the first by only one bit<br>
                    3. <strong>Reflective</strong> - The code is symmetric around the middle<br>
                    4. <strong>Applications:</strong> Rotary encoders, error correction, genetic algorithms<br>
                </div>
                
                <div class="conversion-step mt-2">
                    <strong>Comparison Example:</strong><br>
                    Binary 7  Gray: 0111  0100<br>
                    Notice only 1-bit change between consecutive Gray codes<br>
                    Binary changes: 0110 (6)  0111 (7) = 3 bits change<br>
                    Gray changes: 0101 (6)  0100 (7) = 1 bit change
                </div>
            </div>
        </div>
    `;
    
    resultDiv.appendChild(container);
    
    // Update main result display
    document.getElementById('minimization-result').textContent = 
        'Tested 16 binary  Gray code conversions (0-15)';
    
    addLog('Tested all 4-bit binary to Gray code conversions', 'info');
}

// Show error message
function showError(message) {
    const resultDiv = document.getElementById('solution-steps');
    
    const container = document.createElement('div');
    container.className = 'conversion-results';
    
    container.innerHTML = `
        <div class="calculation-step" style="border-left-color: var(--danger-color);">
            <div class="calculation-title">Conversion Error</div>
            <div class="calculation-content text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </div>
            <div class="conversion-step mt-2">
                <strong>Valid Input Examples:</strong><br>
                 Binary numbers: 1101, 00101101, 10101010<br>
                 Gray codes: 1011, 0010, 11100011<br>
                 <strong>Note:</strong> Only 0s and 1s are allowed<br>
                 Maximum length: 32 bits
            </div>
            <div class="conversion-step mt-2">
                <strong>Invalid Input Examples:</strong><br>
                 Decimal: 123, 89<br>
                 Octal: 17, 77<br>
                 Hexadecimal: A5, FF<br>
                 Alphabetic: ABC, XYZ<br>
                 Mixed: 10A1, 2B3C
            </div>
        </div>
    `;
    
    resultDiv.appendChild(container);
    
    addLog(`Conversion error: ${message}`, 'error');
}

// Clear conversion results
function clearConversion() {
    document.getElementById('code-input').value = '';
    clearConversionResults();
    addLog('Cleared conversion inputs', 'info');
}

function clearConversionResults() {
    document.getElementById('solution-steps').innerHTML = '';
    document.getElementById('minimization-result').textContent = 
        'Enter binary/Gray code and click Convert';
    document.getElementById('kmap-visualization').style.display = 'none';
    document.getElementById('grouping-visualization').style.display = 'none';
    document.getElementById('canonical-forms-results').style.display = 'none';
}

// Show parity interface
// Show parity interface
function showParityInterface(mode) {
    currentParityMode = mode;
    
    // Show input section
    document.getElementById('parity-input-section').style.display = 'block';
    
    // Set title and adjust interface
    const title = document.getElementById('parity-title');
    const checkInput = document.getElementById('parity-check-input');
    const parityTypeSelect = document.getElementById('parity-type-select');
    const binaryInput = document.getElementById('binary-data-input');
    
    if (mode === 'generate') {
        title.textContent = 'Parity Bit Generation';
        checkInput.style.display = 'none';
        parityTypeSelect.style.display = 'block';
        binaryInput.placeholder = 'Enter binary data (e.g., 1011001)';
        binaryInput.parentElement.querySelector('.input-label').textContent = 'Binary Data:';
    } else {
        title.textContent = 'Parity Check (Even/Odd Detection)';
        checkInput.style.display = 'none';
        parityTypeSelect.style.display = 'none';
        binaryInput.placeholder = 'Enter binary data to check (e.g., 1011001)';
        binaryInput.parentElement.querySelector('.input-label').textContent = 'Binary Data:';
    }
    
    // Clear previous results
    clearParityResults();
    
    addLog(`Started ${mode === 'generate' ? 'parity generation' : 'parity checking'}`, 'info');
}

// Execute parity operation
function executeParityOperation() {
    const binaryData = document.getElementById('binary-data-input').value.trim();
    
    if (currentParityMode === 'generate') {
        const parityType = document.getElementById('parity-type-select').value;
        generateParityBit(binaryData, parityType);
    } else {
        checkParityType(binaryData);
    }
}

// Generate parity bit (unchanged)
function generateParityBit(binaryData, parityType) {
    if (!binaryData) {
        showParityError('Please enter binary data');
        return;
    }
    
    // Validate binary input
    if (!/^[01]+$/.test(binaryData)) {
        showParityError('Input must contain only binary digits (0 and 1).');
        return;
    }
    
    if (binaryData.length > 32) {
        showParityError('Input too long. Maximum 32 bits allowed.');
        return;
    }
    
    try {
        const resultDiv = document.getElementById('solution-steps');
        resultDiv.innerHTML = '';
        
        // Create container for results
        const container = document.createElement('div');
        container.className = 'conversion-results';
        
        // Step 1: Count number of 1s
        const countOnes = binaryData.split('').filter(bit => bit === '1').length;
        
        // Step 2: Determine parity bit based on type
        let parityBit;
        let explanation;
        
        if (parityType === 'even') {
            parityBit = countOnes % 2 === 0 ? '0' : '1';
            explanation = `Even parity means: Total number of 1s (data + parity bit) should be EVEN`;
        } else {
            parityBit = countOnes % 2 === 1 ? '0' : '1';
            explanation = `Odd parity means: Total number of 1s (data + parity bit) should be ODD`;
        }
        
        // Step 3: Create final data with parity
        const dataWithParity = binaryData + parityBit;
        const totalOnes = parseInt(countOnes) + parseInt(parityBit);
        
        // Generate explanation
        container.innerHTML = `
            <div class="calculation-step active">
                <div class="calculation-title">${parityType.charAt(0).toUpperCase() + parityType.slice(1)} Parity Bit Generation</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Input Data Analysis</strong></div>
                    <div class="parity-step">
                        Original Data: <span class="bit-value">${binaryData}</span><br>
                        Length: ${binaryData.length} bits<br>
                         Valid binary data confirmed
                    </div>
                    
                    <div class="mt-2"><strong>Step 2: Count Number of 1s</strong></div>
                    <div class="parity-step">
                        Data: ${binaryData}<br>
                        Counting 1s: ${binaryData.split('').map((bit, idx) => 
                            bit === '1' ? `<span class="parity-count">1</span>` : '0'
                        ).join(' ')}<br>
                        Total number of 1s: <span class="highlight-equation">${countOnes}</span>
                    </div>
                    
                    <div class="mt-2"><strong>Step 3: Determine Parity Bit (${parityType} parity)</strong></div>
                    <div class="parity-step active">
                        <strong>Rule for ${parityType} parity:</strong><br>
                        ${explanation}<br><br>
                        
                        <strong>Calculation:</strong><br>
                        Number of 1s in data = ${countOnes}<br>
                        ${countOnes} is ${countOnes % 2 === 0 ? 'EVEN' : 'ODD'}<br><br>
                        
                        <strong>Parity bit should be:</strong><br>
                         For even parity: Parity bit = ${countOnes % 2 === 0 ? '"0" (to keep total even)' : '"1" (to make total even)'}<br>
                         For odd parity: Parity bit = ${countOnes % 2 === 1 ? '"0" (to keep total odd)' : '"1" (to make total odd)'}<br><br>
                        
                        <div class="highlight-equation">Parity bit = <span class="parity-bit">${parityBit}</span></div>
                    </div>
                    
                    <div class="mt-2"><strong>Step 4: Final Result</strong></div>
                    <div class="parity-step">
                        <div>Original Data: <span class="bit-value">${binaryData}</span></div>
                        <div>Parity Bit: <span class="parity-bit">${parityBit}</span></div>
                        <div class="highlight-equation">Data with Parity: ${dataWithParity}</div>
                    </div>
                    
                    <div class="mt-2"><strong>Step 5: Verification</strong></div>
                    <div class="parity-step">
                        Data + Parity = ${binaryData} + ${parityBit} = ${dataWithParity}<br>
                        Total number of 1s = ${countOnes} + ${parityBit} = ${totalOnes}<br>
                        ${totalOnes} is ${totalOnes % 2 === 0 ? 'EVEN' : 'ODD'}<br>
                         ${parityType.charAt(0).toUpperCase() + parityType.slice(1)} parity achieved!
                    </div>
                </div>
            </div>
        `;
        
        resultDiv.appendChild(container);
        
        // Update main result display
        document.getElementById('minimization-result').textContent = 
            `${parityType.charAt(0).toUpperCase() + parityType.slice(1)} Parity: ${binaryData}  ${dataWithParity} (parity bit: ${parityBit})`;
        
        addLog(`Generated ${parityType} parity for ${binaryData}: parity bit = ${parityBit}`, 'success');
        
    } catch (error) {
        showParityError(error.message);
    }
}

// Check parity type (even or odd) - NEW SIMPLIFIED FUNCTION
function checkParityType(binaryData) {
    if (!binaryData) {
        showParityError('Please enter binary data to check');
        return;
    }
    
    // Validate binary input
    if (!/^[01]+$/.test(binaryData)) {
        showParityError('Input must contain only binary digits (0 and 1).');
        return;
    }
    
    if (binaryData.length > 32) {
        showParityError('Input too long. Maximum 32 bits allowed.');
        return;
    }
    
    try {
        const resultDiv = document.getElementById('solution-steps');
        resultDiv.innerHTML = '';
        
        // Create container for results
        const container = document.createElement('div');
        container.className = 'conversion-results';
        
        // Step 1: Count number of 1s
        const countOnes = binaryData.split('').filter(bit => bit === '1').length;
        const isEvenParity = countOnes % 2 === 0;
        
        // Generate explanation
        container.innerHTML = `
            <div class="calculation-step active">
                <div class="calculation-title">Parity Type Check: Even or Odd?</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Input Data Analysis</strong></div>
                    <div class="parity-step">
                        Input Data: <span class="bit-value">${binaryData}</span><br>
                        Length: ${binaryData.length} bits<br>
                         Valid binary data confirmed
                    </div>
                    
                    <div class="mt-2"><strong>Step 2: Count Number of 1s</strong></div>
                    <div class="parity-step">
                        Data: ${binaryData}<br>
                        Counting 1s: ${binaryData.split('').map((bit, idx) => 
                            bit === '1' ? `<span class="parity-count">1</span>` : '0'
                        ).join(' ')}<br>
                        <strong>Total number of 1s: <span class="highlight-equation">${countOnes}</span></strong>
                    </div>
                    
                    <div class="mt-2"><strong>Step 3: Determine if Even or Odd</strong></div>
                    <div class="parity-step active">
                        <strong>Rule:</strong><br>
                         <strong>Even Parity:</strong> When total number of 1s is EVEN (0, 2, 4, 6...)<br>
                         <strong>Odd Parity:</strong> When total number of 1s is ODD (1, 3, 5, 7...)<br><br>
                        
                        <strong>Calculation:</strong><br>
                        Number of 1s = ${countOnes}<br>
                        Is ${countOnes} even or odd?<br>
                        ${countOnes}  2 = ${Math.floor(countOnes/2)} with remainder ${countOnes % 2}<br><br>
                        
                        <div class="highlight-equation">
                            ${countOnes} is ${isEvenParity ? '<span style="color: var(--success-color)">EVEN</span>' : '<span style="color: var(--warning-color)">ODD</span>'}
                        </div>
                    </div>
                    
                    <div class="mt-2"><strong>Step 4: Parity Type Result</strong></div>
                    <div class="parity-step ${isEvenParity ? 'active' : ''}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="gate-description ${isEvenParity ? 'highlight' : ''}" style="animation: ${isEvenParity ? 'highlight 1s ease' : 'none'}">
                                    <h6>Even Parity Analysis:</h6>
                                    <div>Total 1s = ${countOnes}</div>
                                    <div>${countOnes} is ${isEvenParity ? ' EVEN' : ' NOT EVEN'}</div>
                                    <div>${isEvenParity ? 
                                        '<span style="color: var(--success-color)"> This data has EVEN parity</span>' : 
                                        '<span style="color: var(--danger-color)"> This data does NOT have even parity</span>'}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="gate-description ${!isEvenParity ? 'highlight' : ''}" style="animation: ${!isEvenParity ? 'highlight 1s ease' : 'none'}">
                                    <h6>Odd Parity Analysis:</h6>
                                    <div>Total 1s = ${countOnes}</div>
                                    <div>${countOnes} is ${!isEvenParity ? ' ODD' : ' NOT ODD'}</div>
                                    <div>${!isEvenParity ? 
                                        '<span style="color: var(--success-color)"> This data has ODD parity</span>' : 
                                        '<span style="color: var(--danger-color)"> This data does NOT have odd parity</span>'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <h4 class="${isEvenParity ? 'text-success' : 'text-warning'}">
                                <i class="fas fa-${isEvenParity ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                                This binary data has <strong>${isEvenParity ? 'EVEN' : 'ODD'}</strong> parity
                            </h4>
                        </div>
                    </div>
                    
                    <div class="mt-2"><strong>Step 5: Simple Explanation</strong></div>
                    <div class="parity-step">
                        <strong>What does this mean?</strong><br>
                        ${isEvenParity ? 
                            ` Your data "${binaryData}" has ${countOnes} ones<br>
                              ${countOnes} is an EVEN number (${countOnes}  2 = ${countOnes/2} exactly)<br>
                              <strong>Even parity</strong> means data has even number of 1s<br>
                              No parity bit needed for even parity detection` : 
                            ` Your data "${binaryData}" has ${countOnes} ones<br>
                              ${countOnes} is an ODD number (${countOnes}  2 = ${Math.floor(countOnes/2)} remainder 1)<br>
                              <strong>Odd parity</strong> means data has odd number of 1s<br>
                              No parity bit needed for odd parity detection`}
                    </div>
                    
                    <div class="mt-2"><strong>Step 6: If We Wanted to Add a Parity Bit</strong></div>
                    <div class="parity-step">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>To make it EVEN parity:</strong><br>
                                Current 1s: ${countOnes} (${isEvenParity ? 'EVEN' : 'ODD'})<br>
                                ${isEvenParity ? 
                                    'Already even, so parity bit = 0' : 
                                    'Needs to be even, so parity bit = 1'}<br>
                                Result: ${binaryData}${isEvenParity ? '0' : '1'}
                            </div>
                            <div class="col-md-6">
                                <strong>To make it ODD parity:</strong><br>
                                Current 1s: ${countOnes} (${isEvenParity ? 'EVEN' : 'ODD'})<br>
                                ${!isEvenParity ? 
                                    'Already odd, so parity bit = 0' : 
                                    'Needs to be odd, so parity bit = 1'}<br>
                                Result: ${binaryData}${!isEvenParity ? '0' : '1'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3"><strong>Summary for Students:</strong></div>
                    <div class="parity-explanation">
                        <strong>How to check if binary data has even or odd parity:</strong><br>
                        1. <strong>Count all the 1s</strong> in your binary number<br>
                        2. <strong>Check if the count is even or odd</strong><br>
                        3. <strong>Even parity:</strong> If count is 0, 2, 4, 6, 8... (divisible by 2)<br>
                        4. <strong>Odd parity:</strong> If count is 1, 3, 5, 7, 9... (not divisible by 2)<br>
                        <br>
                        <strong>Example:</strong> "1011" has 3 ones (3 is ODD)  Has ODD parity<br>
                        <strong>Example:</strong> "1100" has 2 ones (2 is EVEN)  Has EVEN parity
                    </div>
                    
                    <div class="mt-3"><strong>Quick Practice:</strong></div>
                    <div class="parity-explanation">
                        <strong>Try these (answers below):</strong><br>
                        1. "101010" - Even or odd parity?<br>
                        2. "111000" - Even or odd parity?<br>
                        3. "000000" - Even or odd parity?<br>
                        4. "111111" - Even or odd parity?<br>
                        <br>
                        <button class="btn-glow btn-sm" onclick="showPracticeAnswers()">
                            <i class="fas fa-lightbulb me-1"></i>Show Answers
                        </button>
                        <div id="practice-answers" style="display: none; margin-top: 10px;">
                            <strong>Answers:</strong><br>
                            1. "101010" has 3 ones  ODD parity<br>
                            2. "111000" has 3 ones  ODD parity<br>
                            3. "000000" has 0 ones  EVEN parity (0 is even!)<br>
                            4. "111111" has 6 ones  EVEN parity<br>
                            <small>Tip: 0 is considered an even number in mathematics</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        resultDiv.appendChild(container);
        
        // Update main result display
        document.getElementById('minimization-result').textContent = 
            `Parity Check: "${binaryData}" has ${isEvenParity ? 'EVEN' : 'ODD'} parity (${countOnes} ones)`;
        
        addLog(`Checked parity for ${binaryData}: ${isEvenParity ? 'EVEN' : 'ODD'} parity with ${countOnes} ones`, 'success');
        
    } catch (error) {
        showParityError(error.message);
    }
}

// Helper function to show practice answers
function showPracticeAnswers() {
    const answersDiv = document.getElementById('practice-answers');
    answersDiv.style.display = 'block';
}

// Test parity examples
function testParityExamples() {
    const resultDiv = document.getElementById('solution-steps');
    resultDiv.innerHTML = '';
    
    const testCases = [
        { data: '1011001', ones: 4, parity: 'EVEN', description: 'Example 1' },
        { data: '1100110', ones: 4, parity: 'EVEN', description: 'Example 2' },
        { data: '1111111', ones: 7, parity: 'ODD', description: 'All ones' },
        { data: '0000000', ones: 0, parity: 'EVEN', description: 'All zeros' },
        { data: '1010101', ones: 4, parity: 'EVEN', description: 'Alternating' },
        { data: '1001001', ones: 3, parity: 'ODD', description: 'Example 3' }
    ];
    
    const container = document.createElement('div');
    container.className = 'conversion-results';
    
    container.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">Parity Check Examples</div>
            <div class="calculation-content">
                <div class="parity-step">
                    <strong>Testing different binary patterns:</strong><br>
                    Shows how to determine if binary data has even or odd parity
                </div>
                
                <div class="kmap-table mt-3">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Binary Data</th>
                                <th>1s Count</th>
                                <th>Even/Odd?</th>
                                <th>Parity Type</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // Create table rows
    const tbody = document.createElement('tbody');
    
    testCases.forEach(testCase => {
        const isEven = testCase.ones % 2 === 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${testCase.description}</td>
            <td class="bit-value">${testCase.data}</td>
            <td>${testCase.ones}</td>
            <td>${testCase.ones} is ${isEven ? '<span class="text-success">EVEN</span>' : '<span class="text-warning">ODD</span>'}</td>
            <td class="${isEven ? 'table-success' : 'table-warning'} fw-bold">
                ${isEven ? 'EVEN Parity' : 'ODD Parity'}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Append tbody to container
    const table = container.querySelector('table');
    table.appendChild(tbody);
    
    container.innerHTML += `
                        </tbody>
                    </table>
                </div>
                
                <div class="parity-step mt-3 active">
                    <strong>Key Observations:</strong><br>
                    1. <strong>Even numbers:</strong> 0, 2, 4, 6, 8, 10...  Give EVEN parity<br>
                    2. <strong>Odd numbers:</strong> 1, 3, 5, 7, 9, 11...  Give ODD parity<br>
                    3. <strong>Special case:</strong> 0 is an EVEN number!<br>
                    4. You only need to check if the count is divisible by 2
                </div>
                
                <div class="parity-step mt-2">
                    <strong>Quick Method to Check:</strong><br>
                    <strong>Look at the last digit of the count:</strong><br>
                     If last digit is 0, 2, 4, 6, or 8  EVEN parity<br>
                     If last digit is 1, 3, 5, 7, or 9  ODD parity<br><br>
                    
                    <strong>Example:</strong> Count 1s = 14  Last digit is 4  EVEN parity<br>
                    <strong>Example:</strong> Count 1s = 27  Last digit is 7  ODD parity
                </div>
                
                <div class="mt-3"><strong>Test Yourself:</strong></div>
                <div class="parity-explanation">
                    Without counting all 1s, can you tell if these have even or odd parity?<br>
                    1. "1010101010" (pattern: 1,0 repeating)<br>
                    2. "11110000" (four 1s, four 0s)<br>
                    3. "01010101" (pattern: 0,1 repeating)<br>
                    4. "10000001" (1s at both ends)<br>
                    <br>
                    <strong>Think:</strong> Look for patterns!<br>
                    <strong>Answers:</strong> 1. ODD, 2. EVEN, 3. EVEN, 4. EVEN
                </div>
            </div>
        </div>
    `;
    
    resultDiv.appendChild(container);
    
    // Update main result display
    document.getElementById('minimization-result').textContent = 
        'Tested 6 parity check examples - See patterns and rules';
    
    addLog('Displayed parity check examples', 'info');
}

// Show parity error (unchanged)
function showParityError(message) {
    const resultDiv = document.getElementById('solution-steps');
    
    const container = document.createElement('div');
    container.className = 'conversion-results';
    
    container.innerHTML = `
        <div class="calculation-step" style="border-left-color: var(--danger-color);">
            <div class="calculation-title">Parity Error</div>
            <div class="calculation-content text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </div>
            <div class="parity-step mt-2">
                <strong>Valid Input Examples:</strong><br>
                 Binary numbers: 1011001, 1100110, 0011, 111000111<br>
                 <strong>Note:</strong> Only 0s and 1s are allowed<br>
                 Maximum length: 32 bits
            </div>
            <div class="parity-step mt-2">
                <strong>Example Walkthrough:</strong><br>
                <strong>Check parity for "1011":</strong><br>
                1. Count 1s: 1+0+1+1 = 3<br>
                2. 3 is an ODD number<br>
                3. Therefore, "1011" has ODD parity
            </div>
        </div>
    `;
    
    resultDiv.appendChild(container);
    
    addLog(`Parity error: ${message}`, 'error');
}

// Clear parity interface
function clearParityInterface() {
    document.getElementById('binary-data-input').value = '';
    document.getElementById('data-with-parity-input').value = '';
    clearParityResults();
    addLog('Cleared parity inputs', 'info');
}

function clearParityResults() {
    document.getElementById('solution-steps').innerHTML = '';
    document.getElementById('minimization-result').textContent = 
        currentParityMode === 'generate' ? 
        'Enter binary data and select parity type' : 
        'Enter binary data to check parity';
    document.getElementById('kmap-visualization').style.display = 'none';
    document.getElementById('grouping-visualization').style.display = 'none';
    document.getElementById('canonical-forms-results').style.display = 'none';
}
// Initialize Arithmetic Operations
function initializeArithmeticOperations() {
    // Reset state
    currentAdderType = null;
    currentBinaryOperation = null;
    adderInputs = [0, 0];
    fullAdderInputs = [0, 0, 0];
    adderOutput = { sum: 0, carry: 0 };
    binaryBits = 8;
    binaryNumber1 = '';
    binaryNumber2 = '';
    
    // Hide all sections initially
    document.getElementById('adder-inputs').style.display = 'none';
    document.getElementById('adder-visualization').style.display = 'none';
    document.getElementById('adder-truth-table-container').style.display = 'none';
    document.getElementById('adder-calculation-steps').style.display = 'block';
        // Add this line to hide complement inputs initially
    document.getElementById('complement-inputs').style.display = 'none';

    // Clear calculation steps
    document.getElementById('adder-steps-container').innerHTML = '';
    
    // Update description
    document.getElementById('adder-description').textContent = 
        'Select an operation type to begin';
    document.getElementById('adder-operation-explanation').textContent = 
        'Select an operation from the left panel to begin';
    document.getElementById('adder-result').textContent = '-';
    
    // Setup input listeners
    setupAdderInputListeners();
}

// Select adder type (Half-Adder or Full-Adder)
function selectAdderType(type) {
    currentAdderType = type;
    
    // Show inputs section
    document.getElementById('adder-inputs').style.display = 'block';
    
    // Reset inputs
    if (type === 'half-adder') {
        adderInputs = [0, 0];
        
        // Show half-adder inputs, hide full-adder inputs
        document.getElementById('half-adder-inputs').style.display = 'block';
        document.getElementById('full-adder-inputs').style.display = 'none';
        
        // Update title and description
        document.getElementById('adder-title').textContent = 'Half-Adder Inputs';
        document.getElementById('adder-description').innerHTML = `
            <strong>Half-Adder:</strong><br>
             Adds two binary bits (A and B)<br>
             Produces Sum and Carry outputs<br>
             Sum = A XOR B<br>
             Carry = A AND B<br>
             Cannot handle carry-in from previous stage
        `;
        
    } else { // full-adder
        fullAdderInputs = [0, 0, 0];
        
        // Show full-adder inputs, hide half-adder inputs
        document.getElementById('half-adder-inputs').style.display = 'none';
        document.getElementById('full-adder-inputs').style.display = 'block';
        
        // Update title and description
        document.getElementById('adder-title').textContent = 'Full-Adder Inputs';
        document.getElementById('adder-description').innerHTML = `
            <strong>Full-Adder:</strong><br>
             Adds three binary bits (A, B, and Carry-in)<br>
             Produces Sum and Carry-out outputs<br>
             Can handle carry-in from previous stage<br>
             Implemented using two Half-Adders and an OR gate
        `;
    }
    
    // Show visualization and truth table
    document.getElementById('adder-visualization').style.display = 'block';
    document.getElementById('adder-truth-table-container').style.display = 'block';
    document.getElementById('adder-calculation-steps').style.display = 'block';
    
    // Reset calculation steps
    document.getElementById('adder-steps-container').innerHTML = '';
    
    // Reset outputs
    adderOutput = { sum: 0, carry: 0 };
    document.getElementById('adder-result').textContent = 'Sum: 0, Carry: 0';
    
    // Generate initial visualization and truth table
    updateAdderVisualization();
    updateAdderTruthTable();
    
    // Update explanation
    updateAdderExplanation();
    
    addLog(`Selected ${type === 'half-adder' ? 'Half-Adder' : 'Full-Adder'}`, 'info');
}

// Toggle adder input
function toggleAdderInput(index, type) {
    if (type === 'half-adder') {
        adderInputs[index] = adderInputs[index] ? 0 : 1;
        
        // Update toggle label
        const toggleId = index === 0 ? 'ha-input-a' : 'ha-input-b';
        const toggleInput = document.getElementById(toggleId);
        const toggleLabel = toggleInput.parentElement.parentElement.querySelector('span:last-child');
        toggleLabel.textContent = adderInputs[index] ? '1 (ON)' : '0 (OFF)';
    } else {
        fullAdderInputs[index] = fullAdderInputs[index] ? 0 : 1;
        
        // Update toggle label
        let toggleId;
        if (index === 0) toggleId = 'fa-input-a';
        else if (index === 1) toggleId = 'fa-input-b';
        else toggleId = 'fa-input-cin';
        
        const toggleInput = document.getElementById(toggleId);
        const toggleLabel = toggleInput.parentElement.parentElement.querySelector('span:last-child');
        toggleLabel.textContent = fullAdderInputs[index] ? '1 (ON)' : '0 (OFF)';
    }
    
    // Recalculate
    calculateAdder();
}

// Calculate adder output
function calculateAdder() {
    if (!currentAdderType) return;
    
    let sum, carry;
    
    if (currentAdderType === 'half-adder') {
        // Half-Adder: Sum = A XOR B, Carry = A AND B
        sum = adderInputs[0] ^ adderInputs[1];
        carry = adderInputs[0] & adderInputs[1];
    } else {
        // Full-Adder: implemented using two Half-Adders
        // First half-adder: A XOR B
        const s1 = fullAdderInputs[0] ^ fullAdderInputs[1];
        const c1 = fullAdderInputs[0] & fullAdderInputs[1];
        
        // Second half-adder: s1 XOR Cin
        sum = s1 ^ fullAdderInputs[2];
        const c2 = s1 & fullAdderInputs[2];
        
        // Carry = c1 OR c2
        carry = c1 | c2;
    }
    
    adderOutput = { sum, carry };
    
    // Update result display
    document.getElementById('adder-result').textContent = `Sum: ${sum}, Carry: ${carry}`;
    
    // Update visualization
    updateAdderVisualization();
    
    // Update truth table highlighting
    updateAdderTruthTable();
    
    // Show step-by-step calculation
    showAdderCalculationSteps();
    
    addLog(`Calculated ${currentAdderType === 'half-adder' ? 'Half-Adder' : 'Full-Adder'}: Sum=${sum}, Carry=${carry}`, 'success');
}

// Update adder visualization
function updateAdderVisualization() {
    const visualization = document.getElementById('adder-gate-visualization');
    visualization.innerHTML = '';
    
    if (currentAdderType === 'half-adder') {
        createHalfAdderVisualization(visualization);
    } else {
        createFullAdderVisualization(visualization);
    }
}

// Create Half-Adder visualization
function createHalfAdderVisualization(container) {
    // Create HA gate
    const gate = document.createElement('div');
    gate.className = 'adder-gate half-adder-gate';
    gate.style.position = 'absolute';
    gate.style.left = '50%';
    gate.style.top = '50%';
    gate.style.transform = 'translate(-50%, -50%)';
    container.appendChild(gate);
    
    // Input A
    const inputA = document.createElement('div');
    inputA.className = `adder-input-node ${adderInputs[0] ? 'active' : ''}`;
    inputA.textContent = 'A';
    inputA.style.left = '20%';
    inputA.style.top = '30%';
    inputA.addEventListener('click', () => toggleAdderInput(0, 'half-adder'));
    container.appendChild(inputA);
    
    // Input B
    const inputB = document.createElement('div');
    inputB.className = `adder-input-node ${adderInputs[1] ? 'active' : ''}`;
    inputB.textContent = 'B';
    inputB.style.left = '20%';
    inputB.style.top = '70%';
    inputB.addEventListener('click', () => toggleAdderInput(1, 'half-adder'));
    container.appendChild(inputB);
    
    // Output Sum
    const outputSum = document.createElement('div');
    outputSum.className = `adder-output-node ${adderOutput.sum ? 'active' : ''}`;
    outputSum.textContent = 'S';
    outputSum.style.right = '20%';
    outputSum.style.top = '30%';
    container.appendChild(outputSum);
    
    // Output Carry
    const outputCarry = document.createElement('div');
    outputCarry.className = `adder-output-node ${adderOutput.carry ? 'active' : ''}`;
    outputCarry.textContent = 'C';
    outputCarry.style.right = '20%';
    outputCarry.style.top = '70%';
    container.appendChild(outputCarry);
    
    // Connection lines
    createConnection(container, '20%', '30%', '35%', '30%', adderInputs[0]); // A to gate
    createConnection(container, '20%', '70%', '35%', '70%', adderInputs[1]); // B to gate
    createConnection(container, '65%', '30%', '80%', '30%', adderOutput.sum); // Gate to Sum
    createConnection(container, '65%', '70%', '80%', '70%', adderOutput.carry); // Gate to Carry
}

// Create Full-Adder visualization
function createFullAdderVisualization(container) {
    // Create FA gate
    const gate = document.createElement('div');
    gate.className = 'adder-gate full-adder-gate';
    gate.style.position = 'absolute';
    gate.style.left = '50%';
    gate.style.top = '50%';
    gate.style.transform = 'translate(-50%, -50%)';
    container.appendChild(gate);
    
    // Input A
    const inputA = document.createElement('div');
    inputA.className = `adder-input-node ${fullAdderInputs[0] ? 'active' : ''}`;
    inputA.textContent = 'A';
    inputA.style.left = '15%';
    inputA.style.top = '20%';
    inputA.addEventListener('click', () => toggleAdderInput(0, 'full-adder'));
    container.appendChild(inputA);
    
    // Input B
    const inputB = document.createElement('div');
    inputB.className = `adder-input-node ${fullAdderInputs[1] ? 'active' : ''}`;
    inputB.textContent = 'B';
    inputB.style.left = '15%';
    inputB.style.top = '50%';
    inputB.addEventListener('click', () => toggleAdderInput(1, 'full-adder'));
    container.appendChild(inputB);
    
    // Input Cin
    const inputCin = document.createElement('div');
    inputCin.className = `adder-input-node ${fullAdderInputs[2] ? 'active' : ''}`;
    inputCin.textContent = 'Cin';
    inputCin.style.left = '15%';
    inputCin.style.top = '80%';
    inputCin.addEventListener('click', () => toggleAdderInput(2, 'full-adder'));
    container.appendChild(inputCin);
    
    // Output Sum
    const outputSum = document.createElement('div');
    outputSum.className = `adder-output-node ${adderOutput.sum ? 'active' : ''}`;
    outputSum.textContent = 'S';
    outputSum.style.right = '15%';
    outputSum.style.top = '30%';
    container.appendChild(outputSum);
    
    // Output Carry
    const outputCarry = document.createElement('div');
    outputCarry.className = `adder-output-node ${adderOutput.carry ? 'active' : ''}`;
    outputCarry.textContent = 'Cout';
    outputCarry.style.right = '15%';
    outputCarry.style.top = '70%';
    container.appendChild(outputCarry);
    
    // Connection lines
    createConnection(container, '15%', '20%', '35%', '20%', fullAdderInputs[0]); // A to gate
    createConnection(container, '15%', '50%', '35%', '50%', fullAdderInputs[1]); // B to gate
    createConnection(container, '15%', '80%', '35%', '80%', fullAdderInputs[2]); // Cin to gate
    createConnection(container, '65%', '30%', '85%', '30%', adderOutput.sum); // Gate to Sum
    createConnection(container, '65%', '70%', '85%', '70%', adderOutput.carry); // Gate to Carry
}

// Create connection line
function createConnection(container, x1, y1, x2, y2, isActive) {
    const line = document.createElement('div');
    line.className = `adder-connection ${isActive ? 'active' : ''}`;
    
    const x1Num = parseFloat(x1);
    const y1Num = parseFloat(y1);
    const x2Num = parseFloat(x2);
    const y2Num = parseFloat(y2);
    
    // Calculate length and angle
    const length = Math.sqrt(Math.pow(x2Num - x1Num, 2) + Math.pow(y2Num - y1Num, 2));
    const angle = Math.atan2(y2Num - y1Num, x2Num - x1Num) * 180 / Math.PI;
    
    line.style.left = x1 + '%';
    line.style.top = y1 + '%';
    line.style.width = length + '%';
    line.style.transform = `rotate(${angle}deg)`;
    line.style.transformOrigin = '0 0';
    
    container.appendChild(line);
}

// Update adder truth table
function updateAdderTruthTable() {
    const table = document.getElementById('adder-truth-table');
    table.innerHTML = '';
    
    if (currentAdderType === 'half-adder') {
        // Half-Adder truth table header
        const header = document.createElement('tr');
        header.innerHTML = `
            <th>A</th>
            <th>B</th>
            <th>Sum</th>
            <th>Carry</th>
        `;
        table.appendChild(header);
        
        // Generate all combinations (4 rows)
        for (let a = 0; a <= 1; a++) {
            for (let b = 0; b <= 1; b++) {
                const sum = a ^ b;
                const carry = a & b;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="${a ? 'active' : 'inactive'}">${a}</td>
                    <td class="${b ? 'active' : 'inactive'}">${b}</td>
                    <td class="${sum ? 'active' : 'inactive'}">${sum}</td>
                    <td class="${carry ? 'active' : 'inactive'}">${carry}</td>
                `;
                
                // Highlight current combination
                if (a === adderInputs[0] && b === adderInputs[1]) {
                    row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
                    row.style.fontWeight = 'bold';
                }
                
                table.appendChild(row);
            }
        }
    } else {
        // Full-Adder truth table header
        const header = document.createElement('tr');
        header.innerHTML = `
            <th>A</th>
            <th>B</th>
            <th>Cin</th>
            <th>Sum</th>
            <th>Cout</th>
        `;
        table.appendChild(header);
        
        // Generate all combinations (8 rows)
        for (let a = 0; a <= 1; a++) {
            for (let b = 0; b <= 1; b++) {
                for (let cin = 0; cin <= 1; cin++) {
                    // Full-Adder calculation
                    const s1 = a ^ b;
                    const c1 = a & b;
                    const sum = s1 ^ cin;
                    const c2 = s1 & cin;
                    const carry = c1 | c2;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="${a ? 'active' : 'inactive'}">${a}</td>
                        <td class="${b ? 'active' : 'inactive'}">${b}</td>
                        <td class="${cin ? 'active' : 'inactive'}">${cin}</td>
                        <td class="${sum ? 'active' : 'inactive'}">${sum}</td>
                        <td class="${carry ? 'active' : 'inactive'}">${carry}</td>
                    `;
                    
                    // Highlight current combination
                    if (a === fullAdderInputs[0] && b === fullAdderInputs[1] && cin === fullAdderInputs[2]) {
                        row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
                        row.style.fontWeight = 'bold';
                    }
                    
                    table.appendChild(row);
                }
            }
        }
    }
}

// Show step-by-step calculation
function showAdderCalculationSteps() {
    const container = document.getElementById('adder-steps-container');
    container.innerHTML = '';
    
    if (currentAdderType === 'half-adder') {
        const a = adderInputs[0];
        const b = adderInputs[1];
        const sum = adderOutput.sum;
        const carry = adderOutput.carry;
        
        container.innerHTML = `
            <div class="adder-step active">
                <div class="calculation-title">Half-Adder Step-by-Step Calculation</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Input Values</strong></div>
                    <div>A = ${a}, B = ${b}</div>
                    
                    <div class="mt-2"><strong>Step 2: Sum Calculation (XOR Operation)</strong></div>
                    <div>Sum = A XOR B</div>
                    <div>${a} XOR ${b} = ${a ^ b}</div>
                    <div class="adder-operation">Sum = ${sum}</div>
                    
                    <div class="mt-2"><strong>Step 3: Carry Calculation (AND Operation)</strong></div>
                    <div>Carry = A AND B</div>
                    <div>${a} AND ${b} = ${a & b}</div>
                    <div class="adder-operation">Carry = ${carry}</div>
                    
                    <div class="mt-2"><strong>Step 4: Binary Addition</strong></div>
                    <div>${a} + ${b} = ${sum} (with carry ${carry})</div>
                    <div class="adder-result">Result: Sum=${sum}, Carry=${carry}</div>
                    
                    <div class="mt-2"><strong>Step 5: Verification</strong></div>
                    <div>${a} + ${b} = ${a + b} in decimal</div>
                    <div>Binary: ${sum}${carry} = ${carry}${sum} = ${parseInt(carry.toString() + sum.toString(), 2)} in decimal</div>
                    <div> Calculation verified</div>
                </div>
            </div>
        `;
    } else {
        const a = fullAdderInputs[0];
        const b = fullAdderInputs[1];
        const cin = fullAdderInputs[2];
        const sum = adderOutput.sum;
        const carry = adderOutput.carry;
        
        container.innerHTML = `
            <div class="adder-step active">
                <div class="calculation-title">Full-Adder Step-by-Step Calculation</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Input Values</strong></div>
                    <div>A = ${a}, B = ${b}, Cin = ${cin}</div>
                    
                    <div class="mt-2"><strong>Step 2: First Half-Adder (A and B)</strong></div>
                    <div>Sum1 = A XOR B</div>
                    <div>${a} XOR ${b} = ${a ^ b}</div>
                    <div>Carry1 = A AND B</div>
                    <div>${a} AND ${b} = ${a & b}</div>
                    <div class="adder-operation">Sum1 = ${a ^ b}, Carry1 = ${a & b}</div>
                    
                    <div class="mt-2"><strong>Step 3: Second Half-Adder (Sum1 and Cin)</strong></div>
                    <div>Sum = Sum1 XOR Cin</div>
                    <div>${a ^ b} XOR ${cin} = ${(a ^ b) ^ cin}</div>
                    <div>Carry2 = Sum1 AND Cin</div>
                    <div>${a ^ b} AND ${cin} = ${(a ^ b) & cin}</div>
                    <div class="adder-operation">Sum = ${sum}, Carry2 = ${(a ^ b) & cin}</div>
                    
                    <div class="mt-2"><strong>Step 4: Final Carry Calculation (OR Operation)</strong></div>
                    <div>Cout = Carry1 OR Carry2</div>
                    <div>${a & b} OR ${(a ^ b) & cin} = ${(a & b) | ((a ^ b) & cin)}</div>
                    <div class="adder-operation">Cout = ${carry}</div>
                    
                    <div class="mt-2"><strong>Step 5: Binary Addition</strong></div>
                    <div>${a} + ${b} + ${cin} = ${sum} (with carry ${carry})</div>
                    <div class="adder-result">Result: Sum=${sum}, Cout=${carry}</div>
                    
                    <div class="mt-2"><strong>Step 6: Verification</strong></div>
                    <div>${a} + ${b} + ${cin} = ${a + b + cin} in decimal</div>
                    <div>Binary: ${carry}${sum} = ${parseInt(carry.toString() + sum.toString(), 2)} in decimal</div>
                    <div> Calculation verified</div>
                </div>
            </div>
        `;
    }
}

// Update adder explanation
function updateAdderExplanation() {
    const explanationDiv = document.getElementById('adder-operation-explanation');
    const titleDiv = document.getElementById('adder-operation-title');
    
    if (currentAdderType === 'half-adder') {
        titleDiv.textContent = 'Half-Adder';
        explanationDiv.innerHTML = `
            <strong>Half-Adder:</strong><br>
             Adds two binary bits (A and B)<br>
             Produces Sum and Carry outputs<br>
             Sum = A XOR B<br>
             Carry = A AND B<br>
             Cannot handle carry-in from previous stage
        `;
    } else if (currentAdderType === 'full-adder') {
        titleDiv.textContent = 'Full-Adder';
        explanationDiv.innerHTML = `
            <strong>Full-Adder:</strong><br>
             Adds three binary bits (A, B, and Carry-in)<br>
             Produces Sum and Carry-out outputs<br>
             Can handle carry-in from previous stage<br>
             Implemented using two Half-Adders and an OR gate
        `;
    } else if (currentBinaryOperation === 'addition') {
        titleDiv.textContent = 'Binary Addition (Ripple Carry)';
        explanationDiv.innerHTML = `
            <strong>Binary Addition using Ripple Carry:</strong><br>
            1. Add bits from right to left (LSB to MSB)<br>
            2. Use Full-Adder for each bit position<br>
            3. Carry propagates from one stage to next<br>
            4. Supports signed numbers using 2's complement<br>
            5. Detects overflow when result exceeds bit range<br><br>
            
            <strong>Full-Adder Truth Table:</strong><br>
            A B Cin | Sum Cout<br>
            0 0 0  | 0   0<br>
            0 0 1  | 1   0<br>
            0 1 0  | 1   0<br>
            0 1 1  | 0   1<br>
            1 0 0  | 1   0<br>
            1 0 1  | 0   1<br>
            1 1 0  | 0   1<br>
            1 1 1  | 1   1
        `;
    } else if (currentBinaryOperation === 'subtraction') {
        titleDiv.textContent = 'Binary Subtraction (2\'s Complement)';
        explanationDiv.innerHTML = `
            <strong>Binary Subtraction using 2's Complement:</strong><br>
            1. Convert subtrahend to its 2's complement<br>
            2. Add minuend to 2's complement of subtrahend<br>
            3. Result is in 2's complement form<br>
            4. Overflow detection for signed numbers<br><br>
            
            <strong>2's Complement Process:</strong><br>
            1. Invert all bits (1's complement)<br>
            2. Add 1 to the result<br><br>
            
            <strong>Example: 7 - 5 (4-bit):</strong><br>
            7 (0111) - 5 (0101)<br>
            2's complement of 5: 1010 + 1 = 1011<br>
            Add: 0111 + 1011 = (1)0010 = 2 (ignore overflow)
        `;
    } else {
        titleDiv.textContent = 'Arithmetic Operations';
        explanationDiv.textContent = 'Select an operation type from the left panel to see its details and operation.';
    }
}
// Animate through adder truth table
function animateAdderTruthTable() {
    if (!currentAdderType && !currentSubtractorType) return;
    
    const table = document.getElementById('adder-truth-table');
    const rows = table.querySelectorAll('tr:not(:first-child)');
    const container = document.getElementById('adder-steps-container');
    
    if (isAdderAnimating) return;
    isAdderAnimating = true;
    
    // Disable animate button
    const animateBtn = document.getElementById('animate-adder-btn');
    animateBtn.disabled = true;
    animateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Animating...';
    
    container.innerHTML = '';
    
    // Clear previous highlights
    rows.forEach(row => {
        row.style.backgroundColor = '';
        row.style.fontWeight = '';
    });
    
    let step = 0;
    
    function animateRow() {
        if (step >= rows.length) {
            // Animation complete
            isAdderAnimating = false;
            animateBtn.disabled = false;
            animateBtn.innerHTML = '<i class="fas fa-play-circle me-1"></i>Animate Truth Table';
            
            // Show completion message
            const completionDiv = document.createElement('div');
            completionDiv.className = 'adder-step active';
            completionDiv.innerHTML = `
                <div class="calculation-title">Animation Complete</div>
                <div class="calculation-content">
                     Animated through all truth table rows<br>
                     ${rows.length} combinations tested<br>
                     ${currentAdderType ? 'Adder' : 'Subtractor'} logic verified
                </div>
            `;
            container.appendChild(completionDiv);
            
            return;
        }
        
        const row = rows[step];
        
        // Highlight current row
        row.style.backgroundColor = 'rgba(139, 69, 19, 0.2)';
        row.style.fontWeight = 'bold';
        
        // Create step explanation
        const stepDiv = document.createElement('div');
        stepDiv.className = 'adder-step';
        stepDiv.style.animation = 'slideIn 0.3s ease';
        
        const cells = row.querySelectorAll('td');
        let explanation = '';
        
        if (currentAdderType === 'half-adder') {
            explanation = `
                <strong>Step ${step + 1}:</strong> A=${cells[0].textContent}, B=${cells[1].textContent}<br>
                Sum = A XOR B = ${cells[0].textContent} XOR ${cells[1].textContent} = ${cells[2].textContent}<br>
                Carry = A AND B = ${cells[0].textContent} AND ${cells[1].textContent} = ${cells[3].textContent}
            `;
        } else if (currentAdderType === 'full-adder') {
            explanation = `
                <strong>Step ${step + 1}:</strong> A=${cells[0].textContent}, B=${cells[1].textContent}, Cin=${cells[2].textContent}<br>
                Sum = A XOR B XOR Cin = ${cells[0].textContent} XOR ${cells[1].textContent} XOR ${cells[2].textContent} = ${cells[3].textContent}<br>
                Carry = (A AND B) OR ((A XOR B) AND Cin) = ${cells[4].textContent}
            `;
        } else if (currentSubtractorType === 'half-subtractor') {
            explanation = `
                <strong>Step ${step + 1}:</strong> A=${cells[0].textContent}, B=${cells[1].textContent}<br>
                Difference = A XOR B = ${cells[0].textContent} XOR ${cells[1].textContent} = ${cells[2].textContent}<br>
                Borrow = (NOT A) AND B = (NOT ${cells[0].textContent}) AND ${cells[1].textContent} = ${cells[3].textContent}
            `;
        } else if (currentSubtractorType === 'full-subtractor') {
            explanation = `
                <strong>Step ${step + 1}:</strong> A=${cells[0].textContent}, B=${cells[1].textContent}, Bin=${cells[2].textContent}<br>
                Difference = A XOR B XOR Bin = ${cells[0].textContent} XOR ${cells[1].textContent} XOR ${cells[2].textContent} = ${cells[3].textContent}<br>
                Borrow = ((NOT A) AND B) OR ((NOT (A XOR B)) AND Bin) = ${cells[4].textContent}
            `;
        }
        
        stepDiv.innerHTML = `
            <div class="calculation-title">Truth Table Animation - Step ${step + 1} of ${rows.length}</div>
            <div class="calculation-content">
                ${explanation}
            </div>
        `;
        
        container.appendChild(stepDiv);
        stepDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        step++;
        
        // Continue to next row after delay
        setTimeout(animateRow, 1500);
    }
    
    // Start animation
    animateRow();
    
    addLog(`Started truth table animation for ${currentAdderType || currentSubtractorType}`, 'info');
}
// Reset adder
function resetAdder() {
    if (currentAdderType === 'half-adder') {
        adderInputs = [0, 0];
        
        // Reset toggle switches
        document.getElementById('ha-input-a').checked = false;
        document.getElementById('ha-input-b').checked = false;
        document.querySelectorAll('#half-adder-inputs .toggle-switch + span').forEach(span => {
            span.textContent = '0 (OFF)';
        });
    } else {
        fullAdderInputs = [0, 0, 0];
        
        // Reset toggle switches
        document.getElementById('fa-input-a').checked = false;
        document.getElementById('fa-input-b').checked = false;
        document.getElementById('fa-input-cin').checked = false;
        document.querySelectorAll('#full-adder-inputs .toggle-switch + span').forEach(span => {
            span.textContent = '0 (OFF)';
        });
    }
    
    adderOutput = { sum: 0, carry: 0 };
    document.getElementById('adder-result').textContent = 'Sum: 0, Carry: 0';
    
    updateAdderVisualization();
    updateAdderTruthTable();
    
    // Clear calculation steps
    document.getElementById('adder-steps-container').innerHTML = '';
    
    addLog('Reset adder inputs and outputs', 'info');
}
// Subtractors Logic Functions
function selectSubtractorType(type) {
    currentSubtractorType = type;
    currentAdderType = null; // Reset adder type
    
    // Show inputs section
    document.getElementById('adder-inputs').style.display = 'block';
    
    // Reset inputs
    if (type === 'half-subtractor') {
        halfSubtractorInputs = [0, 0];
        
        // Show half-subtractor inputs, hide others
        document.getElementById('half-subtractor-inputs').style.display = 'block';
        document.getElementById('full-subtractor-inputs').style.display = 'none';
        document.getElementById('half-adder-inputs').style.display = 'none';
        document.getElementById('full-adder-inputs').style.display = 'none';
        
        // Update title and description
        document.getElementById('adder-title').textContent = 'Half-Subtractor Inputs';
        document.getElementById('adder-description').innerHTML = `
            <strong>Half-Subtractor:</strong><br>
             Subtracts two binary bits (A - B)<br>
             Produces Difference and Borrow outputs<br>
             Difference = A XOR B<br>
             Borrow = (NOT A) AND B<br>
             Cannot handle borrow-in from previous stage
        `;
        
    } else { // full-subtractor
        fullSubtractorInputs = [0, 0, 0];
        
        // Show full-subtractor inputs, hide others
        document.getElementById('half-subtractor-inputs').style.display = 'none';
        document.getElementById('full-subtractor-inputs').style.display = 'block';
        document.getElementById('half-adder-inputs').style.display = 'none';
        document.getElementById('full-adder-inputs').style.display = 'none';
        
        // Update title and description
        document.getElementById('adder-title').textContent = 'Full-Subtractor Inputs';
        document.getElementById('adder-description').innerHTML = `
            <strong>Full-Subtractor:</strong><br>
             Subtracts three binary bits (A - B - Bin)<br>
             Produces Difference and Borrow-out outputs<br>
             Can handle borrow-in from previous stage<br>
             Difference = A XOR B XOR Bin<br>
             Borrow-out = ((NOT A) AND B) OR ((NOT (A XOR B)) AND Bin)
        `;
    }
    
    // Show visualization and truth table
    document.getElementById('adder-visualization').style.display = 'block';
    document.getElementById('adder-truth-table-container').style.display = 'block';
    document.getElementById('adder-calculation-steps').style.display = 'block';
    
    // Reset calculation steps
    document.getElementById('adder-steps-container').innerHTML = '';
    
    // Reset outputs
    subtractorOutput = { difference: 0, borrow: 0 };
    document.getElementById('adder-result').textContent = 'Difference: 0, Borrow: 0';
    
    // Generate initial visualization and truth table
    updateSubtractorVisualization();
    updateSubtractorTruthTable();
    
    // Update explanation
    updateSubtractorExplanation();
    
    addLog(`Selected ${type === 'half-subtractor' ? 'Half-Subtractor' : 'Full-Subtractor'}`, 'info');
}

function toggleSubtractorInput(index, type) {
    if (type === 'half-subtractor') {
        halfSubtractorInputs[index] = halfSubtractorInputs[index] ? 0 : 1;
        
        // Update toggle label
        const toggleId = index === 0 ? 'hs-input-a' : 'hs-input-b';
        const toggleInput = document.getElementById(toggleId);
        const toggleLabel = toggleInput.parentElement.parentElement.querySelector('span:last-child');
        toggleLabel.textContent = halfSubtractorInputs[index] ? '1 (ON)' : '0 (OFF)';
    } else {
        fullSubtractorInputs[index] = fullSubtractorInputs[index] ? 0 : 1;
        
        // Update toggle label
        let toggleId;
        if (index === 0) toggleId = 'fs-input-a';
        else if (index === 1) toggleId = 'fs-input-b';
        else toggleId = 'fs-input-bin';
        
        const toggleInput = document.getElementById(toggleId);
        const toggleLabel = toggleInput.parentElement.parentElement.querySelector('span:last-child');
        toggleLabel.textContent = fullSubtractorInputs[index] ? '1 (ON)' : '0 (OFF)';
    }
    
    // Recalculate
    calculateSubtractor();
}

function calculateSubtractor() {
    if (!currentSubtractorType) return;
    
    let difference, borrow;
    
    if (currentSubtractorType === 'half-subtractor') {
        // Half-Subtractor: Difference = A XOR B, Borrow = (NOT A) AND B
        difference = halfSubtractorInputs[0] ^ halfSubtractorInputs[1];
        borrow = (!halfSubtractorInputs[0]) && halfSubtractorInputs[1];
    } else {
        // Full-Subtractor: implemented using Python logic
        const a = fullSubtractorInputs[0];
        const b = fullSubtractorInputs[1];
        const bin_ = fullSubtractorInputs[2];
        
        // Difference = A XOR B XOR Bin
        difference = a ^ b ^ bin_;
        
        // Borrow-out = ((NOT A) AND B) OR ((NOT (A XOR B)) AND Bin)
        const notA = !a;
        const aXorB = a ^ b;
        const notAXorB = !aXorB;
        
        borrow = (notA && b) || (notAXorB && bin_);
    }
    
    subtractorOutput = { difference, borrow };
    
    // Update result display
    document.getElementById('adder-result').textContent = `Difference: ${difference}, Borrow: ${borrow ? 1 : 0}`;
    
    // Update visualization
    updateSubtractorVisualization();
    
    // Update truth table highlighting
    updateSubtractorTruthTable();
    
    // Show step-by-step calculation
    showSubtractorCalculationSteps();
    
    addLog(`Calculated ${currentSubtractorType === 'half-subtractor' ? 'Half-Subtractor' : 'Full-Subtractor'}: Difference=${difference}, Borrow=${borrow ? 1 : 0}`, 'success');
}

function updateSubtractorVisualization() {
    const visualization = document.getElementById('adder-gate-visualization');
    visualization.innerHTML = '';
    
    if (currentSubtractorType === 'half-subtractor') {
        createHalfSubtractorVisualization(visualization);
    } else {
        createFullSubtractorVisualization(visualization);
    }
}

function createHalfSubtractorVisualization(container) {
    // Create HS gate
    const gate = document.createElement('div');
    gate.className = 'adder-gate';
    gate.textContent = 'HS';
    gate.style.position = 'absolute';
    gate.style.left = '50%';
    gate.style.top = '50%';
    gate.style.transform = 'translate(-50%, -50%)';
    container.appendChild(gate);
    
    // Input A
    const inputA = document.createElement('div');
    inputA.className = `adder-input-node ${halfSubtractorInputs[0] ? 'active' : ''}`;
    inputA.textContent = 'A';
    inputA.style.left = '20%';
    inputA.style.top = '30%';
    inputA.addEventListener('click', () => toggleSubtractorInput(0, 'half-subtractor'));
    container.appendChild(inputA);
    
    // Input B
    const inputB = document.createElement('div');
    inputB.className = `adder-input-node ${halfSubtractorInputs[1] ? 'active' : ''}`;
    inputB.textContent = 'B';
    inputB.style.left = '20%';
    inputB.style.top = '70%';
    inputB.addEventListener('click', () => toggleSubtractorInput(1, 'half-subtractor'));
    container.appendChild(inputB);
    
    // Output Difference
    const outputDiff = document.createElement('div');
    outputDiff.className = `adder-output-node ${subtractorOutput.difference ? 'active' : ''}`;
    outputDiff.textContent = 'D';
    outputDiff.style.right = '20%';
    outputDiff.style.top = '30%';
    container.appendChild(outputDiff);
    
    // Output Borrow
    const outputBorrow = document.createElement('div');
    outputBorrow.className = `adder-output-node ${subtractorOutput.borrow ? 'active' : ''}`;
    outputBorrow.textContent = 'B';
    outputBorrow.style.right = '20%';
    outputBorrow.style.top = '70%';
    container.appendChild(outputBorrow);
    
    // Connection lines
    createConnection(container, '20%', '30%', '35%', '30%', halfSubtractorInputs[0]); // A to gate
    createConnection(container, '20%', '70%', '35%', '70%', halfSubtractorInputs[1]); // B to gate
    createConnection(container, '65%', '30%', '80%', '30%', subtractorOutput.difference); // Gate to Diff
    createConnection(container, '65%', '70%', '80%', '70%', subtractorOutput.borrow); // Gate to Borrow
}

function createFullSubtractorVisualization(container) {
    // Create FS gate
    const gate = document.createElement('div');
    gate.className = 'adder-gate';
    gate.textContent = 'FS';
    gate.style.position = 'absolute';
    gate.style.left = '50%';
    gate.style.top = '50%';
    gate.style.transform = 'translate(-50%, -50%)';
    container.appendChild(gate);
    
    // Input A
    const inputA = document.createElement('div');
    inputA.className = `adder-input-node ${fullSubtractorInputs[0] ? 'active' : ''}`;
    inputA.textContent = 'A';
    inputA.style.left = '15%';
    inputA.style.top = '20%';
    inputA.addEventListener('click', () => toggleSubtractorInput(0, 'full-subtractor'));
    container.appendChild(inputA);
    
    // Input B
    const inputB = document.createElement('div');
    inputB.className = `adder-input-node ${fullSubtractorInputs[1] ? 'active' : ''}`;
    inputB.textContent = 'B';
    inputB.style.left = '15%';
    inputB.style.top = '50%';
    inputB.addEventListener('click', () => toggleSubtractorInput(1, 'full-subtractor'));
    container.appendChild(inputB);
    
    // Input Bin
    const inputBin = document.createElement('div');
    inputBin.className = `adder-input-node ${fullSubtractorInputs[2] ? 'active' : ''}`;
    inputBin.textContent = 'Bin';
    inputBin.style.left = '15%';
    inputBin.style.top = '80%';
    inputBin.addEventListener('click', () => toggleSubtractorInput(2, 'full-subtractor'));
    container.appendChild(inputBin);
    
    // Output Difference
    const outputDiff = document.createElement('div');
    outputDiff.className = `adder-output-node ${subtractorOutput.difference ? 'active' : ''}`;
    outputDiff.textContent = 'D';
    outputDiff.style.right = '15%';
    outputDiff.style.top = '30%';
    container.appendChild(outputDiff);
    
    // Output Borrow
    const outputBorrow = document.createElement('div');
    outputBorrow.className = `adder-output-node ${subtractorOutput.borrow ? 'active' : ''}`;
    outputBorrow.textContent = 'Bout';
    outputBorrow.style.right = '15%';
    outputBorrow.style.top = '70%';
    container.appendChild(outputBorrow);
    
    // Connection lines
    createConnection(container, '15%', '20%', '35%', '20%', fullSubtractorInputs[0]); // A to gate
    createConnection(container, '15%', '50%', '35%', '50%', fullSubtractorInputs[1]); // B to gate
    createConnection(container, '15%', '80%', '35%', '80%', fullSubtractorInputs[2]); // Bin to gate
    createConnection(container, '65%', '30%', '85%', '30%', subtractorOutput.difference); // Gate to Diff
    createConnection(container, '65%', '70%', '85%', '70%', subtractorOutput.borrow); // Gate to Borrow
}

function updateSubtractorTruthTable() {
    const table = document.getElementById('adder-truth-table');
    table.innerHTML = '';
    
    if (currentSubtractorType === 'half-subtractor') {
        // Half-Subtractor truth table header
        const header = document.createElement('tr');
        header.innerHTML = `
            <th>A</th>
            <th>B</th>
            <th>Difference</th>
            <th>Borrow</th>
        `;
        table.appendChild(header);
        
        // Generate all combinations (4 rows)
        for (let a = 0; a <= 1; a++) {
            for (let b = 0; b <= 1; b++) {
                // Half-Subtractor logic
                const difference = a ^ b;
                const borrow = (!a) && b;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="${a ? 'active' : 'inactive'}">${a}</td>
                    <td class="${b ? 'active' : 'inactive'}">${b}</td>
                    <td class="${difference ? 'active' : 'inactive'}">${difference}</td>
                    <td class="${borrow ? 'active' : 'inactive'}">${borrow ? 1 : 0}</td>
                `;
                
                // Highlight current combination
                if (a === halfSubtractorInputs[0] && b === halfSubtractorInputs[1]) {
                    row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
                    row.style.fontWeight = 'bold';
                }
                
                table.appendChild(row);
            }
        }
    } else {
        // Full-Subtractor truth table header
        const header = document.createElement('tr');
        header.innerHTML = `
            <th>A</th>
            <th>B</th>
            <th>Bin</th>
            <th>Difference</th>
            <th>Bout</th>
        `;
        table.appendChild(header);
        
        // Generate all combinations (8 rows)
        for (let a = 0; a <= 1; a++) {
            for (let b = 0; b <= 1; b++) {
                for (let bin_ = 0; bin_ <= 1; bin_++) {
                    // Full-Subtractor logic from Python code
                    const difference = a ^ b ^ bin_;
                    const notA = !a;
                    const aXorB = a ^ b;
                    const notAXorB = !aXorB;
                    const borrow = (notA && b) || (notAXorB && bin_);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="${a ? 'active' : 'inactive'}">${a}</td>
                        <td class="${b ? 'active' : 'inactive'}">${b}</td>
                        <td class="${bin_ ? 'active' : 'inactive'}">${bin_}</td>
                        <td class="${difference ? 'active' : 'inactive'}">${difference}</td>
                        <td class="${borrow ? 'active' : 'inactive'}">${borrow ? 1 : 0}</td>
                    `;
                    
                    // Highlight current combination
                    if (a === fullSubtractorInputs[0] && b === fullSubtractorInputs[1] && bin_ === fullSubtractorInputs[2]) {
                        row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
                        row.style.fontWeight = 'bold';
                    }
                    
                    table.appendChild(row);
                }
            }
        }
    }
}

function showSubtractorCalculationSteps() {
    const container = document.getElementById('adder-steps-container');
    container.innerHTML = '';
    
    if (currentSubtractorType === 'half-subtractor') {
        const a = halfSubtractorInputs[0];
        const b = halfSubtractorInputs[1];
        const difference = subtractorOutput.difference;
        const borrow = subtractorOutput.borrow;
        
        container.innerHTML = `
            <div class="adder-step active">
                <div class="calculation-title">Half-Subtractor Step-by-Step Calculation</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Input Values</strong></div>
                    <div>A = ${a}, B = ${b}</div>
                    
                    <div class="mt-2"><strong>Step 2: Difference Calculation (XOR Operation)</strong></div>
                    <div>Difference = A XOR B</div>
                    <div>${a} XOR ${b} = ${a ^ b}</div>
                    <div class="adder-operation">Difference = ${difference}</div>
                    
                    <div class="mt-2"><strong>Step 3: Borrow Calculation</strong></div>
                    <div>Borrow = (NOT A) AND B</div>
                    <div>NOT ${a} = ${!a ? 1 : 0}</div>
                    <div>${!a ? 1 : 0} AND ${b} = ${(!a && b) ? 1 : 0}</div>
                    <div class="adder-operation">Borrow = ${borrow ? 1 : 0}</div>
                    
                    <div class="mt-2"><strong>Step 4: Interpretation</strong></div>
                    <div>${a} - ${b} = ${difference} with borrow ${borrow ? 1 : 0}</div>
                </div>
            </div>
        `;
    } else {
        const a = fullSubtractorInputs[0];
        const b = fullSubtractorInputs[1];
        const bin_ = fullSubtractorInputs[2];
        const difference = subtractorOutput.difference;
        const borrow = subtractorOutput.borrow;
        
        container.innerHTML = `
            <div class="adder-step active">
                <div class="calculation-title">Full-Subtractor Step-by-Step Calculation</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Input Values</strong></div>
                    <div>A = ${a}, B = ${b}, Borrow-in = ${bin_}</div>
                    
                    <div class="mt-2"><strong>Step 2: Difference Calculation</strong></div>
                    <div>Difference = A XOR B XOR Bin</div>
                    <div>First: A XOR B = ${a} XOR ${b} = ${a ^ b}</div>
                    <div>Then: (A XOR B) XOR Bin = ${a ^ b} XOR ${bin_} = ${a ^ b ^ bin_}</div>
                    <div class="adder-operation">Difference = ${difference}</div>
                    
                    <div class="mt-2"><strong>Step 3: Borrow-out Calculation</strong></div>
                    <div>Bout = ((NOT A) AND B) OR ((NOT (A XOR B)) AND Bin)</div>
                    <div>Part 1: NOT A = NOT ${a} = ${!a ? 1 : 0}</div>
                    <div>       (NOT A) AND B = ${!a ? 1 : 0} AND ${b} = ${(!a && b) ? 1 : 0}</div>
                    <div>Part 2: A XOR B = ${a} XOR ${b} = ${a ^ b}</div>
                    <div>       NOT (A XOR B) = NOT ${a ^ b} = ${!(a ^ b) ? 1 : 0}</div>
                    <div>       (NOT (A XOR B)) AND Bin = ${!(a ^ b) ? 1 : 0} AND ${bin_} = ${(!(a ^ b) && bin_) ? 1 : 0}</div>
                    <div>Part 3: Combine with OR: ${(!a && b) ? 1 : 0} OR ${(!(a ^ b) && bin_) ? 1 : 0} = ${borrow ? 1 : 0}</div>
                    <div class="adder-operation">Borrow-out = ${borrow ? 1 : 0}</div>
                    
                    <div class="mt-2"><strong>Step 4: Interpretation</strong></div>
                    <div>${a} - ${b} - ${bin_} = ${difference} with borrow-out ${borrow ? 1 : 0}</div>
                </div>
            </div>
        `;
    }
}

function updateSubtractorExplanation() {
    const explanation = document.getElementById('adder-operation-explanation');
    
    if (currentSubtractorType === 'half-subtractor') {
        explanation.innerHTML = `
            <strong>Half-Subtractor Operation:</strong><br>
            1. <strong>Difference:</strong> A XOR B (1 if inputs are different)<br>
            2. <strong>Borrow:</strong> (NOT A) AND B (1 when A=0 and B=1)<br>
            3. Used for subtracting two single-bit binary numbers<br>
            4. Cannot handle borrow from previous stage
        `;
    } else {
        explanation.innerHTML = `
            <strong>Full-Subtractor Operation:</strong><br>
            1. <strong>Difference:</strong> A XOR B XOR Bin<br>
            2. <strong>Borrow-out:</strong> ((NOT A) AND B) OR ((NOT (A XOR B)) AND Bin)<br>
            3. Can handle borrow-in from previous stage<br>
            4. Used in multi-bit binary subtraction circuits
        `;
    }
}
// Binary Operations Functions
function selectBinaryOperation(operation) {
    currentBinaryOperation = operation;
    currentAdderType = null;
    
    // Hide adder-specific sections
    document.getElementById('adder-inputs').style.display = 'none';
    document.getElementById('adder-visualization').style.display = 'none';
    document.getElementById('adder-truth-table-container').style.display = 'none';
    document.getElementById('adder-calculation-steps').style.display = 'block';
    
    // Show binary operation interface
    showBinaryOperationInterface();
    
    // Update explanation
    updateBinaryOperationExplanation();
    
    addLog(`Selected binary ${operation} operation`, 'info');
}

function showBinaryOperationInterface() {
    const stepsContainer = document.getElementById('adder-steps-container');
    
    stepsContainer.innerHTML = `
        <div class="binary-input-section">
            <h4 class="text-center mb-4">${currentBinaryOperation === 'addition' ? 'Binary Addition' : 'Binary Subtraction'}</h4>
            
            <div class="binary-operation-controls">
                <div>
                    <label class="input-label">Bit Length:</label>
                    <select id="binary-bit-select" class="binary-bit-select">
                        <option value="4">4-bit</option>
                        <option value="8" selected>8-bit</option>
                        <option value="16">16-bit</option>
                        <option value="32">32-bit</option>
                    </select>
                </div>
                <div>
                    <button class="btn-glow btn-sm" id="calculate-binary-btn">
                        <i class="fas fa-calculator me-1"></i>Calculate
                    </button>
                    <button class="btn-glow btn-sm" id="clear-binary-btn">
                        <i class="fas fa-redo me-1"></i>Clear
                    </button>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="binary-input-group">
                        <label class="binary-input-label">Binary Number 1:</label>
                        <input type="text" id="binary-number1" class="binary-input-box" 
                               placeholder="Enter binary number (e.g., 1011)" maxlength="32">
                        <small class="text-muted mt-1 d-block">Enter only 0s and 1s (up to ${binaryBits} bits)</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="binary-input-group">
                        <label class="binary-input-label">Binary Number 2:</label>
                        <input type="text" id="binary-number2" class="binary-input-box" 
                               placeholder="Enter binary number (e.g., 1101)" maxlength="32">
                        <small class="text-muted mt-1 d-block">Enter only 0s and 1s (up to ${binaryBits} bits)</small>
                    </div>
                </div>
            </div>
            
            <div id="binary-error" class="mt-3" style="display: none;">
                <!-- Error messages will appear here -->
            </div>
        </div>
        
        <div id="binary-results-section" class="mt-4" style="display: none;">
            <!-- Results will be shown here -->
        </div>
    `;
    
    // Add event listeners
    document.getElementById('binary-bit-select').addEventListener('change', function() {
        binaryBits = parseInt(this.value);
        addLog(`Set bit length to ${binaryBits}`, 'info');
    });
    
    document.getElementById('calculate-binary-btn').addEventListener('click', function() {
        calculateBinaryOperation();
    });
    
    document.getElementById('clear-binary-btn').addEventListener('click', function() {
        clearBinaryOperation();
    });
    
    // Set initial bit length
    binaryBits = parseInt(document.getElementById('binary-bit-select').value);
}

function updateBinaryOperationExplanation() {
    const explanationDiv = document.getElementById('adder-operation-explanation');
    const titleDiv = document.getElementById('adder-operation-title');
    
    if (currentBinaryOperation === 'addition') {
        titleDiv.textContent = 'Binary Addition (Ripple Carry)';
        explanationDiv.innerHTML = `
            <strong>Binary Addition using Ripple Carry:</strong><br>
            1. Add bits from right to left (LSB to MSB)<br>
            2. Use Full-Adder for each bit position<br>
            3. Carry propagates from one stage to next<br>
            4. Supports signed numbers using 2's complement<br>
            5. Detects overflow when result exceeds bit range<br><br>
            
            <strong>Full-Adder Truth Table:</strong><br>
            A B Cin | Sum Cout<br>
            0 0 0  | 0   0<br>
            0 0 1  | 1   0<br>
            0 1 0  | 1   0<br>
            0 1 1  | 0   1<br>
            1 0 0  | 1   0<br>
            1 0 1  | 0   1<br>
            1 1 0  | 0   1<br>
            1 1 1  | 1   1
        `;
    } else {
        titleDiv.textContent = 'Binary Subtraction (2\'s Complement)';
        explanationDiv.innerHTML = `
            <strong>Binary Subtraction using 2's Complement:</strong><br>
            1. Convert subtrahend to its 2's complement<br>
            2. Add minuend to 2's complement of subtrahend<br>
            3. Result is in 2's complement form<br>
            4. Overflow detection for signed numbers<br><br>
            
            <strong>2's Complement Process:</strong><br>
            1. Invert all bits (1's complement)<br>
            2. Add 1 to the result<br><br>
            
            <strong>Example: 7 - 5 (4-bit):</strong><br>
            7 (0111) - 5 (0101)<br>
            2's complement of 5: 1010 + 1 = 1011<br>
            Add: 0111 + 1011 = (1)0010 = 2 (ignore overflow)
        `;
    }
}

function calculateBinaryOperation() {
    // Get input values
    binaryNumber1 = document.getElementById('binary-number1').value.trim();
    binaryNumber2 = document.getElementById('binary-number2').value.trim();
    
    // Clear previous errors
    const errorDiv = document.getElementById('binary-error');
    errorDiv.style.display = 'none';
    errorDiv.innerHTML = '';
    
    // Remove error classes
    document.getElementById('binary-number1').classList.remove('error');
    document.getElementById('binary-number2').classList.remove('error');
    
    // Validate inputs
    let isValid = true;
    let errorMessage = '';
    
    if (!binaryNumber1) {
        errorMessage += '<div>Please enter Binary Number 1</div>';
        document.getElementById('binary-number1').classList.add('error');
        isValid = false;
    }
    
    if (!binaryNumber2) {
        errorMessage += '<div>Please enter Binary Number 2</div>';
        document.getElementById('binary-number2').classList.add('error');
        isValid = false;
    }
    
    // Check if inputs contain only 0 and 1
    const binaryRegex = /^[01]+$/;
    if (binaryNumber1 && !binaryRegex.test(binaryNumber1)) {
        errorMessage += '<div>Binary Number 1 contains invalid characters (only 0 and 1 allowed)</div>';
        document.getElementById('binary-number1').classList.add('error');
        isValid = false;
    }
    
    if (binaryNumber2 && !binaryRegex.test(binaryNumber2)) {
        errorMessage += '<div>Binary Number 2 contains invalid characters (only 0 and 1 allowed)</div>';
        document.getElementById('binary-number2').classList.add('error');
        isValid = false;
    }
    
    // Check if inputs exceed bit length
    if (binaryNumber1 && binaryNumber1.length > binaryBits) {
        errorMessage += `<div>Binary Number 1 exceeds ${binaryBits}-bit limit (${binaryNumber1.length} bits entered)</div>`;
        document.getElementById('binary-number1').classList.add('error');
        isValid = false;
    }
    
    if (binaryNumber2 && binaryNumber2.length > binaryBits) {
        errorMessage += `<div>Binary Number 2 exceeds ${binaryBits}-bit limit (${binaryNumber2.length} bits entered)</div>`;
        document.getElementById('binary-number2').classList.add('error');
        isValid = false;
    }
    
    if (!isValid) {
        errorDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Input Validation Failed:</strong>
                ${errorMessage}
            </div>
        `;
        errorDiv.style.display = 'block';
        return;
    }
    
    // Pad numbers to bit length
    const paddedNum1 = binaryNumber1.padStart(binaryBits, binaryNumber1[0] === '1' && binaryNumber1.length < binaryBits ? '1' : '0');
    const paddedNum2 = binaryNumber2.padStart(binaryBits, binaryNumber2[0] === '1' && binaryNumber2.length < binaryBits ? '1' : '0');
    
    // Convert to decimal (treat as 2's complement)
    const dec1 = binaryToDecimal(paddedNum1, binaryBits);
    const dec2 = binaryToDecimal(paddedNum2, binaryBits);
    
    // Perform operation
    if (currentBinaryOperation === 'addition') {
        performBinaryAddition(paddedNum1, paddedNum2, dec1, dec2);
    } else {
        performBinarySubtraction(paddedNum1, paddedNum2, dec1, dec2);
    }
}

function binaryToDecimal(binaryStr, bits) {
    // Convert 2's complement binary to decimal
    if (binaryStr[0] === '0') {
        // Positive number
        return parseInt(binaryStr, 2);
    } else {
        // Negative number (2's complement)
        // Invert bits
        let inverted = '';
        for (let i = 0; i < bits; i++) {
            inverted += binaryStr[i] === '0' ? '1' : '0';
        }
        
        // Add 1
        let result = parseInt(inverted, 2) + 1;
        return -result;
    }
}

function decimalToBinary(decimal, bits) {
    if (decimal >= 0) {
        return decimal.toString(2).padStart(bits, '0');
    } else {
        // For negative numbers, calculate 2's complement
        let positive = (-decimal).toString(2).padStart(bits, '0');
        
        // Invert bits
        let inverted = '';
        for (let i = 0; i < bits; i++) {
            inverted += positive[i] === '0' ? '1' : '0';
        }
        
        // Add 1
        let result = (parseInt(inverted, 2) + 1).toString(2).padStart(bits, '0');
        return result;
    }
}

function performBinaryAddition(bin1, bin2, dec1, dec2) {
    const steps = [];
    let result = '';
    let carry = 0;
    let carries = [];
    
    steps.push(`<div class="binary-operation-step active"><strong>Step 1: Input Analysis</strong><br>
        Binary 1: <span class="binary-bit ${bin1[0] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${bin1}</span> (Decimal: ${dec1})<br>
        Binary 2: <span class="binary-bit ${bin2[0] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${bin2}</span> (Decimal: ${dec2})<br>
        Operation: ${dec1} + ${dec2} = ${dec1 + dec2}<br>
        Bit Length: ${binaryBits} bits</div>`);
    
    steps.push(`<div class="binary-operation-step"><strong>Step 2: Ripple Carry Addition Process</strong><br>
        Adding from LSB (right) to MSB (left):</div>`);
    
    // Create table for step-by-step addition
    let tableHTML = `<table class="binary-table">
        <thead>
            <tr>
                <th>Bit Position</th>`;
    
    for (let i = binaryBits - 1; i >= 0; i--) {
        tableHTML += `<th>${i}</th>`;
    }
    tableHTML += `</tr>
            <tr>
                <th>Binary 1</th>`;
    
    for (let i = 0; i < binaryBits; i++) {
        tableHTML += `<td class="binary-bit ${bin1[i] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${bin1[i]}</td>`;
    }
    tableHTML += `</tr>
            <tr>
                <th>Binary 2</th>`;
    
    for (let i = 0; i < binaryBits; i++) {
        tableHTML += `<td class="binary-bit ${bin2[i] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${bin2[i]}</td>`;
    }
    tableHTML += `</tr>
            <tr>
                <th>Carry In</th>`;
    
    // Add from LSB to MSB
    let resultBits = [];
    carries.push(0); // Initial carry in
    
    for (let i = binaryBits - 1; i >= 0; i--) {
        const bit1 = parseInt(bin1[i]);
        const bit2 = parseInt(bin2[i]);
        
        // Full adder logic
        const sum = bit1 ^ bit2 ^ carry;
        const carryOut = (bit1 & bit2) | ((bit1 ^ bit2) & carry);
        
        tableHTML += `<td class="binary-carry">${carry}</td>`;
        
        resultBits.unshift(sum.toString());
        carries.unshift(carryOut);
        carry = carryOut;
    }
    
    tableHTML += `</tr>
            <tr>
                <th>Sum</th>`;
    
    for (let i = 0; i < binaryBits; i++) {
        tableHTML += `<td class="binary-bit ${resultBits[i] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${resultBits[i]}</td>`;
    }
    tableHTML += `</tr>
            <tr>
                <th>Carry Out</th>`;
    
    for (let i = 0; i < binaryBits; i++) {
        tableHTML += `<td class="binary-carry">${carries[i+1]}</td>`;
    }
    tableHTML += `<td class="binary-carry">${carry}</td></tr></table>`;
    
    steps.push(`<div class="binary-operation-step">${tableHTML}</div>`);
    
    result = resultBits.join('');
    const finalCarry = carry;
    const resultDecimal = binaryToDecimal(result, binaryBits);
    
    steps.push(`<div class="binary-operation-step active"><strong>Step 3: Final Result</strong><br>
        Binary Result: <span class="binary-bit ${result[0] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${result}</span><br>
        Decimal Result: ${resultDecimal}<br>
        Final Carry: ${finalCarry}</div>`);
    
    // Check for overflow
    const overflow = checkOverflow(dec1, dec2, resultDecimal, binaryBits);
    
    if (overflow) {
        steps.push(`<div class="binary-operation-step error"><strong>Step 4: Overflow Detection</strong><br>
             OVERFLOW DETECTED!<br>
            The result ${resultDecimal} exceeds the ${binaryBits}-bit signed range.<br>
            Maximum positive: ${(1 << (binaryBits - 1)) - 1}<br>
            Minimum negative: ${-(1 << (binaryBits - 1))}</div>`);
    } else {
        steps.push(`<div class="binary-operation-step"><strong>Step 4: Verification</strong><br>
             No overflow detected<br>
             Result within ${binaryBits}-bit signed range<br>
             Calculation verified: ${dec1} + ${dec2} = ${resultDecimal}</div>`);
    }
    
    displayBinaryResults(steps, result, resultDecimal, finalCarry, overflow);
}

function performBinarySubtraction(bin1, bin2, dec1, dec2) {
    const steps = [];
    
    steps.push(`<div class="binary-operation-step active"><strong>Step 1: Input Analysis</strong><br>
        Minuend (Binary 1): <span class="binary-bit ${bin1[0] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${bin1}</span> (Decimal: ${dec1})<br>
        Subtrahend (Binary 2): <span class="binary-bit ${bin2[0] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${bin2}</span> (Decimal: ${dec2})<br>
        Operation: ${dec1} - ${dec2} = ${dec1 - dec2}<br>
        Bit Length: ${binaryBits} bits</div>`);
    
    steps.push(`<div class="binary-operation-step"><strong>Step 2: Convert Subtrahend to 2's Complement</strong><br>
        Original: ${bin2}</div>`);
    
    // Calculate 2's complement
    let onesComplement = '';
    for (let i = 0; i < binaryBits; i++) {
        onesComplement += bin2[i] === '0' ? '1' : '0';
    }
    
    steps.push(`<div class="binary-operation-step">
        <strong>Step 2a: 1's Complement (invert bits)</strong><br>
        ${bin2}  ${onesComplement}</div>`);
    
    // Add 1 to get 2's complement
    let twosComplement = '';
    let addCarry = 1;
    let addSteps = [];
    
    for (let i = binaryBits - 1; i >= 0; i--) {
        const bit = parseInt(onesComplement[i]);
        const sum = bit + addCarry;
        twosComplement = (sum % 2) + twosComplement;
        addCarry = Math.floor(sum / 2);
        addSteps.unshift(`Bit ${i}: ${bit} + ${addCarry} = ${sum % 2} (carry ${Math.floor(sum / 2)})`);
    }
    
    steps.push(`<div class="binary-operation-step">
        <strong>Step 2b: Add 1 to get 2's Complement</strong><br>
        ${onesComplement} + 1 = ${twosComplement}<br>
        <small>${addSteps.join('<br>')}</small></div>`);
    
    const dec2Complement = binaryToDecimal(twosComplement, binaryBits);
    
    steps.push(`<div class="binary-operation-step active">
        <strong>Step 3: Perform Addition (Minuend + 2's Complement of Subtrahend)</strong><br>
        ${dec1} - ${dec2} = ${dec1} + (${dec2Complement})<br>
        ${bin1} + ${twosComplement}</div>`);
    
    // Now perform addition
    let result = '';
    let carry = 0;
    let carries = [];
    let resultBits = [];
    
    // Create addition table
    let tableHTML = `<table class="binary-table">
        <thead>
            <tr>
                <th>Bit Position</th>`;
    
    for (let i = binaryBits - 1; i >= 0; i--) {
        tableHTML += `<th>${i}</th>`;
    }
    tableHTML += `</tr>
            <tr>
                <th>Minuend</th>`;
    
    for (let i = 0; i < binaryBits; i++) {
        tableHTML += `<td class="binary-bit ${bin1[i] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${bin1[i]}</td>`;
    }
    tableHTML += `</tr>
            <tr>
                <th>2's Comp Subtrahend</th>`;
    
    for (let i = 0; i < binaryBits; i++) {
        tableHTML += `<td class="binary-bit ${twosComplement[i] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${twosComplement[i]}</td>`;
    }
    tableHTML += `</tr>
            <tr>
                <th>Carry In</th>`;
    
    carries.push(0);
    
    for (let i = binaryBits - 1; i >= 0; i--) {
        const bit1 = parseInt(bin1[i]);
        const bit2 = parseInt(twosComplement[i]);
        
        const sum = bit1 ^ bit2 ^ carry;
        const carryOut = (bit1 & bit2) | ((bit1 ^ bit2) & carry);
        
        tableHTML += `<td class="binary-carry">${carry}</td>`;
        
        resultBits.unshift(sum.toString());
        carries.unshift(carryOut);
        carry = carryOut;
    }
    
    tableHTML += `</tr>
            <tr>
                <th>Result</th>`;
    
    for (let i = 0; i < binaryBits; i++) {
        tableHTML += `<td class="binary-bit ${resultBits[i] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${resultBits[i]}</td>`;
    }
    tableHTML += `</tr>
            <tr>
                <th>Carry Out</th>`;
    
    for (let i = 0; i < binaryBits; i++) {
        tableHTML += `<td class="binary-carry">${carries[i+1]}</td>`;
    }
    tableHTML += `<td class="binary-carry">${carry}</td></tr></table>`;
    
    steps.push(`<div class="binary-operation-step">${tableHTML}</div>`);
    
    result = resultBits.join('');
    const finalCarry = carry;
    const resultDecimal = binaryToDecimal(result, binaryBits);
    
    steps.push(`<div class="binary-operation-step active"><strong>Step 4: Final Result</strong><br>
        Binary Result: <span class="binary-bit ${result[0] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${result}</span><br>
        Decimal Result: ${resultDecimal}<br>
        Final Carry: ${finalCarry} ${finalCarry === 1 ? '(overflow - ignore for subtraction)' : ''}</div>`);
    
    // Check for overflow
    const overflow = checkOverflow(dec1, -dec2, resultDecimal, binaryBits);
    
    if (overflow) {
        steps.push(`<div class="binary-operation-step error"><strong>Step 5: Overflow Detection</strong><br>
             OVERFLOW DETECTED!<br>
            The result ${resultDecimal} exceeds the ${binaryBits}-bit signed range.<br>
            Maximum positive: ${(1 << (binaryBits - 1)) - 1}<br>
            Minimum negative: ${-(1 << (binaryBits - 1))}</div>`);
    } else {
        steps.push(`<div class="binary-operation-step"><strong>Step 5: Verification</strong><br>
             No overflow detected<br>
             Result within ${binaryBits}-bit signed range<br>
             Calculation verified: ${dec1} - ${dec2} = ${resultDecimal}</div>`);
    }
    
    displayBinaryResults(steps, result, resultDecimal, finalCarry, overflow);
}

function checkOverflow(num1, num2, result, bits) {
    const max = (1 << (bits - 1)) - 1;
    const min = -(1 << (bits - 1));
    
    // Check if result exceeds signed range
    if (result > max || result < min) {
        return true;
    }
    
    // Check for overflow in addition
    if ((num1 > 0 && num2 > 0 && result < 0) || 
        (num1 < 0 && num2 < 0 && result > 0)) {
        return true;
    }
    
    return false;
}

function displayBinaryResults(steps, resultBinary, resultDecimal, finalCarry, overflow) {
    const resultsSection = document.getElementById('binary-results-section');
    const operationName = currentBinaryOperation === 'addition' ? 'Addition' : 'Subtraction';
    
    resultsSection.innerHTML = `
        <div class="calculation-step active">
            <div class="calculation-title">Binary ${operationName} Results</div>
            <div class="calculation-content">
                <div class="row">
                    <div class="col-md-6">
                        <div class="gate-description">
                            <h6>Input Summary:</h6>
                            <div>Binary 1: <span class="binary-bit ${binaryNumber1[0] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${binaryNumber1}</span></div>
                            <div>Binary 2: <span class="binary-bit ${binaryNumber2[0] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${binaryNumber2}</span></div>
                            <div>Bit Length: ${binaryBits} bits</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="gate-description">
                            <h6>Result Summary:</h6>
                            <div>Binary Result: <span class="binary-bit ${resultBinary[0] === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${resultBinary}</span></div>
                            <div>Decimal Result: <strong>${resultDecimal}</strong></div>
                            <div>Final Carry: ${finalCarry}</div>
                            <div>Overflow: ${overflow ? '<span style="color: var(--danger-color)">YES</span>' : '<span style="color: var(--success-color)">NO</span>'}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="calculation-step mt-3">
            <div class="calculation-title">Step-by-Step Calculation</div>
            <div class="calculation-content">
                ${steps.join('')}
            </div>
        </div>
    `;
    
    resultsSection.style.display = 'block';
    
    // Update adder result display
    document.getElementById('adder-result').textContent = 
        `Result: ${resultDecimal} (Binary: ${resultBinary})`;
    
    addLog(`Performed binary ${currentBinaryOperation}: ${binaryNumber1} ${currentBinaryOperation === 'addition' ? '+' : '-'} ${binaryNumber2} = ${resultBinary} (${resultDecimal})`, 'success');
}

function clearBinaryOperation() {
    document.getElementById('binary-number1').value = '';
    document.getElementById('binary-number2').value = '';
    document.getElementById('binary-number1').classList.remove('error');
    document.getElementById('binary-number2').classList.remove('error');
    document.getElementById('binary-error').style.display = 'none';
    document.getElementById('binary-results-section').style.display = 'none';
    document.getElementById('adder-result').textContent = '-';
    
    addLog('Cleared binary operation inputs', 'info');
}
// Select complement operation (1's or 2's complement)
function selectComplementOperation(type) {
    currentComplementOperation = type;
    currentAdderType = null;
    currentSubtractorType = null;
    currentBinaryOperation = null;
    
    // Hide other input sections
    const adderInputs = document.getElementById('adder-inputs');
    if (adderInputs) adderInputs.style.display = 'none';
    
    const binaryInputSection = document.getElementById('binary-input-section');
    if (binaryInputSection) binaryInputSection.style.display = 'none';
    
    // Show complement inputs
    const complementInputs = document.getElementById('complement-inputs');
    if (complementInputs) complementInputs.style.display = 'block';
    
    // Update title
    const title = document.getElementById('complement-title');
    if (title) {
        title.textContent = type === 'ones-complement' ? "1's Complement Operation" : "2's Complement Operation";
    }
    
    // Update input placeholder
    const complementInput = document.getElementById('complement-binary-input');
    if (complementInput) {
        complementInput.placeholder = "Enter binary number (e.g., 101101)";
    }
    
    // Hide visualization and truth table
    const adderVisualization = document.getElementById('adder-visualization');
    if (adderVisualization) adderVisualization.style.display = 'none';
    
    const adderTruthTable = document.getElementById('adder-truth-table-container');
    if (adderTruthTable) adderTruthTable.style.display = 'none';
    
    const adderSteps = document.getElementById('adder-calculation-steps');
    if (adderSteps) adderSteps.style.display = 'block';
    
    // Clear previous results
    const adderStepsContainer = document.getElementById('adder-steps-container');
    if (adderStepsContainer) adderStepsContainer.innerHTML = '';
    
    // Update description
    const adderDescription = document.getElementById('adder-description');
    if (adderDescription) {
        if (type === 'ones-complement') {
            adderDescription.innerHTML = `
                <strong>1's Complement:</strong><br>
                 Inverts all bits (01, 10)<br>
                 Used for logical operations<br>
                 Simple bitwise NOT operation
            `;
        } else {
            adderDescription.innerHTML = `
                <strong>2's Complement:</strong><br>
                 Inverts all bits and adds 1<br>
                 Used for signed binary arithmetic<br>
                 Used to represent negative numbers
            `;
        }
    }
    
    // Update explanation
    const operationTitle = document.getElementById('adder-operation-title');
    if (operationTitle) {
        operationTitle.textContent = type === 'ones-complement' ? "1's Complement Operation" : "2's Complement Operation";
    }
    
    const operationExplanation = document.getElementById('adder-operation-explanation');
    if (operationExplanation) {
        if (type === 'ones-complement') {
            operationExplanation.innerHTML = `
                <strong>Enter a binary number to calculate its 1's complement.</strong><br>
                1's complement is obtained by flipping all bits (01, 10).
            `;
        } else {
            operationExplanation.innerHTML = `
                <strong>Enter a binary number to calculate its 2's complement.</strong><br>
                2's complement is obtained by: (1) Take 1's complement, (2) Add 1 to the result.
            `;
        }
    }
    
    // Update result display
    const adderResult = document.getElementById('adder-result');
    if (adderResult) {
        adderResult.textContent = '-';
    }
    
    addLog(`Selected ${type === 'ones-complement' ? "1's" : "2's"} complement operation`, 'info');
}
// Calculate complement
function calculateComplement() {
    const binaryInput = document.getElementById('complement-binary-input').value.trim();
    
    if (!binaryInput) {
        showComplementError("Please enter a binary number");
        return;
    }
    
    // Validate binary input
    if (!/^[01]+$/.test(binaryInput)) {
        showComplementError("Input must contain only binary digits (0 and 1).");
        return;
    }
    
    if (binaryInput.length > 32) {
        showComplementError("Input too long. Maximum 32 bits allowed.");
        return;
    }
    
    if (currentComplementOperation === 'ones-complement') {
        calculateOnesComplement(binaryInput);
    } else {
        calculateTwosComplement(binaryInput);
    }
}

// Calculate 1's Complement
function calculateOnesComplement(binaryInput) {
    // Step 1: Invert each bit
    const onesComplement = binaryInput.split('').map(bit => bit === '0' ? '1' : '0').join('');
    
    // Display results
    showComplementResult(binaryInput, onesComplement, null, 'ones');
    
    addLog(`Calculated 1's complement: ${binaryInput}  ${onesComplement}`, 'success');
}

// Calculate 2's Complement
function calculateTwosComplement(binaryInput) {
    // Step 1: Get 1's complement
    const onesComplement = binaryInput.split('').map(bit => bit === '0' ? '1' : '0').join('');
    
    // Step 2: Add 1 to 1's complement
    let twosComplement = '';
    let carry = 1;
    
    // Add binary addition manually (starting from LSB)
    for (let i = onesComplement.length - 1; i >= 0; i--) {
        const bit = parseInt(onesComplement[i]);
        const sum = bit + carry;
        
        if (sum === 0) {
            twosComplement = '0' + twosComplement;
            carry = 0;
        } else if (sum === 1) {
            twosComplement = '1' + twosComplement;
            carry = 0;
        } else if (sum === 2) {
            twosComplement = '0' + twosComplement;
            carry = 1;
        }
    }
    
    // If there's final carry, prepend it
    if (carry === 1) {
        twosComplement = '1' + twosComplement;
    }
    
    // Display results
    showComplementResult(binaryInput, onesComplement, twosComplement, 'twos');
    
    addLog(`Calculated 2's complement: ${binaryInput}  ${twosComplement}`, 'success');
}

// Show complement result
function showComplementResult(original, onesComp, twosComp, type) {
    const container = document.getElementById('adder-steps-container');
    container.innerHTML = '';
    
    if (type === 'ones') {
        container.innerHTML = `
            <div class="adder-step active">
                <div class="calculation-title">1's Complement Calculation</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Input Validation</strong></div>
                    <div class="binary-operation-step">
                        Original Binary: <span class="bit-value">${original}</span><br>
                        Length: ${original.length} bits<br>
                         Valid binary number confirmed
                    </div>
                    
                    <div class="mt-2"><strong>Step 2: 1's Complement Rule</strong></div>
                    <div class="binary-operation-step">
                        <strong>Rule:</strong> Invert (flip) all bits<br>
                        0  1<br>
                        1  0
                    </div>
                    
                    <div class="mt-2"><strong>Step 3: Bit-by-bit Conversion</strong></div>
                    <div class="binary-operation-step">
                        <table class="binary-table">
                            <thead>
                                <tr>
                                    <th>Bit Position</th>
                                    <th>Original Bit</th>
                                    <th>Operation</th>
                                    <th>1's Complement Bit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${original.split('').map((bit, index) => `
                                    <tr>
                                        <td class="bit-index">${index}</td>
                                        <td class="binary-bit ${bit === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${bit}</td>
                                        <td>${bit}  ${bit === '0' ? '1' : '0'}</td>
                                        <td class="binary-bit ${bit === '0' ? 'binary-bit-1' : 'binary-bit-0'}">${bit === '0' ? '1' : '0'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-2"><strong>Step 4: Final Result</strong></div>
                    <div class="binary-operation-step active">
                        <div>Original Binary: <span class="bit-value">${original}</span></div>
                        <div>1's Complement: <span class="highlight-equation">${onesComp}</span></div>
                        <div class="mt-2"><strong>Verification:</strong> All bits are inverted</div>
                    </div>
                    
                    <div class="mt-2"><strong>Step 5: Quick Check</strong></div>
                    <div class="binary-operation-step">
                        <strong>Check:</strong> Original  1's Complement = All 1s<br>
                        ${original}  ${onesComp} = ${'1'.repeat(original.length)}<br>
                         1's complement is correct
                    </div>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="adder-step active">
                <div class="calculation-title">2's Complement Calculation</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Input Validation</strong></div>
                    <div class="binary-operation-step">
                        Original Binary: <span class="bit-value">${original}</span><br>
                        Length: ${original.length} bits<br>
                         Valid binary number confirmed
                    </div>
                    
                    <div class="mt-2"><strong>Step 2: 2's Complement Rule</strong></div>
                    <div class="binary-operation-step">
                        <strong>Two-step process:</strong><br>
                        1. Calculate 1's complement (invert all bits)<br>
                        2. Add 1 to the 1's complement
                    </div>
                    
                    <div class="mt-2"><strong>Step 3: Calculate 1's Complement</strong></div>
                    <div class="binary-operation-step">
                        <strong>1's Complement:</strong> Invert all bits<br>
                        Original: ${original}<br>
                        1's Complement: ${onesComp}
                    </div>
                    
                    <div class="mt-2"><strong>Step 4: Add 1 to 1's Complement</strong></div>
                    <div class="binary-operation-step">
                        <strong>Binary Addition:</strong> ${onesComp} + 1<br>
                        <table class="binary-table">
                            <thead>
                                <tr>
                                    <th>Step</th>
                                    <th>Carry</th>
                                    <th>1's Complement</th>
                                    <th>Add 1</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${onesComp.split('').map((bit, index) => {
                                    const pos = onesComp.length - 1 - index;
                                    const currentBit = onesComp[pos];
                                    const resultBit = twosComp[pos] || '0';
                                    const carryIn = index === 0 ? '1' : '0';
                                    // Simplified display - in real implementation you'd show the actual addition steps
                                    return `
                                        <tr>
                                            <td>Bit ${pos}</td>
                                            <td class="binary-carry">${index === 0 ? '1 (initial)' : 'Carry from previous'}</td>
                                            <td class="binary-bit ${currentBit === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${currentBit}</td>
                                            <td>${index === 0 ? '1' : '0'}</td>
                                            <td class="binary-bit ${resultBit === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${resultBit}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-2"><strong>Step 5: Final Result</strong></div>
                    <div class="binary-operation-step active">
                        <div>Original Binary: <span class="bit-value">${original}</span></div>
                        <div>1's Complement: ${onesComp}</div>
                        <div>2's Complement: <span class="highlight-equation">${twosComp}</span></div>
                    </div>
                    
                    <div class="mt-2"><strong>Step 6: Verification</strong></div>
                    <div class="binary-operation-step">
                        <strong>Check:</strong> Original + 2's Complement = 0 (in n-bit representation)<br>
                        ${original} + ${twosComp} = ${'0'.repeat(original.length)} (with overflow)<br>
                         2's complement is correct
                    </div>
                </div>
            </div>
        `;
    }
    
    // Update result display
    document.getElementById('adder-result').textContent = 
        type === 'ones' ? 
        `1's Complement: ${onesComp}` : 
        `2's Complement: ${twosComp}`;
}

// Show step-by-step complement calculation
function showComplementSteps() {
    const binaryInput = document.getElementById('complement-binary-input').value.trim();
    
    if (!binaryInput) {
        showComplementError("Please enter a binary number first");
        return;
    }
    
    // Just recalculate with more detailed steps
    calculateComplement();
}

// Show complement error
function showComplementError(message) {
    const container = document.getElementById('adder-steps-container');
    
    container.innerHTML = `
        <div class="adder-step error">
            <div class="calculation-title">Error in Complement Calculation</div>
            <div class="calculation-content text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </div>
            <div class="mt-2">
                <strong>Valid Binary Examples:</strong><br>
                 Positive numbers: 101101, 00101101, 1100<br>
                 <strong>Note:</strong> Only 0s and 1s are allowed<br>
                 Maximum length: 32 bits
            </div>
            <div class="mt-2">
                <strong>Example Calculations:</strong><br>
                <strong>1's Complement of "1011":</strong> 0100 (invert all bits)<br>
                <strong>2's Complement of "1011":</strong> 0101 (invert and add 1)
            </div>
        </div>
    `;
    
    addLog(`Complement error: ${message}`, 'error');
}

// Reset complement operation
function resetComplement() {
    document.getElementById('complement-binary-input').value = '';
    document.getElementById('adder-steps-container').innerHTML = '';
    document.getElementById('adder-result').textContent = '-';
    
    addLog('Reset complement operation', 'info');
}
// Initialize MUX/Decoder interface
function initializeMuxDecoder() {
    currentMuxDecoderType = null;
    
    // Hide all input sections
    document.getElementById('mux2-inputs').style.display = 'none';
    document.getElementById('mux4-inputs').style.display = 'none';
    document.getElementById('decoder-inputs').style.display = 'none';
    
    // Hide truth table initially
    document.getElementById('mux-truth-table-container').style.display = 'none';
    document.getElementById('mux-calculation-steps').style.display = 'none';
    
    // Clear previous results
    document.getElementById('mux-steps-container').innerHTML = '';
    document.getElementById('mux-result').textContent = '-';
    
    // Update description
    document.getElementById('mux-description').textContent = 'Select a component to see its operation';
    document.getElementById('mux-operation-explanation').textContent = 
        'Select 2:1 Multiplexer, 4:1 Multiplexer, or 2-to-4 Decoder to see their operation';
    
    // Setup input listeners
    setupMuxDecoderInputListeners();
}

// Setup input listeners
function setupMuxDecoderInputListeners() {
    // MUX 2:1 inputs
    document.getElementById('mux2-i0')?.addEventListener('change', function() {
        mux2Inputs[0] = this.checked ? 1 : 0;
        updateInputLabel(this, mux2Inputs[0]);
    });
    
    document.getElementById('mux2-i1')?.addEventListener('change', function() {
        mux2Inputs[1] = this.checked ? 1 : 0;
        updateInputLabel(this, mux2Inputs[1]);
    });
    
    document.getElementById('mux2-sel')?.addEventListener('change', function() {
        mux2Inputs[2] = this.checked ? 1 : 0;
        updateInputLabel(this, mux2Inputs[2]);
    });
    
    // MUX 4:1 inputs
    document.getElementById('mux4-i0')?.addEventListener('change', function() {
        mux4Inputs[0] = this.checked ? 1 : 0;
        updateInputLabel(this, mux4Inputs[0]);
    });
    
    document.getElementById('mux4-i1')?.addEventListener('change', function() {
        mux4Inputs[1] = this.checked ? 1 : 0;
        updateInputLabel(this, mux4Inputs[1]);
    });
    
    document.getElementById('mux4-i2')?.addEventListener('change', function() {
        mux4Inputs[2] = this.checked ? 1 : 0;
        updateInputLabel(this, mux4Inputs[2]);
    });
    
    document.getElementById('mux4-i3')?.addEventListener('change', function() {
        mux4Inputs[3] = this.checked ? 1 : 0;
        updateInputLabel(this, mux4Inputs[3]);
    });
    
    document.getElementById('mux4-sel0')?.addEventListener('change', function() {
        mux4Inputs[4] = this.checked ? 1 : 0;
        updateInputLabel(this, mux4Inputs[4]);
    });
    
    document.getElementById('mux4-sel1')?.addEventListener('change', function() {
        mux4Inputs[5] = this.checked ? 1 : 0;
        updateInputLabel(this, mux4Inputs[5]);
    });
    
    // Decoder inputs
    document.getElementById('decoder-a')?.addEventListener('change', function() {
        decoderInputs[0] = this.checked ? 1 : 0;
        updateInputLabel(this, decoderInputs[0]);
    });
    
    document.getElementById('decoder-b')?.addEventListener('change', function() {
        decoderInputs[1] = this.checked ? 1 : 0;
        updateInputLabel(this, decoderInputs[1]);
    });
    
    document.getElementById('decoder-enable')?.addEventListener('change', function() {
        decoderInputs[2] = this.checked ? 1 : 0;
        updateInputLabel(this, decoderInputs[2]);
    });
}

// Helper function to update input labels
function updateInputLabel(checkbox, value) {
    const toggleLabel = checkbox.parentElement.parentElement.querySelector('span:last-child');
    toggleLabel.textContent = value ? '1 (ON)' : '0 (OFF)';
}

function selectMuxDecoderType(type) {
    currentMuxDecoderComponent = type;
    currentMuxDecoderType = type;

    // Helper function to safely set innerHTML
    function safeSetInnerHTML(elementId, html) {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = html;
        }
    }
    
    // Helper function to safely set textContent
    function safeSetTextContent(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
        }
    }
    
    // Helper function to safely set style
    function safeSetDisplay(elementId, displayValue) {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.display = displayValue;
        }
    }

    // Hide all input sections
    document.querySelectorAll('[id$="-inputs"]').forEach(el => {
        if (el) el.style.display = 'none';
    });
    
    // Hide the special 4:16 buttons initially
    safeSetDisplay('decoder4x16-buttons', 'none');
    
    // Hide the BCD decoder buttons initially
    safeSetDisplay('bcd-decoder-buttons', 'none');
    
    // Hide results
    safeSetDisplay('mux-truth-table-container', 'none');
    safeSetDisplay('mux-calculation-steps', 'none');

    // Clear previous results if elements exist
    safeSetInnerHTML('mux-steps-container', '');
    safeSetInnerHTML('mux-truth-table', '');

    // Update description and explanation elements
    const description = document.getElementById('mux-description');
    const explanationDiv = document.getElementById('mux-operation-explanation');
    const title = document.getElementById('mux-operation-title');

    // Show the appropriate input section
    switch(type) {
        case 'mux2':
            safeSetDisplay('mux2-inputs', 'block');
            break;
        case 'mux4':
            safeSetDisplay('mux4-inputs', 'block');
            break;
        case 'decoder':
            safeSetDisplay('decoder-inputs', 'block');
            break;
        case 'demux':
            safeSetDisplay('demux-inputs', 'block');
            break;
        case 'decoder3x8':
            safeSetDisplay('decoder3x8-inputs', 'block');
            break;
        case 'priority-encoder':
            safeSetDisplay('priority-encoder-inputs', 'block');
            break;
        case 'decoder4x16':
            safeSetDisplay('decoder4x16-inputs', 'block');
            if (typeof select4x16Decoder === 'function') {
                select4x16Decoder();
            }
            break;
        case 'bcd-decoder':
            safeSetDisplay('bcd-decoder-inputs', 'block');
            safeSetDisplay('bcd-decoder-buttons', 'grid');
            break;
    }

    // Update descriptions and explanations based on type
    if (title && description && explanationDiv) {
        if (type === 'mux2') {
            title.textContent = '2:1 Multiplexer';
            description.innerHTML = `
                <strong>2:1 Multiplexer:</strong> Selects one of two inputs based on select line.<br>
                <small>Output = S'I + SI</small>
            `;
            explanationDiv.innerHTML = `
                <strong>Operation:</strong><br>
                1. When S = 0, output = I<br>
                2. When S = 1, output = I<br>
                3. Only one input is routed to output at a time<br>
                <br>
                <strong>Applications:</strong><br>
                 Data routing<br>
                 Function selection<br>
                 Bus multiplexing
            `;
            
        } else if (type === 'mux4') {
            title.textContent = '4:1 Multiplexer';
            description.innerHTML = `
                <strong>4:1 Multiplexer:</strong> Selects one of four inputs based on select lines.<br>
                <small>Output = S'S'I + S'SI + SS'I + SSI</small>
            `;
            explanationDiv.innerHTML = `
                <strong>Operation:</strong><br>
                1. When SS = 00, output = I<br>
                2. When SS = 01, output = I<br>
                3. When SS = 10, output = I<br>
                4. When SS = 11, output = I<br>
                <br>
                <strong>Applications:</strong><br>
                 Data routing between multiple sources<br>
                 Function selection in ALUs<br>
                 Memory addressing
            `;
            
        } else if (type === 'decoder') {
            title.textContent = '2-to-4 Decoder';
            description.innerHTML = `
                <strong>2-to-4 Decoder:</strong> Converts 2-bit binary input to one of 4 outputs.<br>
                <small>Only one output is active at a time (active high)</small>
            `;
            explanationDiv.innerHTML = `
                <strong>Operation:</strong><br>
                1. Input AB determines which output is active<br>
                2. When AB = 00, output D = 1<br>
                3. When AB = 01, output D = 1<br>
                4. When AB = 10, output D = 1<br>
                5. When AB = 11, output D = 1<br>
                6. Enable must be active for any output<br>
                <br>
                <strong>Applications:</strong><br>
                 Memory chip selection<br>
                 Address decoding<br>
                 Control signal generation
            `;
            
        } else if (type === 'demux') {
            title.textContent = '1:2 Demultiplexer';
            description.innerHTML = `
                <strong>1:2 Demultiplexer:</strong> Routes single input to one of two outputs.<br>
                <small>Inverse operation of 2:1 multiplexer</small>
            `;
            explanationDiv.innerHTML = `
                <strong>Operation:</strong><br>
                1. When S = 0, input routed to Y<br>
                2. When S = 1, input routed to Y<br>
                3. Enable must be active for operation<br>
                4. Other output remains 0<br>
                <br>
                <strong>Applications:</strong><br>
                 Data distribution<br>
                 Serial to parallel conversion<br>
                 Address decoding
            `;
            
        } else if (type === 'decoder3x8') {
            title.textContent = '3-to-8 Decoder';
            description.innerHTML = `
                <strong>3-to-8 Decoder:</strong> Converts 3-bit binary input to one of 8 outputs.<br>
                <small>Only one output is active at a time</small>
            `;
            explanationDiv.innerHTML = `
                <strong>Operation:</strong><br>
                1. 3-bit input ABC selects one of 8 outputs<br>
                2. Output pattern: When input = n, output D = 1<br>
                3. Enable must be active for operation<br>
                4. Can be cascaded for larger decoders<br>
                <br>
                <strong>Applications:</strong><br>
                 Memory address decoding<br>
                 Instruction decoding<br>
                 Chip select generation
            `;
            
        } else if (type === 'priority-encoder') {
            title.textContent = 'Priority Encoder';
            description.innerHTML = `
                <strong>Priority Encoder:</strong> Outputs binary code of highest priority active input.<br>
                <small>Used in interrupt controllers, keyboard encoders, and bus arbitration.</small>
            `;
            explanationDiv.innerHTML = `
                <strong>Operation:</strong><br>
                1. Scans inputs from highest priority to lowest<br>
                2. Outputs binary code of first active input found<br>
                3. Valid flag indicates if any input is active<br>
                4. Multiple active inputs: only highest priority is encoded<br>
                <br>
                <strong>Priority Settings:</strong><br>
                 <em>Highest Index</em>: Input 7/3 has highest priority<br>
                 <em>Lowest Index</em>: Input 0 has highest priority<br>
                 <em>Active High</em>: 1 = Active, 0 = Inactive<br>
                 <em>Active Low</em>: 0 = Active, 1 = Inactive
            `;
            
            // Initialize encoder if needed
            if (typeof initializePriorityEncoder === 'function') {
                initializePriorityEncoder();
            }
            
        } else if (type === 'decoder4x16') {
            title.textContent = '4:16 Decoder';
            description.innerHTML = `
                <strong>4:16 Decoder:</strong> Converts 4-bit binary input to one of 16 outputs.<br>
                <small>Exactly one output is active based on input combination</small>
            `;
            // The explanation will be set by select4x16Decoder() function
            
        } else if (type === 'bcd-decoder') {
            title.textContent = 'BCD to Decimal Decoder';
            description.innerHTML = `
                <strong>BCD to Decimal Decoder:</strong> Converts 4-bit BCD to one of 10 decimal outputs (0-9).<br>
                <small>Only one output is active for valid BCD codes (0000-1001)</small>
            `;
            explanationDiv.innerHTML = `
                <strong>Operation:</strong><br>
                1. 4-bit BCD input D C B A (A=LSB)<br>
                2. Valid BCD codes: 0000-1001 (0-9)<br>
                3. For input = n, output Y = 1 (others = 0)<br>
                4. Invalid codes (1010-1111): All outputs inactive<br>
                <br>
                <strong>BCD Representation:</strong><br>
                 0000 = 0 | 0101 = 5<br>
                 0001 = 1 | 0110 = 6<br>
                 0010 = 2 | 0111 = 7<br>
                 0011 = 3 | 1000 = 8<br>
                 0100 = 4 | 1001 = 9<br>
                <br>
                <strong>Applications:</strong><br>
                 7-segment display drivers<br>
                 Digital calculators<br>
                 BCD to decimal conversion circuits
            `;
        }
    }

    // Update visualization if function exists
    if (typeof updateMuxDecoderVisualization === 'function') {
        updateMuxDecoderVisualization(type);
    }

    // Show explanation section
    safeSetDisplay('mux-explanation', 'block');
    
    // Reset output display
    safeSetTextContent('mux-result', '-');
    
    // Clear calculation steps
    safeSetInnerHTML('mux-steps-container', '');
    safeSetDisplay('mux-calculation-steps', 'none');
    
    // Reset truth table
    safeSetDisplay('mux-truth-table-container', 'none');
    
    // Only add log if function exists
    if (typeof addLog === 'function') {
        const componentName = typeof getComponentName === 'function' ? getComponentName(type) : type;
        addLog(`Selected ${componentName}`, 'info');
    }
}
function getComponentName(type) {
    const names = {
        'mux2': '2:1 Multiplexer',
        'mux4': '4:1 Multiplexer',
        'decoder': '2-to-4 Decoder',
        'demux': '1:2 Demultiplexer',
        'decoder3x8': '3-to-8 Decoder',
        'priority-encoder': 'Priority Encoder',
        'decoder4x16': '4:16 Decoder',
        'bcd-decoder': 'BCD to Decimal Decoder'
    };
    return names[type] || type;
}
function selectMuxDecoderComponent(component) {
    // Hide all input sections first
    document.getElementById('mux2-inputs').style.display = 'none';
    document.getElementById('mux4-inputs').style.display = 'none';
    document.getElementById('decoder-inputs').style.display = 'none';
    document.getElementById('demux-inputs').style.display = 'none';
    document.getElementById('decoder3x8-inputs').style.display = 'none';
    document.getElementById('priority-encoder-inputs').style.display = 'none';
    document.getElementById('decoder4x16-inputs').style.display = 'none';
    document.getElementById('bcd-decoder-inputs').style.display = 'none';

    
    // Remove active class from all buttons
    document.getElementById('mux2-btn').classList.remove('active');
    document.getElementById('mux4-btn').classList.remove('active');
    document.getElementById('decoder-btn').classList.remove('active');
    document.getElementById('demux-btn').classList.remove('active');
    document.getElementById('decoder3x8-btn').classList.remove('active');
    document.getElementById('priority-encoder-btn').classList.remove('active');
    document.getElementById('decoder4x16-btn').classList.remove('active');
    document.getElementById('bcd-decoder-btn').classList.remove('active');

    
    // Show selected component's inputs and set active class
    switch(component) {
        case 'mux2':
            document.getElementById('mux2-inputs').style.display = 'block';
            document.getElementById('mux2-btn').classList.add('active');
            break;
        case 'mux4':
            document.getElementById('mux4-inputs').style.display = 'block';
            document.getElementById('mux4-btn').classList.add('active');
            break;
        case 'decoder':
            document.getElementById('decoder-inputs').style.display = 'block';
            document.getElementById('decoder-btn').classList.add('active');
            break;
        case 'demux':
            document.getElementById('demux-inputs').style.display = 'block';
            document.getElementById('demux-btn').classList.add('active');
            break;
        case 'decoder3x8':
            document.getElementById('decoder3x8-inputs').style.display = 'block';
            document.getElementById('decoder3x8-btn').classList.add('active');
            break;
        case 'priority-encoder':
            document.getElementById('priority-encoder-inputs').style.display = 'block';
            document.getElementById('priority-encoder-btn').classList.add('active');
            break;
        case 'decoder4x16':
            document.getElementById('decoder4x16-inputs').style.display = 'block';
            document.getElementById('decoder4x16-btn').classList.add('active');
            break;
        case 'bcd-decoder':
            document.getElementById('bcd-decoder-inputs').style.display = 'block';
            document.getElementById('bcd-decoder-btn').classList.add('active');
            break;
    }
    
    currentMuxDecoderComponent = component;
    
    // Update description
    updateMuxDecoderDescription(component);
    
    // Clear previous results
    document.getElementById('mux-calculation-steps').style.display = 'none';
    document.getElementById('mux-truth-table-container').style.display = 'none';
    document.getElementById('mux-explanation').style.display = 'block';
    document.getElementById('mux-result').textContent = '-';
    
    addLog(`Selected ${component} component`, 'info');
}
function updateMuxDecoderDescription(component) {
    const descriptionDiv = document.getElementById('mux-description');
    const operationTitle = document.getElementById('mux-operation-title');
    const operationExplanation = document.getElementById('mux-operation-explanation');
}
// Initialize Priority Encoder
// Initialize Priority Encoder
function initializePriorityEncoder() {
    const encoderType = document.getElementById('encoder-type-select').value;
    const inputsContainer = document.getElementById('encoder-inputs-container');
    inputsContainer.innerHTML = '';
    
    let numInputs;
    if (encoderType === '4to2') {
        numInputs = 4;
        currentPriorityEncoderType = '4to2';
    } else {
        numInputs = 8;
        currentPriorityEncoderType = '8to3';
    }
    
    // Initialize inputs array
    priorityEncoderInputs = new Array(numInputs).fill(0);
    
    // Create input toggles
    for (let i = 0; i < numInputs; i++) {
        const toggleDiv = document.createElement('div');
        toggleDiv.className = 'input-toggle mt-2';
        toggleDiv.innerHTML = `
            <span class="input-label">Input ${i}:</span>
            <label class="toggle-switch">
                <input type="checkbox" id="encoder-input-${i}">
                <span class="toggle-slider"></span>
            </label>
            <span class="ms-2">0 (INACTIVE)</span>
        `;
        inputsContainer.appendChild(toggleDiv);
        
        // Add event listener
        const toggleInput = document.getElementById(`encoder-input-${i}`);
        toggleInput.addEventListener('change', function() {
            togglePriorityEncoderInput(i);
        });
    }
    
    addLog(`Initialized ${encoderType} priority encoder with ${numInputs} inputs`, 'info');
}
// Toggle Priority Encoder Input
function togglePriorityEncoderInput(index) {
    const toggleInput = document.getElementById(`encoder-input-${index}`);
    priorityEncoderInputs[index] = toggleInput.checked ? 1 : 0;
    
    // Update display
    const toggleLabel = toggleInput.parentElement.parentElement.querySelector('span:last-child');
    const isActive = priorityEncoderInputs[index] === 1;
    
    if (priorityEncoderSettings.activeLevel === 'high') {
        toggleLabel.textContent = `${isActive ? '1 (ACTIVE)' : '0 (INACTIVE)'}`;
    } else {
        toggleLabel.textContent = `${isActive ? '0 (ACTIVE)' : '1 (INACTIVE)'}`;
    }
    
    // Recalculate output
    calculatePriorityEncoder();
    
    addLog(`Toggled encoder input ${index} to ${priorityEncoderInputs[index]}`, 'info');
}

// Calculate Priority Encoder Output
function calculatePriorityEncoder() {
    const encoderType = currentPriorityEncoderType;
    const direction = priorityEncoderSettings.direction;
    const activeLevel = priorityEncoderSettings.activeLevel;
    const inputs = [...priorityEncoderInputs];
    
    let highestActiveIndex = -1;
    let binaryOutput = '';
    let valid = false;
    
    // Find highest priority active input
    if (direction === 'highest') {
        // Highest index priority (MSB has highest priority)
        for (let i = inputs.length - 1; i >= 0; i--) {
            const isActive = (activeLevel === 'high') ? (inputs[i] === 1) : (inputs[i] === 0);
            if (isActive) {
                highestActiveIndex = i;
                valid = true;
                break;
            }
        }
    } else {
        // Lowest index priority (LSB has highest priority)
        for (let i = 0; i < inputs.length; i++) {
            const isActive = (activeLevel === 'high') ? (inputs[i] === 1) : (inputs[i] === 0);
            if (isActive) {
                highestActiveIndex = i;
                valid = true;
                break;
            }
        }
    }
    
    // Generate output
    if (encoderType === '4to2') {
        // 4-to-2 encoder: 2-bit output
        if (valid) {
            binaryOutput = highestActiveIndex.toString(2).padStart(2, '0');
        } else {
            binaryOutput = '00'; // Default when no active input
        }
    } else {
        // 8-to-3 encoder: 3-bit output
        if (valid) {
            binaryOutput = highestActiveIndex.toString(2).padStart(3, '0');
        } else {
            binaryOutput = '000'; // Default when no active input
        }
    }
    
    // Generate V (valid) output
    const vOutput = valid ? '1' : '0';
    
    // Update display
    updatePriorityEncoderDisplay(highestActiveIndex, binaryOutput, vOutput, valid, inputs);
    
    // Generate calculation steps
    generatePriorityEncoderSteps(inputs, highestActiveIndex, binaryOutput, vOutput, valid);
    
    return {
        highestActiveIndex: highestActiveIndex,
        binaryOutput: binaryOutput,
        valid: valid,
        vOutput: vOutput
    };
}

// Update Priority Encoder Display
function updatePriorityEncoderDisplay(highestIndex, binaryOutput, vOutput, valid, inputs) {
    // Update result display
    const resultDiv = document.getElementById('mux-result');
    
    if (valid) {
        resultDiv.textContent = `Output: ${binaryOutput} (V=${vOutput})`;
        resultDiv.style.color = 'var(--success-color)';
    } else {
        resultDiv.textContent = 'No active input (V=0)';
        resultDiv.style.color = 'var(--danger-color)';
    }
    
    // Update description
    const descDiv = document.getElementById('mux-description');
    descDiv.innerHTML = `
        <strong>Priority Encoder (${currentPriorityEncoderType})</strong><br>
        <small>Active Level: ${priorityEncoderSettings.activeLevel === 'high' ? 'High (1=Active)' : 'Low (0=Active)'}<br>
        Priority: ${priorityEncoderSettings.direction === 'highest' ? 'Highest Index' : 'Lowest Index'}</small>
    `;
}

// Generate Priority Encoder Calculation Steps
function generatePriorityEncoderSteps(inputs, highestIndex, binaryOutput, vOutput, valid) {
    const stepsContainer = document.getElementById('mux-steps-container');
    stepsContainer.innerHTML = '';
    
    const encoderType = currentPriorityEncoderType;
    const direction = priorityEncoderSettings.direction;
    const activeLevel = priorityEncoderSettings.activeLevel;
    
    // Step 1: Input Analysis
    const step1 = document.createElement('div');
    step1.className = 'priority-encoder-step active';
    step1.innerHTML = `
        <div class="calculation-title">Step 1: Input Analysis</div>
        <div class="calculation-content">
            <div><strong>Encoder Type:</strong> ${encoderType}</div>
            <div><strong>Active Level:</strong> ${activeLevel === 'high' ? 'High (1 = Active)' : 'Low (0 = Active)'}</div>
            <div><strong>Priority Direction:</strong> ${direction === 'highest' ? 'Highest Index Priority' : 'Lowest Index Priority'}</div>
            <div><strong>Input States:</strong></div>
            <table class="priority-table">
                <thead>
                    <tr>
                        <th>Input</th>
                        <th>Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${inputs.map((val, idx) => {
                        const isActive = (activeLevel === 'high') ? (val === 1) : (val === 0);
                        const statusClass = isActive ? 'priority-active' : '';
                        const priorityClass = (valid && idx === highestIndex) ? 'priority-selected' : '';
                        return `
                            <tr class="${statusClass} ${priorityClass}">
                                <td>I${idx}</td>
                                <td>${val}</td>
                                <td>${isActive ? 'ACTIVE' : 'inactive'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    stepsContainer.appendChild(step1);
    
    // Step 2: Priority Resolution
    const step2 = document.createElement('div');
    step2.className = 'priority-encoder-step';
    if (valid) step2.classList.add('active');
    
    let resolutionSteps = '';
    if (direction === 'highest') {
        resolutionSteps = 'Checking inputs from highest index to lowest index...';
        for (let i = inputs.length - 1; i >= 0; i--) {
            const isActive = (activeLevel === 'high') ? (inputs[i] === 1) : (inputs[i] === 0);
            resolutionSteps += `<br>Input ${i}: ${inputs[i]}  ${isActive ? 'ACTIVE ' : 'inactive'}`;
            if (i === highestIndex) {
                resolutionSteps += ` <span class="priority-highlight">(Highest Priority Active Input)</span>`;
                break;
            }
        }
    } else {
        resolutionSteps = 'Checking inputs from lowest index to highest index...';
        for (let i = 0; i < inputs.length; i++) {
            const isActive = (activeLevel === 'high') ? (inputs[i] === 1) : (inputs[i] === 0);
            resolutionSteps += `<br>Input ${i}: ${inputs[i]}  ${isActive ? 'ACTIVE ' : 'inactive'}`;
            if (i === highestIndex) {
                resolutionSteps += ` <span class="priority-highlight">(Highest Priority Active Input)</span>`;
                break;
            }
        }
    }
    
    step2.innerHTML = `
        <div class="calculation-title">Step 2: Priority Resolution</div>
        <div class="calculation-content">
            <div><strong>Search Direction:</strong> ${direction === 'highest' ? 'Highest to Lowest' : 'Lowest to Highest'}</div>
            ${resolutionSteps}
            ${valid ? `
                <div class="mt-2">
                    <span class="priority-highlight">Highest Priority Active Input: I${highestIndex}</span>
                </div>
            ` : `
                <div class="mt-2 priority-encoder-step error">
                    <strong>No active inputs found!</strong><br>
                    All inputs are ${activeLevel === 'high' ? '0 (INACTIVE)' : '1 (INACTIVE)'}
                </div>
            `}
        </div>
    `;
    stepsContainer.appendChild(step2);
    
    // Step 3: Binary Encoding
    const step3 = document.createElement('div');
    step3.className = 'priority-encoder-step';
    if (valid) step3.classList.add('active');
    
    step3.innerHTML = `
        <div class="calculation-title">Step 3: Binary Encoding</div>
        <div class="calculation-content">
            ${valid ? `
                <div><strong>Highest Priority Input:</strong> I${highestIndex}</div>
                <div><strong>Binary Conversion:</strong> ${highestIndex} (decimal)  ${highestIndex.toString(2)} (binary)</div>
                <div><strong>Padded to ${encoderType === '4to2' ? '2' : '3'} bits:</strong> ${binaryOutput}</div>
                <div class="mt-2 highlight-equation">Binary Output = ${binaryOutput}</div>
            ` : `
                <div>No active input  Default binary output</div>
                <div>Default: ${encoderType === '4to2' ? '00' : '000'}</div>
                <div class="mt-2">Binary Output = ${binaryOutput}</div>
            `}
        </div>
    `;
    stepsContainer.appendChild(step3);
    
    // Step 4: Valid Output
    const step4 = document.createElement('div');
    step4.className = 'priority-encoder-step';
    step4.classList.add('active');
    
    step4.innerHTML = `
        <div class="calculation-title">Step 4: Valid Output (V)</div>
        <div class="calculation-content">
            <div><strong>V Output indicates:</strong> Whether at least one input is active</div>
            <div><strong>Calculation:</strong> V = ${valid ? '1 (At least one active input)' : '0 (No active inputs)'}</div>
            <div class="mt-2 highlight-equation">V = ${vOutput}</div>
        </div>
    `;
    stepsContainer.appendChild(step4);
    
    // Step 5: Final Result
    const step5 = document.createElement('div');
    step5.className = 'priority-encoder-step active';
    
    step5.innerHTML = `
        <div class="calculation-title">Step 5: Final Result</div>
        <div class="calculation-content">
            <div><strong>Complete Output:</strong></div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>Binary Code</h6>
                        <div class="priority-output">${binaryOutput}</div>
                        <small>Represents highest priority active input</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>Valid Indicator</h6>
                        <div class="priority-output">${vOutput}</div>
                        <small>${valid ? 'Valid output' : 'No active inputs'}</small>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <strong>Summary:</strong> ${valid ? 
                    `When multiple inputs are active, priority encoder outputs the binary code of the highest priority input (I${highestIndex})` :
                    'No active inputs found, output is default binary code with V=0'
                }
            </div>
        </div>
    `;
    stepsContainer.appendChild(step5);
    
    // Show calculation steps container
    document.getElementById('mux-calculation-steps').style.display = 'block';
}

// Generate Priority Encoder Truth Table
function generatePriorityEncoderTruthTable() {
    const encoderType = currentPriorityEncoderType;
    const direction = priorityEncoderSettings.direction;
    const activeLevel = priorityEncoderSettings.activeLevel;
    
    let numInputs, outputBits;
    if (encoderType === '4to2') {
        numInputs = 4;
        outputBits = 2;
    } else {
        numInputs = 8;
        outputBits = 3;
    }
    
    const table = document.getElementById('mux-truth-table');
    table.innerHTML = '';
    
    // Create header
    const headerRow = document.createElement('tr');
    
    // Input headers
    for (let i = numInputs - 1; i >= 0; i--) {
        const th = document.createElement('th');
        th.textContent = `I${i}`;
        headerRow.appendChild(th);
    }
    
    // Output headers
    for (let i = outputBits - 1; i >= 0; i--) {
        const th = document.createElement('th');
        th.textContent = `Y${i}`;
        headerRow.appendChild(th);
    }
    
    // V header
    const vTh = document.createElement('th');
    vTh.textContent = 'V';
    headerRow.appendChild(vTh);
    table.appendChild(headerRow);
    
    // Generate all combinations
    const totalCombinations = Math.pow(2, numInputs);
    
    for (let i = 0; i < totalCombinations; i++) {
        const row = document.createElement('tr');
        
        // Get binary representation
        const binary = i.toString(2).padStart(numInputs, '0');
        const inputs = binary.split('').map(bit => parseInt(bit));
        
        // Display inputs
        for (let j = numInputs - 1; j >= 0; j--) {
            const td = document.createElement('td');
            const bit = inputs[numInputs - 1 - j];
            td.textContent = bit;
            td.className = bit ? 'active' : 'inactive';
            
            // Highlight if active according to active level
            if ((activeLevel === 'high' && bit === 1) || (activeLevel === 'low' && bit === 0)) {
                td.style.backgroundColor = 'rgba(34, 139, 34, 0.2)';
                td.style.fontWeight = 'bold';
            }
            
            row.appendChild(td);
        }
        
        // Calculate output
        let highestActiveIndex = -1;
        let valid = false;
        
        if (direction === 'highest') {
            // Highest index priority
            for (let j = numInputs - 1; j >= 0; j--) {
                const isActive = (activeLevel === 'high') ? (inputs[j] === 1) : (inputs[j] === 0);
                if (isActive) {
                    highestActiveIndex = j;
                    valid = true;
                    break;
                }
            }
        } else {
            // Lowest index priority
            for (let j = 0; j < numInputs; j++) {
                const isActive = (activeLevel === 'high') ? (inputs[j] === 1) : (inputs[j] === 0);
                if (isActive) {
                    highestActiveIndex = j;
                    valid = true;
                    break;
                }
            }
        }
        
        // Generate output bits
        const outputBinary = valid ? 
            highestActiveIndex.toString(2).padStart(outputBits, '0') : 
            '0'.repeat(outputBits);
        
        // Display output bits
        for (let j = outputBits - 1; j >= 0; j--) {
            const td = document.createElement('td');
            const bit = parseInt(outputBinary[outputBits - 1 - j]);
            td.textContent = bit;
            td.className = bit ? 'active' : 'inactive';
            if (valid) {
                td.style.backgroundColor = 'rgba(255, 140, 0, 0.2)';
            }
            row.appendChild(td);
        }
        
        // Display V bit
        const vTd = document.createElement('td');
        vTd.textContent = valid ? '1' : '0';
        vTd.className = valid ? 'active' : 'inactive';
        vTd.style.fontWeight = 'bold';
        row.appendChild(vTd);
        
        // Highlight current row if it matches current inputs
        if (arraysEqual(inputs, priorityEncoderInputs.slice(0, numInputs))) {
            row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
        }
        
        table.appendChild(row);
    }
    
    // Update table title
    document.getElementById('mux-truth-table-title').textContent = 
        `${encoderType.toUpperCase()} Priority Encoder Truth Table`;
    
    // Show table
    document.getElementById('mux-truth-table-container').style.display = 'block';
    
    addLog(`Generated ${encoderType} priority encoder truth table`, 'info');
}

// Helper function to compare arrays
function arraysEqual(a, b) {
    if (a.length !== b.length) return false;
    for (let i = 0; i < a.length; i++) {
        if (a[i] !== b[i]) return false;
    }
    return true;
}

// Generate encoder input toggles
function generateEncoderInputToggles(numInputs) {
    const container = document.getElementById('encoder-inputs-container');
    container.innerHTML = '';
    
    container.innerHTML += `
        <div class="mt-3">
            <h6>Encoder Inputs (D${numInputs-1}-D0):</h6>
            <div class="d-flex flex-wrap gap-2" id="encoder-toggles-container">
                <!-- Input toggles will be added here -->
            </div>
        </div>
    `;
    
    const togglesContainer = document.getElementById('encoder-toggles-container');
    
    for (let i = numInputs - 1; i >= 0; i--) {
        const toggleDiv = document.createElement('div');
        toggleDiv.className = 'input-toggle';
        toggleDiv.innerHTML = `
            <div class="text-center">
                <div class="mb-1"><strong>D${i}</strong></div>
                <label class="toggle-switch">
                    <input type="checkbox" id="enc-input-${i}" 
                           data-index="${i}">
                    <span class="toggle-slider"></span>
                </label>
                <div class="mt-1" id="enc-label-${i}">0</div>
            </div>
        `;
        
        togglesContainer.appendChild(toggleDiv);
        
        // Add event listener
        const toggle = document.getElementById(`enc-input-${i}`);
        toggle.addEventListener('change', function() {
            const index = parseInt(this.getAttribute('data-index'));
            toggleEncoderInput(index);
        });
    }
}

// Update encoder input toggles display
function updateEncoderInputToggles() {
    const numInputs = priorityEncoderInputs.length;
    
    for (let i = 0; i < numInputs; i++) {
        const toggle = document.getElementById(`enc-input-${i}`);
        const label = document.getElementById(`enc-label-${i}`);
        
        if (toggle && label) {
            toggle.checked = priorityEncoderInputs[i] === 1;
            label.textContent = priorityEncoderInputs[i];
            label.className = `mt-1 ${priorityEncoderInputs[i] ? 'text-success fw-bold' : ''}`;
        }
    }
}

// Toggle encoder input
function toggleEncoderInput(index) {
    priorityEncoderInputs[index] = priorityEncoderInputs[index] ? 0 : 1;
    updateEncoderInputToggles();
    
    const inputLabel = `D${index}`;
    addLog(`Toggled encoder input ${inputLabel} to ${priorityEncoderInputs[index]}`, 'info');
    
    // Auto-calculate if inputs change
    calculatePriorityEncoder();
}

// Calculate Priority Encoder
function calculatePriorityEncoder() {
    if (currentMuxDecoderComponent !== 'priority-encoder') return;
    
    const encoderType = currentPriorityEncoderType;
    const direction = priorityEncoderSettings.direction;
    const activeLevel = priorityEncoderSettings.activeLevel;
    const inputs = [...priorityEncoderInputs];
    
    // Perform encoding
    const result = encodePriority(inputs, direction, activeLevel);
    
    // Display results
    displayEncoderResults(result, encoderType, inputs);
    
    // Update output display
    document.getElementById('mux-result').textContent = 
        `${result.binaryOutput} (V=${result.valid ? 1 : 0})`;
    
    addLog(`Encoded ${encoderType}: ${inputs}  ${result.binaryOutput} (V=${result.valid ? 1 : 0})`, 'success');
}

// Core encoding logic
function encodePriority(inputs, direction, activeLevel) {
    const numInputs = inputs.length;
    let binaryCode = 0;
    let valid = false;
    let activeIndex = -1;
    
    // Determine search order based on priority direction
    let searchOrder;
    if (direction === 'highest') {
        searchOrder = Array.from({length: numInputs}, (_, i) => numInputs - 1 - i);
    } else {
        searchOrder = Array.from({length: numInputs}, (_, i) => i);
    }
    
    // Find first active input according to priority
    for (const index of searchOrder) {
        const isActive = (activeLevel === 'high') ? 
            (inputs[index] === 1) : (inputs[index] === 0);
        
        if (isActive) {
            binaryCode = index;
            valid = true;
            activeIndex = index;
            break;
        }
    }
    
    // Convert to binary string
    const outputWidth = Math.max(1, Math.ceil(Math.log2(numInputs)));
    const binaryOutput = binaryCode.toString(2).padStart(outputWidth, '0');
    
    // Find all active inputs for display
    const allActiveIndices = [];
    for (let i = 0; i < numInputs; i++) {
        const isActive = (activeLevel === 'high') ? 
            (inputs[i] === 1) : (inputs[i] === 0);
        if (isActive) {
            allActiveIndices.push(i);
        }
    }
    
    return {
        binaryOutput,
        decimalOutput: binaryCode,
        valid,
        activeIndex,
        allActiveIndices,
        numInputs,
        outputWidth
    };
}

// Display encoder results
function displayEncoderResults(result, encoderType, inputs) {
    const stepsContainer = document.getElementById('mux-steps-container');
    const truthTableContainer = document.getElementById('mux-truth-table-container');
    
    stepsContainer.innerHTML = '';
    truthTableContainer.style.display = 'block';
    
    // Create step-by-step explanation
    const stepsDiv = document.createElement('div');
    stepsDiv.className = 'priority-encoder-step active';
    
    stepsDiv.innerHTML = `
        <div class="calculation-title">${encoderType === '4to2' ? '4-to-2' : '8-to-3'} Priority Encoder Calculation</div>
        <div class="calculation-content">
            <div><strong>Step 1: Input Analysis</strong></div>
            <div class="mt-2">
                Inputs: ${inputs.map((val, idx) => 
                    `<span class="priority-input">D${idx}=${val}</span>`
                ).join(' ')}
            </div>
            <div>Total Inputs: ${result.numInputs}</div>
            <div>Active Level: ${priorityEncoderSettings.activeLevel === 'high' ? 'High (1=Active)' : 'Low (0=Active)'}</div>
            <div>Priority Direction: ${priorityEncoderSettings.direction === 'highest' ? 'Highest Index First' : 'Lowest Index First'}</div>
            
            <div class="mt-3"><strong>Step 2: Priority Scan</strong></div>
            <div>Scanning order: ${
                priorityEncoderSettings.direction === 'highest' ? 
                `D${result.numInputs-1}  D0` : 
                `D0  D${result.numInputs-1}`
            }</div>
            <div>Active inputs found: ${
                result.allActiveIndices.length > 0 ? 
                result.allActiveIndices.map(idx => `D${idx}`).join(', ') : 
                'None'
            }</div>
            
            ${result.allActiveIndices.length > 0 ? `
                <div class="mt-2"><strong>Step 3: Highest Priority Selection</strong></div>
                <div>Highest priority active input: <span class="priority-highlight">D${result.activeIndex}</span></div>
                <div>Decimal value: ${result.decimalOutput}</div>
            ` : `
                <div class="mt-2"><strong>Step 3: No Active Input</strong></div>
                <div>No active input found</div>
            `}
            
            <div class="mt-3"><strong>Step 4: Binary Encoding</strong></div>
            <div>Output width: ${result.outputWidth} bits</div>
            <div>Binary conversion: ${result.decimalOutput}<sub>10</sub> = ${result.binaryOutput}<sub>2</sub></div>
            
            <div class="mt-3"><strong>Step 5: Final Result</strong></div>
            <div class="highlight-equation">
                Binary Output: <span class="priority-output">${result.binaryOutput}</span><br>
                Valid Flag: <span class="${result.valid ? 'text-success' : 'text-danger'}">${result.valid ? '1 (Valid)' : '0 (Invalid)'}</span>
            </div>
        </div>
    `;
    
    stepsContainer.appendChild(stepsDiv);
    
    // Show calculation steps
    document.getElementById('mux-calculation-steps').style.display = 'block';
    
    // Generate truth table
    generatePriorityEncoderTruthTable(encoderType, inputs, result);
}

// Generate truth table for priority encoder
function generatePriorityEncoderTruthTable(encoderType, currentInputs, currentResult) {
    const table = document.getElementById('mux-truth-table');
    const title = document.getElementById('mux-truth-table-title');
    
    title.textContent = `${encoderType === '4to2' ? '4-to-2' : '8-to-3'} Priority Encoder Truth Table`;
    
    const numInputs = encoderType === '4to2' ? 4 : 8;
    const outputWidth = Math.max(1, Math.ceil(Math.log2(numInputs)));
    
    table.innerHTML = '';
    
    // Create header
    const headerRow = document.createElement('tr');
    
    // Input headers
    for (let i = numInputs - 1; i >= 0; i--) {
        const th = document.createElement('th');
        th.textContent = `D${i}`;
        headerRow.appendChild(th);
    }
    
    // Output headers
    for (let i = outputWidth - 1; i >= 0; i--) {
        const th = document.createElement('th');
        th.textContent = `B${i}`;
        headerRow.appendChild(th);
    }
    
    // Valid flag header
    const validTh = document.createElement('th');
    validTh.textContent = 'V';
    headerRow.appendChild(validTh);
    
    // Priority header
    const priorityTh = document.createElement('th');
    priorityTh.textContent = 'Priority';
    headerRow.appendChild(priorityTh);
    
    table.appendChild(headerRow);
    
    // Generate important test cases (not all 2^n cases for display)
    const testCases = generateEncoderTestCases(numInputs);
    
    // Add current input case first
    testCases.unshift(currentInputs);
    
    // Create table rows
    testCases.forEach((inputs, caseIndex) => {
        const row = document.createElement('tr');
        
        // Highlight current case
        const isCurrentCase = caseIndex === 0;
        if (isCurrentCase) {
            row.style.backgroundColor = 'rgba(255, 140, 0, 0.1)';
        }
        
        // Input cells
        for (let i = numInputs - 1; i >= 0; i--) {
            const td = document.createElement('td');
            td.textContent = inputs[i];
            if (inputs[i] === 1) {
                td.classList.add('priority-active');
            }
            if (isCurrentCase && i === currentResult.activeIndex) {
                td.classList.add('priority-selected');
            }
            row.appendChild(td);
        }
        
        // Calculate outputs for this case
        const result = encodePriority(inputs, 
            priorityEncoderSettings.direction, 
            priorityEncoderSettings.activeLevel);
        
        // Output cells
        const binaryBits = result.binaryOutput.split('').reverse();
        for (let i = 0; i < outputWidth; i++) {
            const td = document.createElement('td');
            td.textContent = binaryBits[i] || '0';
            if (isCurrentCase) {
                td.classList.add('priority-output');
            }
            row.appendChild(td);
        }
        
        // Valid flag cell
        const validTd = document.createElement('td');
        validTd.textContent = result.valid ? '1' : '0';
        validTd.className = result.valid ? 'table-success' : 'table-secondary';
        row.appendChild(validTd);
        
        // Priority cell
        const priorityTd = document.createElement('td');
        if (result.valid) {
            priorityTd.textContent = `D${result.activeIndex}`;
            priorityTd.className = 'priority-highlight';
        } else {
            priorityTd.textContent = '-';
        }
        row.appendChild(priorityTd);
        
        table.appendChild(row);
    });
}

// Generate test cases for truth table
function generateEncoderTestCases(numInputs) {
    const testCases = [];
    
    // No inputs active
    testCases.push(new Array(numInputs).fill(0));
    
    // Single active inputs (each position)
    for (let i = 0; i < numInputs; i++) {
        const inputs = new Array(numInputs).fill(0);
        inputs[i] = 1;
        testCases.push(inputs);
    }
    
    // Multiple active inputs (test priority)
    if (numInputs >= 4) {
        // Two active - test priority
        const case1 = new Array(numInputs).fill(0);
        case1[0] = 1;
        case1[3] = 1;
        testCases.push(case1);
        
        // Three active
        const case2 = new Array(numInputs).fill(0);
        case2[1] = 1;
        case2[2] = 1;
        case2[3] = 1;
        testCases.push(case2);
    }
    
    // All inputs active
    testCases.push(new Array(numInputs).fill(1));
    
    return testCases;
}

function updateMuxDescription(title, description) {
    document.getElementById('mux-description').innerHTML = `
        <strong>${title}</strong><br>
        <small>${description}</small>
    `;
}

function updateMuxExplanation(type) {
    const explanationDiv = document.getElementById('mux-operation-explanation');
    let explanation = '';
    
    if (type === 'demux') {
        explanation = `
            <strong>1:2 Demultiplexer Operation:</strong><br>
             Routes a single input to one of two outputs<br>
             Select line (S) determines which output receives the input<br>
             Enable line (E) must be 1 for the demux to work<br>
             When E=1: Output Y0 = IS', Output Y1 = IS<br>
             When E=0: All outputs are 0<br>
            <br>
            <strong>Truth Table:</strong><br>
            E | S | I | Y0 | Y1<br>
            0 | X | X | 0 | 0<br>
            1 | 0 | 0 | 0 | 0<br>
            1 | 0 | 1 | 1 | 0<br>
            1 | 1 | 0 | 0 | 0<br>
            1 | 1 | 1 | 0 | 1
        `;
    } else if (type === 'decoder3x8') {
        explanation = `
            <strong>3-to-8 Decoder Operation:</strong><br>
             Converts 3-bit binary input (A,B,C) to one of 8 outputs (D0-D7)<br>
             Only one output is active (1) at any time<br>
             Enable line (E) must be 1 for the decoder to work<br>
             When E=1: Dn = 1 when n equals binary value of ABC<br>
             When E=0: All outputs are 0<br>
            <br>
            <strong>Output Logic:</strong><br>
            D0 = A'B'C'E<br>
            D1 = A'B'CE<br>
            D2 = A'BC'E<br>
            D3 = A'BCE<br>
            D4 = AB'C'E<br>
            D5 = AB'CE<br>
            D6 = ABC'E<br>
            D7 = ABCE
        `;
    } else {
        // Keep existing explanations for other components
        if (type === 'mux2') {
            explanation = 'Select 2:1 Multiplexer, 4:1 Multiplexer, 2-to-4 Decoder, 1:2 Demultiplexer, or 3-to-8 Decoder to see their operation';
        } else if (type === 'mux4') {
            explanation = '4:1 Multiplexer selects one of four inputs based on two select lines';
        } else if (type === 'decoder') {
            explanation = '2-to-4 Decoder converts 2-bit binary input to one of 4 outputs';
        }
    }
    
    explanationDiv.innerHTML = explanation;
    document.getElementById('mux-operation-title').textContent = 
        type === 'demux' ? '1:2 Demultiplexer' : 
        type === 'decoder3x8' ? '3-to-8 Decoder' : 
        'Multiplexers & Decoders';
}
// Calculate MUX/Decoder output
function calculateMuxDecoder() {
    let result = '';
    let explanation = '';
    let outputValues = [];
    if (currentMuxDecoderComponent === 'priority-encoder') {
        // Calculate priority encoder
        calculatePriorityEncoder();
        
        // Show calculation steps
        document.getElementById('mux-calculation-steps').style.display = 'block';
        document.getElementById('mux-truth-table-container').style.display = 'none';
        
        addLog('Calculated priority encoder output', 'info');
    } 
    if (currentMuxDecoderType === 'mux2') {
        // Get values
        const I0 = document.getElementById('mux2-i0').checked ? 1 : 0;
        const I1 = document.getElementById('mux2-i1').checked ? 1 : 0;
        const S = document.getElementById('mux2-sel').checked ? 1 : 0;
        
        // Calculate
        const output = (!S && I0) || (S && I1);
        result = `Output = ${output}`;
        
        // Generate explanation
        explanation = `
            <div class="mux-step active">
                <div class="calculation-title">2:1 Multiplexer Calculation</div>
                <div class="calculation-content">
                    <div><strong>Inputs:</strong> I0 = ${I0}, I1 = ${I1}, S = ${S}</div>
                    <div><strong>Formula:</strong> Output = S'I0 + SI1</div>
                    <div><strong>Calculation:</strong> Output = ${S ? "0" : "1"}${I0} + ${S}${I1} = ${(!S && I0) ? 1 : 0} + ${(S && I1) ? 1 : 0} = ${output}</div>
                    <div class="mux-output">Output = ${output}</div>
                </div>
            </div>
        `;
        
    } else if (currentMuxDecoderType === 'mux4') {
        // Get values
        const I0 = document.getElementById('mux4-i0').checked ? 1 : 0;
        const I1 = document.getElementById('mux4-i1').checked ? 1 : 0;
        const I2 = document.getElementById('mux4-i2').checked ? 1 : 0;
        const I3 = document.getElementById('mux4-i3').checked ? 1 : 0;
        const S0 = document.getElementById('mux4-sel0').checked ? 1 : 0;
        const S1 = document.getElementById('mux4-sel1').checked ? 1 : 0;
        
        // Calculate
        const output = (!S1 && !S0 && I0) || (!S1 && S0 && I1) || (S1 && !S0 && I2) || (S1 && S0 && I3);
        result = `Output = ${output}`;
        
        // Generate explanation
        explanation = `
            <div class="mux-step active">
                <div class="calculation-title">4:1 Multiplexer Calculation</div>
                <div class="calculation-content">
                    <div><strong>Inputs:</strong> I0 = ${I0}, I1 = ${I1}, I2 = ${I2}, I3 = ${I3}</div>
                    <div><strong>Select Lines:</strong> S1 = ${S1}, S0 = ${S0}</div>
                    <div><strong>Formula:</strong> Output = S1'S0'I0 + S1'S0I1 + S1S0'I2 + S1S0I3</div>
                    <div><strong>Calculation:</strong> Output = ${S1 ? "0" : "1"}${S0 ? "0" : "1"}${I0} + ${S1 ? "0" : "1"}${S0}${I1} + ${S1}${S0 ? "0" : "1"}${I2} + ${S1}${S0}${I3}</div>
                    <div class="mux-output">Output = ${output}</div>
                </div>
            </div>
        `;
        
    } else if (currentMuxDecoderType === 'decoder') {
        // Get values
        const A = document.getElementById('decoder-a').checked ? 1 : 0;
        const B = document.getElementById('decoder-b').checked ? 1 : 0;
        const E = document.getElementById('decoder-enable').checked ? 1 : 0;
        
        // Calculate outputs
        const D0 = E && !A && !B ? 1 : 0;
        const D1 = E && !A && B ? 1 : 0;
        const D2 = E && A && !B ? 1 : 0;
        const D3 = E && A && B ? 1 : 0;
        
        result = `Outputs: D0=${D0}, D1=${D1}, D2=${D2}, D3=${D3}`;
        outputValues = [D0, D1, D2, D3];
        
        // Generate explanation
        explanation = `
            <div class="mux-step active">
                <div class="calculation-title">2-to-4 Decoder Calculation</div>
                <div class="calculation-content">
                    <div><strong>Inputs:</strong> A = ${A}, B = ${B}, Enable = ${E}</div>
                    <div><strong>Output Logic:</strong></div>
                    <div>D0 = EA'B' = ${E}${A ? "0" : "1"}${B ? "0" : "1"} = ${D0}</div>
                    <div>D1 = EA'B = ${E}${A ? "0" : "1"}${B} = ${D1}</div>
                    <div>D2 = EAB' = ${E}${A}${B ? "0" : "1"} = ${D2}</div>
                    <div>D3 = EAB = ${E}${A}${B} = ${D3}</div>
                </div>
            </div>
        `;
        
    } else if (currentMuxDecoderType === 'demux') {
        // Get values
        const I = document.getElementById('demux-input-i').checked ? 1 : 0;
        const S = document.getElementById('demux-input-sel').checked ? 1 : 0;
        const E = document.getElementById('demux-input-enable').checked ? 1 : 0;
        
        // Calculate outputs
        const Y0 = E && I && !S ? 1 : 0;
        const Y1 = E && I && S ? 1 : 0;
        
        result = `Outputs: Y0=${Y0}, Y1=${Y1}`;
        outputValues = [Y0, Y1];
        
        // Generate explanation
        explanation = `
            <div class="mux-step active">
                <div class="calculation-title">1:2 Demultiplexer Calculation</div>
                <div class="calculation-content">
                    <div><strong>Inputs:</strong> I = ${I}, S = ${S}, Enable = ${E}</div>
                    <div><strong>Output Logic:</strong></div>
                    <div>When E=0: All outputs = 0</div>
                    <div>When E=1: Y0 = IS', Y1 = IS</div>
                    <div>Y0 = ${E}${I}${S ? "0" : "1"} = ${Y0}</div>
                    <div>Y1 = ${E}${I}${S} = ${Y1}</div>
                    <div class="mux-output">Y0 = ${Y0}, Y1 = ${Y1}</div>
                </div>
            </div>
        `;
        
    } else if (currentMuxDecoderType === 'decoder3x8') {
        // Get values
        const A = document.getElementById('decoder3x8-input-a').checked ? 1 : 0;
        const B = document.getElementById('decoder3x8-input-b').checked ? 1 : 0;
        const C = document.getElementById('decoder3x8-input-c').checked ? 1 : 0;
        const E = document.getElementById('decoder3x8-input-enable').checked ? 1 : 0;
        
        // Calculate outputs
        const D0 = E && !A && !B && !C ? 1 : 0;
        const D1 = E && !A && !B && C ? 1 : 0;
        const D2 = E && !A && B && !C ? 1 : 0;
        const D3 = E && !A && B && C ? 1 : 0;
        const D4 = E && A && !B && !C ? 1 : 0;
        const D5 = E && A && !B && C ? 1 : 0;
        const D6 = E && A && B && !C ? 1 : 0;
        const D7 = E && A && B && C ? 1 : 0;
        
        result = `Outputs: D0=${D0}, D1=${D1}, D2=${D2}, D3=${D3}, D4=${D4}, D5=${D5}, D6=${D6}, D7=${D7}`;
        outputValues = [D0, D1, D2, D3, D4, D5, D6, D7];
        
        // Generate explanation
        explanation = `
            <div class="mux-step active">
                <div class="calculation-title">3-to-8 Decoder Calculation</div>
                <div class="calculation-content">
                    <div><strong>Inputs:</strong> A = ${A}, B = ${B}, C = ${C}, Enable = ${E}</div>
                    <div><strong>Output Logic:</strong></div>
                    <div>D0 = EA'B'C' = ${E}${A ? "0" : "1"}${B ? "0" : "1"}${C ? "0" : "1"} = ${D0}</div>
                    <div>D1 = EA'B'C = ${E}${A ? "0" : "1"}${B ? "0" : "1"}${C} = ${D1}</div>
                    <div>D2 = EA'BC' = ${E}${A ? "0" : "1"}${B}${C ? "0" : "1"} = ${D2}</div>
                    <div>D3 = EA'BC = ${E}${A ? "0" : "1"}${B}${C} = ${D3}</div>
                    <div>D4 = EAB'C' = ${E}${A}${B ? "0" : "1"}${C ? "0" : "1"} = ${D4}</div>
                    <div>D5 = EAB'C = ${E}${A}${B ? "0" : "1"}${C} = ${D5}</div>
                    <div>D6 = EABC' = ${E}${A}${B}${C ? "0" : "1"} = ${D6}</div>
                    <div>D7 = EABC = ${E}${A}${B}${C} = ${D7}</div>
                </div>
            </div>
        `;
    }
    
    // Update display
    document.getElementById('mux-result').textContent = result;
    
    // Update calculation steps
    const stepsContainer = document.getElementById('mux-steps-container');
    stepsContainer.innerHTML = explanation;
    document.getElementById('mux-calculation-steps').style.display = 'block';
    
    // Show decoder outputs visualization if applicable
    if (currentMuxDecoderType === 'decoder' || currentMuxDecoderType === 'demux' || currentMuxDecoderType === 'decoder3x8') {
        updateDecoderOutputsVisualization(outputValues);
    }
    
    addLog(`Calculated ${currentMuxDecoderType}`, 'success');
}

function updateDecoderOutputsVisualization(outputValues) {
    const stepsContainer = document.getElementById('mux-steps-container');
    let outputsHTML = '';
    
    if (currentMuxDecoderType === 'decoder') {
        outputsHTML = `
            <div class="mux-step">
                <div class="calculation-title">2-to-4 Decoder Output Visualization</div>
                <div class="calculation-content">
                    <div class="decoder-outputs">
                        ${outputValues.map((val, idx) => `
                            <div class="decoder-output ${val ? 'active' : 'inactive'}" title="D${idx}">
                                D${idx}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-2">
                        Active output: ${outputValues.findIndex(val => val === 1) !== -1 ? 
                            `D${outputValues.findIndex(val => val === 1)}` : 'None'}
                    </div>
                </div>
            </div>
        `;
    } else if (currentMuxDecoderType === 'demux') {
        outputsHTML = `
            <div class="mux-step">
                <div class="calculation-title">1:2 Demultiplexer Output Visualization</div>
                <div class="calculation-content">
                    <div class="decoder-outputs">
                        <div class="decoder-output ${outputValues[0] ? 'active' : 'inactive'}" title="Y0">
                            Y0
                        </div>
                        <div class="decoder-output ${outputValues[1] ? 'active' : 'inactive'}" title="Y1">
                            Y1
                        </div>
                    </div>
                    <div class="mt-2">
                        Input routed to: ${outputValues[0] ? 'Y0' : outputValues[1] ? 'Y1' : 'None (disabled or input=0)'}
                    </div>
                </div>
            </div>
        `;
    } else if (currentMuxDecoderType === 'decoder3x8') {
        outputsHTML = `
            <div class="mux-step">
                <div class="calculation-title">3-to-8 Decoder Output Visualization</div>
                <div class="calculation-content">
                    <div class="decoder-outputs">
                        ${outputValues.map((val, idx) => `
                            <div class="decoder-output ${val ? 'active' : 'inactive'}" title="D${idx}" style="width: 45px; height: 45px; font-size: 0.9rem;">
                                D${idx}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-2">
                        Active output: ${outputValues.findIndex(val => val === 1) !== -1 ? 
                            `D${outputValues.findIndex(val => val === 1)}` : 'None'}
                    </div>
                </div>
            </div>
        `;
    }
    
    stepsContainer.innerHTML += outputsHTML;
}

// Calculate 2:1 Multiplexer
function calculateMux2() {
    const [I0, I1, S] = mux2Inputs;
    
    // Output = (S  I0) + (S  I1)
    const output = (!S && I0) || (S && I1) ? 1 : 0;
    
    document.getElementById('mux-result').textContent = `Output = ${output}`;
    
    return { I0, I1, S, output };
}

// Generate steps for 2:1 Multiplexer
function generateMux2Steps() {
    const [I0, I1, S] = mux2Inputs;
    const output = (!S && I0) || (S && I1) ? 1 : 0;
    
    return [
        {
            title: "2:1 Multiplexer Operation",
            content: `
                <div><strong>Input Values:</strong></div>
                <div>I0 = <span class="mux-bit mux-input">${I0}</span>, I1 = <span class="mux-bit mux-input">${I1}</span>, S = <span class="mux-bit mux-select">${S}</span></div>
                
                <div class="mt-2"><strong>Formula:</strong></div>
                <div class="mux-formula">Output = (S  I0) + (S  I1)</div>
                
                <div class="mt-2"><strong>Step 1: Evaluate S (NOT S):</strong></div>
                <div>S = (${S}) = ${S ? 0 : 1}</div>
                
                <div class="mt-2"><strong>Step 2: Calculate (S  I0):</strong></div>
                <div>(${S ? 0 : 1})  (${I0}) = ${(!S && I0) ? 1 : 0}</div>
                
                <div class="mt-2"><strong>Step 3: Calculate (S  I1):</strong></div>
                <div>(${S})  (${I1}) = ${(S && I1) ? 1 : 0}</div>
                
                <div class="mt-2"><strong>Step 4: Final OR operation:</strong></div>
                <div>(${(!S && I0) ? 1 : 0}) + (${(S && I1) ? 1 : 0}) = ${output}</div>
                
                <div class="mt-2"><strong>Result:</strong></div>
                <div class="highlight-equation">When S = ${S}, Output = I${S} = ${output}</div>
                
                <div class="mt-2"><strong>Simple Rule:</strong></div>
                <div> If S=0  Output = I0 = ${I0}</div>
                <div> If S=1  Output = I1 = ${I1}</div>
            `
        }
    ];
}

// Calculate 4:1 Multiplexer
function calculateMux4() {
    const [I0, I1, I2, I3, S0, S1] = mux4Inputs;
    let output;
    
    // Determine output based on 2-bit select
    if (S1 === 0 && S0 === 0) {
        output = I0;
    } else if (S1 === 0 && S0 === 1) {
        output = I1;
    } else if (S1 === 1 && S0 === 0) {
        output = I2;
    } else { // S1=1, S0=1
        output = I3;
    }
    
    document.getElementById('mux-result').textContent = `Output = ${output}`;
    
    return { I0, I1, I2, I3, S0, S1, output };
}

// Generate steps for 4:1 Multiplexer
function generateMux4Steps() {
    const { I0, I1, I2, I3, S0, S1, output } = calculateMux4();
    
    const selectBinary = `${S1}${S0}`;
    const selectDecimal = parseInt(selectBinary, 2);
    
    return [
        {
            title: "4:1 Multiplexer Operation",
            content: `
                <div><strong>Input Values:</strong></div>
                <div>I0 = <span class="mux-bit mux-input">${I0}</span>, I1 = <span class="mux-bit mux-input">${I1}</span></div>
                <div>I2 = <span class="mux-bit mux-input">${I2}</span>, I3 = <span class="mux-bit mux-input">${I3}</span></div>
                <div>S1 = <span class="mux-bit mux-select">${S1}</span>, S0 = <span class="mux-bit mux-select">${S0}</span></div>
                
                <div class="mt-2"><strong>Select Line Analysis:</strong></div>
                <div>Select bits: S1S0 = ${S1}${S0} = Binary ${selectBinary} = Decimal ${selectDecimal}</div>
                
                <div class="mt-2"><strong>4:1 MUX Truth Table:</strong></div>
                <div class="gate-description">
                    S1  S0  |  Output<br>
                    ---------|---------<br>
                    0   0   |  I0 (${I0})<br>
                    0   1   |  I1 (${I1})<br>
                    1   0   |  I2 (${I2})<br>
                    1   1   |  I3 (${I3})
                </div>
                
                <div class="mt-2"><strong>Selection Process:</strong></div>
                <div>Since S1=${S1} and S0=${S0}, the multiplexer selects I${selectDecimal}</div>
                
                <div class="mt-2"><strong>Result:</strong></div>
                <div class="highlight-equation">When [S1,S0] = [${S1},${S0}], Output = I${selectDecimal} = ${output}</div>
                
                <div class="mt-2"><strong>Boolean Expression:</strong></div>
                <div class="mux-formula">
                    Output = (S1S0I0) + (S1S0I1) + (S1S0I2) + (S1S0I3)
                </div>
            `
        }
    ];
}

// Calculate 2-to-4 Decoder
function calculateDecoder() {
    const [A, B, Enable] = decoderInputs;
    
    // Calculate outputs
    if (Enable === 0) {
        // Disabled - all outputs are 0
        decoderOutputs = [0, 0, 0, 0];
    } else {
        // Enabled - one-hot output
        if (A === 0 && B === 0) {
            decoderOutputs = [1, 0, 0, 0]; // D0 active
        } else if (A === 1 && B === 0) {
            decoderOutputs = [0, 1, 0, 0]; // D1 active
        } else if (A === 0 && B === 1) {
            decoderOutputs = [0, 0, 1, 0]; // D2 active
        } else { // A=1, B=1
            decoderOutputs = [0, 0, 0, 1]; // D3 active
        }
    }
    
    // Format output for display
    const outputsStr = decoderOutputs.map((val, idx) => `D${idx}=${val}`).join(', ');
    document.getElementById('mux-result').textContent = `Outputs: ${outputsStr}`;
    
    return { A, B, Enable, outputs: decoderOutputs };
}

// Generate steps for 2-to-4 Decoder
function generateDecoderSteps() {
    const { A, B, Enable, outputs } = calculateDecoder();
    
    let stepsHTML = `
        <div><strong>Input Values:</strong></div>
        <div>A = <span class="mux-bit mux-input">${A}</span>, B = <span class="mux-bit mux-input">${B}</span>, Enable = <span class="mux-bit mux-select">${Enable}</span></div>
    `;
    
    if (Enable === 0) {
        stepsHTML += `
            <div class="mt-2"><strong>Decoder Status:</strong></div>
            <div style="color: var(--danger-color)">Decoder is DISABLED (Enable = 0)</div>
            <div>When disabled, all outputs are forced to 0 regardless of inputs</div>
            
            <div class="mt-2"><strong>Outputs:</strong></div>
            <div class="decoder-outputs">
                ${outputs.map((val, idx) => `
                    <div class="decoder-output ${val ? 'active' : 'inactive'}">
                        D${idx}<br>${val}
                    </div>
                `).join('')}
            </div>
            
            <div class="mt-2">All outputs are 0 because Enable = 0</div>
        `;
    } else {
        const inputDecimal = parseInt(`${B}${A}`, 2); // Note: B is MSB, A is LSB
        
        stepsHTML += `
            <div class="mt-2"><strong>Decoder Status:</strong></div>
            <div style="color: var(--success-color)">Decoder is ENABLED (Enable = 1)</div>
            
            <div class="mt-2"><strong>Input Analysis:</strong></div>
            <div>Input BA = ${B}${A} = Binary ${B}${A} = Decimal ${inputDecimal}</div>
            
            <div class="mt-2"><strong>2-to-4 Decoder Truth Table (when enabled):</strong></div>
            <div class="gate-description">
                A  B  |  D3 D2 D1 D0<br>
                ------|-------------<br>
                0  0  |  0  0  0  1<br>
                1  0  |  0  0  1  0<br>
                0  1  |  0  1  0  0<br>
                1  1  |  1  0  0  0
            </div>
            
            <div class="mt-2"><strong>Decoding Process:</strong></div>
            <div>Since [B,A] = [${B},${A}] = ${inputDecimal}, output D${inputDecimal} is active (1)</div>
            
            <div class="mt-2"><strong>Outputs:</strong></div>
            <div class="decoder-outputs">
                ${outputs.map((val, idx) => `
                    <div class="decoder-output ${val ? 'active' : 'inactive'}">
                        D${idx}<br>${val}
                    </div>
                `).join('')}
            </div>
            
            <div class="mt-2"><strong>Result:</strong></div>
            <div class="highlight-equation">When [B,A] = [${B},${A}], D${inputDecimal} = 1 (all others = 0)</div>
            
            <div class="mt-2"><strong>Boolean Expressions:</strong></div>
            <div class="mux-formula">D0 = A  B  Enable</div>
            <div class="mux-formula">D1 = A  B  Enable</div>
            <div class="mux-formula">D2 = A  B  Enable</div>
            <div class="mux-formula">D3 = A  B  Enable</div>
        `;
    }
    
    return [
        {
            title: "2-to-4 Decoder Operation",
            content: stepsHTML
        }
    ];
}

// Display MUX/Decoder steps
function displayMuxDecoderSteps(steps) {
    const container = document.getElementById('mux-steps-container');
    container.innerHTML = '';
    
    steps.forEach((step, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.className = `mux-step ${index === 0 ? 'active' : ''}`;
        stepDiv.innerHTML = `
            <div class="calculation-title">${step.title}</div>
            <div class="calculation-content">${step.content}</div>
        `;
        container.appendChild(stepDiv);
    });
}

// Show MUX/Decoder truth table
function showMuxDecoderTruthTable() {
    const tableContainer = document.getElementById('mux-truth-table-container');
    const table = document.getElementById('mux-truth-table');
    const title = document.getElementById('mux-truth-table-title');
    
    tableContainer.style.display = 'block';
    table.innerHTML = '';
            if (currentMuxDecoderComponent === 'priority-encoder') {
        generatePriorityEncoderTruthTable();
    } 
    if (currentMuxDecoderType === 'mux2') {
        title.textContent = '2:1 Multiplexer Truth Table';
        
        // Header
        const headerRow = document.createElement('tr');
        ['I0', 'I1', 'S', 'Output'].forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        
        // Generate all combinations (4 rows)
        for (let i = 0; i < 8; i++) {
            const I0 = (i >> 2) & 1;
            const I1 = (i >> 1) & 1;
            const S = i & 1;
            const output = (!S && I0) || (S && I1);
            
            const row = document.createElement('tr');
            [I0, I1, S, output].forEach(val => {
                const td = document.createElement('td');
                td.textContent = val;
                td.className = val ? 'active' : 'inactive';
                row.appendChild(td);
            });
            table.appendChild(row);
        }
        
    } else if (currentMuxDecoderType === 'mux4') {
        title.textContent = '4:1 Multiplexer Truth Table';
        
        // Header
        const headerRow = document.createElement('tr');
        ['I0', 'I1', 'I2', 'I3', 'S1', 'S0', 'Output'].forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        
        // Generate all combinations (16 rows)
        for (let i = 0; i < 64; i++) {
            const I0 = (i >> 5) & 1;
            const I1 = (i >> 4) & 1;
            const I2 = (i >> 3) & 1;
            const I3 = (i >> 2) & 1;
            const S1 = (i >> 1) & 1;
            const S0 = i & 1;
            const output = (!S1 && !S0 && I0) || (!S1 && S0 && I1) || (S1 && !S0 && I2) || (S1 && S0 && I3);
            
            const row = document.createElement('tr');
            [I0, I1, I2, I3, S1, S0, output].forEach(val => {
                const td = document.createElement('td');
                td.textContent = val;
                td.className = val ? 'active' : 'inactive';
                row.appendChild(td);
            });
            table.appendChild(row);
        }
        
    } else if (currentMuxDecoderType === 'decoder') {
        title.textContent = '2-to-4 Decoder Truth Table';
        
        // Header
        const headerRow = document.createElement('tr');
        ['E', 'A', 'B', 'D0', 'D1', 'D2', 'D3'].forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        
        // Generate all combinations (8 rows)
        for (let i = 0; i < 8; i++) {
            const E = (i >> 2) & 1;
            const A = (i >> 1) & 1;
            const B = i & 1;
            const D0 = E && !A && !B ? 1 : 0;
            const D1 = E && !A && B ? 1 : 0;
            const D2 = E && A && !B ? 1 : 0;
            const D3 = E && A && B ? 1 : 0;
            
            const row = document.createElement('tr');
            [E, A, B, D0, D1, D2, D3].forEach(val => {
                const td = document.createElement('td');
                td.textContent = val;
                td.className = val ? 'active' : 'inactive';
                row.appendChild(td);
            });
            table.appendChild(row);
        }
        
    } else if (currentMuxDecoderType === 'demux') {
        title.textContent = '1:2 Demultiplexer Truth Table';
        
        // Header
        const headerRow = document.createElement('tr');
        ['E', 'S', 'I', 'Y0', 'Y1'].forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        
        // Generate all combinations (8 rows)
        for (let i = 0; i < 8; i++) {
            const E = (i >> 2) & 1;
            const S = (i >> 1) & 1;
            const I = i & 1;
            const Y0 = E && I && !S ? 1 : 0;
            const Y1 = E && I && S ? 1 : 0;
            
            const row = document.createElement('tr');
            [E, S, I, Y0, Y1].forEach(val => {
                const td = document.createElement('td');
                td.textContent = val;
                td.className = val ? 'active' : 'inactive';
                row.appendChild(td);
            });
            table.appendChild(row);
        }
        
    } else if (currentMuxDecoderType === 'decoder3x8') {
        title.textContent = '3-to-8 Decoder Truth Table';
        
        // Header
        const headerRow = document.createElement('tr');
        ['E', 'A', 'B', 'C', 'D0', 'D1', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7'].forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        
        // Generate all combinations (16 rows)
        for (let i = 0; i < 16; i++) {
            const E = (i >> 3) & 1;
            const A = (i >> 2) & 1;
            const B = (i >> 1) & 1;
            const C = i & 1;
            const D0 = E && !A && !B && !C ? 1 : 0;
            const D1 = E && !A && !B && C ? 1 : 0;
            const D2 = E && !A && B && !C ? 1 : 0;
            const D3 = E && !A && B && C ? 1 : 0;
            const D4 = E && A && !B && !C ? 1 : 0;
            const D5 = E && A && !B && C ? 1 : 0;
            const D6 = E && A && B && !C ? 1 : 0;
            const D7 = E && A && B && C ? 1 : 0;
            
            const row = document.createElement('tr');
            [E, A, B, C, D0, D1, D2, D3, D4, D5, D6, D7].forEach(val => {
                const td = document.createElement('td');
                td.textContent = val;
                td.className = val ? 'active' : 'inactive';
                row.appendChild(td);
            });
            table.appendChild(row);
        }
    }
    
    addLog(`Displayed truth table for ${currentMuxDecoderType}`, 'info');
}
// Generate 2:1 MUX truth table
function generateMux2TruthTable(table) {
    // Header
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th>I0</th>
        <th>I1</th>
        <th>S</th>
        <th>Output</th>
    `;
    table.appendChild(headerRow);
    
    // All possible combinations
    const testCases = [
        [0, 0, 0],
        [0, 0, 1],
        [0, 1, 0],
        [0, 1, 1],
        [1, 0, 0],
        [1, 0, 1],
        [1, 1, 0],
        [1, 1, 1]
    ];
    
    testCases.forEach(([I0, I1, S]) => {
        const output = (!S && I0) || (S && I1) ? 1 : 0;
        const row = document.createElement('tr');
        
        // Highlight current input combination
        const isCurrent = I0 === mux2Inputs[0] && I1 === mux2Inputs[1] && S === mux2Inputs[2];
        
        row.innerHTML = `
            <td class="${I0 ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${I0}</td>
            <td class="${I1 ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${I1}</td>
            <td class="${S ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${S}</td>
            <td class="${output ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${output}</td>
        `;
        
        if (isCurrent) {
            row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
            row.style.fontWeight = 'bold';
        }
        
        table.appendChild(row);
    });
}

// Generate 4:1 MUX truth table
function generateMux4TruthTable(table) {
    // Header
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th>I0</th>
        <th>I1</th>
        <th>I2</th>
        <th>I3</th>
        <th>S1</th>
        <th>S0</th>
        <th>Output</th>
    `;
    table.appendChild(headerRow);
    
    // Sample combinations (full table would have 64 rows)
    const testCases = [
        // Some representative cases
        [0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 1],
        [0, 0, 0, 0, 1, 0],
        [0, 0, 0, 0, 1, 1],
        [1, 0, 0, 0, 0, 0],
        [0, 1, 0, 0, 0, 1],
        [0, 0, 1, 0, 1, 0],
        [0, 0, 0, 1, 1, 1],
        [1, 1, 1, 1, 0, 0],
        [1, 1, 1, 1, 0, 1],
        [1, 1, 1, 1, 1, 0],
        [1, 1, 1, 1, 1, 1]
    ];
    
    testCases.forEach(([I0, I1, I2, I3, S1, S0]) => {
        let output;
        if (S1 === 0 && S0 === 0) output = I0;
        else if (S1 === 0 && S0 === 1) output = I1;
        else if (S1 === 1 && S0 === 0) output = I2;
        else output = I3;
        
        const row = document.createElement('tr');
        
        // Highlight current input combination
        const isCurrent = I0 === mux4Inputs[0] && I1 === mux4Inputs[1] && 
                          I2 === mux4Inputs[2] && I3 === mux4Inputs[3] &&
                          S1 === mux4Inputs[4] && S0 === mux4Inputs[5];
        
        row.innerHTML = `
            <td class="${I0 ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${I0}</td>
            <td class="${I1 ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${I1}</td>
            <td class="${I2 ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${I2}</td>
            <td class="${I3 ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${I3}</td>
            <td class="${S1 ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${S1}</td>
            <td class="${S0 ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${S0}</td>
            <td class="${output ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${output}</td>
        `;
        
        if (isCurrent) {
            row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
            row.style.fontWeight = 'bold';
        }
        
        table.appendChild(row);
    });
}

// Generate Decoder truth table
function generateDecoderTruthTable(table) {
    // Header
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th>A</th>
        <th>B</th>
        <th>Enable</th>
        <th>D3</th>
        <th>D2</th>
        <th>D1</th>
        <th>D0</th>
        <th>Active Output</th>
    `;
    table.appendChild(headerRow);
    
    // All possible combinations
    const testCases = [
        [0, 0, 0],
        [0, 0, 1],
        [1, 0, 0],
        [1, 0, 1],
        [0, 1, 0],
        [0, 1, 1],
        [1, 1, 0],
        [1, 1, 1]
    ];
    
    testCases.forEach(([A, B, Enable]) => {
        let outputs;
        let activeOutput;
        
        if (Enable === 0) {
            outputs = [0, 0, 0, 0];
            activeOutput = "None (Disabled)";
        } else {
            if (A === 0 && B === 0) {
                outputs = [1, 0, 0, 0];
                activeOutput = "D0";
            } else if (A === 1 && B === 0) {
                outputs = [0, 1, 0, 0];
                activeOutput = "D1";
            } else if (A === 0 && B === 1) {
                outputs = [0, 0, 1, 0];
                activeOutput = "D2";
            } else { // A=1, B=1
                outputs = [0, 0, 0, 1];
                activeOutput = "D3";
            }
        }
        
        const row = document.createElement('tr');
        
        // Highlight current input combination
        const isCurrent = A === decoderInputs[0] && B === decoderInputs[1] && Enable === decoderInputs[2];
        
        row.innerHTML = `
            <td class="${A ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${A}</td>
            <td class="${B ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${B}</td>
            <td class="${Enable ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${Enable}</td>
            <td class="${outputs[3] ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${outputs[3]}</td>
            <td class="${outputs[2] ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${outputs[2]}</td>
            <td class="${outputs[1] ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${outputs[1]}</td>
            <td class="${outputs[0] ? 'active' : 'inactive'} ${isCurrent ? 'highlight' : ''}">${outputs[0]}</td>
            <td class="${isCurrent ? 'highlight' : ''}">${activeOutput}</td>
        `;
        
        if (isCurrent) {
            row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
            row.style.fontWeight = 'bold';
        }
        
        table.appendChild(row);
    });
}
// Reset MUX/Decoder
function resetMuxDecoder() {
        if (currentMuxDecoderComponent === 'priority-encoder') {
        // Reset encoder inputs
        const numInputs = currentPriorityEncoderType === '4to2' ? 4 : 8;
        priorityEncoderInputs = new Array(numInputs).fill(0);
        
        // Set default active input
        priorityEncoderInputs[numInputs - 1] = 1; // Highest priority input
        
        updateEncoderInputToggles();
        calculatePriorityEncoder();
        
        addLog('Reset priority encoder to default state', 'info');
    } 
    // Reset all inputs based on current type
    if (currentMuxDecoderType === 'mux2') {
        document.getElementById('mux2-i0').checked = false;
        document.getElementById('mux2-i1').checked = false;
        document.getElementById('mux2-sel').checked = false;
    } else if (currentMuxDecoderType === 'mux4') {
        document.getElementById('mux4-i0').checked = false;
        document.getElementById('mux4-i1').checked = false;
        document.getElementById('mux4-i2').checked = false;
        document.getElementById('mux4-i3').checked = false;
        document.getElementById('mux4-sel0').checked = false;
        document.getElementById('mux4-sel1').checked = false;
    } else if (currentMuxDecoderType === 'decoder') {
        document.getElementById('decoder-a').checked = false;
        document.getElementById('decoder-b').checked = false;
        document.getElementById('decoder-enable').checked = false;
    } else if (currentMuxDecoderType === 'demux') {
        document.getElementById('demux-input-i').checked = false;
        document.getElementById('demux-input-sel').checked = false;
        document.getElementById('demux-input-enable').checked = false;
    } else if (currentMuxDecoderType === 'decoder3x8') {
        document.getElementById('decoder3x8-input-a').checked = false;
        document.getElementById('decoder3x8-input-b').checked = false;
        document.getElementById('decoder3x8-input-c').checked = false;
        document.getElementById('decoder3x8-input-enable').checked = false;
    }
    
    // Reset displays
    document.getElementById('mux-result').textContent = '-';
    document.getElementById('mux-steps-container').innerHTML = '';
    document.getElementById('mux-calculation-steps').style.display = 'none';
    document.getElementById('mux-truth-table-container').style.display = 'none';
    
    addLog(`Reset ${currentMuxDecoderType}`, 'info');
}

// Helper function to get MUX/Decoder name
function getMuxDecoderName(type) {
    switch(type) {
        case 'mux2': return '2:1 Multiplexer';
        case 'mux4': return '4:1 Multiplexer';
        case 'decoder': return '2-to-4 Decoder';
        default: return 'Unknown';
    }
}
// Add event listeners for priority encoder buttons
document.getElementById('calculate-mux-btn')?.addEventListener('click', function() {
    if (currentMuxDecoderComponent === 'priority-encoder') {
        calculatePriorityEncoder();
    }
});

document.getElementById('show-truth-table-btn')?.addEventListener('click', function() {
    if (currentMuxDecoderComponent === 'priority-encoder') {
        generatePriorityEncoderTruthTable();
    }
});

// Initialize circuit interface
function initializeCircuitInterface() {
    // Reset state
    currentCircuitType = null;
    circuitInputs = [];
    isCircuitAnimating = false;
    
    // Clear diagram
    document.getElementById('circuit-diagram-container').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-sitemap fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <p class="mt-2">Select a circuit type to visualize its diagram</p>
        </div>
    `;
    
    // Hide truth table
    document.getElementById('circuit-truth-table-container').style.display = 'none';
    
    // Reset explanation
    document.getElementById('circuit-operation-title').textContent = 'MUX/DECODER Circuits';
    document.getElementById('circuit-operation-explanation').textContent = 
        'Select a circuit type to see its schematic diagram, operation, and truth table';
    
    // Reset output
    document.getElementById('circuit-output').textContent = '-';
    
    // Clear controls
    document.getElementById('circuit-specific-controls').innerHTML = '';
}

// Select circuit type
function selectCircuitType(type) {
    currentCircuitType = type;
    
    // Update button states
    document.querySelectorAll('#mux-circuit-section .btn-glow').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Generate circuit diagram
    generateCircuitDiagram(type);
    
    // Update controls
    updateCircuitControls(type);
    
    // Update explanation
    updateCircuitExplanation(type);
    
    // Calculate initial output
    calculateCircuitOutput();
    
    addLog(`Selected ${type} circuit diagram`, 'info');
}

// Generate circuit diagram based on type
function generateCircuitDiagram(type) {
    const container = document.getElementById('circuit-diagram-container');
    container.innerHTML = '';
    
    switch(type) {
        case 'mux2':
            generateMUX2Circuit();
            break;
        case 'mux4':
            generateMUX4Circuit();
            break;
        case 'decoder':
            generateDecoderCircuit();
            break;
        case 'demux':
            generateDEMUXCircuit();
            break;
        case 'decoder3x8':
            generateDecoder3x8Circuit();
            break;
        case 'priority-encoder':
            generatePriorityEncoderCircuit();
            break;
    }
}

// Generate 2:1 MUX Circuit
function generateMUX2Circuit() {
    const container = document.getElementById('circuit-diagram-container');
    
    // Create MUX body
    const muxDiv = document.createElement('div');
    muxDiv.className = 'mux-circuit';
    
    // MUX body
    const body = document.createElement('div');
    body.className = 'mux-body';
    muxDiv.appendChild(body);
    
    // Label
    const label = document.createElement('div');
    label.className = 'circuit-label';
    label.textContent = '2:1 MUX';
    label.style.left = '50%';
    label.style.top = '10%';
    label.style.transform = 'translateX(-50%)';
    muxDiv.appendChild(label);
    
    // Input I0
    const input0 = createCircuitNode('I0', 80, 30);
    input0.id = 'circuit-input-0';
    input0.addEventListener('click', () => toggleCircuitInput(0));
    muxDiv.appendChild(input0);
    
    // Input line I0
    const line0 = document.createElement('div');
    line0.className = 'mux-input-line';
    line0.id = 'circuit-line-0';
    line0.style.top = '80px';
    muxDiv.appendChild(line0);
    
    // Input I1
    const input1 = createCircuitNode('I1', 80, 120);
    input1.id = 'circuit-input-1';
    input1.addEventListener('click', () => toggleCircuitInput(1));
    muxDiv.appendChild(input1);
    
    // Input line I1
    const line1 = document.createElement('div');
    line1.className = 'mux-input-line';
    line1.id = 'circuit-line-1';
    line1.style.top = '170px';
    muxDiv.appendChild(line1);
    
    // Select line S
    const selectLine = document.createElement('div');
    selectLine.className = 'mux-select-line';
    selectLine.id = 'circuit-select-line';
    muxDiv.appendChild(selectLine);
    
    // Select node S
    const selectNode = createCircuitNode('S', 20, 100);
    selectNode.id = 'circuit-select';
    selectNode.addEventListener('click', () => toggleCircuitInput(2));
    muxDiv.appendChild(selectNode);
    
    // Output Y
    const outputNode = createCircuitNode('Y', 250, 100);
    outputNode.id = 'circuit-output-node';
    muxDiv.appendChild(outputNode);
    
    // Output line
    const outputLine = document.createElement('div');
    outputLine.className = 'mux-output-line';
    outputLine.id = 'circuit-output-line';
    outputLine.style.top = '100px';
    muxDiv.appendChild(outputLine);
    
    container.appendChild(muxDiv);
    
    // Initialize inputs
    circuitInputs = [0, 0, 0]; // [I0, I1, S]
}

// Generate 4:1 MUX Circuit
function generateMUX4Circuit() {
    const container = document.getElementById('circuit-diagram-container');
    
    // Create MUX body
    const muxDiv = document.createElement('div');
    muxDiv.className = 'mux-circuit';
    muxDiv.style.width = '350px';
    muxDiv.style.height = '350px';
    
    // MUX body
    const body = document.createElement('div');
    body.className = 'mux-body';
    body.style.height = '250px';
    muxDiv.appendChild(body);
    
    // Label
    const label = document.createElement('div');
    label.className = 'circuit-label';
    label.textContent = '4:1 MUX';
    label.style.left = '50%';
    label.style.top = '10%';
    label.style.transform = 'translateX(-50%)';
    muxDiv.appendChild(label);
    
    // Inputs I0-I3
    const inputPositions = [40, 90, 140, 190];
    for (let i = 0; i < 4; i++) {
        const input = createCircuitNode(`I${i}`, 80, inputPositions[i]);
        input.id = `circuit-input-${i}`;
        input.addEventListener('click', () => toggleCircuitInput(i));
        muxDiv.appendChild(input);
        
        const line = document.createElement('div');
        line.className = 'mux-input-line';
        line.id = `circuit-line-${i}`;
        line.style.top = `${inputPositions[i] + 10}px`;
        muxDiv.appendChild(line);
    }
    
    // Select lines S0, S1
    const selectLines = [
        {top: 80, left: 40},
        {top: 160, left: 40}
    ];
    
    for (let i = 0; i < 2; i++) {
        const selectLine = document.createElement('div');
        selectLine.className = 'mux-select-line';
        selectLine.id = `circuit-select-line-${i}`;
        selectLine.style.top = `${selectLines[i].top}px`;
        selectLine.style.left = `${selectLines[i].left}px`;
        muxDiv.appendChild(selectLine);
        
        const selectNode = createCircuitNode(`S${i}`, 20, selectLines[i].top + 10);
        selectNode.id = `circuit-select-${i}`;
        selectNode.addEventListener('click', () => toggleCircuitInput(4 + i));
        muxDiv.appendChild(selectNode);
    }
    
    // Output Y
    const outputNode = createCircuitNode('Y', 300, 140);
    outputNode.id = 'circuit-output-node';
    muxDiv.appendChild(outputNode);
    
    // Output line
    const outputLine = document.createElement('div');
    outputLine.className = 'mux-output-line';
    outputLine.id = 'circuit-output-line';
    outputLine.style.top = '140px';
    muxDiv.appendChild(outputLine);
    
    container.appendChild(muxDiv);
    
    // Initialize inputs
    circuitInputs = [0, 0, 0, 0, 0, 0]; // [I0, I1, I2, I3, S0, S1]
}

// Generate 2-to-4 Decoder Circuit
function generateDecoderCircuit() {
    const container = document.getElementById('circuit-diagram-container');
    
    // Create Decoder body
    const decoderDiv = document.createElement('div');
    decoderDiv.className = 'decoder-circuit';
    
    // Decoder body
    const body = document.createElement('div');
    body.className = 'decoder-body';
    decoderDiv.appendChild(body);
    
    // Label
    const label = document.createElement('div');
    label.className = 'circuit-label';
    label.textContent = '2-to-4 Decoder';
    label.style.left = '50%';
    label.style.top = '10%';
    label.style.transform = 'translateX(-50%)';
    decoderDiv.appendChild(label);
    
    // Input A
    const inputA = createCircuitNode('A', 50, 80);
    inputA.id = 'circuit-input-a';
    inputA.addEventListener('click', () => toggleCircuitInput(0));
    decoderDiv.appendChild(inputA);
    
    // Input line A
    const lineA = document.createElement('div');
    lineA.className = 'decoder-input-line';
    lineA.id = 'circuit-line-a';
    lineA.style.top = '90px';
    decoderDiv.appendChild(lineA);
    
    // Input B
    const inputB = createCircuitNode('B', 50, 130);
    inputB.id = 'circuit-input-b';
    inputB.addEventListener('click', () => toggleCircuitInput(1));
    decoderDiv.appendChild(inputB);
    
    // Input line B
    const lineB = document.createElement('div');
    lineB.className = 'decoder-input-line';
    lineB.id = 'circuit-line-b';
    lineB.style.top = '140px';
    decoderDiv.appendChild(lineB);
    
    // Enable E
    const enable = createCircuitNode('E', 50, 180);
    enable.id = 'circuit-input-enable';
    enable.addEventListener('click', () => toggleCircuitInput(2));
    decoderDiv.appendChild(enable);
    
    // Enable line
    const lineE = document.createElement('div');
    lineE.className = 'decoder-input-line';
    lineE.id = 'circuit-line-enable';
    lineE.style.top = '190px';
    decoderDiv.appendChild(lineE);
    
    // Outputs D0-D3
    const outputPositions = [60, 110, 160, 210];
    for (let i = 0; i < 4; i++) {
        const output = createCircuitNode(`D${i}`, 200, outputPositions[i]);
        output.id = `circuit-output-${i}`;
        decoderDiv.appendChild(output);
        
        const line = document.createElement('div');
        line.className = 'decoder-output-line';
        line.id = `circuit-output-line-${i}`;
        line.style.top = `${outputPositions[i] + 10}px`;
        decoderDiv.appendChild(line);
    }
    
    container.appendChild(decoderDiv);
    
    // Initialize inputs
    circuitInputs = [0, 0, 0]; // [A, B, Enable]
}

// Generate 1:2 DEMUX Circuit
function generateDEMUXCircuit() {
    const container = document.getElementById('circuit-diagram-container');
    
    // Create DEMUX body
    const demuxDiv = document.createElement('div');
    demuxDiv.className = 'demux-circuit';
    
    // DEMUX body
    const body = document.createElement('div');
    body.className = 'demux-body';
    demuxDiv.appendChild(body);
    
    // Label
    const label = document.createElement('div');
    label.className = 'circuit-label';
    label.textContent = '1:2 DEMUX';
    label.style.left = '50%';
    label.style.top = '10%';
    label.style.transform = 'translateX(-50%)';
    demuxDiv.appendChild(label);
    
    // Input I
    const input = createCircuitNode('I', 80, 60);
    input.id = 'circuit-input-i';
    input.addEventListener('click', () => toggleCircuitInput(0));
    demuxDiv.appendChild(input);
    
    // Input line
    const inputLine = document.createElement('div');
    inputLine.className = 'mux-input-line';
    inputLine.id = 'circuit-input-line';
    inputLine.style.top = '70px';
    demuxDiv.appendChild(inputLine);
    
    // Select S
    const select = createCircuitNode('S', 40, 120);
    select.id = 'circuit-select';
    select.addEventListener('click', () => toggleCircuitInput(1));
    demuxDiv.appendChild(select);
    
    // Select line
    const selectLine = document.createElement('div');
    selectLine.className = 'mux-select-line';
    selectLine.id = 'circuit-select-line';
    selectLine.style.top = '130px';
    selectLine.style.left = '60px';
    demuxDiv.appendChild(selectLine);
    
    // Outputs Y0, Y1
    const outputPositions = [60, 150];
    for (let i = 0; i < 2; i++) {
        const output = createCircuitNode(`Y${i}`, 230, outputPositions[i]);
        output.id = `circuit-output-${i}`;
        demuxDiv.appendChild(output);
        
        const line = document.createElement('div');
        line.className = 'mux-output-line';
        line.id = `circuit-output-line-${i}`;
        line.style.top = `${outputPositions[i] + 10}px`;
        demuxDiv.appendChild(line);
    }
    
    container.appendChild(demuxDiv);
    
    // Initialize inputs
    circuitInputs = [0, 0, 0]; // [Input, Select, Enable]
}

// Generate 3-to-8 Decoder Circuit
function generateDecoder3x8Circuit() {
    const container = document.getElementById('circuit-diagram-container');
    
    // Create Decoder body
    const decoderDiv = document.createElement('div');
    decoderDiv.className = 'decoder-circuit';
    decoderDiv.style.width = '300px';
    decoderDiv.style.height = '400px';
    
    // Decoder body
    const body = document.createElement('div');
    body.className = 'decoder-body';
    body.style.height = '320px';
    decoderDiv.appendChild(body);
    
    // Label
    const label = document.createElement('div');
    label.className = 'circuit-label';
    label.textContent = '3-to-8 Decoder';
    label.style.left = '50%';
    label.style.top = '10%';
    label.style.transform = 'translateX(-50%)';
    decoderDiv.appendChild(label);
    
    // Inputs A, B, C
    const inputPositions = [80, 130, 180];
    const inputLabels = ['A', 'B', 'C'];
    
    for (let i = 0; i < 3; i++) {
        const input = createCircuitNode(inputLabels[i], 50, inputPositions[i]);
        input.id = `circuit-input-${i}`;
        input.addEventListener('click', () => toggleCircuitInput(i));
        decoderDiv.appendChild(input);
        
        const line = document.createElement('div');
        line.className = 'decoder-input-line';
        line.id = `circuit-line-${i}`;
        line.style.top = `${inputPositions[i] + 10}px`;
        decoderDiv.appendChild(line);
    }
    
    // Enable E
    const enable = createCircuitNode('E', 50, 230);
    enable.id = 'circuit-input-enable';
    enable.addEventListener('click', () => toggleCircuitInput(3));
    decoderDiv.appendChild(enable);
    
    // Enable line
    const lineE = document.createElement('div');
    lineE.className = 'decoder-input-line';
    lineE.id = 'circuit-line-enable';
    lineE.style.top = '240px';
    decoderDiv.appendChild(lineE);
    
    // Outputs D0-D7
    const outputPositions = [50, 90, 130, 170, 210, 250, 290, 330];
    for (let i = 0; i < 8; i++) {
        const output = createCircuitNode(`D${i}`, 200, outputPositions[i]);
        output.id = `circuit-output-${i}`;
        decoderDiv.appendChild(output);
        
        const line = document.createElement('div');
        line.className = 'decoder-output-line';
        line.id = `circuit-output-line-${i}`;
        line.style.top = `${outputPositions[i] + 10}px`;
        decoderDiv.appendChild(line);
    }
    
    container.appendChild(decoderDiv);
    
    // Initialize inputs
    circuitInputs = [0, 0, 0, 0]; // [A, B, C, Enable]
}

// Generate Priority Encoder Circuit
function generatePriorityEncoderCircuit() {
    const container = document.getElementById('circuit-diagram-container');
    
    // Create Encoder body
    const encoderDiv = document.createElement('div');
    encoderDiv.className = 'priority-encoder-circuit';
    
    // Encoder body
    const body = document.createElement('div');
    body.className = 'encoder-body';
    encoderDiv.appendChild(body);
    
    // Label
    const label = document.createElement('div');
    label.className = 'circuit-label';
    label.textContent = 'Priority Encoder';
    label.style.left = '50%';
    label.style.top = '10%';
    label.style.transform = 'translateX(-50%)';
    encoderDiv.appendChild(label);
    
    // Inputs (4 inputs for 4-to-2 encoder)
    const inputPositions = [60, 110, 160, 210];
    for (let i = 0; i < 4; i++) {
        const input = createCircuitNode(`I${i}`, 80, inputPositions[i]);
        input.id = `circuit-input-${i}`;
        input.addEventListener('click', () => toggleCircuitInput(i));
        encoderDiv.appendChild(input);
        
        const line = document.createElement('div');
        line.className = 'mux-input-line';
        line.id = `circuit-line-${i}`;
        line.style.top = `${inputPositions[i] + 10}px`;
        encoderDiv.appendChild(line);
    }
    
    // Outputs Y0, Y1, V
    const outputPositions = [100, 150, 200];
    const outputLabels = ['Y0', 'Y1', 'V'];
    
    for (let i = 0; i < 3; i++) {
        const output = createCircuitNode(outputLabels[i], 250, outputPositions[i]);
        output.id = `circuit-output-${i}`;
        encoderDiv.appendChild(output);
        
        const line = document.createElement('div');
        line.className = 'mux-output-line';
        line.id = `circuit-output-line-${i}`;
        line.style.top = `${outputPositions[i] + 10}px`;
        encoderDiv.appendChild(line);
    }
    
    container.appendChild(encoderDiv);
    
    // Initialize inputs
    circuitInputs = [0, 0, 0, 0]; // [I0, I1, I2, I3]
}

// Helper function to create circuit nodes
function createCircuitNode(label, x, y) {
    const node = document.createElement('div');
    node.className = 'circuit-node';
    node.textContent = label;
    node.style.left = `${x}px`;
    node.style.top = `${y}px`;
    return node;
}

// Update circuit controls based on type
function updateCircuitControls(type) {
    const controlsDiv = document.getElementById('circuit-specific-controls');
    controlsDiv.innerHTML = '';
    
    let controlHTML = '';
    
    switch(type) {
        case 'mux2':
            controlHTML = `
                <div class="input-toggle mt-2">
                    <span class="input-label">I0:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-0">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                <div class="input-toggle mt-2">
                    <span class="input-label">I1:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-1">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                <div class="input-toggle mt-2">
                    <span class="input-label">S:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-2">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
            `;
            break;
            
        case 'mux4':
            controlHTML = `
                ${[0,1,2,3].map(i => `
                <div class="input-toggle mt-2">
                    <span class="input-label">I${i}:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-${i}">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                `).join('')}
                <div class="input-toggle mt-2">
                    <span class="input-label">S0:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-4">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                <div class="input-toggle mt-2">
                    <span class="input-label">S1:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-5">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
            `;
            break;
            
        case 'decoder':
            controlHTML = `
                <div class="input-toggle mt-2">
                    <span class="input-label">A:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-0">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                <div class="input-toggle mt-2">
                    <span class="input-label">B:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-1">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                <div class="input-toggle mt-2">
                    <span class="input-label">E:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-2">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
            `;
            break;
            
        case 'demux':
            controlHTML = `
                <div class="input-toggle mt-2">
                    <span class="input-label">Input:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-0">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                <div class="input-toggle mt-2">
                    <span class="input-label">Select:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-1">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                <div class="input-toggle mt-2">
                    <span class="input-label">Enable:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-2">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
            `;
            break;
            
        case 'decoder3x8':
            controlHTML = `
                ${['A','B','C'].map((label, i) => `
                <div class="input-toggle mt-2">
                    <span class="input-label">${label}:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-${i}">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                `).join('')}
                <div class="input-toggle mt-2">
                    <span class="input-label">Enable:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-3">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
            `;
            break;
            
        case 'priority-encoder':
            controlHTML = `
                ${[0,1,2,3].map(i => `
                <div class="input-toggle mt-2">
                    <span class="input-label">I${i}:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="circuit-toggle-${i}">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ms-2">0</span>
                </div>
                `).join('')}
                <div class="input-toggle mt-2">
                    <span class="input-label">Priority:</span>
                    <select id="circuit-priority-select" class="form-control mt-1">
                        <option value="highest">Highest Priority</option>
                        <option value="lowest">Lowest Priority</option>
                    </select>
                </div>
            `;
            break;
    }
    
    controlsDiv.innerHTML = controlHTML;
    
    // Add event listeners to toggles
    for (let i = 0; i < circuitInputs.length; i++) {
        const toggle = document.getElementById(`circuit-toggle-${i}`);
        if (toggle) {
            toggle.addEventListener('change', function() {
                toggleCircuitInput(i);
            });
        }
    }
    
    // Add event listener for priority select
    const prioritySelect = document.getElementById('circuit-priority-select');
    if (prioritySelect) {
        prioritySelect.addEventListener('change', function() {
            calculateCircuitOutput();
            updateCircuitVisualization();
        });
    }
}

// Toggle circuit input
function toggleCircuitInput(index) {
    if (isCircuitAnimating) return;
    
    circuitInputs[index] = circuitInputs[index] ? 0 : 1;
    
    // Update toggle switch
    const toggle = document.getElementById(`circuit-toggle-${index}`);
    if (toggle) {
        toggle.checked = circuitInputs[index] === 1;
        const label = toggle.parentElement.parentElement.querySelector('span:last-child');
        label.textContent = circuitInputs[index];
    }
    
    calculateCircuitOutput();
    updateCircuitVisualization();
    
    addLog(`Toggled circuit input ${index} to ${circuitInputs[index]}`, 'info');
}

// Calculate circuit output
function calculateCircuitOutput() {
    let output = '-';
    
    switch(currentCircuitType) {
        case 'mux2':
            // Y = I0S' + I1S
            const mux2Output = circuitInputs[2] === 0 ? circuitInputs[0] : circuitInputs[1];
            output = mux2Output;
            break;
            
        case 'mux4':
            // 4:1 MUX logic
            const select = (circuitInputs[4] << 1) | circuitInputs[5];
            const mux4Output = circuitInputs[select];
            output = mux4Output;
            break;
            
        case 'decoder':
            // 2-to-4 decoder logic
            if (circuitInputs[2] === 1) { // Enable active
                const select = (circuitInputs[0] << 1) | circuitInputs[1];
                output = `D${select}=1`;
            } else {
                output = 'All outputs=0';
            }
            break;
            
        case 'demux':
            // 1:2 demux logic
            if (circuitInputs[2] === 1) { // Enable active
                if (circuitInputs[1] === 0) { // Select=0
                    output = `Y0=${circuitInputs[0]}, Y1=0`;
                } else { // Select=1
                    output = `Y0=0, Y1=${circuitInputs[0]}`;
                }
            } else {
                output = 'Y0=0, Y1=0';
            }
            break;
            
        case 'decoder3x8':
            // 3-to-8 decoder logic
            if (circuitInputs[3] === 1) { // Enable active
                const select = (circuitInputs[0] << 2) | (circuitInputs[1] << 1) | circuitInputs[2];
                output = `D${select}=1`;
            } else {
                output = 'All outputs=0';
            }
            break;
            
        case 'priority-encoder':
            // Priority encoder logic
            const priority = document.getElementById('circuit-priority-select')?.value || 'highest';
            let activeInput = -1;
            
            if (priority === 'highest') {
                // Highest priority (I3 has highest priority)
                for (let i = 3; i >= 0; i--) {
                    if (circuitInputs[i] === 1) {
                        activeInput = i;
                        break;
                    }
                }
            } else {
                // Lowest priority (I0 has highest priority)
                for (let i = 0; i < 4; i++) {
                    if (circuitInputs[i] === 1) {
                        activeInput = i;
                        break;
                    }
                }
            }
            
            if (activeInput >= 0) {
                const y1 = (activeInput >> 1) & 1;
                const y0 = activeInput & 1;
                output = `Y1=${y1}, Y0=${y0}, V=1`;
            } else {
                output = 'Y1=0, Y0=0, V=0';
            }
            break;
    }
    
    document.getElementById('circuit-output').textContent = output;
    return output;
}

// Update circuit visualization
function updateCircuitVisualization() {
    // Update input nodes
    for (let i = 0; i < circuitInputs.length; i++) {
        const node = document.getElementById(`circuit-input-${i}`);
        const line = document.getElementById(`circuit-line-${i}`);
        
        if (node) {
            node.classList.toggle('active', circuitInputs[i] === 1);
        }
        if (line) {
            line.classList.toggle('active', circuitInputs[i] === 1);
        }
    }
    
    // Update select nodes
    const selectNode = document.getElementById('circuit-select');
    const selectLine = document.getElementById('circuit-select-line');
    if (selectNode && circuitInputs[2] !== undefined) {
        selectNode.classList.toggle('active', circuitInputs[2] === 1);
    }
    if (selectLine && circuitInputs[2] !== undefined) {
        selectLine.classList.toggle('active', circuitInputs[2] === 1);
    }
    
    // Update outputs based on circuit type
    const output = calculateCircuitOutput();
    
    // Update output nodes
    switch(currentCircuitType) {
        case 'mux2':
            const outputNode = document.getElementById('circuit-output-node');
            const outputLine = document.getElementById('circuit-output-line');
            const mux2Output = circuitInputs[2] === 0 ? circuitInputs[0] : circuitInputs[1];
            if (outputNode) outputNode.classList.toggle('active', mux2Output === 1);
            if (outputLine) outputLine.classList.toggle('active', mux2Output === 1);
            break;
            
        case 'decoder':
            // Update decoder outputs
            if (circuitInputs[2] === 1) { // Enable active
                const select = (circuitInputs[0] << 1) | circuitInputs[1];
                for (let i = 0; i < 4; i++) {
                    const outputNode = document.getElementById(`circuit-output-${i}`);
                    const outputLine = document.getElementById(`circuit-output-line-${i}`);
                    if (outputNode) outputNode.classList.toggle('active', i === select);
                    if (outputLine) outputLine.classList.toggle('active', i === select);
                }
            } else {
                // All outputs inactive
                for (let i = 0; i < 4; i++) {
                    const outputNode = document.getElementById(`circuit-output-${i}`);
                    const outputLine = document.getElementById(`circuit-output-line-${i}`);
                    if (outputNode) outputNode.classList.remove('active');
                    if (outputLine) outputLine.classList.remove('active');
                }
            }
            break;
            
        // Add similar logic for other circuit types
    }
}

// Update circuit explanation
function updateCircuitExplanation(type) {
    const title = document.getElementById('circuit-operation-title');
    const explanation = document.getElementById('circuit-operation-explanation');
    
    const explanations = {
        'mux2': {
            title: '2:1 Multiplexer Circuit',
            explanation: 'A 2:1 multiplexer selects one of two input signals (I0, I1) based on a select line (S). When S=0, output Y=I0. When S=1, output Y=I1.'
        },
        'mux4': {
            title: '4:1 Multiplexer Circuit',
            explanation: 'A 4:1 multiplexer selects one of four input signals (I0-I3) based on two select lines (S0, S1). The select lines form a 2-bit binary number (00-11) to choose the input.'
        },
        'decoder': {
            title: '2-to-4 Decoder Circuit',
            explanation: 'A 2-to-4 decoder takes two input lines (A, B) and an enable (E). When enabled, it activates exactly one of four output lines (D0-D3) based on the binary input.'
        },
        'demux': {
            title: '1:2 Demultiplexer Circuit',
            explanation: 'A 1:2 demultiplexer routes a single input signal to one of two output lines (Y0, Y1) based on a select line (S). When S=0, input goes to Y0. When S=1, input goes to Y1.'
        },
        'decoder3x8': {
            title: '3-to-8 Decoder Circuit',
            explanation: 'A 3-to-8 decoder takes three input lines (A, B, C) and an enable (E). When enabled, it activates exactly one of eight output lines (D0-D7) based on the 3-bit binary input.'
        },
        'priority-encoder': {
            title: 'Priority Encoder Circuit',
            explanation: 'A priority encoder takes multiple input lines and encodes the highest (or lowest) priority active input into a binary code, with a valid output (V) indicating at least one active input.'
        }
    };
    
    if (explanations[type]) {
        title.textContent = explanations[type].title;
        explanation.textContent = explanations[type].explanation;
    }
}

// Show circuit truth table
function showCircuitTruthTable() {
    const container = document.getElementById('circuit-truth-table-container');
    const table = document.getElementById('circuit-truth-table');
    
    table.innerHTML = '';
    container.style.display = 'block';
    
    switch(currentCircuitType) {
        case 'mux2':
            generateMUX2TruthTable(table);
            break;
        case 'mux4':
            generateMUX4TruthTable(table);
            break;
        case 'decoder':
            generateDecoderTruthTable(table);
            break;
        case 'demux':
            generateDEMUXTruthTable(table);
            break;
        case 'decoder3x8':
            generateDecoder3x8TruthTable(table);
            break;
        case 'priority-encoder':
            generatePriorityEncoderTruthTable(table);
            break;
    }
    
    addLog(`Displayed ${currentCircuitType} truth table`, 'info');
}

// Generate MUX2 truth table
function generateMUX2TruthTable(table) {
    // Header
    const header = document.createElement('tr');
    header.innerHTML = `
        <th>I0</th>
        <th>I1</th>
        <th>S</th>
        <th>Y</th>
    `;
    table.appendChild(header);
    
    // All combinations
    for (let i0 = 0; i0 < 2; i0++) {
        for (let i1 = 0; i1 < 2; i1++) {
            for (let s = 0; s < 2; s++) {
                const row = document.createElement('tr');
                const output = s === 0 ? i0 : i1;
                
                row.innerHTML = `
                    <td class="${i0 ? 'active' : 'inactive'}">${i0}</td>
                    <td class="${i1 ? 'active' : 'inactive'}">${i1}</td>
                    <td class="${s ? 'active' : 'inactive'}">${s}</td>
                    <td class="${output ? 'active' : 'inactive'}">${output}</td>
                `;
                table.appendChild(row);
            }
        }
    }
}

// Generate MUX4 truth table
function generateMUX4TruthTable(table) {
    // Header
    const header = document.createElement('tr');
    header.innerHTML = `
        <th>S1</th>
        <th>S0</th>
        <th>Y</th>
        <th>Selected Input</th>
    `;
    table.appendChild(header);
    
    // All combinations
    for (let s1 = 0; s1 < 2; s1++) {
        for (let s0 = 0; s0 < 2; s0++) {
            const select = (s1 << 1) | s0;
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td class="${s1 ? 'active' : 'inactive'}">${s1}</td>
                <td class="${s0 ? 'active' : 'inactive'}">${s0}</td>
                <td class="active">I${select}</td>
                <td>When S1S0 = ${s1}${s0}, output = I${select}</td>
            `;
            table.appendChild(row);
        }
    }
}

// Generate Decoder truth table
function generateDecoderTruthTable(table) {
    // Header
    const header = document.createElement('tr');
    header.innerHTML = `
        <th>E</th>
        <th>A</th>
        <th>B</th>
        <th>D3</th>
        <th>D2</th>
        <th>D1</th>
        <th>D0</th>
    `;
    table.appendChild(header);
    
    // All combinations
    for (let e = 0; e < 2; e++) {
        for (let a = 0; a < 2; a++) {
            for (let b = 0; b < 2; b++) {
                const row = document.createElement('tr');
                const select = (a << 1) | b;
                const outputs = [0, 0, 0, 0];
                
                if (e === 1) {
                    outputs[3 - select] = 1; // D3-D0, with D3 as MSB
                }
                
                row.innerHTML = `
                    <td class="${e ? 'active' : 'inactive'}">${e}</td>
                    <td class="${a ? 'active' : 'inactive'}">${a}</td>
                    <td class="${b ? 'active' : 'inactive'}">${b}</td>
                    <td class="${outputs[3] ? 'active' : 'inactive'}">${outputs[3]}</td>
                    <td class="${outputs[2] ? 'active' : 'inactive'}">${outputs[2]}</td>
                    <td class="${outputs[1] ? 'active' : 'inactive'}">${outputs[1]}</td>
                    <td class="${outputs[0] ? 'active' : 'inactive'}">${outputs[0]}</td>
                `;
                table.appendChild(row);
            }
        }
    }
}

// Generate DEMUX truth table
function generateDEMUXTruthTable(table) {
    // Header
    const header = document.createElement('tr');
    header.innerHTML = `
        <th>E</th>
        <th>S</th>
        <th>I</th>
        <th>Y1</th>
        <th>Y0</th>
    `;
    table.appendChild(header);
    
    // All combinations
    for (let e = 0; e < 2; e++) {
        for (let s = 0; s < 2; s++) {
            for (let i = 0; i < 2; i++) {
                const row = document.createElement('tr');
                let y1 = 0, y0 = 0;
                
                if (e === 1) {
                    if (s === 0) y0 = i;
                    else y1 = i;
                }
                
                row.innerHTML = `
                    <td class="${e ? 'active' : 'inactive'}">${e}</td>
                    <td class="${s ? 'active' : 'inactive'}">${s}</td>
                    <td class="${i ? 'active' : 'inactive'}">${i}</td>
                    <td class="${y1 ? 'active' : 'inactive'}">${y1}</td>
                    <td class="${y0 ? 'active' : 'inactive'}">${y0}</td>
                `;
                table.appendChild(row);
            }
        }
    }
}

// Animate circuit truth table
function animateCircuitTruthTable() {
    if (isCircuitAnimating || !currentCircuitType) return;
    
    isCircuitAnimating = true;
    const animateBtn = document.getElementById('animate-circuit-btn');
    animateBtn.disabled = true;
    animateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Animating...';
    
    // Show truth table
    showCircuitTruthTable();
    
    // Get all table rows
    const table = document.getElementById('circuit-truth-table');
    const rows = table.querySelectorAll('tr');
    
    // Remove previous highlights
    rows.forEach(row => row.style.backgroundColor = '');
    
    let currentRow = 1; // Start from first data row (skip header)
    
    function animateNextRow() {
        if (currentRow >= rows.length) {
            // Animation complete
            isCircuitAnimating = false;
            animateBtn.disabled = false;
            animateBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i>Animate Circuit';
            return;
        }
        
        // Remove highlight from previous row
        if (currentRow > 1) {
            rows[currentRow - 1].style.backgroundColor = '';
        }
        
        // Highlight current row
        rows[currentRow].style.backgroundColor = 'rgba(139, 69, 19, 0.2)';
        rows[currentRow].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Extract input values from row
        const cells = rows[currentRow].querySelectorAll('td');
        const inputValues = Array.from(cells).map(cell => parseInt(cell.textContent));
        
        // Update circuit inputs
        switch(currentCircuitType) {
            case 'mux2':
                circuitInputs = [inputValues[0], inputValues[1], inputValues[2]];
                break;
            case 'decoder':
                circuitInputs = [inputValues[1], inputValues[2], inputValues[0]];
                break;
            case 'demux':
                circuitInputs = [inputValues[2], inputValues[1], inputValues[0]];
                break;
        }
        
        // Update controls
        for (let i = 0; i < circuitInputs.length; i++) {
            const toggle = document.getElementById(`circuit-toggle-${i}`);
            if (toggle) {
                toggle.checked = circuitInputs[i] === 1;
                const label = toggle.parentElement.parentElement.querySelector('span:last-child');
                label.textContent = circuitInputs[i];
            }
        }
        
        // Update visualization
        updateCircuitVisualization();
        calculateCircuitOutput();
        
        // Move to next row after delay
        currentRow++;
        setTimeout(animateNextRow, 1000);
    }
    
    // Start animation
    animateNextRow();
    
    addLog(`Started ${currentCircuitType} circuit animation`, 'info');
}

// Reset circuit
function resetCircuit() {
    // Reset all inputs to 0
    for (let i = 0; i < circuitInputs.length; i++) {
        circuitInputs[i] = 0;
        
        // Update toggle switches
        const toggle = document.getElementById(`circuit-toggle-${i}`);
        if (toggle) {
            toggle.checked = false;
            const label = toggle.parentElement.parentElement.querySelector('span:last-child');
            label.textContent = '0';
        }
    }
    
    // Update visualization
    updateCircuitVisualization();
    calculateCircuitOutput();
    
    // Hide truth table
    document.getElementById('circuit-truth-table-container').style.display = 'none';
    
    // Reset animation state
    isCircuitAnimating = false;
    const animateBtn = document.getElementById('animate-circuit-btn');
    animateBtn.disabled = false;
    animateBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i>Animate Circuit';
    
    addLog('Circuit reset', 'info');
}
// Initialize Sequential Circuit-2 Operations
function initializeSequential2() {
    currentSequential2Component = 't-flipflop';
    
    // Set up event listeners for component buttons
    document.getElementById('t-flipflop-btn')?.addEventListener('click', () => selectSequential2Component('t-flipflop'));
    document.getElementById('register-storage-btn')?.addEventListener('click', () => selectSequential2Component('register-storage'));
    document.getElementById('shift-register-btn')?.addEventListener('click', () => selectSequential2Component('shift-register'));
    
    // Initialize the first component
    selectSequential2Component('t-flipflop');
}
// Handle Sequential Logic tab selection
function selectSequentialComponent(component) {
    currentSequentialComponent = component;
    
    // Hide all input sections
    document.getElementById('sr-latch-inputs').style.display = 'none';
    document.getElementById('d-latch-inputs').style.display = 'none';
    document.getElementById('d-flipflop-inputs').style.display = 'none';
    document.getElementById('jk-flipflop-inputs').style.display = 'none';
    
    // Show selected component's inputs
    document.getElementById(`${component}-inputs`).style.display = 'block';
    
    // Update description
    updateSequentialDescription();
    
    // Generate circuit diagram
    generateSequentialCircuit();
    
    // Show analysis
    showSequentialAnalysis();
    
    // Reset clock state for new component
    clockState = 0;
    
    addLog(`Selected ${getComponentName(component)}`, 'info');
}

// Get component display name
function getComponentName(component) {
    const names = {
        'sr-latch': 'SR Latch',
        'd-latch': 'D Latch',
        'd-flipflop': 'D Flip-Flop',
        'jk-flipflop': 'JK Flip-Flop'
    };
    return names[component] || component;
}

// Update component description
function updateSequentialDescription() {
    const descriptions = {
        'sr-latch': 'Set-Reset Latch: Basic memory element using NAND/NOR gates. Stores 1 bit.',
        'd-latch': 'Data Latch: Level-sensitive latch that stores D input when Enable is high.',
        'd-flipflop': 'D Flip-Flop: Edge-triggered memory element. Stores D input on clock edge.',
        'jk-flipflop': 'JK Flip-Flop: Universal flip-flop with J (set) and K (reset) inputs.'
    };
    
    document.getElementById('sequential-description').textContent = 
        descriptions[currentSequentialComponent] || 'Select a sequential component';
}

// Calculate sequential component output
function calculateSequential() {
    if (!currentSequentialComponent) return;
    
    let nextQ, nextQbar;
    
    switch(currentSequentialComponent) {
        case 'sr-latch':
            nextQ = calculateSRLatch();
            break;
        case 'd-latch':
            nextQ = calculateDLatch();
            break;
        case 'd-flipflop':
            nextQ = calculateDFlipFlop();
            break;
        case 'jk-flipflop':
            nextQ = calculateJKFlipFlop();
            break;
    }
    
    // Update displays
    document.getElementById('sequential-result').textContent = 
        sequentialState[currentSequentialComponent].Q;
    document.getElementById('sequential-next-result').textContent = nextQ;
    
    // Update circuit visualization
    updateSequentialCircuit();
    
    // Show analysis
    showSequentialAnalysis();
    
    addLog(`Calculated ${getComponentName(currentSequentialComponent)}: Q=${sequentialState[currentSequentialComponent].Q}  Q+=${nextQ}`, 'success');
}

// SR Latch calculation
function calculateSRLatch() {
    const S = document.getElementById('sr-input-s')?.checked ? 1 : 0;
    const R = document.getElementById('sr-input-r')?.checked ? 1 : 0;
    const currentQ = sequentialState['sr-latch'].Q;
    
    let nextQ, nextQbar;
    
    // SR Latch truth table (using NAND implementation)
    if (S === 1 && R === 0) {
        // Set: Q=1, Q'=0
        nextQ = 1;
        nextQbar = 0;
    } else if (S === 0 && R === 1) {
        // Reset: Q=0, Q'=1
        nextQ = 0;
        nextQbar = 1;
    } else if (S === 0 && R === 0) {
        // Hold: maintain previous state
        nextQ = currentQ;
        nextQbar = currentQ === 1 ? 0 : 1;
    } else {
        // S=1, R=1: Invalid state (both outputs become 1)
        nextQ = 1;
        nextQbar = 1;
    }
    
    // Update state
    sequentialState['sr-latch'].prevQ = sequentialState['sr-latch'].Q;
    sequentialState['sr-latch'].Q = nextQ;
    sequentialState['sr-latch'].Qbar = nextQbar;
    
    // Update display toggles
    document.getElementById('sr-current-q').checked = nextQ === 1;
    document.getElementById('sr-current-qbar').checked = nextQbar === 1;
    
    return nextQ;
}

// D Latch calculation
function calculateDLatch() {
    const D = document.getElementById('dl-input-d')?.checked ? 1 : 0;
    const E = document.getElementById('dl-input-e')?.checked ? 1 : 0;
    const currentQ = sequentialState['d-latch'].Q;
    
    let nextQ;
    
    if (E === 1) {
        // Enable is high: Q follows D
        nextQ = D;
    } else {
        // Enable is low: hold previous state
        nextQ = currentQ;
    }
    
    // Update state
    sequentialState['d-latch'].prevQ = sequentialState['d-latch'].Q;
    sequentialState['d-latch'].Q = nextQ;
    
    // Update display toggle
    document.getElementById('dl-current-q').checked = nextQ === 1;
    
    return nextQ;
}

// D Flip-Flop calculation
function calculateDFlipFlop() {
    const D = document.getElementById('dff-input-d')?.checked ? 1 : 0;
    const CLK = document.getElementById('dff-input-clk')?.checked ? 1 : 0;
    const currentQ = sequentialState['d-flipflop'].Q;
    
    let nextQ = currentQ; // Default: hold state
    
    // Check for clock edge (positive edge triggered)
    if (CLK === 1 && clockState === 0) {
        // Positive edge detected: Q = D
        nextQ = D;
    }
    
    // Update clock state
    clockState = CLK;
    
    // Update state
    sequentialState['d-flipflop'].prevQ = sequentialState['d-flipflop'].Q;
    sequentialState['d-flipflop'].Q = nextQ;
    
    // Update display toggle
    document.getElementById('dff-current-q').checked = nextQ === 1;
    
    return nextQ;
}

// JK Flip-Flop calculation
function calculateJKFlipFlop() {
    const J = document.getElementById('jk-input-j')?.checked ? 1 : 0;
    const K = document.getElementById('jk-input-k')?.checked ? 1 : 0;
    const CLK = document.getElementById('jk-input-clk')?.checked ? 1 : 0;
    const currentQ = sequentialState['jk-flipflop'].Q;
    
    let nextQ = currentQ; // Default: hold state
    
    // Check for clock edge (positive edge triggered)
    if (CLK === 1 && clockState === 0) {
        // Positive edge detected
        if (J === 1 && K === 0) {
            // Set: Q=1
            nextQ = 1;
        } else if (J === 0 && K === 1) {
            // Reset: Q=0
            nextQ = 0;
        } else if (J === 1 && K === 1) {
            // Toggle: Q = Q'
            nextQ = currentQ === 1 ? 0 : 1;
        }
        // J=0, K=0: Hold state (already set as default)
    }
    
    // Update clock state
    clockState = CLK;
    
    // Update state
    sequentialState['jk-flipflop'].prevQ = sequentialState['jk-flipflop'].Q;
    sequentialState['jk-flipflop'].Q = nextQ;
    
    // Update display toggle
    document.getElementById('jk-current-q').checked = nextQ === 1;
    
    return nextQ;
}

// Generate sequential circuit diagram
function generateSequentialCircuit() {
    const container = document.getElementById('sequential-circuit-container');
    container.innerHTML = '';
    
    switch(currentSequentialComponent) {
        case 'sr-latch':
            generateSRLatchCircuit();
            break;
        case 'd-latch':
            generateDLatchCircuit();
            break;
        case 'd-flipflop':
            generateDFlipFlopCircuit();
            break;
        case 'jk-flipflop':
            generateJKFlipFlopCircuit();
            break;
    }
}

// Generate SR Latch circuit
function generateSRLatchCircuit() {
    const container = document.getElementById('sequential-circuit-container');
    
    const circuitDiv = document.createElement('div');
    circuitDiv.className = 'latch-circuit';
    circuitDiv.innerHTML = `
        <!-- First NAND gate -->
        <div class="nand-gate" style="top: 40px; left: 50px;">
            NAND
        </div>
        
        <!-- Second NAND gate -->
        <div class="nand-gate" style="top: 120px; left: 50px;">
            NAND
        </div>
        
        <!-- Input S -->
        <div class="sequential-node" id="sr-node-s" style="top: 40px; left: 10px;">S</div>
        <div class="sequential-input-line" id="sr-line-s" style="top: 50px; left: 40px; width: 20px;"></div>
        
        <!-- Input R -->
        <div class="sequential-node" id="sr-node-r" style="top: 120px; left: 10px;">R</div>
        <div class="sequential-input-line" id="sr-line-r" style="top: 130px; left: 40px; width: 20px;"></div>
        
        <!-- Output Q -->
        <div class="sequential-node" id="sr-node-q" style="top: 40px; right: 10px;">Q</div>
        <div class="sequential-output-line" id="sr-line-q" style="top: 50px; right: 40px; width: 20px;"></div>
        
        <!-- Output Q' -->
        <div class="sequential-node" id="sr-node-qbar" style="top: 120px; right: 10px;">Q'</div>
        <div class="sequential-output-line" id="sr-line-qbar" style="top: 130px; right: 40px; width: 20px;"></div>
        
        <!-- Feedback connections -->
        <div class="circuit-line" style="top: 80px; left: 130px; width: 6px; height: 40px; transform: none;"></div>
        <div class="circuit-line" style="top: 80px; right: 130px; width: 6px; height: 40px; transform: none;"></div>
    `;
    
    container.appendChild(circuitDiv);
    updateSequentialCircuit();
}

// Generate D Latch circuit
function generateDLatchCircuit() {
    const container = document.getElementById('sequential-circuit-container');
    
    const circuitDiv = document.createElement('div');
    circuitDiv.className = 'flipflop-circuit';
    circuitDiv.innerHTML = `
        <!-- Latch body -->
        <div class="flipflop-body">D Latch</div>
        
        <!-- Input D -->
        <div class="sequential-node" id="dl-node-d" style="top: 60px; left: 10px;">D</div>
        <div class="sequential-input-line" id="dl-line-d" style="top: 70px; left: 40px; width: 60px;"></div>
        
        <!-- Input E (Enable) -->
        <div class="sequential-node" id="dl-node-e" style="top: 140px; left: 10px;">E</div>
        <div class="sequential-input-line" id="dl-line-e" style="top: 150px; left: 40px; width: 60px;"></div>
        
        <!-- Output Q -->
        <div class="sequential-node" id="dl-node-q" style="top: 100px; right: 10px;">Q</div>
        <div class="sequential-output-line" id="dl-line-q" style="top: 110px; right: 40px; width: 60px;"></div>
        
        <!-- Clock symbol for Enable -->
        <div class="clock-symbol" style="top: 140px; left: 60px;"></div>
    `;
    
    container.appendChild(circuitDiv);
    updateSequentialCircuit();
}

// Generate D Flip-Flop circuit
function generateDFlipFlopCircuit() {
    const container = document.getElementById('sequential-circuit-container');
    
    const circuitDiv = document.createElement('div');
    circuitDiv.className = 'flipflop-circuit';
    circuitDiv.innerHTML = `
        <!-- Flip-flop body -->
        <div class="flipflop-body">D FF</div>
        
        <!-- Input D -->
        <div class="sequential-node" id="dff-node-d" style="top: 80px; left: 10px;">D</div>
        <div class="sequential-input-line" id="dff-line-d" style="top: 90px; left: 40px; width: 60px;"></div>
        
        <!-- Clock input -->
        <div class="sequential-node" id="dff-node-clk" style="top: 160px; left: 10px;">CLK</div>
        <div class="sequential-input-line" id="dff-line-clk" style="top: 170px; left: 40px; width: 60px;"></div>
        
        <!-- Output Q -->
        <div class="sequential-node" id="dff-node-q" style="top: 120px; right: 10px;">Q</div>
        <div class="sequential-output-line" id="dff-line-q" style="top: 130px; right: 40px; width: 60px;"></div>
        
        <!-- Clock edge indicator -->
        <div class="clock-symbol" style="top: 160px; left: 60px;"></div>
    `;
    
    container.appendChild(circuitDiv);
    updateSequentialCircuit();
}

// Generate JK Flip-Flop circuit
function generateJKFlipFlopCircuit() {
    const container = document.getElementById('sequential-circuit-container');
    
    const circuitDiv = document.createElement('div');
    circuitDiv.className = 'flipflop-circuit';
    circuitDiv.innerHTML = `
        <!-- Flip-flop body -->
        <div class="flipflop-body">JK FF</div>
        
        <!-- Input J -->
        <div class="sequential-node" id="jk-node-j" style="top: 60px; left: 10px;">J</div>
        <div class="sequential-input-line" id="jk-line-j" style="top: 70px; left: 40px; width: 60px;"></div>
        
        <!-- Clock input -->
        <div class="sequential-node" id="jk-node-clk" style="top: 120px; left: 10px;">CLK</div>
        <div class="sequential-input-line" id="jk-line-clk" style="top: 130px; left: 40px; width: 60px;"></div>
        
        <!-- Input K -->
        <div class="sequential-node" id="jk-node-k" style="top: 180px; left: 10px;">K</div>
        <div class="sequential-input-line" id="jk-line-k" style="top: 190px; left: 40px; width: 60px;"></div>
        
        <!-- Output Q -->
        <div class="sequential-node" id="jk-node-q" style="top: 120px; right: 10px;">Q</div>
        <div class="sequential-output-line" id="jk-line-q" style="top: 130px; right: 40px; width: 60px;"></div>
        
        <!-- Clock edge indicator -->
        <div class="clock-symbol" style="top: 120px; left: 60px;"></div>
    `;
    
    container.appendChild(circuitDiv);
    updateSequentialCircuit();
}

// Update circuit visualization based on current states
function updateSequentialCircuit() {
    if (!currentSequentialComponent) return;
    
    // Get current states
    const state = sequentialState[currentSequentialComponent];
    const inputs = getCurrentInputs();
    
    // Update nodes and lines based on component type
    switch(currentSequentialComponent) {
        case 'sr-latch':
            updateSRLatchCircuit(inputs, state);
            break;
        case 'd-latch':
            updateDLatchCircuit(inputs, state);
            break;
        case 'd-flipflop':
            updateDFlipFlopCircuit(inputs, state);
            break;
        case 'jk-flipflop':
            updateJKFlipFlopCircuit(inputs, state);
            break;
    }
}

// Get current input values
function getCurrentInputs() {
    const inputs = {};
    
    switch(currentSequentialComponent) {
        case 'sr-latch':
            inputs.S = document.getElementById('sr-input-s')?.checked ? 1 : 0;
            inputs.R = document.getElementById('sr-input-r')?.checked ? 1 : 0;
            break;
        case 'd-latch':
            inputs.D = document.getElementById('dl-input-d')?.checked ? 1 : 0;
            inputs.E = document.getElementById('dl-input-e')?.checked ? 1 : 0;
            break;
        case 'd-flipflop':
            inputs.D = document.getElementById('dff-input-d')?.checked ? 1 : 0;
            inputs.CLK = document.getElementById('dff-input-clk')?.checked ? 1 : 0;
            break;
        case 'jk-flipflop':
            inputs.J = document.getElementById('jk-input-j')?.checked ? 1 : 0;
            inputs.K = document.getElementById('jk-input-k')?.checked ? 1 : 0;
            inputs.CLK = document.getElementById('jk-input-clk')?.checked ? 1 : 0;
            break;
    }
    
    return inputs;
}

// Update SR Latch circuit visualization
function updateSRLatchCircuit(inputs, state) {
    // Update input nodes
    document.getElementById('sr-node-s').className = 
        `sequential-node ${inputs.S ? 'active' : ''}`;
    document.getElementById('sr-node-r').className = 
        `sequential-node ${inputs.R ? 'active' : ''}`;
    
    // Update output nodes
    document.getElementById('sr-node-q').className = 
        `sequential-node ${state.Q ? 'active' : ''}`;
    document.getElementById('sr-node-qbar').className = 
        `sequential-node ${state.Qbar ? 'active' : ''}`;
    
    // Update lines
    document.getElementById('sr-line-s').className = 
        `sequential-input-line ${inputs.S ? 'active' : ''}`;
    document.getElementById('sr-line-r').className = 
        `sequential-input-line ${inputs.R ? 'active' : ''}`;
    document.getElementById('sr-line-q').className = 
        `sequential-output-line ${state.Q ? 'active' : ''}`;
    document.getElementById('sr-line-qbar').className = 
        `sequential-output-line ${state.Qbar ? 'active' : ''}`;
}

// Update D Latch circuit visualization
function updateDLatchCircuit(inputs, state) {
    // Update input nodes
    document.getElementById('dl-node-d').className = 
        `sequential-node ${inputs.D ? 'active' : ''}`;
    document.getElementById('dl-node-e').className = 
        `sequential-node ${inputs.E ? 'active' : ''}`;
    
    // Update output node
    document.getElementById('dl-node-q').className = 
        `sequential-node ${state.Q ? 'active' : ''}`;
    
    // Update lines
    document.getElementById('dl-line-d').className = 
        `sequential-input-line ${inputs.D ? 'active' : ''}`;
    document.getElementById('dl-line-e').className = 
        `sequential-input-line ${inputs.E ? 'active' : ''}`;
    document.getElementById('dl-line-q').className = 
        `sequential-output-line ${state.Q ? 'active' : ''}`;
}

// Update D Flip-Flop circuit visualization
function updateDFlipFlopCircuit(inputs, state) {
    // Update input nodes
    document.getElementById('dff-node-d').className = 
        `sequential-node ${inputs.D ? 'active' : ''}`;
    document.getElementById('dff-node-clk').className = 
        `sequential-node ${inputs.CLK ? 'active' : ''}`;
    
    // Update output node
    document.getElementById('dff-node-q').className = 
        `sequential-node ${state.Q ? 'active' : ''}`;
    
    // Update lines
    document.getElementById('dff-line-d').className = 
        `sequential-input-line ${inputs.D ? 'active' : ''}`;
    document.getElementById('dff-line-clk').className = 
        `sequential-input-line ${inputs.CLK ? 'active' : ''}`;
    document.getElementById('dff-line-q').className = 
        `sequential-output-line ${state.Q ? 'active' : ''}`;
}

// Update JK Flip-Flop circuit visualization
function updateJKFlipFlopCircuit(inputs, state) {
    // Update input nodes
    document.getElementById('jk-node-j').className = 
        `sequential-node ${inputs.J ? 'active' : ''}`;
    document.getElementById('jk-node-k').className = 
        `sequential-node ${inputs.K ? 'active' : ''}`;
    document.getElementById('jk-node-clk').className = 
        `sequential-node ${inputs.CLK ? 'active' : ''}`;
    
    // Update output node
    document.getElementById('jk-node-q').className = 
        `sequential-node ${state.Q ? 'active' : ''}`;
    
    // Update lines
    document.getElementById('jk-line-j').className = 
        `sequential-input-line ${inputs.J ? 'active' : ''}`;
    document.getElementById('jk-line-k').className = 
        `sequential-input-line ${inputs.K ? 'active' : ''}`;
    document.getElementById('jk-line-clk').className = 
        `sequential-input-line ${inputs.CLK ? 'active' : ''}`;
    document.getElementById('jk-line-q').className = 
        `sequential-output-line ${state.Q ? 'active' : ''}`;
}

// Show sequential analysis
function showSequentialAnalysis() {
    const container = document.getElementById('sequential-steps-container');
    const analysisDiv = document.getElementById('sequential-analysis');
    
    if (!currentSequentialComponent) {
        analysisDiv.style.display = 'none';
        return;
    }
    
    analysisDiv.style.display = 'block';
    container.innerHTML = '';
    
    switch(currentSequentialComponent) {
        case 'sr-latch':
            showSRLatchAnalysis(container);
            break;
        case 'd-latch':
            showDLatchAnalysis(container);
            break;
        case 'd-flipflop':
            showDFlipFlopAnalysis(container);
            break;
        case 'jk-flipflop':
            showJKFlipFlopAnalysis(container);
            break;
    }
}

// Show SR Latch analysis
function showSRLatchAnalysis(container) {
    const inputs = getCurrentInputs();
    const state = sequentialState['sr-latch'];
    
    const steps = `
        <div class="sequential-step active">
            <div class="calculation-title">SR Latch Operation Analysis</div>
            <div class="calculation-content">
                <div><strong>Step 1: Current Inputs</strong></div>
                <div class="conversion-step">
                    Set (S) = <span class="state-${inputs.S}">${inputs.S}</span><br>
                    Reset (R) = <span class="state-${inputs.R}">${inputs.R}</span>
                </div>
                
                <div><strong>Step 2: Current State</strong></div>
                <div class="conversion-step">
                    Q = <span class="state-${state.prevQ}">${state.prevQ}</span><br>
                    Q' = <span class="state-${state.Qbar}">${state.Qbar}</span>
                </div>
                
                <div><strong>Step 3: Logic Analysis</strong></div>
                <div class="conversion-step">
    `;
    
    let analysis = '';
    if (inputs.S === 1 && inputs.R === 0) {
        analysis = `S=1, R=0  Set operation:<br>
                   Q = 1, Q' = 0`;
    } else if (inputs.S === 0 && inputs.R === 1) {
        analysis = `S=0, R=1  Reset operation:<br>
                   Q = 0, Q' = 1`;
    } else if (inputs.S === 0 && inputs.R === 0) {
        analysis = `S=0, R=0  Hold state:<br>
                   Q remains ${state.prevQ}, Q' remains ${state.Qbar}`;
    } else {
        analysis = `S=1, R=1  Invalid state:<br>
                   Both Q and Q' become 1 (violates complement rule)`;
    }
    
    const final = `
                ${analysis}
                </div>
                
                <div><strong>Step 4: Next State</strong></div>
                <div class="conversion-step active">
                    Next Q = <span class="state-${state.Q}">${state.Q}</span><br>
                    Next Q' = <span class="state-${state.Qbar}">${state.Qbar}</span>
                </div>
                
                <div><strong>Step 5: Characteristic Equation</strong></div>
                <div class="conversion-step">
                    Q+ = S + R'Q<br>
                    (Next Q = Set OR (NOT Reset AND Current Q))
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = steps + final;
}

// Show D Latch analysis
function showDLatchAnalysis(container) {
    const inputs = getCurrentInputs();
    const state = sequentialState['d-latch'];
    
    const analysis = `
        <div class="sequential-step active">
            <div class="calculation-title">D Latch Operation Analysis</div>
            <div class="calculation-content">
                <div><strong>Step 1: Current Inputs</strong></div>
                <div class="conversion-step">
                    Data (D) = <span class="state-${inputs.D}">${inputs.D}</span><br>
                    Enable (E) = <span class="state-${inputs.E}">${inputs.E}</span>
                </div>
                
                <div><strong>Step 2: Current State</strong></div>
                <div class="conversion-step">
                    Q = <span class="state-${state.prevQ}">${state.prevQ}</span>
                </div>
                
                <div><strong>Step 3: Operation Mode</strong></div>
                <div class="conversion-step">
    `;
    
    let mode = '';
    if (inputs.E === 1) {
        mode = `Enable = 1  Transparent mode:<br>
               Q follows D = ${inputs.D}`;
    } else {
        mode = `Enable = 0  Hold mode:<br>
               Q maintains previous state = ${state.prevQ}`;
    }
    
    const final = `
                ${mode}
                </div>
                
                <div><strong>Step 4: Next State</strong></div>
                <div class="conversion-step active">
                    Next Q = <span class="state-${state.Q}">${state.Q}</span>
                </div>
                
                <div><strong>Step 5: Characteristic Table</strong></div>
                <div class="conversion-step">
                    E | D | Q+<br>
                    ---|----|-----<br>
                    0 | X | Q (Hold)<br>
                    1 | 0 | 0<br>
                    1 | 1 | 1
                </div>
                
                <div><strong>Step 6: Characteristic Equation</strong></div>
                <div class="conversion-step">
                    Q+ = ED + E'Q
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = analysis + final;
}

// Show D Flip-Flop analysis
function showDFlipFlopAnalysis(container) {
    const inputs = getCurrentInputs();
    const state = sequentialState['d-flipflop'];
    const clkEdge = (inputs.CLK === 1 && clockState === 0) ? '' : 'No';
    
    const analysis = `
        <div class="sequential-step active">
            <div class="calculation-title">D Flip-Flop Operation Analysis</div>
            <div class="calculation-content">
                <div><strong>Step 1: Current Inputs</strong></div>
                <div class="conversion-step">
                    Data (D) = <span class="state-${inputs.D}">${inputs.D}</span><br>
                    Clock (CLK) = <span class="state-${inputs.CLK}">${inputs.CLK}</span><br>
                    Clock Edge: <span class="clock-edge">${clkEdge}</span>
                </div>
                
                <div><strong>Step 2: Current State</strong></div>
                <div class="conversion-step">
                    Q = <span class="state-${state.prevQ}">${state.prevQ}</span>
                </div>
                
                <div><strong>Step 3: Edge Detection</strong></div>
                <div class="conversion-step">
    `;
    
    let edgeAnalysis = '';
    if (clkEdge === '') {
        edgeAnalysis = `Positive clock edge detected!<br>
                       Q will be updated to D = ${inputs.D}`;
    } else {
        edgeAnalysis = `No clock edge detected.<br>
                       Q maintains current state = ${state.prevQ}`;
    }
    
    const final = `
                ${edgeAnalysis}
                </div>
                
                <div><strong>Step 4: Next State</strong></div>
                <div class="conversion-step active">
                    Next Q = <span class="state-${state.Q}">${state.Q}</span>
                </div>
                
                <div><strong>Step 5: Truth Table</strong></div>
                <div class="conversion-step">
                    CLK | D | Q+<br>
                    -----|----|-----<br>
                     | 0 | 0<br>
                     | 1 | 1<br>
                    Otherwise | X | Q (Hold)
                </div>
                
                <div><strong>Step 6: Characteristic Equation</strong></div>
                <div class="conversion-step">
                    Q+ = D (on clock edge)
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = analysis + final;
}

// Show JK Flip-Flop analysis
function showJKFlipFlopAnalysis(container) {
    const inputs = getCurrentInputs();
    const state = sequentialState['jk-flipflop'];
    const clkEdge = (inputs.CLK === 1 && clockState === 0) ? '' : 'No';
    
    const analysis = `
        <div class="sequential-step active">
            <div class="calculation-title">JK Flip-Flop Operation Analysis</div>
            <div class="calculation-content">
                <div><strong>Step 1: Current Inputs</strong></div>
                <div class="conversion-step">
                    J = <span class="state-${inputs.J}">${inputs.J}</span><br>
                    K = <span class="state-${inputs.K}">${inputs.K}</span><br>
                    Clock (CLK) = <span class="state-${inputs.CLK}">${inputs.CLK}</span><br>
                    Clock Edge: <span class="clock-edge">${clkEdge}</span>
                </div>
                
                <div><strong>Step 2: Current State</strong></div>
                <div class="conversion-step">
                    Q = <span class="state-${state.prevQ}">${state.prevQ}</span>
                </div>
                
                <div><strong>Step 3: Operation Mode</strong></div>
                <div class="conversion-step">
    `;
    
    let mode = '';
    if (clkEdge === '') {
        if (inputs.J === 1 && inputs.K === 0) {
            mode = `J=1, K=0  Set operation:<br>
                   Q+ = 1`;
        } else if (inputs.J === 0 && inputs.K === 1) {
            mode = `J=0, K=1  Reset operation:<br>
                   Q+ = 0`;
        } else if (inputs.J === 1 && inputs.K === 1) {
            mode = `J=1, K=1  Toggle operation:<br>
                   Q+ = Q' = ${state.prevQ === 1 ? 0 : 1}`;
        } else {
            mode = `J=0, K=0  Hold operation:<br>
                   Q+ = Q = ${state.prevQ}`;
        }
    } else {
        mode = `No clock edge detected:<br>
               Q maintains current state = ${state.prevQ}`;
    }
    
    const final = `
                ${mode}
                </div>
                
                <div><strong>Step 4: Next State</strong></div>
                <div class="conversion-step active">
                    Next Q = <span class="state-${state.Q}">${state.Q}</span>
                </div>
                
                <div><strong>Step 5: Truth Table</strong></div>
                <div class="conversion-step">
                    CLK | J | K | Q+<br>
                    -----|----|----|-----<br>
                     | 0 | 0 | Q (Hold)<br>
                     | 0 | 1 | 0 (Reset)<br>
                     | 1 | 0 | 1 (Set)<br>
                     | 1 | 1 | Q' (Toggle)
                </div>
                
                <div><strong>Step 6: Characteristic Equation</strong></div>
                <div class="conversion-step">
                    Q+ = JQ' + K'Q
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = analysis + final;
    
    // Generate state diagram for JK flip-flop
    generateStateDiagram();
}

// Generate state diagram
function generateStateDiagram() {
    const container = document.getElementById('state-diagram');
    const stateDiv = document.getElementById('state-diagram-container');
    
    if (currentSequentialComponent === 'jk-flipflop') {
        stateDiv.style.display = 'block';
        
        const inputs = getCurrentInputs();
        const currentQ = sequentialState['jk-flipflop'].prevQ;
        const nextQ = sequentialState['jk-flipflop'].Q;
        
        container.innerHTML = `
            <div class="state-diagram-container">
                <div class="state-row">
                    <div class="state-circle ${currentQ === 0 ? 'active' : ''}">
                        Q=0
                    </div>
                    <div class="transition-arrow"></div>
                    <div class="state-circle ${nextQ === 0 ? 'active' : ''}">
                        Q+=0
                    </div>
                </div>
                <div class="state-row">
                    <div class="state-circle ${currentQ === 1 ? 'active' : ''}">
                        Q=1
                    </div>
                    <div class="transition-arrow"></div>
                    <div class="state-circle ${nextQ === 1 ? 'active' : ''}">
                        Q+=1
                    </div>
                </div>
                <div class="state-row mt-3">
                    <div class="gate-description">
                        <strong>Transition Conditions:</strong><br>
                        J=${inputs.J}, K=${inputs.K}, CLK Edge=${inputs.CLK === 1 && clockState === 0 ? 'Yes' : 'No'}<br>
                        Current transition: Q=${currentQ}  Q+=${nextQ}
                    </div>
                </div>
            </div>
        `;
    } else {
        stateDiv.style.display = 'none';
    }
}

// Show truth table for sequential component
function showSequentialTruthTable() {
    const tableContainer = document.getElementById('sequential-truth-table-container');
    const table = document.getElementById('sequential-truth-table');
    const title = document.getElementById('sequential-truth-table-title');
    
    tableContainer.style.display = 'block';
    table.innerHTML = '';
    
    switch(currentSequentialComponent) {
        case 'sr-latch':
            title.textContent = 'SR Latch Truth Table';
            generateSRLatchTruthTable(table);
            break;
        case 'd-latch':
            title.textContent = 'D Latch Truth Table';
            generateDLatchTruthTable(table);
            break;
        case 'd-flipflop':
            title.textContent = 'D Flip-Flop Truth Table';
            generateDFlipFlopTruthTable(table);
            break;
        case 'jk-flipflop':
            title.textContent = 'JK Flip-Flop Truth Table';
            generateJKFlipFlopTruthTable(table);
            break;
    }
    
    addLog(`Displayed ${getComponentName(currentSequentialComponent)} truth table`, 'info');
}

// Generate SR Latch truth table
function generateSRLatchTruthTable(table) {
    // Header
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th>S</th>
        <th>R</th>
        <th>Q</th>
        <th>Q+</th>
        <th>Operation</th>
    `;
    table.appendChild(headerRow);
    
    // Rows
    const rows = [
        [0, 0, 0, 0, 'Hold'],
        [0, 0, 1, 1, 'Hold'],
        [0, 1, 0, 0, 'Reset'],
        [0, 1, 1, 0, 'Reset'],
        [1, 0, 0, 1, 'Set'],
        [1, 0, 1, 1, 'Set'],
        [1, 1, 0, 1, 'Invalid'],
        [1, 1, 1, 1, 'Invalid']
    ];
    
    rows.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach((cell, index) => {
            const td = document.createElement('td');
            td.textContent = cell;
            
            if (index < 2) {
                // S and R columns
                td.className = cell === 1 ? 'active' : 'inactive';
            } else if (index === 2 || index === 3) {
                // Q and Q+ columns
                td.className = cell === 1 ? 'active' : 'inactive';
            }
            
            tr.appendChild(td);
        });
        table.appendChild(tr);
    });
}

// Generate D Latch truth table
function generateDLatchTruthTable(table) {
    // Header
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th>E</th>
        <th>D</th>
        <th>Q</th>
        <th>Q+</th>
        <th>Operation</th>
    `;
    table.appendChild(headerRow);
    
    // Rows
    const rows = [
        [0, 0, 0, 0, 'Hold'],
        [0, 0, 1, 1, 'Hold'],
        [0, 1, 0, 0, 'Hold'],
        [0, 1, 1, 1, 'Hold'],
        [1, 0, 0, 0, 'Reset'],
        [1, 0, 1, 0, 'Reset'],
        [1, 1, 0, 1, 'Set'],
        [1, 1, 1, 1, 'Set']
    ];
    
    rows.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach((cell, index) => {
            const td = document.createElement('td');
            td.textContent = cell;
            
            if (index < 2) {
                // E and D columns
                td.className = cell === 1 ? 'active' : 'inactive';
            } else if (index === 2 || index === 3) {
                // Q and Q+ columns
                td.className = cell === 1 ? 'active' : 'inactive';
            }
            
            tr.appendChild(td);
        });
        table.appendChild(tr);
    });
}

// Generate D Flip-Flop truth table
function generateDFlipFlopTruthTable(table) {
    // Header
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th>CLK</th>
        <th>D</th>
        <th>Q</th>
        <th>Q+</th>
        <th>Operation</th>
    `;
    table.appendChild(headerRow);
    
    // Rows (assuming positive edge triggered)
    const rows = [
        ['01', 0, 0, 0, 'Reset'],
        ['01', 0, 1, 0, 'Reset'],
        ['01', 1, 0, 1, 'Set'],
        ['01', 1, 1, 1, 'Set'],
        ['0', 0, 0, 0, 'Hold'],
        ['0', 0, 1, 1, 'Hold'],
        ['0', 1, 0, 0, 'Hold'],
        ['0', 1, 1, 1, 'Hold'],
        ['1', 0, 0, 0, 'Hold'],
        ['1', 0, 1, 1, 'Hold'],
        ['1', 1, 0, 0, 'Hold'],
        ['1', 1, 1, 1, 'Hold'],
        ['10', 0, 0, 0, 'Hold'],
        ['10', 0, 1, 1, 'Hold'],
        ['10', 1, 0, 0, 'Hold'],
        ['10', 1, 1, 1, 'Hold']
    ];
    
    rows.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach((cell, index) => {
            const td = document.createElement('td');
            td.textContent = cell;
            
            if (index === 0) {
                // CLK column
                if (cell === '01') {
                    td.style.color = 'var(--danger-color)';
                    td.style.fontWeight = 'bold';
                }
            } else if (index === 1) {
                // D column
                td.className = cell === 1 ? 'active' : 'inactive';
            } else if (index === 2 || index === 3) {
                // Q and Q+ columns
                if (typeof cell === 'number') {
                    td.className = cell === 1 ? 'active' : 'inactive';
                }
            }
            
            tr.appendChild(td);
        });
        table.appendChild(tr);
    });
}

// Generate JK Flip-Flop truth table
function generateJKFlipFlopTruthTable(table) {
    // Header
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th>CLK</th>
        <th>J</th>
        <th>K</th>
        <th>Q</th>
        <th>Q+</th>
        <th>Operation</th>
    `;
    table.appendChild(headerRow);
    
    // Rows (assuming positive edge triggered)
    const rows = [
        ['01', 0, 0, 0, 0, 'Hold'],
        ['01', 0, 0, 1, 1, 'Hold'],
        ['01', 0, 1, 0, 0, 'Reset'],
        ['01', 0, 1, 1, 0, 'Reset'],
        ['01', 1, 0, 0, 1, 'Set'],
        ['01', 1, 0, 1, 1, 'Set'],
        ['01', 1, 1, 0, 1, 'Toggle'],
        ['01', 1, 1, 1, 0, 'Toggle'],
        ['0', 0, 0, 0, 0, 'Hold'],
        ['0', 0, 0, 1, 1, 'Hold'],
        ['0', 0, 1, 0, 0, 'Hold'],
        ['0', 0, 1, 1, 1, 'Hold'],
        ['0', 1, 0, 0, 0, 'Hold'],
        ['0', 1, 0, 1, 1, 'Hold'],
        ['0', 1, 1, 0, 0, 'Hold'],
        ['0', 1, 1, 1, 1, 'Hold'],
        ['1', 0, 0, 0, 0, 'Hold'],
        ['1', 0, 0, 1, 1, 'Hold'],
        ['1', 0, 1, 0, 0, 'Hold'],
        ['1', 0, 1, 1, 1, 'Hold'],
        ['1', 1, 0, 0, 0, 'Hold'],
        ['1', 1, 0, 1, 1, 'Hold'],
        ['1', 1, 1, 0, 0, 'Hold'],
        ['1', 1, 1, 1, 1, 'Hold'],
        ['10', 0, 0, 0, 0, 'Hold'],
        ['10', 0, 0, 1, 1, 'Hold'],
        ['10', 0, 1, 0, 0, 'Hold'],
        ['10', 0, 1, 1, 1, 'Hold'],
        ['10', 1, 0, 0, 0, 'Hold'],
        ['10', 1, 0, 1, 1, 'Hold'],
        ['10', 1, 1, 0, 0, 'Hold'],
        ['10', 1, 1, 1, 1, 'Hold']
    ];
    
    rows.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach((cell, index) => {
            const td = document.createElement('td');
            td.textContent = cell;
            
            if (index === 0) {
                // CLK column
                if (cell === '01') {
                    td.style.color = 'var(--danger-color)';
                    td.style.fontWeight = 'bold';
                }
            } else if (index === 1 || index === 2) {
                // J and K columns
                if (typeof cell === 'number') {
                    td.className = cell === 1 ? 'active' : 'inactive';
                }
            } else if (index === 3 || index === 4) {
                // Q and Q+ columns
                if (typeof cell === 'number') {
                    td.className = cell === 1 ? 'active' : 'inactive';
                }
            }
            
            tr.appendChild(td);
        });
        table.appendChild(tr);
    });
}

// Reset sequential component
function resetSequential() {
    // Reset all states
    for (const component in sequentialState) {
        sequentialState[component] = {
            Q: 0,
            Qbar: 1,
            prevQ: 0
        };
    }
    
    // Reset clock
    clockState = 0;
    
    // Reset input toggles
    const allToggles = [
        'sr-input-s', 'sr-input-r',
        'dl-input-d', 'dl-input-e',
        'dff-input-d', 'dff-input-clk',
        'jk-input-j', 'jk-input-k', 'jk-input-clk'
    ];
    
    allToggles.forEach(id => {
        const toggle = document.getElementById(id);
        if (toggle) toggle.checked = false;
    });
    
    // Update displays
    document.getElementById('sequential-result').textContent = '0';
    document.getElementById('sequential-next-result').textContent = '-';
    
    // Update circuit
    updateSequentialCircuit();
    
    // Clear analysis
    document.getElementById('sequential-steps-container').innerHTML = '';
    document.getElementById('sequential-truth-table-container').style.display = 'none';
    document.getElementById('state-diagram-container').style.display = 'none';
    
    addLog('Reset all sequential components', 'info');
}

// Animate sequence of operations
function animateSequentialSequence() {
    if (isSequentialAnimating || !currentSequentialComponent) return;
    
    isSequentialAnimating = true;
    sequenceStep = 0;
    const steps = getSequenceSteps();
    
    animateNextStep(steps);
}

// Get sequence steps based on component
function getSequenceSteps() {
    switch(currentSequentialComponent) {
        case 'sr-latch':
            return [
                { S: 0, R: 0, desc: 'Hold state' },
                { S: 1, R: 0, desc: 'Set operation' },
                { S: 0, R: 0, desc: 'Hold set state' },
                { S: 0, R: 1, desc: 'Reset operation' },
                { S: 0, R: 0, desc: 'Hold reset state' },
                { S: 1, R: 1, desc: 'Invalid state' }
            ];
        case 'd-latch':
            return [
                { D: 0, E: 0, desc: 'Hold with E=0, D=0' },
                { D: 1, E: 0, desc: 'Hold with E=0, D=1' },
                { D: 1, E: 1, desc: 'Transparent: Q follows D=1' },
                { D: 0, E: 1, desc: 'Transparent: Q follows D=0' },
                { D: 1, E: 0, desc: 'Hold previous state' }
            ];
        case 'd-flipflop':
            return [
                { D: 0, CLK: 0, desc: 'No clock edge, hold' },
                { D: 1, CLK: 0, desc: 'No clock edge, hold' },
                { D: 1, CLK: 1, desc: 'Clock edge: Q = D = 1' },
                { D: 0, CLK: 1, desc: 'No edge while CLK=1, hold' },
                { D: 0, CLK: 0, desc: 'Clock falling edge, hold' },
                { D: 1, CLK: 0, desc: 'No edge, hold' },
                { D: 1, CLK: 1, desc: 'Clock edge: Q = D = 1' }
            ];
        case 'jk-flipflop':
            return [
                { J: 0, K: 0, CLK: 0, desc: 'Hold state' },
                { J: 1, K: 0, CLK: 1, desc: 'Set on clock edge' },
                { J: 0, K: 0, CLK: 0, desc: 'Hold set state' },
                { J: 0, K: 1, CLK: 1, desc: 'Reset on clock edge' },
                { J: 0, K: 0, CLK: 0, desc: 'Hold reset state' },
                { J: 1, K: 1, CLK: 1, desc: 'Toggle on clock edge' },
                { J: 1, K: 1, CLK: 1, desc: 'Toggle again' }
            ];
        default:
            return [];
    }
}

// Animate next step in sequence
function animateNextStep(steps, delay = 1500) {
    if (sequenceStep >= steps.length) {
        isSequentialAnimating = false;
        addLog('Sequence animation completed', 'info');
        return;
    }
    
    const step = steps[sequenceStep];
    const inputs = step;
    
    // Update input toggles
    updateInputTogglesForStep(inputs);
    
    // Calculate and update
    calculateSequential();
    
    // Show step description
    const analysisDiv = document.getElementById('sequential-analysis');
    const container = document.getElementById('sequential-steps-container');
    
    container.innerHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Animation Step ${sequenceStep + 1}/${steps.length}</div>
            <div class="calculation-content">
                <div><strong>Step Description:</strong> ${step.desc}</div>
                <div><strong>Inputs:</strong> ${JSON.stringify(inputs).replace(/[{}"]/g, '').replace(/:/g, '=')}</div>
                <div><strong>Current Q:</strong> ${sequentialState[currentSequentialComponent].prevQ}</div>
                <div><strong>Next Q:</strong> ${sequentialState[currentSequentialComponent].Q}</div>
            </div>
        </div>
    `;
    
    // Log the step
    addLog(`Animation step ${sequenceStep + 1}: ${step.desc}`, 'success');
    
    sequenceStep++;
    
    // Continue to next step
    setTimeout(() => animateNextStep(steps, delay), delay);
}

// Update input toggles for animation step
function updateInputTogglesForStep(inputs) {
    for (const [key, value] of Object.entries(inputs)) {
        const toggleId = `${currentSequentialComponent.split('-')[0]}-input-${key.toLowerCase()}`;
        const toggle = document.getElementById(toggleId);
        
        if (toggle) {
            toggle.checked = value === 1;
            
            // Trigger change event to update labels
            const event = new Event('change');
            toggle.dispatchEvent(event);
        }
    }
    
    // Special handling for clock edges
    if (currentSequentialComponent.includes('flipflop') && inputs.CLK !== undefined) {
        clockState = inputs.CLK === 1 ? 1 : 0;
    }
}

// Select Sequential Circuit-2 component
function selectSequential2Component(component) {
    currentSequential2Component = component;
    
    // Hide all input sections
    document.getElementById('t-flipflop-inputs').style.display = 'none';
    document.getElementById('register-storage-inputs').style.display = 'none';
    document.getElementById('shift-register-inputs').style.display = 'none';
    
    // Hide visualization sections
    document.getElementById('register-status-display').style.display = 'none';
    document.getElementById('shift-register-visualization').style.display = 'none';
    
    // Update description
    const descriptionDiv = document.getElementById('sequential2-description');
    
    switch(component) {
        case 't-flipflop':
            document.getElementById('t-flipflop-inputs').style.display = 'block';
            descriptionDiv.innerHTML = `
                <strong>T Flip-Flop (Toggle Flip-Flop):</strong><br>
                 Toggles output on clock edge when T=1<br>
                 Maintains state when T=0<br>
                 Characteristic Equation: Q<sub>next</sub> = T  Q<br>
                 Used in frequency dividers and counters
            `;
            visualizeRealisticTFlipFlop();
            break;
            
        case 'register-storage':
            document.getElementById('register-storage-inputs').style.display = 'block';
            document.getElementById('register-status-display').style.display = 'block';
            descriptionDiv.innerHTML = `
                <strong>Register Data Storage/Transfer:</strong><br>
                 Stores binary data temporarily<br>
                 Load: Load data from input<br>
                 Store: Store data internally<br>
                 Transfer: Move data between registers<br>
                 Clear: Reset register to all zeros
            `;
            updateRegisterDisplay();
            updateRegisterInterface();
            visualizeRealisticRegister();
            break;
            
        case 'shift-register':
            document.getElementById('shift-register-inputs').style.display = 'block';
            document.getElementById('shift-register-visualization').style.display = 'block';
            descriptionDiv.innerHTML = `
                <strong>Shift Register Operation:</strong><br>
                 Shifts data left or right on clock pulse<br>
                 Serial-in, Parallel-out (SIPO) operation<br>
                 Can be used for serial data conversion<br>
                 Applications: data storage, delay lines
            `;
            updateShiftRegisterInterface();
            initializeShiftRegister();
            visualizeRealisticShiftRegister();
            break;
    }
    
    // Update results display
    document.getElementById('sequential2-result').textContent = '-';
    document.getElementById('sequential2-next-result').textContent = '-';
    
    addLog(`Selected ${component} component`, 'info');
}

// Update register interface based on operation
function updateRegisterInterface() {
    const operation = document.getElementById('register-operation-select').value;
    const dataInputDiv = document.getElementById('register-data-input');
    const sourceSelectDiv = document.getElementById('register-source-select');
    
    if (operation === 'transfer') {
        dataInputDiv.style.display = 'none';
        sourceSelectDiv.style.display = 'block';
    } else {
        dataInputDiv.style.display = 'block';
        sourceSelectDiv.style.display = 'none';
    }
}

// Update shift register interface
function updateShiftRegisterInterface() {
    const direction = document.getElementById('shift-direction-select').value;
    const shiftInputDiv = document.getElementById('shift-input-control');
    const bidirectionalDiv = document.getElementById('bidirectional-controls');
    
    if (direction === 'bidirectional') {
        shiftInputDiv.style.display = 'block';
        bidirectionalDiv.style.display = 'block';
    } else {
        shiftInputDiv.style.display = 'none';
        bidirectionalDiv.style.display = 'none';
    }
}

// Initialize shift register with input data
function initializeShiftRegister() {
    const inputData = document.getElementById('shift-input-data').value;
    const size = parseInt(document.getElementById('shift-register-size-select').value);
    
    // Validate input
    if (!/^[01]+$/.test(inputData)) {
        alert('Please enter binary data (0s and 1s only)');
        document.getElementById('shift-input-data').value = '1101';
        shiftRegisterState = Array(size).fill(0);
        shiftRegisterState[0] = 1;
        shiftRegisterState[1] = 1;
        shiftRegisterState[3] = 1;
    } else {
        // Pad or truncate to match size
        const bits = inputData.split('').map(bit => parseInt(bit));
        shiftRegisterState = Array(size).fill(0);
        const copyLength = Math.min(size, bits.length);
        for (let i = 0; i < copyLength; i++) {
            shiftRegisterState[i] = bits[i];
        }
    }
    
    updateShiftRegisterDisplay();
}

// Calculate Sequential Circuit-2 operations
function calculateSequential2() {
    switch(currentSequential2Component) {
        case 't-flipflop':
            calculateTFlipFlop();
            break;
        case 'register-storage':
            calculateRegisterOperation();
            break;
        case 'shift-register':
            calculateShiftRegister();
            break;
    }
}

// T Flip-Flop Calculation
function calculateTFlipFlop() {
    const T = document.getElementById('tff-input-t').checked ? 1 : 0;
    const CLK = document.getElementById('tff-input-clk').checked ? 1 : 0;
    const PR = document.getElementById('tff-input-pr').checked ? 1 : 0;
    const CLR = document.getElementById('tff-input-clr').checked ? 1 : 0;
    const currentQ = tFlipFlopState.Q;
    
    let nextQ = currentQ;
    let resultMessage = '';
    
    // Check for preset and clear (active low)
    if (PR === 0) {
        nextQ = 1; // Preset overrides everything
        resultMessage = 'PRESET active: Q = 1';
    } else if (CLR === 0) {
        nextQ = 0; // Clear overrides everything
        resultMessage = 'CLEAR active: Q = 0';
    } else if (CLK === 1) { // Positive edge trigger (assuming edge detection)
        // Check for clock edge (from 0 to 1)
        if (T === 1) {
            nextQ = currentQ === 1 ? 0 : 1; // Toggle
            resultMessage = `T=1, CLK edge: Q toggles from ${currentQ} to ${nextQ}`;
        } else {
            nextQ = currentQ; // Hold
            resultMessage = `T=0: Q holds at ${currentQ}`;
        }
    } else {
        nextQ = currentQ; // No clock edge, hold
        resultMessage = `No CLK edge: Q holds at ${currentQ}`;
    }
    
    // Update state
    tFlipFlopState.prevQ = currentQ;
    tFlipFlopState.Q = nextQ;
    
    // Update display
    document.getElementById('tff-current-q').checked = nextQ === 1;
    document.getElementById('sequential2-result').textContent = currentQ;
    document.getElementById('sequential2-next-result').textContent = nextQ;
    
    // Show analysis
    const analysisDiv = document.getElementById('sequential2-analysis');
    const stepsContainer = document.getElementById('sequential2-steps-container');
    
    stepsContainer.innerHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">T Flip-Flop Operation Analysis</div>
            <div class="calculation-content">
                <div><strong>Inputs:</strong></div>
                <div>T = ${T}, CLK = ${CLK}, PR = ${PR}, CLR = ${CLR}</div>
                <div><strong>Current State:</strong> Q = ${currentQ}</div>
                <hr>
                <div><strong>Step 1: Check Preset/Clear</strong></div>
                <div>PR = ${PR} (${PR === 0 ? 'ACTIVE' : 'INACTIVE'}), CLR = ${CLR} (${CLR === 0 ? 'ACTIVE' : 'INACTIVE'})</div>
                <div>${PR === 0 ? ' PRESET active  Q = 1' : CLR === 0 ? ' CLEAR active  Q = 0' : ' No preset/clear override'}</div>
                
                <div class="mt-2"><strong>Step 2: Check Clock Edge</strong></div>
                <div>CLK = ${CLK} (${CLK === 1 ? 'CLOCK PULSE DETECTED' : 'NO CLOCK EDGE'})</div>
                <div>${CLK === 1 ? ' Clock edge detected' : ' No clock edge  Q holds'}</div>
                
                <div class="mt-2"><strong>Step 3: Apply T Input</strong></div>
                <div>T = ${T} (${T === 1 ? 'TOGGLE' : 'HOLD'})</div>
                <div>${T === 1 ? ` T=1  Q toggles: ${currentQ}  ${nextQ}` : ' T=0  Q holds current value'}</div>
                
                <div class="mt-2"><strong>Step 4: Calculate Next State</strong></div>
                <div><strong>Characteristic Equation:</strong> Q<sub>next</sub> = T  Q = ${T}  ${currentQ}</div>
                <div class="highlight-equation">Q<sub>next</sub> = ${T}  ${currentQ} = ${T ^ currentQ}</div>
                
                <div class="mt-2"><strong>Result:</strong></div>
                <div class="highlight-equation">${resultMessage}</div>
                <div><strong>Next State:</strong> Q<sup>+</sup> = ${nextQ}</div>
            </div>
        </div>
    `;
    
    analysisDiv.style.display = 'block';
    
    // Update circuit visualization
    visualizeRealisticTFlipFlop();
    
    addLog(`T Flip-Flop: ${resultMessage}`, 'success');
}

// Register Operation Calculation
function calculateRegisterOperation() {
    const operation = document.getElementById('register-operation-select').value;
    const size = parseInt(document.getElementById('register-size-select').value);
    const clk = document.getElementById('register-clk').checked ? 1 : 0;
    const enable = document.getElementById('register-enable').checked ? 1 : 0;
    
    let resultMessage = '';
    let affectedRegister = 'R1'; // Default
    
    if (enable === 0) {
        resultMessage = 'Register disabled (EN=0): No operation';
    } else if (clk === 0) {
        resultMessage = 'No clock pulse: Register holds current value';
    } else {
        switch(operation) {
            case 'load':
                const inputData = document.getElementById('register-input-data').value;
                if (!/^[01]+$/.test(inputData)) {
                    alert('Please enter valid binary data (0s and 1s only)');
                    return;
                }
                
                const bits = inputData.split('').map(bit => parseInt(bit));
                const paddedBits = Array(size).fill(0);
                const copyLength = Math.min(size, bits.length);
                for (let i = 0; i < copyLength; i++) {
                    paddedBits[i] = bits[i];
                }
                
                registerState.R1 = paddedBits;
                resultMessage = `Loaded data: ${bits.join('')} into Register R1`;
                break;
                
            case 'store':
                resultMessage = `Stored data in Register R1: ${registerState.R1.join('')}`;
                break;
                
            case 'transfer':
                const src = document.getElementById('source-register-select').value;
                const dest = document.getElementById('dest-register-select').value;
                
                if (src === dest) {
                    resultMessage = `Source and destination registers are the same (${src})`;
                } else {
                    registerState[dest] = [...registerState[src]];
                    resultMessage = `Transferred data from ${src} to ${dest}: ${registerState[dest].join('')}`;
                    affectedRegister = dest;
                }
                break;
                
            case 'clear':
                registerState.R1 = Array(size).fill(0);
                resultMessage = `Cleared Register R1 to all zeros`;
                break;
        }
    }
    
    // Update display
    updateRegisterDisplay();
    
    // Show analysis
    const analysisDiv = document.getElementById('sequential2-analysis');
    const stepsContainer = document.getElementById('sequential2-steps-container');
    
    stepsContainer.innerHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Register Operation Analysis</div>
            <div class="calculation-content">
                <div><strong>Operation:</strong> ${operation.toUpperCase()}</div>
                <div><strong>Register Size:</strong> ${size}-bit</div>
                <div><strong>Control Signals:</strong> CLK = ${clk}, EN = ${enable}</div>
                <hr>
                
                <div><strong>Step 1: Check Enable Signal</strong></div>
                <div>EN = ${enable} (${enable === 1 ? 'ENABLED' : 'DISABLED'})</div>
                <div>${enable === 1 ? ' Register enabled for operation' : ' Register disabled  No operation'}</div>
                
                ${enable === 1 ? `
                    <div class="mt-2"><strong>Step 2: Check Clock Pulse</strong></div>
                    <div>CLK = ${clk} (${clk === 1 ? 'CLOCK PULSE PRESENT' : 'NO CLOCK PULSE'})</div>
                    <div>${clk === 1 ? ' Clock pulse detected  Operation proceeds' : ' No clock pulse  Register holds'}</div>
                ` : ''}
                
                ${enable === 1 && clk === 1 ? `
                    <div class="mt-2"><strong>Step 3: Execute ${operation.toUpperCase()} Operation</strong></div>
                    ${getRegisterOperationDetails(operation, affectedRegister)}
                ` : ''}
                
                <div class="mt-2"><strong>Result:</strong></div>
                <div class="highlight-equation">${resultMessage}</div>
                
                ${operation === 'transfer' ? `
                    <div class="mt-2"><strong>Register States:</strong></div>
                    <div>R1: ${registerState.R1.join('')}</div>
                    <div>R2: ${registerState.R2.join('')}</div>
                    <div>R3: ${registerState.R3.join('')}</div>
                ` : ''}
            </div>
        </div>
    `;
    
    analysisDiv.style.display = 'block';
    
    // Update circuit visualization
    visualizeRealisticRegister();
    
    addLog(`Register ${operation}: ${resultMessage}`, 'success');
}

function getRegisterOperationDetails(operation, affectedRegister) {
    switch(operation) {
        case 'load':
            const inputData = document.getElementById('register-input-data').value;
            return `
                <div>Input Data: ${inputData}</div>
                <div>Operation: Load input data into ${affectedRegister}</div>
                <div>New ${affectedRegister} value: ${registerState[affectedRegister].join('')}</div>
            `;
            
        case 'store':
            return `
                <div>Operation: Store current ${affectedRegister} value</div>
                <div>${affectedRegister} value: ${registerState[affectedRegister].join('')}</div>
                <div>Data remains in ${affectedRegister} for future use</div>
            `;
            
        case 'transfer':
            const src = document.getElementById('source-register-select').value;
            const dest = document.getElementById('dest-register-select').value;
            return `
                <div>Operation: Transfer data from ${src} to ${dest}</div>
                <div>Source (${src}): ${registerState[src].join('')}</div>
                <div>Destination (${dest}): ${registerState[dest].join('')}</div>
                <div>Data copied from ${src} to ${dest}</div>
            `;
            
        case 'clear':
            return `
                <div>Operation: Clear ${affectedRegister} to all zeros</div>
                <div>All bits in ${affectedRegister} set to 0</div>
                <div>New ${affectedRegister} value: ${registerState[affectedRegister].join('')}</div>
            `;
            
        default:
            return '';
    }
}

// Shift Register Calculation
function calculateShiftRegister() {
    const direction = document.getElementById('shift-direction-select').value;
    const clk = document.getElementById('shift-register-clk').checked ? 1 : 0;
    const enable = document.getElementById('shift-enable').checked ? 1 : 0;
    const size = parseInt(document.getElementById('shift-register-size-select').value);
    
    let actualDirection = direction;
    if (direction === 'bidirectional') {
        actualDirection = document.getElementById('shift-mode').checked ? 'left' : 'right';
    }
    
    let resultMessage = '';
    let previousState = [...shiftRegisterState];
    
    if (enable === 0) {
        resultMessage = 'Shift disabled (EN=0): Register holds current value';
    } else if (clk === 0) {
        resultMessage = 'No clock pulse: Register holds current value';
    } else {
        // Perform shift operation
        if (actualDirection === 'right') {
            // Right shift
            const shiftInBit = document.getElementById('shift-in-data')?.checked ? 1 : 0;
            const lostBit = shiftRegisterState[shiftRegisterState.length - 1];
            
            for (let i = shiftRegisterState.length - 1; i > 0; i--) {
                shiftRegisterState[i] = shiftRegisterState[i - 1];
            }
            shiftRegisterState[0] = shiftInBit;
            
            resultMessage = `Right shift: Lost bit=${lostBit}, Shift-in=${shiftInBit}`;
        } else {
            // Left shift
            const shiftInBit = document.getElementById('shift-in-data')?.checked ? 1 : 0;
            const lostBit = shiftRegisterState[0];
            
            for (let i = 0; i < shiftRegisterState.length - 1; i++) {
                shiftRegisterState[i] = shiftRegisterState[i + 1];
            }
            shiftRegisterState[shiftRegisterState.length - 1] = shiftInBit;
            
            resultMessage = `Left shift: Lost bit=${lostBit}, Shift-in=${shiftInBit}`;
        }
    }
    
    // Update display
    updateShiftRegisterDisplay(previousState);
    
    // Show analysis
    const analysisDiv = document.getElementById('sequential2-analysis');
    const stepsContainer = document.getElementById('sequential2-steps-container');
    
    stepsContainer.innerHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Shift Register Operation Analysis</div>
            <div class="calculation-content">
                <div><strong>Shift Direction:</strong> ${actualDirection.toUpperCase()} SHIFT</div>
                <div><strong>Register Size:</strong> ${size}-bit</div>
                <div><strong>Control Signals:</strong> CLK = ${clk}, EN = ${enable}</div>
                <hr>
                
                <div><strong>Step 1: Check Enable Signal</strong></div>
                <div>EN = ${enable} (${enable === 1 ? 'ENABLED' : 'DISABLED'})</div>
                <div>${enable === 1 ? ' Shift enabled' : ' Shift disabled  No operation'}</div>
                
                ${enable === 1 ? `
                    <div class="mt-2"><strong>Step 2: Check Clock Pulse</strong></div>
                    <div>CLK = ${clk} (${clk === 1 ? 'CLOCK PULSE PRESENT' : 'NO CLOCK PULSE'})</div>
                    <div>${clk === 1 ? ' Clock pulse detected  Shift operation' : ' No clock pulse  Register holds'}</div>
                ` : ''}
                
                ${enable === 1 && clk === 1 ? `
                    <div class="mt-2"><strong>Step 3: Perform ${actualDirection.toUpperCase()} SHIFT</strong></div>
                    <div>Previous state: ${previousState.join('')}</div>
                    <div>Shift direction: ${actualDirection === 'right' ? 'Bits move from left to right' : 'Bits move from right to left'}</div>
                    ${actualDirection === 'right' ? `
                        <div>Rightmost bit (LSB) is lost: ${previousState[previousState.length - 1]}</div>
                        <div>New bit shifted in from left: ${document.getElementById('shift-in-data')?.checked ? 1 : 0}</div>
                    ` : `
                        <div>Leftmost bit (MSB) is lost: ${previousState[0]}</div>
                        <div>New bit shifted in from right: ${document.getElementById('shift-in-data')?.checked ? 1 : 0}</div>
                    `}
                    <div>New state: ${shiftRegisterState.join('')}</div>
                ` : ''}
                
                <div class="mt-2"><strong>Result:</strong></div>
                <div class="highlight-equation">${resultMessage}</div>
                <div><strong>Register State:</strong> ${shiftRegisterState.join('')}</div>
            </div>
        </div>
    `;
    
    analysisDiv.style.display = 'block';
    
    // Update circuit visualization
    visualizeRealisticShiftRegister(previousState);
    
    addLog(`Shift Register ${actualDirection} shift: ${resultMessage}`, 'success');
}

// Update register display
function updateRegisterDisplay() {
    const container = document.getElementById('register-values');
    const size = parseInt(document.getElementById('register-size-select').value);
    
    let html = `
        <div class="mb-3">
            <strong>Register R1 (${size}-bit):</strong>
            <div class="d-flex justify-content-center mt-2">
    `;
    
    for (let i = 0; i < size; i++) {
        const bit = registerState.R1[i] || 0;
        html += `
            <div class="text-center mx-1">
                <div class="register-bit ${bit ? 'active' : 'inactive'}">${bit}</div>
                <div class="register-bit-label">D${i}</div>
            </div>
        `;
    }
    
    html += `
            </div>
        </div>
        
        <div class="mb-3">
            <strong>Register R2 (${size}-bit):</strong>
            <div class="d-flex justify-content-center mt-2">
    `;
    
    for (let i = 0; i < size; i++) {
        const bit = registerState.R2[i] || 0;
        html += `
            <div class="text-center mx-1">
                <div class="register-bit ${bit ? 'active' : 'inactive'}">${bit}</div>
                <div class="register-bit-label">D${i}</div>
            </div>
        `;
    }
    
    html += `
            </div>
        </div>
        
        <div>
            <strong>Register R3 (${size}-bit):</strong>
            <div class="d-flex justify-content-center mt-2">
    `;
    
    for (let i = 0; i < size; i++) {
        const bit = registerState.R3[i] || 0;
        html += `
            <div class="text-center mx-1">
                <div class="register-bit ${bit ? 'active' : 'inactive'}">${bit}</div>
                <div class="register-bit-label">D${i}</div>
            </div>
        `;
    }
    
    html += `
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Update shift register display with animation
function updateShiftRegisterDisplay(previousState = null) {
    const container = document.getElementById('shift-register-states');
    const size = parseInt(document.getElementById('shift-register-size-select').value);
    
    let html = `
        <div class="mb-3">
            <strong>${size}-bit Shift Register State:</strong>
            <div class="d-flex justify-content-center align-items-center mt-3">
    `;
    
    // Add shift direction indicator
    const direction = document.getElementById('shift-direction-select').value;
    let actualDirection = direction;
    if (direction === 'bidirectional') {
        actualDirection = document.getElementById('shift-mode').checked ? 'left' : 'right';
    }
    
    if (actualDirection === 'right') {
        html += `<div class="me-3"><i class="fas fa-arrow-left shift-arrow"></i></div>`;
    }
    
    // Display register bits
    for (let i = 0; i < size; i++) {
        const bit = shiftRegisterState[i] || 0;
        const isAnimated = previousState && previousState[i] !== shiftRegisterState[i];
        const animationClass = isAnimated ? 'shift-animation' : '';
        
        html += `
            <div class="text-center mx-2">
                <div class="register-bit ${bit ? 'active' : 'inactive'} ${animationClass}" 
                     style="animation-delay: ${i * 0.1}s">${bit}</div>
                <div class="register-bit-label">Q${i}</div>
            </div>
        `;
        
        // Add arrow between bits
        if (i < size - 1) {
            html += `<div class="mx-1"><i class="fas fa-arrow-right" style="color: var(--primary-color);"></i></div>`;
        }
    }
    
    if (actualDirection === 'left') {
        html += `<div class="ms-3"><i class="fas fa-arrow-right shift-arrow"></i></div>`;
    }
    
    html += `
            </div>
        </div>
        
        <div class="mt-3">
            <div><strong>Binary Value:</strong> ${shiftRegisterState.join('')}</div>
            <div><strong>Decimal Value:</strong> ${parseInt(shiftRegisterState.join(''), 2)}</div>
            <div><strong>Shift Direction:</strong> ${actualDirection.toUpperCase()}</div>
        </div>
    `;
    
    container.innerHTML = html;
}

// REALISTIC CIRCUIT VISUALIZATIONS

function visualizeRealisticTFlipFlop() {
    const container = document.getElementById('sequential2-circuit-container');
    const T = document.getElementById('tff-input-t').checked ? 1 : 0;
    const CLK = document.getElementById('tff-input-clk').checked ? 1 : 0;
    const PR = document.getElementById('tff-input-pr').checked ? 1 : 0;
    const CLR = document.getElementById('tff-input-clr').checked ? 1 : 0;
    const Q = tFlipFlopState.Q;
    
    container.innerHTML = `
        <div class="realistic-circuit-container">
            <!-- Circuit Board Pattern -->
            <div class="circuit-board"></div>
            
            <!-- IC Package (74LS74 - Dual D Flip-Flop) -->
            <div class="ic-package" style="width: 150px; height: 100px; left: 50%; top: 50%; transform: translate(-50%, -50%);">
                <div class="ic-label">74LS74<br>T-FlipFlop</div>
            </div>
            
            <!-- IC Pins -->
            <div class="ic-pin" style="left: calc(50% - 75px); top: calc(50% - 20px);"></div> <!-- Pin 1: CLR -->
            <div class="ic-pin" style="left: calc(50% - 75px); top: calc(50% - 10px);"></div> <!-- Pin 2: D -->
            <div class="ic-pin" style="left: calc(50% - 75px); top: calc(50%);"></div> <!-- Pin 3: CLK -->
            <div class="ic-pin" style="left: calc(50% - 75px); top: calc(50% + 10px);"></div> <!-- Pin 4: PR -->
            <div class="ic-pin" style="left: calc(50% - 75px); top: calc(50% + 20px);"></div> <!-- Pin 5: Q -->
            
            <div class="ic-pin" style="left: calc(50% + 75px); top: calc(50% - 20px);"></div> <!-- Pin 14: VCC -->
            <div class="ic-pin" style="left: calc(50% + 75px); top: calc(50% - 10px);"></div> <!-- Pin 13: Q' -->
            <div class="ic-pin" style="left: calc(50% + 75px); top: calc(50%);"></div> <!-- Pin 12: T -->
            <div class="ic-pin" style="left: calc(50% + 75px); top: calc(50% + 10px);"></div> <!-- Pin 11: GND -->
            
            <!-- Internal Circuit Components -->
            <div class="gate-symbol-real" style="left: 45%; top: 45%;">AND</div>
            <div class="gate-symbol-real" style="left: 45%; top: 55%;">AND</div>
            <div class="gate-symbol-real" style="left: 55%; top: 45%;">OR</div>
            <div class="gate-symbol-real" style="left: 55%; top: 55%;">OR</div>
            
            <!-- D Flip-Flop Conversion to T Flip-Flop -->
            <div class="d-flipflop-real" style="left: 50%; top: 50%; transform: translate(-50%, -50%); width: 80px; height: 60px;">
                D-FF
            </div>
            
            <!-- XOR Gate for T Input -->
            <div class="gate-symbol-real" style="left: 40%; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #9370DB, #DDA0DD);">
                XOR
            </div>
            
            <!-- Clock Input -->
            <div class="clock-symbol-real" style="left: 30%; top: 50%; transform: translateY(-50%);"></div>
            
            <!-- Input Pads -->
            <div class="input-pad ${T ? 'active' : ''}" style="left: 20%; top: 40%;">T</div>
            <div class="input-pad ${CLK ? 'active' : ''}" style="left: 20%; top: 50%;">CLK</div>
            <div class="input-pad ${PR ? '' : 'active'}" style="left: 20%; top: 60%;">PR</div>
            <div class="input-pad ${CLR ? '' : 'active'}" style="left: 80%; top: 40%;">CLR</div>
            
            <!-- Output Pads -->
            <div class="output-pad ${Q ? 'active' : ''}" style="right: 20%; top: 50%;">Q</div>
            <div class="output-pad ${Q ? '' : 'active'}" style="right: 20%; top: 60%;">Q'</div>
            
            <!-- Circuit Tracks -->
            <div class="circuit-track ${T ? 'active' : 'inactive'}" style="width: 80px; height: 4px; left: 22%; top: 40%;"></div>
            <div class="circuit-track ${CLK ? 'active' : 'inactive'}" style="width: 80px; height: 4px; left: 22%; top: 50%;"></div>
            <div class="circuit-track ${PR ? 'inactive' : 'active'}" style="width: 80px; height: 4px; left: 22%; top: 60%;"></div>
            <div class="circuit-track ${CLR ? 'inactive' : 'active'}" style="width: 80px; height: 4px; right: 22%; top: 40%;"></div>
            <div class="circuit-track ${Q ? 'active' : 'inactive'}" style="width: 80px; height: 4px; right: 22%; top: 50%;"></div>
            <div class="circuit-track ${Q ? 'inactive' : 'active'}" style="width: 80px; height: 4px; right: 22%; top: 60%;"></div>
            
            <!-- Internal Connections -->
            <div class="circuit-connection ${T ? 'active' : ''}" style="width: 40px; height: 2px; left: 30%; top: 40%; transform: rotate(90deg);"></div>
            <div class="circuit-connection ${CLK ? 'active' : ''}" style="width: 40px; height: 2px; left: 30%; top: 50%; transform: rotate(90deg);"></div>
            
            <!-- Labels -->
            <div class="circuit-label-real" style="left: 15%; top: 40%;">T=${T}</div>
            <div class="circuit-label-real" style="left: 15%; top: 50%;">CLK=${CLK}</div>
            <div class="circuit-label-real" style="left: 15%; top: 60%;">PR=${PR}</div>
            <div class="circuit-label-real" style="right: 15%; top: 40%;">CLR=${CLR}</div>
            <div class="circuit-label-real" style="right: 15%; top: 50%;">Q=${Q}</div>
            <div class="circuit-label-real" style="right: 15%; top: 60%;">Q'=${Q ? 0 : 1}</div>
            
            <!-- Feedback Connection -->
            <div class="circuit-connection ${Q ? 'active' : ''}" style="width: 100px; height: 2px; left: 60%; top: 55%; transform: rotate(45deg);"></div>
        </div>
    `;
}

function visualizeRealisticRegister() {
    const container = document.getElementById('sequential2-circuit-container');
    const size = parseInt(document.getElementById('register-size-select').value);
    const operation = document.getElementById('register-operation-select').value;
    const clk = document.getElementById('register-clk').checked ? 1 : 0;
    const enable = document.getElementById('register-enable').checked ? 1 : 0;
    
    container.innerHTML = `
        <div class="realistic-circuit-container">
            <!-- Circuit Board Pattern -->
            <div class="circuit-board"></div>
            
            <!-- Main IC Package (74LS374 - Octal D Flip-Flop) -->
            <div class="ic-package" style="width: 200px; height: 80px; left: 50%; top: 30%; transform: translate(-50%, 0);">
                <div class="ic-label">74LS374<br>${size}-bit Register</div>
            </div>
            
            <!-- Data Bus -->
            <div class="data-bus ${enable && clk ? 'active' : 'inactive'}" style="width: 300px; height: 8px; left: 50%; top: 50%; transform: translate(-50%, -50%);"></div>
            
            <!-- Register Cells -->
            <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; gap: 10px;">
    `;
    
    // Add D Flip-Flop cells
    for (let i = 0; i < size; i++) {
        const bit = registerState.R1[i] || 0;
        container.innerHTML += `
            <div class="d-flipflop-real" style="width: 60px; height: 40px; position: relative;">
                D${i}
                <div class="circuit-label-real" style="top: 60px; left: 50%; transform: translateX(-50%);">${bit}</div>
            </div>
        `;
    }
    
    container.innerHTML += `
            </div>
            
            <!-- Control Lines -->
            <div class="control-line ${clk ? 'active' : ''}" style="width: 300px; height: 4px; left: 50%; top: 60%; transform: translate(-50%, -50%);"></div>
            <div class="control-line ${enable ? 'active' : ''}" style="width: 300px; height: 4px; left: 50%; top: 65%; transform: translate(-50%, -50%);"></div>
            
            <!-- Clock Symbol -->
            ${clk === 1 ? `
                <div class="clock-symbol-real" style="left: 20%; top: 60%;"></div>
            ` : ''}
            
            <!-- Input Pads -->
            <div class="input-pad ${enable && clk ? 'active' : ''}" style="left: 20%; top: 50%;">DIN</div>
            <div class="input-pad ${clk ? 'active' : ''}" style="left: 20%; top: 60%;">CLK</div>
            <div class="input-pad ${enable ? 'active' : ''}" style="left: 20%; top: 65%;">EN</div>
            
            <!-- Output Pads -->
            <div class="output-pad" style="right: 20%; top: 50%;">DOUT</div>
            
            <!-- Data Lines -->
            <div class="circuit-track ${enable && clk ? 'active' : 'inactive'}" style="width: 100px; height: 4px; left: 22%; top: 50%;"></div>
            <div class="circuit-track ${clk ? 'active' : 'inactive'}" style="width: 100px; height: 4px; left: 22%; top: 60%;"></div>
            <div class="circuit-track ${enable ? 'active' : 'inactive'}" style="width: 100px; height: 4px; left: 22%; top: 65%;"></div>
            <div class="circuit-track" style="width: 100px; height: 4px; right: 22%; top: 50%;"></div>
            
            <!-- Multiplexer for Load/Clear -->
            <div class="mux-symbol" style="left: 30%; top: 40%;">MUX</div>
            
            <!-- Labels -->
            <div class="circuit-label-real" style="left: 15%; top: 50%;">Data In</div>
            <div class="circuit-label-real" style="left: 15%; top: 60%;">CLK=${clk}</div>
            <div class="circuit-label-real" style="left: 15%; top: 65%;">EN=${enable}</div>
            <div class="circuit-label-real" style="right: 15%; top: 50%;">Data Out</div>
            <div class="circuit-label-real" style="top: 20%; left: 50%; transform: translateX(-50%); background: ${operation === 'load' ? 'var(--success-color)' : operation === 'clear' ? 'var(--danger-color)' : 'var(--info-color)'}; color: white;">
                ${operation.toUpperCase()} MODE
            </div>
            
            <!-- Internal Data Path -->
            <div class="circuit-connection ${enable && clk ? 'active' : ''}" style="width: 200px; height: 2px; left: 40%; top: 45%;"></div>
            
            <!-- Enable Gate -->
            <div class="gate-symbol-real" style="left: 35%; top: 65%;">AND</div>
        </div>
    `;
}

function visualizeRealisticShiftRegister(previousState = null) {
    const container = document.getElementById('sequential2-circuit-container');
    const size = parseInt(document.getElementById('shift-register-size-select').value);
    const direction = document.getElementById('shift-direction-select').value;
    const clk = document.getElementById('shift-register-clk').checked ? 1 : 0;
    const enable = document.getElementById('shift-enable').checked ? 1 : 0;
    const shiftInBit = document.getElementById('shift-in-data')?.checked ? 1 : 0;
    
    let actualDirection = direction;
    if (direction === 'bidirectional') {
        actualDirection = document.getElementById('shift-mode').checked ? 'left' : 'right';
    }
    
    container.innerHTML = `
        <div class="realistic-circuit-container">
            <!-- Circuit Board Pattern -->
            <div class="circuit-board"></div>
            
            <!-- Main IC Package (74LS164 - 8-bit Shift Register) -->
            <div class="ic-package" style="width: 250px; height: 70px; left: 50%; top: 30%; transform: translate(-50%, 0);">
                <div class="ic-label">74LS164<br>${size}-bit Shift Reg</div>
            </div>
            
            <!-- Shift Register Chain -->
            <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; gap: 5px;">
    `;
    
    // Add D Flip-Flop cells in chain
    for (let i = 0; i < size; i++) {
        const bit = shiftRegisterState[i] || 0;
        const isAnimated = previousState && previousState[i] !== shiftRegisterState[i];
        const animationClass = isAnimated ? 'shift-animation' : '';
        
        container.innerHTML += `
            <div style="position: relative;">
                <div class="d-flipflop-real ${bit ? 'active' : ''} ${animationClass}" style="width: 50px; height: 35px;">
                    D${i}
                </div>
                <div class="circuit-label-real" style="top: 40px; left: 50%; transform: translateX(-50%); white-space: nowrap;">
                    Q${i}=${bit}
                </div>
            </div>
        `;
        
        // Add arrow between flip-flops
        if (i < size - 1) {
            container.innerHTML += `
                <div class="shift-arrow-real" style="margin: 0 5px;">
                    ${actualDirection === 'right' ? '' : ''}
                </div>
            `;
        }
    }
    
    container.innerHTML += `
            </div>
            
            <!-- Control Lines -->
            <div class="control-line ${clk ? 'active' : ''}" style="width: 350px; height: 4px; left: 50%; top: 60%; transform: translate(-50%, -50%);"></div>
            <div class="control-line ${enable ? 'active' : ''}" style="width: 350px; height: 4px; left: 50%; top: 65%; transform: translate(-50%, -50%);"></div>
            
            <!-- Clock Symbol -->
            ${clk === 1 ? `
                <div class="clock-symbol-real" style="left: 20%; top: 60%; animation-delay: ${size * 0.1}s;"></div>
            ` : ''}
            
            <!-- Input/Output Pads -->
            <div class="input-pad ${shiftInBit ? 'active' : ''}" style="left: 20%; top: 40%;">
                ${actualDirection === 'right' ? 'SER IN' : 'IN'}
            </div>
            <div class="input-pad ${clk ? 'active' : ''}" style="left: 20%; top: 60%;">CLK</div>
            <div class="input-pad ${enable ? 'active' : ''}" style="left: 20%; top: 65%;">EN</div>
            
            <div class="output-pad" style="right: 20%; top: 40%;">
                ${actualDirection === 'right' ? 'OUT' : 'SER OUT'}
            </div>
            
            <!-- Parallel Output Pads -->
            <div style="position: absolute; right: 15%; top: 50%; display: flex; flex-direction: column; gap: 5px;">
    `;
    
    // Add parallel output pads
    for (let i = 0; i < Math.min(4, size); i++) {
        const bit = shiftRegisterState[i] || 0;
        container.innerHTML += `
            <div class="output-pad ${bit ? 'active' : ''}" style="width: 25px; height: 25px; font-size: 0.7rem;">
                Q${i}
            </div>
        `;
    }
    
    container.innerHTML += `
            </div>
            
            <!-- Circuit Tracks -->
            <div class="circuit-track ${shiftInBit ? 'active' : 'inactive'}" style="width: 100px; height: 4px; left: 22%; top: 40%;"></div>
            <div class="circuit-track ${clk ? 'active' : 'inactive'}" style="width: 100px; height: 4px; left: 22%; top: 60%;"></div>
            <div class="circuit-track ${enable ? 'active' : 'inactive'}" style="width: 100px; height: 4px; left: 22%; top: 65%;"></div>
            
            <!-- Serial Output Track -->
            <div class="circuit-track" style="width: 100px; height: 4px; right: 22%; top: 40%;"></div>
            
            <!-- Direction Control (for bidirectional) -->
            ${direction === 'bidirectional' ? `
                <div class="mux-symbol" style="left: 30%; top: 45%;">2:1 MUX</div>
                <div class="gate-symbol-real" style="left: 35%; top: 65%;">AND</div>
            ` : ''}
            
            <!-- Labels -->
            <div class="circuit-label-real" style="left: 15%; top: 40%;">SER IN=${shiftInBit}</div>
            <div class="circuit-label-real" style="left: 15%; top: 60%;">CLK=${clk}</div>
            <div class="circuit-label-real" style="left: 15%; top: 65%;">EN=${enable}</div>
            <div class="circuit-label-real" style="right: 15%; top: 40%;">
                ${actualDirection === 'right' ? 'SER OUT' : 'SER OUT'}=${actualDirection === 'right' ? (previousState ? previousState[previousState.length - 1] : 0) : (previousState ? previousState[0] : 0)}
            </div>
            
            <div class="circuit-label-real" style="top: 20%; left: 50%; transform: translateX(-50%); background: ${actualDirection === 'right' ? 'var(--success-color)' : 'var(--warning-color)'}; color: white;">
                ${actualDirection.toUpperCase()} SHIFT
            </div>
            
            <!-- Enable Gate -->
            <div class="gate-symbol-real" style="left: 35%; top: 65%;">AND</div>
            
            <!-- Clock Distribution -->
            <div class="circuit-connection ${clk ? 'active' : ''}" style="width: 300px; height: 2px; left: 40%; top: 60%;"></div>
        </div>
    `;
}

// Show truth table for selected component
function showSequential2TruthTable() {
    const analysisDiv = document.getElementById('sequential2-analysis');
    const stepsContainer = document.getElementById('sequential2-steps-container');
    
    switch(currentSequential2Component) {
        case 't-flipflop':
            stepsContainer.innerHTML = generateTFlipFlopTruthTable();
            break;
        case 'register-storage':
            stepsContainer.innerHTML = generateRegisterTruthTable();
            break;
        case 'shift-register':
            stepsContainer.innerHTML = generateShiftRegisterTruthTable();
            break;
    }
    
    analysisDiv.style.display = 'block';
    analysisDiv.querySelector('#sequential2-analysis-title').textContent = 'Truth Table';
    
    addLog(`Displayed truth table for ${currentSequential2Component}`, 'info');
}

function generateTFlipFlopTruthTable() {
    return `
        <div class="sequential-step active">
            <div class="calculation-title">T Flip-Flop Truth Table</div>
            <div class="calculation-content">
                <div><strong>Characteristics:</strong></div>
                <ul>
                    <li>T = 0: No change (Hold)</li>
                    <li>T = 1: Toggle output</li>
                    <li>Clock edge triggered</li>
                    <li>Preset (PR) and Clear (CLR) are active low</li>
                </ul>
                
                <div class="mt-3"><strong>Characteristic Table:</strong></div>
                <table class="bit-table">
                    <thead>
                        <tr>
                            <th>T</th>
                            <th>Q<sub>n</sub></th>
                            <th>Q<sub>n+1</sub></th>
                            <th>Operation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>0</td><td>0</td><td>0</td><td>Hold</td></tr>
                        <tr><td>0</td><td>1</td><td>1</td><td>Hold</td></tr>
                        <tr><td>1</td><td>0</td><td>1</td><td>Toggle</td></tr>
                        <tr><td>1</td><td>1</td><td>0</td><td>Toggle</td></tr>
                    </tbody>
                </table>
                
                <div class="mt-3"><strong>Characteristic Equation:</strong></div>
                <div class="highlight-equation">Q<sub>n+1</sub> = T  Q<sub>n</sub></div>
                
                <div class="mt-3"><strong>Excitation Table:</strong></div>
                <table class="bit-table">
                    <thead>
                        <tr>
                            <th>Q<sub>n</sub>  Q<sub>n+1</sub></th>
                            <th>T</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>0  0</td><td>0</td></tr>
                        <tr><td>0  1</td><td>1</td></tr>
                        <tr><td>1  0</td><td>1</td></tr>
                        <tr><td>1  1</td><td>0</td></tr>
                    </tbody>
                </table>
                
                <div class="mt-3"><strong>Preset/Clear Operation:</strong></div>
                <table class="bit-table">
                    <thead>
                        <tr>
                            <th>PR</th>
                            <th>CLR</th>
                            <th>Q</th>
                            <th>Q'</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>0</td><td>1</td><td>1</td><td>0</td></tr>
                        <tr><td>1</td><td>0</td><td>0</td><td>1</td></tr>
                        <tr><td>0</td><td>0</td><td>1*</td><td>1*</td></tr>
                    </tbody>
                </table>
                <small>*Invalid state, should be avoided</small>
                
                <div class="mt-3"><strong>Real IC Implementation (74LS74):</strong></div>
                <ul>
                    <li><strong>Package:</strong> 14-pin DIP</li>
                    <li><strong>Power:</strong> VCC (Pin 14), GND (Pin 7)</li>
                    <li><strong>Clock:</strong> Positive edge triggered</li>
                    <li><strong>Setup Time:</strong> 20ns typical</li>
                    <li><strong>Hold Time:</strong> 5ns typical</li>
                </ul>
            </div>
        </div>
    `;
}

function generateRegisterTruthTable() {
    const size = parseInt(document.getElementById('register-size-select').value);
    
    return `
        <div class="sequential-step active">
            <div class="calculation-title">Register Operations Truth Table</div>
            <div class="calculation-content">
                <div><strong>Register Specifications:</strong></div>
                <ul>
                    <li>Size: ${size}-bit register</li>
                    <li>Operations: Load, Store, Transfer, Clear</li>
                    <li>Clock edge triggered (positive edge)</li>
                    <li>Enable signal controls operation</li>
                </ul>
                
                <div class="mt-3"><strong>Control Signals Truth Table:</strong></div>
                <table class="bit-table">
                    <thead>
                        <tr>
                            <th>EN</th>
                            <th>CLK</th>
                            <th>Operation</th>
                            <th>Register Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>0</td><td>X</td><td>Any</td><td>No Operation (Hold)</td></tr>
                        <tr><td>1</td><td>0</td><td>Any</td><td>No Operation (Hold)</td></tr>
                        <tr><td>1</td><td></td><td>Load</td><td>Load input data</td></tr>
                        <tr><td>1</td><td></td><td>Store</td><td>Store current value</td></tr>
                        <tr><td>1</td><td></td><td>Transfer</td><td>Copy to destination</td></tr>
                        <tr><td>1</td><td></td><td>Clear</td><td>Reset to all zeros</td></tr>
                    </tbody>
                </table>
                <small>X = Don't care,  = Rising clock edge</small>
                
                <div class="mt-3"><strong>Real IC Implementation (74LS374):</strong></div>
                <ul>
                    <li><strong>Package:</strong> 20-pin DIP</li>
                    <li><strong>Type:</strong> Octal D-type flip-flop</li>
                    <li><strong>Output:</strong> Tri-state outputs</li>
                    <li><strong>Clock-to-Output:</strong> 15ns typical</li>
                    <li><strong>Power Consumption:</strong> 80mW typical</li>
                </ul>
            </div>
        </div>
    `;
}

function generateShiftRegisterTruthTable() {
    const size = parseInt(document.getElementById('shift-register-size-select').value);
    const direction = document.getElementById('shift-direction-select').value;
    
    return `
        <div class="sequential-step active">
            <div class="calculation-title">Shift Register Truth Table</div>
            <div class="calculation-content">
                <div><strong>Specifications:</strong></div>
                <ul>
                    <li>Size: ${size}-bit shift register</li>
                    <li>Direction: ${direction === 'bidirectional' ? 'Bidirectional' : direction.toUpperCase()}</li>
                    <li>Operation: Shift on clock edge</li>
                    <li>Enable signal controls shifting</li>
                </ul>
                
                <div class="mt-3"><strong>Real IC Implementations:</strong></div>
                <ul>
                    <li><strong>74LS164:</strong> 8-bit serial-in, parallel-out</li>
                    <li><strong>74LS165:</strong> 8-bit parallel-in, serial-out</li>
                    <li><strong>74LS194:</strong> 4-bit bidirectional universal</li>
                    <li><strong>74LS299:</strong> 8-bit bidirectional with tri-state</li>
                </ul>
                
                <div class="mt-3"><strong>74LS164 Pin Configuration:</strong></div>
                <table class="bit-table">
                    <thead>
                        <tr>
                            <th>Pin</th>
                            <th>Name</th>
                            <th>Function</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1, 2</td><td>A, B</td><td>Serial Inputs</td></tr>
                        <tr><td>3-6, 10-13</td><td>QA-QH</td><td>Parallel Outputs</td></tr>
                        <tr><td>8</td><td>CLK</td><td>Clock Input</td></tr>
                        <tr><td>9</td><td>CLR</td><td>Clear Input</td></tr>
                        <tr><td>14</td><td>VCC</td><td>+5V Power</td></tr>
                        <tr><td>7</td><td>GND</td><td>Ground</td></tr>
                    </tbody>
                </table>
                
                <div class="mt-3"><strong>Timing Characteristics:</strong></div>
                <ul>
                    <li><strong>Clock Frequency:</strong> Up to 36MHz</li>
                    <li><strong>Propagation Delay:</strong> 13ns typical</li>
                    <li><strong>Setup Time:</strong> 20ns</li>
                    <li><strong>Hold Time:</strong> 0ns</li>
                </ul>
            </div>
        </div>
    `;
}

// Animate Sequential Circuit-2 operation
function animateSequential2Operation() {
    if (isSequential2Animating) return;
    
    switch(currentSequential2Component) {
        case 't-flipflop':
            animateTFlipFlopSequence();
            break;
        case 'register-storage':
            animateRegisterSequence();
            break;
        case 'shift-register':
            animateShiftRegisterSequence();
            break;
    }
}

function animateTFlipFlopSequence() {
    isSequential2Animating = true;
    const animateBtn = document.getElementById('animate-sequential2-btn');
    animateBtn.disabled = true;
    animateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Animating...';
    
    const steps = [
        { T: 0, CLK: 1, PR: 1, CLR: 1, desc: "T=0: Hold state" },
        { T: 1, CLK: 1, PR: 1, CLR: 1, desc: "T=1: Toggle state" },
        { T: 1, CLK: 1, PR: 1, CLR: 1, desc: "T=1: Toggle again" },
        { T: 0, CLK: 1, PR: 1, CLR: 1, desc: "T=0: Hold new state" },
        { T: 0, CLK: 0, PR: 1, CLR: 1, desc: "No clock: Hold regardless of T" },
        { T: 0, CLK: 1, PR: 0, CLR: 1, desc: "PRESET active: Q=1" },
        { T: 0, CLK: 1, PR: 1, CLR: 0, desc: "CLEAR active: Q=0" }
    ];
    
    let currentStep = 0;
    
    function executeStep(stepIndex) {
        if (stepIndex >= steps.length) {
            // Animation complete
            isSequential2Animating = false;
            animateBtn.disabled = false;
            animateBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i>Animate Operation';
            addLog('T Flip-Flop animation completed', 'info');
            return;
        }
        
        const step = steps[stepIndex];
        currentStep++;
        
        // Update inputs
        document.getElementById('tff-input-t').checked = step.T === 1;
        document.getElementById('tff-input-clk').checked = step.CLK === 1;
        document.getElementById('tff-input-pr').checked = step.PR === 1;
        document.getElementById('tff-input-clr').checked = step.CLR === 1;
        
        // Trigger change events
        document.getElementById('tff-input-t').dispatchEvent(new Event('change'));
        document.getElementById('tff-input-clk').dispatchEvent(new Event('change'));
        document.getElementById('tff-input-pr').dispatchEvent(new Event('change'));
        document.getElementById('tff-input-clr').dispatchEvent(new Event('change'));
        
        // Calculate
        calculateTFlipFlop();
        
        // Update animation status
        const analysisDiv = document.getElementById('sequential2-analysis');
        const stepsContainer = document.getElementById('sequential2-steps-container');
        
        stepsContainer.innerHTML += `
            <div class="sequential-step ${stepIndex === 0 ? 'active' : ''}">
                <div class="calculation-title">Animation Step ${currentStep}/${steps.length}</div>
                <div class="calculation-content">
                    <div><strong>Inputs:</strong> T=${step.T}, CLK=${step.CLK}, PR=${step.PR}, CLR=${step.CLR}</div>
                    <div><strong>Operation:</strong> ${step.desc}</div>
                    <div><strong>Result:</strong> Q = ${tFlipFlopState.Q}</div>
                </div>
            </div>
        `;
        
        // Scroll to latest step
        analysisDiv.style.display = 'block';
        analysisDiv.scrollTop = analysisDiv.scrollHeight;
        
        addLog(`T Flip-Flop animation step ${currentStep}: ${step.desc}`, 'info');
        
        // Next step after delay
        setTimeout(() => {
            executeStep(stepIndex + 1);
        }, 2000);
    }
    
    // Start animation
    executeStep(0);
}

function animateRegisterSequence() {
    isSequential2Animating = true;
    const animateBtn = document.getElementById('animate-sequential2-btn');
    animateBtn.disabled = true;
    animateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Animating...';
    
    const steps = [
        { op: 'clear', data: '00000000', desc: "Clear register to all zeros" },
        { op: 'load', data: '11011010', desc: "Load binary data 11011010" },
        { op: 'store', data: '', desc: "Store current register value" },
        { op: 'transfer', src: 'R1', dest: 'R2', desc: "Transfer data from R1 to R2" },
        { op: 'load', data: '00101101', desc: "Load new data 00101101" }
    ];
    
    let currentStep = 0;
    
    function executeStep(stepIndex) {
        if (stepIndex >= steps.length) {
            // Animation complete
            isSequential2Animating = false;
            animateBtn.disabled = false;
            animateBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i>Animate Operation';
            addLog('Register animation completed', 'info');
            return;
        }
        
        const step = steps[stepIndex];
        currentStep++;
        
        // Update operation
        document.getElementById('register-operation-select').value = step.op;
        updateRegisterInterface();
        
        if (step.op === 'load') {
            document.getElementById('register-input-data').value = step.data;
        } else if (step.op === 'transfer') {
            document.getElementById('source-register-select').value = step.src;
            document.getElementById('dest-register-select').value = step.dest;
        }
        
        // Set clock and enable
        document.getElementById('register-clk').checked = true;
        document.getElementById('register-enable').checked = true;
        
        // Calculate
        calculateRegisterOperation();
        
        // Update animation status
        const analysisDiv = document.getElementById('sequential2-analysis');
        const stepsContainer = document.getElementById('sequential2-steps-container');
        
        stepsContainer.innerHTML += `
            <div class="sequential-step ${stepIndex === 0 ? 'active' : ''}">
                <div class="calculation-title">Animation Step ${currentStep}/${steps.length}</div>
                <div class="calculation-content">
                    <div><strong>Operation:</strong> ${step.op.toUpperCase()}</div>
                    ${step.data ? `<div><strong>Data:</strong> ${step.data}</div>` : ''}
                    ${step.src ? `<div><strong>Source:</strong> ${step.src}, <strong>Destination:</strong> ${step.dest}</div>` : ''}
                    <div><strong>Description:</strong> ${step.desc}</div>
                    <div><strong>R1 State:</strong> ${registerState.R1.join('')}</div>
                    <div><strong>R2 State:</strong> ${registerState.R2.join('')}</div>
                </div>
            </div>
        `;
        
        // Scroll to latest step
        analysisDiv.style.display = 'block';
        analysisDiv.scrollTop = analysisDiv.scrollHeight;
        
        addLog(`Register animation step ${currentStep}: ${step.desc}`, 'info');
        
        // Next step after delay
        setTimeout(() => {
            executeStep(stepIndex + 1);
        }, 2000);
    }
    
    // Start animation
    executeStep(0);
}

function animateShiftRegisterSequence() {
    isSequential2Animating = true;
    const animateBtn = document.getElementById('animate-sequential2-btn');
    animateBtn.disabled = true;
    animateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Animating...';
    
    const direction = document.getElementById('shift-direction-select').value;
    const steps = direction === 'left' ? 
        generateLeftShiftSteps() : 
        direction === 'right' ? 
            generateRightShiftSteps() : 
            generateBidirectionalShiftSteps();
    
    let currentStep = 0;
    
    function executeStep(stepIndex) {
        if (stepIndex >= steps.length) {
            // Animation complete
            isSequential2Animating = false;
            animateBtn.disabled = false;
            animateBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i>Animate Operation';
            addLog('Shift Register animation completed', 'info');
            return;
        }
        
        const step = steps[stepIndex];
        currentStep++;
        
        // Update inputs
        document.getElementById('shift-register-clk').checked = step.clk === 1;
        document.getElementById('shift-enable').checked = step.enable === 1;
        
        if (step.shiftIn !== undefined) {
            document.getElementById('shift-in-data').checked = step.shiftIn === 1;
        }
        
        if (step.direction !== undefined && direction === 'bidirectional') {
            document.getElementById('shift-mode').checked = step.direction === 'left';
        }
        
        // Calculate
        calculateShiftRegister();
        
        // Update animation status
        const analysisDiv = document.getElementById('sequential2-analysis');
        const stepsContainer = document.getElementById('sequential2-steps-container');
        
        stepsContainer.innerHTML += `
            <div class="sequential-step ${stepIndex === 0 ? 'active' : ''}">
                <div class="calculation-title">Animation Step ${currentStep}/${steps.length}</div>
                <div class="calculation-content">
                    <div><strong>Operation:</strong> ${step.desc}</div>
                    <div><strong>Register State:</strong> ${shiftRegisterState.join('')}</div>
                    ${step.shiftIn !== undefined ? `<div><strong>Shift In:</strong> ${step.shiftIn}</div>` : ''}
                    <div><strong>Binary Value:</strong> ${parseInt(shiftRegisterState.join(''), 2)}</div>
                </div>
            </div>
        `;
        
        // Scroll to latest step
        analysisDiv.style.display = 'block';
        analysisDiv.scrollTop = analysisDiv.scrollHeight;
        
        addLog(`Shift Register animation step ${currentStep}: ${step.desc}`, 'info');
        
        // Next step after delay
        setTimeout(() => {
            executeStep(stepIndex + 1);
        }, 1500);
    }
    
    // Start animation
    executeStep(0);
}

function generateRightShiftSteps() {
    return [
        { clk: 1, enable: 1, shiftIn: 1, desc: "Right shift with 1 shifted in" },
        { clk: 1, enable: 1, shiftIn: 0, desc: "Right shift with 0 shifted in" },
        { clk: 1, enable: 1, shiftIn: 1, desc: "Right shift with 1 shifted in" },
        { clk: 1, enable: 1, shiftIn: 0, desc: "Right shift with 0 shifted in" },
        { clk: 1, enable: 0, shiftIn: 1, desc: "Shift disabled: No operation" },
        { clk: 0, enable: 1, shiftIn: 1, desc: "No clock pulse: No operation" }
    ];
}

function generateLeftShiftSteps() {
    return [
        { clk: 1, enable: 1, shiftIn: 1, desc: "Left shift with 1 shifted in" },
        { clk: 1, enable: 1, shiftIn: 0, desc: "Left shift with 0 shifted in" },
        { clk: 1, enable: 1, shiftIn: 1, desc: "Left shift with 1 shifted in" },
        { clk: 1, enable: 1, shiftIn: 0, desc: "Left shift with 0 shifted in" },
        { clk: 1, enable: 0, shiftIn: 1, desc: "Shift disabled: No operation" },
        { clk: 0, enable: 1, shiftIn: 1, desc: "No clock pulse: No operation" }
    ];
}

function generateBidirectionalShiftSteps() {
    return [
        { clk: 1, enable: 1, direction: 'right', shiftIn: 1, desc: "Bidirectional: Right shift with 1" },
        { clk: 1, enable: 1, direction: 'right', shiftIn: 0, desc: "Bidirectional: Right shift with 0" },
        { clk: 1, enable: 1, direction: 'left', shiftIn: 1, desc: "Bidirectional: Left shift with 1" },
        { clk: 1, enable: 1, direction: 'left', shiftIn: 0, desc: "Bidirectional: Left shift with 0" },
        { clk: 1, enable: 1, direction: 'right', shiftIn: 1, desc: "Bidirectional: Right shift with 1" }
    ];
}

// Reset Sequential Circuit-2
function resetSequential2() {
    // Reset T Flip-Flop
    tFlipFlopState = { Q: 0, prevQ: 0 };
    
    // Reset registers
    const size = parseInt(document.getElementById('register-size-select').value);
    registerState = {
        R1: Array(size).fill(0),
        R2: Array(size).fill(0),
        R3: Array(size).fill(0)
    };
    
    // Reset shift register
    shiftRegisterState = Array(8).fill(0);
    shiftRegisterState[0] = 1;
    shiftRegisterState[1] = 1;
    shiftRegisterState[3] = 1;
    
    // Reset input controls
    if (currentSequential2Component === 't-flipflop') {
        document.getElementById('tff-input-t').checked = false;
        document.getElementById('tff-input-clk').checked = false;
        document.getElementById('tff-input-pr').checked = true;
        document.getElementById('tff-input-clr').checked = true;
        document.getElementById('tff-current-q').checked = false;
    } else if (currentSequential2Component === 'register-storage') {
        document.getElementById('register-input-data').value = '';
        document.getElementById('register-clk').checked = false;
        document.getElementById('register-enable').checked = false;
        updateRegisterDisplay();
    } else if (currentSequential2Component === 'shift-register') {
        document.getElementById('shift-input-data').value = '1101';
        document.getElementById('shift-register-clk').checked = false;
        document.getElementById('shift-enable').checked = false;
        if (document.getElementById('shift-in-data')) {
            document.getElementById('shift-in-data').checked = false;
        }
        if (document.getElementById('shift-mode')) {
            document.getElementById('shift-mode').checked = false;
        }
        initializeShiftRegister();
    }
    
    // Update displays
    document.getElementById('sequential2-result').textContent = '-';
    document.getElementById('sequential2-next-result').textContent = '-';
    document.getElementById('sequential2-analysis').style.display = 'none';
    
    // Re-initialize selected component
    selectSequential2Component(currentSequential2Component);
    
    addLog(`Reset ${currentSequential2Component} component`, 'info');
}
// Number System Operations Functions
function selectNumberSystemOperation(operation) {
    currentNumberSystemOperation = operation;
    
    // Hide all input sections
    document.getElementById('binary-decimal-inputs').style.display = 'none';
    document.getElementById('binary-hex-inputs').style.display = 'none';
    document.getElementById('binary-octal-inputs').style.display = 'none';
    document.getElementById('bcd-inputs').style.display = 'none';
    
    // Show selected input section
    document.getElementById(operation + '-inputs').style.display = 'block';
    
    // Update interface based on operation
    updateNumberSystemInterface();
    
    addLog(`Selected ${operation.replace('-', ' ')} operation`, 'info');
}

function updateNumberSystemInterface() {
    const resultsDiv = document.getElementById('number-system-results');
    
    switch(currentNumberSystemOperation) {
        case 'binary-decimal':
            setupBinaryDecimalInterface();
            resultsDiv.innerHTML = `
                <div class="glass-card">
                    <h5 class="text-center mb-3">Binary  Decimal Converter</h5>
                    <div class="text-center">
                        <i class="fas fa-exchange-alt fa-3x" style="color: var(--primary-color);"></i>
                        <p class="mt-3">Convert between binary and decimal number systems</p>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-value">2</div>
                                    <small>Binary Power Method</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-value">2 / 2</div>
                                    <small>Division/Multiplication Method</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'binary-hex':
            setupBinaryHexInterface();
            resultsDiv.innerHTML = `
                <div class="glass-card">
                    <h5 class="text-center mb-3">Binary  Hexadecimal Converter</h5>
                    <div class="text-center">
                        <i class="fas fa-exchange-alt fa-3x" style="color: var(--info-color);"></i>
                        <p class="mt-3">Convert between binary and hexadecimal systems</p>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-value">4-bit</div>
                                    <small>Grouping Method</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-value">0-9,A-F</div>
                                    <small>Hex Digits</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'binary-octal':
            setupBinaryOctalInterface();
            resultsDiv.innerHTML = `
                <div class="glass-card">
                    <h5 class="text-center mb-3">Binary  Octal Converter</h5>
                    <div class="text-center">
                        <i class="fas fa-exchange-alt fa-3x" style="color: var(--primary-color);"></i>
                        <p class="mt-3">Convert between binary and octal number systems</p>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-value">3-bit</div>
                                    <small>Grouping Method</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-value">0-7</div>
                                    <small>Octal Digits</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'bcd':
            setupBCDInterface();
            resultsDiv.innerHTML = `
                <div class="glass-card">
                    <h5 class="text-center mb-3">BCD (Binary Coded Decimal)</h5>
                    <div class="text-center">
                        <i class="fas fa-code fa-3x" style="color: var(--success-color);"></i>
                        <p class="mt-3">Encode/decode decimal numbers in BCD format</p>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-value">8421</div>
                                    <small>BCD Weighted Code</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-value">0-9</div>
                                    <small>Valid Digits</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
    }
    
    // Hide other containers
    document.getElementById('conversion-steps-container').style.display = 'none';
    document.getElementById('reference-tables').style.display = 'none';
    document.getElementById('practice-questions').style.display = 'none';
}
// Add these missing helper functions
function showBinaryDecimalSteps() {
    if (!window.binaryDecimalSteps || window.binaryDecimalSteps.length === 0) {
        showError("Please calculate a conversion first to see the steps.");
        return;
    }
    
    document.getElementById('conversion-steps-container').style.display = 'block';
    document.getElementById('steps-content').innerHTML = `
        <h6>Binary  Decimal Conversion Steps</h6>
        ${window.binaryDecimalSteps.join('')}
    `;
    
    addLog('Displayed binary-decimal conversion steps', 'info');
}

function generateBinaryDecimalExamples() {
    const examples = [
        { binary: "1010", decimal: "10", type: "unsigned" },
        { binary: "1111", decimal: "15", type: "unsigned" },
        { binary: "1001", decimal: "-7", type: "signed" },
        { binary: "1101.101", decimal: "13.625", type: "fractional" }
    ];
    
    const randomExample = examples[Math.floor(Math.random() * examples.length)];
    
    document.getElementById('bd-binary-value').value = randomExample.binary;
    document.getElementById('bd-decimal-value').value = randomExample.decimal;
    document.getElementById('bd-input-type').value = randomExample.type;
    
    // Trigger the calculation
    calculateBinaryDecimal();
    
    addLog(`Generated example: ${randomExample.binary}  ${randomExample.decimal}`, 'info');
}

function showHexTable() {
    document.getElementById('reference-tables').style.display = 'block';
    addLog('Displayed hexadecimal reference table', 'info');
}

function startHexPractice() {
    const hexDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'];
    const randomDigit = hexDigits[Math.floor(Math.random() * hexDigits.length)];
    const binaryEquivalent = parseInt(randomDigit, 16).toString(2).padStart(4, '0');
    
    const resultsDiv = document.getElementById('number-system-results');
    resultsDiv.innerHTML = `
        <div class="glass-card">
            <h5 class="text-center mb-3">Hexadecimal Practice Drill</h5>
            <div class="text-center">
                <i class="fas fa-dumbbell fa-3x" style="color: var(--warning-color);"></i>
                <p class="mt-3">Convert hexadecimal digit: <span class="hex-highlight">${randomDigit}</span> to binary</p>
                <div class="mt-4">
                    <button class="btn-glow" id="show-hex-answer">
                        <i class="fas fa-eye me-1"></i>Show Answer
                    </button>
                    <button class="btn-glow" id="new-hex-question">
                        <i class="fas fa-random me-1"></i>New Question
                    </button>
                </div>
                <div id="hex-answer" class="mt-3" style="display: none;">
                    <div class="conversion-step active">
                        <strong>Answer:</strong> ${randomDigit} = ${binaryEquivalent}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('show-hex-answer').addEventListener('click', function() {
        document.getElementById('hex-answer').style.display = 'block';
    });
    
    document.getElementById('new-hex-question').addEventListener('click', function() {
        startHexPractice();
    });
    
    addLog('Started hexadecimal practice drill', 'info');
}

function showBinaryOctalSteps() {
    if (!window.binaryOctalSteps || window.binaryOctalSteps.length === 0) {
        showError("Please calculate a conversion first to see the steps.");
        return;
    }
    
    document.getElementById('conversion-steps-container').style.display = 'block';
    document.getElementById('steps-content').innerHTML = `
        <h6>Binary  Octal Conversion Steps</h6>
        ${window.binaryOctalSteps.join('')}
    `;
    
    addLog('Displayed binary-octal conversion steps', 'info');
}

function generateBinaryOctalTest() {
    const testExamples = [
        { binary: "101110", octal: "56" },
        { binary: "111001", octal: "71" },
        { binary: "100011", octal: "43" },
        { binary: "110101", octal: "65" }
    ];
    
    const randomExample = testExamples[Math.floor(Math.random() * testExamples.length)];
    
    document.getElementById('bo-binary-value').value = randomExample.binary;
    document.getElementById('bo-octal-value').value = randomExample.octal;
    
    // Trigger calculation
    calculateBinaryOctal();
    
    addLog(`Generated test example: ${randomExample.binary}  ${randomExample.octal}`, 'info');
}

function showBCDTable() {
    document.getElementById('reference-tables').style.display = 'block';
    addLog('Displayed BCD reference table', 'info');
}

function validateBCD() {
    const bcdInput = document.getElementById('bcd-bcd-value').value.trim().replace(/\s+/g, '');
    
    if (!bcdInput) {
        showError("Please enter a BCD value to validate.");
        return;
    }
    
    if (!isValidBCD(bcdInput)) {
        showError("Invalid BCD format. Must be groups of 4 binary digits.");
        return;
    }
    
    const resultsDiv = document.getElementById('number-system-results');
    let validationResult = "<h6>BCD Validation Results:</h6>";
    let allValid = true;
    
    for (let i = 0; i < bcdInput.length; i += 4) {
        const group = bcdInput.substr(i, 4);
        const decimalValue = parseInt(group, 2);
        const isValid = decimalValue <= 9;
        
        validationResult += `
            <div class="conversion-step ${isValid ? 'active' : 'error'}">
                Group ${i/4 + 1}: ${group}  Decimal ${decimalValue} ${isValid ? '' : ''}
                ${!isValid ? '<br><small class="text-danger">Invalid: BCD groups must represent 0-9 only</small>' : ''}
            </div>
        `;
        
        if (!isValid) allValid = false;
    }
    
    validationResult += `
        <div class="conversion-step ${allValid ? 'active' : 'error'}">
            <strong>Overall Result:</strong> ${allValid ? ' VALID BCD' : ' INVALID BCD'}
        </div>
    `;
    
    resultsDiv.innerHTML = validationResult;
    addLog('Validated BCD input', allValid ? 'success' : 'error');
}

// Binary  Decimal Functions
function setupBinaryDecimalInterface() {
    const conversionType = document.getElementById('bd-conversion-type');
    const inputType = document.getElementById('bd-input-type');
    const bitLength = document.getElementById('bd-bit-length');
    
    // Show/hide appropriate input fields
    conversionType.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('bd-binary-input').style.display = 
            (type === 'binary-to-decimal' || type === 'bidirectional') ? 'block' : 'none';
        document.getElementById('bd-decimal-input').style.display = 
            (type === 'decimal-to-binary' || type === 'bidirectional') ? 'block' : 'none';
    });
    
    // Set up event listeners
    document.getElementById('calculate-bd-btn').addEventListener('click', calculateBinaryDecimal);
    document.getElementById('show-steps-bd-btn').addEventListener('click', showBinaryDecimalSteps);
    document.getElementById('generate-examples-bd-btn').addEventListener('click', generateBinaryDecimalExamples);
    document.getElementById('reset-bd-btn').addEventListener('click', resetBinaryDecimal);
}

function calculateBinaryDecimal() {
    const startTime = performance.now();
    const conversionType = document.getElementById('bd-conversion-type').value;
    const inputType = document.getElementById('bd-input-type').value;
    const bitLength = parseInt(document.getElementById('bd-bit-length').value);
    
    let result = '';
    let steps = [];
    
    if (conversionType === 'binary-to-decimal' || conversionType === 'bidirectional') {
        const binaryInput = document.getElementById('bd-binary-value').value.trim();
        
        if (!isValidBinary(binaryInput)) {
            showError('Please enter a valid binary number (0s and 1s only)');
            return;
        }
        
        const paddedBinary = binaryInput.padStart(bitLength, '0').slice(-bitLength);
        
        if (inputType === 'unsigned') {
            result = `Decimal: ${parseInt(paddedBinary, 2)}`;
            steps = generateBinaryToDecimalSteps(paddedBinary);
        } else if (inputType === 'signed') {
            // Handle 2's complement
            const decimal = twosComplementToDecimal(paddedBinary);
            result = `Decimal (2's complement): ${decimal}`;
            steps = generateTwosComplementSteps(paddedBinary);
        } else if (inputType === 'fractional') {
            // Handle fractional binary
            const [integerPart, fractionalPart] = binaryInput.split('.');
            const decimal = fractionalBinaryToDecimal(integerPart || '0', fractionalPart || '');
            result = `Decimal: ${decimal}`;
            steps = generateFractionalBinarySteps(integerPart || '0', fractionalPart || '');
        }
    }
    
    if (conversionType === 'decimal-to-binary' || conversionType === 'bidirectional') {
        const decimalInput = document.getElementById('bd-decimal-value').value.trim();
        
        if (!isValidDecimal(decimalInput)) {
            showError('Please enter a valid decimal number');
            return;
        }
        
        const decimal = parseInt(decimalInput);
        
        if (inputType === 'unsigned') {
            const binary = decimal.toString(2).padStart(bitLength, '0');
            result += result ? '<br>' : '';
            result += `Binary: ${binary}`;
            steps = steps.concat(generateDecimalToBinarySteps(decimal, bitLength));
        } else if (inputType === 'signed') {
            const binary = decimalToTwosComplement(decimal, bitLength);
            result += result ? '<br>' : '';
            result += `Binary (2's complement): ${binary}`;
            steps = steps.concat(generateDecimalToTwosComplementSteps(decimal, bitLength));
        }
    }
    
    const endTime = performance.now();
    const calculationTime = Math.round(endTime - startTime);
    
    // Update results
    document.getElementById('conversion-result').innerHTML = result;
    document.getElementById('conversion-time').textContent = calculationTime + ' ms';
    document.getElementById('conversion-steps').textContent = steps.length;
    
    // Store steps for detailed view
    window.binaryDecimalSteps = steps;
    
    addLog(`Performed ${conversionType} conversion (${inputType}, ${bitLength}-bit)`, 'success');
}

function generateBinaryToDecimalSteps(binary) {
    const steps = [];
    const length = binary.length;
    
    steps.push(`<div class="conversion-step active"><strong>Step 1: Identify bit positions</strong><br>${binary.split('').map((bit, i) => `${bit}2^${length-1-i}`).join(' + ')}</div>`);
    
    let calculation = '';
    let sum = 0;
    for (let i = 0; i < length; i++) {
        const bit = parseInt(binary[i]);
        const power = length - 1 - i;
        const value = bit * Math.pow(2, power);
        sum += value;
        calculation += `${bit}2^${power}=${value}`;
        if (i < length - 1) calculation += ' + ';
    }
    steps.push(`<div class="conversion-step"><strong>Step 2: Calculate powers</strong><br>${calculation}</div>`);
    steps.push(`<div class="conversion-step"><strong>Step 3: Sum values</strong><br>${sum}</div>`);
    
    return steps;
}

// Binary  Hexadecimal Functions
function setupBinaryHexInterface() {
    const conversionType = document.getElementById('bh-conversion-type');
    
    conversionType.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('bh-binary-input').style.display = 
            (type === 'binary-to-hex' || type === 'bidirectional') ? 'block' : 'none';
        document.getElementById('bh-hex-input').style.display = 
            (type === 'hex-to-binary' || type === 'bidirectional') ? 'block' : 'none';
    });
    
    // Event listeners
    document.getElementById('calculate-bh-btn').addEventListener('click', calculateBinaryHex);
    document.getElementById('show-table-bh-btn').addEventListener('click', showHexTable);
    document.getElementById('practice-bh-btn').addEventListener('click', startHexPractice);
    document.getElementById('reset-bh-btn').addEventListener('click', resetBinaryHex);
}

function calculateBinaryHex() {
    const conversionType = document.getElementById('bh-conversion-type').value;
    const groupSize = parseInt(document.getElementById('bh-group-size').value);
    
    if (conversionType === 'binary-to-hex' || conversionType === 'bidirectional') {
        const binaryInput = document.getElementById('bh-binary-value').value.trim();
        
        if (!isValidBinary(binaryInput)) {
            showError('Invalid binary input');
            return;
        }
        
        // Pad binary to make groups of 4
        const paddedLength = Math.ceil(binaryInput.length / 4) * 4;
        const paddedBinary = binaryInput.padStart(paddedLength, '0');
        
        // Convert to hex
        let hexResult = '';
        let steps = [];
        
        for (let i = 0; i < paddedBinary.length; i += 4) {
            const group = paddedBinary.substr(i, 4);
            const hexDigit = parseInt(group, 2).toString(16).toUpperCase();
            hexResult += hexDigit;
            steps.push(`<div class="conversion-step">Group ${group}  ${hexDigit}</div>`);
        }
        
        document.getElementById('conversion-result').innerHTML = `Hexadecimal: ${hexResult}`;
        window.binaryHexSteps = steps;
    }
    
    if (conversionType === 'hex-to-binary' || conversionType === 'bidirectional') {
        const hexInput = document.getElementById('bh-hex-value').value.trim().toUpperCase();
        
        if (!isValidHex(hexInput)) {
            showError('Invalid hexadecimal input');
            return;
        }
        
        let binaryResult = '';
        let steps = [];
        
        for (let i = 0; i < hexInput.length; i++) {
            const hexDigit = hexInput[i];
            const binaryDigit = parseInt(hexDigit, 16).toString(2).padStart(4, '0');
            binaryResult += binaryDigit + ' ';
            steps.push(`<div class="conversion-step">${hexDigit}  ${binaryDigit}</div>`);
        }
        
        document.getElementById('conversion-result').innerHTML = `Binary: ${binaryResult.trim()}`;
        window.binaryHexSteps = steps;
    }
}

// Binary  Octal Functions
function setupBinaryOctalInterface() {
    const conversionType = document.getElementById('bo-conversion-type');
    
    conversionType.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('bo-binary-input').style.display = 
            (type === 'binary-to-octal' || type === 'bidirectional') ? 'block' : 'none';
        document.getElementById('bo-octal-input').style.display = 
            (type === 'octal-to-binary' || type === 'bidirectional') ? 'block' : 'none';
    });
    
    // Event listeners
    document.getElementById('calculate-bo-btn').addEventListener('click', calculateBinaryOctal);
    document.getElementById('show-steps-bo-btn').addEventListener('click', showBinaryOctalSteps);
    document.getElementById('generate-bo-btn').addEventListener('click', generateBinaryOctalTest);
    document.getElementById('reset-bo-btn').addEventListener('click', resetBinaryOctal);
}

function calculateBinaryOctal() {
    const conversionType = document.getElementById('bo-conversion-type').value;
    
    if (conversionType === 'binary-to-octal' || conversionType === 'bidirectional') {
        const binaryInput = document.getElementById('bo-binary-value').value.trim();
        
        if (!isValidBinary(binaryInput)) {
            showError('Invalid binary input');
            return;
        }
        
        // Pad binary to make groups of 3
        const paddedLength = Math.ceil(binaryInput.length / 3) * 3;
        const paddedBinary = binaryInput.padStart(paddedLength, '0');
        
        let octalResult = '';
        let steps = [];
        
        for (let i = 0; i < paddedBinary.length; i += 3) {
            const group = paddedBinary.substr(i, 3);
            const octalDigit = parseInt(group, 2).toString(8);
            octalResult += octalDigit;
            steps.push(`<div class="conversion-step">Group ${group}  ${octalDigit}</div>`);
        }
        
        document.getElementById('conversion-result').innerHTML = `Octal: ${octalResult}`;
        window.binaryOctalSteps = steps;
    }
    
    if (conversionType === 'octal-to-binary' || conversionType === 'bidirectional') {
        const octalInput = document.getElementById('bo-octal-value').value.trim();
        
        if (!isValidOctal(octalInput)) {
            showError('Invalid octal input');
            return;
        }
        
        let binaryResult = '';
        let steps = [];
        
        for (let i = 0; i < octalInput.length; i++) {
            const octalDigit = octalInput[i];
            const binaryDigit = parseInt(octalDigit, 8).toString(2).padStart(3, '0');
            binaryResult += binaryDigit + ' ';
            steps.push(`<div class="conversion-step">${octalDigit}  ${binaryDigit}</div>`);
        }
        
        document.getElementById('conversion-result').innerHTML = `Binary: ${binaryResult.trim()}`;
        window.binaryOctalSteps = steps;
    }
}

// BCD Functions
function setupBCDInterface() {
    const operationType = document.getElementById('bcd-operation-type');
    
    operationType.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('bcd-decimal-input').style.display = 
            (type === 'encode' || type === 'addition' || type === 'subtraction') ? 'block' : 'none';
        document.getElementById('bcd-bcd-input').style.display = 
            (type === 'decode') ? 'block' : 'none';
        document.getElementById('bcd-second-input').style.display = 
            (type === 'addition' || type === 'subtraction') ? 'block' : 'none';
    });
    
    // Event listeners
    document.getElementById('calculate-bcd-btn').addEventListener('click', calculateBCD);
    document.getElementById('show-bcd-table-btn').addEventListener('click', showBCDTable);
    document.getElementById('validate-bcd-btn').addEventListener('click', validateBCD);
    document.getElementById('reset-bcd-btn').addEventListener('click', resetBCD);
}

function calculateBCD() {
    const operationType = document.getElementById('bcd-operation-type').value;
    
    if (operationType === 'encode') {
        const decimalInput = document.getElementById('bcd-decimal-value').value.trim();
        
        if (!isValidDecimal(decimalInput)) {
            showError('Invalid decimal input');
            return;
        }
        
        let bcdResult = '';
        let steps = [];
        
        for (let i = 0; i < decimalInput.length; i++) {
            const digit = decimalInput[i];
            const bcdDigit = parseInt(digit).toString(2).padStart(4, '0');
            bcdResult += bcdDigit + ' ';
            steps.push(`<div class="conversion-step">Digit ${digit}  ${bcdDigit}</div>`);
        }
        
        document.getElementById('conversion-result').innerHTML = `BCD: ${bcdResult.trim()}`;
        window.bcdSteps = steps;
    }
    
    if (operationType === 'decode') {
        const bcdInput = document.getElementById('bcd-bcd-value').value.trim().replace(/\s+/g, '');
        
        if (!isValidBCD(bcdInput)) {
            showError('Invalid BCD input');
            return;
        }
        
        let decimalResult = '';
        let steps = [];
        
        for (let i = 0; i < bcdInput.length; i += 4) {
            const bcdGroup = bcdInput.substr(i, 4);
            const decimalDigit = parseInt(bcdGroup, 2);
            if (decimalDigit > 9) {
                showError(`Invalid BCD group ${bcdGroup} (must be  9)`);
                return;
            }
            decimalResult += decimalDigit;
            steps.push(`<div class="conversion-step">BCD ${bcdGroup}  ${decimalDigit}</div>`);
        }
        
        document.getElementById('conversion-result').innerHTML = `Decimal: ${decimalResult}`;
        window.bcdSteps = steps;
    }
    
    // Handle BCD addition and subtraction
    if (operationType === 'addition' || operationType === 'subtraction') {
        const decimal1 = document.getElementById('bcd-decimal-value').value.trim();
        const decimal2 = document.getElementById('bcd-second-value').value.trim();
        
        if (!isValidDecimal(decimal1) || !isValidDecimal(decimal2)) {
            showError('Invalid decimal inputs');
            return;
        }
        
        const result = operationType === 'addition' ? 
            bcdAddition(decimal1, decimal2) : 
            bcdSubtraction(decimal1, decimal2);
            
        document.getElementById('conversion-result').innerHTML = 
            `BCD ${operationType}: ${result}`;
    }
}
function reviewQuestions() {
    const container = document.getElementById('questions-container');
    let reviewHTML = '<div class="practice-question"><h5 class="text-center mb-3">Question Review</h5>';
    
    practiceQuestions.forEach((question, index) => {
        const userAnswer = question.userAnswer !== undefined ? 
            `Your answer: ${question.options[question.userAnswer]}` : 
            'Not answered';
        const correctAnswer = `Correct answer: ${question.options[question.correct]}`;
        
        reviewHTML += `
            <div class="conversion-step ${question.userAnswer === question.correct ? 'active' : 'error'}">
                <strong>Q${index + 1}:</strong> ${question.question}<br>
                ${userAnswer}<br>
                ${correctAnswer}<br>
                <small>${question.explanation}</small>
            </div>
        `;
    });
    
    reviewHTML += `
        <div class="d-grid gap-2 mt-3">
            <button class="btn-glow" id="back-to-results">
                <i class="fas fa-arrow-left me-1"></i>Back to Results
            </button>
        </div>
    </div>`;
    
    container.innerHTML = reviewHTML;
    
    document.getElementById('back-to-results').addEventListener('click', function() {
        endPracticeTest();
    });
}
// Add this function to show detailed steps for 2's complement
function generateTwosComplementSteps(binary) {
    const steps = [];
    const length = binary.length;
    
    steps.push(`<div class="conversion-step active"><strong>Step 1: Check MSB (Most Significant Bit)</strong><br>MSB = ${binary[0]}  ${binary[0] === '1' ? 'Negative number (2\'s complement)' : 'Positive number'}</div>`);
    
    if (binary[0] === '1') {
        steps.push(`<div class="conversion-step"><strong>Step 2: Invert all bits</strong><br>${binary}  ${binary.split('').map(bit => bit === '0' ? '1' : '0').join('')}</div>`);
        
        steps.push(`<div class="conversion-step"><strong>Step 3: Add 1 to inverted value</strong><br>${binary.split('').map(bit => bit === '0' ? '1' : '0').join('')} + 1 = ${twosComplementToDecimal(binary)}</div>`);
        
        steps.push(`<div class="conversion-step"><strong>Step 4: Apply negative sign</strong><br>-${-twosComplementToDecimal(binary)}</div>`);
    } else {
        steps.push(`<div class="conversion-step"><strong>Step 2: Convert as normal binary</strong><br>${binary} = ${parseInt(binary, 2)}</div>`);
    }
    
    return steps;
}

function generateFractionalBinarySteps(integerPart, fractionalPart) {
    const steps = [];
    
    steps.push(`<div class="conversion-step active"><strong>Step 1: Convert integer part</strong><br>${integerPart} = ${parseInt(integerPart, 2)}</div>`);
    
    if (fractionalPart) {
        let fractionalCalculation = "";
        let fractionalSum = 0;
        
        for (let i = 0; i < fractionalPart.length; i++) {
            const bit = parseInt(fractionalPart[i]);
            const value = bit * Math.pow(2, -(i + 1));
            fractionalSum += value;
            fractionalCalculation += `${bit}2^-${i+1}=${value.toFixed(3)}`;
            if (i < fractionalPart.length - 1) fractionalCalculation += ' + ';
        }
        
        steps.push(`<div class="conversion-step"><strong>Step 2: Convert fractional part</strong><br>.${fractionalPart} = ${fractionalCalculation}</div>`);
        steps.push(`<div class="conversion-step"><strong>Step 3: Calculate fractional sum</strong><br>= ${fractionalSum.toFixed(3)}</div>`);
        steps.push(`<div class="conversion-step"><strong>Step 4: Combine integer and fractional parts</strong><br>${parseInt(integerPart, 2)} + ${fractionalSum.toFixed(3)} = ${fractionalBinaryToDecimal(integerPart, fractionalPart)}</div>`);
    }
    
    return steps;
}

function generateDecimalToBinarySteps(decimal, bitLength) {
    const steps = [];
    let num = Math.abs(decimal);
    let binaryString = "";
    
    steps.push(`<div class="conversion-step active"><strong>Step 1: Divide by 2 repeatedly</strong><br>Converting ${decimal} to binary:</div>`);
    
    let stepCount = 1;
    while (num > 0) {
        const remainder = num % 2;
        binaryString = remainder + binaryString;
        steps.push(`<div class="conversion-step">Step ${stepCount++}: ${num}  2 = ${Math.floor(num/2)} remainder ${remainder}</div>`);
        num = Math.floor(num / 2);
    }
    
    if (binaryString === "") binaryString = "0";
    
    steps.push(`<div class="conversion-step"><strong>Step ${stepCount}: Result</strong><br>${decimal} = ${binaryString}</div>`);
    
    if (binaryString.length < bitLength) {
        steps.push(`<div class="conversion-step"><strong>Step ${stepCount + 1}: Pad to ${bitLength} bits</strong><br>${binaryString}  ${binaryString.padStart(bitLength, '0')}</div>`);
    }
    
    return steps;
}

function generateDecimalToTwosComplementSteps(decimal, bitLength) {
    const steps = [];
    
    if (decimal >= 0) {
        steps.push(`<div class="conversion-step active"><strong>Step 1: Positive number</strong><br>${decimal}  0, so use normal binary conversion</div>`);
        steps.push(...generateDecimalToBinarySteps(decimal, bitLength));
    } else {
        steps.push(`<div class="conversion-step active"><strong>Step 1: Negative number</strong><br>${decimal} < 0, using 2's complement representation</div>`);
        
        // Convert absolute value to binary
        const absBinary = Math.abs(decimal).toString(2).padStart(bitLength, '0');
        steps.push(`<div class="conversion-step"><strong>Step 2: Convert absolute value to ${bitLength}-bit binary</strong><br>|${decimal}| = ${Math.abs(decimal)}  ${absBinary}</div>`);
        
        // Invert bits
        const inverted = absBinary.split('').map(bit => bit === '0' ? '1' : '0').join('');
        steps.push(`<div class="conversion-step"><strong>Step 3: Invert all bits</strong><br>${absBinary}  ${inverted}</div>`);
        
        // Add 1
        const result = decimalToTwosComplement(decimal, bitLength);
        steps.push(`<div class="conversion-step"><strong>Step 4: Add 1 to inverted value</strong><br>${inverted} + 1 = ${result}</div>`);
        
        steps.push(`<div class="conversion-step"><strong>Step 5: Final 2's complement</strong><br>${decimal} = ${result} (${bitLength}-bit 2's complement)</div>`);
    }
    
    return steps;
}

// Initialize the event listeners properly
function initializeNumberSystemListeners() {
    // Make sure all event listeners are properly attached
    const buttons = [
        { id: 'show-steps-bd-btn', func: showBinaryDecimalSteps },
        { id: 'generate-examples-bd-btn', func: generateBinaryDecimalExamples },
        { id: 'show-table-bh-btn', func: showHexTable },
        { id: 'practice-bh-btn', func: startHexPractice },
        { id: 'show-steps-bo-btn', func: showBinaryOctalSteps },
        { id: 'generate-bo-btn', func: generateBinaryOctalTest },
        { id: 'show-bcd-table-btn', func: showBCDTable },
        { id: 'validate-bcd-btn', func: validateBCD }
    ];
    
    buttons.forEach(btn => {
        const element = document.getElementById(btn.id);
        if (element) {
            // Remove any existing listeners to prevent duplicates
            element.removeEventListener('click', btn.func);
            element.addEventListener('click', btn.func);
        }
    });
}

// Call this function when the Number System tab is loaded
function selectNumberSystemOperation(operation) {
    currentNumberSystemOperation = operation;
    
    // Hide all input sections
    document.getElementById('binary-decimal-inputs').style.display = 'none';
    document.getElementById('binary-hex-inputs').style.display = 'none';
    document.getElementById('binary-octal-inputs').style.display = 'none';
    document.getElementById('bcd-inputs').style.display = 'none';
    
    // Show selected input section
    document.getElementById(operation + '-inputs').style.display = 'block';
    
    // Initialize listeners for the selected operation
    initializeNumberSystemListeners();
    
    // Update interface based on operation
    updateNumberSystemInterface();
    
    addLog(`Selected ${operation.replace('-', ' ')} operation`, 'info');
}

// Practice Test Functions
function startQuickPracticeTest() {
    practiceQuestions = generatePracticeQuestions();
    currentQuestionIndex = 0;
    practiceScore = 0;
    practiceTime = 0;
    isPracticeActive = true;
    
    document.getElementById('practice-questions').style.display = 'block';
    document.getElementById('reference-tables').style.display = 'none';
    document.getElementById('conversion-steps-container').style.display = 'none';
    
    // Start timer
    startPracticeTimer();
    
    // Display first question
    displayPracticeQuestion();
    
    addLog('Started quick practice test', 'info');
}

function startPracticeTimer() {
    if (practiceTimerInterval) {
        clearInterval(practiceTimerInterval);
    }
    
    practiceTimerInterval = setInterval(() => {
        practiceTime++;
        updatePracticeTimer();
    }, 1000);
}

function updatePracticeTimer() {
    const minutes = Math.floor(practiceTime / 60);
    const seconds = practiceTime % 60;
    const timerDisplay = document.querySelector('#practice-questions .practice-timer');
    if (timerDisplay) {
        timerDisplay.innerHTML = `<i class="fas fa-clock me-2"></i>Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
}

function stopPracticeTimer() {
    if (practiceTimerInterval) {
        clearInterval(practiceTimerInterval);
        practiceTimerInterval = null;
    }
}

function generatePracticeQuestions() {
    const questions = [];
    
    // Binary  Decimal questions
    for (let i = 0; i < 5; i++) {
        const binary = Math.floor(Math.random() * 256).toString(2).padStart(8, '0');
        questions.push({
            type: 'binary-decimal',
            question: `Convert the binary number ${binary} to decimal.`,
            options: [
                parseInt(binary, 2),
                parseInt(binary, 2) + 1,
                parseInt(binary, 2) - 1,
                parseInt(binary, 2) + 10
            ],
            correct: 0,
            explanation: `Binary ${binary} = ${parseInt(binary, 2)} in decimal`
        });
    }
    
    // Decimal  Binary questions
    for (let i = 0; i < 5; i++) {
        const decimal = Math.floor(Math.random() * 256);
        questions.push({
            type: 'decimal-binary',
            question: `Convert the decimal number ${decimal} to 8-bit binary.`,
            options: [
                decimal.toString(2).padStart(8, '0'),
                (decimal + 1).toString(2).padStart(8, '0'),
                (decimal - 1).toString(2).padStart(8, '0'),
                (decimal * 2).toString(2).padStart(8, '0')
            ],
            correct: 0,
            explanation: `Decimal ${decimal} = ${decimal.toString(2).padStart(8, '0')} in binary`
        });
    }
    
    // Binary  Hex questions
    for (let i = 0; i < 5; i++) {
        const binary = Math.floor(Math.random() * 256).toString(2).padStart(8, '0');
        const hex = parseInt(binary, 2).toString(16).toUpperCase();
        questions.push({
            type: 'binary-hex',
            question: `Convert the binary number ${binary} to hexadecimal.`,
            options: [
                hex,
                (parseInt(hex, 16) + 1).toString(16).toUpperCase(),
                (parseInt(hex, 16) - 1).toString(16).toUpperCase(),
                (parseInt(hex, 16) + 16).toString(16).toUpperCase()
            ],
            correct: 0,
            explanation: `Binary ${binary} = ${hex} in hexadecimal`
        });
    }
    
    // BCD questions
    for (let i = 0; i < 5; i++) {
        const decimal = Math.floor(Math.random() * 1000);
        const bcd = decimal.toString().split('').map(d => 
            parseInt(d).toString(2).padStart(4, '0')
        ).join(' ');
        questions.push({
            type: 'bcd',
            question: `Convert the decimal number ${decimal} to BCD.`,
            options: [
                bcd,
                bcd.split('').reverse().join(''),
                (decimal + 1).toString().split('').map(d => 
                    parseInt(d).toString(2).padStart(4, '0')
                ).join(' '),
                (decimal - 1).toString().split('').map(d => 
                    parseInt(d).toString(2).padStart(4, '0')
                ).join(' ')
            ],
            correct: 0,
            explanation: `Decimal ${decimal} = ${bcd} in BCD`
        });
    }
    
    return questions;
}

function displayPracticeQuestion() {
    if (currentQuestionIndex >= practiceQuestions.length) {
        endPracticeTest();
        return;
    }
    
    const question = practiceQuestions[currentQuestionIndex];
    const container = document.getElementById('questions-container');
    
    container.innerHTML = `
        <div class="practice-question">
            <div class="question-number">Question ${currentQuestionIndex + 1} of ${practiceQuestions.length}</div>
            <div class="question-text">${question.question}</div>
            <div class="question-options">
                ${question.options.map((option, index) => `
                    <div class="question-option" data-index="${index}">
                        ${index + 1}. ${option}
                    </div>
                `).join('')}
            </div>
            <div class="practice-stats">
                <div class="practice-stat">
                    <div class="practice-value">${practiceScore}</div>
                    <small>Score</small>
                </div>
                <div class="practice-stat">
                    <div class="practice-value">${Math.round(practiceScore / (currentQuestionIndex + 1) * 100)}%</div>
                    <small>Accuracy</small>
                </div>
                <div class="practice-stat">
                    <div class="practice-value">${currentQuestionIndex + 1}</div>
                    <small>Progress</small>
                </div>
            </div>
        </div>
    `;
    
    // Add event listeners to options
    container.querySelectorAll('.question-option').forEach(option => {
        option.addEventListener('click', function() {
            const selectedIndex = parseInt(this.getAttribute('data-index'));
            checkAnswer(selectedIndex);
        });
    });
}

function checkAnswer(selectedIndex) {
    const question = practiceQuestions[currentQuestionIndex];
    const isCorrect = selectedIndex === question.correct;
    
    if (isCorrect) {
        practiceScore++;
        addLog(`Correct answer for question ${currentQuestionIndex + 1}`, 'success');
    } else {
        addLog(`Incorrect answer for question ${currentQuestionIndex + 1}`, 'error');
    }
    
    // Show correct answer and explanation
    const container = document.getElementById('questions-container');
    const questionDiv = container.querySelector('.practice-question');
    
    questionDiv.innerHTML += `
        <div class="question-explanation">
            <strong>${isCorrect ? ' Correct!' : ' Incorrect'}</strong><br>
            Correct answer: ${question.options[question.correct]}<br>
            Explanation: ${question.explanation}
        </div>
        <div class="d-grid gap-2 mt-3">
            <button class="btn-glow" id="next-question-btn">
                <i class="fas fa-arrow-right me-1"></i>Next Question
            </button>
        </div>
    `;
    
    document.getElementById('next-question-btn').addEventListener('click', function() {
        currentQuestionIndex++;
        displayPracticeQuestion();
    });
}

function endPracticeTest() {
    stopPracticeTimer();
    isPracticeActive = false;
    
    const container = document.getElementById('questions-container');
    const accuracy = Math.round(practiceScore / practiceQuestions.length * 100);
    const minutes = Math.floor(practiceTime / 60);
    const seconds = practiceTime % 60;
    
    container.innerHTML = `
        <div class="practice-question">
            <h5 class="text-center mb-3">Practice Test Complete!</h5>
            <div class="text-center">
                <i class="fas fa-trophy fa-3x" style="color: var(--warning-color); margin-bottom: 20px;"></i>
            </div>
            <div class="practice-stats">
                <div class="practice-stat">
                    <div class="practice-value">${practiceScore}/${practiceQuestions.length}</div>
                    <small>Score</small>
                </div>
                <div class="practice-stat">
                    <div class="practice-value">${accuracy}%</div>
                    <small>Accuracy</small>
                </div>
                <div class="practice-stat">
                    <div class="practice-value">${minutes}:${seconds.toString().padStart(2, '0')}</div>
                    <small>Time</small>
                </div>
            </div>
            <div class="mt-4">
                <h6>Performance Analysis:</h6>
                <p>${getPerformanceFeedback(accuracy)}</p>
            </div>
            <div class="d-grid gap-2 mt-3">
                <button class="btn-glow" id="restart-test-btn">
                    <i class="fas fa-redo me-1"></i>Restart Test
                </button>
                <button class="btn-glow" id="review-questions-btn">
                    <i class="fas fa-list-ol me-1"></i>Review Questions
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('restart-test-btn').addEventListener('click', startQuickPracticeTest);
    document.getElementById('review-questions-btn').addEventListener('click', reviewQuestions);
    
    addLog(`Completed practice test with score ${practiceScore}/${practiceQuestions.length} (${accuracy}%)`, 'info');
}

function getPerformanceFeedback(accuracy) {
    if (accuracy >= 90) return "Excellent! You have mastered number system conversions.";
    if (accuracy >= 75) return "Good job! You have a strong understanding of number systems.";
    if (accuracy >= 60) return "Fair performance. Review the concepts you missed.";
    return "Needs improvement. Focus on practicing more conversions.";
}

// GATE Practice Questions
function loadGATEPracticeQuestions() {
    const gateQuestions = [
        {
            year: 2023,
            difficulty: 'medium',
            question: "The 16-bit 2's complement representation of an integer is 1111 1111 1111 0101. Its decimal value is:",
            options: ["-11", "-10", "-9", "-8"],
            correct: 1,
            explanation: "2's complement: Invert bits and add 1, or use negative weighting of MSB. 1111 1111 1111 0101 = -11? Let's check: MSB (bit 15) has weight -2^15, rest positive. Actually: -32768 + 16384 + ... = -11"
        },
        {
            year: 2022,
            difficulty: 'easy',
            question: "The number of 1's in the binary representation of (3^4096 + 15^256) is:",
            options: ["5", "6", "7", "8"],
            correct: 1,
            explanation: "3^4096 is (11) in binary raised to power. This becomes complex but pattern emerges."
        },
        {
            year: 2021,
            difficulty: 'hard',
            question: "The representation of the decimal number (27.625)10 in base-2 is:",
            options: ["11011.101", "11011.110", "10111.101", "10111.110"],
            correct: 0,
            explanation: "27 = 11011, 0.625 = 0.5 + 0.125 = 2^-1 + 2^-3 = .101, so 11011.101"
        },
        {
            year: 2020,
            difficulty: 'medium',
            question: "Consider the 4-to-1 multiplexer with two select lines S1 and S0. For what values of S1 and S0 does the output Q represent the BCD digit for decimal 7?",
            options: ["S1=0, S0=1", "S1=1, S0=0", "S1=1, S0=1", "S1=0, S0=0"],
            correct: 2,
            explanation: "BCD for 7 is 0111. With 4-to-1 MUX, need to check truth table."
        },
        {
            year: 2019,
            difficulty: 'easy',
            question: "The binary number (10101101)2 is equivalent to which hexadecimal number?",
            options: ["AD", "AC", "BD", "BC"],
            correct: 0,
            explanation: "1010 = A, 1101 = D, so AD"
        }
    ];
    
    practiceQuestions = gateQuestions;
    currentQuestionIndex = 0;
    practiceScore = 0;
    
    document.getElementById('practice-questions').style.display = 'block';
    document.getElementById('reference-tables').style.display = 'none';
    document.getElementById('conversion-steps-container').style.display = 'none';
    
    displayGATEQuestion();
    addLog('Loaded GATE previous year questions', 'info');
}

function displayGATEQuestion() {
    if (currentQuestionIndex >= practiceQuestions.length) {
        endGATEPractice();
        return;
    }
    
    const question = practiceQuestions[currentQuestionIndex];
    const container = document.getElementById('questions-container');
    
    container.innerHTML = `
        <div class="gate-question">
            <span class="gate-year">GATE ${question.year}</span>
            <span class="gate-difficulty ${'difficulty-' + question.difficulty}">${question.difficulty.toUpperCase()}</span>
            <div class="question-number">GATE Question ${currentQuestionIndex + 1} of ${practiceQuestions.length}</div>
            <div class="question-text">${question.question}</div>
            <div class="question-options">
                ${question.options.map((option, index) => `
                    <div class="question-option" data-index="${index}">
                        ${String.fromCharCode(65 + index)}. ${option}
                    </div>
                `).join('')}
            </div>
            <div class="practice-stats">
                <div class="practice-stat">
                    <div class="practice-value">${practiceScore}</div>
                    <small>Score</small>
                </div>
                <div class="practice-stat">
                    <div class="practice-value">${currentQuestionIndex + 1}</div>
                    <small>Question</small>
                </div>
            </div>
        </div>
    `;
    
    // Add event listeners
    container.querySelectorAll('.question-option').forEach(option => {
        option.addEventListener('click', function() {
            const selectedIndex = parseInt(this.getAttribute('data-index'));
            checkGATEAnswer(selectedIndex);
        });
    });
}

function checkGATEAnswer(selectedIndex) {
    const question = practiceQuestions[currentQuestionIndex];
    const isCorrect = selectedIndex === question.correct;
    
    if (isCorrect) {
        practiceScore++;
    }
    
    const container = document.getElementById('questions-container');
    const questionDiv = container.querySelector('.gate-question');
    
    // Show explanation
    questionDiv.innerHTML += `
        <div class="question-explanation">
            <strong>${isCorrect ? ' Correct!' : ' Incorrect'}</strong><br>
            <strong>Answer:</strong> ${String.fromCharCode(65 + question.correct)}. ${question.options[question.correct]}<br>
            <strong>Explanation:</strong> ${question.explanation}
        </div>
        <div class="d-grid gap-2 mt-3">
            <button class="btn-glow" id="next-gate-btn">
                <i class="fas fa-arrow-right me-1"></i>${currentQuestionIndex + 1 < practiceQuestions.length ? 'Next Question' : 'View Results'}
            </button>
        </div>
    `;
    
    document.getElementById('next-gate-btn').addEventListener('click', function() {
        currentQuestionIndex++;
        if (currentQuestionIndex < practiceQuestions.length) {
            displayGATEQuestion();
        } else {
            endGATEPractice();
        }
    });
}

function endGATEPractice() {
    const container = document.getElementById('questions-container');
    const accuracy = Math.round(practiceScore / practiceQuestions.length * 100);
    
    container.innerHTML = `
        <div class="gate-question">
            <h5 class="text-center mb-3">GATE Practice Complete!</h5>
            <div class="text-center">
                <i class="fas fa-graduation-cap fa-3x" style="color: var(--primary-color); margin-bottom: 20px;"></i>
            </div>
            <div class="practice-stats">
                <div class="practice-stat">
                    <div class="practice-value">${practiceScore}/${practiceQuestions.length}</div>
                    <small>Score</small>
                </div>
                <div class="practice-stat">
                    <div class="practice-value">${accuracy}%</div>
                    <small>Accuracy</small>
                </div>
            </div>
            <div class="mt-4">
                <h6>GATE Preparation Tips:</h6>
                <ul>
                    <li>Practice number system conversions daily</li>
                    <li>Memorize powers of 2 up to 2^16</li>
                    <li>Understand 2's complement thoroughly</li>
                    <li>Practice BCD addition with carry correction</li>
                    <li>Time yourself during practice</li>
                </ul>
            </div>
            <div class="d-grid gap-2 mt-3">
                <button class="btn-glow" id="retry-gate-btn">
                    <i class="fas fa-redo me-1"></i>Retry GATE Questions
                </button>
                <button class="btn-glow" id="back-to-converter-btn">
                    <i class="fas fa-exchange-alt me-1"></i>Back to Converter
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('retry-gate-btn').addEventListener('click', loadGATEPracticeQuestions);
    document.getElementById('back-to-converter-btn').addEventListener('click', function() {
        document.getElementById('practice-questions').style.display = 'none';
    });
}

// Utility Functions
function isValidBinary(str) {
    return /^[01]+(\.[01]+)?$/.test(str);
}

function isValidDecimal(str) {
    return /^-?\d+$/.test(str);
}

function isValidHex(str) {
    return /^[0-9A-Fa-f]+$/.test(str);
}

function isValidOctal(str) {
    return /^[0-7]+$/.test(str);
}

function isValidBCD(str) {
    return /^[01]+$/.test(str) && str.length % 4 === 0;
}

function showError(message) {
    const resultsDiv = document.getElementById('number-system-results');
    resultsDiv.innerHTML = `
        <div class="conversion-step error">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
    addLog(`Error: ${message}`, 'error');
}

function twosComplementToDecimal(binary) {
    if (binary[0] === '0') {
        return parseInt(binary, 2);
    }
    
    // Invert bits and add 1
    const inverted = binary.split('').map(bit => bit === '0' ? '1' : '0').join('');
    const decimal = parseInt(inverted, 2) + 1;
    return -decimal;
}

function decimalToTwosComplement(decimal, bits) {
    if (decimal >= 0) {
        return decimal.toString(2).padStart(bits, '0');
    }
    
    // For negative numbers
    const positive = (-decimal).toString(2).padStart(bits, '0');
    const inverted = positive.split('').map(bit => bit === '0' ? '1' : '0').join('');
    const twosComp = (parseInt(inverted, 2) + 1).toString(2).padStart(bits, '0');
    return twosComp;
}

function fractionalBinaryToDecimal(integerPart, fractionalPart) {
    let decimal = parseInt(integerPart, 2);
    
    for (let i = 0; i < fractionalPart.length; i++) {
        decimal += parseInt(fractionalPart[i]) * Math.pow(2, -(i + 1));
    }
    
    return decimal.toFixed(fractionalPart.length);
}

function bcdAddition(decimal1, decimal2) {
    // Simple BCD addition (doesn't handle carry correction)
    const num1 = parseInt(decimal1);
    const num2 = parseInt(decimal2);
    const sum = num1 + num2;
    
    // Convert sum to BCD
    const bcd = sum.toString().split('').map(d => 
        parseInt(d).toString(2).padStart(4, '0')
    ).join(' ');
    
    return `${decimal1} + ${decimal2} = ${sum} (BCD: ${bcd})`;
}

function bcdSubtraction(decimal1, decimal2) {
    const num1 = parseInt(decimal1);
    const num2 = parseInt(decimal2);
    const diff = num1 - num2;
    
    if (diff < 0) {
        return `Negative result: ${decimal1} - ${decimal2} = ${diff}`;
    }
    
    const bcd = diff.toString().split('').map(d => 
        parseInt(d).toString(2).padStart(4, '0')
    ).join(' ');
    
    return `${decimal1} - ${decimal2} = ${diff} (BCD: ${bcd})`;
}

// Reset Functions
function resetBinaryDecimal() {
    document.getElementById('bd-binary-value').value = '';
    document.getElementById('bd-decimal-value').value = '';
    document.getElementById('conversion-result').innerHTML = '-';
    document.getElementById('conversion-time').textContent = '0 ms';
    document.getElementById('conversion-steps').textContent = '0';
    updateNumberSystemInterface();
}

function resetBinaryHex() {
    document.getElementById('bh-binary-value').value = '';
    document.getElementById('bh-hex-value').value = '';
    document.getElementById('conversion-result').innerHTML = '-';
    updateNumberSystemInterface();
}

function resetBinaryOctal() {
    document.getElementById('bo-binary-value').value = '';
    document.getElementById('bo-octal-value').value = '';
    document.getElementById('conversion-result').innerHTML = '-';
    updateNumberSystemInterface();
}

function resetBCD() {
    document.getElementById('bcd-decimal-value').value = '';
    document.getElementById('bcd-bcd-value').value = '';
    document.getElementById('bcd-second-value').value = '';
    document.getElementById('conversion-result').innerHTML = '-';
    updateNumberSystemInterface();
}

// Add to your existing addLog function if needed
function addLog(message, type) {
    const logContainer = document.getElementById('operation-log');
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;
    logEntry.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>${message}`;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}
// Update signed magnitude interface based on operation type
function updateSignedMagnitudeInterface() {
    const opType = document.getElementById('sm-operation-type').value;
    const decimalInput = document.getElementById('sm-decimal-input');
    const binaryInput = document.getElementById('sm-binary-input');
    const additionInputs = document.getElementById('sm-addition-inputs');
    
    // Hide all inputs first
    decimalInput.style.display = 'none';
    binaryInput.style.display = 'none';
    additionInputs.style.display = 'none';
    
    // Show relevant inputs
    switch(opType) {
        case 'decimal-to-sm':
            decimalInput.style.display = 'block';
            break;
        case 'sm-to-decimal':
            binaryInput.style.display = 'block';
            break;
        case 'range-analysis':
            // No additional inputs needed
            break;
        case 'addition-example':
            additionInputs.style.display = 'block';
            break;
    }
}

// Signed magnitude conversion functions
function toSignedMagnitude(number, bits) {
    if (bits < 2) {
        throw new Error("Need at least 2 bits for signed magnitude");
    }
    
    // Calculate range
    const maxVal = Math.pow(2, bits - 1) - 1;
    const minVal = -maxVal;
    
    // Check range
    if (number > maxVal || number < minVal) {
        throw new Error(`Number ${number} out of range for ${bits}-bit signed magnitude. Range: [${minVal}, ${maxVal}]`);
    }
    
    // Handle zero (both +0 and -0 possible)
    if (number === 0) {
        const signBit = "0";
        const magnitude = "0".repeat(bits - 1);
        return signBit + magnitude;
    }
    
    // Determine sign and magnitude
    const sign = number >= 0 ? "0" : "1";
    const magnitudeValue = Math.abs(number);
    
    // Convert magnitude to binary
    let magnitudeBinary = magnitudeValue.toString(2);
    
    // Pad magnitude to (bits-1) length
    magnitudeBinary = magnitudeBinary.padStart(bits - 1, '0');
    
    // Ensure magnitude doesn't exceed available bits
    if (magnitudeBinary.length > bits - 1) {
        magnitudeBinary = magnitudeBinary.slice(-(bits - 1));
    }
    
    return sign + magnitudeBinary;
}

function fromSignedMagnitude(binaryStr) {
    if (!binaryStr || !/^[01]+$/.test(binaryStr)) {
        throw new Error("Invalid binary string");
    }
    
    // Extract sign bit and magnitude
    const signBit = binaryStr[0];
    const magnitudeBits = binaryStr.slice(1);
    
    // Convert magnitude to integer
    const magnitude = parseInt(magnitudeBits, 2);
    
    // Apply sign
    return signBit === "0" ? magnitude : -magnitude;
}

// Calculate signed magnitude
function calculateSignedMagnitude() {
    const opType = document.getElementById('sm-operation-type').value;
    const bits = parseInt(document.getElementById('sm-bit-length').value);
    const resultsDiv = document.getElementById('number-system-results');
    
    try {
        switch(opType) {
            case 'decimal-to-sm':
                const decimal = parseInt(document.getElementById('sm-decimal-value').value);
                const smBinary = toSignedMagnitude(decimal, bits);
                resultsDiv.innerHTML = generateDecimalToSMResult(decimal, smBinary, bits);
                break;
                
            case 'sm-to-decimal':
                const binaryStr = document.getElementById('sm-binary-value').value;
                if (!/^[01]+$/.test(binaryStr) || binaryStr.length !== bits) {
                    throw new Error(`Please enter a valid ${bits}-bit binary number`);
                }
                const decimalResult = fromSignedMagnitude(binaryStr);
                resultsDiv.innerHTML = generateSMToDecimalResult(binaryStr, decimalResult);
                break;
                
            case 'range-analysis':
                resultsDiv.innerHTML = generateRangeAnalysis(bits);
                break;
                
            case 'addition-example':
                const a = parseInt(document.getElementById('sm-add-a').value);
                const b = parseInt(document.getElementById('sm-add-b').value);
                resultsDiv.innerHTML = generateAdditionExample(a, b, bits);
                break;
        }
        
        addLog(`Calculated signed magnitude for ${opType}`, 'success');
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="conversion-step error">
                <strong>Error:</strong> ${error.message}
            </div>
        `;
        addLog(`Signed magnitude error: ${error.message}`, 'error');
    }
}

// Generate decimal to signed magnitude result
function generateDecimalToSMResult(decimal, smBinary, bits) {
    const signBit = smBinary[0];
    const magnitudeBits = smBinary.slice(1);
    const magnitudeDecimal = parseInt(magnitudeBits, 2);
    
    return `
        <div class="conversion-results">
            <h5 class="text-center mb-3">Decimal to Signed Magnitude Conversion</h5>
            
            <div class="conversion-step active">
                <div class="conversion-title">Step 1: Input Analysis</div>
                <div class="conversion-content">
                    Decimal Number: ${decimal}<br>
                    Bit Length: ${bits} bits<br>
                    Sign: ${decimal >= 0 ? 'Positive (+)' : 'Negative (-)'}
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Step 2: Calculate Magnitude</div>
                <div class="conversion-content">
                    |${decimal}| = ${Math.abs(decimal)}<br>
                    Binary of ${Math.abs(decimal)} = ${magnitudeDecimal.toString(2)}<br>
                    Padded to ${bits-1} bits = ${magnitudeBits}
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Step 3: Add Sign Bit</div>
                <div class="conversion-content">
                    Sign bit (0=+, 1=-): ${signBit} (${decimal >= 0 ? '0 for positive' : '1 for negative'})<br>
                    Final ${bits}-bit Signed Magnitude: <span class="binary-bit-highlight">${signBit}</span>${magnitudeBits}
                </div>
            </div>
            
            <div class="conversion-step active">
                <div class="conversion-title">Step 4: Result Breakdown</div>
                <div class="conversion-content">
                    <div class="bit-visualization mt-2">
                        ${smBinary.split('').map((bit, index) => `
                            <div class="d-inline-block text-center mx-1">
                                <div class="bit-box ${bit === '1' ? 'active' : 'inactive'}">${bit}</div>
                                <div class="bit-index">${index === 0 ? 'Sign' : `Bit ${index}`}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-3">
                        <strong>Sign bit:</strong> ${signBit} (${signBit === '0' ? 'Positive' : 'Negative'})<br>
                        <strong>Magnitude bits:</strong> ${magnitudeBits} = ${magnitudeDecimal}<br>
                        <strong>Complete Representation:</strong> ${decimal} = ${smBinary} (Signed Magnitude)
                    </div>
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Step 5: Verification</div>
                <div class="conversion-content">
                    Reconstructing from signed magnitude:<br>
                    Sign: ${signBit === '0' ? '+' : '-'}<br>
                    Magnitude: ${magnitudeDecimal}<br>
                    Result: ${signBit === '0' ? '' : '-'}${magnitudeDecimal} = ${fromSignedMagnitude(smBinary)}
                </div>
            </div>
        </div>
    `;
}

// Generate signed magnitude to decimal result
function generateSMToDecimalResult(binaryStr, decimal) {
    const signBit = binaryStr[0];
    const magnitudeBits = binaryStr.slice(1);
    const magnitudeDecimal = parseInt(magnitudeBits, 2);
    
    return `
        <div class="conversion-results">
            <h5 class="text-center mb-3">Signed Magnitude to Decimal Conversion</h5>
            
            <div class="conversion-step active">
                <div class="conversion-title">Step 1: Input Analysis</div>
                <div class="conversion-content">
                    Signed Magnitude Binary: ${binaryStr}<br>
                    Length: ${binaryStr.length} bits<br>
                    Sign bit: ${signBit} (${signBit === '0' ? 'Positive' : 'Negative'})<br>
                    Magnitude bits: ${magnitudeBits}
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Step 2: Extract Magnitude</div>
                <div class="conversion-content">
                    Magnitude bits: ${magnitudeBits}<br>
                    Convert to decimal: ${magnitudeBits} = ${magnitudeDecimal}
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Step 3: Apply Sign</div>
                <div class="conversion-content">
                    Sign bit: ${signBit} (${signBit === '0' ? '0 = Positive' : '1 = Negative'})<br>
                    Final value: ${signBit === '0' ? '' : '-'}${magnitudeDecimal} = ${decimal}
                </div>
            </div>
            
            <div class="conversion-step active">
                <div class="conversion-title">Step 4: Bit Visualization</div>
                <div class="conversion-content">
                    <div class="bit-visualization mt-2">
                        ${binaryStr.split('').map((bit, index) => `
                            <div class="d-inline-block text-center mx-1">
                                <div class="bit-box ${bit === '1' ? 'active' : 'inactive'}">${bit}</div>
                                <div class="bit-index">${index === 0 ? 'Sign' : `Bit ${index}`}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-3">
                        <strong>Interpretation:</strong> ${binaryStr} = ${decimal}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Generate range analysis
function generateRangeAnalysis(bits) {
    const maxVal = Math.pow(2, bits - 1) - 1;
    const minVal = -maxVal;
    const totalValues = 2 * maxVal + 1; // Includes +0 and -0
    
    return `
        <div class="conversion-results">
            <h5 class="text-center mb-3">${bits}-bit Signed Magnitude Range Analysis</h5>
            
            <div class="conversion-step active">
                <div class="conversion-title">General Information</div>
                <div class="conversion-content">
                    <strong>Representation Scheme:</strong> Signed Magnitude<br>
                    <strong>Bit Allocation:</strong> 1 sign bit + ${bits-1} magnitude bits<br>
                    <strong>Total Bits:</strong> ${bits}<br>
                    <strong>Distinct Values:</strong> ${totalValues} (including +0 and -0)
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Range Calculation</div>
                <div class="conversion-content">
                     Magnitude bits: ${bits-1} bits<br>
                     Maximum magnitude: 2^${bits-1} - 1 = ${maxVal}<br>
                     Positive range: 0 to ${maxVal}<br>
                     Negative range: -0 to -${maxVal}<br>
                     Full range: [${minVal}, ${maxVal}]
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Example Values</div>
                <div class="conversion-content">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Positive Numbers:</strong><br>
                             +0: ${toSignedMagnitude(0, bits)}<br>
                             +1: ${toSignedMagnitude(1, bits)}<br>
                             +${maxVal}: ${toSignedMagnitude(maxVal, bits)}
                        </div>
                        <div class="col-md-6">
                            <strong>Negative Numbers:</strong><br>
                             -0: ${toSignedMagnitude(-0, bits)}<br>
                             -1: ${toSignedMagnitude(-1, bits)}<br>
                             -${maxVal}: ${toSignedMagnitude(minVal, bits)}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="conversion-step active">
                <div class="conversion-title">Limitations</div>
                <div class="conversion-content">
                    <div class="alert alert-warning">
                        <strong>Important Notes:</strong><br>
                        1. Two representations of zero: +0 (${toSignedMagnitude(0, bits)}) and -0 (${toSignedMagnitude(-0, bits)})<br>
                        2. Arithmetic operations are complex (need separate sign/magnitude handling)<br>
                        3. Not used in modern computers (2's complement is preferred)<br>
                        4. Addition/subtraction requires sign comparison and magnitude operations
                    </div>
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Comparison with Other Systems</div>
                <div class="conversion-content">
                    <table class="bit-table">
                        <tr>
                            <th>System</th>
                            <th>${bits}-bit Range</th>
                            <th>Zero Representation</th>
                            <th>Arithmetic Complexity</th>
                        </tr>
                        <tr>
                            <td>Signed Magnitude</td>
                            <td>[${minVal}, ${maxVal}]</td>
                            <td>Two (0)</td>
                            <td>Complex</td>
                        </tr>
                        <tr>
                            <td>1's Complement</td>
                            <td>[${minVal}, ${maxVal}]</td>
                            <td>Two (0)</td>
                            <td>Moderate</td>
                        </tr>
                        <tr>
                            <td>2's Complement</td>
                            <td>[${minVal-1}, ${maxVal}]</td>
                            <td>One (0)</td>
                            <td>Simple</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    `;
}

// Generate addition example
function generateAdditionExample(a, b, bits) {
    const aSM = toSignedMagnitude(a, bits);
    const bSM = toSignedMagnitude(b, bits);
    const result = a + b;
    let resultSM;
    
    try {
        resultSM = toSignedMagnitude(result, bits);
    } catch (e) {
        resultSM = "OVERFLOW";
    }
    
    return `
        <div class="conversion-results">
            <h5 class="text-center mb-3">Signed Magnitude Addition Example</h5>
            
            <div class="conversion-step active">
                <div class="conversion-title">Problem Statement</div>
                <div class="conversion-content">
                    Calculate: ${a} + (${b}) = ${a + b}<br>
                    Using ${bits}-bit Signed Magnitude Representation
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Step 1: Convert to Signed Magnitude</div>
                <div class="conversion-content">
                     ${a} = ${aSM} (Sign: ${aSM[0]}, Magnitude: ${aSM.slice(1)})<br>
                     ${b} = ${bSM} (Sign: ${bSM[0]}, Magnitude: ${bSM.slice(1)})<br>
                    <div class="mt-2">
                        <strong>Visual Representation:</strong><br>
                        A = ${aSM}: <span class="binary-bit-0">${aSM[0]}</span>${aSM.slice(1)}<br>
                        B = ${bSM}: <span class="binary-bit-0">${bSM[0]}</span>${bSM.slice(1)}
                    </div>
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Step 2: Signed Magnitude Addition Rules</div>
                <div class="conversion-content">
                    <div class="alert alert-info">
                        <strong>Rules for Signed Magnitude Addition:</strong><br>
                        1. If signs are <strong>same</strong>: Add magnitudes, keep sign<br>
                        2. If signs are <strong>different</strong>: Subtract smaller magnitude from larger,<br>
                           &nbsp;&nbsp;&nbsp;sign = sign of number with larger magnitude<br>
                        3. Check for overflow in magnitude<br>
                        4. Normalize result if needed
                    </div>
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Step 3: Manual Calculation</div>
                <div class="conversion-content">
                    <div class="mt-2">
                        <strong>Sign Analysis:</strong><br>
                         Sign(A): ${aSM[0]} (${a >= 0 ? 'Positive' : 'Negative'})<br>
                         Sign(B): ${bSM[0]} (${b >= 0 ? 'Positive' : 'Negative'})<br>
                         Signs are ${aSM[0] === bSM[0] ? 'EQUAL' : 'DIFFERENT'}
                    </div>
                    
                    <div class="mt-2">
                        <strong>Magnitude Analysis:</strong><br>
                         |A| = ${parseInt(aSM.slice(1), 2)}<br>
                         |B| = ${parseInt(bSM.slice(1), 2)}
                    </div>
                    
                    <div class="mt-2">
                        <strong>Calculation:</strong><br>
                        ${aSM[0] === bSM[0] ? 
                            `Signs are same  Add magnitudes:<br>
                            ${parseInt(aSM.slice(1), 2)} + ${parseInt(bSM.slice(1), 2)} = ${parseInt(aSM.slice(1), 2) + parseInt(bSM.slice(1), 2)}<br>
                            Keep sign: ${aSM[0]}` :
                            `Signs are different  Subtract smaller from larger:<br>
                            |${Math.abs(a)}| ${Math.abs(a) > Math.abs(b) ? '>' : '<'} |${Math.abs(b)}|<br>
                            ${Math.abs(a) > Math.abs(b) ? 
                                `${Math.abs(a)} - ${Math.abs(b)} = ${Math.abs(a) - Math.abs(b)}<br>
                                Sign = sign of A (${aSM[0]})` :
                                `${Math.abs(b)} - ${Math.abs(a)} = ${Math.abs(b) - Math.abs(a)}<br>
                                Sign = sign of B (${bSM[0]})`}`
                        }
                    </div>
                </div>
            </div>
            
            <div class="conversion-step active">
                <div class="conversion-title">Step 4: Result</div>
                <div class="conversion-content">
                    <div class="mt-2">
                        <strong>Decimal Result:</strong> ${a} + (${b}) = ${result}
                    </div>
                    
                    <div class="mt-2">
                        <strong>Signed Magnitude Result:</strong><br>
                        ${resultSM === "OVERFLOW" ? 
                            `<span class="binary-overflow">OVERFLOW: Result ${result} is outside ${bits}-bit range</span>` :
                            `${result} = ${resultSM}`
                        }
                    </div>
                    
                    ${resultSM !== "OVERFLOW" ? `
                    <div class="mt-2">
                        <strong>Verification:</strong><br>
                        Reconstructed from ${resultSM}:<br>
                        Sign: ${resultSM[0]} (${resultSM[0] === '0' ? 'Positive' : 'Negative'})<br>
                        Magnitude: ${resultSM.slice(1)} = ${parseInt(resultSM.slice(1), 2)}<br>
                        Value: ${resultSM[0] === '0' ? '' : '-'}${parseInt(resultSM.slice(1), 2)} = ${fromSignedMagnitude(resultSM)}
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <div class="conversion-step">
                <div class="conversion-title">Step 5: Why Signed Magnitude is Problematic</div>
                <div class="conversion-content">
                    <div class="alert alert-warning">
                        <strong>Issues with Signed Magnitude:</strong><br>
                        1. <strong>Two zeros</strong> (+0 and -0) waste representation<br>
                        2. <strong>Complex arithmetic</strong> requires sign checking and magnitude operations<br>
                        3. <strong>Overflow detection</strong> is complicated<br>
                        4. <strong>Not used in modern CPUs</strong> (2's complement is standard)<br>
                        5. <strong>Example</strong>: Try adding +5 (00000101) and -5 (10000101) = 00000000? No, it's complex!
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Show detailed steps for signed magnitude
function showSignedMagnitudeSteps() {
    const opType = document.getElementById('sm-operation-type').value;
    const bits = parseInt(document.getElementById('sm-bit-length').value);
    const stepsDiv = document.getElementById('steps-content');
    
    stepsDiv.innerHTML = `
        <div class="conversion-step active">
            <div class="conversion-title">Signed Magnitude Representation Theory</div>
            <div class="conversion-content">
                <strong>Definition:</strong> In Signed Magnitude representation:<br>
                1. The leftmost bit (MSB) represents the sign:<br>
                   &nbsp;&nbsp; 0 = Positive number<br>
                   &nbsp;&nbsp; 1 = Negative number<br>
                2. The remaining bits represent the magnitude (absolute value)<br>
                3. Example: 8-bit representation of 5<br>
                   &nbsp;&nbsp; +5 = 00000101 (sign=0, magnitude=101)<br>
                   &nbsp;&nbsp; -5 = 10000101 (sign=1, magnitude=101)
            </div>
        </div>
        
        <div class="conversion-step">
            <div class="conversion-title">Conversion Algorithm</div>
            <div class="conversion-content">
                <strong>Decimal to Signed Magnitude:</strong><br>
                1. Determine sign: if number  0, sign bit = 0, else sign bit = 1<br>
                2. Take absolute value: magnitude = |number|<br>
                3. Convert magnitude to binary using (bits-1) bits<br>
                4. Pad magnitude with leading zeros to (bits-1) bits<br>
                5. Combine: sign bit + magnitude bits<br><br>
                
                <strong>Signed Magnitude to Decimal:</strong><br>
                1. Extract sign bit (first bit)<br>
                2. Extract magnitude bits (remaining bits)<br>
                3. Convert magnitude bits to decimal<br>
                4. Apply sign: if sign bit = 0, result = +magnitude, else result = -magnitude
            </div>
        </div>
        
        <div class="conversion-step">
            <div class="conversion-title">Range Calculation</div>
            <div class="conversion-content">
                For ${bits}-bit Signed Magnitude:<br>
                 Number of magnitude bits = ${bits-1}<br>
                 Maximum magnitude = 2^${bits-1} - 1 = ${Math.pow(2, bits-1) - 1}<br>
                 Positive range: 0 to ${Math.pow(2, bits-1) - 1}<br>
                 Negative range: -0 to -${Math.pow(2, bits-1) - 1}<br>
                 Total distinct values: ${2 * (Math.pow(2, bits-1) - 1) + 2} (including +0 and -0)
            </div>
        </div>
        
        <div class="conversion-step active">
            <div class="conversion-title">Example Walkthrough</div>
            <div class="conversion-content">
                <strong>Example 1:</strong> Convert -13 to 8-bit Signed Magnitude<br>
                1. Sign: negative  sign bit = 1<br>
                2. Magnitude: | -13 | = 13<br>
                3. 13 in binary: 1101<br>
                4. Pad to 7 bits: 0001101<br>
                5. Result: 1 0001101 = 10001101<br><br>
                
                <strong>Example 2:</strong> Convert 10001101 to decimal<br>
                1. Sign bit: 1  negative<br>
                2. Magnitude bits: 0001101<br>
                3. Magnitude decimal: 0001101 = 13<br>
                4. Apply sign: -13
            </div>
        </div>
    `;
    
    document.getElementById('conversion-steps-container').style.display = 'block';
}

// Add event listeners
document.getElementById('calculate-sm-btn')?.addEventListener('click', function() {
    calculateSignedMagnitude();
});

document.getElementById('show-steps-sm-btn')?.addEventListener('click', function() {
    showSignedMagnitudeSteps();
});

document.getElementById('reset-sm-btn')?.addEventListener('click', function() {
    resetSignedMagnitude();
});

// Reset signed magnitude interface
function resetSignedMagnitude() {
    document.getElementById('sm-decimal-value').value = '';
    document.getElementById('sm-binary-value').value = '';
    document.getElementById('sm-add-a').value = '5';
    document.getElementById('sm-add-b').value = '-3';
    document.getElementById('number-system-results').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-balance-scale fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <h4 class="mt-3">Signed Magnitude Representation</h4>
            <p>Select an operation type and enter values</p>
            <p class="small text-muted">Signed Magnitude uses first bit for sign (0=+, 1=-), remaining bits for magnitude</p>
        </div>
    `;
    document.getElementById('conversion-steps-container').style.display = 'none';
    addLog('Reset signed magnitude interface', 'info');
}
// Function to handle binary multiplication selection
function selectBinaryMultiplication() {
    // Hide other input sections
    hideAllNumberSystemInputs();
    
    // Show multiplication inputs
    const inputsSection = document.getElementById('binary-multiplication-inputs');
    inputsSection.style.display = 'block';
    
    // Update results display
    displayMultiplicationInitialView();
}

// Function to perform binary multiplication
function performBinaryMultiplication() {
    const multiplicand = document.getElementById('multiplicand-input').value.trim();
    const multiplier = document.getElementById('multiplier-input').value.trim();
    
    // Validate inputs
    if (!multiplicand || !multiplier) {
        showNumberSystemError("Please enter both multiplicand and multiplier");
        return;
    }
    
    if (!isValidBinary(multiplicand) || !isValidBinary(multiplier)) {
        showNumberSystemError("Please enter valid binary numbers (0s and 1s only)");
        return;
    }
    
    // Perform multiplication
    const startTime = performance.now();
    const result = binaryMultiplicationStepByStep(multiplicand, multiplier);
    const endTime = performance.now();
    
    // Display results
    displayMultiplicationResult(multiplicand, multiplier, result, endTime - startTime);
    addLog(`Binary multiplication: ${multiplicand}  ${multiplier} = ${result.result}`, 'success');
}

// Core binary multiplication function with step-by-step analysis
function binaryMultiplicationStepByStep(a, b) {
    const aDec = parseInt(a, 2);
    const bDec = parseInt(b, 2);
    
    const steps = [];
    let result = 0;
    let shift = 0;
    
    // Process each bit of multiplier from LSB to MSB
    for (let i = b.length - 1; i >= 0; i--) {
        const bit = b[i];
        const position = b.length - 1 - i;
        
        if (bit === '1') {
            const partialProduct = aDec << position;
            steps.push({
                bit: bit,
                position: position,
                action: `${a} << ${position}`,
                partialProduct: partialProduct.toString(2),
                decimal: partialProduct,
                added: true
            });
            result += partialProduct;
        } else {
            steps.push({
                bit: bit,
                position: position,
                action: `Skip (bit is 0)`,
                partialProduct: '0',
                decimal: 0,
                added: false
            });
        }
    }
    
    return {
        multiplicand: a,
        multiplier: b,
        decimalMultiplicand: aDec,
        decimalMultiplier: bDec,
        resultBinary: result.toString(2),
        resultDecimal: result,
        steps: steps,
        finalResult: result.toString(2)
    };
}

// Function to display multiplication results
function displayMultiplicationResult(multiplicand, multiplier, resultData, timeTaken) {
    const resultsDiv = document.getElementById('number-system-results');
    
    let html = `
        <div class="glass-card">
            <h5 class="text-center mb-3">Binary Multiplication Result</h5>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="gate-description">
                        <strong>Input Values:</strong>
                        <div class="mt-2">
                            <div>Multiplicand (A): <span class="binary-bit-highlight">${multiplicand}</span> = ${resultData.decimalMultiplicand}</div>
                            <div>Multiplier (B): <span class="binary-bit-highlight">${multiplier}</span> = ${resultData.decimalMultiplier}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="gate-description">
                        <strong>Result:</strong>
                        <div class="mt-2">
                            <div>Binary: <span class="decimal-highlight">${resultData.resultBinary}</span></div>
                            <div>Decimal: <span class="decimal-highlight">${resultData.resultDecimal}</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="stats-card">
                    <div class="stats-value">${resultData.resultDecimal}</div>
                    <small>Decimal Result</small>
                </div>
                <div class="stats-card mt-2">
                    <div class="stats-value">${timeTaken.toFixed(2)} ms</div>
                    <small>Calculation Time</small>
                </div>
            </div>
        </div>
        
        <div class="gate-description mt-3">
            <h6>Verification:</h6>
            <div class="conversion-formula">
                ${resultData.decimalMultiplicand}  ${resultData.decimalMultiplier} = ${resultData.resultDecimal}
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
    
    // Update steps container
    updateMultiplicationSteps(resultData);
}

// Function to update step-by-step analysis
function updateMultiplicationSteps(resultData) {
    const stepsContainer = document.getElementById('steps-content');
    const conversionContainer = document.getElementById('conversion-steps-container');
    
    conversionContainer.style.display = 'block';
    
    let stepsHtml = `
        <div class="calculation-step active">
            <div class="calculation-title">Binary Multiplication Step-by-Step Analysis</div>
            <div class="calculation-content">
                <div><strong>Method:</strong> Shift-and-Add Algorithm</div>
                <div><strong>Multiplicand:</strong> ${resultData.multiplicand} (${resultData.decimalMultiplicand})</div>
                <div><strong>Multiplier:</strong> ${resultData.multiplier} (${resultData.decimalMultiplier})</div>
                <hr>
                
                <div><strong>Step 1:</strong> Examine multiplier bits from LSB to MSB</div>
                <div class="binary-table">
                    <table class="bit-table">
                        <tr>
                            <th>Multiplier Bit</th>
                            <th>Position</th>
                            <th>Operation</th>
                            <th>Partial Product</th>
                            <th>Decimal</th>
                        </tr>
    `;
    
    resultData.steps.forEach((step, index) => {
        stepsHtml += `
            <tr>
                <td class="binary-bit ${step.bit === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${step.bit}</td>
                <td>${step.position}</td>
                <td>${step.action}</td>
                <td>${step.partialProduct}</td>
                <td>${step.decimal}</td>
            </tr>
        `;
    });
    
    stepsHtml += `
                    </table>
                </div>
                
                <div class="mt-3"><strong>Step 2:</strong> Sum all partial products</div>
                <div class="conversion-formula">
                    Sum = ${resultData.steps.filter(s => s.added).map(s => s.decimal).join(' + ')}
                </div>
                <div class="conversion-formula">
                    = ${resultData.resultDecimal} = ${resultData.resultBinary}
                </div>
                
                <div class="mt-3"><strong>Step 3:</strong> Final Result</div>
                <div class="conversion-formula highlight-equation">
                    ${resultData.multiplicand}  ${resultData.multiplier} = ${resultData.resultBinary}
                </div>
                <div class="conversion-formula highlight-equation">
                    ${resultData.decimalMultiplicand}  ${resultData.decimalMultiplier} = ${resultData.resultDecimal}
                </div>
            </div>
        </div>
    `;
    
    stepsContainer.innerHTML = stepsHtml;
}

// Function to show detailed multiplication steps
function showDetailedMultiplicationSteps() {
    const multiplicand = document.getElementById('multiplicand-input').value.trim();
    const multiplier = document.getElementById('multiplier-input').value.trim();
    
    if (!multiplicand || !multiplier) {
        showNumberSystemError("Please enter both numbers first");
        return;
    }
    
    const resultData = binaryMultiplicationStepByStep(multiplicand, multiplier);
    updateMultiplicationSteps(resultData);
}

// Function to generate multiplication examples
function generateMultiplicationExamples() {
    const examples = [
        { a: '1011', b: '1101', desc: '11  13 = 143' },
        { a: '111', b: '101', desc: '7  5 = 35' },
        { a: '1001', b: '111', desc: '9  7 = 63' },
        { a: '1100', b: '1010', desc: '12  10 = 120' }
    ];
    
    const randomExample = examples[Math.floor(Math.random() * examples.length)];
    
    document.getElementById('multiplicand-input').value = randomExample.a;
    document.getElementById('multiplier-input').value = randomExample.b;
    
    addLog(`Generated example: ${randomExample.a}  ${randomExample.b} (${randomExample.desc})`, 'info');
    
    // Auto-calculate
    setTimeout(() => performBinaryMultiplication(), 500);
}

// Function to reset multiplication inputs
function resetMultiplication() {
    document.getElementById('multiplicand-input').value = '';
    document.getElementById('multiplier-input').value = '';
    
    document.getElementById('number-system-results').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-times fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <h4 class="mt-3">Binary Multiplication</h4>
            <p>Enter binary numbers to multiply</p>
        </div>
    `;
    
    document.getElementById('conversion-steps-container').style.display = 'none';
    
    addLog('Binary multiplication inputs cleared', 'info');
}

// Helper function to display initial multiplication view
function displayMultiplicationInitialView() {
    document.getElementById('number-system-results').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-times fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <h4 class="mt-3">Binary Multiplication</h4>
            <p>Shift-and-Add Algorithm</p>
            <p class="small text-muted">Enter two binary numbers to perform multiplication</p>
        </div>
    `;
    
    document.getElementById('conversion-steps-container').style.display = 'none';
}

// Function to select special gate
// Function to select special gate
function selectSpecialGate(gateType) {
    currentSpecialGate = gateType;
    specialGateInputs = [0, 0];
    
    // Update button states
    document.getElementById('tristate-btn').classList.remove('active');
    document.getElementById('transmission-btn').classList.remove('active');
    
    if (gateType === 'tristate') {
        document.getElementById('tristate-btn').classList.add('active');
        document.getElementById('tristate-inputs').style.display = 'block';
        document.getElementById('transmission-inputs').style.display = 'none';
        document.getElementById('special-gate-description').innerHTML = 
            '<strong>Tri-State Buffer:</strong> Active-high enable. Outputs input when enabled (1), High-Z when disabled (0).';
    } else {
        document.getElementById('transmission-btn').classList.add('active');
        document.getElementById('transmission-inputs').style.display = 'block';
        document.getElementById('tristate-inputs').style.display = 'none';
        document.getElementById('special-gate-description').innerHTML = 
            '<strong>Transmission Gate:</strong> Bidirectional switch. Passes signal when control is active (1), High-Z when control is inactive (0).';
    }
    
    // Reset toggle displays
    if (currentSpecialGate === 'tristate') {
        document.getElementById('tristate-data').checked = false;
        document.getElementById('tristate-enable').checked = false;
        
        const dataLabel = document.getElementById('tristate-data').parentElement.parentElement.querySelector('span:last-child');
        const enableLabel = document.getElementById('tristate-enable').parentElement.parentElement.querySelector('span:last-child');
        dataLabel.textContent = '0 (OFF)';
        enableLabel.textContent = '0 (OFF)';
    } else {
        document.getElementById('transmission-signal').checked = false;
        document.getElementById('transmission-control').checked = false;
        
        const signalLabel = document.getElementById('transmission-signal').parentElement.parentElement.querySelector('span:last-child');
        const controlLabel = document.getElementById('transmission-control').parentElement.parentElement.querySelector('span:last-child');
        signalLabel.textContent = '0 (OFF)';
        controlLabel.textContent = '0 (OFF)';
    }
    
    // Update visualization
    updateSpecialGateVisualization();
    
    // Update truth table
    updateSpecialTruthTable();
    
    // Calculate output with analysis
    calculateSpecialGate();
    
    addLog(`Selected ${gateType === 'tristate' ? 'Tri-State Buffer' : 'Transmission Gate'}`, 'info');
}

// Update special gate visualization
function updateSpecialGateVisualization() {
    const visualization = document.getElementById('special-gate-visualization');
    visualization.innerHTML = '';
    
    if (!currentSpecialGate) return;
    
    // Create gate symbol container
    const gateContainer = document.createElement('div');
    gateContainer.className = 'gate-symbol-container';
    
    // Create gate shape based on current gate
    const gateShape = document.createElement('div');
    
    if (currentSpecialGate === 'tristate') {
        gateShape.className = 'gate-shape gate-tristate';
        
        // Create gate label
        const gateLabel = document.createElement('div');
        gateLabel.className = 'gate-label';
        gateLabel.textContent = 'TSB';
        gateShape.appendChild(gateLabel);
        
        // Add input node (data)
        const dataNode = document.createElement('div');
        dataNode.className = `input-node ${specialGateInputs[0] ? 'active' : 'inactive'}`;
        dataNode.textContent = 'D';
        dataNode.style.left = '20%';
        dataNode.style.top = '40%';
        dataNode.style.transform = 'translateY(-50%)';
        dataNode.addEventListener('click', function() {
            toggleSpecialInput(0);
        });
        visualization.appendChild(dataNode);
        
        // Add enable node
        const enableNode = document.createElement('div');
        enableNode.className = `enable-node ${specialGateInputs[1] ? 'active' : 'inactive'}`;
        enableNode.textContent = 'E';
        enableNode.style.left = '20%';
        enableNode.style.top = '60%';
        enableNode.style.transform = 'translateY(-50%)';
        enableNode.addEventListener('click', function() {
            toggleSpecialInput(1);
        });
        visualization.appendChild(enableNode);
        
        // Connection lines
        const dataLine = document.createElement('div');
        dataLine.className = `connection-line ${specialGateInputs[0] ? 'active' : 'inactive'}`;
        dataLine.style.left = '20%';
        dataLine.style.width = '30%';
        dataLine.style.top = '40%';
        dataLine.style.transform = 'translateY(-50%)';
        dataLine.style.height = '6px';
        visualization.appendChild(dataLine);
        
        const enableLine = document.createElement('div');
        enableLine.className = `control-line ${specialGateInputs[1] ? 'active' : 'inactive'}`;
        enableLine.style.left = '20%';
        enableLine.style.width = '30%';
        enableLine.style.top = '60%';
        enableLine.style.transform = 'translateY(-50%)';
        enableLine.style.height = '6px';
        visualization.appendChild(enableLine);
        
    } else { // transmission gate
        gateShape.className = 'gate-shape gate-transmission';
        
        // Create gate label
        const gateLabel = document.createElement('div');
        gateLabel.className = 'gate-label';
        gateLabel.textContent = 'TG';
        gateLabel.style.fontSize = '1.5rem';
        gateShape.appendChild(gateLabel);
        
        // Add signal node
        const signalNode = document.createElement('div');
        signalNode.className = `input-node ${specialGateInputs[0] ? 'active' : 'inactive'}`;
        signalNode.textContent = 'S';
        signalNode.style.left = '20%';
        signalNode.style.top = '40%';
        signalNode.style.transform = 'translateY(-50%)';
        signalNode.addEventListener('click', function() {
            toggleSpecialInput(0);
        });
        visualization.appendChild(signalNode);
        
        // Add control node
        const controlNode = document.createElement('div');
        controlNode.className = `enable-node ${specialGateInputs[1] ? 'active' : 'inactive'}`;
        controlNode.textContent = 'C';
        controlNode.style.left = '20%';
        controlNode.style.top = '60%';
        controlNode.style.transform = 'translateY(-50%)';
        controlNode.addEventListener('click', function() {
            toggleSpecialInput(1);
        });
        visualization.appendChild(controlNode);
        
        // Connection lines
        const signalLine = document.createElement('div');
        signalLine.className = `connection-line ${specialGateInputs[0] ? 'active' : 'inactive'}`;
        signalLine.style.left = '20%';
        signalLine.style.width = '30%';
        signalLine.style.top = '40%';
        signalLine.style.transform = 'translateY(-50%)';
        signalLine.style.height = '6px';
        visualization.appendChild(signalLine);
        
        const controlLine = document.createElement('div');
        controlLine.className = `control-line ${specialGateInputs[1] ? 'active' : 'inactive'}`;
        controlLine.style.left = '20%';
        controlLine.style.width = '30%';
        controlLine.style.top = '60%';
        controlLine.style.transform = 'translateY(-50%)';
        controlLine.style.height = '6px';
        visualization.appendChild(controlLine);
    }
    
    gateContainer.appendChild(gateShape);
    visualization.appendChild(gateContainer);
    
    // Add output node
    const outputValue = calculateSpecialOutput();
    const outputNode = document.createElement('div');
    outputNode.className = outputValue === 'Z' ? 'output-node high-z-state' : 
                         outputValue === 1 ? 'output-node active' : 'output-node inactive';
    outputNode.textContent = outputValue === 'Z' ? 'Z' : 'Q';
    outputNode.style.right = '20%';
    outputNode.style.top = '50%';
    outputNode.style.transform = 'translateY(-50%)';
    visualization.appendChild(outputNode);
    
    // Output connection
    const outputLine = document.createElement('div');
    outputLine.className = outputValue === 'Z' ? 'connection-line' : 
                          outputValue === 1 ? 'connection-line active' : 'connection-line inactive';
    outputLine.style.left = '50%';
    outputLine.style.width = '30%';
    outputLine.style.top = '50%';
    outputLine.style.transform = 'translateY(-50%)';
    outputLine.style.height = '6px';
    visualization.appendChild(outputLine);
}

// Toggle special gate input
function toggleSpecialInput(index) {
    specialGateInputs[index] = specialGateInputs[index] ? 0 : 1;
    
    // Update toggle display
    if (currentSpecialGate === 'tristate') {
        if (index === 0) {
            const toggle = document.getElementById('tristate-data');
            toggle.checked = specialGateInputs[0] === 1;
            const label = toggle.parentElement.parentElement.querySelector('span:last-child');
            label.textContent = specialGateInputs[0] ? '1 (ON)' : '0 (OFF)';
        } else {
            const toggle = document.getElementById('tristate-enable');
            toggle.checked = specialGateInputs[1] === 1;
            const label = toggle.parentElement.parentElement.querySelector('span:last-child');
            label.textContent = specialGateInputs[1] ? '1 (ON)' : '0 (OFF)';
        }
    } else {
        if (index === 0) {
            const toggle = document.getElementById('transmission-signal');
            toggle.checked = specialGateInputs[0] === 1;
            const label = toggle.parentElement.parentElement.querySelector('span:last-child');
            label.textContent = specialGateInputs[0] ? '1 (ON)' : '0 (OFF)';
        } else {
            const toggle = document.getElementById('transmission-control');
            toggle.checked = specialGateInputs[1] === 1;
            const label = toggle.parentElement.parentElement.querySelector('span:last-child');
            label.textContent = specialGateInputs[1] ? '1 (ON)' : '0 (OFF)';
        }
    }
    
    // Update visualization and output
    updateSpecialGateVisualization();
    calculateSpecialGate();
}

// Calculate special gate output as per Python code
function calculateSpecialOutput() {
    if (currentSpecialGate === 'tristate') {
        // Tri-State Buffer logic
        if (specialGateInputs[1] === 1) { // enable == 1
            return specialGateInputs[0]; // Passes the input
        } else {
            return 'Z'; // High-Z state
        }
    } else {
        // Transmission Gate logic
        if (specialGateInputs[1] === 1) { // control == 1
            return specialGateInputs[0]; // Connected (bidirectional pass)
        } else {
            return 'Z'; // Disconnected
        }
    }
}

// Calculate and display special gate output
// Calculate and display special gate output with step-by-step analysis
function calculateSpecialGate() {
    const outputValue = calculateSpecialOutput();
    document.getElementById('special-output').textContent = outputValue;
    
    // Show step-by-step analysis
    showSpecialStepByStepAnalysis();
    
    // Update truth table highlighting
    updateSpecialTruthTable();
    
    addLog(`${currentSpecialGate === 'tristate' ? 'Tri-State Buffer' : 'Transmission Gate'}: 
           Input=${specialGateInputs[0]}, ${currentSpecialGate === 'tristate' ? 'Enable' : 'Control'}=${specialGateInputs[1]}  Output=${outputValue}`, 'success');
}

// Show step-by-step analysis for special gates
function showSpecialStepByStepAnalysis() {
    const container = document.getElementById('special-analysis');
    const stepsContainer = document.getElementById('special-steps-container');
    
    container.style.display = 'block';
    stepsContainer.innerHTML = '';
    
    let analysisHTML = '';
    
    if (currentSpecialGate === 'tristate') {
        analysisHTML = `
            <div class="calculation-step active">
                <div class="calculation-title">Tri-State Buffer Operation Analysis</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Check Enable Signal</strong></div>
                    <div>Enable (E) = ${specialGateInputs[1]}</div>
                    <div>${specialGateInputs[1] === 1 ? 
                        ' Enable is HIGH (1)  Buffer is ACTIVE' : 
                        ' Enable is LOW (0)  Buffer is DISABLED (High-Z state)'}</div>
                    
                    ${specialGateInputs[1] === 1 ? `
                    <div class="mt-2"><strong>Step 2: Pass Data Input</strong></div>
                    <div>Data Input (D) = ${specialGateInputs[0]}</div>
                    <div>Buffer is active, so output = input</div>
                    ` : `
                    <div class="mt-2"><strong>Step 2: Enter High-Z State</strong></div>
                    <div>Buffer is disabled, output = Z (High-Impedance)</div>
                    <div><em>High-Z state means the output is effectively disconnected from the circuit</em></div>
                    `}
                    
                    <div class="mt-2"><strong>Step 3: Final Output</strong></div>
                    <div class="highlight-equation">
                        Output = ${specialGateInputs[1] === 1 ? specialGateInputs[0] : 'Z'}
                    </div>
                    
                    <div class="mt-2"><strong>Explanation:</strong></div>
                    <ul>
                        <li>Tri-State Buffer has three states: 0, 1, and Z (High-Z)</li>
                        <li>When ENABLE = 1: Output follows input (D)</li>
                        <li>When ENABLE = 0: Output goes to High-Z (disconnected)</li>
                        <li>High-Z allows multiple outputs to share a bus without interference</li>
                    </ul>
                </div>
            </div>
        `;
    } else {
        analysisHTML = `
            <div class="calculation-step active">
                <div class="calculation-title">Transmission Gate Operation Analysis</div>
                <div class="calculation-content">
                    <div><strong>Step 1: Check Control Signal</strong></div>
                    <div>Control (C) = ${specialGateInputs[1]}</div>
                    <div>${specialGateInputs[1] === 1 ? 
                        ' Control is HIGH (1)  Gate is CLOSED/ON' : 
                        ' Control is LOW (0)  Gate is OPEN/OFF'}</div>
                    
                    ${specialGateInputs[1] === 1 ? `
                    <div class="mt-2"><strong>Step 2: Pass Signal Bidirectionally</strong></div>
                    <div>Signal Input (S) = ${specialGateInputs[0]}</div>
                    <div>Gate is closed, signal passes through</div>
                    <div><em>Transmission gates are bidirectional - signal can flow in either direction</em></div>
                    ` : `
                    <div class="mt-2"><strong>Step 2: Enter High-Z State</strong></div>
                    <div>Gate is open, output = Z (High-Impedance)</div>
                    <div><em>Transmission gate acts as an open circuit</em></div>
                    `}
                    
                    <div class="mt-2"><strong>Step 3: Final Output</strong></div>
                    <div class="highlight-equation">
                        Output = ${specialGateInputs[1] === 1 ? specialGateInputs[0] : 'Z'}
                    </div>
                    
                    <div class="mt-2"><strong>Explanation:</strong></div>
                    <ul>
                        <li>Transmission Gate is a bidirectional analog switch</li>
                        <li>When CONTROL = 1: Switch is CLOSED, signal passes through</li>
                        <li>When CONTROL = 0: Switch is OPEN, output is High-Z</li>
                        <li>Unlike Tri-State Buffer, transmission gates can pass analog signals</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    stepsContainer.innerHTML = analysisHTML;
}

// Update special gate truth table
function updateSpecialTruthTable() {
    const table = document.getElementById('special-truth-table');
    const container = document.getElementById('special-truth-table-container');
    
    table.innerHTML = '';
    container.style.display = 'block';
    
    // Create header row
    const headerRow = document.createElement('tr');
    
    if (currentSpecialGate === 'tristate') {
        headerRow.innerHTML = `
            <th>Data (D)</th>
            <th>Enable (E)</th>
            <th>Output</th>
        `;
        
        // Generate truth table for Tri-State Buffer
        for (let data = 0; data <= 1; data++) {
            for (let enable = 0; enable <= 1; enable++) {
                const row = document.createElement('tr');
                const output = enable === 1 ? data : 'Z';
                
                // Highlight current combination
                if (data === specialGateInputs[0] && enable === specialGateInputs[1]) {
                    row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
                    row.style.fontWeight = 'bold';
                }
                
                row.innerHTML = `
                    <td class="${data ? 'active' : 'inactive'}">${data}</td>
                    <td class="${enable ? 'active' : 'inactive'}">${enable}</td>
                    <td class="${output === 'Z' ? 'high-z' : (output ? 'active' : 'inactive')}">
                        ${output}
                    </td>
                `;
                
                table.appendChild(row);
            }
        }
    } else {
        headerRow.innerHTML = `
            <th>Signal (S)</th>
            <th>Control (C)</th>
            <th>Output</th>
        `;
        
        // Generate truth table for Transmission Gate
        for (let signal = 0; signal <= 1; signal++) {
            for (let control = 0; control <= 1; control++) {
                const row = document.createElement('tr');
                const output = control === 1 ? signal : 'Z';
                
                // Highlight current combination
                if (signal === specialGateInputs[0] && control === specialGateInputs[1]) {
                    row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
                    row.style.fontWeight = 'bold';
                }
                
                row.innerHTML = `
                    <td class="${signal ? 'active' : 'inactive'}">${signal}</td>
                    <td class="${control ? 'active' : 'inactive'}">${control}</td>
                    <td class="${output === 'Z' ? 'high-z' : (output ? 'active' : 'inactive')}">
                        ${output}
                    </td>
                `;
                
                table.appendChild(row);
            }
        }
    }
    
    table.insertBefore(headerRow, table.firstChild);
}

// Show special gate truth table
function showSpecialTruthTable() {
    const container = document.getElementById('special-truth-table-container');
    container.style.display = 'block';
    updateSpecialTruthTable();
}

// Animate special gate truth table
// Animate special gate truth table with step-by-step analysis
function animateSpecialTruthTable() {
    const combinations = [
        [0, 0],
        [0, 1],
        [1, 0],
        [1, 1]
    ];
    
    let step = 0;
    const totalSteps = combinations.length;
    
    function animateStep() {
        if (step >= totalSteps) {
            addLog('Special gate animation completed', 'info');
            
            // Show final analysis
            showSpecialStepByStepAnalysis();
            return;
        }
        
        const [data, control] = combinations[step];
        specialGateInputs = [data, control];
        
        // Update toggles
        if (currentSpecialGate === 'tristate') {
            document.getElementById('tristate-data').checked = data === 1;
            document.getElementById('tristate-enable').checked = control === 1;
            
            // Update toggle labels
            const dataLabel = document.getElementById('tristate-data').parentElement.parentElement.querySelector('span:last-child');
            const enableLabel = document.getElementById('tristate-enable').parentElement.parentElement.querySelector('span:last-child');
            dataLabel.textContent = data ? '1 (ON)' : '0 (OFF)';
            enableLabel.textContent = control ? '1 (ON)' : '0 (OFF)';
        } else {
            document.getElementById('transmission-signal').checked = data === 1;
            document.getElementById('transmission-control').checked = control === 1;
            
            // Update toggle labels
            const signalLabel = document.getElementById('transmission-signal').parentElement.parentElement.querySelector('span:last-child');
            const controlLabel = document.getElementById('transmission-control').parentElement.parentElement.querySelector('span:last-child');
            signalLabel.textContent = data ? '1 (ON)' : '0 (OFF)';
            controlLabel.textContent = control ? '1 (ON)' : '0 (OFF)';
        }
        
        // Update visualization
        updateSpecialGateVisualization();
        
        // Show step-by-step analysis for current step
        showAnimationStepAnalysis(step + 1, totalSteps, data, control);
        
        step++;
        setTimeout(animateStep, 1500);
    }
    
    animateStep();
    addLog(`Starting animation for ${currentSpecialGate === 'tristate' ? 'Tri-State Buffer' : 'Transmission Gate'} (${totalSteps} steps)`, 'info');
}

// Show analysis for animation step
function showAnimationStepAnalysis(stepNumber, totalSteps, data, control) {
    const container = document.getElementById('special-analysis');
    const stepsContainer = document.getElementById('special-steps-container');
    
    container.style.display = 'block';
    
    let analysisHTML = '';
    const outputValue = control === 1 ? data : 'Z';
    
    if (currentSpecialGate === 'tristate') {
        analysisHTML = `
            <div class="calculation-step active">
                <div class="calculation-title">Step ${stepNumber} of ${totalSteps}: Tri-State Buffer Animation</div>
                <div class="calculation-content">
                    <div><strong>Configuration:</strong> Data (D) = ${data}, Enable (E) = ${control}</div>
                    
                    <div class="mt-2"><strong>Step-by-Step Analysis:</strong></div>
                    <ol>
                        <li>Enable signal is ${control === 1 ? 'HIGH (1)' : 'LOW (0)'}</li>
                        <li>${control === 1 ? 
                            'Buffer is ACTIVE  Passes input to output' : 
                            'Buffer is DISABLED  Output enters High-Z state'}</li>
                        <li>Data input is ${data}</li>
                        <li>Final output = ${outputValue}</li>
                    </ol>
                    
                    <div class="mt-2"><strong>Result:</strong></div>
                    <div class="highlight-equation">
                        Output = ${outputValue}
                    </div>
                    
                    ${control === 0 ? `
                    <div class="mt-2 high-z-label">
                         High-Z State: Output is effectively disconnected from circuit
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    } else {
        analysisHTML = `
            <div class="calculation-step active">
                <div class="calculation-title">Step ${stepNumber} of ${totalSteps}: Transmission Gate Animation</div>
                <div class="calculation-content">
                    <div><strong>Configuration:</strong> Signal (S) = ${data}, Control (C) = ${control}</div>
                    
                    <div class="mt-2"><strong>Step-by-Step Analysis:</strong></div>
                    <ol>
                        <li>Control signal is ${control === 1 ? 'HIGH (1)' : 'LOW (0)'}</li>
                        <li>${control === 1 ? 
                            'Gate is CLOSED  Signal passes through' : 
                            'Gate is OPEN  Output is High-Z'}</li>
                        <li>Input signal is ${data}</li>
                        <li>Final output = ${outputValue}</li>
                    </ol>
                    
                    <div class="mt-2"><strong>Result:</strong></div>
                    <div class="highlight-equation">
                        Output = ${outputValue}
                    </div>
                    
                    ${control === 0 ? `
                    <div class="mt-2 high-z-label">
                         High-Z State: Gate acts as an open circuit
                    </div>
                    ` : `
                    <div class="mt-2 text-info">
                         Bidirectional: Signal can flow in either direction
                    </div>
                    `}
                </div>
            </div>
        `;
    }
    
    stepsContainer.innerHTML = analysisHTML;
    
    // Add to log
    addLog(`Step ${stepNumber}/${totalSteps}: ${currentSpecialGate === 'tristate' ? 'D=' : 'S='}${data}, ${currentSpecialGate === 'tristate' ? 'E=' : 'C='}${control}  Output=${outputValue}`, 'success');
}

// Reset special gate
// Reset special gate
function resetSpecialGate() {
    specialGateInputs = [0, 0];
    
    // Reset toggles
    if (currentSpecialGate === 'tristate') {
        document.getElementById('tristate-data').checked = false;
        document.getElementById('tristate-enable').checked = false;
        
        // Update toggle labels
        const dataLabel = document.getElementById('tristate-data').parentElement.parentElement.querySelector('span:last-child');
        const enableLabel = document.getElementById('tristate-enable').parentElement.parentElement.querySelector('span:last-child');
        dataLabel.textContent = '0 (OFF)';
        enableLabel.textContent = '0 (OFF)';
    } else {
        document.getElementById('transmission-signal').checked = false;
        document.getElementById('transmission-control').checked = false;
        
        // Update toggle labels
        const signalLabel = document.getElementById('transmission-signal').parentElement.parentElement.querySelector('span:last-child');
        const controlLabel = document.getElementById('transmission-control').parentElement.parentElement.querySelector('span:last-child');
        signalLabel.textContent = '0 (OFF)';
        controlLabel.textContent = '0 (OFF)';
    }
    
    // Update visualization
    updateSpecialGateVisualization();
    
    // Clear analysis
    document.getElementById('special-analysis').style.display = 'none';
    document.getElementById('special-steps-container').innerHTML = '';
    
    // Calculate output
    calculateSpecialGate();
    
    addLog('Special gate reset', 'info');
}

// Initialize Gate PYQ Interface
function initializeGatePYQ() {
    selectedYear = '2023';
    updateYearButtons();
    updateFileInfo();
}

function selectYear(year) {
    selectedYear = year;
    updateYearButtons();
    updatePDFPath(year);
    updateFileInfo();
    addLog(`Selected GATE ${year} question paper`, 'info');
}

function updateYearButtons() {
    document.querySelectorAll('.pyq-year-btn').forEach(btn => {
        if (btn.getAttribute('data-year') === selectedYear) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

function updatePDFPath(year) {
    // Update the PDF path based on selected year
    // For now, using the same file path for all years
    currentPDFPath = `C:\\Users\\ASUS\\Downloads\\GateQuestion${year}.pdf`;
}

function updateFileInfo() {
    document.getElementById('current-filename').textContent = `GateQuestion${selectedYear}.pdf`;
    document.getElementById('current-filepath').textContent = currentPDFPath;
    
    // Simulate file info (in real implementation, you'd get this from the file)
    const size = (2.0 + Math.random() * 1).toFixed(1); // 2.0-3.0 MB
    const pages = 12 + Math.floor(Math.random() * 10); // 12-22 pages
    
    document.getElementById('current-filesize').textContent = `${size} MB`;
    document.getElementById('current-filepages').textContent = pages;
}

function viewQuestionPaper() {
    const pdfDisplayArea = document.getElementById('pdf-display-area');
    
    // Show loading state
    pdfDisplayArea.innerHTML = `
        <div class="pdf-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading GATE ${selectedYear} Question Paper...</p>
            <p class="small text-muted">Please wait while we load the PDF</p>
        </div>
    `;
    
    // Enable navigation buttons
    document.getElementById('prev-page-btn').disabled = false;
    document.getElementById('next-page-btn').disabled = false;
    
    // Simulate PDF loading (in a real app, you would use a PDF library)
    setTimeout(() => {
        totalPages = parseInt(document.getElementById('current-filepages').textContent);
        currentPageNum = 1;
        
        // Update page info
        document.getElementById('current-page').textContent = currentPageNum;
        document.getElementById('total-pages').textContent = totalPages;
        
        // Display PDF content (simulated)
        pdfDisplayArea.innerHTML = `
            <div style="padding: 20px; background: white; border-radius: 5px;">
                <h4 class="text-center mb-4">GATE ${selectedYear} - Digital Logic Question Paper</h4>
                <div class="pdf-frame">
                    <div style="padding: 20px; height: 100%; overflow-y: auto;">
                        <h5>Page ${currentPageNum} of ${totalPages}</h5>
                        <hr>
                        <div style="margin-top: 20px;">
                            <p><strong>Instructions:</strong></p>
                            <ol>
                                <li>This question paper contains 65 questions carrying 100 marks.</li>
                                <li>All questions are compulsory.</li>
                                <li>Multiple Choice Questions (MCQs) carry 1 or 2 marks each.</li>
                                <li>Numerical Answer Type (NAT) questions carry 1 or 2 marks each.</li>
                            </ol>
                            
                            <div style="margin-top: 30px; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <p><strong>Sample Question (Page ${currentPageNum}):</strong></p>
                                <p>Q1. The output of a 2-input XOR gate is HIGH when:</p>
                                <p>A. Both inputs are HIGH</p>
                                <p>B. Both inputs are LOW</p>
                                <p>C. Inputs are different</p>
                                <p>D. Either input is HIGH</p>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <p><strong>Answer Key (Sample):</strong> C. Inputs are different</p>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="text-center mt-3 text-muted">PDF content loaded successfully</p>
            </div>
        `;
        
        addLog(`GATE ${selectedYear} question paper loaded (Page ${currentPageNum}/${totalPages})`, 'success');
    }, 1500);
}

function navigatePDFPage(direction) {
    const newPage = currentPageNum + direction;
    
    if (newPage < 1 || newPage > totalPages) {
        return;
    }
    
    currentPageNum = newPage;
    document.getElementById('current-page').textContent = currentPageNum;
    
    // Update PDF display with new page content
    const pdfFrame = document.querySelector('.pdf-frame');
    if (pdfFrame) {
        pdfFrame.querySelector('h5').textContent = `Page ${currentPageNum} of ${totalPages}`;
        
        // Update sample question for demonstration
        const sampleDiv = pdfFrame.querySelector('div[style*="margin-top: 30px; background"]');
        if (sampleDiv) {
            const questionNumber = (currentPageNum * 2 - 1);
            sampleDiv.innerHTML = `
                <p><strong>Sample Question (Page ${currentPageNum}):</strong></p>
                <p>Q${questionNumber}. The Boolean expression A'B'C' + A'BC' + AB'C' + ABC' simplifies to:</p>
                <p>A. A'B'</p>
                <p>B. C'</p>
                <p>C. A  B</p>
                <p>D. A + B</p>
            `;
        }
    }
    
    // Update navigation buttons state
    document.getElementById('prev-page-btn').disabled = currentPageNum === 1;
    document.getElementById('next-page-btn').disabled = currentPageNum === totalPages;
    
    addLog(`Navigated to page ${currentPageNum} of GATE ${selectedYear} question paper`, 'info');
}

function downloadQuestionPaper() {
    // Create a fake download link
    const downloadLink = document.createElement('a');
    downloadLink.href = '#'; // In real app, this would be the actual PDF URL
    downloadLink.download = `GATE_Digital_Logic_${selectedYear}.pdf`;
    downloadLink.click();
    
    // Show success message
    const pdfDisplayArea = document.getElementById('pdf-display-area');
    const successMsg = document.createElement('div');
    successMsg.className = 'alert alert-success mt-3';
    successMsg.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        Download started: GATE_Digital_Logic_${selectedYear}.pdf
    `;
    pdfDisplayArea.appendChild(successMsg);
    
    // Remove message after 3 seconds
    setTimeout(() => successMsg.remove(), 3000);
    
    addLog(`Download initiated for GATE ${selectedYear} question paper`, 'success');
}

function printQuestionPaper() {
    // Open print dialog
    window.print();
    addLog(`Print dialog opened for GATE ${selectedYear} question paper`, 'info');
}

function downloadPDFDirect() {
    // This would trigger actual file download
    alert(`In a real application, this would download: ${currentPDFPath}`);
    addLog(`Direct download requested for ${currentPDFPath}`, 'info');
}

function printPDF() {
    // This would print the PDF
    alert(`Printing GATE ${selectedYear} question paper...`);
    addLog(`Print requested for GATE ${selectedYear} question paper`, 'info');
}

function savePDFCopy() {
    // This would save a copy of the PDF
    const newName = `GATE_DL_${selectedYear}_Copy.pdf`;
    alert(`Saving copy as: ${newName}`);
    addLog(`PDF copy saved as ${newName}`, 'success');
}

function openPDFFolder() {
    // This would open the folder containing the PDF
    alert(`Opening folder containing: ${currentPDFPath}`);
    addLog(`Opening PDF folder: ${currentPDFPath}`, 'info');
}

function searchInPDF() {
    const searchTerm = prompt('Enter search term:');
    if (searchTerm) {
        alert(`Searching for "${searchTerm}" in GATE ${selectedYear} question paper...`);
        addLog(`Search initiated for: "${searchTerm}" in GATE ${selectedYear} paper`, 'info');
    }
}
// Select advanced operation
function selectAdvancedOperation(operation) {
    currentAdvancedOperation = operation;
    
    // Hide all input sections
    document.getElementById('excess3-inputs').style.display = 'none';
    document.getElementById('hamming-inputs').style.display = 'none';
    
    // Hide results
    document.getElementById('number-system2-steps-container').style.display = 'none';
    document.getElementById('code-reference-tables').style.display = 'none';
    document.getElementById('position-visualization').style.display = 'none';
    
    // Update description
    const descElement = document.getElementById('code-description');
    
    if (operation === 'excess3') {
        document.getElementById('excess3-inputs').style.display = 'block';
        descElement.innerHTML = `
            <strong>Excess-3 Code:</strong> Self-complementing BCD code where each digit is represented by binary value +3.
            <ul class="mt-2 small">
                <li>Decimal 0  0011 (0+3)</li>
                <li>Decimal 5  1000 (5+3)</li>
                <li>Supports easy subtraction using 9's complement</li>
            </ul>
        `;
        updateExcess3Interface();
        addLog('Selected Excess-3 Code operation', 'info');
    } else if (operation === 'hamming') {
        document.getElementById('hamming-inputs').style.display = 'block';
        descElement.innerHTML = `
            <strong>Hamming Code:</strong> Error-correcting code that can detect and correct single-bit errors.
            <ul class="mt-2 small">
                <li>Uses parity bits at power-of-2 positions</li>
                <li>Can detect 2 errors and correct 1 error</li>
                <li>Formula: 2^p  m + p + 1</li>
            </ul>
        `;
        updateHammingInterface();
        addLog('Selected Hamming Code operation', 'info');
    }
}

// Update Excess-3 interface
function updateExcess3Interface() {
    const operation = document.getElementById('excess3-operation').value;
    
    // Show/hide appropriate input fields
    document.getElementById('excess3-decimal-input').style.display = 'none';
    document.getElementById('excess3-code-input').style.display = 'none';
    document.getElementById('excess3-second-input').style.display = 'none';
    
    // Update input placeholders and maxlength based on operation
    if (operation === 'decimal-to-excess3') {
        document.getElementById('excess3-decimal-input').style.display = 'block';
        document.getElementById('excess3-decimal-value').placeholder = "Enter decimal number (e.g., 12345678)";
        document.getElementById('excess3-decimal-value').maxLength = 32;
    } else if (operation === 'excess3-to-decimal') {
        document.getElementById('excess3-code-input').style.display = 'block';
        document.getElementById('excess3-code-value').placeholder = "Enter Excess-3 code (multiple of 4 bits, up to 32 bits)";
        document.getElementById('excess3-code-value').maxLength = 32;
    } else if (operation === 'addition' || operation === 'subtraction') {
        document.getElementById('excess3-decimal-input').style.display = 'block';
        document.getElementById('excess3-second-input').style.display = 'block';
        document.getElementById('excess3-decimal-value').placeholder = "Enter first decimal number";
        document.getElementById('excess3-second-value').placeholder = "Enter second decimal number";
        document.getElementById('excess3-decimal-value').maxLength = 32;
        document.getElementById('excess3-second-value').maxLength = 32;
    }
}

// Add input validation for large numbers
document.getElementById('excess3-decimal-value')?.addEventListener('input', function() {
    const value = this.value;
    if (!/^\d*$/.test(value)) {
        this.value = value.replace(/[^\d]/g, '');
    }
    if (value.length > 32) {
        this.value = value.substring(0, 32);
        addLog('Limited input to 32 digits', 'warning');
    }
});

document.getElementById('excess3-code-value')?.addEventListener('input', function() {
    const value = this.value;
    if (!/^[01]*$/.test(value)) {
        this.value = value.replace(/[^01]/g, '');
    }
    if (value.length > 32) {
        this.value = value.substring(0, 32);
        addLog('Limited input to 32 bits', 'warning');
    }
});

// Update Hamming interface
function updateHammingInterface() {
    const operation = document.getElementById('hamming-operation').value;
    
    // Show/hide appropriate input fields
    document.getElementById('hamming-data-input').style.display = 'none';
    document.getElementById('hamming-encoded-input').style.display = 'none';
    document.getElementById('hamming-error-input').style.display = 'none';
    
    if (operation === 'encode') {
        document.getElementById('hamming-data-input').style.display = 'block';
    } else if (operation === 'decode') {
        document.getElementById('hamming-encoded-input').style.display = 'block';
    } else if (operation === 'single-error' || operation === 'double-error') {
        document.getElementById('hamming-data-input').style.display = 'block';
        document.getElementById('hamming-error-input').style.display = 'block';
    }
}

// Perform Excess-3 operation
function performExcess3Operation() {
    const operation = document.getElementById('excess3-operation').value;
    const stepsContainer = document.getElementById('number-system2-steps-container');
    const stepsContent = document.getElementById('number-system2-steps-content');
    
    stepsContainer.style.display = 'block';
    stepsContent.innerHTML = '';
    
    let steps = [];
    
    if (operation === 'decimal-to-excess3') {
        const decimal = document.getElementById('excess3-decimal-value').value;
        steps = convertDecimalToExcess3(decimal);
    } else if (operation === 'excess3-to-decimal') {
        const code = document.getElementById('excess3-code-value').value;
        steps = convertExcess3ToDecimal(code);
    } else if (operation === 'addition') {
        const num1 = document.getElementById('excess3-decimal-value').value;
        const num2 = document.getElementById('excess3-second-value').value;
        steps = performExcess3Addition(num1, num2);
    } else if (operation === 'subtraction') {
        const num1 = document.getElementById('excess3-decimal-value').value;
        const num2 = document.getElementById('excess3-second-value').value;
        steps = performExcess3Subtraction(num1, num2);
    }
    
    // Display steps
    steps.forEach((step, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.className = `number-system2-step ${index === 0 ? 'active' : ''}`;
        stepDiv.innerHTML = step;
        stepsContent.appendChild(stepDiv);
    });
    
    // Update stats
    document.getElementById('code-steps').textContent = steps.length;
    document.getElementById('code-result').textContent = '';
    
    addLog(`Performed Excess-3 ${operation} operation`, 'success');
}

// Perform Hamming operation
function performHammingOperation() {
    const operation = document.getElementById('hamming-operation').value;
    const codeType = document.getElementById('hamming-type-select').value;
    const stepsContainer = document.getElementById('number-system2-steps-container');
    const stepsContent = document.getElementById('number-system2-steps-content');
    
    stepsContainer.style.display = 'block';
    stepsContent.innerHTML = '';
    
    let steps = [];
    
    if (operation === 'encode') {
        const data = document.getElementById('hamming-data-value').value;
        steps = encodeHammingCode(data, codeType);
    } else if (operation === 'decode') {
        const encoded = document.getElementById('hamming-encoded-value').value;
        steps = decodeHammingCode(encoded, codeType);
    } else if (operation === 'single-error') {
        const data = document.getElementById('hamming-data-value').value;
        const errorPos = document.getElementById('hamming-error-position').value;
        steps = testSingleError(data, errorPos, codeType);
    } else if (operation === 'double-error') {
        const data = document.getElementById('hamming-data-value').value;
        const errorPos = document.getElementById('hamming-error-position').value;
        steps = testDoubleError(data, errorPos, codeType);
    }
    
    // Display steps
    steps.forEach((step, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.className = `number-system2-step ${index === 0 ? 'active' : ''}`;
        stepDiv.innerHTML = step;
        stepsContent.appendChild(stepDiv);
    });
    
    // Show position visualization for encoding
    if (operation === 'encode') {
        showPositionVisualization(steps[steps.length - 1].positions);
    }
    
    // Update stats
    document.getElementById('code-steps').textContent = steps.length;
    document.getElementById('code-result').textContent = '';
    
    addLog(`Performed Hamming Code ${operation} operation`, 'success');
}

// Excess-3 conversion functions
function convertDecimalToExcess3(decimal) {
    const steps = [];
    
    steps.push(`<h6>Step 1: Validate Input</h6>
                <p>Input: ${decimal} (decimal)</p>
                <p>Checking if input is a valid decimal number...</p>`);
    
    if (!/^\d+$/.test(decimal)) {
        steps.push(`<p class="text-danger">Error: Invalid decimal input. Must contain only digits 0-9.</p>`);
        return steps;
    }
    
    // Handle large numbers
    if (decimal.length > 8) {
        steps.push(`<p>Large number detected (${decimal.length} digits). Processing each digit separately...</p>`);
    }
    
    // Split into individual digits
    const digits = decimal.split('');
    
    steps.push(`<h6>Step 2: Split into Individual Digits</h6>
                <p>Number: ${decimal}</p>
                <p>Splitting into individual digits: ${digits.map((d, i) => `D${i+1}=${d}`).join(', ')}</p>`);
    
    const excess3Table = {
        '0': '0011', '1': '0100', '2': '0101', '3': '0110',
        '4': '0111', '5': '1000', '6': '1001', '7': '1010',
        '8': '1011', '9': '1100'
    };
    
    let result = '';
    let detailedSteps = '<div class="coverage-diagram">';
    
    // Display number in stacked format
    detailedSteps += `<h6>Step 3: Convert Each Digit (Decimal + 3 = Excess-3)</h6>`;
    
    // Show original number
    detailedSteps += `<div style="margin: 10px 0;">
                        <div class="coverage-row">
                            <div class="coverage-label">Decimal:</div>
                            <div class="coverage-bits">${digits.join(' ')}</div>
                        </div>
                      </div>`;
    
    // Process each digit
    digits.forEach((digit, index) => {
        const decimalValue = parseInt(digit);
        const excess3Value = excess3Table[digit];
        
        detailedSteps += `<div class="excess-step">
                            <strong>Digit ${index + 1}: ${digit}</strong>
                            <table style="width: 100%; margin-top: 5px;">
                                <tr>
                                    <td style="width: 40%;">Decimal:</td>
                                    <td>${decimalValue}</td>
                                </tr>
                                <tr>
                                    <td>Add 3:</td>
                                    <td>${decimalValue} + 3 = ${decimalValue + 3}</td>
                                </tr>
                                <tr>
                                    <td>Binary:</td>
                                    <td>${(decimalValue + 3).toString(2).padStart(4, '0')}</td>
                                </tr>
                                <tr>
                                    <td><strong>Excess-3:</strong></td>
                                    <td><span class="excess-highlight">${excess3Value}</span></td>
                                </tr>
                            </table>
                          </div>`;
        result += excess3Value + ' ';
    });
    
    detailedSteps += '</div>';
    steps.push(detailedSteps);
    
    // Show final result in formatted way
    const resultDigits = result.trim().split(' ');
    steps.push(`<h6>Step 4: Final Result</h6>
                <div class="coverage-diagram">
                    <div class="coverage-row">
                        <div class="coverage-label">Decimal:</div>
                        <div class="coverage-bits">${digits.map(d => `<span class="data-position">${d}</span>`).join(' ')}</div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">Excess-3:</div>
                        <div class="coverage-bits">${resultDigits.map(d => `<span class="parity-position">${d}</span>`).join(' ')}</div>
                    </div>
                    <p class="mt-3"><strong>Excess-3 code for ${decimal}:</strong></p>
                    <div style="background: rgba(139, 69, 19, 0.1); padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 1.1rem;">
                        ${resultDigits.join(' ')}
                    </div>
                    <p class="mt-2 small text-muted">Each 4-bit group represents one decimal digit</p>
                </div>`);
    
    return steps;
}

function convertExcess3ToDecimal(code) {
    const steps = [];
    
    steps.push(`<h6>Step 1: Validate Input</h6>
                <p>Input: ${code} (Excess-3 code)</p>
                <p>Checking if input is valid binary and length...</p>`);
    
    // Validate input
    if (!/^[01]+$/.test(code)) {
        steps.push(`<p class="text-danger">Error: Input must contain only binary digits (0 or 1).</p>`);
        return steps;
    }
    
    // Check if length is multiple of 4
    if (code.length % 4 !== 0) {
        steps.push(`<p class="text-danger">Error: Excess-3 code must be in groups of 4 bits. Current length: ${code.length}</p>`);
        return steps;
    }
    
    // Check for maximum length
    if (code.length > 32) {
        steps.push(`<p class="text-warning">Large input detected (${code.length} bits). Processing ${code.length / 4} digits...</p>`);
    }
    
    const groups = code.match(/.{1,4}/g);
    
    steps.push(`<h6>Step 2: Split into 4-bit Groups</h6>
                <p>Total bits: ${code.length} (${groups.length} groups of 4 bits)</p>
                <div style="background: rgba(139, 69, 19, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0;">
                    ${groups.map((g, i) => `<span class="data-position">${g}</span>`).join(' ')}
                </div>`);
    
    const excess3ToDecimal = {
        '0011': '0', '0100': '1', '0101': '2', '0110': '3',
        '0111': '4', '1000': '5', '1001': '6', '1010': '7',
        '1011': '8', '1100': '9'
    };
    
    let result = '';
    let detailedSteps = '<div class="coverage-diagram">';
    let hasError = false;
    
    detailedSteps += `<h6>Step 3: Convert Each Group (Excess-3 - 3 = Decimal)</h6>`;
    
    // Show original Excess-3 code
    detailedSteps += `<div style="margin: 10px 0;">
                        <div class="coverage-row">
                            <div class="coverage-label">Excess-3:</div>
                            <div class="coverage-bits">${groups.map((g, i) => `G${i+1}=${g}`).join(' ')}</div>
                        </div>
                      </div>`;
    
    groups.forEach((group, index) => {
        if (excess3ToDecimal[group]) {
            const decimalValue = excess3ToDecimal[group];
            const binaryValue = parseInt(group, 2);
            const decimalResult = binaryValue - 3;
            
            detailedSteps += `<div class="excess-step">
                                <strong>Group ${index + 1}: ${group}</strong>
                                <table style="width: 100%; margin-top: 5px;">
                                    <tr>
                                        <td style="width: 40%;">Binary:</td>
                                        <td>${group} = ${binaryValue}</td>
                                    </tr>
                                    <tr>
                                        <td>Subtract 3:</td>
                                        <td>${binaryValue} - 3 = ${decimalResult}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Decimal:</strong></td>
                                        <td><span class="excess-highlight">${decimalValue}</span></td>
                                    </tr>
                                </table>
                              </div>`;
            result += decimalValue;
        } else {
            detailedSteps += `<div class="excess-step text-danger">
                                <strong>Group ${index + 1}: ${group}</strong><br>
                                <table style="width: 100%; margin-top: 5px;">
                                    <tr>
                                        <td>Binary:</td>
                                        <td>${group} = ${parseInt(group, 2)}</td>
                                    </tr>
                                    <tr>
                                        <td>Status:</td>
                                        <td>Error: Invalid Excess-3 code (not in 0011-1100 range)</td>
                                    </tr>
                                </table>
                              </div>`;
            hasError = true;
        }
    });
    
    detailedSteps += '</div>';
    steps.push(detailedSteps);
    
    if (!hasError) {
        steps.push(`<h6>Step 4: Final Result</h6>
                    <div class="coverage-diagram">
                        <div class="coverage-row">
                            <div class="coverage-label">Excess-3:</div>
                            <div class="coverage-bits">${groups.map(g => `<span class="parity-position">${g}</span>`).join(' ')}</div>
                        </div>
                        <div class="coverage-row">
                            <div class="coverage-label">Decimal:</div>
                            <div class="coverage-bits">${result.split('').map(d => `<span class="data-position">${d}</span>`).join(' ')}</div>
                        </div>
                        <p class="mt-3"><strong>Decimal value:</strong></p>
                        <div style="background: rgba(34, 139, 34, 0.1); padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 1.1rem;">
                            ${result}
                        </div>
                    </div>`);
    }
    
    return steps;
}
function performExcess3Addition(num1, num2) {
    const steps = [];
    
    steps.push(`<h6>Step 1: Input Validation</h6>
                <p>Number 1: ${num1} (${num1.length} digits)</p>
                <p>Number 2: ${num2} (${num2.length} digits)</p>`);
    
    if (!/^\d+$/.test(num1) || !/^\d+$/.test(num2)) {
        steps.push(`<p class="text-danger">Error: Both inputs must be decimal numbers (0-9 only)</p>`);
        return steps;
    }
    
    // Pad numbers to same length
    const maxLength = Math.max(num1.length, num2.length);
    const paddedNum1 = num1.padStart(maxLength, '0');
    const paddedNum2 = num2.padStart(maxLength, '0');
    
    steps.push(`<h6>Step 2: Align Numbers</h6>
                <div style="background: rgba(139, 69, 19, 0.1); padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace;">
                    <div style="text-align: right;">Number 1: ${paddedNum1}</div>
                    <div style="text-align: right;">Number 2: ${paddedNum2}</div>
                    <div style="border-bottom: 2px solid var(--primary-color); margin: 5px 0;"></div>
                </div>`);
    
    const excess3Table = {
        '0': '0011', '1': '0100', '2': '0101', '3': '0110',
        '4': '0111', '5': '1000', '6': '1001', '7': '1010',
        '8': '1011', '9': '1100'
    };
    
    // Convert each digit to Excess-3
    const excess3Num1 = paddedNum1.split('').map(d => excess3Table[d]).join(' ');
    const excess3Num2 = paddedNum2.split('').map(d => excess3Table[d]).join(' ');
    
    steps.push(`<h6>Step 3: Convert to Excess-3</h6>
                <div class="coverage-diagram">
                    <div class="coverage-row">
                        <div class="coverage-label">Number 1:</div>
                        <div class="coverage-bits">${paddedNum1.split('').map((d, i) => `<span title="Digit ${i+1}: ${d}">${d}</span>`).join(' ')}</div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">Excess-3:</div>
                        <div class="coverage-bits">${excess3Num1.split(' ').map((b, i) => `<span class="parity-position" title="Position ${i+1}">${b}</span>`).join(' ')}</div>
                    </div>
                </div>
                <div class="coverage-diagram mt-2">
                    <div class="coverage-row">
                        <div class="coverage-label">Number 2:</div>
                        <div class="coverage-bits">${paddedNum2.split('').map((d, i) => `<span title="Digit ${i+1}: ${d}">${d}</span>`).join(' ')}</div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">Excess-3:</div>
                        <div class="coverage-bits">${excess3Num2.split(' ').map((b, i) => `<span class="parity-position" title="Position ${i+1}">${b}</span>`).join(' ')}</div>
                    </div>
                </div>`);
    
    steps.push(`<h6>Step 4: Perform Digit-by-Digit Addition</h6>
                <p>Adding Excess-3 codes from right to left (least significant digit first):</p>`);
    
    // Perform addition digit by digit
    let carry = 0;
    const results = [];
    const detailedAdditions = [];
    
    for (let i = maxLength - 1; i >= 0; i--) {
        const digit1 = parseInt(paddedNum1[i]);
        const digit2 = parseInt(paddedNum2[i]);
        const excess3Digit1 = excess3Table[paddedNum1[i]];
        const excess3Digit2 = excess3Table[paddedNum2[i]];
        
        // Add Excess-3 codes (binary addition)
        const sum = parseInt(excess3Digit1, 2) + parseInt(excess3Digit2, 2) + carry;
        let binarySum = sum.toString(2).padStart(5, '0'); // 5 bits to handle carry
        
        // Adjust for Excess-3
        let resultDigit;
        if (sum <= 9) {
            // Add 3 to get back to Excess-3
            resultDigit = (sum + 3).toString(2).padStart(4, '0');
            carry = 0;
        } else {
            // Subtract 3 and set carry
            resultDigit = (sum - 3).toString(2).padStart(4, '0');
            carry = 1;
        }
        
        // Calculate decimal result
        const decimalResult = parseInt(resultDigit, 2) - 3;
        
        detailedAdditions.push(`
            <div class="excess-step">
                <strong>Position ${maxLength - i}: ${digit1} + ${digit2}</strong>
                <table style="width: 100%; margin-top: 5px; font-size: 0.9rem;">
                    <tr>
                        <td style="width: 30%;">Excess-3 ${digit1}:</td>
                        <td>${excess3Digit1} (${parseInt(excess3Digit1, 2)})</td>
                    </tr>
                    <tr>
                        <td>Excess-3 ${digit2}:</td>
                        <td>${excess3Digit2} (${parseInt(excess3Digit2, 2)})</td>
                    </tr>
                    <tr>
                        <td>Carry:</td>
                        <td>${carry}</td>
                    </tr>
                    <tr style="border-top: 1px solid #ddd;">
                        <td><strong>Sum:</strong></td>
                        <td>${sum} (binary: ${binarySum})</td>
                    </tr>
                    <tr>
                        <td>Adjustment:</td>
                        <td>${sum <= 9 ? 'Add 3' : 'Subtract 3'}</td>
                    </tr>
                    <tr>
                        <td>Result Excess-3:</td>
                        <td><span class="parity-position">${resultDigit}</span></td>
                    </tr>
                    <tr>
                        <td>Decimal:</td>
                        <td><span class="data-position">${decimalResult}</span></td>
                    </tr>
                </table>
            </div>
        `);
        
        results.unshift({
            excess3: resultDigit,
            decimal: decimalResult,
            carry: carry
        });
        
        // Reset carry for next iteration
        carry = (sum > 9) ? 1 : 0;
    }
    
    // Add any final carry
    if (carry) {
        results.unshift({
            excess3: '0001',
            decimal: 1,
            carry: 0
        });
        detailedAdditions.push(`
            <div class="excess-step">
                <strong>Final Carry</strong>
                <p>Carry generated from most significant digit</p>
                <p>Adding carry digit: 1</p>
            </div>
        `);
    }
    
    steps.push(`<div class="coverage-diagram">${detailedAdditions.reverse().join('')}</div>`);
    
    // Build final results
    const excess3Result = results.map(r => r.excess3).join(' ');
    const decimalResult = results.map(r => r.decimal).join('');
    
    steps.push(`<h6>Step 5: Final Results</h6>
                <div class="coverage-diagram">
                    <div class="coverage-row">
                        <div class="coverage-label">Decimal Sum:</div>
                        <div class="coverage-bits">
                            ${parseInt(num1) + parseInt(num2)}
                        </div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">Excess-3 Result:</div>
                        <div class="coverage-bits">
                            ${excess3Result.split(' ').map(b => `<span class="parity-position">${b}</span>`).join(' ')}
                        </div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">Verification:</div>
                        <div class="coverage-bits">
                            ${excess3Result.split(' ').map(b => {
                                const decimal = parseInt(b, 2) - 3;
                                return decimal >= 0 ? decimal : '';
                            }).filter(d => d !== '').join('')} = ${decimalResult}
                        </div>
                    </div>
                </div>
                <div class="mt-3 text-success">
                    <strong> Addition successful using Excess-3 code</strong><br>
                    <small>${num1} + ${num2} = ${parseInt(num1) + parseInt(num2)}</small>
                </div>`);
    
    return steps;
}
// Enhanced Excess-3 Subtraction
function performExcess3Subtraction(num1, num2) {
    const steps = [];
    
    steps.push(`<h6>Step 1: Input Validation</h6>
                <p>Minuend: ${num1}</p>
                <p>Subtrahend: ${num2}</p>
                <p>Operation: ${num1} - ${num2}</p>`);
    
    if (!/^\d+$/.test(num1) || !/^\d+$/.test(num2)) {
        steps.push(`<p class="text-danger">Error: Both inputs must be decimal numbers (0-9 only)</p>`);
        return steps;
    }
    
    // Pad numbers to same length
    const maxLength = Math.max(num1.length, num2.length);
    const paddedNum1 = num1.padStart(maxLength, '0');
    const paddedNum2 = num2.padStart(maxLength, '0');
    
    steps.push(`<h6>Step 2: Align Numbers</h6>
                <div style="background: rgba(139, 69, 19, 0.1); padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace;">
                    <div style="text-align: right;">Minuend: ${paddedNum1}</div>
                    <div style="text-align: right;">Subtrahend: -${paddedNum2}</div>
                    <div style="border-bottom: 2px solid var(--primary-color); margin: 5px 0;"></div>
                </div>`);
    
    const excess3Table = {
        '0': '0011', '1': '0100', '2': '0101', '3': '0110',
        '4': '0111', '5': '1000', '6': '1001', '7': '1010',
        '8': '1011', '9': '1100'
    };
    
    // Convert to Excess-3
    const excess3Num1 = paddedNum1.split('').map(d => excess3Table[d]).join(' ');
    const excess3Num2 = paddedNum2.split('').map(d => excess3Table[d]).join(' ');
    
    steps.push(`<h6>Step 3: Convert to Excess-3</h6>
                <div class="coverage-diagram">
                    <div class="coverage-row">
                        <div class="coverage-label">Minuend:</div>
                        <div class="coverage-bits">${paddedNum1.split('').map(d => `<span class="data-position">${d}</span>`).join(' ')}</div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">Excess-3:</div>
                        <div class="coverage-bits">${excess3Num1.split(' ').map(b => `<span class="parity-position">${b}</span>`).join(' ')}</div>
                    </div>
                </div>
                <div class="coverage-diagram mt-2">
                    <div class="coverage-row">
                        <div class="coverage-label">Subtrahend:</div>
                        <div class="coverage-bits">${paddedNum2.split('').map(d => `<span class="data-position">${d}</span>`).join(' ')}</div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">Excess-3:</div>
                        <div class="coverage-bits">${excess3Num2.split(' ').map(b => `<span class="parity-position">${b}</span>`).join(' ')}</div>
                    </div>
                </div>`);
    
    steps.push(`<h6>Step 4: Convert Subtrahend to 9's Complement in Excess-3</h6>
                <p>For subtraction in Excess-3, we use 9's complement method:</p>`);
    
    // Calculate 9's complement in Excess-3
    const ninesComplement = [];
    const detailedComplements = [];
    
    for (let i = 0; i < maxLength; i++) {
        const digit = parseInt(paddedNum2[i]);
        const complementDigit = 9 - digit;
        const excess3Complement = excess3Table[complementDigit.toString()];
        
        ninesComplement.push(excess3Complement);
        
        detailedComplements.push(`
            <div class="excess-step">
                <strong>Digit ${i + 1}: ${digit}</strong>
                <table style="width: 100%; margin-top: 5px; font-size: 0.9rem;">
                    <tr>
                        <td style="width: 40%;">9's complement:</td>
                        <td>9 - ${digit} = ${complementDigit}</td>
                    </tr>
                    <tr>
                        <td>Excess-3:</td>
                        <td>${complementDigit} + 3 = ${complementDigit + 3} = ${excess3Complement}</td>
                    </tr>
                    <tr>
                        <td><strong>Result:</strong></td>
                        <td><span class="parity-position">${excess3Complement}</span></td>
                    </tr>
                </table>
            </div>
        `);
    }
    
    steps.push(`<div class="coverage-diagram">${detailedComplements.join('')}</div>`);
    
    const ninesComplementStr = ninesComplement.join(' ');
    
    steps.push(`<h6>Step 5: Add Minuend and 9's Complement</h6>
                <p>Adding Excess-3 of minuend with 9's complement of subtrahend:</p>
                <div class="coverage-diagram">
                    <div class="coverage-row">
                        <div class="coverage-label">Minuend:</div>
                        <div class="coverage-bits">${excess3Num1.split(' ').map(b => `<span class="parity-position">${b}</span>`).join(' ')}</div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">9's Complement:</div>
                        <div class="coverage-bits">${ninesComplementStr.split(' ').map(b => `<span class="parity-position" style="background: var(--warning-color);">${b}</span>`).join(' ')}</div>
                    </div>
                </div>`);
    
    // Perform addition
    let carry = 0;
    const additionResults = [];
    const detailedAdditions = [];
    
    for (let i = maxLength - 1; i >= 0; i--) {
        const excess3Digit1 = excess3Table[paddedNum1[i]];
        const excess3Complement = ninesComplement[i];
        
        const sum = parseInt(excess3Digit1, 2) + parseInt(excess3Complement, 2) + carry;
        let binarySum = sum.toString(2).padStart(5, '0');
        
        let resultDigit;
        if (sum <= 9) {
            resultDigit = (sum + 3).toString(2).padStart(4, '0');
            carry = 0;
        } else {
            resultDigit = (sum - 3).toString(2).padStart(4, '0');
            carry = 1;
        }
        
        const decimalResult = parseInt(resultDigit, 2) - 3;
        
        detailedAdditions.push(`
            <div class="excess-step">
                <strong>Position ${maxLength - i}</strong>
                <table style="width: 100%; margin-top: 5px; font-size: 0.9rem;">
                    <tr>
                        <td style="width: 40%;">Minuend:</td>
                        <td>${excess3Digit1} (${parseInt(excess3Digit1, 2)})</td>
                    </tr>
                    <tr>
                        <td>9's Complement:</td>
                        <td>${excess3Complement} (${parseInt(excess3Complement, 2)})</td>
                    </tr>
                    <tr>
                        <td>Carry:</td>
                        <td>${carry}</td>
                    </tr>
                    <tr style="border-top: 1px solid #ddd;">
                        <td><strong>Sum:</strong></td>
                        <td>${sum} (binary: ${binarySum})</td>
                    </tr>
                    <tr>
                        <td>Adjustment:</td>
                        <td>${sum <= 9 ? 'Add 3' : 'Subtract 3'}</td>
                    </tr>
                    <tr>
                        <td>Result:</td>
                        <td><span class="parity-position">${resultDigit}</span></td>
                    </tr>
                    <tr>
                        <td>Decimal:</td>
                        <td><span class="data-position">${decimalResult}</span></td>
                    </tr>
                </table>
            </div>
        `);
        
        additionResults.unshift({
            excess3: resultDigit,
            decimal: decimalResult,
            carry: carry
        });
        
        carry = (sum > 9) ? 1 : 0;
    }
    
    steps.push(`<div class="coverage-diagram">${detailedAdditions.reverse().join('')}</div>`);
    
    // Handle end-around carry
    if (carry) {
        steps.push(`<h6>Step 6: Handle End-Around Carry</h6>
                    <p>Carry generated, so result is positive. Adding carry to least significant digit:</p>`);
        
        // Add 1 to the result (end-around carry)
        let finalCarry = 1;
        const finalResults = [];
        
        for (let i = additionResults.length - 1; i >= 0; i--) {
            const current = additionResults[i];
            const sum = current.decimal + finalCarry;
            
            if (sum <= 9) {
                finalResults.unshift({
                    excess3: excess3Table[sum.toString()],
                    decimal: sum,
                    carry: 0
                });
                finalCarry = 0;
            } else {
                finalResults.unshift({
                    excess3: excess3Table[(sum - 10).toString()],
                    decimal: sum - 10,
                    carry: 1
                });
                finalCarry = 1;
            }
        }
        
        additionResults.splice(0, additionResults.length, ...finalResults);
        
        steps.push(`<p class="text-success"> End-around carry added. Result is positive.</p>`);
    } else {
        steps.push(`<h6>Step 6: No End-Around Carry</h6>
                    <p class="text-warning">No carry generated, result is negative. Taking 9's complement of result.</p>`);
        
        // Take 9's complement of result
        for (let i = 0; i < additionResults.length; i++) {
            const current = additionResults[i];
            const complement = 9 - current.decimal;
            additionResults[i] = {
                excess3: excess3Table[complement.toString()],
                decimal: complement,
                carry: 0
            };
        }
        
        steps.push(`<p class="text-warning">Result is negative: -${additionResults.map(r => r.decimal).join('')}</p>`);
    }
    
    // Build final results
    const excess3Result = additionResults.map(r => r.excess3).join(' ');
    const decimalResult = additionResults.map(r => r.decimal).join('');
    const actualResult = parseInt(num1) - parseInt(num2);
    
    steps.push(`<h6>Step 7: Final Results</h6>
                <div class="coverage-diagram">
                    <div class="coverage-row">
                        <div class="coverage-label">Actual Result:</div>
                        <div class="coverage-bits">
                            ${parseInt(num1)} - ${parseInt(num2)} = ${actualResult}
                        </div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">Excess-3 Result:</div>
                        <div class="coverage-bits">
                            ${excess3Result.split(' ').map(b => `<span class="parity-position">${b}</span>`).join(' ')}
                        </div>
                    </div>
                    <div class="coverage-row">
                        <div class="coverage-label">Decimal Result:</div>
                        <div class="coverage-bits">
                            ${carry ? '' : '-'}${decimalResult}
                        </div>
                    </div>
                </div>
                <div class="mt-3 ${carry ? 'text-success' : 'text-warning'}">
                    <strong>${carry ? '' : ''} Subtraction ${carry ? 'successful' : 'result is negative'}</strong><br>
                    <small>${num1} - ${num2} = ${actualResult}</small>
                </div>`);
    
    return steps;
}

// Hamming Code functions
function encodeHammingCode(data, codeType) {
    const steps = [];
    const dataBits = data.split('').map(bit => parseInt(bit));
    const m = dataBits.length;
    
    steps.push(`<h6>Step 1: Determine Parameters</h6>
                <p>Data bits: ${data} (${m} bits)</p>
                <p>Finding number of parity bits (p) using formula: 2^p  m + p + 1</p>`);
    
    // Calculate parity bits needed
    let p = 0;
    while (Math.pow(2, p) < (m + p + 1)) {
        p++;
    }
    
    const n = m + p;
    
    steps.push(`<p>Solving: 2^p  ${m} + p + 1</p>
                <p>For p = ${p}: 2^${p} = ${Math.pow(2, p)}  ${m} + ${p} + 1 = ${m + p + 1}</p>
                <p> Need ${p} parity bits</p>
                <p>Total encoded bits: n = m + p = ${m} + ${p} = ${n}</p>`);
    
    steps.push(`<h6>Step 2: Determine Positions</h6>
                <p>Parity bits go at positions that are powers of 2:</p>
                <p>${Array.from({length: p}, (_, i) => Math.pow(2, i)).join(', ')}</p>
                <p>Data bits go at all other positions</p>`);
    
    // Create position map
    const positions = [];
    let dataIndex = 0;
    
    for (let i = 1; i <= n; i++) {
        if ((i & (i - 1)) === 0) { // Power of 2
            positions.push({pos: i, type: 'parity', value: 0});
        } else {
            positions.push({pos: i, type: 'data', value: dataBits[dataIndex++]});
        }
    }
    
    // Display position assignment
    let positionTable = '<table class="position-table"><tr><th>Position</th><th>Type</th><th>Bit Value</th></tr>';
    positions.forEach(pos => {
        positionTable += `<tr>
            <td class="position-index">${pos.pos}</td>
            <td><span class="${pos.type === 'parity' ? 'parity-position' : 'data-position'}">${pos.type}</span></td>
            <td>${pos.value}</td>
        </tr>`;
    });
    positionTable += '</table>';
    
    steps.push(positionTable);
    
    steps.push(`<h6>Step 3: Calculate Parity Bits</h6>
                <p>Each parity bit covers positions where the corresponding bit in position index is 1:</p>`);
    
    // Calculate parity bits
    for (let i = 0; i < p; i++) {
        const parityPos = Math.pow(2, i);
        let xorResult = 0;
        let coveredPositions = [];
        
        // Find all positions covered by this parity bit
        for (let j = 1; j <= n; j++) {
            if (j & parityPos) { // Check if position has this bit set
                if (j !== parityPos) { // Don't include the parity bit itself
                    const bitValue = positions.find(p => p.pos === j)?.value || 0;
                    xorResult ^= bitValue;
                    coveredPositions.push(j);
                }
            }
        }
        
        // Update parity bit value
        const parityIndex = positions.findIndex(p => p.pos === parityPos);
        positions[parityIndex].value = xorResult;
        
        steps.push(`<div class="coverage-diagram">
            <div class="coverage-row">
                <div class="coverage-label">P${parityPos}:</div>
                <div class="coverage-bits">
                    Covers positions where bit ${i} = 1: ${coveredPositions.join(', ')}
                </div>
            </div>
            <p>XOR of covered data bits = ${xorResult}</p>
            <p>Set P${parityPos} = ${xorResult}</p>
        </div>`);
    }
    
    steps.push(`<h6>Step 4: Final Encoded Message</h6>
                <p>Arranging bits in order:</p>`);
    
    const encodedBits = positions.map(p => p.value).join('');
    const parityBits = positions.filter(p => p.type === 'parity').map(p => p.value).join('');
    const dataBitsStr = positions.filter(p => p.type === 'data').map(p => p.value).join('');
    
    steps.push(`<p>Parity bits (positions ${Array.from({length: p}, (_, i) => Math.pow(2, i)).join(', ')}): ${parityBits}</p>
                <p>Data bits: ${dataBitsStr}</p>
                <p class="text-success"><strong>Encoded Hamming Code: ${encodedBits}</strong></p>`);
    
    // Store positions for visualization
    steps.positions = positions;
    
    return steps;
}

function decodeHammingCode(encoded, codeType) {
    const steps = [];
    const encodedBits = encoded.split('').map(bit => parseInt(bit));
    const n = encodedBits.length;
    
    steps.push(`<h6>Step 1: Analyze Received Code</h6>
                <p>Received code: ${encoded} (${n} bits)</p>
                <p>Determining parity bit positions...</p>`);
    
    // Determine parity bits (positions that are powers of 2)
    const parityPositions = [];
    let p = 0;
    while (Math.pow(2, p) <= n) {
        parityPositions.push(Math.pow(2, p));
        p++;
    }
    p--; // Adjust count
    
    steps.push(`<p>Found ${p} parity bits at positions: ${parityPositions.join(', ')}</p>`);
    
    steps.push(`<h6>Step 2: Calculate Syndrome Bits</h6>
                <p>Calculating syndrome by XORing all bits in each parity group:</p>`);
    
    const syndrome = [];
    let syndromeValue = 0;
    
    for (let i = 0; i < p; i++) {
        const parityPos = Math.pow(2, i);
        let xorResult = 0;
        let coveredPositions = [];
        
        // XOR all bits where this parity bit position is set
        for (let j = 1; j <= n; j++) {
            if (j & parityPos) {
                xorResult ^= encodedBits[j - 1];
                coveredPositions.push(j);
            }
        }
        
        syndrome.push(xorResult);
        syndromeValue += xorResult * Math.pow(2, i);
        
        steps.push(`<div class="coverage-diagram">
            <div class="coverage-row">
                <div class="coverage-label">S${i}:</div>
                <div class="coverage-bits">
                    XOR of positions: ${coveredPositions.join(', ')}
                </div>
            </div>
            <p>Syndrome bit S${i} = ${xorResult}</p>
        </div>`);
    }
    
    const syndromeBinary = syndrome.reverse().join('');
    
    steps.push(`<h6>Step 3: Analyze Syndrome</h6>
                <p>Syndrome bits: ${syndromeBinary} (binary)</p>
                <p>Syndrome value: ${syndromeValue} (decimal)</p>`);
    
    if (syndromeValue === 0) {
        steps.push(`<p class="text-success"><strong> No errors detected</strong></p>
                    <p>Extracted data bits (excluding parity positions):</p>`);
        
        // Extract data bits
        const dataBits = [];
        for (let i = 1; i <= n; i++) {
            if (!parityPositions.includes(i)) {
                dataBits.push(encodedBits[i - 1]);
            }
        }
        
        steps.push(`<p><strong>Data: ${dataBits.join('')}</strong></p>`);
    } else {
        steps.push(`<p class="text-warning"><strong> Error detected at position ${syndromeValue}</strong></p>
                    <p>Correcting error by flipping bit at position ${syndromeValue}...</p>`);
        
        // Correct error
        const correctedBits = [...encodedBits];
        correctedBits[syndromeValue - 1] = correctedBits[syndromeValue - 1] === 0 ? 1 : 0;
        
        steps.push(`<p>Original bit at position ${syndromeValue}: ${encodedBits[syndromeValue - 1]}</p>
                    <p>Corrected bit: ${correctedBits[syndromeValue - 1]}</p>
                    <p class="text-success"><strong> Error corrected successfully</strong></p>`);
        
        // Extract corrected data bits
        const dataBits = [];
        for (let i = 1; i <= n; i++) {
            if (!parityPositions.includes(i)) {
                dataBits.push(correctedBits[i - 1]);
            }
        }
        
        steps.push(`<p><strong>Corrected Data: ${dataBits.join('')}</strong></p>`);
    }
    
    return steps;
}

// Helper functions
function showExcess3Table() {
    document.getElementById('code-reference-tables').style.display = 'block';
    document.getElementById('number-system2-steps-container').style.display = 'none';
    addLog('Displayed Excess-3 reference table', 'info');
}

function showDetailedHammingSteps() {
    // This would show even more detailed steps
    addLog('Showing detailed Hamming Code steps', 'info');
}

function generateHammingExamples() {
    const examples = [
        { data: '1010', desc: 'Classic (7,4) Hamming Code example' },
        { data: '11111', desc: '5-bit data example from your request' },
        { data: '11001100', desc: '8-bit data example' }
    ];
    
    const randomExample = examples[Math.floor(Math.random() * examples.length)];
    document.getElementById('hamming-data-value').value = randomExample.data;
    
    addLog(`Generated example: ${randomExample.desc}`, 'info');
}

function showPositionVisualization(positions) {
    const positionDisplay = document.getElementById('position-display');
    positionDisplay.innerHTML = '';
    
    positions.forEach(pos => {
        const bitDiv = document.createElement('div');
        bitDiv.className = `bit-visual ${pos.type === 'parity' ? 'bit-parity' : 'bit-data'}`;
        bitDiv.innerHTML = `
            <div>${pos.value}</div>
            <small>${pos.pos}</small>
        `;
        positionDisplay.appendChild(bitDiv);
    });
    
    document.getElementById('position-visualization').style.display = 'block';
}
// Test functions with large numbers
function testLargeNumberOperations() {
    const testCases = [
        {
            type: 'decimal-to-excess3',
            input: '1234567890',
            expected: '0100 0101 0110 0111 1000 1001 1010 1011 1100 0011'
        },
        {
            type: 'excess3-to-decimal',
            input: '0100010101100111100010011010101111000011',
            expected: '1234567890'
        },
        {
            type: 'addition',
            num1: '9999',
            num2: '1',
            expected: '10000'
        },
        {
            type: 'subtraction',
            num1: '10000',
            num2: '9999',
            expected: '1'
        }
    ];
    
    console.log('Testing large number operations:');
    testCases.forEach(test => {
        console.log(`Test ${test.type}:`, test);
    });
}

// Reset functions
function resetExcess3() {
    document.getElementById('excess3-decimal-value').value = '';
    document.getElementById('excess3-code-value').value = '';
    document.getElementById('excess3-second-value').value = '';
    document.getElementById('number-system2-steps-container').style.display = 'none';
    document.getElementById('code-reference-tables').style.display = 'none';
    addLog('Reset Excess-3 interface', 'info');
}

function resetHamming() {
    document.getElementById('hamming-data-value').value = '';
    document.getElementById('hamming-encoded-value').value = '';
    document.getElementById('hamming-error-position').value = '';
    document.getElementById('number-system2-steps-container').style.display = 'none';
    document.getElementById('position-visualization').style.display = 'none';
    addLog('Reset Hamming Code interface', 'info');
}

// Test functions
function testBothCodes() {
    const stepsContainer = document.getElementById('number-system2-steps-container');
    const stepsContent = document.getElementById('number-system2-steps-content');
    
    stepsContainer.style.display = 'block';
    stepsContent.innerHTML = '';
    
    stepsContent.innerHTML = `
        <div class="number-system2-step active">
            <h6>Testing Both Code Systems</h6>
            <p>1. <strong>Excess-3 Code Test:</strong> Converting decimal 5 to Excess-3</p>
            <p>5 + 3 = 8  1000 in binary</p>
            <p><strong>Result:</strong> 5  1000</p>
        </div>
        <div class="number-system2-step">
            <p>2. <strong>Hamming Code Test:</strong> Encoding data "1010"</p>
            <p>Data bits: 4, Parity bits needed: 3</p>
            <p>Total bits: 7 (classic (7,4) Hamming Code)</p>
            <p><strong>Result:</strong> 1010  1011010 (with parity bits)</p>
        </div>
        <div class="number-system2-step">
            <p>3. <strong>Error Detection Test:</strong> Introducing error at position 3</p>
            <p>Original: 1011010</p>
            <p>With error: 1001010 (bit 3 flipped)</p>
            <p><strong>Result:</strong> Hamming Code detects and corrects error</p>
        </div>
    `;
    
    addLog('Tested both Excess-3 and Hamming Code systems', 'info');
}

function loadAdvancedPracticeQuestions() {
    // This would load GATE practice questions
    addLog('Loading GATE practice questions for advanced codes', 'info');
    
    // Show practice questions
    const stepsContent = document.getElementById('number-system2-steps-content');
    stepsContent.innerHTML = `
        <div class="number-system2-step active">
            <h6>GATE Practice Question 1</h6>
            <p><strong>Question:</strong> The Excess-3 code for decimal number 7 is:</p>
            <p>A) 0110</p>
            <p>B) 1010</p>
            <p>C) 1000</p>
            <p>D) 1100</p>
            <button class="btn-glow btn-sm mt-2" onclick="showAnswer(1)">Show Answer</button>
            <div id="answer-1" style="display: none; margin-top: 10px;">
                <p><strong>Answer:</strong> B) 1010</p>
                <p><strong>Explanation:</strong> 7 + 3 = 10, which is 1010 in binary.</p>
            </div>
        </div>
        <div class="number-system2-step">
            <h6>GATE Practice Question 2</h6>
            <p><strong>Question:</strong> For a (7,4) Hamming Code, if the received code is 1011010 and syndrome is 011, the error is at position:</p>
            <p>A) 3</p>
            <p>B) 5</p>
            <p>C) 6</p>
            <p>D) 7</p>
            <button class="btn-glow btn-sm mt-2" onclick="showAnswer(2)">Show Answer</button>
            <div id="answer-2" style="display: none; margin-top: 10px;">
                <p><strong>Answer:</strong> A) 3</p>
                <p><strong>Explanation:</strong> Syndrome 011 in binary is 3 in decimal, indicating error at position 3.</p>
            </div>
        </div>
    `;
    
    document.getElementById('number-system2-steps-container').style.display = 'block';
}
// Helper function for practice questions
function showAnswer(questionNum) {
    const answerDiv = document.getElementById(`answer-${questionNum}`);
    if (answerDiv.style.display === 'none') {
        answerDiv.style.display = 'block';
    } else {
        answerDiv.style.display = 'none';
    }
}
// Select advanced operation
function selectAdvancedOperation(operation) {
    currentAdvancedOperations = operation;
    
    // Hide all input sections
    document.getElementById('excess3-inputs').style.display = 'none';
    document.getElementById('hamming-inputs').style.display = 'none';
    document.getElementById('ascii-inputs').style.display = 'none';
    document.getElementById('seven-segment-inputs').style.display = 'none';
    
    // Hide results and steps
    document.getElementById('number-system2-steps-container').style.display = 'none';
    document.getElementById('position-visualization').style.display = 'none';
    
    // Initialize decoders if needed
    if (operation === 'ascii' && !asciiDecoder) {
        asciiDecoder = new ASCIIDecoder();
    }
    if (operation === 'seven-segment' && !sevenSegmentDecoder) {
        sevenSegmentDecoder = new SevenSegmentDecoder();
    }
    
    // Show selected input section
    switch(operation) {
        case 'excess3':
            document.getElementById('excess3-inputs').style.display = 'block';
            updateExcess3Interface();
            break;
        case 'hamming':
            document.getElementById('hamming-inputs').style.display = 'block';
            updateHammingInterface();
            break;
        case 'ascii':
            document.getElementById('ascii-inputs').style.display = 'block';
            updateASCIIInterface();
            break;
        case 'seven-segment':
            document.getElementById('seven-segment-inputs').style.display = 'block';
            updateSevenSegmentInterface();
            break;
    }
    
    // Update description
    updateAdvancedOperationDescription();
    
    addLog(`Selected ${operation.replace('-', ' ')} operation`, 'info');
}

// Update ASCII interface based on selected operation
function updateASCIIInterface() {
    const operation = document.getElementById('ascii-operation').value;
    
    // Hide all input sections
    document.getElementById('ascii-char-input').style.display = 'none';
    document.getElementById('ascii-value-input').style.display = 'none';
    document.getElementById('ascii-string-input').style.display = 'none';
    document.getElementById('ascii-codes-input').style.display = 'none';
    
    // Show relevant input section
    switch(operation) {
        case 'char-to-ascii':
            document.getElementById('ascii-char-input').style.display = 'block';
            break;
        case 'ascii-to-char':
            document.getElementById('ascii-value-input').style.display = 'block';
            break;
        case 'string-to-ascii':
            document.getElementById('ascii-string-input').style.display = 'block';
            break;
        case 'ascii-to-string':
            document.getElementById('ascii-codes-input').style.display = 'block';
            break;
    }
}

// Update 7-Segment interface
function updateSevenSegmentInterface() {
    const operation = document.getElementById('seven-seg-operation').value;
    
    // Hide all input sections
    document.getElementById('7seg-char-input').style.display = 'none';
    document.getElementById('7seg-ascii-input').style.display = 'none';
    document.getElementById('7seg-string-input').style.display = 'none';
    document.getElementById('7seg-binary-input').style.display = 'none';
    
    // Show relevant input section
    switch(operation) {
        case 'char-to-7seg':
            document.getElementById('7seg-char-input').style.display = 'block';
            break;
        case 'ascii-to-7seg':
            document.getElementById('7seg-ascii-input').style.display = 'block';
            break;
        case 'string-to-7seg':
            document.getElementById('7seg-string-input').style.display = 'block';
            break;
        case 'binary-to-7seg':
        case 'visual-display':
            document.getElementById('7seg-binary-input').style.display = 'block';
            break;
    }
}

// Perform ASCII operation
// Perform ASCII operation
function performASCIIOperation() {
    const operation = document.getElementById('ascii-operation').value;
    const format = document.getElementById('ascii-format-select').value;
    
    let steps = [];
    let results = [];
    
    try {
        switch(operation) {
            case 'char-to-ascii':
                const char = document.getElementById('ascii-char-value').value;
                if (!char) {
                    throw new Error('Please enter a character');
                }
                results = asciiDecoder.charToASCII(char[0], format);
                // Use a different method or create a new one
                // For now, let's use getASCIIToCharSteps with the code
                steps = asciiDecoder.getASCIIToCharSteps(char.charCodeAt(0), format);
                break;
                
            case 'ascii-to-char':
                const asciiVal = parseInt(document.getElementById('ascii-decimal-value').value);
                if (isNaN(asciiVal) || asciiVal < 0 || asciiVal > 127) {
                    throw new Error('Please enter a valid ASCII value (0-127)');
                }
                results = asciiDecoder.asciiToChar(asciiVal, format);
                steps = asciiDecoder.getASCIIToCharSteps(asciiVal, format);
                break;
                
            case 'string-to-ascii':
                const text = document.getElementById('ascii-string-value').value;
                if (!text) {
                    throw new Error('Please enter a string');
                }
                results = asciiDecoder.stringToASCII(text, format);
                steps = asciiDecoder.getStringConversionSteps(text, format);
                break;
                
            case 'ascii-to-string':
                const codesInput = document.getElementById('ascii-codes-value').value;
                if (!codesInput) {
                    throw new Error('Please enter ASCII codes');
                }
                const codes = codesInput.split(',').map(c => parseInt(c.trim()));
                if (codes.some(isNaN)) {
                    throw new Error('Invalid ASCII codes');
                }
                results = asciiDecoder.asciiToString(codes, format);
                steps = asciiDecoder.getCodesToStringSteps(codes, format);
                break;
                
            case 'full-table':
                results = asciiDecoder.getASCIITable();
                steps = asciiDecoder.getASCIITableSteps();
                break;
        }
        
        displayAdvancedResults(results, steps);
        
    } catch (error) {
        addLog(`ASCII Error: ${error.message}`, 'error');
        showError(`Error: ${error.message}`);
    }
}
// Perform 7-Segment operation
// Perform 7-Segment operation
// Perform 7-Segment operation
function performSevenSegmentOperation() {
    const operation = document.getElementById('seven-seg-operation').value;
    const displayType = document.getElementById('7seg-display-type').value;
    
    let steps = [];
    let results = [];
    
    try {
        switch(operation) {
            case 'char-to-7seg':
                const char = document.getElementById('7seg-char-value').value;
                if (!char) {
                    throw new Error('Please enter a character');
                }
                results = sevenSegmentDecoder.charToSevenSegment(char[0], displayType);
                steps = sevenSegmentDecoder.getConversionSteps(char[0], displayType);
                break;
                
            case 'ascii-to-7seg':
                const asciiVal = parseInt(document.getElementById('7seg-ascii-value').value);
                if (isNaN(asciiVal) || asciiVal < 0 || asciiVal > 127) {
                    throw new Error('Please enter a valid ASCII value (0-127)');
                }
                results = sevenSegmentDecoder.asciiToSevenSegment(asciiVal, displayType);
                steps = sevenSegmentDecoder.getASCIITo7SegSteps(asciiVal, displayType);
                break;
                
            case 'string-to-7seg':
                const text = document.getElementById('7seg-string-value').value;
                if (!text) {
                    throw new Error('Please enter a string');
                }
                results = sevenSegmentDecoder.stringToSevenSegment(text, displayType);
                steps = sevenSegmentDecoder.getStringConversionSteps(text, displayType);
                break;
                
            case 'binary-to-7seg':
                const binaryPattern = document.getElementById('7seg-binary-value').value;
                if (!/^[01]{7}$/.test(binaryPattern)) {
                    throw new Error('Please enter a valid 7-bit binary pattern');
                }
                results = sevenSegmentDecoder.binaryToCharacter(binaryPattern, displayType);
                steps = sevenSegmentDecoder.getBinaryToCharSteps(binaryPattern, displayType);
                break;
                
            case 'visual-display':
                const visualPattern = document.getElementById('7seg-binary-value').value;
                if (!/^[01]{7}$/.test(visualPattern)) {
                    throw new Error('Please enter a valid 7-bit binary pattern');
                }
                results = sevenSegmentDecoder.createVisualDisplay(visualPattern, displayType);
                steps = sevenSegmentDecoder.getVisualDisplaySteps(visualPattern, displayType);
                break;
        }
        
        displayAdvancedResults(results, steps);
        
    } catch (error) {
        addLog(`7-Segment Error: ${error.message}`, 'error');
        showError(`Error: ${error.message}`);
    }
}
// 4:16 Decoder Functions
function select4x16Decoder() {
    // Show the buttons only for 4:16 Decoder
    document.getElementById('decoder4x16-buttons').style.display = 'grid';
    
    // Initialize inputs
    reset4x16Decoder();
    
    // Display description
    document.getElementById('mux-description').innerHTML = `
        <strong>4:16 Decoder</strong><br>
         4 input lines (A3, A2, A1, A0)<br>
         16 output lines (Y0-Y15)<br>
         Enable input (active high)<br>
         Exactly one output is active based on input combination
    `;
    
    // Generate visualization
    display4x16DecoderVisualization();
}

function toggle4x16Input(index) {
    const checkbox = document.getElementById(`decoder4x16-input-a${index}`);
    currentDecoder4x16Inputs[index] = checkbox.checked ? 1 : 0;
    
    const label = checkbox.parentElement.parentElement.querySelector('span:last-child');
    label.textContent = currentDecoder4x16Inputs[index] ? '1 (ON)' : '0 (OFF)';
    
    addLog(`4:16 Decoder input A${index} set to ${currentDecoder4x16Inputs[index]}`, 'info');
}

function calculate4x16Decoder() {
    // Calculate decimal value from binary inputs
    const inputDecimal = (currentDecoder4x16Inputs[3] << 3) | 
                         (currentDecoder4x16Inputs[2] << 2) | 
                         (currentDecoder4x16Inputs[1] << 1) | 
                         currentDecoder4x16Inputs[0];
    
    // Reset all outputs
    decoder4x16Outputs = Array(16).fill(0);
    
    // If enable is active, activate the corresponding output
    if (decoder4x16Enable === 1) {
        decoder4x16Outputs[inputDecimal] = 1;
    }
    
    // Display results
    display4x16DecoderResults(inputDecimal);
    
    // Show step-by-step calculation
    display4x16StepByStep(inputDecimal);
}

function display4x16DecoderResults(inputDecimal) {
    const resultsContainer = document.getElementById('mux-calculation-steps');
    const stepsContainer = document.getElementById('mux-steps-container');
    
    // Clear previous results
    stepsContainer.innerHTML = '';
    
    // Create results display
    let resultsHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">4:16 Decoder Results</div>
            <div class="calculation-content">
                <p><strong>Input Binary:</strong> ${currentDecoder4x16Inputs[3]}${currentDecoder4x16Inputs[2]}${currentDecoder4x16Inputs[1]}${currentDecoder4x16Inputs[0]}</p>
                <p><strong>Input Decimal:</strong> ${inputDecimal}</p>
                <p><strong>Enable:</strong> ${decoder4x16Enable} ${decoder4x16Enable === 1 ? '(Active)' : '(Inactive)'}</p>
                <p><strong>Active Output:</strong> Y${inputDecimal} ${decoder4x16Enable === 1 ? '(ACTIVE)' : '(All inactive due to disable)'}</p>
            </div>
        </div>
        
        <div class="sequential-step active">
            <div class="calculation-title">Output Status (Y0-Y15)</div>
            <div class="decoder-outputs" style="justify-content: flex-start; flex-wrap: wrap;">
    `;
    
    // Add all 16 outputs
    for (let i = 0; i < 16; i++) {
        const isActive = decoder4x16Outputs[i] === 1;
        resultsHTML += `
            <div class="decoder-output ${isActive ? 'active' : 'inactive'}" 
                 style="width: 40px; height: 40px; margin: 5px;">
                <span>Y${i}</span>
                <div style="font-size: 0.8em; margin-top: 2px;">${isActive ? '1' : '0'}</div>
            </div>
        `;
    }
    
    resultsHTML += `
            </div>
        </div>
    `;
    
    stepsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
    
    addLog(`4:16 Decoder calculated: Input ${inputDecimal}, Output Y${inputDecimal} active`, 'success');
}

function display4x16StepByStep(inputDecimal) {
    const stepsContainer = document.getElementById('mux-steps-container');
    
    const stepHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Step-by-Step Calculation</div>
            <div class="calculation-content">
                <p><strong>Step 1:</strong> Read input bits</p>
                <div class="excess-step">
                    A3 = ${currentDecoder4x16Inputs[3]} (MSB)<br>
                    A2 = ${currentDecoder4x16Inputs[2]}<br>
                    A1 = ${currentDecoder4x16Inputs[1]}<br>
                    A0 = ${currentDecoder4x16Inputs[0]} (LSB)
                </div>
                
                <p><strong>Step 2:</strong> Convert binary to decimal</p>
                <div class="excess-step">
                    ${currentDecoder4x16Inputs[3]}  2 + ${currentDecoder4x16Inputs[2]}  2 + ${currentDecoder4x16Inputs[1]}  2 + ${currentDecoder4x16Inputs[0]}  2<br>
                    = ${currentDecoder4x16Inputs[3] * 8} + ${currentDecoder4x16Inputs[2] * 4} + ${currentDecoder4x16Inputs[1] * 2} + ${currentDecoder4x16Inputs[0] * 1}<br>
                    = ${inputDecimal}
                </div>
                
                <p><strong>Step 3:</strong> Check enable signal</p>
                <div class="excess-step">
                    Enable (E) = ${decoder4x16Enable}<br>
                    ${decoder4x16Enable === 1 ? 
                        'Enable is ACTIVE  Decoding proceeds' : 
                        'Enable is INACTIVE  All outputs remain 0'}
                </div>
                
                <p><strong>Step 4:</strong> Activate corresponding output</p>
                <div class="excess-step">
                    ${decoder4x16Enable === 1 ? 
                        `Since input = ${inputDecimal}, activate output Y${inputDecimal}` : 
                        'All outputs remain inactive (0)'}<br>
                    Output Y${inputDecimal} = ${decoder4x16Enable === 1 ? '1 (ACTIVE)' : '0'}
                </div>
                
                <p><strong>Step 5:</strong> Final output pattern</p>
                <div class="excess-step">
                    ${decoder4x16Outputs.map((val, idx) => 
                        `Y${idx} = ${val}`).join(', ')}
                </div>
            </div>
        </div>
    `;
    
    // Insert at beginning
    stepsContainer.insertAdjacentHTML('afterbegin', stepHTML);
}

function show4x16TruthTable() {
    const resultsContainer = document.getElementById('mux-calculation-steps');
    const stepsContainer = document.getElementById('mux-steps-container');
    
    // Clear previous results
    stepsContainer.innerHTML = '';
    
    let tableHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">4:16 Decoder Complete Truth Table (Enable = 1)</div>
            <div class="truth-table-container" style="max-height: 500px;">
                <table class="truth-table">
                    <thead>
                        <tr>
                            <th>Decimal</th>
                            <th>Binary (A3A2A1A0)</th>
                            <th>Active Output</th>
                            <th>Output Pattern</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Generate all 16 rows
    for (let i = 0; i < 16; i++) {
        // Calculate binary representation
        const binary = i.toString(2).padStart(4, '0');
        const binaryArray = binary.split('').map(Number);
        const binaryFormatted = `${binaryArray[0]}${binaryArray[1]}${binaryArray[2]}${binaryArray[3]}`;
        
        // Create output pattern
        let outputPattern = '';
        for (let j = 0; j < 16; j++) {
            outputPattern += j === i ? '1' : '0';
        }
        
        tableHTML += `
            <tr>
                <td>${i}</td>
                <td>${binaryFormatted}</td>
                <td>Y${i}</td>
                <td>${outputPattern}</td>
            </tr>
        `;
    }
    
    tableHTML += `
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="sequential-step">
            <div class="calculation-title">Truth Table Notes</div>
            <div class="calculation-content">
                <p><strong>Key Points:</strong></p>
                <ul>
                    <li>When Enable = 0, all outputs are 0 regardless of input</li>
                    <li>Exactly one output is active (1) when Enable = 1</li>
                    <li>Output Yn corresponds to binary input n</li>
                    <li>Input A3 is MSB, A0 is LSB</li>
                    <li>Output pattern shows which output line is active</li>
                </ul>
            </div>
        </div>
    `;
    
    stepsContainer.innerHTML = tableHTML;
    resultsContainer.style.display = 'block';
    
    addLog('Displayed complete 4:16 Decoder truth table', 'info');
}

function reset4x16Decoder() {
    // Reset all inputs to 0
    currentDecoder4x16Inputs = [0, 0, 0, 0];
    decoder4x16Enable = 1;
    decoder4x16Outputs = Array(16).fill(0);
    
    // Reset checkboxes
    document.getElementById('decoder4x16-input-a0').checked = false;
    document.getElementById('decoder4x16-input-a1').checked = false;
    document.getElementById('decoder4x16-input-a2').checked = false;
    document.getElementById('decoder4x16-input-a3').checked = false;
    document.getElementById('decoder4x16-input-enable').checked = true;
    
    // Update labels
    document.querySelectorAll('#decoder4x16-inputs .input-toggle span:last-child').forEach((span, index) => {
        if (index < 4) {
            span.textContent = '0 (OFF)';
        } else {
            span.textContent = '1 (ON)';
        }
    });
    
    // Clear results display
    document.getElementById('mux-calculation-steps').style.display = 'none';
    document.getElementById('mux-steps-container').innerHTML = '';
    
    // Refresh visualization
    display4x16DecoderVisualization();
    
    addLog('4:16 Decoder reset to initial values', 'info');
}

function close4x16Decoder() {
    // Hide the 4:16 Decoder section
    document.getElementById('decoder4x16-inputs').style.display = 'none';
    document.getElementById('decoder4x16-buttons').style.display = 'none';
    
    // Hide results
    document.getElementById('mux-calculation-steps').style.display = 'none';
    
    // Reset MUX/Decoder to initial state
    selectMuxDecoderType('mux2');
    
    addLog('4:16 Decoder closed', 'info');
}

function display4x16DecoderVisualization() {
    const explanationDiv = document.getElementById('mux-explanation');
    
    const htmlParts = [];
    
    htmlParts.push(`
        <div style="text-align: center; padding: 20px;">
            <h4>4:16 Decoder Visualization</h4>
            
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin: 20px 0;">
                <!-- Input Section -->
                <div style="background: rgba(139, 69, 19, 0.1); padding: 15px; border-radius: 10px;">
                    <h5>Inputs</h5>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <div class="circuit-node ${currentDecoder4x16Inputs[3] ? 'active' : ''}">
                            A3<br>${currentDecoder4x16Inputs[3]}
                        </div>
                        <div class="circuit-node ${currentDecoder4x16Inputs[2] ? 'active' : ''}">
                            A2<br>${currentDecoder4x16Inputs[2]}
                        </div>
                        <div class="circuit-node ${currentDecoder4x16Inputs[1] ? 'active' : ''}">
                            A1<br>${currentDecoder4x16Inputs[1]}
                        </div>
                        <div class="circuit-node ${currentDecoder4x16Inputs[0] ? 'active' : ''}">
                            A0<br>${currentDecoder4x16Inputs[0]}
                        </div>
                        <div class="circuit-node ${decoder4x16Enable ? 'active' : ''}" style="background: var(--warning-color);">
                            E<br>${decoder4x16Enable}
                        </div>
                    </div>
                </div>
                
                <!-- Decoder Box -->
                <div style="background: var(--primary-color); color: white; padding: 20px 40px; 
                           border-radius: 10px; font-weight: bold; font-size: 1.2rem;">
                    4:16 DECODER
                </div>
                
                <!-- Outputs Section -->
                <div style="background: rgba(34, 139, 34, 0.1); padding: 15px; border-radius: 10px; width: 100%;">
                    <h5>Outputs (Y0-Y15)</h5>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px;">
    `);
    
    // Add all 16 outputs
    for (let i = 0; i < 16; i++) {
        const isActive = decoder4x16Outputs[i] === 1;
        htmlParts.push(`
            <div class="circuit-node ${isActive ? 'active' : ''}" 
                 style="margin: 5px; width: 60px;">
                Y${i}<br>${isActive ? '1' : '0'}
            </div>
        `);
    }
    
    htmlParts.push(`
                    </div>
                </div>
                
                <!-- Current Status -->
                <div style="background: rgba(65, 105, 225, 0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <h5>Current Status</h5>
                    <p>Binary Input: ${currentDecoder4x16Inputs[3]}${currentDecoder4x16Inputs[2]}${currentDecoder4x16Inputs[1]}${currentDecoder4x16Inputs[0]}</p>
                    <p>Decimal Equivalent: ${parseInt(currentDecoder4x16Inputs.join(''), 2)}</p>
                    <p>Enable: ${decoder4x16Enable} ${decoder4x16Enable === 1 ? '(Active)' : '(Inactive)'}</p>
                    <p>Active Output: ${decoder4x16Enable === 1 ? `Y${parseInt(currentDecoder4x16Inputs.join(''), 2)}` : 'None (disabled)'}</p>
                </div>
            </div>
        </div>
    `);
    
    const visualizationHTML = htmlParts.join('');
    
    explanationDiv.innerHTML = `
        <h5 id="mux-operation-title">4:16 Decoder</h5>
        <div id="mux-operation-explanation">
            ${visualizationHTML}
        </div>
    `;
}
// Add this function to calculate BCD Decoder
// Add this function to calculate BCD Decoder
function calculateBCDDecoder() {
    try {
        // Get input values
        const A = document.getElementById('bcd-input-a').checked ? 1 : 0;
        const B = document.getElementById('bcd-input-b').checked ? 1 : 0;
        const C = document.getElementById('bcd-input-c').checked ? 1 : 0;
        const D = document.getElementById('bcd-input-d').checked ? 1 : 0;
        
        currentBCDDecoderInputs = [D, C, B, A]; // MSB to LSB
        
        // Convert to binary string
        const bcdInput = currentBCDDecoderInputs.join('');
        
        // Decode using the decoder
        const result = bcdDecoder.decode(bcdInput);
        
        // Get gate simulation results
        const gateResults = bcdDecoder.simulateCircuit(A, B, C, D);
        
        // Update outputs
        bcdDecoderOutputs = result.outputPattern.split('').map(bit => parseInt(bit));
        
        // Display results
        displayBCDDecoderResults(bcdInput, result, gateResults);
        
    } catch (error) {
        console.error('Error calculating BCD decoder:', error);
        addLog(`Error calculating BCD decoder: ${error.message}`, 'error');
        
        // Show error in the results area
        const resultsContainer = document.getElementById('mux-explanation');
        resultsContainer.innerHTML = `
            <div class="special-analysis-step active">
                <div class="calculation-title text-danger">Error</div>
                <div class="calculation-content text-danger">
                    <p><strong>Error calculating BCD decoder:</strong></p>
                    <p>${error.message}</p>
                    <p>Please ensure inputs are valid (0 or 1 only).</p>
                </div>
            </div>
        `;
    }
}

// Add this function to display BCD Decoder results
// Add this function to display BCD Decoder results
function displayBCDDecoderResults(bcdInput, result, gateResults) {
    const resultsContainer = document.getElementById('mux-explanation');
    
    // Create results display
    const resultHTML = `
        <div class="special-analysis-step active">
            <div class="calculation-title">BCD to Decimal Decoder Results</div>
            <div class="calculation-content">
                <p><strong>Input BCD:</strong> ${bcdInput} (D=${currentBCDDecoderInputs[0]}, C=${currentBCDDecoderInputs[1]}, B=${currentBCDDecoderInputs[2]}, A=${currentBCDDecoderInputs[3]})</p>
                
                ${result.decimalValue !== null ? 
                    `<p><strong> Valid BCD Code</strong></p>
                     <p><strong>Decimal Value:</strong> ${result.decimalValue}</p>
                     <p><strong>Active Output Line:</strong> Y${result.decimalValue}</p>` :
                    `<p><strong> Invalid BCD Code</strong> (1010-1111 are invalid BCD codes)</p>
                     <p><strong>Status:</strong> All outputs inactive</p>`
                }
                
                <p><strong>Output Pattern (Y9 to Y0):</strong> ${result.outputPattern}</p>
                
                <div class="decoder-outputs mt-3">
                    ${Array.from({length: 10}, (_, i) => i).reverse().map(i => 
                        `<div class="decoder-output ${bcdDecoderOutputs[i] ? 'active' : 'inactive'}">
                            Y${i}<br>
                            <small>${bcdDecoderOutputs[i] ? '1' : '0'}</small>
                        </div>`
                    ).join('')}
                </div>
            </div>
        </div>
        
        <div class="special-analysis-step">
            <div class="calculation-title">Step-by-Step Analysis</div>
            <div class="calculation-content">
                <p><strong>Step 1:</strong> Input BCD code: ${bcdInput}</p>
                <p><strong>Step 2:</strong> Check if valid BCD (0000-1001): ${result.decimalValue !== null ? ' Valid' : ' Invalid'}</p>
                ${result.decimalValue !== null ? 
                    `<p><strong>Step 3:</strong> Map to decimal value: ${result.decimalValue}</p>
                     <p><strong>Step 4:</strong> Activate output line Y${result.decimalValue}</p>
                     <p><strong>Step 5:</strong> Set output pattern: ${result.outputPattern}</p>` :
                    `<p><strong>Step 3:</strong> Invalid BCD  All outputs remain inactive</p>`
                }
                <p><strong>Step ${result.decimalValue !== null ? '6' : '4'}:</strong> Gate outputs calculated:</p>
                <div class="row mt-2">
                    ${Object.entries(gateResults).map(([key, value]) => 
                        `<div class="col-3 mb-2">
                            <div class="gate-description p-2 text-center">
                                <small>${key}</small><br>
                                <strong class="${value === 0 ? 'text-success' : 'text-secondary'}">${value}</strong>
                            </div>
                        </div>`
                    ).join('')}
                </div>
            </div>
        </div>
    `;
    
    resultsContainer.innerHTML = resultHTML;
    resultsContainer.style.display = 'block';
    
    // Update the output value display
    const decimalValue = result.decimalValue !== null ? result.decimalValue : 'Invalid';
    document.getElementById('mux-result').textContent = decimalValue;
    
    addLog(`BCD ${bcdInput} decoded to decimal ${decimalValue}`, 'success');
}
// Add this function to show BCD Decoder truth table
function showBCDDecoderTruthTable() {
    const table = bcdDecoder.generateTruthTable();
    
    const truthTableContainer = document.getElementById('mux-truth-table-container');
    truthTableContainer.style.display = 'block';
    
    let tableHTML = `
        <h5 class="text-center mb-3">BCD to Decimal Decoder - Truth Table</h5>
        <table class="truth-table">
            <tr>
                <th>BCD Input</th>
                <th>D C B A</th>
                <th>Decimal</th>
                <th>Output Pattern<br>(Y9-Y0)</th>
                <th>Active Line</th>
            </tr>
    `;
    
    table.forEach(row => {
        const [d, c, b, a] = row.bcd.split('');
        const isValid = row.decimal !== 'Invalid';
        
        tableHTML += `
            <tr>
                <td>${row.bcd}</td>
                <td>${d} ${c} ${b} ${a}</td>
                <td class="${isValid ? 'active' : 'inactive'}">${row.decimal}</td>
                <td>${row.outputPattern}</td>
                <td>${row.activeLine}</td>
            </tr>
        `;
    });
    
    tableHTML += '</table>';
    
    truthTableContainer.innerHTML = tableHTML;
    addLog('Displayed BCD to Decimal Decoder truth table', 'info');
}

// Add this function to reset BCD Decoder
function resetBCDDecoder() {
    // Reset inputs with null checks
    const inputA = document.getElementById('bcd-input-a');
    const inputB = document.getElementById('bcd-input-b');
    const inputC = document.getElementById('bcd-input-c');
    const inputD = document.getElementById('bcd-input-d');
    
    if (inputA) inputA.checked = false;
    if (inputB) inputB.checked = false;
    if (inputC) inputC.checked = false;
    if (inputD) inputD.checked = false;
    
    // Update labels if container exists
    const bcdInputsContainer = document.getElementById('bcd-decoder-inputs');
    if (bcdInputsContainer) {
        document.querySelectorAll('#bcd-decoder-inputs .ms-2').forEach(span => {
            span.textContent = '0 (OFF)';
        });
    }
    
    // Reset state
    currentBCDDecoderInputs = [0, 0, 0, 0];
    bcdDecoderOutputs = Array(10).fill(0);
    
    // Reset output display with null check
    const muxResult = document.getElementById('mux-result');
    if (muxResult) {
        muxResult.textContent = '-';
    }
    
    // Reset to default explanation with null check
    const explanationDiv = document.getElementById('mux-operation-explanation');
    if (explanationDiv) {
        explanationDiv.innerHTML = `
            <strong>Operation:</strong><br>
            1. 4-bit BCD input D C B A (A=LSB)<br>
            2. Valid BCD codes: 0000-1001 (0-9)<br>
            3. For input = n, output Y = 1 (others = 0)<br>
            4. Invalid codes (1010-1111): All outputs inactive<br>
            <br>
            <strong>BCD Representation:</strong><br>
             0000 = 0 | 0101 = 5<br>
             0001 = 1 | 0110 = 6<br>
             0010 = 2 | 0111 = 7<br>
             0011 = 3 | 1000 = 8<br>
             0100 = 4 | 1001 = 9<br>
            <br>
            <strong>Applications:</strong><br>
             7-segment display drivers<br>
             Digital calculators<br>
             BCD to decimal conversion circuits
        `;
    }
    
    // Hide truth table with null check
    const truthTableContainer = document.getElementById('mux-truth-table-container');
    if (truthTableContainer) {
        truthTableContainer.style.display = 'none';
    }
    
    addLog('BCD Decoder reset to initial state', 'info');
}

// Add this function to close BCD Decoder
function closeBCDDecoder() {
    // Reset BCD decoder state first
    resetBCDDecoder();
    
    // Hide BCD decoder inputs and buttons with null checks
    const bcdInputs = document.getElementById('bcd-decoder-inputs');
    const bcdButtons = document.getElementById('bcd-decoder-buttons');
    
    if (bcdInputs) bcdInputs.style.display = 'none';
    if (bcdButtons) bcdButtons.style.display = 'none';
    
    // Remove active state from BCD decoder button
    const bcdBtn = document.getElementById('bcd-decoder-btn');
    if (bcdBtn) bcdBtn.classList.remove('active');
    
    // Clear any current MUX/Decoder component selection
    currentMuxDecoderComponent = null;
    currentMuxDecoderType = null;
    
    // Reset to default MUX/Decoder state with null check
    const operationTitle = document.getElementById('mux-operation-title');
    if (operationTitle) {
        operationTitle.textContent = 'Multiplexers & Decoders';
    }
    
    // Clear the results/explanation area with null check
    const muxExplanation = document.getElementById('mux-explanation');
    if (muxExplanation) {
        muxExplanation.innerHTML = `
            <h5 id="mux-operation-title">Multiplexers & Decoders</h5>
            <div id="mux-operation-explanation">
                Select 2:1 Multiplexer, 4:1 Multiplexer, 2-to-4 Decoder, 3-to-8 Decoder, 
                Priority Encoder, 4:16 Decoder, or BCD to Decimal Decoder to see their operation
            </div>
        `;
    }
    
    // Reset output display with null check (redundant but safe)
    const muxResult = document.getElementById('mux-result');
    if (muxResult) {
        muxResult.textContent = '-';
    }
    
    // Hide truth table if it's showing with null check
    const truthTableContainer = document.getElementById('mux-truth-table-container');
    if (truthTableContainer) {
        truthTableContainer.style.display = 'none';
    }
    
    // Hide calculation steps if showing with null check
    const calculationSteps = document.getElementById('mux-calculation-steps');
    if (calculationSteps) {
        calculationSteps.style.display = 'none';
    }
    
    // Reset the description with null check
    const muxDescription = document.getElementById('mux-description');
    if (muxDescription) {
        muxDescription.innerHTML = `
            Select a component to see its operation
        `;
    }
    
    addLog('Closed BCD Decoder', 'info');
}
// Add this helper function
function updateBCDDecoderDescription() {
    const description = document.getElementById('mux-description');
    description.innerHTML = `
        <p><strong>BCD to Decimal Decoder</strong></p>
        <p>Converts 4-bit BCD (Binary Coded Decimal) to activate one of 10 decimal outputs (0-9).</p>
        <p><strong>Inputs:</strong> D, C, B, A (4-bit BCD, A=LSB)</p>
        <p><strong>Outputs:</strong> Y0-Y9 (Active high, only one output is active at a time)</p>
        <p><strong>Invalid BCD (1010-1111):</strong> All outputs remain inactive</p>
    `;
    
    // Update main operation explanation
    document.getElementById('mux-explanation').innerHTML = `
        <h5 id="mux-operation-title">BCD to Decimal Decoder</h5>
        <div id="mux-operation-explanation">
            <p><strong>BCD (Binary Coded Decimal) to Decimal Decoder</strong></p>
            <p>Converts 4-bit BCD inputs to 10 decimal outputs (0-9)</p>
            <p><strong>BCD Representation:</strong></p>
            <ul>
                <li>0000 = 0 | 0101 = 5</li>
                <li>0001 = 1 | 0110 = 6</li>
                <li>0010 = 2 | 0111 = 7</li>
                <li>0011 = 3 | 1000 = 8</li>
                <li>0100 = 4 | 1001 = 9</li>
            </ul>
            <p><strong>Invalid BCD codes (1010-1111):</strong> All outputs remain inactive</p>
            <p>Set the 4 input bits (D, C, B, A) and click Calculate to see the decoded output.</p>
        </div>
    `;
}

// Add this helper function
function displayBCDDecoderError(errorMessage) {
    const resultsContainer = document.getElementById('mux-explanation');
    resultsContainer.innerHTML = `
        <div class="special-analysis-step active">
            <div class="calculation-title">Error</div>
            <div class="calculation-content text-danger">
                <p><strong>Error calculating BCD decoder:</strong></p>
                <p>${errorMessage}</p>
                <p>Please ensure inputs are valid (0 or 1 only).</p>
            </div>
        </div>
    `;
}
// Add SRAM initialization function
function initializeSRAMInterface() {
    // Set up event listeners for SRAM controls
    document.getElementById('sram-stored-value')?.addEventListener('change', function() {
        sramState.storedValue = this.checked ? 1 : 0;
        document.getElementById('stored-value-label').textContent = `${sramState.storedValue} ${this.checked ? '(ON)' : '(OFF)'}`;
        
        // Update storage nodes
        updateSRAMStorageNodes();
        addLog(`SRAM stored value changed to ${sramState.storedValue}`, 'info');
    });
    
    document.getElementById('sram-word-line')?.addEventListener('change', function() {
        sramState.wordLine = this.checked ? 1 : 0;
        document.getElementById('wl-label').textContent = `${sramState.wordLine} ${this.checked ? '(ON)' : '(OFF)'}`;
        
        // Update WL line
        const wlLine = document.getElementById('wl-line');
        if (sramState.wordLine) {
            wlLine.classList.add('active');
            wlLine.style.background = 'linear-gradient(90deg, #FF8C00, #FFA500, #FF8C00)';
        } else {
            wlLine.classList.remove('active');
            wlLine.style.background = 'linear-gradient(90deg, #DC143C, #FF6347, #DC143C)';
        }
        addLog(`Word Line ${sramState.wordLine ? 'activated' : 'deactivated'}`, 'info');
    });
    
    document.getElementById('sram-precharge')?.addEventListener('change', function() {
        sramState.precharge = this.checked ? 1 : 0;
        document.getElementById('precharge-label').textContent = `${sramState.precharge} ${this.checked ? '(ON)' : '(OFF)'}`;
        
        // Update bitlines
        updateBitlineVoltages();
        addLog(`Precharge ${sramState.precharge ? 'enabled' : 'disabled'}`, 'info');
    });
    
    document.getElementById('sram-sense-amp')?.addEventListener('change', function() {
        sramState.senseAmp = this.checked ? 1 : 0;
        document.getElementById('sense-amp-label').textContent = `${sramState.senseAmp} ${this.checked ? '(ON)' : '(OFF)'}`;
        
        const senseAmp = document.querySelector('.flipflop-symbol');
        if (sramState.senseAmp) {
            senseAmp.classList.add('active');
            senseAmp.style.background = 'linear-gradient(135deg, #FF8C00, #FFA500)';
            senseAmp.style.boxShadow = '0 0 15px rgba(255, 140, 0, 0.8)';
        } else {
            senseAmp.classList.remove('active');
            senseAmp.style.background = 'linear-gradient(135deg, #FF8C00, #FFA500)';
            senseAmp.style.boxShadow = 'none';
        }
        addLog(`Sense Amplifier ${sramState.senseAmp ? 'enabled' : 'disabled'}`, 'info');
    });
    
    // Operation buttons
    document.getElementById('simulate-read-btn')?.addEventListener('click', function() {
        simulateSRAMRead();
    });
    
    document.getElementById('step-by-step-btn')?.addEventListener('click', function() {
        startStepByStepDemo();
    });
    
    document.getElementById('show-truth-table-sram-btn')?.addEventListener('click', function() {
        showSRAMTruthTable();
    });
    
    document.getElementById('reset-sram-btn')?.addEventListener('click', function() {
        resetSRAM();
    });
    
    // Initialize display
    updateSRAMStorageNodes();
    updateBitlineVoltages();
    drawWaveform();
}

// SRAM Functions
function updateSRAMStorageNodes() {
    const qNode = document.getElementById('q-node');
    const qbarNode = document.getElementById('qbar-node');
    
    if (sramState.storedValue === 1) {
        qNode.textContent = '1';
        qNode.classList.add('active');
        qbarNode.textContent = '0';
        qbarNode.classList.remove('active');
    } else {
        qNode.textContent = '0';
        qNode.classList.remove('active');
        qbarNode.textContent = '1';
        qbarNode.classList.add('active');
    }
}

function updateBitlineVoltages() {
    if (sramState.precharge) {
        sramState.blVoltage = 1.0;
        sramState.blbVoltage = 1.0;
        
        const blLine = document.getElementById('bl-line');
        const blbLine = document.getElementById('blb-line');
        blLine.classList.add('active');
        blbLine.classList.add('active');
    } else if (sramState.wordLine) {
        // Simulate discharge based on stored value
        if (sramState.storedValue === 1) {
            sramState.blVoltage = 1.0; // Stays high
            sramState.blbVoltage = 0.6; // Discharges
            document.getElementById('blb-line').classList.add('bitline-discharge');
        } else {
            sramState.blVoltage = 0.6; // Discharges
            sramState.blbVoltage = 1.0; // Stays high
            document.getElementById('bl-line').classList.add('bitline-discharge');
        }
    }
    
    document.getElementById('bl-voltage').textContent = `${sramState.blVoltage.toFixed(1)}V`;
    document.getElementById('blb-voltage').textContent = `${sramState.blbVoltage.toFixed(1)}V`;
}

function simulateSRAMRead() {
    addLog('Starting SRAM read simulation...', 'info');
    
    // Reset previous states
    resetSRAMSteps();
    
    // Step 1: Show precharge phase
    setTimeout(() => {
        document.getElementById('step1').style.display = 'block';
        document.getElementById('step1').classList.add('active');
        sramState.precharge = 1;
        document.getElementById('sram-precharge').checked = true;
        updateBitlineVoltages();
        drawWaveform();
        addLog('Step 1: Bitlines precharged to VDD', 'info');
    }, 1000);
    
    // Step 2: Activate word line
    setTimeout(() => {
        document.getElementById('step2').style.display = 'block';
        document.getElementById('step2').classList.add('active');
        sramState.wordLine = 1;
        document.getElementById('sram-word-line').checked = true;
        document.getElementById('wl-label').textContent = '1 (ON)';
        document.getElementById('wl-line').classList.add('active');
        addLog('Step 2: Word Line activated', 'info');
    }, 3000);
    
    // Step 3: Show discharge
    setTimeout(() => {
        document.getElementById('step3').style.display = 'block';
        document.getElementById('step3').classList.add('active');
        sramState.precharge = 0;
        document.getElementById('sram-precharge').checked = false;
        updateBitlineVoltages();
        drawWaveform();
        addLog('Step 3: One bitline discharges based on stored value', 'info');
    }, 5000);
    
    // Step 4: Activate sense amplifier
    setTimeout(() => {
        document.getElementById('step4').style.display = 'block';
        document.getElementById('step4').classList.add('active');
        sramState.senseAmp = 1;
        document.getElementById('sram-sense-amp').checked = true;
        document.getElementById('sense-amp-label').textContent = '1 (ON)';
        addLog('Step 4: Sense amplifier detects and amplifies difference', 'info');
    }, 7000);
    
    // Step 5: Show output
    setTimeout(() => {
        document.getElementById('step5').style.display = 'block';
        document.getElementById('step5').classList.add('active');
        
        // Calculate read output
        sramState.readOutput = sramState.storedValue;
        document.getElementById('sram-output').textContent = sramState.readOutput;
        document.getElementById('sram-output').style.color = sramState.readOutput ? 'var(--success-color)' : 'var(--success-dark)';
        
        // Update waveform with read output
        drawWaveform();
        addLog(`Step 5: Read complete. Output = ${sramState.readOutput}`, 'success');
        
        // Show success message
        addLog('SRAM read operation completed successfully!', 'success');
    }, 9000);
}

function startStepByStepDemo() {
    // Hide truth table if visible
    document.getElementById('sram-truth-table-container').style.display = 'none';
    document.getElementById('sram-explanation').style.display = 'block';
    
    // Reset steps
    resetSRAMSteps();
    
    // Start demo
    simulateSRAMRead();
}

function showSRAMTruthTable() {
    document.getElementById('sram-truth-table-container').style.display = 'block';
    document.getElementById('sram-explanation').style.display = 'none';
}

function resetSRAM() {
    // Reset state
    sramState = {
        storedValue: 1,
        wordLine: 0,
        precharge: 1,
        senseAmp: 0,
        blVoltage: 1.0,
        blbVoltage: 1.0,
        readOutput: -1
    };
    
    // Reset UI elements
    document.getElementById('sram-stored-value').checked = true;
    document.getElementById('stored-value-label').textContent = '1 (ON)';
    
    document.getElementById('sram-word-line').checked = false;
    document.getElementById('wl-label').textContent = '0 (OFF)';
    
    document.getElementById('sram-precharge').checked = true;
    document.getElementById('precharge-label').textContent = '1 (ON)';
    
    document.getElementById('sram-sense-amp').checked = false;
    document.getElementById('sense-amp-label').textContent = '0 (OFF)';
    
    document.getElementById('sram-output').textContent = '-';
    
    // Reset visual elements
    document.getElementById('wl-line').classList.remove('active');
    document.getElementById('wl-line').style.background = 'linear-gradient(90deg, #DC143C, #FF6347, #DC143C)';
    
    document.querySelector('.flipflop-symbol').classList.remove('active');
    document.querySelector('.flipflop-symbol').style.boxShadow = 'none';
    
    document.getElementById('bl-line').classList.remove('bitline-discharge');
    document.getElementById('blb-line').classList.remove('bitline-discharge');
    
    // Reset steps
    resetSRAMSteps();
    
    // Update displays
    updateSRAMStorageNodes();
    updateBitlineVoltages();
    drawWaveform();
    
    addLog('SRAM simulation reset', 'info');
}

function resetSRAMSteps() {
    for (let i = 1; i <= 5; i++) {
        const step = document.getElementById(`step${i}`);
        if (step) {
            step.style.display = 'none';
            step.classList.remove('active');
        }
    }
}

function drawWaveform() {
    const canvas = document.getElementById('sram-waveform');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Draw grid
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 0.5;
    
    // Horizontal grid lines
    for (let i = 0; i <= 10; i++) {
        const y = i * height / 10;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
    }
    
    // Vertical grid lines
    for (let i = 0; i <= 10; i++) {
        const x = i * width / 10;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
    }
    
    // Draw waveforms
    const timePoints = Array.from({length: 100}, (_, i) => i);
    
    // BL waveform (blue)
    ctx.strokeStyle = '#4169E1';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    timePoints.forEach((t, i) => {
        let voltage;
        if (t < 30) {
            voltage = sramState.precharge ? 1.0 : 0.8; // Precharge phase
        } else if (t < 70 && sramState.wordLine) {
            voltage = sramState.storedValue === 1 ? 1.0 : 0.6; // Discharge if stored 0
        } else {
            voltage = sramState.storedValue === 1 ? 1.0 : 0.6;
        }
        
        const x = (i / timePoints.length) * width;
        const y = height - (voltage * height);
        
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    
    ctx.stroke();
    
    // ~BL waveform (red)
    ctx.strokeStyle = '#DC143C';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    timePoints.forEach((t, i) => {
        let voltage;
        if (t < 30) {
            voltage = sramState.precharge ? 1.0 : 0.8; // Precharge phase
        } else if (t < 70 && sramState.wordLine) {
            voltage = sramState.storedValue === 1 ? 0.6 : 1.0; // Discharge if stored 1
        } else {
            voltage = sramState.storedValue === 1 ? 0.6 : 1.0;
        }
        
        const x = (i / timePoints.length) * width;
        const y = height - (voltage * height);
        
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    
    ctx.stroke();
    
    // Draw labels
    ctx.fillStyle = '#333';
    ctx.font = '12px Arial';
    ctx.fillText('Time', width - 40, height - 5);
    ctx.fillText('Voltage', 5, 15);
    
    // Draw voltage scale
    ctx.strokeStyle = '#666';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(40, height - 20);
    ctx.lineTo(60, height - 20);
    ctx.stroke();
    ctx.fillText('1.0V', 65, height - 18);
    
    ctx.beginPath();
    ctx.moveTo(40, height - 40);
    ctx.lineTo(60, height - 40);
    ctx.stroke();
    ctx.fillText('0.5V', 65, height - 38);
    
    ctx.beginPath();
    ctx.moveTo(40, height - 60);
    ctx.lineTo(60, height - 60);
    ctx.stroke();
    ctx.fillText('0.0V', 65, height - 58);
    
    // Draw legend
    ctx.fillStyle = '#4169E1';
    ctx.fillRect(width - 120, 10, 20, 10);
    ctx.fillStyle = '#333';
    ctx.fillText('BL', width - 95, 20);
    
    ctx.fillStyle = '#DC143C';
    ctx.fillRect(width - 120, 30, 20, 10);
    ctx.fillStyle = '#333';
    ctx.fillText('~BL', width - 95, 40);
}

// Add to the existing JavaScript file
// Ring Counter and Johnson Counter Implementation
// Mod-N Counter Implementation
class ModNCounter {
    constructor(N = 4, type = 'synchronous') {
        this.N = N;
        this.type = type;
        this.numBits = this.calculateBitsNeeded(N);
        this.reset();
    }

    calculateBitsNeeded(N) {
        let bits = 0;
        while ((1 << bits) < N) {
            bits++;
        }
        return bits;
    }

    reset() {
        this.state = new Array(this.numBits).fill(0);
        this.currentCount = 0;
        this.history = [];
        this.clockCycles = 0;
        return `Mod-${this.N} counter reset to initial state (0).`;
    }

    getStatus() {
        const binaryStr = this.state.join('');
        return {
            N: this.N,
            type: this.type,
            bits: this.numBits,
            binary: binaryStr,
            decimal: this.currentCount,
            clockCycles: this.clockCycles,
            maxCount: this.N - 1
        };
    }

    generateTruthTable(cycles = null) {
        if (cycles === null) cycles = this.N * 2;
        
        // Save current state
        const originalState = [...this.state];
        const originalCount = this.currentCount;
        const originalCycles = this.clockCycles;
        
        // Reset for generating truth table
        this.reset();
        
        const table = [{
            clock: 0,
            binary: this.state.join(' '),
            decimal: 0,
            state: 'Start'
        }];
        
        for (let cycle = 1; cycle <= cycles; cycle++) {
            this.clockPulse();
            const decimal = this.currentCount;
            const stateLabel = decimal < this.N ? `S${decimal}` : 'Reset';
            
            table.push({
                clock: cycle,
                binary: this.state.join(' '),
                decimal: decimal,
                state: stateLabel
            });
        }
        
        // Restore original state
        this.state = originalState;
        this.currentCount = originalCount;
        this.clockCycles = originalCycles;
        
        return table;
    }

    clockPulse() {
        if (this.type === 'synchronous') {
            this.incrementSynchronous();
        } else {
            this.incrementAsynchronous();
        }
        
        this.history.push([...this.state]);
        this.clockCycles++;
    }

    incrementSynchronous() {
        this.currentCount = (this.currentCount + 1) % this.N;
        this.state = this.decimalToBinary(this.currentCount);
    }

    incrementAsynchronous() {
        // Ripple counter implementation
        for (let i = 0; i < this.numBits; i++) {
            if (this.state[i] === 0) {
                this.state[i] = 1;
                break;
            } else {
                this.state[i] = 0;
            }
        }
        
        this.currentCount = this.binaryToDecimal(this.state);
        if (this.currentCount >= this.N) {
            this.currentCount = 0;
            this.state = new Array(this.numBits).fill(0);
        }
    }

    binaryToDecimal(binaryArray) {
        return parseInt(binaryArray.join(''), 2);
    }

    decimalToBinary(decimal) {
        const binary = decimal.toString(2).padStart(this.numBits, '0');
        return binary.split('').map(bit => parseInt(bit));
    }

    generateCircuitDiagram() {
        const bits = this.numBits;
        const N = this.N;
        const binaryN = this.decimalToBinary(N);
        
        return {
            title: `Mod-${N} Counter (${this.type})`,
            bits: bits,
            N: N,
            flipFlops: Array.from({ length: bits }, (_, i) => ({
                id: `FF${i}`,
                label: `Q${i}`,
                position: { x: 150, y: 100 + i * 80 }
            })),
            andGate: {
                id: 'AND1',
                label: `Detect ${N}`,
                position: { x: 350, y: 100 + (bits - 1) * 40 }
            },
            connections: {
                clock: { from: 'CLK', to: 'All FFs' },
                outputs: binaryN.map((bit, i) => ({
                    from: `Q${i}`,
                    to: 'AND1',
                    inverted: bit === 0,
                    label: bit === 1 ? `Q${i}` : `Q${i}'`
                })),
                reset: { from: 'AND1', to: 'All FFs', label: 'Clear' }
            }
        };
    }
}

// Global Mod-N Counter instance
let modNCounter = null;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize with default values
    initializeModNCounter();
    
    // Event Listeners
    setupModNEventListeners();
});

function setupModNEventListeners() {
    // Mod-N Counter button click
    const modNButton = document.getElementById('mod-n-counter-btn');
    if (modNButton) {
        modNButton.addEventListener('click', function() {
            showModNSection('mod-n-counter-inputs');
            updateBitsDisplay();
        });
    }

    // Close Mod-N Counter
    const closeButton = document.getElementById('close-mod-n-btn');
    if (closeButton) {
        closeButton.addEventListener('click', function() {
            document.getElementById('mod-n-counter-inputs').style.display = 'none';
            clearModNResults();
            showMessage("Mod-N Counter interface closed successfully.", "success");
        });
    }

    // Show Circuit Diagram
    const circuitButton = document.getElementById('show-mod-n-circuit-btn');
    if (circuitButton) {
        circuitButton.addEventListener('click', function() {
            if (!modNCounter) {
                showMessage("Please configure the counter first.", "error");
                return;
            }
            displayCircuitDiagram();
        });
    }

    // Show Truth Table
    const truthTableButton = document.getElementById('show-mod-n-truth-table-btn');
    if (truthTableButton) {
        truthTableButton.addEventListener('click', function() {
            if (!modNCounter) {
                showMessage("Please configure the counter first.", "error");
                return;
            }
            displayTruthTable();
        });
    }

    // Reset Counter
    const resetButton = document.getElementById('reset-mod-n-btn');
    if (resetButton) {
        resetButton.addEventListener('click', function() {
            if (!modNCounter) {
                showMessage("Please configure the counter first.", "error");
                return;
            }
            const message = modNCounter.reset();
            showMessage(message, "success");
            updateModNStatus();
        });
    }

    // Input changes
    const nInput = document.getElementById('mod-n-value');
    if (nInput) {
        nInput.addEventListener('input', function() {
            const N = parseInt(this.value) || 4;
            if (N < 2) N = 2;
            if (N > 32) N = 32;
            this.value = N;
            
            const type = document.getElementById('mod-n-type').value;
            modNCounter = new ModNCounter(N, type);
            updateBitsDisplay();
            updateModNStatus();
        });
    }

    const typeSelect = document.getElementById('mod-n-type');
    if (typeSelect) {
        typeSelect.addEventListener('change', function() {
            const N = parseInt(document.getElementById('mod-n-value').value) || 4;
            const type = this.value;
            modNCounter = new ModNCounter(N, type);
            updateModNStatus();
        });
    }
}

function initializeModNCounter() {
    const N = parseInt(document.getElementById('mod-n-value')?.value) || 4;
    const type = document.getElementById('mod-n-type')?.value || 'synchronous';
    
    modNCounter = new ModNCounter(N, type);
    updateBitsDisplay();
}

function updateBitsDisplay() {
    if (!modNCounter) return;
    
    const bitsDisplay = document.getElementById('mod-n-bits-display');
    if (bitsDisplay) {
        const bits = modNCounter.numBits;
        bitsDisplay.value = `${bits} bit${bits > 1 ? 's' : ''} (0 to ${Math.pow(2, bits) - 1})`;
    }
}

function updateModNStatus() {
    if (!modNCounter) return;
    
    const status = modNCounter.getStatus();
    const statusElement = document.getElementById('mod-n-status');
    
    if (statusElement) {
        statusElement.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="status-dot bg-success"></div>
                <span class="ms-2">
                    Mod-${status.N} ${status.type} Counter | 
                    ${status.bits} bits | 
                    Count: 0  ${status.maxCount}  0
                </span>
            </div>
        `;
    }
}

function displayCircuitDiagram() {
    if (!modNCounter) return;
    
    const diagram = modNCounter.generateCircuitDiagram();
    const resultsDiv = getOrCreateResultsDiv();
    
    // Create the ASCII-style circuit diagram
    const asciiDiagram = createAsciiCircuitDiagram(diagram);
    
    resultsDiv.innerHTML = `
        <div class="glass-card">
            <h4 class="text-center mb-4">${diagram.title} Circuit Diagram</h4>
            
            <div class="circuit-diagram-container" style="height: ${300 + diagram.bits * 60}px;">
                ${renderCircuitDiagram(diagram)}
            </div>
            
            <div class="animation-explanation mt-4">
                <h5>Circuit Explanation:</h5>
                <p>This ${diagram.title} uses ${diagram.bits} JK flip-flops connected in ${modNCounter.type === 'synchronous' ? 'parallel' : 'series'}.</p>
                <p>The AND gate detects when the count reaches ${diagram.N} (binary: ${modNCounter.decimalToBinary(diagram.N).join('')}) and generates a CLEAR signal.</p>
                <p><strong>AND Gate Inputs:</strong> ${diagram.connections.outputs.map(conn => conn.label).join(', ')}</p>
                <p><strong>Count sequence:</strong> 0  ${diagram.N - 1}  0</p>
                <p><strong>Unused states:</strong> ${Math.pow(2, diagram.bits) - diagram.N}</p>
            </div>
            
            <div class="text-center mt-3">
                <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px;">${asciiDiagram}</pre>
            </div>
        </div>
    `;
    
    showMessage(`Circuit diagram for Mod-${diagram.N} counter displayed successfully.`, "success");
}

function renderCircuitDiagram(diagram) {
    const bits = diagram.bits;
    let html = '';
    
    // Clock input
    html += `
        <div class="circuit-node" style="top: 50px; left: 50px; width: 60px; height: 60px;">
            <i class="fas fa-clock"></i><br>
            <small>CLK</small>
        </div>
    `;
    
    // Flip-flops
    diagram.flipFlops.forEach((ff, i) => {
        const top = 80 + i * 80;
        html += `
            <div class="flipflop-circuit" style="top: ${top}px; left: 150px; width: 100px; height: 70px;">
                <div class="flipflop-body" style="width: 80px; height: 50px;">
                    JK<br><small>FF${i}</small>
                </div>
                <div class="circuit-label" style="top: -15px; left: 85px;">
                    Q${i}
                </div>
                <div class="circuit-label" style="top: 25px; left: 85px;">
                    Q${i}'
                </div>
            </div>
            
            <!-- Clock connection -->
            <div class="circuit-line" style="top: ${top + 35}px; left: 110px; width: 40px;"></div>
            
            <!-- Output line -->
            <div class="circuit-line" style="top: ${top + 15}px; left: 250px; width: 100px;"></div>
            
            <!-- Inversion bubble if needed -->
            ${diagram.connections.outputs[i].inverted ? 
                `<div class="circuit-node" style="top: ${top + 15}px; left: 340px; width: 20px; height: 20px; border-radius: 50%; background: white; border: 2px solid var(--primary-color);"></div>` 
                : ''}
        `;
    });
    
    // AND Gate
    const andTop = 80 + (bits - 1) * 40;
    html += `
        <div class="gate-symbol-real" style="top: ${andTop}px; left: 380px; width: 60px; height: 60px;">
            AND
        </div>
        
        <!-- AND Gate output to reset -->
        <div class="circuit-line" style="top: ${andTop + 30}px; left: 440px; width: 60px;"></div>
        
        <div class="circuit-node" style="top: ${andTop + 25}px; left: 510px; width: 70px; height: 40px;">
            CLEAR<br><small>to all FFs</small>
        </div>
    `;
    
    return html;
}

function createAsciiCircuitDiagram(diagram) {
    const bits = diagram.bits;
    const lines = [];
    
    lines.push("=".repeat(60));
    lines.push(`MOD-${diagram.N} COUNTER CIRCUIT DIAGRAM (${modNCounter.type.toUpperCase()})`);
    lines.push("=".repeat(60));
    lines.push("");
    lines.push("Clock Signal");
    lines.push("     ");
    lines.push("     +---+".repeat(bits));
    
    for (let i = 0; i < bits; i++) {
        lines.push(`     | J |  Q${i}`);
        lines.push(`     |   |`);
        lines.push(`     | K |  Q${i}'`);
        lines.push("     +---+");
    }
    
    lines.push("");
    lines.push("Outputs to AND Gate:");
    diagram.connections.outputs.forEach((conn, i) => {
        lines.push(`  Q${i}${conn.inverted ? "'" : ""}  AND input ${i + 1}`);
    });
    
    lines.push("");
    lines.push("AND Gate detects when count = " + diagram.N);
    lines.push("AND Output  CLEAR signal to all flip-flops");
    lines.push("");
    lines.push("-".repeat(60));
    lines.push(`Number of flip-flops: ${bits}`);
    lines.push(`Maximum count: ${diagram.N - 1}`);
    lines.push(`Reset condition: Count = ${diagram.N}`);
    lines.push("-".repeat(60));
    
    return lines.join('\n');
}

function displayTruthTable() {
    if (!modNCounter) return;
    
    const tableData = modNCounter.generateTruthTable();
    const status = modNCounter.getStatus();
    const resultsDiv = getOrCreateResultsDiv();
    
    // Create bit visualization for each row
    const tableRows = tableData.map(row => {
        const bits = row.binary.split(' ').map(bit => parseInt(bit));
        const bitCells = bits.map((bit, idx) => `
            <div class="bit-cell ${bit === 1 ? 'active' : 'inactive'}">
                ${bit}
                <div class="bit-label">Q${idx}</div>
            </div>
        `).join('');
        
        const stateClass = row.state === 'Start' ? 'bg-primary' : 
                          row.state === 'Reset' ? 'bg-danger' : 'bg-success';
        
        return `
            <tr>
                <td class="text-center fw-bold">${row.clock}</td>
                <td>
                    <div class="bit-sequence-display">
                        ${bitCells}
                    </div>
                    <div class="text-center small mt-1">${row.binary}</div>
                </td>
                <td class="text-center fw-bold">${row.decimal}</td>
                <td class="text-center">
                    <span class="badge ${stateClass}">${row.state}</span>
                </td>
            </tr>
        `;
    }).join('');
    
    resultsDiv.innerHTML = `
        <div class="glass-card">
            <h4 class="text-center mb-4">Mod-${status.N} Counter Truth Table (${status.type})</h4>
            
            <div class="gate-description mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-value">${status.bits}</div>
                            <small>Flip-flops</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-value">${status.N}</div>
                            <small>Modulus Value</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-value">${status.maxCount}</div>
                            <small>Maximum Count</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="truth-table-container" style="max-height: 500px;">
                <table class="truth-table">
                    <thead>
                        <tr>
                            <th class="text-center">Clock<br>Cycle</th>
                            <th class="text-center">Binary Output<br>(${status.bits} bits)</th>
                            <th class="text-center">Decimal</th>
                            <th class="text-center">State</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            </div>
            
            <div class="animation-explanation mt-4">
                <h5>Truth Table Analysis:</h5>
                <p>The counter counts from 0 to ${status.maxCount} and then resets to 0.</p>
                <p><strong>Total states:</strong> ${status.N} (0 to ${status.maxCount})</p>
                <p><strong>Clock cycles per complete cycle:</strong> ${status.N}</p>
                <p><strong>Frequency division:</strong></p>
                <ul>
                    ${Array.from({ length: status.bits }, (_, i) => 
                        `<li>Q${i} frequency = Clock frequency / ${Math.pow(2, i + 1)}</li>`
                    ).join('')}
                </ul>
                <p><strong>Unused states:</strong> ${Math.pow(2, status.bits) - status.N} states are never reached</p>
            </div>
        </div>
    `;
    
    showMessage(`Truth table for Mod-${status.N} counter displayed successfully.`, "success");
}

function getOrCreateResultsDiv() {
    const col8Div = document.querySelector('#sequential-circuit2-section .col-md-8');
    let resultsDiv = document.getElementById('sequential-circuit2-results');
    
    if (!resultsDiv) {
        resultsDiv = document.createElement('div');
        resultsDiv.id = 'sequential-circuit2-results';
        col8Div.insertBefore(resultsDiv, col8Div.firstChild);
    }
    
    resultsDiv.innerHTML = ''; // Clear previous content
    return resultsDiv;
}

function clearModNResults() {
    const resultsDiv = document.getElementById('sequential-circuit2-results');
    if (resultsDiv) {
        resultsDiv.innerHTML = '';
    }
}

function showModNSection(sectionId) {
    // Hide all input sections
    const sections = [
        't-flipflop-inputs', 'register-storage-inputs', 'master-slave-inputs',
        'setup-time-inputs', 'hold-time-inputs', 'clock-skew-inputs',
        'async-reset-inputs', 'synchronous-reset-inputs', 'parallel-load-inputs',
        'ring-counter-inputs', 'johnson-counter-inputs', 'binary-counter-inputs',
        'mod-n-counter-inputs'
    ];
    
    sections.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'none';
    });
    
    // Show requested section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.style.display = 'block';
    }
}

function showMessage(message, type = "info") {
    // Remove any existing messages
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} 
                         alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
class RingCounter {
    constructor(bits = 4, initialState = null) {
        this.bits = bits;
        this.state = initialState ? [...initialState] : this.getDefaultInitialState();
        this.history = [];
        this.currentStep = 0;
        this.recordStep("Initialized Ring Counter");
    }

    getDefaultInitialState() {
        const state = new Array(this.bits).fill(0);
        state[0] = 1;
        return state;
    }

    shiftRight() {
        const msb = this.state[this.bits - 1];
        for (let i = this.bits - 1; i > 0; i--) {
            this.state[i] = this.state[i - 1];
        }
        this.state[0] = msb;
        this.recordStep(`Shifted Right: ${this.getStateString()}`);
        return this.state;
    }

    shiftLeft() {
        const lsb = this.state[0];
        for (let i = 0; i < this.bits - 1; i++) {
            this.state[i] = this.state[i + 1];
        }
        this.state[this.bits - 1] = lsb;
        this.recordStep(`Shifted Left: ${this.getStateString()}`);
        return this.state;
    }

    shift(direction = 'right') {
        return direction === 'right' ? this.shiftRight() : this.shiftLeft();
    }

    reset(state = null) {
        this.state = state ? [...state] : this.getDefaultInitialState();
        this.currentStep = 0;
        this.recordStep(`Reset: ${this.getStateString()}`);
        return this.state;
    }

    getState() {
        return [...this.state];
    }

    getStateString() {
        return this.state.join('');
    }

    getDecimal() {
        return parseInt(this.getStateString(), 2);
    }

    recordStep(description) {
        this.history.push({
            step: this.currentStep++,
            state: [...this.state],
            description: description,
            decimal: this.getDecimal()
        });
    }

    simulateSequence(steps = null, direction = 'right') {
        if (steps === null) steps = this.bits;
        const sequence = [this.getState()];
        const counter = new RingCounter(this.bits, this.getState());
        
        for (let i = 1; i < steps; i++) {
            counter.shift(direction);
            sequence.push(counter.getState());
        }
        
        return sequence;
    }

    getHistory() {
        return [...this.history];
    }

    getTruthTable() {
        const sequence = this.simulateSequence(this.bits);
        const table = [];
        
        for (let i = 0; i < sequence.length; i++) {
            table.push({
                clock: i,
                state: sequence[i],
                stateString: sequence[i].join(''),
                decimal: parseInt(sequence[i].join(''), 2)
            });
        }
        
        return table;
    }
}

class JohnsonCounter {
    constructor(bits = 4, initialState = null) {
        this.bits = bits;
        this.state = initialState ? [...initialState] : this.getDefaultInitialState();
        this.history = [];
        this.currentStep = 0;
        this.recordStep("Initialized Johnson Counter");
    }

    getDefaultInitialState() {
        return new Array(this.bits).fill(0);
    }

    shiftRight() {
        const feedback = 1 - this.state[this.bits - 1];
        for (let i = this.bits - 1; i > 0; i--) {
            this.state[i] = this.state[i - 1];
        }
        this.state[0] = feedback;
        this.recordStep(`Shifted Right: ${this.getStateString()}`);
        return this.state;
    }

    shiftLeft() {
        const feedback = 1 - this.state[0];
        for (let i = 0; i < this.bits - 1; i++) {
            this.state[i] = this.state[i + 1];
        }
        this.state[this.bits - 1] = feedback;
        this.recordStep(`Shifted Left: ${this.getStateString()}`);
        return this.state;
    }

    shift(direction = 'right') {
        return direction === 'right' ? this.shiftRight() : this.shiftLeft();
    }

    reset(state = null) {
        this.state = state ? [...state] : this.getDefaultInitialState();
        this.currentStep = 0;
        this.recordStep(`Reset: ${this.getStateString()}`);
        return this.state;
    }

    getState() {
        return [...this.state];
    }

    getStateString() {
        return this.state.join('');
    }

    getDecimal() {
        return parseInt(this.getStateString(), 2);
    }

    recordStep(description) {
        this.history.push({
            step: this.currentStep++,
            state: [...this.state],
            description: description,
            decimal: this.getDecimal()
        });
    }

    simulateSequence(steps = null, direction = 'right') {
        if (steps === null) steps = 2 * this.bits;
        const sequence = [this.getState()];
        const counter = new JohnsonCounter(this.bits, this.getState());
        
        for (let i = 1; i < steps; i++) {
            counter.shift(direction);
            sequence.push(counter.getState());
        }
        
        return sequence;
    }

    getHistory() {
        return [...this.history];
    }

    getTruthTable() {
        const sequence = this.simulateSequence();
        const table = [];
        
        for (let i = 0; i < sequence.length; i++) {
            table.push({
                clock: i,
                state: sequence[i],
                stateString: sequence[i].join(''),
                decimal: parseInt(sequence[i].join(''), 2)
            });
        }
        
        return table;
    }
}
// Global variables
let currentRingCounter = null;
let currentJohnsonCounter = null;

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Ring Counter Button
    document.getElementById('ring-counter-btn')?.addEventListener('click', function() {
        showRingCounterInterface();
    });

    // Johnson Counter Button
    document.getElementById('johnson-counter-btn')?.addEventListener('click', function() {
        showJohnsonCounterInterface();
    });

    // Ring Counter Input Change Events
    document.getElementById('ring-counter-initial')?.addEventListener('change', function() {
        const customInput = document.getElementById('ring-counter-custom-input');
        customInput.style.display = this.value === 'custom' ? 'block' : 'none';
    });

    document.getElementById('ring-counter-bits')?.addEventListener('change', function() {
        const bits = parseInt(this.value);
        const customInput = document.getElementById('ring-counter-pattern');
        const initialSelect = document.getElementById('ring-counter-initial');
        
        if (initialSelect.value === 'custom' && customInput.value) {
            // Adjust custom pattern to match new bit length
            const currentPattern = customInput.value;
            if (currentPattern.length > bits) {
                customInput.value = currentPattern.slice(0, bits);
            } else if (currentPattern.length < bits) {
                customInput.value = currentPattern.padEnd(bits, '0');
            }
        }
    });

    // Johnson Counter Input Change Events
    document.getElementById('johnson-counter-initial')?.addEventListener('change', function() {
        const customInput = document.getElementById('johnson-counter-custom-input');
        customInput.style.display = this.value === 'custom' ? 'block' : 'none';
    });

    document.getElementById('johnson-counter-bits')?.addEventListener('change', function() {
        const bits = parseInt(this.value);
        const customInput = document.getElementById('johnson-counter-pattern');
        const initialSelect = document.getElementById('johnson-counter-initial');
        
        if (initialSelect.value === 'custom' && customInput.value) {
            const currentPattern = customInput.value;
            if (currentPattern.length > bits) {
                customInput.value = currentPattern.slice(0, bits);
            } else if (currentPattern.length < bits) {
                customInput.value = currentPattern.padEnd(bits, '0');
            }
        }
    });

    // Ring Counter Action Buttons
    document.getElementById('calculate-ring-btn')?.addEventListener('click', function() {
        calculateRingCounterNextState();
    });

    document.getElementById('simulate-ring-sequence-btn')?.addEventListener('click', function() {
        simulateRingCounterSequence();
    });

    document.getElementById('show-ring-truth-table-btn')?.addEventListener('click', function() {
        showRingCounterTruthTable();
    });

    document.getElementById('reset-ring-btn')?.addEventListener('click', function() {
        resetRingCounter();
    });

    document.getElementById('close-ring-btn')?.addEventListener('click', function() {
        closeRingCounterInterface();
    });

    // Johnson Counter Action Buttons
    document.getElementById('calculate-johnson-btn')?.addEventListener('click', function() {
        calculateJohnsonCounterNextState();
    });

    document.getElementById('simulate-johnson-sequence-btn')?.addEventListener('click', function() {
        simulateJohnsonCounterSequence();
    });

    document.getElementById('show-johnson-truth-table-btn')?.addEventListener('click', function() {
        showJohnsonCounterTruthTable();
    });

    document.getElementById('reset-johnson-btn')?.addEventListener('click', function() {
        resetJohnsonCounter();
    });

    document.getElementById('close-johnson-btn')?.addEventListener('click', function() {
        closeJohnsonCounterInterface();
    });
});

// Ring Counter Functions
function showRingCounterInterface() {
    // Hide other inputs
    hideAllCounterInputs();
    
    // Show ring counter inputs
    document.getElementById('ring-counter-inputs').style.display = 'block';
    
    // Update component description
    document.getElementById('sequential2-description').innerHTML = `
        <strong>Ring Counter (Circular Shift Register)</strong><br>
        A ring counter is a type of counter composed of flip-flops connected 
        in a shift register with the output of the last flip-flop fed to the 
        input of the first, making a "circular" or "ring" structure.
    `;
    
    // Initialize ring counter
    initializeRingCounter();
    
    // Show results area
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card">
            <h5 class="text-center">Ring Counter Operation</h5>
            <p class="text-center">Configure the counter and click Calculate</p>
        </div>
    `;
}

function initializeRingCounter() {
    const bits = parseInt(document.getElementById('ring-counter-bits').value);
    const initialType = document.getElementById('ring-counter-initial').value;
    
    let initialState;
    if (initialType === 'custom') {
        const pattern = document.getElementById('ring-counter-pattern').value;
        if (pattern && /^[01]+$/.test(pattern)) {
            initialState = pattern.split('').map(Number);
            if (initialState.length !== bits) {
                initialState = initialState.concat(new Array(bits - initialState.length).fill(0));
            }
        } else {
            initialState = new Array(bits).fill(0);
            initialState[0] = 1;
        }
    } else if (initialType === 'single-zero') {
        initialState = new Array(bits).fill(1);
        initialState[0] = 0;
    } else {
        // single-one
        initialState = new Array(bits).fill(0);
        initialState[0] = 1;
    }
    
    currentRingCounter = new RingCounter(bits, initialState);
    
    // Update current result display
    document.getElementById('sequential2-result').textContent = currentRingCounter.getStateString();
    document.getElementById('sequential2-next-result').textContent = '-';
    
    // Create realistic circuit diagram
    createRingCounterCircuit(bits);
}

function calculateRingCounterNextState() {
    if (!currentRingCounter) return;
    
    const direction = document.getElementById('ring-counter-direction').value;
    currentRingCounter.shift(direction);
    
    // Update displays
    document.getElementById('sequential2-result').textContent = currentRingCounter.getStateString();
    document.getElementById('sequential2-next-result').textContent = '-';
    
    // Show step-by-step analysis
    const history = currentRingCounter.getHistory();
    const lastStep = history[history.length - 1];
    
    const analysisHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Step ${lastStep.step}: ${lastStep.description}</div>
            <div class="calculation-content">
                Current State: <span class="highlight-equation">${lastStep.stateString}</span><br>
                Decimal Value: <span class="highlight-equation">${lastStep.decimal}</span><br>
                Shift Direction: <span class="highlight-equation">${direction}</span>
            </div>
        </div>
    `;
    
    document.getElementById('sequential2-analysis').style.display = 'block';
    document.getElementById('sequential2-analysis-title').textContent = 'Ring Counter Operation';
    document.getElementById('sequential2-steps-container').innerHTML = analysisHTML;
    
    // Update circuit visualization
    updateRingCounterCircuit(currentRingCounter.state);
}

function simulateRingCounterSequence() {
    if (!currentRingCounter) return;
    
    const direction = document.getElementById('ring-counter-direction').value;
    const bits = currentRingCounter.bits;
    const sequence = currentRingCounter.simulateSequence(bits, direction);
    
    let sequenceHTML = `
        <div class="glass-card">
            <h5 class="text-center">Ring Counter Full Sequence (${bits} States)</h5>
            <div class="counter-states">
    `;
    
    sequence.forEach((state, index) => {
        const stateString = state.join('');
        sequenceHTML += `
            <div class="counter-state">
                <div class="state-header">Clock ${index}</div>
                <div class="state-bits">
                    ${state.map((bit, i) => `
                        <span class="counter-bit ${bit === 1 ? 'bit-1' : 'bit-0'}">
                            ${bit}
                            <div class="bit-index">Q${i}</div>
                        </span>
                    `).join('')}
                </div>
                <div class="state-decimal">Decimal: ${parseInt(stateString, 2)}</div>
            </div>
        `;
    });
    
    sequenceHTML += `
            </div>
        </div>
    `;
    
    document.getElementById('sequential2-results').innerHTML = sequenceHTML;
    
    // Show analysis
    const analysisHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Complete Ring Counter Sequence</div>
            <div class="calculation-content">
                Total States: <span class="highlight-equation">${bits}</span><br>
                Shift Direction: <span class="highlight-equation">${direction}</span><br>
                Sequence Length: <span class="highlight-equation">${bits} clock cycles</span><br>
                <br>
                <strong>Sequence Pattern:</strong><br>
                ${sequence.map((state, i) => 
                    `Clock ${i}: ${state.join('')} (Decimal: ${parseInt(state.join(''), 2)})`
                ).join('<br>')}
            </div>
        </div>
    `;
    
    document.getElementById('sequential2-analysis').style.display = 'block';
    document.getElementById('sequential2-analysis-title').textContent = 'Ring Counter Sequence Analysis';
    document.getElementById('sequential2-steps-container').innerHTML = analysisHTML;
}

function showRingCounterTruthTable() {
    if (!currentRingCounter) return;
    
    const truthTable = currentRingCounter.getTruthTable();
    const bits = currentRingCounter.bits;
    
    let tableHTML = `
        <div class="glass-card">
            <h5 class="text-center">Ring Counter Truth Table</h5>
            <table class="truth-table">
                <tr>
                    <th>Clock</th>
    `;
    
    // Add column headers
    for (let i = 0; i < bits; i++) {
        tableHTML += `<th>Q${i}</th>`;
    }
    
    tableHTML += `<th>Decimal</th></tr>`;
    
    // Add rows
    truthTable.forEach(row => {
        tableHTML += `<tr><td>${row.clock}</td>`;
        
        row.state.forEach(bit => {
            tableHTML += `<td class="${bit === 1 ? 'active' : 'inactive'}">${bit}</td>`;
        });
        
        tableHTML += `<td>${row.decimal}</td></tr>`;
    });
    
    tableHTML += `</table></div>`;
    
    document.getElementById('sequential2-results').innerHTML = tableHTML;
    
    // Show analysis
    const analysisHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Ring Counter Truth Table Analysis</div>
            <div class="calculation-content">
                <strong>Characteristics:</strong><br>
                 Number of unique states: ${bits}<br>
                 One-hot encoding pattern<br>
                 Circular shift operation<br>
                 Useful for frequency division<br>
                 Simple decoding logic<br>
                <br>
                <strong>Truth Table Notes:</strong><br>
                 Each clock pulse shifts the single '1' by one position<br>
                 After ${bits} clocks, returns to initial state<br>
                 Only one output is active at any time
            </div>
        </div>
    `;
    
    document.getElementById('sequential2-analysis').style.display = 'block';
    document.getElementById('sequential2-analysis-title').textContent = 'Truth Table Analysis';
    document.getElementById('sequential2-steps-container').innerHTML = analysisHTML;
}

function resetRingCounter() {
    initializeRingCounter();
    
    // Reset results display
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card">
            <h5 class="text-center">Ring Counter Operation</h5>
            <p class="text-center">Counter has been reset to initial state</p>
            <p class="text-center">Current State: ${currentRingCounter.getStateString()}</p>
        </div>
    `;
    
    // Show reset message
    showNotification('Ring counter has been reset to initial state', 'success');
}

function closeRingCounterInterface() {
    document.getElementById('ring-counter-inputs').style.display = 'none';
    document.getElementById('sequential2-results').innerHTML = '';
    document.getElementById('sequential2-analysis').style.display = 'none';
    document.getElementById('sequential2-circuit-container').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-share-alt fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <p class="mt-2">Select a sequential component to visualize its circuit</p>
        </div>
    `;
    
    showNotification('Ring counter interface closed successfully', 'info');
}

// Johnson Counter Functions
function showJohnsonCounterInterface() {
    // Hide other inputs
    hideAllCounterInputs();
    
    // Show johnson counter inputs
    document.getElementById('johnson-counter-inputs').style.display = 'block';
    
    // Update component description
    document.getElementById('sequential2-description').innerHTML = `
        <strong>Johnson Counter (Twisted Ring Counter)</strong><br>
        A Johnson counter is a modified ring counter where the complement 
        of the output of the last flip-flop is connected to the input of 
        the first flip-flop, producing a different sequence.
    `;
    
    // Initialize johnson counter
    initializeJohnsonCounter();
    
    // Show results area
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card">
            <h5 class="text-center">Johnson Counter Operation</h5>
            <p class="text-center">Configure the counter and click Calculate</p>
        </div>
    `;
}

function initializeJohnsonCounter() {
    const bits = parseInt(document.getElementById('johnson-counter-bits').value);
    const initialType = document.getElementById('johnson-counter-initial').value;
    
    let initialState;
    if (initialType === 'custom') {
        const pattern = document.getElementById('johnson-counter-pattern').value;
        if (pattern && /^[01]+$/.test(pattern)) {
            initialState = pattern.split('').map(Number);
            if (initialState.length !== bits) {
                initialState = initialState.concat(new Array(bits - initialState.length).fill(0));
            }
        } else {
            initialState = new Array(bits).fill(0);
        }
    } else if (initialType === 'all-ones') {
        initialState = new Array(bits).fill(1);
    } else {
        // all-zeros
        initialState = new Array(bits).fill(0);
    }
    
    currentJohnsonCounter = new JohnsonCounter(bits, initialState);
    
    // Update current result display
    document.getElementById('sequential2-result').textContent = currentJohnsonCounter.getStateString();
    document.getElementById('sequential2-next-result').textContent = '-';
    
    // Create realistic circuit diagram
    createJohnsonCounterCircuit(bits);
}

function calculateJohnsonCounterNextState() {
    if (!currentJohnsonCounter) return;
    
    const direction = document.getElementById('johnson-counter-direction').value;
    currentJohnsonCounter.shift(direction);
    
    // Update displays
    document.getElementById('sequential2-result').textContent = currentJohnsonCounter.getStateString();
    document.getElementById('sequential2-next-result').textContent = '-';
    
    // Show step-by-step analysis
    const history = currentJohnsonCounter.getHistory();
    const lastStep = history[history.length - 1];
    
    const analysisHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Step ${lastStep.step}: ${lastStep.description}</div>
            <div class="calculation-content">
                Current State: <span class="highlight-equation">${lastStep.stateString}</span><br>
                Decimal Value: <span class="highlight-equation">${lastStep.decimal}</span><br>
                Shift Direction: <span class="highlight-equation">${direction}</span><br>
                Complemented Feedback: <span class="highlight-equation">${1 - lastStep.state[lastStep.state.length - 1]}</span>
            </div>
        </div>
    `;
    
    document.getElementById('sequential2-analysis').style.display = 'block';
    document.getElementById('sequential2-analysis-title').textContent = 'Johnson Counter Operation';
    document.getElementById('sequential2-steps-container').innerHTML = analysisHTML;
    
    // Update circuit visualization
    updateJohnsonCounterCircuit(currentJohnsonCounter.state);
}

function simulateJohnsonCounterSequence() {
    if (!currentJohnsonCounter) return;
    
    const direction = document.getElementById('johnson-counter-direction').value;
    const bits = currentJohnsonCounter.bits;
    const sequence = currentJohnsonCounter.simulateSequence(2 * bits, direction);
    
    let sequenceHTML = `
        <div class="glass-card">
            <h5 class="text-center">Johnson Counter Full Sequence (${2 * bits} States)</h5>
            <div class="counter-states">
    `;
    
    sequence.forEach((state, index) => {
        const stateString = state.join('');
        sequenceHTML += `
            <div class="counter-state">
                <div class="state-header">Clock ${index}</div>
                <div class="state-bits">
                    ${state.map((bit, i) => `
                        <span class="counter-bit ${bit === 1 ? 'bit-1' : 'bit-0'}">
                            ${bit}
                            <div class="bit-index">Q${i}</div>
                        </span>
                    `).join('')}
                </div>
                <div class="state-decimal">Decimal: ${parseInt(stateString, 2)}</div>
            </div>
        `;
    });
    
    sequenceHTML += `
            </div>
        </div>
    `;
    
    document.getElementById('sequential2-results').innerHTML = sequenceHTML;
    
    // Show analysis
    const analysisHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Complete Johnson Counter Sequence</div>
            <div class="calculation-content">
                Total States: <span class="highlight-equation">${2 * bits}</span><br>
                Shift Direction: <span class="highlight-equation">${direction}</span><br>
                Sequence Length: <span class="highlight-equation">${2 * bits} clock cycles</span><br>
                <br>
                <strong>Sequence Pattern:</strong><br>
                ${sequence.map((state, i) => 
                    `Clock ${i}: ${state.join('')} (Decimal: ${parseInt(state.join(''), 2)})`
                ).slice(0, 8).join('<br>')}
                <br>... (${sequence.length - 8} more states)
            </div>
        </div>
    `;
    
    document.getElementById('sequential2-analysis').style.display = 'block';
    document.getElementById('sequential2-analysis-title').textContent = 'Johnson Counter Sequence Analysis';
    document.getElementById('sequential2-steps-container').innerHTML = analysisHTML;
}

function showJohnsonCounterTruthTable() {
    if (!currentJohnsonCounter) return;
    
    const truthTable = currentJohnsonCounter.getTruthTable();
    const bits = currentJohnsonCounter.bits;
    
    let tableHTML = `
        <div class="glass-card">
            <h5 class="text-center">Johnson Counter Truth Table</h5>
            <table class="truth-table">
                <tr>
                    <th>Clock</th>
    `;
    
    // Add column headers
    for (let i = 0; i < bits; i++) {
        tableHTML += `<th>Q${i}</th>`;
    }
    
    tableHTML += `<th>Decimal</th></tr>`;
    
    // Add rows (show first 16 states or all if less)
    const maxRows = Math.min(16, truthTable.length);
    for (let i = 0; i < maxRows; i++) {
        const row = truthTable[i];
        tableHTML += `<tr><td>${row.clock}</td>`;
        
        row.state.forEach(bit => {
            tableHTML += `<td class="${bit === 1 ? 'active' : 'inactive'}">${bit}</td>`;
        });
        
        tableHTML += `<td>${row.decimal}</td></tr>`;
    }
    
    if (truthTable.length > maxRows) {
        tableHTML += `<tr><td colspan="${bits + 2}" class="text-center">... ${truthTable.length - maxRows} more states</td></tr>`;
    }
    
    tableHTML += `</table></div>`;
    
    document.getElementById('sequential2-results').innerHTML = tableHTML;
    
    // Show analysis
    const analysisHTML = `
        <div class="sequential-step active">
            <div class="calculation-title">Johnson Counter Truth Table Analysis</div>
            <div class="calculation-content">
                <strong>Characteristics:</strong><br>
                 Number of unique states: ${2 * bits}<br>
                 Complemented feedback<br>
                 Twisted ring structure<br>
                 Generates walking patterns<br>
                 More complex decoding<br>
                <br>
                <strong>Truth Table Notes:</strong><br>
                 Each clock pulse shifts bits and complements feedback<br>
                 After ${2 * bits} clocks, returns to initial state<br>
                 Generates ${2 * bits} unique states<br>
                 Useful for sequence generation
            </div>
        </div>
    `;
    
    document.getElementById('sequential2-analysis').style.display = 'block';
    document.getElementById('sequential2-analysis-title').textContent = 'Truth Table Analysis';
    document.getElementById('sequential2-steps-container').innerHTML = analysisHTML;
}

function resetJohnsonCounter() {
    initializeJohnsonCounter();
    
    // Reset results display
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card">
            <h5 class="text-center">Johnson Counter Operation</h5>
            <p class="text-center">Counter has been reset to initial state</p>
            <p class="text-center">Current State: ${currentJohnsonCounter.getStateString()}</p>
        </div>
    `;
    
    // Show reset message
    showNotification('Johnson counter has been reset to initial state', 'success');
}

function closeJohnsonCounterInterface() {
    document.getElementById('johnson-counter-inputs').style.display = 'none';
    document.getElementById('sequential2-results').innerHTML = '';
    document.getElementById('sequential2-analysis').style.display = 'none';
    document.getElementById('sequential2-circuit-container').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-share-alt fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <p class="mt-2">Select a sequential component to visualize its circuit</p>
        </div>
    `;
    
    showNotification('Johnson counter interface closed successfully', 'info');
}

// Helper Functions
function hideAllCounterInputs() {
    const allInputs = [
        'ring-counter-inputs',
        'johnson-counter-inputs',
        't-flipflop-inputs',
        'register-storage-inputs',
        'shift-register-inputs',
        'master-slave-inputs',
        'setup-time-inputs',
        'hold-time-inputs',
        'clock-skew-inputs',
        'async-reset-inputs',
        'synchronous-reset-inputs',
        'parallel-load-inputs'
    ];
    
    allInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'none';
    });
}

function createRingCounterCircuit(bits) {
    const container = document.getElementById('sequential2-circuit-container');
    
    // Create realistic circuit diagram
    container.innerHTML = `
        <div class="realistic-circuit-container">
            <div class="circuit-board"></div>
            
            <!-- D Flip-Flops -->
            ${Array.from({length: bits}, (_, i) => `
                <div class="d-flipflop-real" style="left: ${150 + i * 120}px; top: 150px;">
                    <div class="ic-label">D-FF ${i}</div>
                    <div class="ic-pin" style="left: -12px; top: 20px;" title="Clock"></div>
                    <div class="ic-pin" style="left: -12px; top: 40px;" title="Data In"></div>
                    <div class="ic-pin" style="right: -12px; top: 20px;" title="Q${i}"></div>
                    <div class="ic-pin" style="right: -12px; top: 40px;" title="Q${i}"></div>
                </div>
            `).join('')}
            
            <!-- Clock Signal -->
            <div class="clock-symbol-real" style="left: 100px; top: 170px;">
                CLK
            </div>
            
            <!-- Feedback Connection -->
            <div class="circuit-connection" id="feedback-connection" 
                 style="left: ${150 + bits * 120 - 60}px; top: 180px; width: ${60 + (bits - 1) * 120}px; height: 4px;"></div>
            
            <!-- Input/Output Labels -->
            <div class="circuit-label-real" style="left: 80px; top: 200px;">Clock</div>
            ${Array.from({length: bits}, (_, i) => `
                <div class="circuit-label-real" style="left: ${150 + i * 120 + 40}px; top: 100px;">Q${i}</div>
            `).join('')}
            
            <!-- Circular Arrow -->
            <div class="shift-arrow-real" style="left: ${150 + bits * 120 - 30}px; top: 220px; transform: rotate(180deg);">
                
            </div>
            
            <!-- Connection Lines -->
            ${Array.from({length: bits - 1}, (_, i) => `
                <div class="circuit-connection" style="left: ${150 + i * 120 + 80}px; top: 180px; width: 40px; height: 4px;"></div>
            `).join('')}
            
            <!-- Clock Distribution -->
            <div class="control-line" style="left: 120px; top: 180px; width: ${30 + (bits - 1) * 120}px; height: 4px;"></div>
            
            <!-- Title -->
            <div class="circuit-label-real" style="left: 50%; top: 50px; transform: translateX(-50%); font-size: 1.2rem;">
                ${bits}-BIT RING COUNTER CIRCUIT
            </div>
        </div>
    `;
}

function updateRingCounterCircuit(state) {
    // Update the circuit visualization based on current state
    const bits = state.length;
    
    // Find the position of the '1' (active flip-flop)
    const activeIndex = state.indexOf(1);
    
    // Update connection colors
    const feedbackConnection = document.getElementById('feedback-connection');
    if (feedbackConnection) {
        feedbackConnection.classList.toggle('active', activeIndex === bits - 1);
    }
    
    // Update individual flip-flops
    for (let i = 0; i < bits; i++) {
        const ff = document.querySelector(`.d-flipflop-real:nth-child(${i + 1})`);
        if (ff) {
            ff.classList.toggle('active', state[i] === 1);
            
            // Update the IC label to show current state
            const label = ff.querySelector('.ic-label');
            if (label) {
                label.textContent = `D-FF ${i}: Q=${state[i]}`;
            }
        }
    }
}

function createJohnsonCounterCircuit(bits) {
    const container = document.getElementById('sequential2-circuit-container');
    
    // Create realistic circuit diagram with NOT gate for complemented feedback
    container.innerHTML = `
        <div class="realistic-circuit-container">
            <div class="circuit-board"></div>
            
            <!-- D Flip-Flops -->
            ${Array.from({length: bits}, (_, i) => `
                <div class="d-flipflop-real" style="left: ${150 + i * 120}px; top: 150px;">
                    <div class="ic-label">D-FF ${i}</div>
                    <div class="ic-pin" style="left: -12px; top: 20px;" title="Clock"></div>
                    <div class="ic-pin" style="left: -12px; top: 40px;" title="Data In"></div>
                    <div class="ic-pin" style="right: -12px; top: 20px;" title="Q${i}"></div>
                    <div class="ic-pin" style="right: -12px; top: 40px;" title="Q${i}"></div>
                </div>
            `).join('')}
            
            <!-- NOT Gate for Complemented Feedback -->
            <div class="gate-symbol-real" style="left: ${150 + bits * 120 - 30}px; top: 250px;">
                NOT
            </div>
            
            <!-- Clock Signal -->
            <div class="clock-symbol-real" style="left: 100px; top: 170px;">
                CLK
            </div>
            
            <!-- Feedback Path -->
            <div class="circuit-connection" id="feedback-line" 
                 style="left: ${150 + bits * 120 - 60}px; top: 180px; width: 60px; height: 4px;"></div>
            
            <div class="circuit-connection" 
                 style="left: ${150 + bits * 120 - 30}px; top: 180px; width: 4px; height: 70px;"></div>
            
            <div class="circuit-connection" 
                 style="left: ${150 + bits * 120 - 60}px; top: 250px; width: 60px; height: 4px;"></div>
            
            <!-- Input/Output Labels -->
            <div class="circuit-label-real" style="left: 80px; top: 200px;">Clock</div>
            ${Array.from({length: bits}, (_, i) => `
                <div class="circuit-label-real" style="left: ${150 + i * 120 + 40}px; top: 100px;">Q${i}</div>
            `).join('')}
            
            <!-- NOT Gate Label -->
            <div class="circuit-label-real" style="left: ${150 + bits * 120 - 40}px; top: 280px;">
                Complement
            </div>
            
            <!-- Connection Lines between Flip-Flops -->
            ${Array.from({length: bits - 1}, (_, i) => `
                <div class="circuit-connection" style="left: ${150 + i * 120 + 80}px; top: 180px; width: 40px; height: 4px;"></div>
            `).join('')}
            
            <!-- Clock Distribution -->
            <div class="control-line" style="left: 120px; top: 180px; width: ${30 + (bits - 1) * 120}px; height: 4px;"></div>
            
            <!-- Title -->
            <div class="circuit-label-real" style="left: 50%; top: 50px; transform: translateX(-50%); font-size: 1.2rem;">
                ${bits}-BIT JOHNSON COUNTER CIRCUIT
            </div>
            
            <!-- Legend -->
            <div class="circuit-label-real" style="left: 50px; top: 320px; font-size: 0.8rem;">
                <div>Red: Clock Signal</div>
                <div>Brown: Data Path</div>
                <div>Green: Active Signal</div>
            </div>
        </div>
    `;
}

function updateJohnsonCounterCircuit(state) {
    // Update the circuit visualization based on current state
    const bits = state.length;
    
    // Update individual flip-flops
    for (let i = 0; i < bits; i++) {
        const ff = document.querySelector(`.d-flipflop-real:nth-child(${i + 1})`);
        if (ff) {
            ff.classList.toggle('active', state[i] === 1);
            
            // Update the IC label to show current state
            const label = ff.querySelector('.ic-label');
            if (label) {
                label.textContent = `D-FF ${i}: Q=${state[i]}`;
            }
        }
    }
    
    // Update NOT gate based on last bit complement
    const notGate = document.querySelector('.gate-symbol-real');
    if (notGate) {
        const lastBit = state[bits - 1];
        const complement = 1 - lastBit;
        notGate.innerHTML = `NOT<br>${lastBit}${complement}`;
        notGate.classList.toggle('active', complement === 1);
    }
    
    // Update feedback line
    const feedbackLine = document.getElementById('feedback-line');
    if (feedbackLine) {
        const lastBit = state[bits - 1];
        feedbackLine.classList.toggle('active', lastBit === 1);
    }
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                            type === 'error' ? 'exclamation-circle' : 
                            type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Add to body
    document.body.appendChild(notification);
    
    // Add styles if not already present
    if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .notification.success {
                background: linear-gradient(45deg, var(--success-color), var(--success-dark));
                border-left: 4px solid var(--success-dark);
            }
            
            .notification.error {
                background: linear-gradient(45deg, var(--danger-color), #b71c1c);
                border-left: 4px solid #b71c1c;
            }
            
            .notification.warning {
                background: linear-gradient(45deg, var(--warning-color), #ff6f00);
                border-left: 4px solid #ff6f00;
            }
            
            .notification.info {
                background: linear-gradient(45deg, var(--info-color), #1565c0);
                border-left: 4px solid #1565c0;
            }
            
            .notification-content {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .notification i {
                font-size: 1.2rem;
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add slideOut animation
const existingStyle = document.getElementById('notification-styles');
if (existingStyle) {
    existingStyle.textContent += `
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
}

// Add CSS for counter states
const counterCSS = `
    .counter-states {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin: 20px 0;
    }
    
    .counter-state {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 15px;
        border: 2px solid var(--primary-color);
        min-width: 120px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .counter-state:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(139, 69, 19, 0.2);
    }
    
    .state-header {
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    
    .state-bits {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-bottom: 10px;
    }
    
    .counter-bit {
        width: 35px;
        height: 35px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 5px;
        font-weight: bold;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .bit-1 {
        background: var(--success-color);
        color: white;
        box-shadow: 0 2px 5px rgba(34, 139, 34, 0.3);
    }
    
    .bit-0 {
        background: var(--success-dark);
        color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .bit-index {
        font-size: 0.7rem;
        margin-top: 2px;
        opacity: 0.8;
    }
    
    .state-decimal {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
    }
`;

// Add counter CSS to the page
if (!document.getElementById('counter-css')) {
    const style = document.createElement('style');
    style.id = 'counter-css';
    style.textContent = counterCSS;
    document.head.appendChild(style);
}

class ParallelLoadRegister {
    constructor(width = 8, initialValue = 0) {
        this.width = width;
        this.value = initialValue & ((1 << width) - 1);
        this.maxValue = (1 << width) - 1;
        this.loadEnable = false;
        this.history = [];
        this.step = 0;
    }

    setLoadEnable(enable) {
        this.loadEnable = enable;
        return {
            enabled: enable,
            message: `Load Enable set to ${enable ? 'HIGH (ON)' : 'LOW (OFF)'}`
        };
    }

    clockEdge(parallelData) {
        const oldValue = this.value;
        let operation = '';
        let result = false;
        let message = '';

        if (this.loadEnable) {
            // Load parallel data on clock edge
            const maskedData = parallelData & this.maxValue;
            this.value = maskedData;
            operation = 'PARALLEL LOAD';
            result = true;
            message = `Clock edge: ${operation} ${this.toBinaryString(maskedData)}  Register = ${this.toBinaryString(this.value)} (${this.value})`;
        } else {
            // Maintain current value
            operation = 'NO LOAD';
            result = false;
            message = `Clock edge: ${operation} (enable=0)  Register = ${this.toBinaryString(this.value)} (${this.value})`;
        }

        // Record history
        this.history.push({
            step: ++this.step,
            oldValue,
            newValue: this.value,
            loadEnable: this.loadEnable,
            parallelData,
            operation,
            message
        });

        return {
            success: result,
            operation,
            oldValue,
            newValue: this.value,
            oldBinary: this.toBinaryString(oldValue),
            newBinary: this.toBinaryString(this.value),
            message
        };
    }

    shiftRight(serialIn = 0) {
        if (!this.loadEnable) {
            const lsb = this.value & 1;
            this.value = (this.value >> 1) | ((serialIn & 1) << (this.width - 1));
            
            this.history.push({
                step: ++this.step,
                operation: 'SHIFT RIGHT',
                serialIn,
                lsbOut: lsb,
                newValue: this.value,
                message: `Shift right: in=${serialIn}  Register = ${this.toBinaryString(this.value)}`
            });
            
            return lsb;
        }
        return null;
    }

    getValue() {
        return this.value;
    }

    toBinaryString(value = this.value) {
        return value.toString(2).padStart(this.width, '0');
    }

    getBitArray(value = this.value) {
        return this.toBinaryString(value).split('');
    }

    reset(initialValue = 0) {
        this.value = initialValue & ((1 << this.width) - 1);
        this.history = [];
        this.step = 0;
        return {
            message: `Register reset to ${this.toBinaryString(this.value)} (${this.value})`
        };
    }

    getHistory() {
        return this.history;
    }

    toString() {
        return `Register[${this.width} bits]: ${this.toBinaryString()} (${this.value})`;
    }
}

// Global Parallel Load Register instance
let parallelRegister = new ParallelLoadRegister(8, 51);

// Update binary displays
function updateParallelBinaryDisplays() {
    const width = parseInt(document.getElementById('parallel-reg-width').value);
    const initialValue = parseInt(document.getElementById('parallel-reg-initial').value) || 0;
    const dataValue = parseInt(document.getElementById('parallel-reg-data').value) || 0;
    
    // Update binary displays
    document.getElementById('parallel-reg-initial-binary').textContent = 
        initialValue.toString(2).padStart(width, '0');
    document.getElementById('parallel-reg-data-binary').textContent = 
        dataValue.toString(2).padStart(width, '0');
    
    // Update current register display
    const currentBinary = parallelRegister.toBinaryString();
    const currentDecimal = parallelRegister.getValue();
    document.getElementById('parallel-reg-current').value = 
        `${currentBinary} (${currentDecimal})`;
    
    // Update bit display
    const bits = parallelRegister.getBitArray();
    document.getElementById('parallel-reg-bits').innerHTML = 
        'Bit: ' + bits.map(bit => `<span class="${bit === '1' ? 'bit-1' : 'bit-0'}">${bit}</span>`).join(' ');
}

// Event Listeners for Parallel Load Register
document.addEventListener('DOMContentLoaded', function() {
    // Show Parallel Load inputs
    document.getElementById('parallel-load-btn')?.addEventListener('click', function() {
        showInputSection('parallel-load-inputs');
        updateParallelBinaryDisplays();
        
        // Reset register
        const width = parseInt(document.getElementById('parallel-reg-width').value);
        const initialValue = parseInt(document.getElementById('parallel-reg-initial').value) || 0;
        parallelRegister = new ParallelLoadRegister(width, initialValue);
        
        // Show results area
        document.getElementById('sequential2-results').style.display = 'block';
        document.getElementById('sequential2-analysis').style.display = 'block';
        document.getElementById('sequential2-analysis-title').textContent = 'Parallel Load Register Operation';
        
        // Clear previous steps
        const stepsContainer = document.getElementById('sequential2-steps-container');
        stepsContainer.innerHTML = '';
        
        // Add initial step
        const initialStep = document.createElement('div');
        initialStep.className = 'sequential-step active';
        initialStep.innerHTML = `
            <div class="calculation-title">Initial State</div>
            <div class="calculation-content">
                Register initialized with: ${parallelRegister.toBinaryString()} (${parallelRegister.getValue()})<br>
                Width: ${parallelRegister.width} bits<br>
                Load Enable: ${parallelRegister.loadEnable ? 'HIGH' : 'LOW'}
            </div>
        `;
        stepsContainer.appendChild(initialStep);
    });
    
    // Close button
    document.getElementById('close-parallel-btn')?.addEventListener('click', function() {
        document.getElementById('parallel-load-inputs').style.display = 'none';
        document.getElementById('sequential2-analysis').style.display = 'none';
        document.getElementById('sequential2-results').innerHTML = '';
    });
    
    // Width change
    document.getElementById('parallel-reg-width')?.addEventListener('change', function() {
        const width = parseInt(this.value);
        parallelRegister = new ParallelLoadRegister(width, 0);
        updateParallelBinaryDisplays();
        
        // Update input max values
        const maxValue = (1 << width) - 1;
        document.getElementById('parallel-reg-initial').max = maxValue;
        document.getElementById('parallel-reg-data').max = maxValue;
    });
    
    // Initial value change
    document.getElementById('parallel-reg-initial')?.addEventListener('input', updateParallelBinaryDisplays);
    
    // Data value change
    document.getElementById('parallel-reg-data')?.addEventListener('input', updateParallelBinaryDisplays);
    
    // Load enable toggle
    document.getElementById('parallel-reg-load-enable')?.addEventListener('change', function() {
        const enabled = this.checked;
        const result = parallelRegister.setLoadEnable(enabled);
        
        document.getElementById('parallel-load-status').textContent = enabled ? 'ON' : 'OFF';
        document.getElementById('parallel-load-status').className = 
            enabled ? 'badge bg-success' : 'badge bg-danger';
        
        // Add step to history
        const stepsContainer = document.getElementById('sequential2-steps-container');
        const stepDiv = document.createElement('div');
        stepDiv.className = 'sequential-step active';
        stepDiv.innerHTML = `
            <div class="calculation-title">Load Enable Changed</div>
            <div class="calculation-content">
                ${result.message}
            </div>
        `;
        stepsContainer.appendChild(stepDiv);
        stepDiv.scrollIntoView({ behavior: 'smooth' });
    });
    
    // Clock toggle
    document.getElementById('parallel-reg-clock')?.addEventListener('change', function() {
        const clockOn = this.checked;
        document.getElementById('parallel-clock-status').textContent = clockOn ? 'RISING EDGE' : 'OFF';
        document.getElementById('parallel-clock-status').className = 
            clockOn ? 'badge bg-warning' : 'badge bg-secondary';
        
        if (clockOn) {
            // Simulate clock edge
            const dataValue = parseInt(document.getElementById('parallel-reg-data').value) || 0;
            const result = parallelRegister.clockEdge(dataValue);
            
            // Update display
            updateParallelBinaryDisplays();
            
            // Add step to history
            const stepsContainer = document.getElementById('sequential2-steps-container');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'sequential-step active';
            stepDiv.innerHTML = `
                <div class="calculation-title">${result.operation}</div>
                <div class="calculation-content">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Previous: ${result.oldBinary} (${result.oldValue})</span>
                        <span class="sequential-state state-0"></span>
                        <span>New: ${result.newBinary} (${result.newValue})</span>
                    </div>
                    <div>Load Enable: ${parallelRegister.loadEnable ? 'HIGH' : 'LOW'}</div>
                    <div>Parallel Data: ${dataValue.toString(2).padStart(parallelRegister.width, '0')} (${dataValue})</div>
                    <div class="mt-2 text-success">${result.message}</div>
                </div>
            `;
            stepsContainer.appendChild(stepDiv);
            stepDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Auto-reset clock after 500ms
        setTimeout(() => {
            this.checked = false;
            document.getElementById('parallel-clock-status').textContent = 'OFF';
            document.getElementById('parallel-clock-status').className = 'badge bg-secondary';
        }, 500);
    });
    
    // Calculate button
    document.getElementById('calculate-parallel-btn')?.addEventListener('click', function() {
        document.getElementById('parallel-reg-clock').checked = true;
        document.getElementById('parallel-reg-clock').dispatchEvent(new Event('change'));
    });
    
    // Reset button
    document.getElementById('reset-parallel-reg-btn')?.addEventListener('click', function() {
        const width = parseInt(document.getElementById('parallel-reg-width').value);
        const initialValue = parseInt(document.getElementById('parallel-reg-initial').value) || 0;
        
        parallelRegister = new ParallelLoadRegister(width, initialValue);
        
        // Reset UI elements
        document.getElementById('parallel-reg-load-enable').checked = false;
        document.getElementById('parallel-load-status').textContent = 'OFF';
        document.getElementById('parallel-load-status').className = 'badge bg-danger';
        
        document.getElementById('parallel-reg-clock').checked = false;
        document.getElementById('parallel-clock-status').textContent = 'OFF';
        document.getElementById('parallel-clock-status').className = 'badge bg-secondary';
        
        updateParallelBinaryDisplays();
        
        // Clear and reset steps
        const stepsContainer = document.getElementById('sequential2-steps-container');
        stepsContainer.innerHTML = '';
        
        const initialStep = document.createElement('div');
        initialStep.className = 'sequential-step active';
        initialStep.innerHTML = `
            <div class="calculation-title">Register Reset</div>
            <div class="calculation-content">
                Register reset to initial state: ${parallelRegister.toBinaryString()} (${parallelRegister.getValue()})
            </div>
        `;
        stepsContainer.appendChild(initialStep);
    });
    
    // Run Full Demo button
    document.getElementById('run-parallel-demo-btn')?.addEventListener('click', function() {
        const stepsContainer = document.getElementById('sequential2-steps-container');
        
        // Clear previous steps
        stepsContainer.innerHTML = '';
        
        // Add demo header
        const headerDiv = document.createElement('div');
        headerDiv.className = 'sequential-step active';
        headerDiv.innerHTML = `
            <div class="calculation-title">Parallel Load Register Demonstration</div>
            <div class="calculation-content">
                Running full demonstration sequence...
            </div>
        `;
        stepsContainer.appendChild(headerDiv);
        
        // Reset register
        parallelRegister = new ParallelLoadRegister(8, 0b00110011);
        updateParallelBinaryDisplays();
        
        // Run demo steps with delays
        const demoSteps = [
            { delay: 1000, action: () => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequential-step active';
                stepDiv.innerHTML = `
                    <div class="calculation-title">Initial State</div>
                    <div class="calculation-content">
                        Register initialized with: 00110011 (51)<br>
                        Width: 8 bits
                    </div>
                `;
                stepsContainer.appendChild(stepDiv);
                stepDiv.scrollIntoView({ behavior: 'smooth' });
            }},
            
            { delay: 1500, action: () => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequential-step active';
                stepDiv.innerHTML = `
                    <div class="calculation-title">Test 1: Try load without enable</div>
                    <div class="calculation-content">
                        Load Enable: LOW (OFF)<br>
                        Attempting to load: 11110000 (240)<br>
                        Result: No load operation (enable=0)
                    </div>
                `;
                stepsContainer.appendChild(stepDiv);
                parallelRegister.setLoadEnable(false);
                parallelRegister.clockEdge(0b11110000);
                updateParallelBinaryDisplays();
                stepDiv.scrollIntoView({ behavior: 'smooth' });
            }},
            
            { delay: 1500, action: () => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequential-step active';
                stepDiv.innerHTML = `
                    <div class="calculation-title">Test 2: Enable and load new value</div>
                    <div class="calculation-content">
                        Load Enable: HIGH (ON)<br>
                        Loading: 10101010 (170)<br>
                        Result: Successful parallel load
                    </div>
                `;
                stepsContainer.appendChild(stepDiv);
                parallelRegister.setLoadEnable(true);
                parallelRegister.clockEdge(0b10101010);
                updateParallelBinaryDisplays();
                stepDiv.scrollIntoView({ behavior: 'smooth' });
            }},
            
            { delay: 1500, action: () => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequential-step active';
                stepDiv.innerHTML = `
                    <div class="calculation-title">Test 3: Load another value</div>
                    <div class="calculation-content">
                        Load Enable: HIGH (ON)<br>
                        Loading: 11001100 (204)<br>
                        Result: Successful parallel load
                    </div>
                `;
                stepsContainer.appendChild(stepDiv);
                parallelRegister.clockEdge(0b11001100);
                updateParallelBinaryDisplays();
                stepDiv.scrollIntoView({ behavior: 'smooth' });
            }},
            
            { delay: 1500, action: () => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequential-step active';
                stepDiv.innerHTML = `
                    <div class="calculation-title">Test 4: Disable and try to load</div>
                    <div class="calculation-content">
                        Load Enable: LOW (OFF)<br>
                        Attempting to load: 11111111 (255)<br>
                        Result: No load operation (enable=0)
                    </div>
                `;
                stepsContainer.appendChild(stepDiv);
                parallelRegister.setLoadEnable(false);
                parallelRegister.clockEdge(0b11111111);
                updateParallelBinaryDisplays();
                stepDiv.scrollIntoView({ behavior: 'smooth' });
            }},
            
            { delay: 1500, action: () => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequential-step active';
                stepDiv.innerHTML = `
                    <div class="calculation-title">Test 5: Re-enable and load final value</div>
                    <div class="calculation-content">
                        Load Enable: HIGH (ON)<br>
                        Loading: 01010101 (85)<br>
                        Result: Successful parallel load
                    </div>
                `;
                stepsContainer.appendChild(stepDiv);
                parallelRegister.setLoadEnable(true);
                parallelRegister.clockEdge(0b01010101);
                updateParallelBinaryDisplays();
                stepDiv.scrollIntoView({ behavior: 'smooth' });
            }},
            
            { delay: 1000, action: () => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequential-step active';
                stepDiv.innerHTML = `
                    <div class="calculation-title">Final State</div>
                    <div class="calculation-content">
                        <strong>Final Register Value:</strong> ${parallelRegister.toBinaryString()} (${parallelRegister.getValue()})<br>
                        <strong>Operations Performed:</strong> 6<br>
                        <strong>Successful Loads:</strong> 3
                    </div>
                `;
                stepsContainer.appendChild(stepDiv);
                stepDiv.scrollIntoView({ behavior: 'smooth' });
            }}
        ];
        
        // Execute demo steps with delays
        let currentDelay = 0;
        demoSteps.forEach((step, index) => {
            setTimeout(() => {
                step.action();
            }, currentDelay);
            currentDelay += step.delay;
        });
    });
    
    // Step Through Demo button
    document.getElementById('step-parallel-demo-btn')?.addEventListener('click', function() {
        let step = 1;
        
        function showStep(stepNumber) {
            const steps = [
                `Step ${stepNumber}: Initial State - Register = 00110011 (51)`,
                `Step ${stepNumber}: Load Enable = OFF, Try load 11110000 (no effect)`,
                `Step ${stepNumber}: Load Enable = ON, Load 10101010 (successful)`,
                `Step ${stepNumber}: Load Enable = ON, Load 11001100 (successful)`,
                `Step ${stepNumber}: Load Enable = OFF, Try load 11111111 (no effect)`,
                `Step ${stepNumber}: Load Enable = ON, Load 01010101 (successful)`,
                `Step ${stepNumber}: Final State - Register = 01010101 (85)`
            ];
            
            alert(steps[stepNumber - 1]);
            
            if (stepNumber === 1) {
                parallelRegister = new ParallelLoadRegister(8, 0b00110011);
            } else if (stepNumber === 2) {
                parallelRegister.setLoadEnable(false);
                parallelRegister.clockEdge(0b11110000);
            } else if (stepNumber === 3) {
                parallelRegister.setLoadEnable(true);
                parallelRegister.clockEdge(0b10101010);
            } else if (stepNumber === 4) {
                parallelRegister.clockEdge(0b11001100);
            } else if (stepNumber === 5) {
                parallelRegister.setLoadEnable(false);
                parallelRegister.clockEdge(0b11111111);
            } else if (stepNumber === 6) {
                parallelRegister.setLoadEnable(true);
                parallelRegister.clockEdge(0b01010101);
            }
            
            updateParallelBinaryDisplays();
        }
        
        showStep(step);
        
        // You could implement a more sophisticated step-by-step interface here
        // For now, we'll just show the first step
    });
});

// Helper function to show input sections
function showInputSection(sectionId) {
    // Hide all input sections
    const sections = [
        't-flipflop-inputs',
        'register-storage-inputs',
        'shift-register-inputs',
        'master-slave-inputs',
        'setup-time-inputs',
        'hold-time-inputs',
        'clock-skew-inputs',
        'async-reset-inputs',
        'synchronous-reset-inputs',
        'parallel-load-inputs'
    ];
    
    sections.forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    
    // Show requested section
    document.getElementById(sectionId).style.display = 'block';
}
// Synchronous Register Class
class SynchronousRegister {
    constructor(width = 8, initialValue = 0) {
        this.width = width;
        this.maxValue = (1 << width) - 1;
        this.value = initialValue & this.maxValue;
        this.history = [];
        this.step = 0;
    }
    
    clockEdge(dataIn, reset, enable = true) {
        const prevValue = this.value;
        let operation = "No Change";
        
        if (reset) {
            // Synchronous reset
            this.value = 0;
            operation = "RESET  0";
        } else if (enable) {
            // Normal data load
            const maskedData = dataIn & this.maxValue;
            if (this.value !== maskedData) {
                this.value = maskedData;
                operation = `Load ${maskedData}`;
            }
        } else {
            operation = "Disabled";
        }
        
        // Record this step
        this.history.push({
            step: this.step + 1,
            dataIn,
            reset: reset ? 1 : 0,
            enable: enable ? 1 : 0,
            prevValue,
            newValue: this.value,
            operation
        });
        
        this.step++;
        return operation;
    }
    
    getValue() {
        return this.value;
    }
    
    getBinaryString() {
        return this.value.toString(2).padStart(this.width, '0');
    }
    
    getHistory() {
        return this.history;
    }
    
    resetRegister() {
        this.value = 0;
        this.history = [];
        this.step = 0;
    }
    
    toString() {
        return `${this.getBinaryString()} (${this.value})`;
    }
}

// Global register instance
let syncRegister = null;
let currentDemoStep = 0;
const demoSequence = [
    { data: 10, reset: 0, enable: 1, desc: "Load 10 (1010)" },
    { data: 7, reset: 0, enable: 1, desc: "Load 7 (0111)" },
    { data: 3, reset: 1, enable: 1, desc: "Reset while trying to load 3" },
    { data: 8, reset: 0, enable: 0, desc: "Try load 8 with enable=0" },
    { data: 12, reset: 0, enable: 1, desc: "Load 12 (1100)" },
    { data: 9, reset: 1, enable: 1, desc: "Reset while trying to load 9" },
    { data: 15, reset: 0, enable: 1, desc: "Load 15 (1111)" }
];
// Initialize Synchronous Register
function initSynchronousRegister() {
    const width = parseInt(document.getElementById('sync-reg-width').value);
    const initialValue = parseInt(document.getElementById('sync-reg-initial').value);
    
    syncRegister = new SynchronousRegister(width, initialValue);
    updateSyncRegisterDisplay();
    
    // Show success message
    showSyncMessage(`Initialized ${width}-bit register with value ${syncRegister.toString()}`, 'success');
}

// Update register display
function updateSyncRegisterDisplay() {
    if (!syncRegister) return;
    
    const currentValue = document.getElementById('sync-reg-current');
    currentValue.value = `${syncRegister.getBinaryString()} (${syncRegister.getValue()})`;
    
    // Update results display
    const resultsDiv = document.getElementById('sequential2-results');
    if (resultsDiv) {
        resultsDiv.innerHTML = `
            <div class="glass-card">
                <h5 class="text-center mb-3">Synchronous Reset Register</h5>
                <div class="text-center">
                    <div class="display-4 mb-3" style="color: var(--primary-color);">
                        ${syncRegister.getBinaryString()}
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-value">${syncRegister.getValue()}</div>
                                <small>Decimal Value</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-value">${syncRegister.width}</div>
                                <small>Bit Width</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Update analysis section
    updateSyncAnalysisDisplay();
}

// Update analysis display
function updateSyncAnalysisDisplay() {
    if (!syncRegister) return;
    
    const analysisDiv = document.getElementById('sequential2-analysis');
    const stepsContainer = document.getElementById('sequential2-steps-container');
    
    if (analysisDiv && stepsContainer) {
        analysisDiv.style.display = 'block';
        document.getElementById('sequential2-analysis-title').textContent = 'Synchronous Reset Operation';
        
        let stepsHTML = '';
        
        // Show current state
        stepsHTML += `
            <div class="sequential-step active">
                <div class="calculation-title">Current Register State</div>
                <div class="calculation-content">
                    <strong>Binary:</strong> ${syncRegister.getBinaryString()}<br>
                    <strong>Decimal:</strong> ${syncRegister.getValue()}<br>
                    <strong>Bit Width:</strong> ${syncRegister.width} bits
                </div>
            </div>
        `;
        
        // Show operation history
        if (syncRegister.history.length > 0) {
            stepsHTML += `
                <div class="sequential-step">
                    <div class="calculation-title">Operation History</div>
                    <div class="calculation-content">
            `;
            
            syncRegister.history.forEach(step => {
                stepsHTML += `
                    <div class="sequential-step ${step.operation.includes('RESET') ? 'active' : ''}">
                        <strong>Step ${step.step}:</strong> ${step.desc || 'Manual Operation'}<br>
                        <strong>Inputs:</strong> Data=${step.dataIn.toString(2).padStart(syncRegister.width, '0')}, 
                        Reset=${step.reset}, Enable=${step.enable}<br>
                        <strong>Operation:</strong> <span class="state-transition">${step.operation}</span><br>
                        <strong>Result:</strong> ${step.prevValue.toString(2).padStart(syncRegister.width, '0')}  
                        ${step.newValue.toString(2).padStart(syncRegister.width, '0')}
                    </div>
                `;
            });
            
            stepsHTML += `</div></div>`;
        }
        
        stepsContainer.innerHTML = stepsHTML;
    }
}

// Show message
function showSyncMessage(message, type = 'info') {
    const resultsDiv = document.getElementById('sequential2-results');
    if (!resultsDiv) return;
    
    const alertClass = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : 'log-info';
    
    resultsDiv.innerHTML += `
        <div class="log-entry ${alertClass}">
            <i class="fas fa-info-circle me-2"></i>${message}
        </div>
    `;
}

// Simulate clock edge
function simulateClockEdge() {
    if (!syncRegister) {
        showSyncMessage('Please initialize the register first', 'error');
        return;
    }
    
    const dataIn = parseInt(document.getElementById('sync-reg-data').value);
    const reset = document.getElementById('sync-reg-reset').checked;
    const enable = document.getElementById('sync-reg-enable').checked;
    
    // Toggle clock for visual feedback
    const clockToggle = document.getElementById('sync-reg-clock');
    clockToggle.checked = !clockToggle.checked;
    
    // Perform clock edge operation
    const operation = syncRegister.clockEdge(dataIn, reset, enable);
    
    // Update display
    updateSyncRegisterDisplay();
    
    // Show operation result
    showSyncMessage(`Clock Edge: ${operation}  Register = ${syncRegister.toString()}`, 'success');
    
    // Reset clock toggle after delay
    setTimeout(() => {
        clockToggle.checked = !clockToggle.checked;
    }, 300);
}

// Run full demo
function runFullDemo() {
    if (!syncRegister) {
        initSynchronousRegister();
    }
    
    syncRegister.resetRegister();
    currentDemoStep = 0;
    
    showSyncMessage("Starting Synchronous Reset Demonstration...", 'info');
    
    // Run demo steps with delay
    function runStep() {
        if (currentDemoStep >= demoSequence.length) {
            showSyncMessage("Demo completed!", 'success');
            return;
        }
        
        const step = demoSequence[currentDemoStep];
        
        // Update UI inputs
        document.getElementById('sync-reg-data').value = step.data;
        document.getElementById('sync-reg-reset').checked = step.reset === 1;
        document.getElementById('sync-reg-enable').checked = step.enable === 1;
        
        // Simulate clock edge
        const operation = syncRegister.clockEdge(step.data, step.reset, step.enable);
        
        // Update display
        updateSyncRegisterDisplay();
        
        // Show step info
        showSyncMessage(`Step ${currentDemoStep + 1}: ${step.desc}  ${operation}`, 
                       step.reset ? 'error' : 'success');
        
        currentDemoStep++;
        
        // Continue to next step after delay
        setTimeout(runStep, 1500);
    }
    
    // Start demo
    setTimeout(runStep, 500);
}

// Step through demo
function stepThroughDemo() {
    if (!syncRegister) {
        initSynchronousRegister();
    }
    
    if (currentDemoStep >= demoSequence.length) {
        showSyncMessage("Demo completed! Reset to start over.", 'info');
        return;
    }
    
    const step = demoSequence[currentDemoStep];
    
    // Update UI inputs
    document.getElementById('sync-reg-data').value = step.data;
    document.getElementById('sync-reg-reset').checked = step.reset === 1;
    document.getElementById('sync-reg-enable').checked = step.enable === 1;
    
    // Simulate clock edge
    const operation = syncRegister.clockEdge(step.data, step.reset, step.enable);
    
    // Update display
    updateSyncRegisterDisplay();
    
    // Show step info
    showSyncMessage(`Step ${currentDemoStep + 1}: ${step.desc}  ${operation}`, 
                   step.reset ? 'error' : 'success');
    
    currentDemoStep++;
}

// Reset register
function resetSynchronousRegister() {
    const width = parseInt(document.getElementById('sync-reg-width').value);
    const initialValue = parseInt(document.getElementById('sync-reg-initial').value);
    
    syncRegister = new SynchronousRegister(width, initialValue);
    currentDemoStep = 0;
    
    updateSyncRegisterDisplay();
    showSyncMessage(`Register reset to initial value: ${syncRegister.toString()}`, 'success');
}

// Close interface
function closeSyncInterface() {
    document.getElementById('synchronous-reset-inputs').style.display = 'none';
    syncRegister = null;
    currentDemoStep = 0;
    
    // Clear results
    const resultsDiv = document.getElementById('sequential2-results');
    if (resultsDiv) resultsDiv.innerHTML = '';
    
    // Hide analysis
    const analysisDiv = document.getElementById('sequential2-analysis');
    if (analysisDiv) analysisDiv.style.display = 'none';
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Synchronous Reset button click
    document.getElementById('synchronous-reset-btn')?.addEventListener('click', function() {
        // Hide other inputs
        document.querySelectorAll('#sequential-circuit2-section .mt-3[id$="-inputs"]').forEach(el => {
            el.style.display = 'none';
        });
        
        // Show synchronous reset inputs
        document.getElementById('synchronous-reset-inputs').style.display = 'block';
        
        // Initialize register
        initSynchronousRegister();
    });
    
    // Calculate/SIMULATE button
    document.getElementById('calculate-sync-reg-btn')?.addEventListener('click', simulateClockEdge);
    
    // Run Full Demo button
    document.getElementById('run-sync-demo-btn')?.addEventListener('click', runFullDemo);
    
    // Step Through Demo button
    document.getElementById('step-sync-demo-btn')?.addEventListener('click', stepThroughDemo);
    
    // Reset Register button
    document.getElementById('reset-sync-reg-btn')?.addEventListener('click', resetSynchronousRegister);
    
    // Close button
    document.getElementById('close-sync-reg-btn')?.addEventListener('click', closeSyncInterface);
    
    // Clock toggle for visual feedback
    document.getElementById('sync-reg-clock')?.addEventListener('change', function() {
        // This is just for visual feedback, actual operation happens in simulateClockEdge
    });
    
    // Update display when width changes
    document.getElementById('sync-reg-width')?.addEventListener('change', function() {
        if (syncRegister) {
            const width = parseInt(this.value);
            const maxValue = (1 << width) - 1;
            
            // Update max values for inputs
            document.getElementById('sync-reg-initial').max = maxValue;
            document.getElementById('sync-reg-data').max = maxValue;
            
            // Reinitialize register if needed
            initSynchronousRegister();
        }
    });
});

// Enhanced SlaveNode class (same as before)
class SlaveNode {
    constructor(slaveId) {
        this.slaveId = slaveId;
        this.status = "idle";
        this.currentTask = null;
        this.tasksCompleted = 0;
        this.totalProcessingTime = 0;
        this.queue = [];
    }

    async processTask(task) {
        this.status = "busy";
        this.currentTask = task;

        // Simulate processing time (1-3 seconds)
        const processTime = Math.random() * 2 + 1;
        
        return new Promise((resolve) => {
            setTimeout(() => {
                const result = this.executeTask(task, processTime);
                
                this.status = "idle";
                this.currentTask = null;
                this.tasksCompleted++;
                this.totalProcessingTime += processTime;
                
                resolve(result);
            }, processTime * 1000);
        });
    }

    executeTask(task, processTime) {
        const taskType = task.type || "calculation";
        const data = task.data || [];

        switch(taskType) {
            case "calculation":
                const numbers = Array.isArray(data) ? data : data.split(',').map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
                return {
                    slaveId: this.slaveId,
                    taskId: task.id,
                    result: numbers.reduce((sum, num) => sum + num, 0),
                    processTime: parseFloat(processTime.toFixed(2)),
                    status: "success",
                    taskType: "calculation"
                };
            
            case "transform":
                return {
                    slaveId: this.slaveId,
                    taskId: task.id,
                    result: String(data).toUpperCase(),
                    processTime: parseFloat(processTime.toFixed(2)),
                    status: "success",
                    taskType: "transform"
                };
            
            case "validation":
                return {
                    slaveId: this.slaveId,
                    taskId: task.id,
                    result: data.length > 0,
                    processTime: parseFloat(processTime.toFixed(2)),
                    status: "success",
                    taskType: "validation"
                };
            
            default:
                return {
                    slaveId: this.slaveId,
                    taskId: task.id,
                    result: null,
                    processTime: parseFloat(processTime.toFixed(2)),
                    status: "error",
                    error: "Unknown task type"
                };
        }
    }

    getStatus() {
        return {
            slaveId: this.slaveId,
            status: this.status,
            currentTask: this.currentTask,
            tasksCompleted: this.tasksCompleted,
            totalProcessingTime: parseFloat(this.totalProcessingTime.toFixed(2)),
            averageTime: this.tasksCompleted > 0 ? 
                parseFloat((this.totalProcessingTime / this.tasksCompleted).toFixed(2)) : 0
        };
    }
}

// Enhanced MasterSlaveSystem with better error handling
class MasterSlaveSystem {
    constructor(numSlaves = 3) {
        this.numSlaves = numSlaves;
        this.slaves = [];
        this.taskQueue = [];
        this.results = [];
        this.taskCounter = 0;
        this.isRunning = false;
        this.startTime = null;
        this.workerThreads = [];
        this.systemStatus = "stopped";

        // Initialize slaves
        for (let i = 0; i < numSlaves; i++) {
            this.slaves.push(new SlaveNode(i + 1));
        }
    }

    submitTask(taskType, data) {
        if (!this.isRunning) {
            throw new Error("System is not running. Please initialize first.");
        }
        
        this.taskCounter++;
        const task = {
            id: this.taskCounter,
            type: taskType,
            data: data,
            submittedAt: new Date().toISOString(),
            status: "pending",
            assignedTo: null
        };
        
        this.taskQueue.push(task);
        this.processQueue();
        
        return this.taskCounter;
    }

    startSystem() {
        this.isRunning = true;
        this.systemStatus = "running";
        this.startTime = new Date();
        
        // Clear any existing worker threads
        this.workerThreads.forEach(thread => {
            if (thread) clearTimeout(thread);
        });
        this.workerThreads = [];
        
        this.processQueue();
        
        // Start background processor
        this.startBackgroundProcessor();
    }

    stopSystem() {
        this.isRunning = false;
        this.systemStatus = "stopped";
        
        // Clear all worker threads
        this.workerThreads.forEach(thread => {
            if (thread) clearTimeout(thread);
        });
        this.workerThreads = [];
    }

    pauseSystem() {
        this.isRunning = false;
        this.systemStatus = "paused";
    }

    resumeSystem() {
        if (this.systemStatus === "paused") {
            this.isRunning = true;
            this.systemStatus = "running";
            this.processQueue();
        }
    }

    startBackgroundProcessor() {
        if (!this.isRunning) return;
        
        const processor = () => {
            if (this.isRunning) {
                this.processQueue();
                // Schedule next processing cycle
                const thread = setTimeout(processor, 1000);
                this.workerThreads.push(thread);
            }
        };
        
        // Start processor
        processor();
    }

    async processQueue() {
        if (!this.isRunning || this.taskQueue.length === 0) return;

        // Find idle slaves
        const idleSlaves = this.slaves.filter(slave => slave.status === "idle");
        
        // Process tasks with idle slaves
        idleSlaves.forEach(slave => {
            if (this.taskQueue.length > 0) {
                const task = this.taskQueue.shift();
                task.status = "processing";
                task.assignedTo = slave.slaveId;
                task.startedAt = new Date().toISOString();

                // Process task asynchronously
                slave.processTask(task).then(result => {
                    task.status = "completed";
                    task.completedAt = new Date().toISOString();
                    task.result = result;

                    this.results.push({
                        task: task,
                        result: result
                    });

                    // Trigger UI update
                    if (typeof onTaskCompleted === 'function') {
                        onTaskCompleted(task.id);
                    }
                }).catch(error => {
                    task.status = "error";
                    task.error = error.message;
                    
                    this.results.push({
                        task: task,
                        error: error
                    });
                });
            }
        });
    }

    getSystemStatus() {
        const uptime = this.startTime ? (new Date() - this.startTime) / 1000 : 0;
        
        return {
            master: {
                status: this.systemStatus,
                uptimeSeconds: parseFloat(uptime.toFixed(2)),
                tasksSubmitted: this.taskCounter,
                tasksPending: this.taskQueue.length,
                tasksCompleted: this.results.length
            },
            slaves: this.slaves.map(slave => slave.getStatus()),
            performance: this.calculatePerformance()
        };
    }

    calculatePerformance() {
        if (this.results.length === 0) return {};

        const totalTime = this.results.reduce((sum, r) => sum + r.result.processTime, 0);
        const avgTime = totalTime / this.results.length;
        const uptime = this.startTime ? (new Date() - this.startTime) / 1000 : 1;

        return {
            totalProcessingTime: parseFloat(totalTime.toFixed(2)),
            averageTaskTime: parseFloat(avgTime.toFixed(2)),
            throughput: parseFloat((this.results.length / uptime).toFixed(2))
        };
    }

    getTaskResults(taskId = null) {
        if (taskId) {
            return this.results.filter(r => r.task.id === taskId);
        }
        return this.results;
    }
}
// Master-Slave UI Functions
function showMasterSlaveInterface() {
    currentSequential2Component = 'master-slave';
    
    // Hide other input sections
    document.getElementById('t-flipflop-inputs').style.display = 'none';
    document.getElementById('register-storage-inputs').style.display = 'none';
    document.getElementById('shift-register-inputs').style.display = 'none';
    
    // Show master-slave inputs
    const masterSlaveInputs = document.getElementById('master-slave-inputs');
    masterSlaveInputs.style.display = 'block';
    
    // Add animation
    masterSlaveInputs.classList.add('fade-in');
    
    // Update description
    document.getElementById('sequential2-description').innerHTML = 
        `<strong>Master-Slave Configuration:</strong> Distributed task processing system where a Master node distributes tasks to multiple Slave nodes.`;
    
    // Show status display
    document.getElementById('register-status-display').style.display = 'block';
    
    // Initialize circuit visualization
    updateMasterSlaveCircuit(3); // Default 3 slaves
    
    // Show results container
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card">
            <h5 class="text-center mb-3"><i class="fas fa-network-wired me-2"></i>Master-Slave System</h5>
            <p class="text-center">Click "Initialize System" to start distributed processing</p>
            <div class="text-center mt-3">
                <i class="fas fa-play-circle fa-3x text-primary" style="opacity: 0.5;"></i>
            </div>
        </div>
    `;
    
    // Reset system status indicator
    updateSystemStatusIndicator("ready");
    
    addLog('Master-Slave Configuration interface opened', 'info');
}
async function initializeMasterSlaveSystem() {
    try {
        const numSlaves = parseInt(document.getElementById('num-slaves-input').value);
        
        if (numSlaves < 1 || numSlaves > 8) {
            throw new Error('Number of slaves must be between 1 and 8');
        }
        
        // Disable button during initialization
        const initBtn = document.getElementById('initialize-master-slave-btn');
        const originalText = initBtn.innerHTML;
        initBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Initializing...';
        initBtn.disabled = true;
        
        // Stop existing system if any
        if (masterSlaveSystem) {
            masterSlaveSystem.stopSystem();
        }
        
        // Initialize new system
        masterSlaveSystem = new MasterSlaveSystem(numSlaves);
        
        // Small delay for visual feedback
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Start the system
        masterSlaveSystem.startSystem();
        masterSlaveTasks = [];
        systemInitialized = true;
        
        // Update UI with success feedback
        document.getElementById('sequential2-results').innerHTML = `
            <div class="glass-card animate__animated animate__fadeIn">
                <h5 class="text-center mb-3 text-success">
                    <i class="fas fa-check-circle me-2"></i>System Initialized
                </h5>
                <div class="text-center">
                    <div class="mb-3">
                        <i class="fas fa-server fa-3x text-primary"></i>
                        <p class="mt-2"><strong>${numSlaves} Slave Nodes</strong></p>
                    </div>
                    <div class="alert alert-success">
                        <i class="fas fa-check me-2"></i>
                        Master-Slave system is now running and ready to process tasks
                    </div>
                </div>
            </div>
        `;
        
        // Update circuit visualization
        updateMasterSlaveCircuit(numSlaves);
        
        // Update system status indicator
        updateSystemStatusIndicator("running");
        
        // Update button text
        initBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Reinitialize System';
        
        // Change stop button to "Pause"
        const stopBtn = document.getElementById('stop-master-slave-btn');
        stopBtn.innerHTML = '<i class="fas fa-pause-circle me-2"></i>Pause System';
        stopBtn.className = 'btn btn-warning';
        
        addLog(` Master-Slave system initialized with ${numSlaves} slaves`, 'success');
        
    } catch (error) {
        // Show error message
        document.getElementById('sequential2-results').innerHTML = `
            <div class="glass-card animate__animated animate__shakeX">
                <h5 class="text-center mb-3 text-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>Initialization Failed
                </h5>
                <div class="alert alert-danger">
                    <i class="fas fa-times me-2"></i>
                    ${error.message}
                </div>
            </div>
        `;
        
        addLog(`Initialization failed: ${error.message}`, 'error');
    } finally {
        // Re-enable button
        const initBtn = document.getElementById('initialize-master-slave-btn');
        initBtn.disabled = false;
    }
}
function submitMasterSlaveTask() {
    if (!masterSlaveSystem) {
        showError("Please initialize the system first");
        return;
    }
    
    if (masterSlaveSystem.systemStatus !== "running") {
        showError("System is not running. Please initialize or resume the system.");
        return;
    }
    
    try {
        const taskType = document.getElementById('task-type-select').value;
        let data;
        
        switch(taskType) {
            case 'calculation':
                const calcInput = document.getElementById('calculation-data').value;
                data = calcInput.split(',').map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
                if (data.length === 0) {
                    throw new Error('Please enter valid numbers');
                }
                break;
            case 'transform':
                data = document.getElementById('transform-data').value;
                if (!data.trim()) {
                    throw new Error('Please enter text to transform');
                }
                break;
            case 'validation':
                data = document.getElementById('validation-data').value;
                if (!data.trim()) {
                    throw new Error('Please enter data to validate');
                }
                break;
        }
        
        const taskId = masterSlaveSystem.submitTask(taskType, data);
        masterSlaveTasks.push({ id: taskId, type: taskType, data: data, status: 'submitted' });
        
        // Show success message with task details
        document.getElementById('sequential2-results').innerHTML = `
            <div class="glass-card animate__animated animate__fadeIn">
                <h5 class="text-center mb-3 text-success">
                    <i class="fas fa-paper-plane me-2"></i>Task Submitted
                </h5>
                <div class="text-center">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <div class="task-details">
                        <p><strong>Task ID:</strong> ${taskId}</p>
                        <p><strong>Type:</strong> ${taskType}</p>
                        <p><strong>Status:</strong> <span class="badge bg-warning">Processing...</span></p>
                    </div>
                </div>
            </div>
        `;
        
        addLog(`Task ${taskId} submitted (${taskType})`, 'success');
        
        // Automatically update status after 2 seconds
        setTimeout(() => {
            if (masterSlaveSystem) {
                viewMasterSlaveStatus();
            }
        }, 2000);
        
    } catch (error) {
        showError(error.message);
    }
}
function viewMasterSlaveStatus() {
    if (!masterSlaveSystem) {
        showError('System not initialized');
        return;
    }
    
    const status = masterSlaveSystem.getSystemStatus();
    const results = masterSlaveSystem.getTaskResults();
    
    let statusHTML = `
        <div class="glass-card animate__animated animate__fadeIn">
            <h5 class="text-center mb-3">
                <i class="fas fa-chart-bar me-2"></i>System Status
                <span class="badge ${status.master.status === 'running' ? 'bg-success' : 'bg-warning'} ms-2">
                    ${status.master.status.toUpperCase()}
                </span>
            </h5>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="status-card">
                        <h6><i class="fas fa-crown me-2"></i>Master Node</h6>
                        <div class="status-details">
                            <p><i class="fas fa-play-circle me-2"></i><strong>Status:</strong> ${status.master.status}</p>
                            <p><i class="fas fa-clock me-2"></i><strong>Uptime:</strong> ${formatTime(status.master.uptimeSeconds)}</p>
                            <p><i class="fas fa-tasks me-2"></i><strong>Tasks:</strong> ${status.master.tasksCompleted}/${status.master.tasksSubmitted}</p>
                            <p><i class="fas fa-hourglass-half me-2"></i><strong>Pending:</strong> ${status.master.tasksPending}</p>
                        </div>
                    </div>
                </div>
    `;
    
    if (status.performance) {
        statusHTML += `
                <div class="col-md-6">
                    <div class="status-card">
                        <h6><i class="fas fa-chart-line me-2"></i>Performance</h6>
                        <div class="status-details">
                            <p><i class="fas fa-clock me-2"></i><strong>Total Time:</strong> ${status.performance.totalProcessingTime}s</p>
                            <p><i class="fas fa-tachometer-alt me-2"></i><strong>Avg Time:</strong> ${status.performance.averageTaskTime}s</p>
                            <p><i class="fas fa-bolt me-2"></i><strong>Throughput:</strong> ${status.performance.throughput}/s</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Slave nodes status
    statusHTML += `
            <h6 class="mt-4"><i class="fas fa-server me-2"></i>Slave Nodes (${status.slaves.length})</h6>
            <div class="row">
    `;
    
    status.slaves.forEach(slave => {
        const statusColor = slave.status === 'idle' ? 'success' : 'warning';
        statusHTML += `
                <div class="col-md-4 mb-3">
                    <div class="slave-card">
                        <div class="slave-header ${slave.status === 'busy' ? 'busy' : ''}">
                            <h6><i class="fas fa-microchip me-2"></i>Slave #${slave.slaveId}</h6>
                            <span class="badge bg-${statusColor}">${slave.status.toUpperCase()}</span>
                        </div>
                        <div class="slave-body">
                            <p><i class="fas fa-check-circle me-2"></i><strong>Completed:</strong> ${slave.tasksCompleted}</p>
                            <p><i class="fas fa-clock me-2"></i><strong>Avg Time:</strong> ${slave.averageTime}s</p>
                            ${slave.currentTask ? `<p><i class="fas fa-spinner fa-spin me-2"></i>Processing Task ${slave.currentTask.id}</p>` : ''}
                        </div>
                    </div>
                </div>
        `;
    });
    
    statusHTML += `
            </div>
    `;
    
    // Recent tasks
    if (results.length > 0) {
        statusHTML += `
            <h6 class="mt-4"><i class="fas fa-history me-2"></i>Recent Tasks</h6>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Slave</th>
                            <th>Result</th>
                            <th>Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        const recentTasks = results.slice(-10).reverse();
        recentTasks.forEach(item => {
            const task = item.task;
            const result = item.result;
            const statusBadge = task.status === 'completed' ? 'success' : 
                               task.status === 'processing' ? 'warning' : 'danger';
            
            statusHTML += `
                        <tr>
                            <td><strong>#${task.id}</strong></td>
                            <td><span class="badge bg-info">${task.type}</span></td>
                            <td>${task.assignedTo || '-'}</td>
                            <td><code>${JSON.stringify(result?.result || 'N/A')}</code></td>
                            <td>${result?.processTime || 'N/A'}s</td>
                            <td><span class="badge bg-${statusBadge}">${task.status}</span></td>
                        </tr>
            `;
        });
        
        statusHTML += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    statusHTML += `
        </div>
        <div class="text-center mt-3">
            <button class="btn btn-sm btn-outline-primary" onclick="viewMasterSlaveStatus()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>
    `;
    
    document.getElementById('sequential2-results').innerHTML = statusHTML;
    addLog('System status viewed', 'info');
}


function pauseMasterSlaveSystem() {
    if (!masterSlaveSystem) {
        showError('System not initialized');
        return;
    }
    
    masterSlaveSystem.pauseSystem();
    
    const stopBtn = document.getElementById('stop-master-slave-btn');
    stopBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i>Resume System';
    stopBtn.className = 'btn btn-success';
    
    updateSystemStatusIndicator("paused");
    
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card animate__animated animate__fadeIn">
            <h5 class="text-center mb-3 text-warning">
                <i class="fas fa-pause-circle me-2"></i>System Paused
            </h5>
            <div class="text-center">
                <i class="fas fa-pause-circle fa-3x text-warning mb-3"></i>
                <p class="mt-3">Master-Slave system is paused</p>
                <p>Click "Resume System" to continue processing</p>
            </div>
        </div>
    `;
    
    addLog('Master-Slave system paused', 'warning');
}

function resumeMasterSlaveSystem() {
    if (!masterSlaveSystem) {
        showError('System not initialized');
        return;
    }
    
    masterSlaveSystem.resumeSystem();
    
    const stopBtn = document.getElementById('stop-master-slave-btn');
    stopBtn.innerHTML = '<i class="fas fa-pause-circle me-2"></i>Pause System';
    stopBtn.className = 'btn btn-warning';
    
    updateSystemStatusIndicator("running");
    
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card animate__animated animate__fadeIn">
            <h5 class="text-center mb-3 text-success">
                <i class="fas fa-play-circle me-2"></i>System Resumed
            </h5>
            <div class="text-center">
                <i class="fas fa-play-circle fa-3x text-success mb-3"></i>
                <p class="mt-3">Master-Slave system is now running</p>
                <p>Tasks will continue processing</p>
            </div>
        </div>
    `;
    
    addLog('Master-Slave system resumed', 'success');
}

function stopMasterSlaveSystem() {
    if (!masterSlaveSystem) {
        showError('System not initialized');
        return;
    }
    
    masterSlaveSystem.stopSystem();
    masterSlaveSystem = null;
    systemInitialized = false;
    
    // Reset buttons
    const initBtn = document.getElementById('initialize-master-slave-btn');
    initBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i>Initialize System';
    
    const stopBtn = document.getElementById('stop-master-slave-btn');
    stopBtn.innerHTML = '<i class="fas fa-stop-circle me-2"></i>Stop System';
    stopBtn.className = 'btn btn-danger';
    
    updateSystemStatusIndicator("stopped");
    
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card animate__animated animate__fadeIn">
            <h5 class="text-center mb-3 text-danger">
                <i class="fas fa-stop-circle me-2"></i>System Stopped
            </h5>
            <div class="text-center">
                <i class="fas fa-stop-circle fa-3x text-danger mb-3"></i>
                <p class="mt-3">Master-Slave system has been stopped</p>
                <p>All processing threads terminated</p>
            </div>
        </div>
    `;
    
    addLog('Master-Slave system stopped', 'info');
}

function exitMasterSlaveInterface() {
    // Stop system if running
    if (masterSlaveSystem) {
        masterSlaveSystem.stopSystem();
        masterSlaveSystem = null;
    }
    
    // Hide master-slave interface
    document.getElementById('master-slave-inputs').style.display = 'none';
    
    // Reset component
    currentSequential2Component = null;
    systemInitialized = false;
    
    // Clear results
    document.getElementById('sequential2-results').innerHTML = '';
    
    // Reset circuit container
    document.getElementById('sequential2-circuit-container').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-share-alt fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <p class="mt-2">Select a sequential component to visualize its circuit</p>
        </div>
    `;
    
    addLog('Master-Slave interface closed', 'info');
}
function updateTaskTypeInputs(taskType) {
    // Hide all input sections
    document.querySelectorAll('.task-input-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show selected input section
    document.getElementById(`${taskType}-inputs`).style.display = 'block';
}

function updateMasterSlaveCircuit(numSlaves) {
    let circuitHTML = `
        <div class="text-center">
            <h4><i class="fas fa-network-wired me-2"></i>Master-Slave Architecture</h4>
            <div class="realistic-circuit-container mt-4" style="min-height: 400px;">
                <div class="circuit-board"></div>
                
                <!-- Master Node -->
                <div class="ic-package master-node-circuit" style="width: 140px; height: 100px; left: 50%; top: 50px; transform: translateX(-50%);">
                    <div class="ic-label"><i class="fas fa-crown me-1"></i>MASTER</div>
                    <div class="ic-pin" style="top: 25px; left: -8px;"></div>
                    <div class="ic-pin" style="top: 75px; left: -8px;"></div>
                    <div class="node-status" id="master-status">Running</div>
                </div>
    `;
    
    // Slave Nodes
    const slaveWidth = 90;
    const slaveHeight = 70;
    const containerWidth = 650;
    const startX = (containerWidth - (numSlaves * (slaveWidth + 25))) / 2;
    
    for (let i = 0; i < numSlaves; i++) {
        const x = startX + i * (slaveWidth + 25);
        const y = 200;
        
        circuitHTML += `
                <!-- Slave Node ${i + 1} -->
                <div class="ic-package slave-node-circuit" style="width: ${slaveWidth}px; height: ${slaveHeight}px; left: ${x}px; top: ${y}px;">
                    <div class="ic-label"><i class="fas fa-microchip me-1"></i>SLAVE ${i + 1}</div>
                    <div class="ic-pin" style="top: 25px; right: -8px;"></div>
                    <div class="ic-pin" style="top: 45px; right: -8px;"></div>
                    <div class="node-status" id="slave-status-${i+1}">Idle</div>
                </div>
                
                <!-- Connection from Master to Slave -->
                <div class="circuit-track" style="width: 4px; height: ${y - 130}px; left: ${x + slaveWidth/2}px; top: 130px;"></div>
                <div class="circuit-track" style="width: ${Math.abs(300 - (x + slaveWidth/2))}px; height: 4px; left: ${Math.min(300, x + slaveWidth/2)}px; top: 130px;"></div>
        `;
    }
    
    circuitHTML += `
                <!-- Data Bus -->
                <div class="data-bus" style="width: 550px; height: 6px; left: 50px; top: 280px;"></div>
                
                <!-- Task Queue -->
                <div class="ic-package queue-circuit" style="width: 180px; height: 80px; left: 50%; top: 350px; transform: translateX(-50%);">
                    <div class="ic-label"><i class="fas fa-list-alt me-1"></i>TASK QUEUE</div>
                    <div class="queue-count" id="queue-count">0 tasks</div>
                </div>
                
                <!-- Status Indicators -->
                <div class="circuit-label-real" style="left: 30px; top: 30px;"><i class="fas fa-crown me-1"></i>Master Node</div>
                <div class="circuit-label-real" style="left: 30px; top: 220px;"><i class="fas fa-server me-1"></i>Slave Nodes (${numSlaves})</div>
                <div class="circuit-label-real" style="left: 30px; top: 360px;"><i class="fas fa-tasks me-1"></i>Task Queue</div>
                
                <!-- Data Flow Animation -->
                <div class="data-packet" id="data-packet-1" style="left: 300px; top: 60px;"></div>
                <div class="data-packet" id="data-packet-2" style="left: 400px; top: 60px;"></div>
            </div>
        </div>
    `;
    
    document.getElementById('sequential2-circuit-container').innerHTML = circuitHTML;
    
    // Start data flow animation
    animateDataFlow();
}
function updateSystemStatusIndicator(status) {
    const indicator = document.getElementById('master-slave-status-indicator');
    const statusDot = document.getElementById('system-status-dot');
    const statusText = document.getElementById('system-status-text');
    
    indicator.style.display = 'block';
    
    switch(status) {
        case 'ready':
            statusDot.className = 'status-dot bg-secondary';
            statusText.textContent = 'Ready to Initialize';
            break;
        case 'running':
            statusDot.className = 'status-dot bg-success';
            statusText.textContent = 'System Running';
            break;
        case 'paused':
            statusDot.className = 'status-dot bg-warning';
            statusText.textContent = 'System Paused';
            break;
        case 'stopped':
            statusDot.className = 'status-dot bg-danger';
            statusText.textContent = 'System Stopped';
            break;
    }
}

function animateDataFlow() {
    // Simple data flow animation
    const packets = document.querySelectorAll('.data-packet');
    packets.forEach((packet, index) => {
        packet.style.animation = `moveData 3s linear ${index * 1.5}s infinite`;
    });
}

function showError(message) {
    const resultsDiv = document.getElementById('sequential2-results');
    resultsDiv.innerHTML = `
        <div class="glass-card animate__animated animate__shakeX">
            <h5 class="text-center mb-3 text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>Error
            </h5>
            <div class="alert alert-danger">
                <i class="fas fa-times me-2"></i>
                ${message}
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-sm btn-outline-primary" onclick="showMasterSlaveInterface()">
                    <i class="fas fa-redo me-1"></i>Return to Interface
                </button>
            </div>
        </div>
    `;
    
    addLog(`Error: ${message}`, 'error');
}

function formatTime(seconds) {
    if (seconds < 60) {
        return `${seconds.toFixed(1)}s`;
    } else if (seconds < 3600) {
        return `${(seconds / 60).toFixed(1)}m`;
    } else {
        return `${(seconds / 3600).toFixed(1)}h`;
    }
}

// Task completion callback
function onTaskCompleted(taskId) {
    // Update UI when task completes
    if (document.getElementById('sequential2-results').innerHTML.includes('Task Submitted')) {
        // If showing task submission page, update it
        setTimeout(() => {
            viewMasterSlaveStatus();
        }, 1000);
    }
}
// Setup Time Verification functions
function setupTimeVerification(dataTimes, clockTimes, requiredSetup, clockPeriod) {
    let violations = [];
    let slackValues = [];
    let worstSlack = Infinity;
    let calculationSteps = []; // Store detailed steps
    
    for (let i = 0; i < dataTimes.length; i++) {
        for (let j = 0; j < clockTimes.length; j++) {
            if (clockTimes[j] > dataTimes[i]) {
                const slack = (clockTimes[j] - dataTimes[i]) - requiredSetup;
                slackValues.push(slack);
                
                // Add detailed calculation step
                calculationSteps.push({
                    stepNumber: calculationSteps.length + 1,
                    dataIndex: i,
                    clockIndex: j,
                    dataTime: dataTimes[i],
                    clockTime: clockTimes[j],
                    slack: slack,
                    calculation: `(${clockTimes[j]} - ${dataTimes[i]}) - ${requiredSetup} = ${slack.toFixed(3)}`,
                    status: slack >= 0 ? 'PASS' : 'FAIL'
                });
                
                if (slack < worstSlack) {
                    worstSlack = slack;
                }
                
                if (slack < 0) {
                    violations.push({
                        dataIndex: i,
                        clockIndex: j,
                        dataTime: dataTimes[i],
                        clockTime: clockTimes[j],
                        violation: Math.abs(slack),
                        slack: slack
                    });
                }
                break;
            }
        }
    }
    
    const status = violations.length === 0 ? "PASS" : "FAIL";
    const avgSlack = slackValues.length > 0 ? 
        slackValues.reduce((a, b) => a + b, 0) / slackValues.length : 0;
    
    const summary = {
        totalChecks: slackValues.length,
        violationCount: violations.length,
        worstSlack: worstSlack,
        minSlack: slackValues.length > 0 ? Math.min(...slackValues) : 0,
        maxSlack: slackValues.length > 0 ? Math.max(...slackValues) : 0,
        avgSlack: avgSlack,
        clockPeriod: clockPeriod,
        setupRequired: requiredSetup
    };
    
    return {
        violations: violations,
        worstSlack: worstSlack,
        slackValues: slackValues,
        status: status,
        summary: summary,
        calculationSteps: calculationSteps,
        timestamp: new Date().toLocaleString()
    };
}

function createStepByStepAnalysis(results) {
    let html = `
        <div class="setup-time-step active">
            <h6> Step-by-Step Analysis</h6>
            <p><strong>Formula Used:</strong> Slack = (Clock Time - Data Time) - Required Setup Time</p>
            <p><strong>Rule:</strong> Slack  0 means PASS, Slack < 0 means FAIL (Violation)</p>
        </div>
    `;
    
    // Show each calculation step
    results.calculationSteps.forEach(step => {
        const isViolation = step.slack < 0;
        
        html += `
            <div class="setup-time-step ${isViolation ? 'error' : ''}">
                <div class="d-flex justify-content-between align-items-center">
                    <h6>Step ${step.stepNumber}: Data D${step.dataIndex} vs Clock C${step.clockIndex}</h6>
                    <span class="badge ${isViolation ? 'bg-danger' : 'bg-success'}">
                        ${isViolation ? 'VIOLATION' : 'PASS'}
                    </span>
                </div>
                
                <div class="mt-2">
                    <p><strong>Timing Values:</strong></p>
                    <ul>
                        <li>Data D${step.dataIndex} arrives at: <code>${step.dataTime.toFixed(3)} ns</code></li>
                        <li>Clock C${step.clockIndex} edge at: <code>${step.clockTime.toFixed(3)} ns</code></li>
                        <li>Required setup time: <code>${results.summary.setupRequired} ns</code></li>
                    </ul>
                </div>
                
                <div class="mt-2">
                    <p><strong>Calculation:</strong></p>
                    <div class="calculation-formula">
                        Slack = (Clock - Data) - Setup<br>
                        = (${step.clockTime.toFixed(3)} - ${step.dataTime.toFixed(3)}) - ${results.summary.setupRequired}<br>
                        = ${(step.clockTime - step.dataTime).toFixed(3)} - ${results.summary.setupRequired}<br>
                        = <strong class="${isViolation ? 'text-danger' : 'text-success'}">${step.slack.toFixed(3)} ns</strong>
                    </div>
                </div>
                
                <div class="mt-2">
                    <p><strong>Analysis:</strong></p>
                    ${isViolation ? 
                        `<p class="text-danger">
                             <strong>VIOLATION DETECTED!</strong><br>
                            Data D${step.dataIndex} arrives <strong>${Math.abs(step.slack).toFixed(3)} ns too late</strong>.<br>
                            Need to arrive at least ${results.summary.setupRequired} ns before clock, 
                            but only ${(step.clockTime - step.dataTime).toFixed(3)} ns margin available.
                        </p>` :
                        `<p class="text-success">
                             <strong>PASS - Timing constraint satisfied</strong><br>
                            Data D${step.dataIndex} arrives with <strong>${step.slack.toFixed(3)} ns positive margin</strong>.<br>
                            Available margin: ${(step.clockTime - step.dataTime).toFixed(3)} ns - Required: ${results.summary.setupRequired} ns
                        </p>`
                    }
                </div>
                
                ${isViolation ? `
                    <div class="mt-2 p-2 bg-danger bg-opacity-10 border-start border-3 border-danger">
                        <p><strong> Why This Violates:</strong></p>
                        <ol>
                            <li>Data changes <strong>${(step.dataTime - (step.clockTime - results.summary.setupRequired)).toFixed(3)} ns too late</strong></li>
                            <li>The flip-flop needs ${results.summary.setupRequired} ns stable time before clock edge</li>
                            <li>Data is only stable for ${(step.clockTime - step.dataTime).toFixed(3)} ns before clock</li>
                            <li>Missing ${Math.abs(step.slack).toFixed(3)} ns of required setup time</li>
                        </ol>
                    </div>
                ` : ''}
                
                <div class="mt-2 small text-muted">
                    <p><strong>Visual Timeline:</strong></p>
                    <div style="position: relative; height: 30px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin: 10px 0;">
                        <!-- Timeline visualization -->
                        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 100%;">
                            <!-- Data arrival point -->
                            <div style="position: absolute; left: ${(step.dataTime / (step.clockTime + 2)) * 95}%; top: 5px; 
                                        width: 4px; height: 20px; background: var(${isViolation ? '--danger-color' : '--success-color'}); 
                                        transform: translateX(-50%);">
                                <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); 
                                            font-size: 10px; white-space: nowrap;">D${step.dataIndex}</div>
                            </div>
                            
                            <!-- Clock edge point -->
                            <div style="position: absolute; left: ${(step.clockTime / (step.clockTime + 2)) * 95}%; top: 5px; 
                                        width: 4px; height: 20px; background: var(--info-color); 
                                        transform: translateX(-50%);">
                                <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); 
                                            font-size: 10px; white-space: nowrap;">C${step.clockIndex}</div>
                            </div>
                            
                            <!-- Setup window -->
                            <div style="position: absolute; 
                                        left: ${((step.clockTime - results.summary.setupRequired) / (step.clockTime + 2)) * 95}%; 
                                        right: ${100 - (step.clockTime / (step.clockTime + 2)) * 95}%; 
                                        top: 5px; height: 20px; background: ${isViolation ? 'rgba(220, 20, 60, 0.2)' : 'rgba(34, 139, 34, 0.2)'}; 
                                        border: 1px dashed ${isViolation ? 'var(--danger-color)' : 'var(--success-color)'};">
                                <div style="position: absolute; top: -18px; left: 50%; transform: translateX(-50%); 
                                            font-size: 9px; color: #666;">Setup Window</div>
                            </div>
                            
                            <!-- Margin line -->
                            <div style="position: absolute; 
                                        left: ${(step.dataTime / (step.clockTime + 2)) * 95}%; 
                                        right: ${100 - (step.clockTime / (step.clockTime + 2)) * 95}%; 
                                        top: 50%; height: 1px; background: ${isViolation ? 'var(--danger-color)' : 'var(--success-color)'}; 
                                        opacity: 0.5;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    return html;
}

function createSetupTimeResultsHTML(results) {
    let html = `
        <div class="setup-time-result ${results.status === 'PASS' ? 'result-pass' : 'result-fail'}">
            <h4>Setup Time Verification: ${results.status}</h4>
            <p>Worst Slack: <strong>${results.worstSlack.toFixed(3)} ns</strong></p>
            <p>Violations: ${results.summary.violationCount} out of ${results.summary.totalChecks}</p>
            <p class="small">Based on ${results.calculationSteps.length} timing checks</p>
        </div>
        
        <!-- Quick Summary -->
        <div class="setup-time-step active">
            <h6> Quick Summary</h6>
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center p-2">
                        <div class="display-6 ${results.status === 'PASS' ? 'text-success' : 'text-danger'}">
                            ${results.status}
                        </div>
                        <small>Overall Result</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-2">
                        <div class="display-6 ${results.worstSlack >= 0 ? 'text-success' : 'text-danger'}">
                            ${results.worstSlack.toFixed(3)} ns
                        </div>
                        <small>Worst Slack</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-2">
                        <div class="display-6 ${results.summary.violationCount === 0 ? 'text-success' : 'text-danger'}">
                            ${results.summary.violationCount}
                        </div>
                        <small>Violations</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add step-by-step analysis
    html += createStepByStepAnalysis(results);
    
    // Add summary statistics
    html += `
        <div class="setup-time-step">
            <h6> Summary Statistics</h6>
            <table class="setup-time-table">
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                    <th>Interpretation</th>
                </tr>
                <tr>
                    <td>Total Timing Checks</td>
                    <td>${results.summary.totalChecks}</td>
                    <td>Data-clock pairs analyzed</td>
                </tr>
                <tr>
                    <td>Setup Violations</td>
                    <td class="${results.summary.violationCount > 0 ? 'setup-time-violation' : 'setup-time-pass'}">
                        ${results.summary.violationCount}
                    </td>
                    <td>${results.summary.violationCount > 0 ? 'FAIL - Timing errors found' : 'PASS - All constraints met'}</td>
                </tr>
                <tr>
                    <td>Worst Slack</td>
                    <td>
                        <span class="setup-time-slack ${results.worstSlack < 0 ? 'slack-negative' : 'slack-positive'}">
                            ${results.worstSlack.toFixed(3)} ns
                        </span>
                    </td>
                    <td>${results.worstSlack < 0 ? 
                        `Short by ${Math.abs(results.worstSlack).toFixed(3)} ns` : 
                        `${results.worstSlack.toFixed(3)} ns positive margin`}
                    </td>
                </tr>
                <tr>
                    <td>Average Slack</td>
                    <td>${results.summary.avgSlack.toFixed(3)} ns</td>
                    <td>${results.summary.avgSlack > 0 ? 'Positive average margin' : 'Negative average margin'}</td>
                </tr>
                <tr>
                    <td>Required Setup</td>
                    <td>${results.summary.setupRequired} ns</td>
                    <td>Technology/library requirement</td>
                </tr>
                <tr>
                    <td>Clock Period</td>
                    <td>${results.summary.clockPeriod} ns</td>
                    <td>Time between clock edges</td>
                </tr>
            </table>
        </div>
    `;
    
    if (results.violations.length > 0) {
        html += `
            <div class="setup-time-step error">
                <h6> Violation Details</h6>
                <p><strong>${results.violations.length} critical timing violations found:</strong></p>
                <table class="setup-time-table">
                    <tr>
                        <th>#</th>
                        <th>Data Signal</th>
                        <th>Clock Edge</th>
                        <th>Data Time</th>
                        <th>Clock Time</th>
                        <th>Available Margin</th>
                        <th>Required Setup</th>
                        <th>Slack</th>
                        <th>Violation</th>
                    </tr>
        `;
        
        results.violations.forEach((violation, index) => {
            const availableMargin = (violation.clockTime - violation.dataTime).toFixed(3);
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>D${violation.dataIndex}</td>
                    <td>C${violation.clockIndex}</td>
                    <td>${violation.dataTime.toFixed(2)} ns</td>
                    <td>${violation.clockTime.toFixed(2)} ns</td>
                    <td>${availableMargin} ns</td>
                    <td>${results.summary.setupRequired} ns</td>
                    <td class="setup-time-violation">${violation.slack.toFixed(3)} ns</td>
                    <td class="setup-time-violation">${violation.violation.toFixed(3)} ns</td>
                </tr>
            `;
        });
        
        html += `</table></div>`;
    }
    
    html += `
        <div class="setup-time-step">
            <h6> Slack Distribution</h6>
            <div class="timing-diagram" id="slack-histogram">
                <!-- Slack visualization will be generated here -->
            </div>
        </div>
        
        <div class="setup-time-step ${results.status === 'FAIL' ? 'error' : ''}">
            <h6>${results.status === 'PASS' ? ' Recommendations' : ' Critical Issues'}</h6>
            ${results.status === 'PASS' ? 
                `<p><strong>All setup time requirements are satisfied!</strong></p>
                 <ul>
                    <li>Worst-case slack: <strong>${results.worstSlack.toFixed(3)} ns positive</strong></li>
                    <li>Average slack: <strong>${results.summary.avgSlack.toFixed(3)} ns</strong></li>
                    <li>No timing violations detected</li>
                 </ul>
                 <p class="text-success"> Design meets all setup time constraints</p>` :
                `<p><strong>${results.violations.length} setup time violation${results.violations.length > 1 ? 's' : ''} detected!</strong></p>
                 <p><strong>Problem:</strong> Data arrives too close to clock edges, causing potential metastability.</p>
                 <p><strong>Worst violation:</strong> Missing ${Math.abs(results.worstSlack).toFixed(3)} ns of required setup time</p>
                 
                 <div class="mt-3">
                    <h6> Solutions:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="gate-description">
                                <strong>Reduce Data Path Delay:</strong>
                                <ul>
                                    <li>Use faster logic gates</li>
                                    <li>Optimize combinational logic</li>
                                    <li>Reduce wire delay</li>
                                    <li>Use pipeline registers</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="gate-description">
                                <strong>Adjust Timing:</strong>
                                <ul>
                                    <li>Increase clock period to ${(results.summary.clockPeriod + Math.abs(results.worstSlack)).toFixed(2)} ns</li>
                                    <li>Use clock skew optimization</li>
                                    <li>Balance clock tree</li>
                                    <li>Use clock gating carefully</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                 </div>
                 
                 <div class="mt-3 alert alert-warning">
                    <strong> Risk Assessment:</strong>
                    <ul>
                        <li>Violations can cause metastability and data corruption</li>
                        <li>Worst-case violation: ${Math.abs(results.worstSlack).toFixed(3)} ns</li>
                        <li>Probability of failure increases with violation magnitude</li>
                        <li>Consider adding synchronizers for critical paths</li>
                    </ul>
                 </div>`
            }
        </div>
    `;
    
    return html;
}
function createSlackHistogram(slackValues, worstSlack) {
    if (slackValues.length === 0) return '<p>No slack data available</p>';
    
    const minSlack = Math.min(...slackValues);
    const maxSlack = Math.max(...slackValues);
    const range = maxSlack - minSlack;
    const numBins = Math.min(10, slackValues.length);
    const binWidth = range / numBins;
    
    // Create histogram bins
    const bins = Array(numBins).fill(0);
    slackValues.forEach(slack => {
        const binIndex = Math.min(numBins - 1, Math.floor((slack - minSlack) / binWidth));
        bins[binIndex]++;
    });
    
    // Calculate max frequency for scaling
    const maxFreq = Math.max(...bins);
    
    // Create HTML for histogram with labels
    let html = `
        <div class="mb-3">
            <p><strong>Distribution of ${slackValues.length} slack values:</strong></p>
            <p>Range: ${minSlack.toFixed(3)} ns to ${maxSlack.toFixed(3)} ns</p>
        </div>
        
        <div style="height: 200px; position: relative; margin-top: 20px; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
    `;
    
    // Create histogram bars
    bins.forEach((freq, index) => {
        const barHeight = (freq / maxFreq) * 150;
        const barLeft = (index / numBins) * 100;
        const barWidth = (100 / numBins) * 0.8;
        const barCenter = barLeft + (barWidth / 2);
        const barMin = minSlack + (index * binWidth);
        const barMax = barMin + binWidth;
        const barColor = barMax <= 0 ? 'var(--danger-color)' : 
                        barMin < 0 ? 'var(--warning-color)' : 'var(--success-color)';
        
        html += `
            <div style="
                position: absolute;
                bottom: 0;
                left: ${barLeft}%;
                width: ${barWidth}%;
                height: ${barHeight}px;
                background-color: ${barColor};
                border-radius: 3px 3px 0 0;
                opacity: 0.8;
            " title="Slack: ${barMin.toFixed(2)} to ${barMax.toFixed(2)} ns (${freq} values)">
                <div style="
                    position: absolute;
                    top: -20px;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 10px;
                    color: #666;
                ">${barMin.toFixed(1)}</div>
                <div style="
                    position: absolute;
                    top: ${barHeight + 5}px;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 11px;
                    font-weight: bold;
                    color: #333;
                ">${freq}</div>
            </div>
        `;
    });
    
    // Add violation threshold line (0 ns)
    html += `
        <div style="
            position: absolute;
            left: ${((0 - minSlack) / range) * 100}%;
            bottom: 0;
            width: 2px;
            height: 150px;
            background-color: var(--warning-color);
            z-index: 10;
        " title="Violation Threshold (0 ns)">
            <div style="
                position: absolute;
                top: -25px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 11px;
                font-weight: bold;
                color: var(--warning-color);
                white-space: nowrap;
            ">0 ns (Threshold)</div>
        </div>
    `;
    
    // Add worst slack marker
    if (worstSlack !== Infinity) {
        html += `
            <div style="
                position: absolute;
                left: ${((worstSlack - minSlack) / range) * 100}%;
                bottom: 0;
                width: 3px;
                height: 150px;
                background-color: var(--dark-color);
                z-index: 5;
            " title="Worst Slack: ${worstSlack.toFixed(3)} ns">
                <div style="
                    position: absolute;
                    top: -35px;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 11px;
                    font-weight: bold;
                    color: var(--dark-color);
                    white-space: nowrap;
                    background: white;
                    padding: 2px 5px;
                    border: 1px solid #ccc;
                    border-radius: 3px;
                ">Worst: ${worstSlack.toFixed(2)} ns</div>
            </div>
        `;
    }
    
    html += `
        <div style="position: absolute; bottom: -30px; left: 0; right: 0; text-align: center;">
            <span style="color: #666; font-weight: bold;">Slack Value (ns)</span>
        </div>
        
        <div style="position: absolute; left: -40px; top: 50%; transform: translateY(-50%) rotate(-90deg);">
            <span style="color: #666; font-weight: bold;">Frequency</span>
        </div>
    `;
    
    html += `</div>`;
    
    return html;
}
// Add this missing log function
function addLogEntry(message, type = 'info') {
    const logContainer = document.getElementById('operation-log');
    if (!logContainer) return;
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;
    logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// Function to load setup time example (needs to be global)
window.loadSetupTimeExample = function(exampleIndex) {
    const examples = [
        {
            dataTimes: [1.0, 3.0, 5.0, 7.0, 9.0],
            clockTimes: [2.0, 4.0, 6.0, 8.0, 10.0],
            setupTime: 0.5,
            clockPeriod: 2.0
        },
        {
            dataTimes: [1.8, 3.9, 5.8, 7.9, 9.8],
            clockTimes: [2.0, 4.0, 6.0, 8.0, 10.0],
            setupTime: 0.5,
            clockPeriod: 2.0
        },
        {
            dataTimes: [1.4, 3.4, 5.4, 7.4, 9.4],
            clockTimes: [2.0, 4.0, 6.0, 8.0, 10.0],
            setupTime: 0.5,
            clockPeriod: 2.0
        }
    ];
    
    const example = examples[exampleIndex];
    
    document.getElementById('data-times-input').value = example.dataTimes.join(', ');
    document.getElementById('clock-times-input').value = example.clockTimes.join(', ');
    document.getElementById('setup-time-input').value = example.setupTime;
    document.getElementById('clock-period-input').value = example.clockPeriod;
    
    addLogEntry(`Loaded setup time example ${exampleIndex + 1}`, 'info');
};

// Make sure DOM is loaded before attaching event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Only add event listeners if elements exist
    const setupTimeBtn = document.getElementById('setup-time-btn');
    const calculateSetupTimeBtn = document.getElementById('calculate-setup-time-btn');
    const generateRandomTimingBtn = document.getElementById('generate-random-timing-btn');
    const showExamplesBtn = document.getElementById('show-setup-time-examples-btn');
    const closeSetupTimeBtn = document.getElementById('close-setup-time-btn');
    
    if (setupTimeBtn) {
        setupTimeBtn.addEventListener('click', function() {
            currentSequential2Component = 'setup-time';
            
            // Hide other input sections
            document.getElementById('t-flipflop-inputs').style.display = 'none';
            document.getElementById('register-storage-inputs').style.display = 'none';
            document.getElementById('shift-register-inputs').style.display = 'none';
            document.getElementById('master-slave-inputs').style.display = 'none';
            
            // Show setup time inputs
            document.getElementById('setup-time-inputs').style.display = 'block';
            
            // Clear previous results
            document.getElementById('sequential2-results').innerHTML = '';
            document.getElementById('sequential2-analysis').style.display = 'none';
            
            // Update description
            document.getElementById('sequential2-description').innerHTML = `
                <p><strong>Setup Time Verification</strong></p>
                <p>Verifies that data is stable before the clock edge by checking setup time constraints.</p>
                <p>Inputs:</p>
                <ul>
                    <li>Data arrival times at flip-flop inputs</li>
                    <li>Clock edge arrival times</li>
                    <li>Required setup time for the technology/library</li>
                    <li>Clock period</li>
                </ul>
            `;
        });
    }
    
    if (calculateSetupTimeBtn) {
        calculateSetupTimeBtn.addEventListener('click', function() {
            try {
                // Parse inputs
                const dataTimes = document.getElementById('data-times-input').value
                    .split(',')
                    .map(time => parseFloat(time.trim()))
                    .filter(time => !isNaN(time));
                
                const clockTimes = document.getElementById('clock-times-input').value
                    .split(',')
                    .map(time => parseFloat(time.trim()))
                    .filter(time => !isNaN(time));
                
                const requiredSetup = parseFloat(document.getElementById('setup-time-input').value);
                const clockPeriod = parseFloat(document.getElementById('clock-period-input').value);
                
                // Validate inputs
                if (dataTimes.length === 0 || clockTimes.length === 0) {
                    throw new Error('Please enter valid data and clock times');
                }
                
                if (isNaN(requiredSetup) || requiredSetup < 0) {
                    throw new Error('Please enter a valid positive setup time');
                }
                
                if (isNaN(clockPeriod) || clockPeriod <= 0) {
                    throw new Error('Please enter a valid positive clock period');
                }
                
                // Perform verification
                setupTimeResults = setupTimeVerification(dataTimes, clockTimes, requiredSetup, clockPeriod);
                
                // Display results
                const resultsHTML = createSetupTimeResultsHTML(setupTimeResults);
                document.getElementById('sequential2-results').innerHTML = resultsHTML;
                document.getElementById('sequential2-analysis').style.display = 'block';
                document.getElementById('sequential2-analysis-title').textContent = 'Setup Time Verification Results';
                
                // Add slack histogram
                const histogramContainer = document.getElementById('slack-histogram');
                if (histogramContainer) {
                    histogramContainer.innerHTML = createSlackHistogram(setupTimeResults.slackValues, setupTimeResults.worstSlack);
                }
                
                // Add to log
                addLogEntry(`Setup time verification completed: ${setupTimeResults.status}`, 
                           setupTimeResults.status === 'PASS' ? 'success' : 'error');
                
            } catch (error) {
                alert(`Error: ${error.message}`);
                addLogEntry(`Setup time verification failed: ${error.message}`, 'error');
            }
        });
    }
    
    if (generateRandomTimingBtn) {
        generateRandomTimingBtn.addEventListener('click', function() {
            const clockPeriod = parseFloat(document.getElementById('clock-period-input').value) || 2.0;
            const requiredSetup = parseFloat(document.getElementById('setup-time-input').value) || 0.5;
            
            // Generate random data and clock times
            const numDataPoints = Math.floor(Math.random() * 5) + 3;
            const numClockPoints = Math.floor(Math.random() * 6) + 4;
            
            const dataTimes = [];
            const clockTimes = [];
            
            // Generate clock edges
            for (let i = 0; i < numClockPoints; i++) {
                clockTimes.push(i * clockPeriod + (Math.random() * 0.2 - 0.1));
            }
            
            // Generate data arrival times with some randomness
            for (let i = 0; i < numDataPoints; i++) {
                const baseTime = i * clockPeriod;
                const randomOffset = (Math.random() * 0.8 * clockPeriod) - (0.4 * clockPeriod);
                dataTimes.push(baseTime + randomOffset);
            }
            
            // Sort times
            dataTimes.sort((a, b) => a - b);
            clockTimes.sort((a, b) => a - b);
            
            // Update input fields
            document.getElementById('data-times-input').value = dataTimes.map(t => t.toFixed(2)).join(', ');
            document.getElementById('clock-times-input').value = clockTimes.map(t => t.toFixed(2)).join(', ');
            
            addLogEntry('Generated random timing data for setup time verification', 'info');
        });
    }
    
    if (showExamplesBtn) {
        showExamplesBtn.addEventListener('click', function() {
            const examples = [
                {
                    name: 'Example 1: Perfect Timing',
                    dataTimes: [1.0, 3.0, 5.0, 7.0, 9.0],
                    clockTimes: [2.0, 4.0, 6.0, 8.0, 10.0],
                    setupTime: 0.5,
                    clockPeriod: 2.0
                },
                {
                    name: 'Example 2: With Violations',
                    dataTimes: [1.8, 3.9, 5.8, 7.9, 9.8],
                    clockTimes: [2.0, 4.0, 6.0, 8.0, 10.0],
                    setupTime: 0.5,
                    clockPeriod: 2.0
                },
                {
                    name: 'Example 3: Tight Margin',
                    dataTimes: [1.4, 3.4, 5.4, 7.4, 9.4],
                    clockTimes: [2.0, 4.0, 6.0, 8.0, 10.0],
                    setupTime: 0.5,
                    clockPeriod: 2.0
                }
            ];
            
            let examplesHTML = '<div class="setup-time-step"><h6>Setup Time Examples</h6>';
            
            examples.forEach((example, index) => {
                examplesHTML += `
                    <div class="gate-description mt-2">
                        <h6>${example.name}</h6>
                        <p>Data Times: ${example.dataTimes.join(', ')} ns</p>
                        <p>Clock Times: ${example.clockTimes.join(', ')} ns</p>
                        <p>Required Setup: ${example.setupTime} ns, Clock Period: ${example.clockPeriod} ns</p>
                        <button class="btn-glow btn-sm" onclick="loadSetupTimeExample(${index})">
                            <i class="fas fa-check me-1"></i>Load Example
                        </button>
                    </div>
                `;
            });
            
            examplesHTML += '</div>';
            document.getElementById('sequential2-results').innerHTML = examplesHTML;
            document.getElementById('sequential2-analysis').style.display = 'block';
            document.getElementById('sequential2-analysis-title').textContent = 'Setup Time Verification Examples';
        });
    }
    
    if (closeSetupTimeBtn) {
        closeSetupTimeBtn.addEventListener('click', function() {
            document.getElementById('setup-time-inputs').style.display = 'none';
            document.getElementById('sequential2-results').innerHTML = '';
            document.getElementById('sequential2-analysis').style.display = 'none';
            currentSequential2Component = null;
            
            document.getElementById('sequential2-description').innerHTML = 
                'Select a sequential component to see its operation';
        });
    }
});
function showHoldTimeSection() {
    // Hide all other input sections
    hideAllInputSections('sequential-circuit2-section');
    
    // Show hold time inputs
    document.getElementById('hold-time-inputs').style.display = 'block';
    
    // Update circuit visualization
    document.getElementById('sequential2-circuit-container').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-clock fa-4x" style="color: var(--primary-color);"></i>
            <h4 class="mt-3">Hold Time Verification</h4>
            <p>Enter timing parameters to verify hold time constraints</p>
        </div>
    `;
    
    // Show analysis section
    document.getElementById('sequential2-analysis').style.display = 'block';
    document.getElementById('sequential2-analysis-title').textContent = 'Hold Time Analysis';
    
    // Update description
    document.getElementById('sequential2-description').innerHTML = `
        <strong>Hold Time Verification:</strong> Critical for VLSI design and GATE preparation.<br>
        Hold time is the minimum time data must remain stable AFTER clock edge.<br>
        Violation occurs when data changes too quickly.
    `;
    
    currentHoldTimeTabVisible = true;
}

function hideHoldTimeSection() {
    document.getElementById('hold-time-inputs').style.display = 'none';
    document.getElementById('sequential2-analysis').style.display = 'none';
    document.getElementById('sequential2-description').innerHTML = `
        Select a sequential component to see its operation
    `;
    currentHoldTimeTabVisible = false;
}

function performHoldTimeAnalysis() {
    // Get input values
    const clockPeriod = parseFloat(document.getElementById('hold-clock-period').value);
    const holdTime = parseFloat(document.getElementById('hold-time-value').value);
    const clockToQ = parseFloat(document.getElementById('hold-clock-to-q').value);
    const minDelay = parseFloat(document.getElementById('hold-min-delay').value);
    const clockSkew = parseFloat(document.getElementById('hold-clock-skew').value);
    const jitter = parseFloat(document.getElementById('hold-jitter').value);
    
    // Validate inputs
    if (isNaN(clockPeriod) || isNaN(holdTime) || isNaN(clockToQ) || isNaN(minDelay)) {
        alert('Please enter valid numeric values');
        return;
    }
    
    // Perform hold time analysis
    const analysisResult = calculateHoldTimeMargin({
        clockPeriod,
        holdTime,
        clockToQ,
        minDelay,
        clockSkew,
        jitter
    });
    
    // Display results
    displayHoldTimeResults(analysisResult);
}

function calculateHoldTimeMargin(params) {
    const { clockPeriod, holdTime, clockToQ, minDelay, clockSkew, jitter } = params;
    
    // For hold time analysis (minimum path):
    // Data Arrival Time (earliest) = Launch edge + clock_to_q(min) + comb_delay(min)
    // Required Time = Capture edge + hold_time - clock_skew + jitter
    
    const launchEdge = 0; // Reference time
    const captureEdge = clockPeriod; // Next clock cycle
    
    // Conservative assumptions
    const clockToQMin = clockToQ * 0.8; // 20% variation for minimum
    const minDelayWorst = minDelay * 0.9; // 10% process variation
    
    // Earliest data arrival
    const dataArrivalEarliest = launchEdge + clockToQMin + minDelayWorst;
    
    // Required hold time (worst case for hold)
    // For hold violation: destination clock arrives earlier helps violation
    // So we subtract positive skew, add negative skew
    const requiredHoldTime = captureEdge + holdTime - clockSkew + jitter;
    
    // Calculate margin
    const holdMargin = dataArrivalEarliest - requiredHoldTime;
    
    // Check for violation
    const hasViolation = holdMargin < 0;
    
    return {
        dataArrivalEarliest: dataArrivalEarliest.toFixed(2),
        requiredHoldTime: requiredHoldTime.toFixed(2),
        holdMargin: holdMargin.toFixed(2),
        hasViolation,
        violationMessage: hasViolation ? 
            `HOLD VIOLATION: Margin = ${holdMargin.toFixed(2)}ns (negative)` :
            `No violation: Margin = ${holdMargin.toFixed(2)}ns`,
        parameters: params
    };
}

function displayHoldTimeResults(result) {
    const stepsContainer = document.getElementById('sequential2-steps-container');
    
    stepsContainer.innerHTML = `
        <div class="special-analysis-step active">
            <div class="calculation-title">Hold Time Analysis Results</div>
            <div class="calculation-content">
                <p><strong>Timing Parameters:</strong></p>
                <ul>
                    <li>Clock Period: ${result.parameters.clockPeriod} ns</li>
                    <li>Hold Time: ${result.parameters.holdTime} ns</li>
                    <li>Clock-to-Q Delay: ${result.parameters.clockToQ} ns</li>
                    <li>Min Combinational Delay: ${result.parameters.minDelay} ns</li>
                    <li>Clock Skew: ${result.parameters.clockSkew} ns</li>
                    <li>Jitter: ${result.parameters.jitter} ns</li>
                </ul>
            </div>
        </div>
        
        <div class="special-analysis-step ${result.hasViolation ? 'error' : 'active'}">
            <div class="calculation-title">Calculation Steps</div>
            <div class="calculation-content">
                <p>1. Earliest Data Arrival = Launch Edge + Clock-to-Q(min) + Combinational Delay(min)</p>
                <p>   = 0 + (${result.parameters.clockToQ}  0.8) + (${result.parameters.minDelay}  0.9)</p>
                <p>   = <strong>${result.dataArrivalEarliest} ns</strong></p>
                
                <p>2. Required Hold Time = Capture Edge + Hold Time - Clock Skew + Jitter</p>
                <p>   = ${result.parameters.clockPeriod} + ${result.parameters.holdTime} - ${result.parameters.clockSkew} + ${result.parameters.jitter}</p>
                <p>   = <strong>${result.requiredHoldTime} ns</strong></p>
                
                <p>3. Hold Margin = Data Arrival - Required Time</p>
                <p>   = ${result.dataArrivalEarliest} - ${result.requiredHoldTime}</p>
                <p>   = <strong>${result.holdMargin} ns</strong></p>
            </div>
        </div>
        
        <div class="special-analysis-step ${result.hasViolation ? 'error' : ''}">
            <div class="calculation-title">Analysis Result</div>
            <div class="calculation-content">
                <p><strong>${result.violationMessage}</strong></p>
                ${result.hasViolation ? `
                    <p class="text-danger"> HOLD TIME VIOLATION DETECTED!</p>
                    <p>Data changes too quickly after the clock edge.</p>
                ` : `
                    <p class="text-success"> No Hold Time Violation</p>
                    <p>Data remains stable for sufficient time after clock edge.</p>
                `}
            </div>
        </div>
        
        ${result.hasViolation ? `
        <div class="special-analysis-step">
            <div class="calculation-title">Suggested Fixes for Hold Violation</div>
            <div class="calculation-content">
                <p>To fix hold violations (data changes too fast):</p>
                <ol>
                    <li><strong>Add delay buffers</strong> in data path: Add ${Math.abs(result.holdMargin).toFixed(2)} ns delay</li>
                    <li><strong>Increase clock latency</strong> at destination register</li>
                    <li><strong>Use flip-flops with larger clock-to-Q delay</strong></li>
                    <li><strong>Adjust clock tree</strong> to reduce negative skew</li>
                </ol>
            </div>
        </div>
        ` : ''}
        
        <div class="special-analysis-step">
            <div class="calculation-title">Key Concept for GATE Exam</div>
            <div class="calculation-content">
                <p><strong>Hold Time Constraint:</strong> T_data_arrival(min)  T_clock_arrival + T_hold</p>
                <p><strong>Hold Check:</strong> Same clock edge (unlike setup which checks next edge)</p>
                <p><strong>Hold Violation:</strong> Data changes too FAST after clock edge</p>
                <p><strong>Setup Violation:</strong> Data changes too SLOW before next clock edge</p>
                <p>Minimum delay paths cause hold issues; Maximum delay paths cause setup issues</p>
            </div>
        </div>
    `;
    
    // Update result display
    document.getElementById('sequential2-result').textContent = result.holdMargin + ' ns';
    document.getElementById('sequential2-next-result').textContent = result.hasViolation ? 'Violation' : 'OK';
    
    // Log the operation
    addLogEntry(`Hold time analysis: ${result.violationMessage}`, 
                result.hasViolation ? 'log-error' : 'log-success');
}

function generateHoldTimeExamples() {
    const examples = [
        {
            title: "Example 1: Normal Case (No Violation)",
            clockPeriod: 10,
            holdTime: 1,
            clockToQ: 3,
            minDelay: 5,
            clockSkew: 0.5,
            jitter: 0.2
        },
        {
            title: "Example 2: Hold Violation (Short Path)",
            clockPeriod: 10,
            holdTime: 1,
            clockToQ: 2,
            minDelay: 1,
            clockSkew: -0.5,
            jitter: 0.2
        },
        {
            title: "Example 3: Critical Case (Zero Margin)",
            clockPeriod: 8,
            holdTime: 1.5,
            clockToQ: 2.5,
            minDelay: 2,
            clockSkew: 0,
            jitter: 0.1
        }
    ];
    
    const stepsContainer = document.getElementById('sequential2-steps-container');
    
    let examplesHTML = `
        <div class="special-analysis-step active">
            <div class="calculation-title">Hold Time Analysis Examples</div>
            <div class="calculation-content">
                <p>Click any example to load its parameters:</p>
    `;
    
    examples.forEach((example, index) => {
        examplesHTML += `
            <div class="special-example mt-2">
                <div class="special-example-title">${example.title}</div>
                <div class="small">
                    Clock: ${example.clockPeriod}ns, Hold: ${example.holdTime}ns, 
                    Clock-to-Q: ${example.clockToQ}ns, Min Delay: ${example.minDelay}ns,
                    Skew: ${example.clockSkew}ns, Jitter: ${example.jitter}ns
                </div>
                <button class="btn-glow btn-sm mt-1" onclick="loadHoldTimeExample(${index})">
                    Load Example
                </button>
            </div>
        `;
    });
    
    examplesHTML += `</div></div>`;
    
    stepsContainer.innerHTML = examplesHTML;
}

function loadHoldTimeExample(index) {
    const examples = [
        {
            clockPeriod: 10,
            holdTime: 1,
            clockToQ: 3,
            minDelay: 5,
            clockSkew: 0.5,
            jitter: 0.2
        },
        {
            clockPeriod: 10,
            holdTime: 1,
            clockToQ: 2,
            minDelay: 1,
            clockSkew: -0.5,
            jitter: 0.2
        },
        {
            clockPeriod: 8,
            holdTime: 1.5,
            clockToQ: 2.5,
            minDelay: 2,
            clockSkew: 0,
            jitter: 0.1
        }
    ];
    
    const example = examples[index];
    
    // Set input values
    document.getElementById('hold-clock-period').value = example.clockPeriod;
    document.getElementById('hold-time-value').value = example.holdTime;
    document.getElementById('hold-clock-to-q').value = example.clockToQ;
    document.getElementById('hold-min-delay').value = example.minDelay;
    document.getElementById('hold-clock-skew').value = example.clockSkew;
    document.getElementById('hold-jitter').value = example.jitter;
    
    // Perform analysis with these values
    performHoldTimeAnalysis();
}

function showHoldTimeFormulas() {
    const stepsContainer = document.getElementById('sequential2-steps-container');
    
    stepsContainer.innerHTML = `
        <div class="special-analysis-step active">
            <div class="calculation-title">Hold Time Formulas for GATE Exam</div>
            <div class="calculation-content">
                <p><strong>1. Hold Time Constraint:</strong></p>
                <p>T_data_arrival(min)  T_clock_arrival + T_hold</p>
                
                <p><strong>2. Earliest Data Arrival Time:</strong></p>
                <p>T_launch + T_clk_to_q(min) + T_comb(min)</p>
                
                <p><strong>3. Required Hold Time (worst case):</strong></p>
                <p>T_capture + T_hold - T_skew + T_jitter</p>
                <small>Note: Positive skew helps hold, negative skew hurts hold</small>
                
                <p><strong>4. Hold Margin Calculation:</strong></p>
                <p>Margin = T_data_arrival - T_required</p>
                <p>Positive: No violation, Negative: Violation</p>
                
                <p><strong>5. Key Differences from Setup Time:</strong></p>
                <ul>
                    <li>Hold: Same clock edge, Setup: Next clock edge</li>
                    <li>Hold: Minimum delays, Setup: Maximum delays</li>
                    <li>Hold: Data too fast, Setup: Data too slow</li>
                    <li>Hold: Fixed by adding delay, Setup: Fixed by reducing delay</li>
                </ul>
                
                <p><strong>6. Common GATE Exam Questions:</strong></p>
                <ul>
                    <li>Which path causes hold violation?  Minimum delay path</li>
                    <li>How to fix hold violation?  Add delay buffers</li>
                    <li>Effect of clock skew on hold?  Positive skew helps, negative hurts</li>
                </ul>
            </div>
        </div>
        
        <div class="special-analysis-step">
            <div class="calculation-title">Memory Aid for GATE</div>
            <div class="calculation-content">
                <p><strong>HOLD = FAST = MINIMUM</strong></p>
                <p> Hold violation = Data changes too <strong>FAST</strong></p>
                <p> Caused by <strong>MINIMUM</strong> delay paths</p>
                <p> Checked at <strong>SAME</strong> clock edge</p>
                <p> Fixed by making path <strong>SLOWER</strong> (add delay)</p>
                
                <p><strong>SETUP = SLOW = MAXIMUM</strong></p>
                <p> Setup violation = Data changes too <strong>SLOW</strong></p>
                <p> Caused by <strong>MAXIMUM</strong> delay paths</p>
                <p> Checked at <strong>NEXT</strong> clock edge</p>
                <p> Fixed by making path <strong>FASTER</strong> (reduce delay)</p>
            </div>
        </div>
    `;
}

// Helper function to hide all input sections
function hideAllInputSections(parentId) {
    const parent = document.getElementById(parentId);
    const inputSections = parent.querySelectorAll('.gate-description > div[id$="-inputs"]');
    inputSections.forEach(section => {
        if (section.id !== 'hold-time-inputs') {
            section.style.display = 'none';
        }
    });
}
// PLA Programming JavaScript
// PLA Programming JavaScript - Enhanced Version
document.addEventListener('DOMContentLoaded', function() {
    // PLA section elements
    const plaSection = document.getElementById('pla-programming-section');
    const plaMintermsInput = document.getElementById('pla-minterms-input');
    const plaBooleanInput = document.getElementById('pla-boolean-input');
    const plaMintermsRadio = document.getElementById('pla-minterms');
    const plaBooleanRadio = document.getElementById('pla-boolean');
    const plaMintermsValue = document.getElementById('pla-minterms-value');
    const plaBooleanValue = document.getElementById('pla-boolean-value');
    const plaVariablesCount = document.getElementById('pla-variables-count');
    const plaMultipleOutputs = document.getElementById('pla-multiple-outputs');
    const plaAddFunctionDiv = document.getElementById('pla-add-function-div');
    const plaFunctionsContainer = document.getElementById('pla-functions-container');
    const plaGenerateBtn = document.getElementById('pla-generate-btn');
    const plaShowKmapBtn = document.getElementById('pla-show-kmap-btn');
    const plaShowTableBtn = document.getElementById('pla-show-table-btn');
    const plaResetBtn = document.getElementById('pla-reset-btn');
    
    // Variables for storing current state
    let currentVariables = 3;
    let currentProductTerms = [];
    let currentFunctions = [];
    let simplifiedExpression = ''; // Add this to store simplified expression

    // Input type toggle
    plaMintermsRadio.addEventListener('change', function() {
        plaMintermsInput.style.display = 'block';
        plaBooleanInput.style.display = 'none';
        updatePLAStats();
    });
    
    plaBooleanRadio.addEventListener('change', function() {
        plaMintermsInput.style.display = 'none';
        plaBooleanInput.style.display = 'block';
        updatePLAStats();
    });
    
    // Multiple outputs toggle
    plaMultipleOutputs.addEventListener('change', function() {
        if (this.checked) {
            plaAddFunctionDiv.style.display = 'block';
            plaFunctionsContainer.style.display = 'block';
        } else {
            plaAddFunctionDiv.style.display = 'none';
            plaFunctionsContainer.style.display = 'none';
        }
        updatePLAStats();
    });
    
    // Variables count change
    plaVariablesCount.addEventListener('change', function() {
        currentVariables = parseInt(this.value);
        updatePLAStats();
        // Update example placeholders
        updateExamplePlaceholders();
    });
    
    // Update example placeholders based on variable count
    function updateExamplePlaceholders() {
        const varCount = parseInt(plaVariablesCount.value);
        let mintermExample = '';
        let exprExample = '';
        const vars = ['A', 'B', 'C', 'D'].slice(0, varCount);
        
        switch(varCount) {
            case 2:
                mintermExample = '0,1,3';
                exprExample = "A'B + AB'";
                break;
            case 3:
                mintermExample = '0,1,2,5,6,7';
                exprExample = "A'B' + AB'C + BC'";
                break;
            case 4:
                mintermExample = '0,1,2,5,6,7,8,9,10,13,14,15';
                exprExample = "A'B'C' + AB'CD + A'BCD'";
                break;
        }
        
        plaMintermsValue.placeholder = `e.g., ${mintermExample} (0 to ${Math.pow(2, varCount)-1})`;
        plaBooleanValue.placeholder = `e.g., ${exprExample} (Use ${vars.join(', ')} and operators +, *, ')`;
    }
    
    // Add function button
    document.getElementById('pla-add-function-btn').addEventListener('click', function() {
        const functionCount = plaFunctionsContainer.children.length + 2; // Start from F2
        
        const functionDiv = document.createElement('div');
        functionDiv.className = 'gate-description mt-2';
        functionDiv.innerHTML = `
            <label for="pla-function-${functionCount}">Function F${functionCount}:</label>
            <div class="input-group mt-1">
                <input type="text" id="pla-function-${functionCount}" class="form-control pla-function-input" 
                       placeholder="Enter minterms or expression for F${functionCount}">
                <button class="btn btn-outline-danger remove-function-btn" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Add change listener to new input
        const input = functionDiv.querySelector('.pla-function-input');
        input.addEventListener('input', updatePLAStats);
        input.addEventListener('change', function() {
            if (plaMintermsRadio.checked) {
                validateMinterms(this.value, currentVariables);
            }
        });
        
        functionDiv.querySelector('.remove-function-btn').addEventListener('click', function() {
            functionDiv.remove();
            updatePLAStats();
        });
        
        plaFunctionsContainer.appendChild(functionDiv);
        updateExamplePlaceholders();
        updatePLAStats();
    });
    
    // Generate PLA Design
    plaGenerateBtn.addEventListener('click', generatePLADesign);
    
    // Show K-map
    plaShowKmapBtn.addEventListener('click', showPLAKmap);
    
    // Show Program Table
    plaShowTableBtn.addEventListener('click', showPLAProgramTable);
    
    // Reset PLA
    plaResetBtn.addEventListener('click', resetPLA);
    
    // Update PLA stats when inputs change
    plaMintermsValue.addEventListener('input', updatePLAStats);
    plaBooleanValue.addEventListener('input', updatePLAStats);
    
    // Initialize with 3 variables example
    updateExamplePlaceholders();
    
    // Validation functions
    function validateMinterms(mintermsStr, varCount) {
        if (!mintermsStr.trim()) return true;
        
        const minterms = mintermsStr.split(',').map(m => m.trim()).filter(m => m !== '');
        const maxMinterm = Math.pow(2, varCount) - 1;
        
        for (let m of minterms) {
            const num = parseInt(m);
            if (isNaN(num) || num < 0 || num > maxMinterm) {
                alert(`Invalid minterm ${m}. For ${varCount} variables, minterms must be between 0 and ${maxMinterm}`);
                return false;
            }
        }
        return true;
    }
    
    function validateBooleanExpression(expr, varCount) {
        if (!expr.trim()) return true;
        
        const validVars = ['A', 'B', 'C', 'D'].slice(0, varCount);
        const validVarPattern = new RegExp(`^[${validVars.join('')}]'?$`);
        
        // Check for invalid variables
        const varsInExpr = expr.match(/[A-D]/g) || [];
        for (let v of varsInExpr) {
            if (!validVars.includes(v)) {
                alert(`Invalid variable ${v}. For ${varCount} variables, use only ${validVars.join(', ')}`);
                return false;
            }
        }
        
        return true;
    }
    
    function updatePLAStats() {
        const varCount = parseInt(plaVariablesCount.value);
        currentVariables = varCount;
        
        const outputsCount = plaMultipleOutputs.checked ? 
            (plaFunctionsContainer.children.length + 1) : 1;
        
        document.getElementById('pla-inputs-count').textContent = varCount;
        document.getElementById('pla-outputs-count').textContent = outputsCount;
        
        // Calculate product terms based on input
        let productTerms = 0;
        if (plaMintermsRadio.checked) {
            const minterms = plaMintermsValue.value.trim();
            if (minterms) {
                if (!validateMinterms(minterms, varCount)) return;
                const terms = minterms.split(',').filter(t => t.trim() !== '');
                productTerms = Math.min(terms.length, 2 ** varCount);
                currentProductTerms = terms.map(t => parseInt(t.trim()));
            }
        } else {
            const expr = plaBooleanValue.value.trim();
            if (expr) {
                if (!validateBooleanExpression(expr, varCount)) return;
                // Count product terms in expression
                const terms = expr.split('+').filter(t => t.trim() !== '');
                productTerms = Math.min(terms.length, 2 ** varCount);
                currentProductTerms = terms;
            }
        }
        
        document.getElementById('pla-products-count').textContent = productTerms;
        document.getElementById('pla-size').textContent = `${productTerms}${outputsCount}`;
    }
    
    
    function generatePLADesign() {
        const varCount = parseInt(plaVariablesCount.value);
        const variables = ['A', 'B', 'C', 'D'].slice(0, varCount);
        
        // Validate main function
        let mainFunction = '';
        if (plaMintermsRadio.checked) {
            mainFunction = plaMintermsValue.value.trim();
            if (!validateMinterms(mainFunction, varCount)) return;
        } else {
            mainFunction = plaBooleanValue.value.trim();
            if (!validateBooleanExpression(mainFunction, varCount)) return;
        }
        
        if (!mainFunction) {
            alert('Please enter minterms or boolean expression');
            return;
        }
        
        // Generate simplified expression first
        simplifiedExpression = simplifyExpression(mainFunction, varCount);
        
        // Update K-map with simplified expression display
        generatePLAKmap(varCount, mainFunction);
        
        // Get additional functions if multiple outputs
        currentFunctions = [];
        currentFunctions.push({name: 'F1', expression: simplifiedExpression}); // Use simplified expression
        
        if (plaMultipleOutputs.checked) {
            const functionInputs = plaFunctionsContainer.querySelectorAll('.pla-function-input');
            functionInputs.forEach((input, index) => {
                const expr = input.value.trim();
                if (expr) {
                    const funcSimplifiedExpr = simplifyExpression(expr, varCount);
                    currentFunctions.push({
                        name: `F${index + 2}`,
                        expression: funcSimplifiedExpr // Use simplified expression
                    });
                }
            });
        }
        
        // Generate program table based on simplified expression
        generatePLAProgramTable(variables, currentFunctions);
        
        // Generate PLA diagram based on simplified expression
        generatePLADiagram(variables, currentFunctions);
        
        // Show steps
        for (let i = 1; i <= 5; i++) {
            const step = document.getElementById(`pla-step${i}`);
            if (step) {
                step.style.display = 'block';
                setTimeout(() => {
                    step.classList.add('active');
                }, i * 300);
            }
        }
        
        updatePLAStats();
    }

 function generatePLAKmap(varCount, expression) {
        const kmapContent = document.getElementById('pla-kmap-content');
        kmapContent.innerHTML = '';
        
        // Generate truth table first
        const truthTable = generateTruthTable(varCount, expression);
        
        let kmapHTML = '';
        if (varCount === 2) {
            kmapHTML = generate2VarKmap(truthTable);
        } else if (varCount === 3) {
            kmapHTML = generate3VarKmap(truthTable);
        } else if (varCount === 4) {
            kmapHTML = generate4VarKmap(truthTable);
        }
        
        kmapContent.innerHTML = kmapHTML;
        document.getElementById('pla-kmap-container').style.display = 'block';
        
        // Generate simplified expression
        simplifiedExpression = simplifyExpression(expression, varCount);
        document.getElementById('pla-simplified-expression').textContent = 
            `Simplified Expression: F = ${simplifiedExpression}`;
    }
    
    function generateTruthTable(varCount, expression) {
        const table = [];
        const maxRows = Math.pow(2, varCount);
        
        if (plaMintermsRadio.checked) {
            // Parse minterms
            const minterms = expression.split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m));
            
            for (let i = 0; i < maxRows; i++) {
                table.push(minterms.includes(i) ? 1 : 0);
            }
        } else {
            // Parse boolean expression
            // This is a simplified evaluation - in production, you'd use a proper parser
            for (let i = 0; i < maxRows; i++) {
                // Convert i to binary and assign to variables
                const binary = i.toString(2).padStart(varCount, '0');
                const vars = {};
                const varNames = ['A', 'B', 'C', 'D'];
                
                for (let j = 0; j < varCount; j++) {
                    vars[varNames[j]] = parseInt(binary[j]);
                }
                
                // Simple evaluation (handles basic expressions)
                let result = 0;
                const terms = expression.split('+').map(t => t.trim());
                
                for (let term of terms) {
                    let termResult = 1;
                    const factors = term.split('*').map(f => f.trim());
                    
                    for (let factor of factors) {
                        let varName = factor.replace("'", '');
                        let complement = factor.endsWith("'");
                        
                        if (vars.hasOwnProperty(varName)) {
                            let value = vars[varName];
                            if (complement) value = value === 0 ? 1 : 0;
                            termResult = termResult && value;
                        }
                    }
                    
                    if (termResult) {
                        result = 1;
                        break;
                    }
                }
                
                table.push(result);
            }
        }
        
        return table;
    }
    
    function generate2VarKmap(truthTable) {
        return `
            <table class="kmap-table" style="margin: 0 auto; border-collapse: collapse;">
                <tr>
                    <th style="border: 2px solid #333; padding: 10px;"></th>
                    <th style="border: 2px solid #333; padding: 10px;">B=0</th>
                    <th style="border: 2px solid #333; padding: 10px;">B=1</th>
                </tr>
                <tr>
                    <th style="border: 2px solid #333; padding: 10px;">A=0</th>
                    <td class="${truthTable[0] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[0]}</td>
                    <td class="${truthTable[1] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[1]}</td>
                </tr>
                <tr>
                    <th style="border: 2px solid #333; padding: 10px;">A=1</th>
                    <td class="${truthTable[2] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[2]}</td>
                    <td class="${truthTable[3] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[3]}</td>
                </tr>
            </table>
        `;
    }
    
    function generate3VarKmap(truthTable) {
        // Gray code ordering for 3 variables
        const order = [0, 1, 3, 2];
        return `
            <table class="kmap-table" style="margin: 0 auto; border-collapse: collapse;">
                <tr>
                    <th style="border: 2px solid #333; padding: 10px;"></th>
                    <th style="border: 2px solid #333; padding: 10px;">BC=00</th>
                    <th style="border: 2px solid #333; padding: 10px;">BC=01</th>
                    <th style="border: 2px solid #333; padding: 10px;">BC=11</th>
                    <th style="border: 2px solid #333; padding: 10px;">BC=10</th>
                </tr>
                <tr>
                    <th style="border: 2px solid #333; padding: 10px;">A=0</th>
                    <td class="${truthTable[0] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[0]}</td>
                    <td class="${truthTable[1] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[1]}</td>
                    <td class="${truthTable[3] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[3]}</td>
                    <td class="${truthTable[2] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[2]}</td>
                </tr>
                <tr>
                    <th style="border: 2px solid #333; padding: 10px;">A=1</th>
                    <td class="${truthTable[4] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[4]}</td>
                    <td class="${truthTable[5] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[5]}</td>
                    <td class="${truthTable[7] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[7]}</td>
                    <td class="${truthTable[6] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[6]}</td>
                </tr>
            </table>
        `;
    }
    
    function generate4VarKmap(truthTable) {
        // Gray code ordering for 4 variables
        const rowOrder = [0, 1, 3, 2];
        const colOrder = [0, 1, 3, 2];
        
        let html = `
            <table class="kmap-table" style="margin: 0 auto; border-collapse: collapse;">
                <tr>
                    <th style="border: 2px solid #333; padding: 10px;"></th>
                    <th style="border: 2px solid #333; padding: 10px;">CD=00</th>
                    <th style="border: 2px solid #333; padding: 10px;">CD=01</th>
                    <th style="border: 2px solid #333; padding: 10px;">CD=11</th>
                    <th style="border: 2px solid #333; padding: 10px;">CD=10</th>
                </tr>
        `;
        
        for (let i = 0; i < 4; i++) {
            html += `<tr><th style="border: 2px solid #333; padding: 10px;">AB=${rowOrder[i].toString(2).padStart(2, '0')}</th>`;
            for (let j = 0; j < 4; j++) {
                const index = rowOrder[i] * 4 + colOrder[j];
                html += `<td class="${truthTable[index] ? 'active' : 'inactive'}" style="border: 2px solid #333; padding: 15px; text-align: center;">${truthTable[index]}</td>`;
            }
            html += '</tr>';
        }
        
        html += '</table>';
        return html;
    }
    
    function generatePLAProgramTable(variables, functions) {
        const table = document.getElementById('pla-program-table');
        table.innerHTML = '';
        
        // Create header
        let headerHTML = '<thead><tr style="background-color: #f8f9fa;"><th style="padding: 10px; border: 1px solid #dee2e6;">Inputs</th><th style="padding: 10px; border: 1px solid #dee2e6;">Product Terms</th>';
        functions.forEach(func => {
            headerHTML += `<th style="padding: 10px; border: 1px solid #dee2e6;">${func.name}</th>`;
        });
        headerHTML += '</tr><tr style="background-color: #e9ecef;"><th style="padding: 10px; border: 1px solid #dee2e6;">' + variables.join('') + '</th><th style="padding: 10px; border: 1px solid #dee2e6;"></th>';
        functions.forEach(() => {
            headerHTML += '<th style="padding: 10px; border: 1px solid #dee2e6;"></th>';
        });
        headerHTML += '</tr></thead>';
        
        // Generate product terms from SIMPLIFIED expressions
        const varCount = variables.length;
        const allProductTerms = [];
        
        functions.forEach(func => {
            const terms = generateProductTermsFromExpression(func.expression, varCount);
            terms.forEach(term => {
                // Check if this product term already exists
                const existingTerm = allProductTerms.find(t => 
                    JSON.stringify(t.inputs) === JSON.stringify(term.inputs)
                );
                
                if (existingTerm) {
                    // Add this function's output to existing term
                    existingTerm.outputs[func.name] = 1;
                } else {
                    // Create new term
                    const newTerm = {
                        inputs: term.inputs,
                        outputs: { [func.name]: 1 }
                    };
                    allProductTerms.push(newTerm);
                }
            });
        });
        
        // Create body with product terms from simplified expressions
        let bodyHTML = '<tbody>';
        allProductTerms.forEach((term, idx) => {
            bodyHTML += `<tr><td style="padding: 10px; border: 1px solid #dee2e6; font-family: monospace;">${term.inputs.join('')}</td>`;
            bodyHTML += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">P${idx + 1}</td>`;
            
            functions.forEach((func) => {
                const output = term.outputs[func.name] || 0;
                bodyHTML += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; background-color: ${output ? '#d4edda' : '#f8d7da'};">
                    ${output ? '1' : '0'}
                </td>`;
            });
            
            bodyHTML += '</tr>';
        });
        bodyHTML += '</tbody>';
        
        table.innerHTML = headerHTML + bodyHTML;
        document.getElementById('pla-table-container').style.display = 'block';
    }

    // NEW FUNCTION: Generate product terms from simplified expression
    function generateProductTermsFromExpression(expression, varCount) {
        const terms = [];
        
        if (!expression || expression === '0') {
            return terms;
        }
        
        if (expression === '1') {
            // For expression = 1, create a single term with all dashes
            const inputs = Array(varCount).fill('-');
            terms.push({ inputs: inputs });
            return terms;
        }
        
        // Split by '+' for SOP form
        const productExpressions = expression.split('+').map(t => t.trim()).filter(t => t !== '');
        
        productExpressions.forEach(prod => {
            const inputs = Array(varCount).fill('-');
            const vars = ['A', 'B', 'C', 'D'];
            
            for (let i = 0; i < varCount; i++) {
                const varName = vars[i];
                // Check for variable or its complement
                if (prod.includes(varName + "'")) {
                    inputs[i] = '0'; // Complement
                } else if (prod.includes(varName)) {
                    inputs[i] = '1'; // Variable
                }
            }
            
            terms.push({ inputs: inputs });
        });
        
        return terms;
    }

    
    function generateProductTerms(expression, varCount) {
        const terms = [];
        const maxMinterm = Math.pow(2, varCount) - 1;
        
        if (plaMintermsRadio.checked) {
            // Convert minterms to product terms
            const minterms = expression.split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m));
            
            // Group minterms to reduce product terms
            const grouped = groupMinterms(minterms, varCount);
            
            grouped.forEach((group, idx) => {
                const inputs = [];
                for (let i = 0; i < varCount; i++) {
                    if (group.mask & (1 << i)) {
                        inputs.push('-');
                    } else {
                        const bit = (group.value >> i) & 1;
                        inputs.push(bit.toString());
                    }
                }
                inputs.reverse(); // For correct variable order
                
                terms.push({
                    inputs: inputs,
                    outputs: { 'F1': 1 }
                });
            });
        } else {
            // Convert boolean expression to product terms
            const productExpressions = expression.split('+').map(t => t.trim()).filter(t => t !== '');
            
            productExpressions.forEach((prod, idx) => {
                const inputs = [];
                const vars = ['A', 'B', 'C', 'D'];
                
                for (let i = 0; i < varCount; i++) {
                    const varName = vars[i];
                    const varPattern = new RegExp(varName + "'?", 'g');
                    const matches = prod.match(varPattern);
                    
                    if (matches) {
                        if (matches[0].endsWith("'")) {
                            inputs.push('0');
                        } else {
                            inputs.push('1');
                        }
                    } else {
                        inputs.push('-');
                    }
                }
                
                terms.push({
                    inputs: inputs,
                    outputs: { 'F1': 1 }
                });
            });
        }
        
        return terms;
    }
    
    function groupMinterms(minterms, varCount) {
        // Simplified grouping algorithm
        const groups = [];
        
        // Start with individual minterms
        minterms.forEach(m => {
            groups.push({
                value: m,
                mask: 0,
                minterms: [m]
            });
        });
        
        // Try to combine groups
        const combined = [];
        const used = new Set();
        
        for (let i = 0; i < groups.length; i++) {
            for (let j = i + 1; j < groups.length; j++) {
                const diff = groups[i].value ^ groups[j].value;
                if ((diff & (diff - 1)) === 0) { // Power of 2 (differ by one bit)
                    const bitPos = Math.log2(diff);
                    const newMask = groups[i].mask | (1 << bitPos);
                    const newValue = groups[i].value & ~(1 << bitPos);
                    
                    combined.push({
                        value: newValue,
                        mask: newMask,
                        minterms: [...groups[i].minterms, ...groups[j].minterms]
                    });
                    used.add(i);
                    used.add(j);
                }
            }
        }
        
        // Add groups that couldn't be combined
        for (let i = 0; i < groups.length; i++) {
            if (!used.has(i)) {
                combined.push(groups[i]);
            }
        }
        
        return combined;
    }
function generatePLADiagram(variables, functions) {
    const circuitDiagram = document.getElementById('pla-circuit-diagram');
    circuitDiagram.innerHTML = '';
    
    const varCount = variables.length;
    const funcCount = functions.length;
    
    // Generate product terms from SIMPLIFIED expressions
    const allProductTerms = [];
    functions.forEach(func => {
        const terms = generateProductTermsFromExpression(func.expression, varCount);
        terms.forEach(term => {
            const existingTerm = allProductTerms.find(t => 
                JSON.stringify(t.inputs) === JSON.stringify(term.inputs)
            );
            
            if (existingTerm) {
                existingTerm.outputs = { ...existingTerm.outputs, [func.name]: 1 };
            } else {
                allProductTerms.push({
                    inputs: term.inputs,
                    outputs: { [func.name]: 1 }
                });
            }
        });
    });
    
    const productTermsCount = allProductTerms.length;
    
    // Create SVG container
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("width", "1000");
    svg.setAttribute("height", "700");
    svg.setAttribute("viewBox", "0 0 1000 700");
    svg.style.backgroundColor = "#f8f9fa";
    
    // Title - Updated to mention simplified expression
    const title = document.createElementNS(svgNS, "text");
    title.setAttribute("x", "500");
    title.setAttribute("y", "40");
    title.setAttribute("text-anchor", "middle");
    title.setAttribute("font-size", "24");
    title.setAttribute("font-weight", "bold");
    title.setAttribute("fill", "#2c3e50");
    title.textContent = "PLA Circuit Diagram (Based on Simplified Expression)";
    svg.appendChild(title);
    
    // Add simplified expression display
    if (functions.length > 0 && functions[0].expression) {
        const exprText = document.createElementNS(svgNS, "text");
        exprText.setAttribute("x", "500");
        exprText.setAttribute("y", "70");
        exprText.setAttribute("text-anchor", "middle");
        exprText.setAttribute("font-size", "14");
        exprText.setAttribute("fill", "#27ae60");
        exprText.setAttribute("font-weight", "bold");
        exprText.textContent = `Simplified: ${functions.map(f => `${f.name} = ${f.expression}`).join(', ')}`;
        svg.appendChild(exprText);
    }
    
    // ========== INPUT SECTION ==========
    // Draw input lines
    for (let i = 0; i < varCount; i++) {
        const yStart = 100;
        const yEnd = 600;
        const xPos = 100 + i * 80;
        
        // Variable line
        const varLine = document.createElementNS(svgNS, "line");
        varLine.setAttribute("x1", xPos);
        varLine.setAttribute("y1", yStart);
        varLine.setAttribute("x2", xPos);
        varLine.setAttribute("y2", yEnd);
        varLine.setAttribute("stroke", "#2c3e50");
        varLine.setAttribute("stroke-width", "3");
        varLine.setAttribute("stroke-linecap", "round");
        svg.appendChild(varLine);
        
        // Variable label
        const varLabel = document.createElementNS(svgNS, "text");
        varLabel.setAttribute("x", xPos);
        varLabel.setAttribute("y", yStart - 20);
        varLabel.setAttribute("text-anchor", "middle");
        varLabel.setAttribute("font-size", "18");
        varLabel.setAttribute("font-weight", "bold");
        varLabel.setAttribute("fill", "#2c3e50");
        varLabel.textContent = variables[i];
        svg.appendChild(varLabel);
        
        // Complement line
        const compLine = document.createElementNS(svgNS, "line");
        compLine.setAttribute("x1", xPos + 40);
        compLine.setAttribute("y1", yStart);
        compLine.setAttribute("x2", xPos + 40);
        compLine.setAttribute("y2", yEnd);
        compLine.setAttribute("stroke", "#7f8c8d");
        compLine.setAttribute("stroke-width", "2");
        compLine.setAttribute("stroke-dasharray", "4,4");
        compLine.setAttribute("stroke-linecap", "round");
        svg.appendChild(compLine);
        
        // Complement label
        const compLabel = document.createElementNS(svgNS, "text");
        compLabel.setAttribute("x", xPos + 40);
        compLabel.setAttribute("y", yStart - 20);
        compLabel.setAttribute("text-anchor", "middle");
        compLabel.setAttribute("font-size", "18");
        compLabel.setAttribute("font-weight", "bold");
        compLabel.setAttribute("fill", "#7f8c8d");
        compLabel.textContent = variables[i] + "'";
        svg.appendChild(compLabel);
    }
    
    // ========== AND ARRAY ==========
    const andArrayX = 300;
    const andArrayWidth = 200;
    
    // AND array boundary
    const andArrayRect = document.createElementNS(svgNS, "rect");
    andArrayRect.setAttribute("x", andArrayX);
    andArrayRect.setAttribute("y", 100);
    andArrayRect.setAttribute("width", andArrayWidth);
    andArrayRect.setAttribute("height", 500);
    andArrayRect.setAttribute("fill", "rgba(52, 152, 219, 0.1)");
    andArrayRect.setAttribute("stroke", "#3498db");
    andArrayRect.setAttribute("stroke-width", "3");
    svg.appendChild(andArrayRect);
    
    // AND array label
    const andLabel = document.createElementNS(svgNS, "text");
    andLabel.setAttribute("x", andArrayX + andArrayWidth/2);
    andLabel.setAttribute("y", 80);
    andLabel.setAttribute("text-anchor", "middle");
    andLabel.setAttribute("font-size", "20");
    andLabel.setAttribute("font-weight", "bold");
    andLabel.setAttribute("fill", "#2980b9");
    andLabel.textContent = "AND ARRAY";
    svg.appendChild(andLabel);
    
    // Draw product term lines based on simplified expression
    for (let i = 0; i < productTermsCount; i++) {
        const yPos = 150 + i * 60;
        
        // Product term line (SIMPLIFIED)
        const termLine = document.createElementNS(svgNS, "line");
        termLine.setAttribute("x1", andArrayX);
        termLine.setAttribute("y1", yPos);
        termLine.setAttribute("x2", andArrayX + andArrayWidth);
        termLine.setAttribute("y2", yPos);
        termLine.setAttribute("stroke", "#2c3e50");
        termLine.setAttribute("stroke-width", "2");
        termLine.setAttribute("stroke-dasharray", "3,3");
        svg.appendChild(termLine);
        
        // Product term label
        const termLabel = document.createElementNS(svgNS, "text");
        termLabel.setAttribute("x", andArrayX - 40);
        termLabel.setAttribute("y", yPos + 5);
        termLabel.setAttribute("font-size", "16");
        termLabel.setAttribute("font-weight", "bold");
        termLabel.setAttribute("fill", "#3498db");
        termLabel.textContent = "P" + (i + 1);
        svg.appendChild(termLabel);
        
        // AND gates connections based on simplified product term
        const productTerm = allProductTerms[i];
        for (let j = 0; j < varCount; j++) {
            const inputType = productTerm.inputs[j];
            if (inputType !== '-') {
                const isComplement = (inputType === '0');
                const xPos = 100 + j * 80 + (isComplement ? 40 : 0);
                
                // Connection line
                const connLine = document.createElementNS(svgNS, "line");
                connLine.setAttribute("x1", xPos);
                connLine.setAttribute("y1", yPos);
                connLine.setAttribute("x2", andArrayX);
                connLine.setAttribute("y2", yPos);
                connLine.setAttribute("stroke", isComplement ? "#7f8c8d" : "#2c3e50");
                connLine.setAttribute("stroke-width", isComplement ? "1.5" : "2");
                connLine.setAttribute("stroke-dasharray", isComplement ? "4,4" : "none");
                connLine.setAttribute("opacity", "0.8");
                svg.appendChild(connLine);
                
                // Fuse point - GREEN for simplified expression connections
                const fuse = document.createElementNS(svgNS, "circle");
                fuse.setAttribute("cx", xPos);
                fuse.setAttribute("cy", yPos);
                fuse.setAttribute("r", "5");
                fuse.setAttribute("fill", "#27ae60"); // GREEN color
                fuse.setAttribute("stroke", isComplement ? "#7f8c8d" : "#2c3e50");
                fuse.setAttribute("stroke-width", "2");
                svg.appendChild(fuse);
            }
        }
    }
    
    // ========== OR ARRAY ========== (ADDING THIS MISSING SECTION)
    const orArrayX = 550;
    const orArrayWidth = 200;
    
    // OR array boundary
    const orArrayRect = document.createElementNS(svgNS, "rect");
    orArrayRect.setAttribute("x", orArrayX);
    orArrayRect.setAttribute("y", 100);
    orArrayRect.setAttribute("width", orArrayWidth);
    orArrayRect.setAttribute("height", 500);
    orArrayRect.setAttribute("fill", "rgba(39, 174, 96, 0.1)");
    orArrayRect.setAttribute("stroke", "#27ae60");
    orArrayRect.setAttribute("stroke-width", "3");
    svg.appendChild(orArrayRect);
    
    // OR array label
    const orLabel = document.createElementNS(svgNS, "text");
    orLabel.setAttribute("x", orArrayX + orArrayWidth/2);
    orLabel.setAttribute("y", 80);
    orLabel.setAttribute("text-anchor", "middle");
    orLabel.setAttribute("font-size", "20");
    orLabel.setAttribute("font-weight", "bold");
    orLabel.setAttribute("fill", "#229954");
    orLabel.textContent = "OR ARRAY";
    svg.appendChild(orLabel);
    
    // Draw output lines
    for (let i = 0; i < funcCount; i++) {
        const yPos = 200 + i * 80;
        
        // Output line
        const outputLine = document.createElementNS(svgNS, "line");
        outputLine.setAttribute("x1", orArrayX);
        outputLine.setAttribute("y1", yPos);
        outputLine.setAttribute("x2", orArrayX + orArrayWidth);
        outputLine.setAttribute("y2", yPos);
        outputLine.setAttribute("stroke", "#2c3e50");
        outputLine.setAttribute("stroke-width", "2");
        outputLine.setAttribute("stroke-dasharray", "3,3");
        svg.appendChild(outputLine);
        
        // Output label
        const outputLabel = document.createElementNS(svgNS, "text");
        outputLabel.setAttribute("x", orArrayX + orArrayWidth + 30);
        outputLabel.setAttribute("y", yPos + 5);
        outputLabel.setAttribute("font-size", "18");
        outputLabel.setAttribute("font-weight", "bold");
        outputLabel.setAttribute("fill", "#e74c3c");
        outputLabel.textContent = "F" + (i + 1);
        svg.appendChild(outputLabel);
        
        // OR connections from simplified product terms
        for (let j = 0; j < productTermsCount; j++) {
            const productTerm = allProductTerms[j];
            if (productTerm.outputs && productTerm.outputs[functions[i].name]) {
                const termY = 150 + j * 60;
                
                // Connection dot - GREEN for simplified expression
                const fuse = document.createElementNS(svgNS, "circle");
                fuse.setAttribute("cx", orArrayX);
                fuse.setAttribute("cy", termY);
                fuse.setAttribute("r", "5");
                fuse.setAttribute("fill", "#27ae60"); // GREEN color
                fuse.setAttribute("stroke", "#2c3e50");
                fuse.setAttribute("stroke-width", "2");
                svg.appendChild(fuse);
                
                // Connection line
                const connLine = document.createElementNS(svgNS, "line");
                connLine.setAttribute("x1", orArrayX);
                connLine.setAttribute("y1", termY);
                connLine.setAttribute("x2", orArrayX);
                connLine.setAttribute("y2", yPos);
                connLine.setAttribute("stroke", "#27ae60"); // GREEN color
                connLine.setAttribute("stroke-width", "2");
                connLine.setAttribute("opacity", "0.7");
                svg.appendChild(connLine);
            }
        }
        
        // Output arrow
        const arrow = document.createElementNS(svgNS, "polygon");
        arrow.setAttribute("points", 
            `${orArrayX + orArrayWidth + 10},${yPos-5} ` +
            `${orArrayX + orArrayWidth + 10},${yPos+5} ` +
            `${orArrayX + orArrayWidth + 20},${yPos}`
        );
        arrow.setAttribute("fill", "#e74c3c");
        svg.appendChild(arrow);
    }
    
    // ========== LEGEND ==========
    const legendX = 800;
    const legendY = 100;
    
    // Legend box
    const legendRect = document.createElementNS(svgNS, "rect");
    legendRect.setAttribute("x", legendX);
    legendRect.setAttribute("y", legendY);
    legendRect.setAttribute("width", 180);
    legendRect.setAttribute("height", 180);
    legendRect.setAttribute("fill", "white");
    legendRect.setAttribute("stroke", "#7f8c8d");
    legendRect.setAttribute("stroke-width", "2");
    legendRect.setAttribute("rx", "5");
    svg.appendChild(legendRect);
    
    // Legend title - Updated to show it's simplified
    const legendTitle = document.createElementNS(svgNS, "text");
    legendTitle.setAttribute("x", legendX + 90);
    legendTitle.setAttribute("y", legendY + 25);
    legendTitle.setAttribute("text-anchor", "middle");
    legendTitle.setAttribute("font-size", "14");
    legendTitle.setAttribute("font-weight", "bold");
    legendTitle.setAttribute("fill", "#2c3e50");
    legendTitle.textContent = "PLA DIAGRAM (SIMPLIFIED)";
    svg.appendChild(legendTitle);
    
    // Legend items - Updated with green dots
    const legendItems = [
        {color: "#27ae60", label: "Active Fuse (Simplified)"},
        {color: "#2c3e50", label: "Variable Line"},
        {color: "#7f8c8d", label: "Complement Line"},
        {color: "#3498db", label: "AND Array"},
        {color: "#27ae60", label: "OR Array"}
    ];
    
    legendItems.forEach((item, index) => {
        // Color box
        const colorBox = document.createElementNS(svgNS, "circle");
        colorBox.setAttribute("cx", legendX + 20);
        colorBox.setAttribute("cy", legendY + 45 + index * 25);
        colorBox.setAttribute("r", "6");
        colorBox.setAttribute("fill", item.color);
        colorBox.setAttribute("stroke", "#2c3e50");
        colorBox.setAttribute("stroke-width", "1");
        svg.appendChild(colorBox);
        
        // Label
        const itemLabel = document.createElementNS(svgNS, "text");
        itemLabel.setAttribute("x", legendX + 35);
        itemLabel.setAttribute("y", legendY + 48 + index * 25);
        itemLabel.setAttribute("font-size", "11");
        itemLabel.setAttribute("fill", "#2c3e50");
        itemLabel.textContent = item.label;
        svg.appendChild(itemLabel);
    });
    
    // ========== INFORMATION PANEL ==========
    const infoX = 800;
    const infoY = 300;
    
    // Info box
    const infoRect = document.createElementNS(svgNS, "rect");
    infoRect.setAttribute("x", infoX);
    infoRect.setAttribute("y", infoY);
    infoRect.setAttribute("width", 180);
    infoRect.setAttribute("height", 150);
    infoRect.setAttribute("fill", "#ecf0f1");
    infoRect.setAttribute("stroke", "#bdc3c7");
    infoRect.setAttribute("stroke-width", "1");
    infoRect.setAttribute("rx", "5");
    svg.appendChild(infoRect);
    
    // Info title
    const infoTitle = document.createElementNS(svgNS, "text");
    infoTitle.setAttribute("x", infoX + 90);
    infoTitle.setAttribute("y", infoY + 25);
    infoTitle.setAttribute("text-anchor", "middle");
    infoTitle.setAttribute("font-size", "14");
    infoTitle.setAttribute("font-weight", "bold");
    infoTitle.setAttribute("fill", "#2c3e50");
    infoTitle.textContent = "PLA CONFIGURATION";
    svg.appendChild(infoTitle);
    
    // Info details - Updated to show it's based on simplified expression
    const infoDetails = [
        `Input Variables: ${varCount}`,
        `Product Terms: ${productTermsCount}`,
        `Output Functions: ${funcCount}`,
        `PLA Size: ${productTermsCount}  ${funcCount}`,
        `Based on Simplified Expression`
    ];
    
    infoDetails.forEach((detail, index) => {
        const detailText = document.createElementNS(svgNS, "text");
        detailText.setAttribute("x", infoX + 15);
        detailText.setAttribute("y", infoY + 50 + index * 20);
        detailText.setAttribute("font-size", "12");
        detailText.setAttribute("fill", index === 4 ? "#27ae60" : "#34495e"); // Green for last line
        detailText.setAttribute("font-weight", index === 4 ? "bold" : "normal");
        detailText.textContent = detail;
        svg.appendChild(detailText);
    });
    
    // Add explanatory text about green dots
    const explanation = document.createElementNS(svgNS, "text");
    explanation.setAttribute("x", 500);
    explanation.setAttribute("y", 650);
    explanation.setAttribute("text-anchor", "middle");
    explanation.setAttribute("font-size", "12");
    explanation.setAttribute("fill", "#27ae60");
    explanation.setAttribute("font-weight", "bold");
    explanation.textContent = "Green dots represent active fuses based on simplified K-map expression";
    svg.appendChild(explanation);
    
    circuitDiagram.appendChild(svg);
}

    
    function showPLAKmap() {
        const varCount = parseInt(plaVariablesCount.value);
        let expression = '';
        
        if (plaMintermsRadio.checked) {
            expression = plaMintermsValue.value.trim();
            if (!validateMinterms(expression, varCount)) return;
        } else {
            expression = plaBooleanValue.value.trim();
            if (!validateBooleanExpression(expression, varCount)) return;
        }
        
        if (!expression) {
            alert('Please enter minterms or boolean expression first');
            return;
        }
        
        generatePLAKmap(varCount, expression);
    }
    
    function showPLAProgramTable() {
        const varCount = parseInt(plaVariablesCount.value);
        const variables = ['A', 'B', 'C', 'D'].slice(0, varCount);
        
        let mainFunction = '';
        if (plaMintermsRadio.checked) {
            mainFunction = plaMintermsValue.value.trim();
            if (!validateMinterms(mainFunction, varCount)) return;
        } else {
            mainFunction = plaBooleanValue.value.trim();
            if (!validateBooleanExpression(mainFunction, varCount)) return;
        }
        
        if (!mainFunction) {
            alert('Please enter minterms or boolean expression first');
            return;
        }
        
        const functions = [{name: 'F1', expression: mainFunction}];
        generatePLAProgramTable(variables, functions);
    }
    
    function resetPLA() {
        plaMintermsValue.value = '0,1,2,5,6,7';
        plaBooleanValue.value = '';
        plaVariablesCount.value = '3';
        plaMultipleOutputs.checked = false;
        plaFunctionsContainer.innerHTML = '';
        plaAddFunctionDiv.style.display = 'none';
        plaFunctionsContainer.style.display = 'none';
        
        document.getElementById('pla-kmap-container').style.display = 'none';
        document.getElementById('pla-table-container').style.display = 'none';
        document.getElementById('pla-circuit-diagram').innerHTML = '';
        
        // Reset steps
        for (let i = 1; i <= 5; i++) {
            const step = document.getElementById(`pla-step${i}`);
            if (step) {
                step.style.display = i === 1 ? 'block' : 'none';
                step.classList.remove('active');
            }
        }
        
        updateExamplePlaceholders();
        updatePLAStats();
    }
    
    // Enhanced simplification function
    function simplifyExpression(expression, varCount) {
        if (plaMintermsRadio.checked) {
            const minterms = expression.split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m));
            
            if (minterms.length === 0) return '0';
            if (minterms.length === Math.pow(2, varCount)) return '1';
            
            // Get truth table for K-map grouping
            const truthTable = generateTruthTable(varCount, expression);
            
            // Perform K-map simplification
            return simplifyUsingKmap(truthTable, varCount);
            
        } else {
            // For boolean expressions, try to simplify
            // Remove spaces and convert to standard form
            let expr = expression.replace(/\s+/g, '');
            
            // Basic simplification rules
            expr = expr.replace(/A\+A/g, 'A');
            expr = expr.replace(/B\+B/g, 'B');
            expr = expr.replace(/C\+C/g, 'C');
            expr = expr.replace(/D\+D/g, 'D');
            
            // Remove redundant terms (needs more sophisticated algorithm)
            // For now, return the expression with some cleaning
            return expr.replace(/\*/g, '').replace(/\+/g, ' + ');
        }
    }
  // NEW FUNCTION: Simplify using K-map algorithm
    function simplifyUsingKmap(truthTable, varCount) {
        const vars = ['A', 'B', 'C', 'D'].slice(0, varCount);
        const minterms = [];
        
        // Collect minterms where truth table is 1
        for (let i = 0; i < truthTable.length; i++) {
            if (truthTable[i] === 1) {
                minterms.push(i);
            }
        }
        
        if (minterms.length === 0) return '0';
        if (minterms.length === Math.pow(2, varCount)) return '1';
        
        // Simple grouping algorithm for common patterns
        if (varCount === 2) {
            return simplify2VarKmap(minterms, vars);
        } else if (varCount === 3) {
            return simplify3VarKmap(minterms, vars);
        } else if (varCount === 4) {
            return simplify4VarKmap(minterms, vars);
        }
        
        // Fallback: return as sum of minterms
        return minterms.map(m => {
            let term = '';
            for (let i = 0; i < varCount; i++) {
                const bit = (m >> (varCount - 1 - i)) & 1;
                term += bit ? vars[i] : vars[i] + "'";
            }
            return term;
        }).join(' + ');
    }
        function simplify2VarKmap(minterms, vars) {
        const [A, B] = vars;
        
        // Check for all 1s
        if (minterms.length === 4) return '1';
        
        // Check for patterns
        if (minterms.includes(0) && minterms.includes(1)) {
            if (minterms.includes(2) && minterms.includes(3)) return '1';
            return A + "'";
        }
        if (minterms.includes(2) && minterms.includes(3)) {
            return A;
        }
        if (minterms.includes(0) && minterms.includes(2)) {
            return B + "'";
        }
        if (minterms.includes(1) && minterms.includes(3)) {
            return B;
        }
        if (minterms.includes(0) && minterms.includes(3)) {
            return A + "'" + B + "' + " + A + B;
        }
        if (minterms.includes(1) && minterms.includes(2)) {
            return A + "'" + B + " + " + A + B + "'";
        }
        
        // Return individual minterms
        return minterms.map(m => {
            const aBit = (m >> 1) & 1;
            const bBit = m & 1;
            return (aBit ? A : A + "'") + (bBit ? B : B + "'");
        }).join(' + ');
    }

    function simplify3VarKmap(minterms, vars) {
        const [A, B, C] = vars;
        
        // Common patterns for 3-variable K-maps
        const patterns = [
            { check: [0,1,2,3], expr: A + "'" },
            { check: [4,5,6,7], expr: A },
            { check: [0,1,4,5], expr: B + "'" },
            { check: [2,3,6,7], expr: B },
            { check: [0,2,4,6], expr: C + "'" },
            { check: [1,3,5,7], expr: C },
            { check: [0,1], expr: A + "'" + B + "'" },
            { check: [2,3], expr: A + "'" + B },
            { check: [4,5], expr: A + B + "'" },
            { check: [6,7], expr: A + B },
            { check: [0,4], expr: A + "'" + C + "'" },
            { check: [1,5], expr: A + "'" + C },
            { check: [2,6], expr: A + B + "'" + C + "'" },
            { check: [3,7], expr: A + B + C }
        ];
        
        let simplified = [];
        let covered = new Set();
        
        // Try to apply patterns
        patterns.forEach(pattern => {
            if (pattern.check.every(m => minterms.includes(m))) {
                if (!pattern.check.some(m => covered.has(m))) {
                    simplified.push(pattern.expr);
                    pattern.check.forEach(m => covered.add(m));
                }
            }
        });
        
        // Add any uncovered minterms
        minterms.forEach(m => {
            if (!covered.has(m)) {
                const aBit = (m >> 2) & 1;
                const bBit = (m >> 1) & 1;
                const cBit = m & 1;
                simplified.push(
                    (aBit ? A : A + "'") + 
                    (bBit ? B : B + "'") + 
                    (cBit ? C : C + "'")
                );
            }
        });
        
        return simplified.length > 0 ? simplified.join(' + ') : '0';
    }

    function simplify4VarKmap(minterms, vars) {
        // For 4 variables, return a reasonable simplification
        // This is a simplified version - full Quine-McCluskey would be needed for optimal
        const [A, B, C, D] = vars;
        
        if (minterms.length > 8) {
            // If more than half are 1s, consider complement
            const total = 16;
            if (minterms.length > total/2) {
                const notMinterms = [];
                for (let i = 0; i < total; i++) {
                    if (!minterms.includes(i)) notMinterms.push(i);
                }
                const complementExpr = simplify4VarKmap(notMinterms, vars);
                return complementExpr === '0' ? '1' : '(' + complementExpr + ")'";
            }
        }
        
        // Group into 4s, then 2s
        const groups = [];
        
        // Check for 4x1 groups
        const fourGroups = [
            [[0,1,2,3], A+"'B'"], [[4,5,6,7], A+"'B"], [[12,13,14,15], "AB"], [[8,9,10,11], "AB'"],
            [[0,4,8,12], "C'D'"], [[1,5,9,13], "C'D"], [[3,7,11,15], "CD"], [[2,6,10,14], "CD'"],
            [[0,1,4,5], A+"'C'"], [[2,3,6,7], A+"'C"], [[8,9,12,13], "AC'"], [[10,11,14,15], "AC"],
            [[0,2,8,10], "B'D'"], [[1,3,9,11], "B'D"], [[4,6,12,14], "BD'"], [[5,7,13,15], "BD"]
        ];
        
        let covered = new Set();
        let result = [];
        
        fourGroups.forEach(([group, expr]) => {
            if (group.every(m => minterms.includes(m))) {
                if (!group.some(m => covered.has(m))) {
                    result.push(expr);
                    group.forEach(m => covered.add(m));
                }
            }
        });
        
        // Add remaining minterms
        minterms.forEach(m => {
            if (!covered.has(m)) {
                const aBit = (m >> 3) & 1;
                const bBit = (m >> 2) & 1;
                const cBit = (m >> 1) & 1;
                const dBit = m & 1;
                result.push(
                    (aBit ? A : A+"'") + 
                    (bBit ? B : B+"'") + 
                    (cBit ? C : C+"'") + 
                    (dBit ? D : D+"'")
                );
            }
        });
        
        return result.length > 0 ? result.join(' + ') : '0';
    }


    // Add event listener for gate selection to show PLA section
    document.querySelectorAll('.gate-btn[data-gate="PLA-PROGRAMMING"]').forEach(btn => {
        btn.addEventListener('click', function() {
            // Hide all other sections
            document.querySelectorAll('.row.mt-4[id$="-section"]').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show PLA section
            plaSection.style.display = 'block';
            
            // Update active button
            document.querySelectorAll('.gate-btn').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // Update current gate name
            document.getElementById('current-gate-name').textContent = 'PLA Programming';
            
            // Initialize
            updateExamplePlaceholders();
            updatePLAStats();
        });
    });
    
    // Initialize
    updateExamplePlaceholders();
    updatePLAStats();
});
// Async Reset Flip-Flop Class
class AsyncResetFlipFlop {
    constructor() {
        this.Q = 0;
        this.Q_bar = 1;
        this.stepHistory = [];
    }
    
    operate(clock, data, preset, clear) {
        let operation = "";
        let previousQ = this.Q;
        
        // Priority: Clear > Preset > Normal operation
        if (clear == 1) {
            // Async Clear - immediate action
            this.Q = 0;
            this.Q_bar = 1;
            operation = "Async CLEAR";
        } else if (preset == 1) {
            // Async Preset - immediate action
            this.Q = 1;
            this.Q_bar = 0;
            operation = "Async PRESET";
        } else if (clock == 1) {
            // Positive edge detection
            this.Q = data;
            this.Q_bar = data ? 0 : 1;
            operation = "Clock Edge";
        } else {
            operation = "No Change";
        }
        
        this.stepHistory.push({
            clock, data, preset, clear,
            previousQ: previousQ,
            currentQ: this.Q,
            operation: operation
        });
        
        return { Q: this.Q, Q_bar: this.Q_bar, operation };
    }
    
    reset() {
        this.Q = 0;
        this.Q_bar = 1;
        this.stepHistory = [];
    }
}

let asyncFF = new AsyncResetFlipFlop();

function updateAsyncResetDisplay() {
    const clk = document.getElementById('async-input-clk').checked ? 1 : 0;
    const data = document.getElementById('async-input-d').checked ? 1 : 0;
    const preset = document.getElementById('async-input-preset').checked ? 1 : 0;
    const clear = document.getElementById('async-input-clear').checked ? 1 : 0;
    
    document.getElementById('async-current-q').checked = asyncFF.Q === 1;
    document.getElementById('async-current-qbar').checked = asyncFF.Q_bar === 1;
}

function calculateAsyncReset() {
    const clk = document.getElementById('async-input-clk').checked ? 1 : 0;
    const data = document.getElementById('async-input-d').checked ? 1 : 0;
    const preset = document.getElementById('async-input-preset').checked ? 1 : 0;
    const clear = document.getElementById('async-input-clear').checked ? 1 : 0;
    
    const result = asyncFF.operate(clk, data, preset, clear);
    
    // Update display
    updateAsyncResetDisplay();
    
    // Show results in right panel
    const resultsDiv = document.getElementById('sequential2-results');
    resultsDiv.innerHTML = `
        <div class="glass-card">
            <h5 class="text-center mb-3">Asynchronous Preset/Clear Operation</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="sequential-step active">
                        <div class="calculation-title">Input Signals:</div>
                        <div class="calculation-content">
                            Clock (CLK): <span class="sequential-state ${clk ? 'state-1' : 'state-0'}">${clk}</span><br>
                            Data (D): <span class="sequential-state ${data ? 'state-1' : 'state-0'}">${data}</span><br>
                            Preset (PRE): <span class="sequential-state ${preset ? 'state-1' : 'state-0'}">${preset}</span><br>
                            Clear (CLR): <span class="sequential-state ${clear ? 'state-1' : 'state-0'}">${clear}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="sequential-step active">
                        <div class="calculation-title">Operation Result:</div>
                        <div class="calculation-content">
                            <strong>${result.operation}</strong><br>
                            New Q: <span class="sequential-state ${result.Q ? 'state-1' : 'state-0'}">${result.Q}</span><br>
                            New Q': <span class="sequential-state ${result.Q_bar ? 'state-1' : 'state-0'}">${result.Q_bar}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sequential-step active mt-3">
                <div class="calculation-title">Operation Explanation:</div>
                <div class="calculation-content">
                    ${getAsyncExplanation(clk, data, preset, clear, result.operation)}
                </div>
            </div>
        </div>
    `;
    
    // Show circuit diagram
    showAsyncCircuitDiagram(clk, data, preset, clear, result.Q, result.Q_bar);
}

function getAsyncExplanation(clk, data, preset, clear, operation) {
    if (clear === 1) {
        return "Clear signal is active (CLR=1). This has the HIGHEST priority. The flip-flop immediately sets Q=0 and Q'=1, regardless of clock or other inputs.";
    } else if (preset === 1) {
        return "Preset signal is active (PRE=1). This has second priority. The flip-flop immediately sets Q=1 and Q'=0, regardless of clock or other inputs.";
    } else if (clk === 1) {
        return "Clock edge detected (CLK rising). Since no async signals are active, the flip-flop captures the Data input (D=" + data + ") and updates Q to this value.";
    } else {
        return "No clock edge and no async signals active. The flip-flop maintains its previous state (no change).";
    }
}

function showAsyncCircuitDiagram(clk, data, preset, clear, Q, Q_bar) {
    const container = document.getElementById('sequential2-circuit-container');
    container.innerHTML = `
        <div class="realistic-circuit-container">
            <!-- Circuit Board Background -->
            <div class="circuit-board"></div>
            
            <!-- D Flip-Flop with Async Controls -->
            <div class="d-flipflop-real" style="left: 50%; top: 50%; transform: translate(-50%, -50%);">
                <div class="ic-label">D-FF<br>Async</div>
            </div>
            
            <!-- Input Signals -->
            <div class="input-pad" style="left: 20%; top: 30%;" id="clk-node">
                CLK<br>${clk}
            </div>
            
            <div class="input-pad" style="left: 20%; top: 50%;" id="data-node">
                D<br>${data}
            </div>
            
            <div class="input-pad" style="left: 20%; top: 70%;" id="preset-node">
                PRE<br>${preset}
            </div>
            
            <div class="input-pad" style="left: 80%; top: 30%;" id="clear-node">
                CLR<br>${clear}
            </div>
            
            <!-- Output Signals -->
            <div class="output-pad" style="left: 80%; top: 50%;" id="q-node">
                Q<br>${Q}
            </div>
            
            <div class="output-pad" style="left: 80%; top: 70%;" id="qbar-node">
                Q'<br>${Q_bar}
            </div>
            
            <!-- Connection Lines -->
            <div class="circuit-connection ${clk ? 'active' : ''}" 
                 style="left: 25%; top: 30%; width: 25%;"></div>
            
            <div class="circuit-connection ${data ? 'active' : ''}" 
                 style="left: 25%; top: 50%; width: 25%;"></div>
            
            <div class="circuit-connection ${preset ? 'active' : ''}" 
                 style="left: 25%; top: 70%; width: 25%;"></div>
            
            <div class="circuit-connection ${clear ? 'active' : ''}" 
                 style="left: 55%; top: 30%; width: 25%;"></div>
            
            <div class="circuit-connection ${Q ? 'active' : ''}" 
                 style="left: 55%; top: 50%; width: 25%;"></div>
            
            <div class="circuit-connection ${Q_bar ? 'active' : ''}" 
                 style="left: 55%; top: 70%; width: 25%;"></div>
            
            <!-- Labels -->
            <div class="circuit-label-real" style="left: 15%; top: 25%;">Clock Input</div>
            <div class="circuit-label-real" style="left: 15%; top: 45%;">Data Input</div>
            <div class="circuit-label-real" style="left: 15%; top: 65%;">Preset (Async)</div>
            <div class="circuit-label-real" style="left: 85%; top: 25%;">Clear (Async)</div>
            <div class="circuit-label-real" style="left: 85%; top: 45%;">Output Q</div>
            <div class="circuit-label-real" style="left: 85%; top: 65%;">Output Q'</div>
            
            <!-- Priority Indicator -->
            <div class="circuit-label-real" style="left: 50%; top: 10%; background: var(--warning-color); color: white;">
                Priority: CLR > PRE > CLK
            </div>
        </div>
    `;
    
    // Highlight active nodes
    if (clk) document.getElementById('clk-node').classList.add('active');
    if (data) document.getElementById('data-node').classList.add('active');
    if (preset) document.getElementById('preset-node').classList.add('active');
    if (clear) document.getElementById('clear-node').classList.add('active');
    if (Q) document.getElementById('q-node').classList.add('active');
    if (Q_bar) document.getElementById('qbar-node').classList.add('active');
}

function showAsyncTruthTable() {
    const container = document.getElementById('sequential2-results');
    container.innerHTML = `
        <div class="glass-card">
            <h5 class="text-center mb-3">Asynchronous Flip-Flop Truth Table</h5>
            <p class="text-center mb-3">Priority Order: <strong>Clear (CLR) > Preset (PRE) > Clock (CLK)</strong></p>
            
            <div class="table-responsive">
                <table class="truth-table">
                    <thead>
                        <tr>
                            <th>CLR</th>
                            <th>PRE</th>
                            <th>CLK</th>
                            <th>D</th>
                            <th>Q(t+1)</th>
                            <th>Operation</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="active">1</td>
                            <td class="inactive">0</td>
                            <td class="inactive">X</td>
                            <td class="inactive">X</td>
                            <td class="active">0</td>
                            <td>Async Clear</td>
                            <td>Immediate clear, highest priority</td>
                        </tr>
                        <tr>
                            <td class="inactive">0</td>
                            <td class="active">1</td>
                            <td class="inactive">X</td>
                            <td class="inactive">X</td>
                            <td class="active">1</td>
                            <td>Async Preset</td>
                            <td>Immediate preset, second priority</td>
                        </tr>
                        <tr>
                            <td class="inactive">0</td>
                            <td class="inactive">0</td>
                            <td class="active"></td>
                            <td class="inactive">0</td>
                            <td class="inactive">0</td>
                            <td>Clock Edge</td>
                            <td>Capture D=0 on clock rising edge</td>
                        </tr>
                        <tr>
                            <td class="inactive">0</td>
                            <td class="inactive">0</td>
                            <td class="active"></td>
                            <td class="active">1</td>
                            <td class="active">1</td>
                            <td>Clock Edge</td>
                            <td>Capture D=1 on clock rising edge</td>
                        </tr>
                        <tr>
                            <td class="inactive">0</td>
                            <td class="inactive">0</td>
                            <td class="inactive">0</td>
                            <td class="inactive">X</td>
                            <td class="inactive">Q(t)</td>
                            <td>No Change</td>
                            <td>Maintain previous state</td>
                        </tr>
                        <tr>
                            <td class="active">1</td>
                            <td class="active">1</td>
                            <td class="inactive">X</td>
                            <td class="inactive">X</td>
                            <td class="active">0</td>
                            <td>Async Clear</td>
                            <td>Clear has priority over Preset</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="gate-description mt-3">
                <h6>Key Points:</h6>
                <ul>
                    <li><strong>X = Don't Care</strong> - Signal value doesn't matter</li>
                    <li><strong> = Rising Edge</strong> - Clock transition from 0 to 1</li>
                    <li><strong>Q(t) = Current State</strong> - Maintains previous output</li>
                    <li>Async operations happen immediately, overriding clock</li>
                    <li>Clear (CLR) has highest priority, even over Preset (PRE)</li>
                </ul>
            </div>
        </div>
    `;
    
    // Also show the circuit diagram
    showAsyncCircuitDiagram(0, 0, 0, 0, 0, 1);
}

function stepThroughAsyncExample() {
    const steps = [
        { clk: 0, data: 1, preset: 0, clear: 0, desc: "Clock low, D=1, no async signals" },
        { clk: 1, data: 1, preset: 0, clear: 0, desc: "Clock edge, should capture D=1" },
        { clk: 0, data: 0, preset: 1, clear: 0, desc: "Async preset active (immediate Q=1)" },
        { clk: 1, data: 0, preset: 0, clear: 0, desc: "Clock edge with D=0" },
        { clk: 0, data: 1, preset: 0, clear: 1, desc: "Async clear active (immediate Q=0)" },
        { clk: 1, data: 1, preset: 0, clear: 0, desc: "Clock edge to capture D=1" },
        { clk: 1, data: 0, preset: 0, clear: 0, desc: "Another clock edge" },
        { clk: 0, data: 0, preset: 1, clear: 1, desc: "Both preset and clear (clear wins)" }
    ];
    
    const container = document.getElementById('sequential2-analysis');
    container.style.display = 'block';
    container.innerHTML = `
        <h5 class="text-center mb-3">Step-by-Step Demonstration</h5>
        <div class="gate-description mb-3">
            This demonstrates the priority: <strong>Clear > Preset > Clock</strong><br>
            Async signals work immediately, regardless of clock state.
        </div>
    `;
    
    // Reset flip-flop
    asyncFF.reset();
    
    steps.forEach((step, index) => {
        const result = asyncFF.operate(step.clk, step.data, step.preset, step.clear);
        
        const stepDiv = document.createElement('div');
        stepDiv.className = 'sequential-step active';
        stepDiv.innerHTML = `
            <div class="calculation-title">Step ${index + 1}: ${step.desc}</div>
            <div class="calculation-content">
                Inputs: CLK=${step.clk}, D=${step.data}, PRE=${step.preset}, CLR=${step.clear}<br>
                Operation: <strong>${result.operation}</strong><br>
                New State: Q=${result.Q}, Q'=${result.Q_bar}
            </div>
        `;
        
        container.appendChild(stepDiv);
        
        // Add a small delay for animation effect
        setTimeout(() => {
            showAsyncCircuitDiagram(step.clk, step.data, step.preset, step.clear, result.Q, result.Q_bar);
        }, index * 300);
    });
    
    // Final summary
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'gate-description mt-3';
    summaryDiv.innerHTML = `
        <h6>Summary of Asynchronous Behavior:</h6>
        <ol>
            <li><strong>Async Clear (CLR=1)</strong>  Immediate Q=0 (Highest Priority)</li>
            <li><strong>Async Preset (PRE=1)</strong>  Immediate Q=1</li>
            <li><strong>Clock Edge (CLK rising)</strong>  Q follows D (only when no async signals)</li>
            <li><strong>Async signals override clock</strong> - they work even when clock is low</li>
        </ol>
    `;
    container.appendChild(summaryDiv);
}

function resetAsyncFlipFlop() {
    asyncFF.reset();
    updateAsyncResetDisplay();
    
    const container = document.getElementById('sequential2-results');
    container.innerHTML = `
        <div class="glass-card">
            <h5 class="text-center mb-3">Flip-Flop Reset</h5>
            <div class="text-center">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <p>Flip-flop has been reset to initial state:</p>
                <p><strong>Q = 0, Q' = 1</strong></p>
            </div>
        </div>
    `;
    
    // Reset circuit diagram
    showAsyncCircuitDiagram(0, 0, 0, 0, 0, 1);
}

function clearAsyncResetResults() {
    const container = document.getElementById('sequential2-results');
    container.innerHTML = '';
    document.getElementById('sequential2-analysis').style.display = 'none';
}

// Helper function to show/hide sections
function showSection(sectionId) {
    document.getElementById(sectionId).style.display = 'block';
}

function hideOtherInputs(currentSection) {
    const sections = [
        't-flipflop-inputs', 'register-storage-inputs', 'shift-register-inputs',
        'master-slave-inputs', 'setup-time-inputs', 'hold-time-inputs',
        'clock-skew-inputs', 'async-reset-inputs'
    ];
    
    sections.forEach(section => {
        if (section !== currentSection) {
            document.getElementById(section).style.display = 'none';
        }
    });
}
// Initialize memory operations
function selectMemoryOperation(operation) {
    currentMemoryOperation = operation;
    
    // Hide all input sections
    document.getElementById('address-decoding-inputs').style.display = 'none';
    document.getElementById('cache-mapping-inputs').style.display = 'none';
    document.getElementById('tlb-operation-inputs').style.display = 'none';
    document.getElementById('memory-alignment-inputs').style.display = 'none';
    
    // Hide all results sections
    document.getElementById('address-decoding-results').style.display = 'none';
    document.getElementById('cache-mapping-results').style.display = 'none';
    document.getElementById('tlb-operation-results').style.display = 'none';
    document.getElementById('memory-alignment-results').style.display = 'none';
    document.getElementById('binary-visualization').style.display = 'none';
    document.getElementById('cache-truth-table-container').style.display = 'none';
    
    // Update operation description
    let description = '';
    switch(operation) {
        case 'address-decoding':
            description = '<strong>Address Decoding:</strong> Converts virtual/physical addresses into page numbers, offsets, and cache indices.';
            document.getElementById('address-decoding-inputs').style.display = 'block';
            setupAddressDecodingListeners();
            break;
        case 'cache-mapping':
            description = '<strong>Cache Mapping:</strong> Maps memory addresses to cache locations using different mapping techniques.';
            document.getElementById('cache-mapping-inputs').style.display = 'block';
            setupCacheMappingListeners();
            break;
        case 'tlb-operation':
            description = '<strong>TLB Operation:</strong> Simulates Translation Lookaside Buffer operations for virtual memory.';
            document.getElementById('tlb-operation-inputs').style.display = 'block';
            setupTLBListeners();
            break;
        case 'memory-alignment':
            description = '<strong>Memory Alignment:</strong> Checks if memory addresses are properly aligned for different data types.';
            document.getElementById('memory-alignment-inputs').style.display = 'block';
            setupAlignmentListeners();
            break;
    }
    
    document.getElementById('memory-operation-description').innerHTML = description;
}

// Setup address decoding event listeners
function setupAddressDecodingListeners() {
    const decodeBtn = document.getElementById('decode-address-btn');
    const examplesBtn = document.getElementById('show-examples-btn');
    const closeBtn = document.getElementById('close-address-decoding-btn');
    
    if (decodeBtn) {
        decodeBtn.onclick = decodeAddress;
    }
    
    if (examplesBtn) {
        examplesBtn.onclick = showAddressDecodingExamples;
    }
    
    if (closeBtn) {
        closeBtn.onclick = function() {
            document.getElementById('address-decoding-inputs').style.display = 'none';
            document.getElementById('memory-results').innerHTML = `
                <div class="text-center mt-5">
                    <i class="fas fa-microchip fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                    <h4 class="mt-3">Memory Address Decoding</h4>
                    <p>Select an operation to get started</p>
                </div>
            `;
        };
    }
}

// Setup cache mapping event listeners
function setupCacheMappingListeners() {
    const calculateBtn = document.getElementById('calculate-cache-btn');
    const examplesBtn = document.getElementById('show-cache-examples-btn');
    const visualizeBtn = document.getElementById('visualize-cache-btn');
    const closeBtn = document.getElementById('close-cache-mapping-btn');
    
    if (calculateBtn) {
        calculateBtn.onclick = calculateCacheMapping;
    }
    
    if (examplesBtn) {
        examplesBtn.onclick = showCacheMappingExamples;
    }
    
    if (visualizeBtn) {
        visualizeBtn.onclick = visualizeCacheStructure;
    }
    
    if (closeBtn) {
        closeBtn.onclick = function() {
            document.getElementById('cache-mapping-inputs').style.display = 'none';
            document.getElementById('memory-results').innerHTML = `
                <div class="text-center mt-5">
                    <i class="fas fa-layer-group fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                    <h4 class="mt-3">Cache Mapping</h4>
                    <p>Select an operation to get started</p>
                </div>
            `;
        };
    }
}

// Setup TLB operation listeners
function setupTLBListeners() {
    const checkBtn = document.getElementById('check-tlb-btn');
    const updateBtn = document.getElementById('update-tlb-btn');
    const simulateBtn = document.getElementById('simulate-tlb-btn');
    const closeBtn = document.getElementById('close-tlb-btn');
    
    if (checkBtn) {
        checkBtn.onclick = checkTLB;
    }
    
    if (updateBtn) {
        updateBtn.onclick = updateTLB;
    }
    
    if (simulateBtn) {
        simulateBtn.onclick = simulateTLBAccess;
    }
    
    if (closeBtn) {
        closeBtn.onclick = function() {
            document.getElementById('tlb-operation-inputs').style.display = 'none';
            document.getElementById('memory-results').innerHTML = `
                <div class="text-center mt-5">
                    <i class="fas fa-bolt fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                    <h4 class="mt-3">TLB Operations</h4>
                    <p>Select an operation to get started</p>
                </div>
            `;
        };
    }
}

// Setup alignment listeners
function setupAlignmentListeners() {
    const checkBtn = document.getElementById('check-alignment-btn');
    const nextBtn = document.getElementById('find-next-aligned-btn');
    const examplesBtn = document.getElementById('show-alignment-examples-btn');
    const closeBtn = document.getElementById('close-alignment-btn');
    
    if (checkBtn) {
        checkBtn.onclick = checkMemoryAlignment;
    }
    
    if (nextBtn) {
        nextBtn.onclick = findNextAlignedAddress;
    }
    
    if (examplesBtn) {
        examplesBtn.onclick = showAlignmentExamples;
    }
    
    if (closeBtn) {
        closeBtn.onclick = function() {
            document.getElementById('memory-alignment-inputs').style.display = 'none';
            document.getElementById('memory-results').innerHTML = `
                <div class="text-center mt-5">
                    <i class="fas fa-ruler fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
                    <h4 class="mt-3">Memory Alignment</h4>
                    <p>Select an operation to get started</p>
                </div>
            `;
        };
    }
}

// Address decoding function
function decodeAddress() {
    const addressInput = document.getElementById('address-input').value.trim();
    const addressType = document.getElementById('address-type-select').value;
    const addressFormat = document.getElementById('address-format-select').value;
    const pagingLevels = parseInt(document.getElementById('paging-levels-select').value);
    
    let address;
    
    try {
        // Parse address based on format
        if (addressFormat === 'hex') {
            address = parseInt(addressInput.replace(/^0x/, ''), 16);
        } else if (addressFormat === 'decimal') {
            address = parseInt(addressInput, 10);
        } else if (addressFormat === 'binary') {
            address = parseInt(addressInput.replace(/^0b/, ''), 2);
        }
        
        if (isNaN(address)) {
            throw new Error('Invalid address format');
        }
        
        // Perform decoding based on address type
        let result;
        if (addressType === 'virtual') {
            result = decodeVirtualAddress(address, pagingLevels);
        } else if (addressType === 'physical') {
            result = decodePhysicalAddress(address);
        } else if (addressType === 'cache') {
            result = decodeCacheAddress(address);
        } else if (addressType === 'multi-level') {
            result = decodeMultiLevelAddress(address, pagingLevels);
        }
        
        // Display results in right column
        displayAddressDecodingResults(result, address, addressType);
        
    } catch (error) {
        document.getElementById('address-decoding-results').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
        document.getElementById('address-decoding-results').style.display = 'block';
    }
}

// Cache mapping function
function calculateCacheMapping() {
    const addressInput = document.getElementById('cache-address-input').value.trim();
    const cacheType = document.getElementById('cache-mapping-type-select').value;
    const cacheSize = parseInt(document.getElementById('cache-size-select').value) * 1024; // Convert to bytes
    const blockSize = parseInt(document.getElementById('block-size-select').value);
    
    let address;
    
    try {
        // Parse address (assuming hex)
        address = parseInt(addressInput.replace(/^0x/, ''), 16);
        
        if (isNaN(address)) {
            throw new Error('Invalid address format');
        }
        
        // Calculate cache mapping
        const result = mapAddressToCache(address, cacheType, cacheSize, blockSize);
        
        // Display results in right column
        displayCacheMappingResults(result);
        
    } catch (error) {
        document.getElementById('cache-mapping-results').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
        document.getElementById('cache-mapping-results').style.display = 'block';
    }
}

// TLB check function
function checkTLB() {
    const virtualAddress = document.getElementById('tlb-virtual-address').value.trim();
    const physicalAddress = document.getElementById('tlb-physical-address').value.trim();
    const tlbType = document.getElementById('tlb-type-select').value;
    const tlbSize = parseInt(document.getElementById('tlb-size-select').value);
    
    try {
        const vAddr = parseInt(virtualAddress.replace(/^0x/, ''), 16);
        const pAddr = parseInt(physicalAddress.replace(/^0x/, ''), 16);
        
        if (isNaN(vAddr) || isNaN(pAddr)) {
            throw new Error('Invalid address format');
        }
        
        const result = simulateTLBLookup(vAddr, pAddr, tlbType, tlbSize);
        
        // Display results in right column
        displayTLBResults(result);
        
    } catch (error) {
        document.getElementById('tlb-operation-results').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
        document.getElementById('tlb-operation-results').style.display = 'block';
    }
}

// Memory alignment check
function checkMemoryAlignment() {
    const addressInput = document.getElementById('alignment-address').value.trim();
    const dataSize = parseInt(document.getElementById('data-size-select').value);
    
    try {
        const address = parseInt(addressInput.replace(/^0x/, ''), 16);
        
        if (isNaN(address)) {
            throw new Error('Invalid address format');
        }
        
        // Check multiple boundaries if selected
        const boundaries = [];
        if (document.getElementById('check-4byte').checked) boundaries.push(4);
        if (document.getElementById('check-8byte').checked) boundaries.push(8);
        if (document.getElementById('check-16byte').checked) boundaries.push(16);
        
        const results = boundaries.map(boundary => ({
            boundary,
            aligned: isAddressAligned(address, boundary),
            offset: address % boundary
        }));
        
        // Display results in right column
        displayAlignmentResults(address, dataSize, results);
        
    } catch (error) {
        document.getElementById('memory-alignment-results').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
        document.getElementById('memory-alignment-results').style.display = 'block';
    }
}

// Helper functions for memory operations
function decodeVirtualAddress(address, levels) {
    const binary = address.toString(2).padStart(32, '0');
    
    let result = {
        address: address,
        hex: '0x' + address.toString(16).toUpperCase(),
        binary: binary,
        offset: 0,
        pageNumber: 0,
        indices: [],
        breakdown: []
    };
    
    if (levels === 2) {
        // 2-level paging: 10-10-12 bits
        result.offset = address & 0xFFF; // 12 bits
        result.pageNumber = (address >> 12) & 0xFFFFF; // 20 bits
        result.indices = [
            (address >> 22) & 0x3FF, // Level 0: 10 bits
            (address >> 12) & 0x3FF  // Level 1: 10 bits
        ];
        result.breakdown = [
            { name: 'Directory', bits: 10, value: result.indices[0] },
            { name: 'Page', bits: 10, value: result.indices[1] },
            { name: 'Offset', bits: 12, value: result.offset }
        ];
    } else if (levels === 4) {
        // 4-level paging: 9-9-9-9-12 bits (x86-64 with 48-bit addresses)
        result.offset = address & 0xFFF; // 12 bits
        result.pageNumber = (address >> 12) & 0xFFFFFFFF; // 36 bits
        result.indices = [
            (address >> 39) & 0x1FF, // PML4: 9 bits
            (address >> 30) & 0x1FF, // PDP: 9 bits
            (address >> 21) & 0x1FF, // PD: 9 bits
            (address >> 12) & 0x1FF  // PT: 9 bits
        ];
        result.breakdown = [
            { name: 'PML4 Index', bits: 9, value: result.indices[0] },
            { name: 'PDP Index', bits: 9, value: result.indices[1] },
            { name: 'PD Index', bits: 9, value: result.indices[2] },
            { name: 'PT Index', bits: 9, value: result.indices[3] },
            { name: 'Offset', bits: 12, value: result.offset }
        ];
    }
    
    return result;
}

function mapAddressToCache(address, cacheType, cacheSize, blockSize) {
    const numBlocks = cacheSize / blockSize;
    const blockOffsetBits = Math.log2(blockSize);
    const indexBits = Math.log2(numBlocks);
    const tagBits = 32 - blockOffsetBits - indexBits;
    
    const blockOffset = address & ((1 << blockOffsetBits) - 1);
    const index = (address >> blockOffsetBits) & ((1 << indexBits) - 1);
    const tag = (address >> (blockOffsetBits + indexBits));
    
    return {
        address: address,
        hex: '0x' + address.toString(16).toUpperCase(),
        cacheType: cacheType,
        cacheSize: cacheSize,
        blockSize: blockSize,
        numBlocks: numBlocks,
        tag: tag,
        tagBits: tagBits,
        index: index,
        indexBits: indexBits,
        blockOffset: blockOffset,
        blockOffsetBits: blockOffsetBits,
        cacheSet: Math.floor(index % (numBlocks / 4)) // For 4-way set associative
    };
}

function isAddressAligned(address, boundary) {
    return address % boundary === 0;
}
// Display functions for each operation
function displayAddressDecodingResults(result, originalAddress, addressType) {
    let html = `
        <div class="glass-card">
            <h4 class="text-center mb-3"><i class="fas fa-map-marker-alt me-2"></i>Address Decoding Results</h4>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>Address Information:</h6>
                        <table class="bit-table">
                            <tr>
                                <td><strong>Address:</strong></td>
                                <td>${result.hex}</td>
                            </tr>
                            <tr>
                                <td><strong>Decimal:</strong></td>
                                <td>${result.address}</td>
                            </tr>
                            <tr>
                                <td><strong>Binary:</strong></td>
                                <td class="monospace">${result.binary}</td>
                            </tr>
    `;
    
    // Add type-specific information
    if (addressType === 'virtual' || addressType === 'multi-level') {
        html += `
            <tr>
                <td><strong>Page Number:</strong></td>
                <td>${result.pageNumber} (0x${result.pageNumber.toString(16).toUpperCase()})</td>
            </tr>
        `;
    } else if (addressType === 'physical') {
        html += `
            <tr>
                <td><strong>Frame Number:</strong></td>
                <td>${result.frameNumber} (0x${result.frameNumber.toString(16).toUpperCase()})</td>
            </tr>
        `;
    } else if (addressType === 'cache') {
        html += `
            <tr>
                <td><strong>Tag:</strong></td>
                <td>${result.tag} (0x${result.tag.toString(16).toUpperCase()})</td>
            </tr>
            <tr>
                <td><strong>Index:</strong></td>
                <td>${result.index} (0x${result.index.toString(16).toUpperCase()})</td>
            </tr>
        `;
    }
    
    html += `
                            <tr>
                                <td><strong>Offset:</strong></td>
                                <td>${result.offset} (0x${result.offset.toString(16).toUpperCase()})</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>${addressType === 'virtual' || addressType === 'multi-level' ? 'Paging Indices:' : 'Address Breakdown:'}</h6>
                        <table class="bit-table">
    `;
    
    if (addressType === 'virtual' || addressType === 'multi-level') {
        if (result.indices && result.indices.length > 0) {
            result.indices.forEach((index, i) => {
                html += `
                    <tr>
                        <td><strong>Level ${i}:</strong></td>
                        <td>${index} (0x${index.toString(16).toUpperCase()})</td>
                    </tr>
                `;
            });
        }
    } else if (addressType === 'cache') {
        html += `
            <tr>
                <td><strong>Tag Bits:</strong></td>
                <td>${result.tagBits}</td>
            </tr>
            <tr>
                <td><strong>Index Bits:</strong></td>
                <td>${result.indexBits}</td>
            </tr>
            <tr>
                <td><strong>Offset Bits:</strong></td>
                <td>${result.blockOffsetBits}</td>
            </tr>
            <tr>
                <td><strong>Cache Set:</strong></td>
                <td>${result.cacheSet}</td>
            </tr>
        `;
    } else if (addressType === 'physical') {
        html += `
            <tr>
                <td><strong>Frame Bits:</strong></td>
                <td>20 bits</td>
            </tr>
            <tr>
                <td><strong>Offset Bits:</strong></td>
                <td>12 bits</td>
            </tr>
        `;
    }
    
    html += `
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <h6>Bit Allocation Diagram:</h6>
                <div class="bit-visualization">
    `;
    
    // Create bit visualization
    if (result.breakdown && result.breakdown.length > 0) {
        let bitHtml = '<div class="bit-row">';
        let currentPos = 0;
        result.breakdown.forEach(field => {
            for (let i = 0; i < field.bits; i++) {
                bitHtml += `<div class="bit-cell" title="${field.name} bit ${i}">${31 - currentPos}</div>`;
                currentPos++;
            }
        });
        bitHtml += '</div><div class="bit-labels">';
        
        result.breakdown.forEach(field => {
            bitHtml += `<div class="bit-label" style="width: ${(field.bits/32)*100}%">${field.name} (${field.bits} bits)</div>`;
        });
        bitHtml += '</div>';
        
        html += bitHtml;
    } else {
        html += '<p class="text-muted">No bit breakdown available for this address type.</p>';
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('address-decoding-results').innerHTML = html;
    document.getElementById('address-decoding-results').style.display = 'block';
    document.getElementById('memory-result').textContent = result.hex;
}

function displayCacheMappingResults(result) {
    const html = `
        <div class="glass-card">
            <h4 class="text-center mb-3"><i class="fas fa-layer-group me-2"></i>Cache Mapping Results</h4>
            
            <div class="gate-description">
                <h6>Cache Configuration:</h6>
                <table class="bit-table">
                    <tr>
                        <td><strong>Cache Type:</strong></td>
                        <td>${result.cacheType}</td>
                    </tr>
                    <tr>
                        <td><strong>Cache Size:</strong></td>
                        <td>${result.cacheSize} bytes (${result.cacheSize/1024} KB)</td>
                    </tr>
                    <tr>
                        <td><strong>Block Size:</strong></td>
                        <td>${result.blockSize} bytes</td>
                    </tr>
                    <tr>
                        <td><strong>Number of Blocks:</strong></td>
                        <td>${result.numBlocks}</td>
                    </tr>
                </table>
            </div>
            
            <div class="mt-3">
                <h6>Address Mapping:</h6>
                <table class="bit-table">
                    <tr>
                        <td><strong>Address:</strong></td>
                        <td>${result.hex}</td>
                    </tr>
                    <tr>
                        <td><strong>Tag (${result.tagBits} bits):</strong></td>
                        <td>${result.tag.toString(2).padStart(result.tagBits, '0')} (${result.tag})</td>
                    </tr>
                    <tr>
                        <td><strong>Index (${result.indexBits} bits):</strong></td>
                        <td>${result.index.toString(2).padStart(result.indexBits, '0')} (${result.index})</td>
                    </tr>
                    <tr>
                        <td><strong>Block Offset (${result.blockOffsetBits} bits):</strong></td>
                        <td>${result.blockOffset.toString(2).padStart(result.blockOffsetBits, '0')} (${result.blockOffset})</td>
                    </tr>
                    <tr>
                        <td><strong>Cache Set:</strong></td>
                        <td>${result.cacheSet}</td>
                    </tr>
                </table>
            </div>
            
            <div class="mt-3">
                <h6>Address Bit Breakdown:</h6>
                <div class="bit-breakdown">
                    <div class="bit-segment tag" style="width: ${(result.tagBits/32)*100}%">
                        <span>Tag (${result.tagBits} bits)</span>
                    </div>
                    <div class="bit-segment index" style="width: ${(result.indexBits/32)*100}%">
                        <span>Index (${result.indexBits} bits)</span>
                    </div>
                    <div class="bit-segment offset" style="width: ${(result.blockOffsetBits/32)*100}%">
                        <span>Offset (${result.blockOffsetBits} bits)</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('cache-mapping-results').innerHTML = html;
    document.getElementById('cache-mapping-results').style.display = 'block';
    document.getElementById('memory-result').textContent = `Set ${result.cacheSet}`;
}

function displayAlignmentResults(address, dataSize, results) {
    let html = `
        <div class="glass-card">
            <h4 class="text-center mb-3"><i class="fas fa-ruler me-2"></i>Memory Alignment Results</h4>
            
            <div class="gate-description">
                <h6>Address Information:</h6>
                <table class="bit-table">
                    <tr>
                        <td><strong>Address:</strong></td>
                        <td>0x${address.toString(16).toUpperCase()}</td>
                    </tr>
                    <tr>
                        <td><strong>Decimal:</strong></td>
                        <td>${address}</td>
                    </tr>
                    <tr>
                        <td><strong>Binary:</strong></td>
                        <td class="monospace">${address.toString(2).padStart(32, '0')}</td>
                    </tr>
                    <tr>
                        <td><strong>Data Size:</strong></td>
                        <td>${dataSize} byte${dataSize > 1 ? 's' : ''}</td>
                    </tr>
                </table>
            </div>
            
            <div class="mt-3">
                <h6>Alignment Check Results:</h6>
                <table class="truth-table">
                    <thead>
                        <tr>
                            <th>Boundary</th>
                            <th>Aligned?</th>
                            <th>Offset</th>
                            <th>Next Aligned</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    results.forEach(result => {
        const nextAligned = address + (result.boundary - result.offset) % result.boundary;
        html += `
            <tr>
                <td>${result.boundary}-byte</td>
                <td class="${result.aligned ? 'text-success' : 'text-danger'}">
                    ${result.aligned ? ' ALIGNED' : ' MISALIGNED'}
                </td>
                <td>${result.offset} byte${result.offset !== 1 ? 's' : ''}</td>
                <td>0x${nextAligned.toString(16).toUpperCase()}</td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                <h6>Visual Representation:</h6>
                <div class="alignment-visual">
                    <div class="memory-line">
                        <div class="address-label">0x${address.toString(16).toUpperCase()}</div>
    `;
    
    // Create visual representation
    results.forEach(result => {
        const alignmentClass = result.aligned ? 'aligned' : 'misaligned';
        html += `
            <div class="boundary-marker ${alignmentClass}" style="left: ${(result.offset/result.boundary)*100}%">
                <div class="marker-label">${result.boundary}-byte</div>
            </div>
        `;
    });
    
    html += `
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('memory-alignment-results').innerHTML = html;
    document.getElementById('memory-alignment-results').style.display = 'block';
    document.getElementById('memory-result').textContent = results.every(r => r.aligned) ? 'Aligned' : 'Misaligned';
}
// Missing function definitions for Advanced Memory Operations

// Address Decoding Examples
function showAddressDecodingExamples() {
    const examples = [
        {
            address: "0x12345678",
            type: "virtual",
            levels: 4,
            description: "Example 1: 32-bit virtual address with 4-level paging"
        },
        {
            address: "0x87654321",
            type: "cache",
            description: "Example 2: Cache address mapping (Direct Mapped)"
        },
        {
            address: "0x7FFFFFFF",
            type: "physical",
            description: "Example 3: Physical address decoding"
        },
        {
            address: "0xFFFF0000",
            type: "multi-level",
            levels: 2,
            description: "Example 4: 2-level paging system"
        }
    ];

    let html = `
        <div class="glass-card">
            <h4 class="text-center mb-3"><i class="fas fa-list-ol me-2"></i>Address Decoding Examples</h4>
            <div class="row">
    `;

    examples.forEach((example, index) => {
        html += `
            <div class="col-md-6 mb-3">
                <div class="gate-description p-3">
                    <h6>${example.description}</h6>
                    <p><strong>Address:</strong> ${example.address}</p>
                    <p><strong>Type:</strong> ${example.type}</p>
                    ${example.levels ? `<p><strong>Paging Levels:</strong> ${example.levels}</p>` : ''}
                    <button class="btn btn-sm btn-primary mt-2" onclick="loadExample('${example.address}', '${example.type}', ${example.levels || 4})">
                        Load This Example
                    </button>
                </div>
            </div>
        `;
    });

    html += `
            </div>
            <div class="mt-3">
                <h6>Common Address Patterns:</h6>
                <ul>
                    <li><strong>Virtual Address:</strong> Typically 32-bit or 48-bit addresses used by processes</li>
                    <li><strong>Physical Address:</strong> Actual memory locations in RAM</li>
                    <li><strong>Cache Address:</strong> Broken into Tag, Index, and Offset bits</li>
                    <li><strong>Multi-Level:</strong> Modern systems use 4-5 level paging</li>
                </ul>
            </div>
        </div>
    `;

    document.getElementById('address-decoding-results').innerHTML = html;
    document.getElementById('address-decoding-results').style.display = 'block';
}

function loadExample(address, type, levels = 4) {
    document.getElementById('address-input').value = address;
    document.getElementById('address-type-select').value = type;
    document.getElementById('paging-levels-select').value = levels;
    
    if (type === 'cache') {
        document.getElementById('cache-type-select').value = 'direct';
    }
    
    // Trigger decoding
    decodeAddress();
}

// Cache Mapping Examples
function showCacheMappingExamples() {
    const examples = [
        {
            address: "0x12345678",
            cacheType: "direct",
            cacheSize: "512",
            blockSize: "64",
            description: "Direct Mapped Cache (512KB, 64-byte blocks)"
        },
        {
            address: "0x87654321",
            cacheType: "set-associative",
            cacheSize: "256",
            blockSize: "32",
            description: "4-way Set Associative Cache"
        },
        {
            address: "0xABCDEF12",
            cacheType: "fully-associative",
            cacheSize: "64",
            blockSize: "128",
            description: "Fully Associative Cache"
        }
    ];

    let html = `
        <div class="glass-card">
            <h4 class="text-center mb-3"><i class="fas fa-list-ol me-2"></i>Cache Mapping Examples</h4>
            <div class="row">
    `;

    examples.forEach((example, index) => {
        html += `
            <div class="col-md-4 mb-3">
                <div class="gate-description p-3">
                    <h6>${example.description}</h6>
                    <p><strong>Address:</strong> ${example.address}</p>
                    <p><strong>Type:</strong> ${example.cacheType}</p>
                    <p><strong>Size:</strong> ${example.cacheSize}KB</p>
                    <p><strong>Block:</strong> ${example.blockSize} bytes</p>
                    <button class="btn btn-sm btn-primary mt-2" onclick="loadCacheExample('${example.address}', '${example.cacheType}', '${example.cacheSize}', '${example.blockSize}')">
                        Load Example
                    </button>
                </div>
            </div>
        `;
    });

    html += `
            </div>
            <div class="mt-3">
                <h6>Cache Mapping Types:</h6>
                <ul>
                    <li><strong>Direct Mapped:</strong> Each memory block maps to exactly one cache line</li>
                    <li><strong>Set Associative:</strong> Each memory block maps to a set of cache lines</li>
                    <li><strong>Fully Associative:</strong> Any memory block can go in any cache line</li>
                </ul>
            </div>
        </div>
    `;

    document.getElementById('cache-mapping-results').innerHTML = html;
    document.getElementById('cache-mapping-results').style.display = 'block';
}

function loadCacheExample(address, cacheType, cacheSize, blockSize) {
    document.getElementById('cache-address-input').value = address;
    document.getElementById('cache-mapping-type-select').value = cacheType;
    document.getElementById('cache-size-select').value = cacheSize;
    document.getElementById('block-size-select').value = blockSize;
    
    // Trigger calculation
    calculateCacheMapping();
}

// Cache Visualization
function visualizeCacheStructure() {
    const cacheType = document.getElementById('cache-mapping-type-select').value;
    const cacheSize = parseInt(document.getElementById('cache-size-select').value) * 1024;
    const blockSize = parseInt(document.getElementById('block-size-select').value);
    
    const numBlocks = cacheSize / blockSize;
    const sets = cacheType === 'direct' ? numBlocks : 
                 cacheType === 'set-associative' ? numBlocks / 4 : 1;
    const ways = cacheType === 'direct' ? 1 : 
                 cacheType === 'set-associative' ? 4 : numBlocks;
    
    let html = `
        <div class="glass-card">
            <h4 class="text-center mb-3"><i class="fas fa-eye me-2"></i>Cache Structure Visualization</h4>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>Cache Configuration:</h6>
                        <table class="bit-table">
                            <tr>
                                <td><strong>Cache Type:</strong></td>
                                <td>${cacheType}</td>
                            </tr>
                            <tr>
                                <td><strong>Total Size:</strong></td>
                                <td>${cacheSize} bytes (${cacheSize/1024} KB)</td>
                            </tr>
                            <tr>
                                <td><strong>Block Size:</strong></td>
                                <td>${blockSize} bytes</td>
                            </tr>
                            <tr>
                                <td><strong>Number of Blocks:</strong></td>
                                <td>${numBlocks}</td>
                            </tr>
                            <tr>
                                <td><strong>Number of Sets:</strong></td>
                                <td>${sets}</td>
                            </tr>
                            <tr>
                                <td><strong>Associativity:</strong></td>
                                <td>${ways}-way</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>Cache Organization:</h6>
                        <div class="cache-visualization">
    `;
    
    if (cacheType === 'direct') {
        html += `
            <div class="direct-cache">
                <div class="cache-header">Direct Mapped Cache</div>
                <div class="cache-lines">
        `;
        for (let i = 0; i < Math.min(16, numBlocks); i++) {
            html += `
                <div class="cache-line">
                    <div class="line-index">Line ${i}</div>
                    <div class="line-content">Tag: ?<br>Data: ?</div>
                </div>
            `;
        }
        if (numBlocks > 16) {
            html += `<div class="cache-line">... ${numBlocks - 16} more lines</div>`;
        }
        html += `
                </div>
            </div>
        `;
    } else if (cacheType === 'set-associative') {
        html += `
            <div class="set-cache">
                <div class="cache-header">4-way Set Associative Cache</div>
                <div class="cache-sets">
        `;
        for (let set = 0; set < Math.min(4, sets); set++) {
            html += `
                <div class="cache-set">
                    <div class="set-header">Set ${set}</div>
            `;
            for (let way = 0; way < ways; way++) {
                html += `
                    <div class="cache-way">
                        <div class="way-label">Way ${way}</div>
                        <div class="way-content">Tag: ?<br>Data: ?</div>
                    </div>
                `;
            }
            html += `</div>`;
        }
        html += `
                </div>
            </div>
        `;
    }
    
    html += `
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <h6>Memory to Cache Mapping:</h6>
                <div class="mapping-diagram">
                    <div class="memory-block">Memory Block</div>
                    <div class="arrow"></div>
                    <div class="cache-block">
                        <div class="cache-label">Cache</div>
                        <div class="mapping-rule">
                            ${cacheType === 'direct' ? 'Direct mapping to specific line' :
                              cacheType === 'set-associative' ? 'Mapping to set (4 lines)' :
                              'Can map to any line'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('cache-mapping-results').innerHTML = html;
    document.getElementById('cache-mapping-results').style.display = 'block';
}

// TLB Functions
function updateTLB() {
    const virtualAddress = document.getElementById('tlb-virtual-address').value.trim();
    const physicalAddress = document.getElementById('tlb-physical-address').value.trim();
    
    try {
        const vAddr = parseInt(virtualAddress.replace(/^0x/, ''), 16);
        const pAddr = parseInt(physicalAddress.replace(/^0x/, ''), 16);
        
        if (isNaN(vAddr) || isNaN(pAddr)) {
            throw new Error('Invalid address format');
        }
        
        const html = `
            <div class="glass-card">
                <h4 class="text-center mb-3"><i class="fas fa-sync me-2"></i>TLB Update</h4>
                
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    TLB Entry Updated Successfully
                </div>
                
                <div class="gate-description">
                    <h6>Updated TLB Entry:</h6>
                    <table class="bit-table">
                        <tr>
                            <td><strong>Virtual Page:</strong></td>
                            <td>0x${(vAddr >> 12).toString(16).toUpperCase()}</td>
                        </tr>
                        <tr>
                            <td><strong>Physical Frame:</strong></td>
                            <td>0x${(pAddr >> 12).toString(16).toUpperCase()}</td>
                        </tr>
                        <tr>
                            <td><strong>Virtual Address:</strong></td>
                            <td>0x${vAddr.toString(16).toUpperCase()}</td>
                        </tr>
                        <tr>
                            <td><strong>Physical Address:</strong></td>
                            <td>0x${pAddr.toString(16).toUpperCase()}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="mt-3">
                    <h6>TLB Operation:</h6>
                    <ol>
                        <li>Extract virtual page number: 0x${(vAddr >> 12).toString(16).toUpperCase()}</li>
                        <li>Extract physical frame number: 0x${(pAddr >> 12).toString(16).toUpperCase()}</li>
                        <li>Store mapping in TLB cache</li>
                        <li>Set valid bit to 1</li>
                        <li>Set access time for LRU replacement</li>
                    </ol>
                </div>
            </div>
        `;
        
        document.getElementById('tlb-operation-results').innerHTML = html;
        document.getElementById('tlb-operation-results').style.display = 'block';
        document.getElementById('memory-result').textContent = "TLB Updated";
        
    } catch (error) {
        document.getElementById('tlb-operation-results').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
        document.getElementById('tlb-operation-results').style.display = 'block';
    }
}

function simulateTLBAccess() {
    const tlbType = document.getElementById('tlb-type-select').value;
    const tlbSize = parseInt(document.getElementById('tlb-size-select').value);
    
    const html = `
        <div class="glass-card">
            <h4 class="text-center mb-3"><i class="fas fa-play-circle me-2"></i>TLB Access Simulation</h4>
            
            <div class="gate-description">
                <h6>TLB Configuration:</h6>
                <table class="bit-table">
                    <tr>
                        <td><strong>TLB Type:</strong></td>
                        <td>${tlbType}</td>
                    </tr>
                    <tr>
                        <td><strong>TLB Size:</strong></td>
                        <td>${tlbSize} entries</td>
                    </tr>
                    <tr>
                        <td><strong>Access Time:</strong></td>
                        <td>1 cycle (hit) / 10-100 cycles (miss)</td>
                    </tr>
                </table>
            </div>
            
            <div class="mt-3">
                <h6>Simulation Steps:</h6>
                <div class="simulation-steps">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <strong>Virtual Address Presented</strong><br>
                            CPU generates virtual address
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <strong>TLB Lookup</strong><br>
                            Check TLB for VPNPFN mapping
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <strong>Hit/Miss Detection</strong><br>
                            If hit: Return physical address (1 cycle)<br>
                            If miss: Page table walk required
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <strong>Page Table Walk (on miss)</strong><br>
                            Access memory page tables (10-100 cycles)
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <strong>Update TLB</strong><br>
                            Add new entry to TLB
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <h6>Performance Analysis:</h6>
                <table class="truth-table">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Hit Rate</th>
                            <th>Avg Access Time</th>
                            <th>Speedup</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>90% Hit Rate</td>
                            <td>90%</td>
                            <td>1.9 cycles</td>
                            <td>5.26x</td>
                        </tr>
                        <tr>
                            <td>95% Hit Rate</td>
                            <td>95%</td>
                            <td>1.45 cycles</td>
                            <td>6.9x</td>
                        </tr>
                        <tr>
                            <td>99% Hit Rate</td>
                            <td>99%</td>
                            <td>1.09 cycles</td>
                            <td>9.17x</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('tlb-operation-results').innerHTML = html;
    document.getElementById('tlb-operation-results').style.display = 'block';
    document.getElementById('memory-result').textContent = "Simulation Ready";
}

function simulateTLBLookup(vAddr, pAddr, tlbType, tlbSize) {
    // Simulate TLB lookup with random hit/miss
    const hit = Math.random() > 0.3; // 70% hit rate
    
    return {
        virtualAddress: vAddr,
        physicalAddress: pAddr,
        tlbType: tlbType,
        tlbSize: tlbSize,
        hit: hit,
        virtualPage: vAddr >> 12,
        physicalFrame: pAddr >> 12,
        accessTime: hit ? 1 : 50, // 1 cycle for hit, 50 for miss
        tlbEntry: Math.floor(Math.random() * tlbSize)
    };
}

function displayTLBResults(result) {
    const html = `
        <div class="glass-card">
            <h4 class="text-center mb-3"><i class="fas fa-search me-2"></i>TLB Lookup Results</h4>
            
            <div class="alert ${result.hit ? 'alert-success' : 'alert-warning'}">
                <i class="fas fa-${result.hit ? 'check' : 'times'}-circle me-2"></i>
                TLB ${result.hit ? 'HIT' : 'MISS'}
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>Address Information:</h6>
                        <table class="bit-table">
                            <tr>
                                <td><strong>Virtual Address:</strong></td>
                                <td>0x${result.virtualAddress.toString(16).toUpperCase()}</td>
                            </tr>
                            <tr>
                                <td><strong>Physical Address:</strong></td>
                                <td>0x${result.physicalAddress.toString(16).toUpperCase()}</td>
                            </tr>
                            <tr>
                                <td><strong>Virtual Page:</strong></td>
                                <td>0x${result.virtualPage.toString(16).toUpperCase()}</td>
                            </tr>
                            <tr>
                                <td><strong>Physical Frame:</strong></td>
                                <td>0x${result.physicalFrame.toString(16).toUpperCase()}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>TLB Information:</h6>
                        <table class="bit-table">
                            <tr>
                                <td><strong>TLB Type:</strong></td>
                                <td>${result.tlbType}</td>
                            </tr>
                            <tr>
                                <td><strong>TLB Size:</strong></td>
                                <td>${result.tlbSize} entries</td>
                            </tr>
                            <tr>
                                <td><strong>Access Time:</strong></td>
                                <td>${result.accessTime} cycle${result.accessTime !== 1 ? 's' : ''}</td>
                            </tr>
                            <tr>
                                <td><strong>TLB Entry:</strong></td>
                                <td>#${result.tlbEntry}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <h6>${result.hit ? 'TLB Hit Process:' : 'TLB Miss Process:'}</h6>
                <ol>
                    ${result.hit ? `
                    <li>Virtual address presented to TLB</li>
                    <li>TLB finds matching entry #${result.tlbEntry}</li>
                    <li>Physical frame retrieved from TLB</li>
                    <li>Physical address formed (frame + offset)</li>
                    <li>Memory access proceeds (${result.accessTime} cycle)</li>
                    ` : `
                    <li>Virtual address presented to TLB</li>
                    <li>No matching entry found (miss)</li>
                    <li>Initiate page table walk</li>
                    <li>Access page tables in memory</li>
                    <li>Update TLR with new mapping</li>
                    <li>Retry access (total ${result.accessTime} cycles)</li>
                    `}
                </ol>
            </div>
        </div>
    `;
    
    document.getElementById('tlb-operation-results').innerHTML = html;
    document.getElementById('tlb-operation-results').style.display = 'block';
    document.getElementById('memory-result').textContent = result.hit ? "TLB Hit" : "TLB Miss";
}

// Alignment Functions
function findNextAlignedAddress() {
    const addressInput = document.getElementById('alignment-address').value.trim();
    const dataSize = parseInt(document.getElementById('data-size-select').value);
    
    try {
        const address = parseInt(addressInput.replace(/^0x/, ''), 16);
        
        if (isNaN(address)) {
            throw new Error('Invalid address format');
        }
        
        // Find next aligned address for each boundary
        const boundaries = [4, 8, 16];
        const alignedAddresses = boundaries.map(boundary => ({
            boundary,
            currentAligned: address % boundary === 0,
            nextAligned: address + (boundary - (address % boundary)) % boundary,
            offset: address % boundary
        }));
        
        let html = `
            <div class="glass-card">
                <h4 class="text-center mb-3"><i class="fas fa-arrow-right me-2"></i>Next Aligned Addresses</h4>
                
                <div class="gate-description">
                    <h6>Current Address:</h6>
                    <table class="bit-table">
                        <tr>
                            <td><strong>Address:</strong></td>
                            <td>0x${address.toString(16).toUpperCase()}</td>
                        </tr>
                        <tr>
                            <td><strong>Decimal:</strong></td>
                            <td>${address}</td>
                        </tr>
                        <tr>
                            <td><strong>Binary:</strong></td>
                            <td class="monospace">${address.toString(2).padStart(32, '0')}</td>
                        </tr>
                        <tr>
                            <td><strong>Data Size:</strong></td>
                            <td>${dataSize} byte${dataSize > 1 ? 's' : ''}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="mt-3">
                    <h6>Next Aligned Addresses:</h6>
                    <table class="truth-table">
                        <thead>
                            <tr>
                                <th>Boundary</th>
                                <th>Current</th>
                                <th>Offset</th>
                                <th>Next Aligned</th>
                                <th>Hex</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        alignedAddresses.forEach(item => {
            const diff = item.nextAligned - address;
            html += `
                <tr>
                    <td>${item.boundary}-byte</td>
                    <td class="${item.currentAligned ? 'text-success' : 'text-muted'}">
                        ${item.currentAligned ? 'Aligned' : 'Misaligned'}
                    </td>
                    <td>${item.offset}</td>
                    <td>${item.nextAligned}</td>
                    <td class="monospace">0x${item.nextAligned.toString(16).toUpperCase()}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <h6>Alignment Rules:</h6>
                    <ul>
                        <li><strong>4-byte alignment:</strong> Address % 4 == 0</li>
                        <li><strong>8-byte alignment:</strong> Address % 8 == 0</li>
                        <li><strong>16-byte alignment:</strong> Address % 16 == 0</li>
                        <li><strong>General rule:</strong> Address % alignment_size == 0</li>
                    </ul>
                </div>
            </div>
        `;
        
        document.getElementById('memory-alignment-results').innerHTML = html;
        document.getElementById('memory-alignment-results').style.display = 'block';
        document.getElementById('memory-result').textContent = "Aligned Addrs";
        
    } catch (error) {
        document.getElementById('memory-alignment-results').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
        document.getElementById('memory-alignment-results').style.display = 'block';
    }
}

function showAlignmentExamples() {
    const examples = [
        {
            address: "0x1000",
            description: "Perfectly aligned address (4K boundary)",
            aligned: [true, true, true]
        },
        {
            address: "0x1004",
            description: "4-byte aligned but not 8-byte aligned",
            aligned: [true, false, false]
        },
        {
            address: "0x1008",
            description: "8-byte aligned address",
            aligned: [true, true, false]
        },
        {
            address: "0x1010",
            description: "16-byte aligned address",
            aligned: [true, true, true]
        }
    ];
    
    let html = `
        <div class="glass-card">
            <h4 class="text-center mb-3"><i class="fas fa-list-ol me-2"></i>Memory Alignment Examples</h4>
            
            <div class="row">
    `;
    
    examples.forEach((example, index) => {
        const addr = parseInt(example.address.replace(/^0x/, ''), 16);
        html += `
            <div class="col-md-6 mb-3">
                <div class="gate-description p-3">
                    <h6>${example.description}</h6>
                    <p><strong>Address:</strong> ${example.address}</p>
                    <p><strong>Decimal:</strong> ${addr}</p>
                    <div class="alignment-status mt-2">
                        <span class="badge ${example.aligned[0] ? 'bg-success' : 'bg-danger'}">4-byte: ${example.aligned[0] ? '' : ''}</span>
                        <span class="badge ${example.aligned[1] ? 'bg-success' : 'bg-danger'} ms-2">8-byte: ${example.aligned[1] ? '' : ''}</span>
                        <span class="badge ${example.aligned[2] ? 'bg-success' : 'bg-danger'} ms-2">16-byte: ${example.aligned[2] ? '' : ''}</span>
                    </div>
                    <button class="btn btn-sm btn-primary mt-2" onclick="loadAlignmentExample('${example.address}')">
                        Load Example
                    </button>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
            
            <div class="mt-3">
                <h6>Why Alignment Matters:</h6>
                <ul>
                    <li><strong>Performance:</strong> Misaligned accesses require multiple memory operations</li>
                    <li><strong>Atomicity:</strong> Some operations require aligned addresses for atomic access</li>
                    <li><strong>Hardware Requirements:</strong> Some processors require alignment for certain data types</li>
                    <li><strong>SIMD Operations:</strong> Vector operations typically require 16-byte or 32-byte alignment</li>
                </ul>
            </div>
            
            <div class="mt-3">
                <h6>Common Alignment Requirements:</h6>
                <table class="truth-table">
                    <thead>
                        <tr>
                            <th>Data Type</th>
                            <th>Typical Size</th>
                            <th>Common Alignment</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>char / byte</td>
                            <td>1 byte</td>
                            <td>1 byte</td>
                        </tr>
                        <tr>
                            <td>short / halfword</td>
                            <td>2 bytes</td>
                            <td>2 bytes</td>
                        </tr>
                        <tr>
                            <td>int / word</td>
                            <td>4 bytes</td>
                            <td>4 bytes</td>
                        </tr>
                        <tr>
                            <td>long / doubleword</td>
                            <td>8 bytes</td>
                            <td>8 bytes</td>
                        </tr>
                        <tr>
                            <td>float[4] (SIMD)</td>
                            <td>16 bytes</td>
                            <td>16 bytes</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('memory-alignment-results').innerHTML = html;
    document.getElementById('memory-alignment-results').style.display = 'block';
}

function loadAlignmentExample(address) {
    document.getElementById('alignment-address').value = address;
    document.getElementById('data-size-select').value = 4;
    document.getElementById('check-4byte').checked = true;
    document.getElementById('check-8byte').checked = true;
    document.getElementById('check-16byte').checked = true;
    
    // Trigger alignment check
    checkMemoryAlignment();
}

// Helper functions for other memory operations
function decodePhysicalAddress(address) {
    const binary = address.toString(2).padStart(32, '0');
    const offset = address & 0xFFF;
    const frameNumber = (address >> 12) & 0xFFFFF;
    
    return {
        address: address,
        hex: '0x' + address.toString(16).toUpperCase(),
        binary: binary,
        offset: offset,
        frameNumber: frameNumber,
        breakdown: [
            { name: 'Frame Number', bits: 20, value: frameNumber },
            { name: 'Offset', bits: 12, value: offset }
        ]
    };
}
function decodeCacheAddress(address) {
    // Direct mapped cache with 64 sets, 64-byte blocks
    const blockOffsetBits = 6; // 64 bytes = 2^6
    const indexBits = 6; // 64 sets = 2^6
    const tagBits = 32 - blockOffsetBits - indexBits;
    
    const blockOffset = address & ((1 << blockOffsetBits) - 1);
    const index = (address >> blockOffsetBits) & ((1 << indexBits) - 1);
    const tag = (address >> (blockOffsetBits + indexBits)) & ((1 << tagBits) - 1);
    
    return {
        address: address,
        hex: '0x' + address.toString(16).toUpperCase(),
        binary: address.toString(2).padStart(32, '0'),
        offset: blockOffset, // Use offset instead of blockOffset for consistency
        tag: tag,
        tagBits: tagBits,
        index: index,
        indexBits: indexBits,
        blockOffset: blockOffset,
        blockOffsetBits: blockOffsetBits,
        cacheSet: index,
        breakdown: [
            { name: 'Tag', bits: tagBits, value: tag },
            { name: 'Index', bits: indexBits, value: index },
            { name: 'Offset', bits: blockOffsetBits, value: blockOffset }
        ]
    };
}

function decodeMultiLevelAddress(address, levels) {
    return decodeVirtualAddress(address, levels);
}
// ROM Programming Functionality
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const romProgrammingBtn = document.getElementById('rom-programming-btn');
    const romProgrammingInputs = document.getElementById('rom-programming-inputs');
    const romProgrammingResults = document.getElementById('rom-programming-results');
    const romTypeSelect = document.getElementById('rom-type-select');
    const customFunctionInputs = document.getElementById('custom-function-inputs');
    const generateRomBtn = document.getElementById('generate-rom-btn');
    const showRomTruthTableBtn = document.getElementById('show-rom-truth-table-btn');
    const exportRomBtn = document.getElementById('export-rom-btn');
    const closeRomBtn = document.getElementById('close-rom-btn');
    
    // ROM Data Storage
    let currentROMData = {
        type: '',
        truthTable: [],
        binaryData: [],
        hexData: [],
        hexROMContent: '', // New: Full HEX ROM content
        description: ''
    };

    // Initialize
    initializeROMEvents();

    function initializeROMEvents() {
        // ROM Type change handler
        romTypeSelect.addEventListener('change', handleROMTypeChange);
        
        // Generate ROM Contents
        generateRomBtn.addEventListener('click', generateROMContents);
        
        // Show Truth Table
        showRomTruthTableBtn.addEventListener('click', showROMTruthTable);
        
        // Export ROM Formats
        exportRomBtn.addEventListener('click', exportROMFormats);
        
        // Close ROM Programming
        closeRomBtn.addEventListener('click', closeROMProgramming);
        
        // ROM Programming button
        romProgrammingBtn.addEventListener('click', showROMProgramming);
    }

    function handleROMTypeChange() {
        const romType = this.value;
        if (romType === 'custom-function' || romType === 'full-adder' || romType === 'seven-segment') {
            customFunctionInputs.style.display = 'block';
            
            // Set default values for examples
            if (romType === 'full-adder') {
                document.getElementById('minterms-input-rom').value = '3,5,6,7';
                document.getElementById('dontcare-input-rom').value = '';
            } else if (romType === 'seven-segment') {
                document.getElementById('minterms-input-rom').value = '0,2,3,5,6,7,8,9';
                document.getElementById('dontcare-input-rom').value = '';
            }
        } else {
            customFunctionInputs.style.display = 'none';
        }
    }

    function generateROMContents() {
        const romType = romTypeSelect.value;
        
        switch(romType) {
            case 'decimal-excess3':
                generateDecimalToExcess3ROM();
                break;
            case 'custom-function':
                generateCustomFunctionROM();
                break;
            case 'full-adder':
                generateFullAdderROM();
                break;
            case 'seven-segment':
                generateSevenSegmentROM();
                break;
            default:
                generateDecimalToExcess3ROM();
        }
        
        // Update operation description
        updateMemoryOperationDescription(romType);
    }

    function showROMTruthTable() {
        displayTruthTable();
    }

    function exportROMFormats() {
        exportROMData();
    }

    function closeROMProgramming() {
        hideAllMemorySections();
        romProgrammingInputs.style.display = 'none';
        romProgrammingResults.style.display = 'none';
        document.getElementById('memory-results').style.display = 'block';
    }

    function showROMProgramming() {
        hideAllMemorySections();
        romProgrammingInputs.style.display = 'block';
        romProgrammingResults.style.display = 'block';
        document.getElementById('memory-results').style.display = 'none';
        
        // Initialize with default ROM type
        romTypeSelect.value = 'decimal-excess3';
        customFunctionInputs.style.display = 'none';
        generateDecimalToExcess3ROM();
    }

    // ROM Generation Functions
    function generateDecimalToExcess3ROM() {
        const truthTable = [];
        
        // Valid addresses 0-9
        for (let i = 0; i <= 9; i++) {
            const binary = i.toString(2).padStart(4, '0');
            let excess3, hexVal;
            
            // Excess-3 conversion: BCD + 3
            switch(i) {
                case 0: excess3 = '0011'; hexVal = '3'; break;
                case 1: excess3 = '0100'; hexVal = '4'; break;
                case 2: excess3 = '0101'; hexVal = '5'; break;
                case 3: excess3 = '0110'; hexVal = '6'; break;
                case 4: excess3 = '0111'; hexVal = '7'; break;
                case 5: excess3 = '1000'; hexVal = '8'; break;
                case 6: excess3 = '1001'; hexVal = '9'; break;
                case 7: excess3 = '1010'; hexVal = 'A'; break;
                case 8: excess3 = '1011'; hexVal = 'B'; break;
                case 9: excess3 = '1100'; hexVal = 'C'; break;
            }
            
            truthTable.push({
                address: i,
                binary: binary,
                output: excess3,
                hex: hexVal,
                isValid: true
            });
        }
        
        // Invalid addresses 10-15
        for (let i = 10; i < 16; i++) {
            truthTable.push({
                address: i,
                binary: i.toString(2).padStart(4, '0'),
                output: '1100',
                hex: 'C',
                isValid: false
            });
        }
        
        // Generate HEX ROM content
        const hexROMContent = generateHexROMContent(truthTable.map(row => row.output));
        
        currentROMData = {
            type: 'decimal-excess3',
            truthTable: truthTable,
            binaryData: truthTable.map(row => row.output),
            hexData: truthTable.map(row => row.hex),
            hexROMContent: hexROMContent, // Store HEX ROM content
            description: '4-input to 164-bit ROM: Decimal to Excess-3 Code Converter'
        };
        
        displayROMResults();
    }

    function generateCustomFunctionROM() {
        const mintermsInput = document.getElementById('minterms-input-rom').value;
        const dontcareInput = document.getElementById('dontcare-input-rom').value;
        const variableCount = parseInt(document.getElementById('rom-variables-select').value);
        
        const minterms = mintermsInput ? mintermsInput.split(',').map(m => parseInt(m.trim())).filter(m => m >= 0 && m < 16) : [];
        const dontcares = dontcareInput ? dontcareInput.split(',').map(d => parseInt(d.trim())).filter(d => d >= 0 && d < 16) : [];
        
        const truthTable = [];
        const binaryData = [];
        
        for (let addr = 0; addr < 16; addr++) {
            const binary = addr.toString(2).padStart(4, '0');
            let output, hexVal, status;
            
            if (minterms.includes(addr)) {
                output = '1';
                hexVal = '1';
                status = 'minterm';
            } else if (dontcares.includes(addr)) {
                output = 'X';
                hexVal = 'X';
                status = 'dontcare';
            } else {
                output = '0';
                hexVal = '0';
                status = 'zero';
            }
            
            truthTable.push({
                address: addr,
                binary: binary,
                output: output,
                hex: hexVal,
                status: status
            });
            
            binaryData.push(output);
        }
        
        // Generate HEX ROM content for 161 ROM (convert to 4-bit hex groups)
        const hexROMContent = generateHexROMContentFor16x1(binaryData);
        
        currentROMData = {
            type: 'custom-function',
            truthTable: truthTable,
            binaryData: binaryData,
            hexData: truthTable.map(row => row.hex),
            hexROMContent: hexROMContent, // Store HEX ROM content
            description: `Custom Boolean Function (${variableCount} variables):  m(${minterms.join(',')})${dontcares.length > 0 ? ' + d(' + dontcares.join(',') + ')' : ''}`
        };
        
        displayROMResults();
    }

    function generateFullAdderROM() {
        document.getElementById('minterms-input-rom').value = '3,5,6,7';
        document.getElementById('dontcare-input-rom').value = '';
        generateCustomFunctionROM();
        currentROMData.description = 'Full Adder Carry Output:  m(3,5,6,7)';
    }

    function generateSevenSegmentROM() {
        document.getElementById('minterms-input-rom').value = '0,2,3,5,6,7,8,9';
        document.getElementById('dontcare-input-rom').value = '';
        generateCustomFunctionROM();
        currentROMData.description = '7-Segment Decoder (Segment a):  m(0,2,3,5,6,7,8,9)';
    }

    // HEX ROM Content Generation Functions
    function generateHexROMContent(binaryArray) {
        // For 164 ROM (Decimal to Excess-3): each entry is 4 bits
        let hexContent = '';
        for (let i = 0; i < binaryArray.length; i++) {
            const hexVal = parseInt(binaryArray[i], 2).toString(16).toUpperCase();
            hexContent += hexVal + ' ';
        }
        return hexContent.trim();
    }

    function generateHexROMContentFor16x1(binaryArray) {
        // For 161 ROM: group 16 bits into 4 hex digits (4 bits each)
        let hexContent = '';
        for (let i = 0; i < binaryArray.length; i += 4) {
            const nibble = binaryArray.slice(i, i + 4)
                .map(bit => bit === '1' ? '1' : '0')
                .join('');
            const hexVal = parseInt(nibble, 2).toString(16).toUpperCase();
            hexContent += hexVal;
        }
        return hexContent.split('').join(' '); // Add spaces between hex digits
    }

    // Display Functions
    function displayROMResults() {
        const resultsContainer = document.getElementById('rom-results-container');
        
        if (!resultsContainer) return;
        
        let html = '';
        
        if (currentROMData.type === 'decimal-excess3') {
            html = generateDecimalExcess3HTML();
        } else {
            html = generateCustomFunctionHTML();
        }
        
        resultsContainer.innerHTML = html;
        
        // Update memory result with HEX ROM content
        document.getElementById('memory-result').textContent = 
            currentROMData.hexROMContent;
    }

    function generateDecimalExcess3HTML() {
        const truthTable = currentROMData.truthTable;
        const binaryString = currentROMData.binaryData.join(' ');
        const hexString = currentROMData.hexData.join(' ');
        const hexROMContent = currentROMData.hexROMContent;
        
        return `
            <h4 class="text-center mb-4">${currentROMData.description}</h4>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="gate-description">
                        <h6>Truth Table (Decimal 0-9  Excess-3 Code)</h6>
                        <p>Excess-3 = BCD + 0011 (3)</p>
                        
                        <div class="table-responsive">
                            <table class="truth-table">
                                <thead>
                                    <tr>
                                        <th>Decimal</th>
                                        <th>Address (Binary)</th>
                                        <th>Excess-3 Output (Binary)</th>
                                        <th>Hex Output</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${truthTable.map(row => `
                                        <tr ${!row.isValid ? 'style="background-color: rgba(255, 140, 0, 0.1);"' : ''}>
                                            <td>${row.address}</td>
                                            <td>${row.binary}</td>
                                            <td class="${row.output === '0011' ? 'active' : row.output === '1100' ? 'inactive' : ''}">
                                                ${row.output}
                                            </td>
                                            <td>${row.hex}</td>
                                            <td>${row.isValid ? 'Valid' : 'Invalid  C'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4">
                            <h6>ROM Data Formats:</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="conversion-step">
                                        <strong>Binary Format (164 bits):</strong>
                                        <div class="conversion-result mt-2">${binaryString}</div>
                                        <small class="text-muted">16 words  4 bits each</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="conversion-step">
                                        <strong>HEX ROM Content:</strong>
                                        <div class="conversion-result mt-2" style="font-family: 'Courier New', monospace; font-weight: bold; color: var(--primary-color);">
                                            ${hexROMContent}
                                        </div>
                                        <small class="text-muted">Complete ROM in hexadecimal format</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="conversion-step">
                                        <strong>Individual Hex Outputs:</strong>
                                        <div class="conversion-result mt-2">${hexString}</div>
                                        <small class="text-muted">Hex value for each address</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="conversion-step">
                                        <strong>Verilog Initialization:</strong>
                                        <pre class="mt-2 small">${generateVerilogCode()}</pre>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="conversion-step">
                                        <strong>VHDL Initialization:</strong>
                                        <pre class="mt-2 small">${generateVHDLCode()}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="gate-description mt-4">
                            <h6>Application Notes:</h6>
                            <ul class="small">
                                <li><strong>HEX ROM Content:</strong> Use this to program the ROM directly</li>
                                <li><strong>Binary Format:</strong> 64 bits total (164)</li>
                                <li><strong>HEX Format:</strong> 16 hex digits, each representing 4 bits</li>
                                <li>Used in digital systems where BCD needs to be converted to Excess-3</li>
                                <li>Common in older calculators and digital displays</li>
                                <li>Invalid inputs (10-15) output '1100' by convention</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function generateCustomFunctionHTML() {
        const truthTable = currentROMData.truthTable;
        const binaryString = currentROMData.binaryData.join(' ');
        const hexString = currentROMData.hexData.join(' ');
        const hexROMContent = currentROMData.hexROMContent;
        
        return `
            <h4 class="text-center mb-4">${currentROMData.description}</h4>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="gate-description">
                        <h6>Complete Truth Table (16 entries):</h6>
                        
                        <div class="table-responsive">
                            <table class="truth-table">
                                <thead>
                                    <tr>
                                        <th>Address</th>
                                        <th>Binary Input</th>
                                        <th>Minterm</th>
                                        <th>Output</th>
                                        <th>Hex Value</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${truthTable.map(row => `
                                        <tr ${row.status === 'minterm' ? 'class="active"' : row.status === 'dontcare' ? 'style="background-color: rgba(255, 140, 0, 0.1);"' : ''}>
                                            <td>${row.address}</td>
                                            <td>${row.binary}</td>
                                            <td>m${row.address}</td>
                                            <td>${row.output}</td>
                                            <td>${row.hex}</td>
                                            <td>
                                                ${row.status === 'minterm' ? ' Minterm' : 
                                                  row.status === 'dontcare' ? ' Don\'t Care' : 
                                                  '0'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4">
                            <h6>ROM Implementation:</h6>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="conversion-step">
                                        <strong>Binary Output Pattern:</strong>
                                        <div class="conversion-result mt-2">${binaryString}</div>
                                        <small class="text-muted">16-bit pattern (1 bit per address)</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="conversion-step">
                                        <strong>HEX ROM Content:</strong>
                                        <div class="conversion-result mt-2" style="font-family: 'Courier New', monospace; font-weight: bold; color: var(--primary-color);">
                                            ${hexROMContent}
                                        </div>
                                        <small class="text-muted">4 hex digits (4 bits each)</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="conversion-step">
                                        <strong>Individual Hex Outputs:</strong>
                                        <div class="conversion-result mt-2">${hexString}</div>
                                        <small class="text-muted">Hex value for each output</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="conversion-step">
                                        <strong>Boolean Expression:</strong>
                                        <div class="conversion-result mt-2">
                                            F =  m(${getMintermsList().join(',')})
                                            ${getDontCaresList().length > 0 ? '+ d(' + getDontCaresList().join(',') + ')' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="conversion-step">
                                        <strong>Verilog Code:</strong>
                                        <pre class="mt-2 small">${generateVerilogCode()}</pre>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="conversion-step">
                                        <strong>VHDL Code:</strong>
                                        <pre class="mt-2 small">${generateVHDLCode()}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="gate-description mt-4">
                            <h6>Implementation Guide:</h6>
                            <ul class="small">
                                <li><strong>HEX ROM Content:</strong> ${hexROMContent} - Use this to program the ROM</li>
                                <li>Each address corresponds to a minterm combination</li>
                                <li>Output '1' for minterms, '0' for others</li>
                                <li>'X' represents don't care conditions (can be 0 or 1)</li>
                                <li>Total ROM size: 16 bits (4 hex digits)</li>
                                <li><strong>Note:</strong> For 161 ROM, output is organized as 4-bit hex groups</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function displayTruthTable() {
        // Enhanced truth table display with more details
        alert(`Showing detailed truth table for ${currentROMData.type}\n\nTotal entries: ${currentROMData.truthTable.length}\n\nHEX ROM Content: ${currentROMData.hexROMContent}`);
    }

    // Export Functions
    function exportROMData() {
        const formats = {
            binary: currentROMData.binaryData.join(' '),
            hex: currentROMData.hexData.join(' '),
            hexROM: currentROMData.hexROMContent,
            verilog: generateVerilogCode(),
            vhdl: generateVHDLCode(),
            csv: generateCSVFormat(),
            json: generateJSONFormat()
        };
        
        displayExportOptions(formats);
    }

    function generateVerilogCode() {
        if (currentROMData.type === 'decimal-excess3') {
            return `// Verilog ROM Initialization for Decimal to Excess-3 Converter
// HEX ROM Content: ${currentROMData.hexROMContent}
module decimal_excess3_rom (
    input [3:0] address,
    output reg [3:0] data
);
    always @(*) begin
        case(address)
            4'h0: data = 4'h3;  // 0000  0011
            4'h1: data = 4'h4;  // 0001  0100
            4'h2: data = 4'h5;  // 0010  0101
            4'h3: data = 4'h6;  // 0011  0110
            4'h4: data = 4'h7;  // 0100  0111
            4'h5: data = 4'h8;  // 0101  1000
            4'h6: data = 4'h9;  // 0110  1001
            4'h7: data = 4'hA;  // 0111  1010
            4'h8: data = 4'hB;  // 1000  1011
            4'h9: data = 4'hC;  // 1001  1100
            default: data = 4'hC; // Invalid inputs  1100
        endcase
    end
endmodule`;
        } else {
            return `// Verilog ROM Initialization for Custom Function
// HEX ROM Content: ${currentROMData.hexROMContent}
module custom_rom (
    input [3:0] address,
    output reg data
);
    always @(*) begin
        case(address)
            ${currentROMData.truthTable
                .filter(row => row.output === '1')
                .map(row => `4'h${row.address.toString(16).toUpperCase()}: data = 1'b1; // m${row.address}`)
                .join('\n            ')}
            default: data = 1'b0;
        endcase
    end
endmodule`;
        }
    }

    function generateVHDLCode() {
        if (currentROMData.type === 'decimal-excess3') {
            return `-- VHDL ROM Declaration for Decimal to Excess-3 Converter
-- HEX ROM Content: ${currentROMData.hexROMContent}
library IEEE;
use IEEE.STD_LOGIC_1164.ALL;

entity decimal_excess3_rom is
    Port ( address : in  STD_LOGIC_VECTOR(3 downto 0);
           data    : out STD_LOGIC_VECTOR(3 downto 0));
end decimal_excess3_rom;

architecture Behavioral of decimal_excess3_rom is
    type rom_type is array (0 to 15) of STD_LOGIC_VECTOR(3 downto 0);
    constant ROM : rom_type := (
        x"3", x"4", x"5", x"6", x"7", x"8", x"9", x"A",
        x"B", x"C", x"C", x"C", x"C", x"C", x"C", x"C"
    );
begin
    data <= ROM(to_integer(unsigned(address)));
end Behavioral;`;
        } else {
            const binaryPattern = currentROMData.binaryData.map(bit => bit === '1' ? '"1"' : '"0"').join(', ');
            return `-- VHDL ROM Declaration for Custom Function
-- HEX ROM Content: ${currentROMData.hexROMContent}
library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.NUMERIC_STD.ALL;

entity custom_rom is
    Port ( address : in  STD_LOGIC_VECTOR(3 downto 0);
           data    : out STD_LOGIC);
end custom_rom;

architecture Behavioral of custom_rom is
    type rom_type is array (0 to 15) of STD_LOGIC;
    constant ROM : rom_type := (
        ${binaryPattern}
    );
begin
    data <= ROM(to_integer(unsigned(address)));
end Behavioral;`;
        }
    }

    function generateCSVFormat() {
        let csv = "Address,Binary Input,Output,Hex Output,HEX ROM Content\n";
        currentROMData.truthTable.forEach((row, index) => {
            csv += `${row.address},${row.binary},${row.output},${row.hex},${currentROMData.hexROMContent}\n`;
        });
        return csv;
    }

    function generateJSONFormat() {
        return JSON.stringify({
            romType: currentROMData.type,
            description: currentROMData.description,
            hexROMContent: currentROMData.hexROMContent,
            truthTable: currentROMData.truthTable,
            binaryData: currentROMData.binaryData,
            hexData: currentROMData.hexData,
            generatedAt: new Date().toISOString()
        }, null, 2);
    }

    // Helper Functions
    function getMintermsList() {
        return currentROMData.truthTable
            .filter(row => row.output === '1' || row.status === 'minterm')
            .map(row => row.address);
    }

    function getDontCaresList() {
        return currentROMData.truthTable
            .filter(row => row.output === 'X' || row.status === 'dontcare')
            .map(row => row.address);
    }

    function displayExportOptions(formats) {
        const exportHTML = `
            <div class="glass-card mt-3">
                <h5 class="text-center mb-3">Export ROM Data</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="conversion-step">
                            <button class="btn-glow btn-sm w-100 mb-2" onclick="copyToClipboard('${formats.binary.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy me-1"></i>Copy Binary
                            </button>
                            <button class="btn-glow btn-sm w-100 mb-2" onclick="copyToClipboard('${formats.hex.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy me-1"></i>Copy Hex Outputs
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="conversion-step">
                            <button class="btn-glow btn-sm w-100 mb-2" onclick="copyToClipboard('${formats.hexROM.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy me-1"></i>Copy HEX ROM Content
                            </button>
                            <button class="btn-glow btn-sm w-100 mb-2" onclick="downloadFile('rom_data.csv', '${formats.csv.replace(/'/g, "\\'")}')">
                                <i class="fas fa-download me-1"></i>Download CSV
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="conversion-step">
                            <button class="btn-glow btn-sm w-100 mb-2" onclick="downloadFile('rom_data.json', '${formats.json.replace(/'/g, "\\'")}')">
                                <i class="fas fa-download me-1"></i>Download JSON
                            </button>
                            <button class="btn-glow btn-sm w-100" onclick="showExportPreview()">
                                <i class="fas fa-eye me-1"></i>Preview All Formats
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="conversion-step">
                        <strong>HEX ROM Content (Primary Format):</strong>
                        <div class="conversion-result mt-2" style="font-family: 'Courier New', monospace; font-size: 1.2rem; font-weight: bold; color: var(--success-color); background: rgba(34, 139, 34, 0.1); padding: 10px; border-radius: 5px;">
                            ${formats.hexROM}
                        </div>
                        <small class="text-muted">Use this hexadecimal string to program the ROM directly</small>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="conversion-step">
                                <strong>Verilog Code:</strong>
                                <pre class="mt-2 small">${formats.verilog}</pre>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="conversion-step">
                                <strong>VHDL Code:</strong>
                                <pre class="mt-2 small">${formats.vhdl}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('rom-results-container').insertAdjacentHTML('beforeend', exportHTML);
    }

    function updateMemoryOperationDescription(romType) {
        const descriptions = {
            'decimal-excess3': 'Decimal to Excess-3 ROM Converter',
            'custom-function': 'Custom Boolean Function ROM',
            'full-adder': 'Full Adder Carry ROM',
            'seven-segment': '7-Segment Decoder ROM'
        };
        
        document.getElementById('memory-operation-description').innerHTML = 
            `<strong>${descriptions[romType] || 'ROM Programming'}</strong><br>
             ${currentROMData.description}<br>
             <small>HEX ROM: ${currentROMData.hexROMContent}</small>`;
    }

    function hideAllMemorySections() {
        const sections = [
            'address-decoding-inputs',
            'cache-mapping-inputs',
            'tlb-operation-inputs',
            'memory-alignment-inputs',
            'rom-programming-inputs'
        ];
        
        sections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) section.style.display = 'none';
        });
        
        const resultSections = [
            'address-decoding-results',
            'cache-mapping-results',
            'tlb-operation-results',
            'memory-alignment-results',
            'rom-programming-results'
        ];
        
        resultSections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) section.style.display = 'none';
        });
    }

    // Utility functions for export
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Copied to clipboard!');
        });
    };

    window.downloadFile = function(filename, content) {
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    window.showExportPreview = function() {
        alert(`HEX ROM Content Preview:\n\n${currentROMData.hexROMContent}\n\nThis is the main hexadecimal representation of the ROM contents that can be used for programming.`);
    };
});
// Add this to the JavaScript section
document.getElementById('prom-burning-btn').addEventListener('click', function() {
    // Hide all other sections
    hideAllSections();
    document.getElementById('prom-burning-inputs').style.display = 'block';
    document.getElementById('prom-burning-results').style.display = 'block';
    
    // Update description
    document.getElementById('memory-operation-description').innerHTML = 
        '<strong>PROM Burning:</strong> Programmable Read-Only Memory burning simulation. Generate memory contents for various digital logic applications.';
});

document.getElementById('close-prom-btn').addEventListener('click', function() {
    document.getElementById('prom-burning-inputs').style.display = 'none';
    document.getElementById('prom-burning-results').style.display = 'none';
    resetPROMInterface();
});

document.getElementById('generate-prom-btn').addEventListener('click', function() {
    generatePROMContents();
});

document.getElementById('show-prom-truth-table-btn').addEventListener('click', function() {
    showPROMTruthTable();
});

document.getElementById('simulate-prom-btn').addEventListener('click', function() {
    simulatePROMBurning();
});

// Function to generate PROM contents
function generatePROMContents() {
    const promType = document.getElementById('prom-type-select').value;
    const resultsContainer = document.getElementById('prom-results-container');
    
    let promContents = [];
    let title = '';
    let description = '';
    
    switch(promType) {
        case '7segment':
            title = '4-bit Binary to 7-Segment Display Decoder';
            description = 'Converts 4-bit binary input (0-9) to 7-segment display patterns.';
            promContents = generate7SegmentPROM();
            break;
        case 'binary-gray':
            title = 'Binary to Gray Code Converter';
            description = 'Converts 4-bit binary to Gray code using XOR logic.';
            promContents = generateBinaryGrayPROM();
            break;
        case 'full-adder':
            title = 'Full Adder Implementation';
            description = 'Implements full adder (Sum and Carry outputs) in PROM.';
            promContents = generateFullAdderPROM();
            break;
        case 'custom-function':
            title = 'Custom Boolean Function';
            description = 'User-defined function based on minterms and don\'t cares.';
            promContents = generateCustomPROM();
            break;
    }
    
    // Display results
    resultsContainer.innerHTML = `
        <div class="text-center mb-3">
            <h5>${title}</h5>
            <p>${description}</p>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="binary-table">
                    <h6>PROM Memory Map</h6>
                    <div id="prom-visualization" class="text-center">
                        <!-- Visual representation will be added here -->
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Generate visualization
    generatePROMVisualization(promContents, promType);
    
    // Update stats
    updatePROMStats(promType);
}

// Function to generate 7-segment PROM contents
function generate7SegmentPROM() {
    const displayType = document.getElementById('prom-display-type').value;
    
    // 7-segment patterns for common anode (active HIGH)
    const segmentPatternsCommonAnode = [
        '1111110', // 0
        '0110000', // 1
        '1101101', // 2
        '1111001', // 3
        '0110011', // 4
        '1011011', // 5
        '1011111', // 6
        '1110000', // 7
        '1111111', // 8
        '1111011', // 9
        '0000000', // A (blank)
        '0000000', // B (blank)
        '0000000', // C (blank)
        '0000000', // D (blank)
        '0000000', // E (blank)
        '0000000'  // F (blank)
    ];
    
    // For common cathode, invert the patterns
    let promContents = [];
    for (let i = 0; i < 16; i++) {
        let pattern = segmentPatternsCommonAnode[i] || '0000000';
        if (displayType === 'common-cathode') {
            // Invert for common cathode (active LOW)
            pattern = pattern.split('').map(bit => bit === '1' ? '0' : '1').join('');
        }
        promContents.push({
            address: i,
            binaryInput: i.toString(2).padStart(4, '0'),
            pattern: pattern,
            hex: parseInt(pattern, 2).toString(16).toUpperCase().padStart(2, '0'),
            active: i <= 9
        });
    }
    
    return promContents;
}

// Function to show PROM truth table
function showPROMTruthTable() {
    const promContents = getCurrentPROMContents();
    const tableBody = document.getElementById('prom-truth-table-body');
    
    let html = '';
    promContents.forEach(item => {
        html += `
            <tr class="${item.active ? 'active-row' : ''}">
                <td>${item.address}</td>
                <td>${item.binaryInput}</td>
                <td>${item.pattern}</td>
                <td>0x${item.hex}</td>
                <td>
                    <span class="badge ${item.active ? 'bg-success' : 'bg-secondary'}">
                        ${item.active ? 'Active' : 'Blank'}
                    </span>
                </td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
    document.getElementById('prom-truth-table-container').style.display = 'block';
}

// Function to simulate PROM burning
function simulatePROMBurning() {
    const progressBar = document.getElementById('prom-burning-progress');
    const statusText = document.getElementById('prom-burning-status');
    
    document.getElementById('prom-burning-visualization').style.display = 'block';
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += 5;
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;
        
        if (progress <= 25) {
            statusText.textContent = 'Erasing PROM...';
        } else if (progress <= 50) {
            statusText.textContent = 'Programming address lines...';
        } else if (progress <= 75) {
            statusText.textContent = 'Burning data patterns...';
        } else if (progress <= 95) {
            statusText.textContent = 'Verifying contents...';
        } else {
            statusText.textContent = ' PROM Burning Complete!';
            statusText.className = 'text-success fw-bold';
            clearInterval(interval);
            
            // Show success message
            setTimeout(() => {
                alert('PROM successfully programmed! Ready for use in digital circuits.');
            }, 500);
        }
    }, 100);
}

// Function to reset PROM interface
function resetPROMInterface() {
    document.getElementById('prom-truth-table-container').style.display = 'none';
    document.getElementById('prom-burning-visualization').style.display = 'none';
    document.getElementById('prom-export-formats').style.display = 'none';
    
    const progressBar = document.getElementById('prom-burning-progress');
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    
    const statusText = document.getElementById('prom-burning-status');
    statusText.textContent = 'Ready to burn...';
    statusText.className = '';
}

// Helper function to generate PROM visualization
function generatePROMVisualization(contents, type) {
    const container = document.getElementById('prom-visualization');
    let html = '';
    
    html += '<div class="prom-grid">';
    contents.forEach(item => {
        html += `
            <div class="prom-cell ${item.active ? 'active' : 'inactive'}" 
                 title="Addr: ${item.address} (0x${item.address.toString(16).toUpperCase()})">
                <div class="prom-address">${item.address}</div>
                <div class="prom-pattern">${item.pattern}</div>
                <div class="prom-hex">${item.hex}</div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Add this CSS for PROM visualization
const promCSS = `
.prom-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin: 20px 0;
}

.prom-cell {
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
}

.prom-cell.active {
    background: rgba(34, 139, 34, 0.2);
    border-color: var(--success-color);
    box-shadow: 0 0 10px rgba(34, 139, 34, 0.3);
}

.prom-cell.inactive {
    background: rgba(128, 128, 128, 0.1);
    border-color: #ccc;
}

.prom-address {
    font-weight: bold;
    color: var(--primary-color);
    font-size: 1.2rem;
}

.prom-pattern {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    margin: 5px 0;
    letter-spacing: 2px;
}

.prom-hex {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: var(--info-color);
    background: rgba(135, 206, 235, 0.2);
    padding: 2px 5px;
    border-radius: 3px;
    display: inline-block;
}

.prom-cell:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}
`;

// Add the CSS to the page
const styles1 = document.createElement('style');
styles1.textContent = promCSS;
document.head.appendChild(styles1);
// Add these missing helper functions at the beginning

// Function to hide all sections (replace with your existing hideAllSections function)
function hideAllSections() {
    // Hide all other memory operation sections
    const sections = [
        'address-decoding-inputs', 'cache-mapping-inputs', 
        'tlb-operation-inputs', 'memory-alignment-inputs',
        'rom-programming-inputs', 'prom-burning-inputs'
    ];
    
    sections.forEach(section => {
        document.getElementById(section).style.display = 'none';
    });
    
    // Hide all result sections
    const resultSections = [
        'address-decoding-results', 'cache-mapping-results',
        'tlb-operation-results', 'memory-alignment-results',
        'rom-programming-results', 'prom-burning-results'
    ];
    
    resultSections.forEach(section => {
        document.getElementById(section).style.display = 'none';
    });
}

// Function to get current PROM contents based on type
function getCurrentPROMContents() {
    const promType = document.getElementById('prom-type-select').value;
    
    switch(promType) {
        case '7segment':
            return generate7SegmentPROM();
        case 'binary-gray':
            return generateBinaryGrayPROM();
        case 'full-adder':
            return generateFullAdderPROM();
        case 'custom-function':
            return generateCustomPROM();
        default:
            return generate7SegmentPROM(); // Default
    }
}

// Function to generate Binary to Gray PROM contents
function generateBinaryGrayPROM() {
    let promContents = [];
    for (let i = 0; i < 16; i++) {
        const binary = i.toString(2).padStart(4, '0');
        // Gray code conversion: G0 = B0 xor B1, G1 = B1 xor B2, G2 = B2 xor B3, G3 = B3
        const b3 = parseInt(binary[0]);
        const b2 = parseInt(binary[1]);
        const b1 = parseInt(binary[2]);
        const b0 = parseInt(binary[3]);
        
        const g3 = b3;
        const g2 = b3 ^ b2;
        const g1 = b2 ^ b1;
        const g0 = b1 ^ b0;
        
        const pattern = `${g3}${g2}${g1}${g0}`;
        
        promContents.push({
            address: i,
            binaryInput: binary,
            pattern: pattern,
            hex: parseInt(pattern, 2).toString(16).toUpperCase().padStart(1, '0'),
            active: true
        });
    }
    return promContents;
}

// Function to generate Full Adder PROM contents
function generateFullAdderPROM() {
    let promContents = [];
    for (let i = 0; i < 8; i++) { // 3 inputs = 8 addresses
        const binary = i.toString(2).padStart(3, '0');
        const a = parseInt(binary[0]);
        const b = parseInt(binary[1]);
        const cin = parseInt(binary[2]);
        
        // Full adder logic
        const sum = a ^ b ^ cin;
        const carry = (a & b) | (b & cin) | (cin & a);
        const pattern = `${carry}${sum}`;
        
        promContents.push({
            address: i,
            binaryInput: binary,
            pattern: pattern,
            hex: parseInt(pattern, 2).toString(16).toUpperCase().padStart(1, '0'),
            active: true
        });
    }
    
    // Fill remaining addresses with zeros
    for (let i = 8; i < 16; i++) {
        promContents.push({
            address: i,
            binaryInput: i.toString(2).padStart(4, '0'),
            pattern: '00',
            hex: '0',
            active: false
        });
    }
    return promContents;
}

// Function to generate Custom PROM contents
function generateCustomPROM() {
    const mintermsInput = document.getElementById('prom-minterms').value;
    const dontcaresInput = document.getElementById('prom-dontcares').value;
    const outputWidth = parseInt(document.getElementById('prom-output-width').value);
    
    // Parse minterms and don't cares
    const minterms = mintermsInput ? mintermsInput.split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m)) : [];
    const dontcares = dontcaresInput ? dontcaresInput.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d)) : [];
    
    // Default pattern for empty outputs
    const defaultPattern = '0'.repeat(outputWidth);
    const activePattern = '1'.repeat(outputWidth);
    const dontcarePattern = '10101010'.slice(0, outputWidth);
    
    let promContents = [];
    for (let i = 0; i < 16; i++) {
        let pattern = defaultPattern;
        let active = false;
        
        if (minterms.includes(i)) {
            pattern = activePattern;
            active = true;
        } else if (dontcares.includes(i)) {
            pattern = dontcarePattern;
            active = true;
        }
        
        promContents.push({
            address: i,
            binaryInput: i.toString(2).padStart(4, '0'),
            pattern: pattern,
            hex: parseInt(pattern, 2).toString(16).toUpperCase().padStart(Math.ceil(outputWidth/4), '0'),
            active: active
        });
    }
    return promContents;
}

// Function to update PROM stats
function updatePROMStats(promType) {
    const addressLines = 4; // Always 4 address lines for 16 locations
    let outputLines = 0;
    let size = 0;
    
    switch(promType) {
        case '7segment':
            outputLines = 7;
            size = 16 * 7;
            document.getElementById('prom-type-badge').textContent = '4-bit to 7-Segment Display';
            document.getElementById('prom-size-badge').textContent = '16  7-bit';
            break;
        case 'binary-gray':
            outputLines = 4;
            size = 16 * 4;
            document.getElementById('prom-type-badge').textContent = 'Binary to Gray Code';
            document.getElementById('prom-size-badge').textContent = '16  4-bit';
            break;
        case 'full-adder':
            outputLines = 2;
            size = 16 * 2;
            document.getElementById('prom-type-badge').textContent = 'Full Adder';
            document.getElementById('prom-size-badge').textContent = '16  2-bit';
            break;
        case 'custom-function':
            outputLines = parseInt(document.getElementById('prom-output-width').value);
            size = 16 * outputLines;
            document.getElementById('prom-type-badge').textContent = 'Custom Function';
            document.getElementById('prom-size-badge').textContent = `16  ${outputLines}-bit`;
            break;
    }
    
    document.getElementById('prom-address-lines').textContent = addressLines;
    document.getElementById('prom-output-lines').textContent = outputLines;
    document.getElementById('prom-locations').textContent = 16;
    document.getElementById('prom-size').textContent = `${size} bits`;
}

// Now add the event listeners after defining all functions
document.addEventListener('DOMContentLoaded', function() {
    // PROM Burning button event listener
    const promBurningBtn = document.getElementById('prom-burning-btn');
    if (promBurningBtn) {
        promBurningBtn.addEventListener('click', function() {
            // Hide all other sections
            hideAllSections();
            document.getElementById('prom-burning-inputs').style.display = 'block';
            document.getElementById('prom-burning-results').style.display = 'block';
            
            // Update description
            document.getElementById('memory-operation-description').innerHTML = 
                '<strong>PROM Burning:</strong> Programmable Read-Only Memory burning simulation. Generate memory contents for various digital logic applications.';
        });
    }
    
    // Close PROM button
    const closePromBtn = document.getElementById('close-prom-btn');
    if (closePromBtn) {
        closePromBtn.addEventListener('click', function() {
            document.getElementById('prom-burning-inputs').style.display = 'none';
            document.getElementById('prom-burning-results').style.display = 'none';
            resetPROMInterface();
        });
    }
    
    // Generate PROM button
    const generatePromBtn = document.getElementById('generate-prom-btn');
    if (generatePromBtn) {
        generatePromBtn.addEventListener('click', generatePROMContents);
    }
    
    // Show truth table button
    const showTruthTableBtn = document.getElementById('show-prom-truth-table-btn');
    if (showTruthTableBtn) {
        showTruthTableBtn.addEventListener('click', showPROMTruthTable);
    }
    
    // Simulate burning button
    const simulatePromBtn = document.getElementById('simulate-prom-btn');
    if (simulatePromBtn) {
        simulatePromBtn.addEventListener('click', simulatePROMBurning);
    }
    
    // Update inputs when PROM type changes
    const promTypeSelect = document.getElementById('prom-type-select');
    if (promTypeSelect) {
        promTypeSelect.addEventListener('change', function() {
            const type = this.value;
            document.getElementById('prom-custom-inputs').style.display = 
                (type === 'custom-function') ? 'block' : 'none';
            document.getElementById('prom-7segment-info').style.display = 
                (type === '7segment') ? 'block' : 'none';
        });
    }
    
    // Initialize display
    document.getElementById('prom-custom-inputs').style.display = 'none';
    document.getElementById('prom-7segment-info').style.display = 'block';
});

// Export Hex File functionality
document.getElementById('export-prom-hex-btn').addEventListener('click', function() {
    const promContents = getCurrentPROMContents();
    const promType = document.getElementById('prom-type-select').value;
    
    // Generate Intel HEX format
    let hexOutput = '';
    let binaryOutput = '';
    
    // Intel HEX format header
    hexOutput += ':020000040000FA\n'; // Extended linear address 0000
    
    // Process in chunks of 8 (standard for HEX files)
    for (let i = 0; i < 16; i += 8) {
        const chunk = promContents.slice(i, i + 8);
        const byteCount = chunk.length;
        const address = i.toString(16).toUpperCase().padStart(4, '0');
        const recordType = '00';
        
        // Combine data bytes
        let data = '';
        chunk.forEach(item => {
            data += item.hex.padStart(2, '0');
        });
        
        // Calculate checksum
        let checksum = byteCount + 
                      parseInt(address.substr(0, 2), 16) + 
                      parseInt(address.substr(2, 2), 16) + 
                      parseInt(recordType, 16);
        
        // Add data bytes to checksum
        for (let j = 0; j < data.length; j += 2) {
            checksum += parseInt(data.substr(j, 2), 16);
        }
        
        checksum = (0x100 - (checksum & 0xFF)) & 0xFF;
        checksum = checksum.toString(16).toUpperCase().padStart(2, '0');
        
        hexOutput += `:${byteCount.toString(16).toUpperCase().padStart(2, '0')}${address}${recordType}${data}${checksum}\n`;
        
        // Also build binary output
        chunk.forEach(item => {
            binaryOutput += `${item.pattern} `;
        });
    }
    
    // End of file record
    hexOutput += ':00000001FF';
    
    // Show export formats
    document.getElementById('prom-hex-output').textContent = hexOutput;
    document.getElementById('prom-binary-output').textContent = binaryOutput.trim();
    document.getElementById('prom-export-formats').style.display = 'block';
    
    // Option to download the file
    const blob = new Blob([hexOutput], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prom_${promType}.hex`;
    a.click();
    URL.revokeObjectURL(url);
});

// Clock Skew Analyzer Implementation
// Clock Skew Analyzer Implementation
class ClockSkewAnalyzer {
    constructor(samplingRate = 1.0) {
        this.samplingRate = samplingRate;
        this.timestamps = null;
        this.deltas = null;
        this.skewEstimate = null;
        this.results = {};
    }
    
    generateSyntheticData(nSamples = 1000, trueSkew = 0.001, noiseStd = 0.0001, driftRate = 1e-8) {
        // Time vector
        const t = Array.from({length: nSamples}, (_, i) => i / this.samplingRate);
        
        // Generate true timestamps with skew and drift
        const trueTime = t.map(time => time + 0.5 * driftRate * Math.pow(time, 2));
        const skewedTime = trueTime.map(time => time * (1 + trueSkew));
        
        // Add measurement noise
        const noise = Array.from({length: nSamples}, () => (Math.random() - 0.5) * 2 * noiseStd);
        this.timestamps = skewedTime.map((time, i) => time + noise[i]);
        
        // Store true parameters for reference
        this.trueParams = {
            skew: trueSkew,
            drift: driftRate,
            noiseStd: noiseStd
        };
        
        return this.timestamps;
    }
    
    computeDeltas() {
        if (!this.timestamps) {
            throw new Error("No timestamp data loaded. Generate or load data first.");
        }
        
        this.deltas = [];
        for (let i = 1; i < this.timestamps.length; i++) {
            this.deltas.push(this.timestamps[i] - this.timestamps[i - 1]);
        }
        
        return this.deltas;
    }
    
    linearRegressionMethod() {
        if (!this.timestamps) {
            this.generateSyntheticData();
        }
        
        // Time vector
        const t = Array.from({length: this.timestamps.length}, (_, i) => i / this.samplingRate);
        
        // Perform linear regression
        const n = t.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        
        for (let i = 0; i < n; i++) {
            sumX += t[i];
            sumY += this.timestamps[i];
            sumXY += t[i] * this.timestamps[i];
            sumX2 += t[i] * t[i];
        }
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        // Calculate R-squared
        let ssRes = 0, ssTot = 0;
        const yMean = sumY / n;
        
        for (let i = 0; i < n; i++) {
            const yPred = slope * t[i] + intercept;
            ssRes += Math.pow(this.timestamps[i] - yPred, 2);
            ssTot += Math.pow(this.timestamps[i] - yMean, 2);
        }
        
        const rSquared = 1 - (ssRes / ssTot);
        this.skewEstimate = slope - 1; // Relative skew
        
        this.regressionResults = {
            slope: slope,
            intercept: intercept,
            rSquared: rSquared,
            skew: this.skewEstimate
        };
        
        return { skew: this.skewEstimate, intercept: intercept, rSquared: rSquared };
    }
    
    pairwiseDifferenceMethod() {
        if (!this.timestamps) {
            this.generateSyntheticData();
        }
        
        const n = this.timestamps.length;
        const t = Array.from({length: n}, (_, i) => i / this.samplingRate);
        const skews = [];
        
        // Compute pairwise differences (limited to first 1000 pairs for efficiency)
        const maxPairs = Math.min(1000, n * (n - 1) / 2);
        let pairsComputed = 0;
        
        for (let i = 0; i < n && pairsComputed < maxPairs; i++) {
            for (let j = i + 1; j < Math.min(i + 10, n) && pairsComputed < maxPairs; j++) {
                const dt = t[j] - t[i];
                if (dt > 0) {
                    const skew = (this.timestamps[j] - this.timestamps[i]) / dt - 1;
                    skews.push(skew);
                    pairsComputed++;
                }
            }
        }
        
        // Calculate statistics
        const mean = skews.reduce((a, b) => a + b, 0) / skews.length;
        const sorted = [...skews].sort((a, b) => a - b);
        const median = sorted[Math.floor(sorted.length / 2)];
        
        const variance = skews.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / skews.length;
        const std = Math.sqrt(variance);
        
        this.pairwiseStats = {
            median: median,
            mean: mean,
            std: std,
            nPairs: skews.length
        };
        
        return median;
    }
    
    statisticalAnalysis() {
        if (!this.timestamps) {
            this.generateSyntheticData();
        }
        
        if (!this.deltas) {
            this.computeDeltas();
        }
        
        // Calculate statistics
        const mean = this.deltas.reduce((a, b) => a + b, 0) / this.deltas.length;
        const sorted = [...this.deltas].sort((a, b) => a - b);
        const median = sorted[Math.floor(sorted.length / 2)];
        const min = Math.min(...this.deltas);
        const max = Math.max(...this.deltas);
        
        const variance = this.deltas.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / this.deltas.length;
        const std = Math.sqrt(variance);
        
        // Skewness
        const skewness = this.deltas.reduce((sum, val) => sum + Math.pow((val - mean) / std, 3), 0) / this.deltas.length;
        
        this.statistics = {
            meanDelta: mean,
            stdDelta: std,
            minDelta: min,
            maxDelta: max,
            medianDelta: median,
            skewness: skewness,
            nSamples: this.deltas.length
        };
        
        return this.statistics;
    }
    
    detectOutliers(threshold = 3.0) {
        if (!this.deltas) {
            this.computeDeltas();
        }
        
        // Use IQR method for outlier detection
        const sorted = [...this.deltas].sort((a, b) => a - b);
        const q1 = sorted[Math.floor(sorted.length * 0.25)];
        const q3 = sorted[Math.floor(sorted.length * 0.75)];
        const iqr = q3 - q1;
        const lowerBound = q1 - threshold * iqr;
        const upperBound = q3 + threshold * iqr;
        
        const outlierIndices = [];
        const outlierValues = [];
        
        for (let i = 0; i < this.deltas.length; i++) {
            if (this.deltas[i] < lowerBound || this.deltas[i] > upperBound) {
                outlierIndices.push(i);
                outlierValues.push(this.deltas[i]);
            }
        }
        
        this.outliers = {
            indices: outlierIndices,
            values: outlierValues,
            method: 'iqr',
            threshold: threshold,
            lowerBound: lowerBound,
            upperBound: upperBound
        };
        
        return outlierIndices;
    }
    
    generateReport() {
        let report = "=".repeat(60) + "\n";
        report += "CLOCK SKEW ANALYSIS REPORT\n";
        report += "=".repeat(60) + "\n\n";
        
        // Basic information
        report += `Analysis Time: ${new Date().toLocaleString()}\n`;
        report += `Number of samples: ${this.timestamps ? this.timestamps.length : 0}\n`;
        report += `Sampling rate: ${this.samplingRate} Hz\n`;
        const duration = this.timestamps ? this.timestamps.length / this.samplingRate : 0;
        report += `Duration: ${duration.toFixed(2)} seconds\n\n`;
        
        // Statistical analysis
        if (this.statistics) {
            report += "STATISTICAL ANALYSIS:\n";
            report += "-".repeat(40) + "\n";
            for (const [key, value] of Object.entries(this.statistics)) {
                report += `${key.padEnd(20)}: ${value.toFixed(6)}\n`;
            }
            report += "\n";
        }
        
        // Skew estimation results
        report += "SKEW ESTIMATION RESULTS:\n";
        report += "-".repeat(40) + "\n";
        
        if (this.regressionResults) {
            report += "Linear Regression:\n";
            report += `  Estimated skew: ${this.regressionResults.skew.toExponential(6)}\n`;
            report += `  Confidence (R): ${this.regressionResults.rSquared.toFixed(4)}\n\n`;
        }
        
        if (this.pairwiseStats) {
            report += "Pairwise Difference:\n";
            report += `  Median skew: ${this.pairwiseStats.median.toExponential(6)}\n`;
            report += `  Mean skew: ${this.pairwiseStats.mean.toExponential(6)}\n`;
            report += `  Std deviation: ${this.pairwiseStats.std.toExponential(6)}\n\n`;
        }
        
        // True parameters (if synthetic data)
        if (this.trueParams) {
            report += "TRUE PARAMETERS (Synthetic Data):\n";
            report += "-".repeat(40) + "\n";
            report += `True skew: ${this.trueParams.skew.toExponential(6)}\n`;
            report += `Drift rate: ${this.trueParams.drift.toExponential(6)}\n`;
            report += `Noise std: ${this.trueParams.noiseStd.toExponential(6)}\n\n`;
        }
        
        // Outlier detection
        if (this.outliers) {
            report += "OUTLIER DETECTION:\n";
            report += "-".repeat(40) + "\n";
            report += `Method: ${this.outliers.method}\n`;
            report += `Threshold: ${this.outliers.threshold}\n`;
            report += `Number of outliers: ${this.outliers.indices.length}\n`;
            if (this.outliers.indices.length > 0) {
                const percentage = (this.outliers.indices.length / this.deltas.length) * 100;
                report += `Outlier percentage: ${percentage.toFixed(2)}%\n`;
            }
            report += "\n";
        }
        
        // Recommendations
        report += "RECOMMENDATIONS:\n";
        report += "-".repeat(40) + "\n";
        
        if (this.statistics) {
            if (this.statistics.stdDelta > 0.01) {
                report += "  High jitter detected. Consider:\n";
                report += "   - Improving clock source stability\n";
                report += "   - Using hardware timestamping\n";
                report += "   - Implementing jitter buffers\n";
            }
            
            if (this.regressionResults) {
                const skewMagnitude = Math.abs(this.regressionResults.skew);
                if (skewMagnitude > 1e-4) {
                    report += `  Significant clock skew (${skewMagnitude.toExponential(2)}). Consider:\n`;
                    report += "   - Clock synchronization (NTP/PTP)\n";
                    report += "   - Hardware-assisted synchronization\n";
                    report += "   - Skew compensation algorithms\n";
                } else if (skewMagnitude < 1e-6) {
                    report += "  Clock skew is within acceptable limits\n";
                }
            }
        }
        
        report += "=".repeat(60) + "\n";
        
        return report;
    }
}

// Event Listeners for Clock Skew Analysis
document.addEventListener('DOMContentLoaded', function() {
    let clockSkewAnalyzer = null;
    
    // Check if elements exist before adding event listeners
    const clockSkewBtn = document.getElementById('clock-skew-btn');
    const closeSkewBtn = document.getElementById('close-skew-btn');
    const generateSkewDataBtn = document.getElementById('generate-skew-data-btn');
    const analyzeSkewBtn = document.getElementById('analyze-skew-btn');
    const showSkewReportBtn = document.getElementById('show-skew-report-btn');
    
    if (clockSkewBtn) {
        // Show Clock Skew Analysis inputs
        clockSkewBtn.addEventListener('click', function() {
            // Hide other input sections
            hideAllInputSections();
            
            // Show Clock Skew Analysis inputs
            const clockSkewInputs = document.getElementById('clock-skew-inputs');
            if (clockSkewInputs) {
                clockSkewInputs.style.display = 'block';
            }
            
            // Clear previous results
            clearClockSkewResults();
        });
    }
    
    if (closeSkewBtn) {
        // Close Clock Skew Analysis
        closeSkewBtn.addEventListener('click', function() {
            const clockSkewInputs = document.getElementById('clock-skew-inputs');
            if (clockSkewInputs) {
                clockSkewInputs.style.display = 'none';
            }
            clearClockSkewResults();
        });
    }
    
    if (generateSkewDataBtn) {
        // Generate Synthetic Data
        generateSkewDataBtn.addEventListener('click', function() {
            try {
                const samplingRate = parseFloat(document.getElementById('skew-sampling-rate').value) || 10.0;
                const nSamples = parseInt(document.getElementById('skew-n-samples').value) || 1000;
                const trueSkew = parseFloat(document.getElementById('skew-true-skew').value) || 0.0005;
                const noiseStd = parseFloat(document.getElementById('skew-noise-std').value) || 0.0002;
                const driftRate = parseFloat(document.getElementById('skew-drift-rate').value) || 1e-7;
                
                clockSkewAnalyzer = new ClockSkewAnalyzer(samplingRate);
                clockSkewAnalyzer.generateSyntheticData(nSamples, trueSkew, noiseStd, driftRate);
                clockSkewAnalyzer.computeDeltas();
                
                showMessage('success', `Generated ${nSamples} synthetic timestamp samples with ${(trueSkew * 1e6).toFixed(2)} ppm skew`);
                
                // Display basic statistics
                displayBasicStatistics();
                
            } catch (error) {
                showMessage('error', `Error generating data: ${error.message}`);
            }
        });
    }
    
    if (analyzeSkewBtn) {
        // Analyze Clock Skew
        analyzeSkewBtn.addEventListener('click', function() {
            if (!clockSkewAnalyzer || !clockSkewAnalyzer.timestamps) {
                showMessage('error', 'Please generate synthetic data first');
                return;
            }
            
            try {
                // Perform all analyses
                const regression = clockSkewAnalyzer.linearRegressionMethod();
                const pairwise = clockSkewAnalyzer.pairwiseDifferenceMethod();
                clockSkewAnalyzer.statisticalAnalysis();
                clockSkewAnalyzer.detectOutliers(3.0);
                
                // Display results
                displayAnalysisResults(regression, pairwise);
                showMessage('success', 'Clock skew analysis completed successfully');
                
            } catch (error) {
                showMessage('error', `Error analyzing skew: ${error.message}`);
            }
        });
    }
    
    if (showSkewReportBtn) {
        // Generate Report
        showSkewReportBtn.addEventListener('click', function() {
            if (!clockSkewAnalyzer) {
                showMessage('error', 'Please generate and analyze data first');
                return;
            }
            
            try {
                const report = clockSkewAnalyzer.generateReport();
                displayReport(report);
                showMessage('success', 'Report generated successfully');
                
            } catch (error) {
                showMessage('error', `Error generating report: ${error.message}`);
            }
        });
    }
    
    // Helper functions
    function hideAllInputSections() {
        const sections = [
            't-flipflop-inputs',
            'register-storage-inputs',
            'shift-register-inputs',
            'master-slave-inputs',
            'setup-time-inputs',
            'hold-time-inputs'
        ];
        
        sections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'none';
            }
        });
    }
    
    function clearClockSkewResults() {
        const resultsDiv = document.getElementById('sequential2-results');
        if (resultsDiv) {
            resultsDiv.innerHTML = '<div class="text-center mt-5"><p>Clock Skew Analysis results will be displayed here</p></div>';
        }
        
        const analysisDiv = document.getElementById('sequential2-analysis');
        if (analysisDiv) {
            analysisDiv.style.display = 'none';
        }
    }
    
    function displayBasicStatistics() {
        if (!clockSkewAnalyzer || !clockSkewAnalyzer.statistics) {
            clockSkewAnalyzer.statisticalAnalysis();
        }
        
        const stats = clockSkewAnalyzer.statistics;
        const resultsDiv = document.getElementById('sequential2-results');
        
        if (!resultsDiv) return;
        
        let html = `
            <div class="glass-card">
                <h5 class="text-center mb-3">Basic Statistics</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-value">${stats.meanDelta.toFixed(6)}</div>
                            <small>Mean Delta (s)</small>
                        </div>
                        <div class="stats-card mt-2">
                            <div class="stats-value">${stats.stdDelta.toFixed(6)}</div>
                            <small>Std Dev Delta (s)</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-value">${stats.minDelta.toFixed(6)}</div>
                            <small>Min Delta (s)</small>
                        </div>
                        <div class="stats-card mt-2">
                            <div class="stats-value">${stats.maxDelta.toFixed(6)}</div>
                            <small>Max Delta (s)</small>
                        </div>
                    </div>
                </div>
                <div class="gate-description mt-3">
                    <p>Generated ${clockSkewAnalyzer.timestamps.length} timestamp samples at ${clockSkewAnalyzer.samplingRate} Hz sampling rate.</p>
                </div>
            </div>
        `;
        
        resultsDiv.innerHTML = html;
    }
    
    function displayAnalysisResults(regression, pairwise) {
        const analysisDiv = document.getElementById('sequential2-analysis');
        const stepsContainer = document.getElementById('sequential2-steps-container');
        
        if (!analysisDiv || !stepsContainer) return;
        
        let html = `
            <div class="special-analysis-step active">
                <div class="calculation-title">Linear Regression Analysis</div>
                <div class="calculation-content">
                    Estimated skew: <span class="highlight-equation">${regression.skew.toExponential(6)} s/s</span><br>
                    R-squared: <span class="highlight-equation">${regression.rSquared.toFixed(4)}</span><br>
                    Intercept: ${regression.intercept.toFixed(6)} s
                </div>
            </div>
            
            <div class="special-analysis-step">
                <div class="calculation-title">Pairwise Difference Analysis</div>
                <div class="calculation-content">
                    Median skew: <span class="highlight-equation">${pairwise.toExponential(6)} s/s</span><br>
                    Mean skew: ${clockSkewAnalyzer.pairwiseStats.mean.toExponential(6)} s/s<br>
                    Standard deviation: ${clockSkewAnalyzer.pairwiseStats.std.toExponential(6)} s/s<br>
                    Number of pairs analyzed: ${clockSkewAnalyzer.pairwiseStats.nPairs}
                </div>
            </div>
            
            <div class="special-analysis-step">
                <div class="calculation-title">Outlier Detection</div>
                <div class="calculation-content">
                    Method: ${clockSkewAnalyzer.outliers.method}<br>
                    Threshold: ${clockSkewAnalyzer.outliers.threshold}<br>
                    Outliers detected: <span class="special-highlight">${clockSkewAnalyzer.outliers.indices.length}</span><br>
                    Outlier percentage: ${((clockSkewAnalyzer.outliers.indices.length / clockSkewAnalyzer.deltas.length) * 100).toFixed(2)}%
                </div>
            </div>
            
            <div class="special-analysis-step">
                <div class="calculation-title">True Parameters (Synthetic Data)</div>
                <div class="calculation-content">
                    True skew: ${clockSkewAnalyzer.trueParams.skew.toExponential(6)} s/s<br>
                    Drift rate: ${clockSkewAnalyzer.trueParams.drift.toExponential(6)} s/s<br>
                    Noise standard deviation: ${clockSkewAnalyzer.trueParams.noiseStd.toExponential(6)} s
                </div>
            </div>
        `;
        
        stepsContainer.innerHTML = html;
        analysisDiv.style.display = 'block';
        const analysisTitle = document.getElementById('sequential2-analysis-title');
        if (analysisTitle) {
            analysisTitle.textContent = 'Clock Skew Analysis Results';
        }
    }
    
    function displayReport(report) {
        const analysisDiv = document.getElementById('sequential2-analysis');
        const stepsContainer = document.getElementById('sequential2-steps-container');
        
        if (!analysisDiv || !stepsContainer) return;
        
        let html = `
            <div class="special-analysis-step active">
                <div class="calculation-title">Complete Analysis Report</div>
                <div class="calculation-content" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; max-height: 400px; overflow-y: auto;">
                    ${report}
                </div>
            </div>
            
            <div class="special-analysis-step">
                <div class="calculation-title">Recommendations</div>
                <div class="calculation-content">
                    Based on the analysis:
                    ${getRecommendations()}
                </div>
            </div>
        `;
        
        stepsContainer.innerHTML = html;
        analysisDiv.style.display = 'block';
        const analysisTitle = document.getElementById('sequential2-analysis-title');
        if (analysisTitle) {
            analysisTitle.textContent = 'Clock Skew Analysis Report';
        }
    }
    
    function getRecommendations() {
        if (!clockSkewAnalyzer) return '';
        
        let recommendations = '';
        
        if (clockSkewAnalyzer.statistics && clockSkewAnalyzer.statistics.stdDelta > 0.01) {
            recommendations += '<div class="gate-description mt-2">';
            recommendations += '<strong> High Jitter Detected:</strong><br>';
            recommendations += '- Improve clock source stability<br>';
            recommendations += '- Use hardware timestamping<br>';
            recommendations += '- Implement jitter buffers';
            recommendations += '</div>';
        }
        
        if (clockSkewAnalyzer.regressionResults) {
            const skewMagnitude = Math.abs(clockSkewAnalyzer.regressionResults.skew);
            
            if (skewMagnitude > 1e-4) {
                recommendations += '<div class="gate-description mt-2">';
                recommendations += `<strong> Significant Clock Skew (${skewMagnitude.toExponential(2)}):</strong><br>`;
                recommendations += '- Implement clock synchronization (NTP/PTP)<br>';
                recommendations += '- Use hardware-assisted synchronization<br>';
                recommendations += '- Apply skew compensation algorithms';
                recommendations += '</div>';
            } else if (skewMagnitude < 1e-6) {
                recommendations += '<div class="gate-description mt-2">';
                recommendations += '<strong> Clock Skew Within Acceptable Limits</strong><br>';
                recommendations += 'No immediate action required';
                recommendations += '</div>';
            }
        }
        
        return recommendations || '<p>No specific recommendations based on current analysis.</p>';
    }
    
    function showMessage(type, text) {
        const resultsDiv = document.getElementById('sequential2-results');
        if (!resultsDiv) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'success' ? 'alert alert-success mt-3' : 'alert alert-danger mt-3';
        messageDiv.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>${text}`;
        
        resultsDiv.appendChild(messageDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 5000);
    }
});
// Event Listeners for Clock Skew Analysis
document.addEventListener('DOMContentLoaded', function() {
    let clockSkewAnalyzer = null;
    
    // Show Clock Skew Analysis inputs
    const clockSkewBtn = document.getElementById('clock-skew-btn');
    if (clockSkewBtn) {
        clockSkewBtn.addEventListener('click', function() {
            // Hide other input sections
            hideInputSections();
            
            // Show Clock Skew Analysis inputs
            const clockSkewInputs = document.getElementById('clock-skew-inputs');
            if (clockSkewInputs) {
                clockSkewInputs.style.display = 'block';
            }
            
            // Clear previous results
            clearClockSkewResults();
        });
    }
    
    // Close Clock Skew Analysis
    const closeSkewBtn = document.getElementById('close-skew-btn');
    if (closeSkewBtn) {
        closeSkewBtn.addEventListener('click', function() {
            const clockSkewInputs = document.getElementById('clock-skew-inputs');
            if (clockSkewInputs) {
                clockSkewInputs.style.display = 'none';
            }
            clearClockSkewResults();
        });
    }
    
    // Generate Synthetic Data
    const generateSkewDataBtn = document.getElementById('generate-skew-data-btn');
    if (generateSkewDataBtn) {
        generateSkewDataBtn.addEventListener('click', function() {
            try {
                const samplingRate = parseFloat(document.getElementById('skew-sampling-rate').value) || 10.0;
                const nSamples = parseInt(document.getElementById('skew-n-samples').value) || 1000;
                const trueSkew = parseFloat(document.getElementById('skew-true-skew').value) || 0.0005;
                const noiseStd = parseFloat(document.getElementById('skew-noise-std').value) || 0.0002;
                const driftRate = parseFloat(document.getElementById('skew-drift-rate').value) || 0.0000001;
                
                clockSkewAnalyzer = new ClockSkewAnalyzer(samplingRate);
                clockSkewAnalyzer.generateSyntheticData(nSamples, trueSkew, noiseStd, driftRate);
                clockSkewAnalyzer.computeDeltas();
                
                showMessage('success', 'Generated ' + nSamples + ' synthetic timestamp samples with ' + (trueSkew * 1000000).toFixed(2) + ' ppm skew');
                
                // Display basic statistics
                displayBasicStatistics();
                
            } catch (error) {
                showMessage('error', 'Error generating data: ' + error.message);
            }
        });
    }
    
    // Analyze Clock Skew
    const analyzeSkewBtn = document.getElementById('analyze-skew-btn');
    if (analyzeSkewBtn) {
        analyzeSkewBtn.addEventListener('click', function() {
            if (!clockSkewAnalyzer || !clockSkewAnalyzer.timestamps) {
                showMessage('error', 'Please generate synthetic data first');
                return;
            }
            
            try {
                // Perform all analyses
                const regression = clockSkewAnalyzer.linearRegressionMethod();
                const pairwise = clockSkewAnalyzer.pairwiseDifferenceMethod();
                clockSkewAnalyzer.statisticalAnalysis();
                clockSkewAnalyzer.detectOutliers(3.0);
                
                // Display results
                displayAnalysisResults(regression, pairwise);
                showMessage('success', 'Clock skew analysis completed successfully');
                
            } catch (error) {
                showMessage('error', 'Error analyzing skew: ' + error.message);
            }
        });
    }
    
    // Generate Report
    const showSkewReportBtn = document.getElementById('show-skew-report-btn');
    if (showSkewReportBtn) {
        showSkewReportBtn.addEventListener('click', function() {
            if (!clockSkewAnalyzer) {
                showMessage('error', 'Please generate and analyze data first');
                return;
            }
            
            try {
                const report = clockSkewAnalyzer.generateReport();
                displayReport(report);
                showMessage('success', 'Report generated successfully');
                
            } catch (error) {
                showMessage('error', 'Error generating report: ' + error.message);
            }
        });
    }
    
    // Helper functions
    function hideInputSections() {
        const sections = [
            't-flipflop-inputs',
            'register-storage-inputs',
            'shift-register-inputs',
            'master-slave-inputs',
            'setup-time-inputs',
            'hold-time-inputs'
        ];
        
        sections.forEach(function(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'none';
            }
        });
    }
    
    function clearClockSkewResults() {
        const resultsDiv = document.getElementById('sequential2-results');
        if (resultsDiv) {
            resultsDiv.innerHTML = '<div class="text-center mt-5"><p>Clock Skew Analysis results will be displayed here</p></div>';
        }
        
        const analysisDiv = document.getElementById('sequential2-analysis');
        if (analysisDiv) {
            analysisDiv.style.display = 'none';
        }
    }
    
    function displayBasicStatistics() {
        if (!clockSkewAnalyzer) return;
        
        if (!clockSkewAnalyzer.statistics) {
            clockSkewAnalyzer.statisticalAnalysis();
        }
        
        const stats = clockSkewAnalyzer.statistics;
        const resultsDiv = document.getElementById('sequential2-results');
        
        if (!resultsDiv) return;
        
        let html = '<div class="glass-card">';
        html += '<h5 class="text-center mb-3">Basic Statistics</h5>';
        html += '<div class="row">';
        html += '<div class="col-md-6">';
        html += '<div class="stats-card">';
        html += '<div class="stats-value">' + stats.meanDelta.toFixed(6) + '</div>';
        html += '<small>Mean Delta (s)</small>';
        html += '</div>';
        html += '<div class="stats-card mt-2">';
        html += '<div class="stats-value">' + stats.stdDelta.toFixed(6) + '</div>';
        html += '<small>Std Dev Delta (s)</small>';
        html += '</div>';
        html += '</div>';
        html += '<div class="col-md-6">';
        html += '<div class="stats-card">';
        html += '<div class="stats-value">' + stats.minDelta.toFixed(6) + '</div>';
        html += '<small>Min Delta (s)</small>';
        html += '</div>';
        html += '<div class="stats-card mt-2">';
        html += '<div class="stats-value">' + stats.maxDelta.toFixed(6) + '</div>';
        html += '<small>Max Delta (s)</small>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '<div class="gate-description mt-3">';
        html += '<p>Generated ' + clockSkewAnalyzer.timestamps.length + ' timestamp samples at ' + clockSkewAnalyzer.samplingRate + ' Hz sampling rate.</p>';
        html += '</div>';
        html += '</div>';
        
        resultsDiv.innerHTML = html;
    }
    
    function displayAnalysisResults(regression, pairwise) {
        const analysisDiv = document.getElementById('sequential2-analysis');
        const stepsContainer = document.getElementById('sequential2-steps-container');
        
        if (!analysisDiv || !stepsContainer) return;
        
        let html = '<div class="special-analysis-step active">';
        html += '<div class="calculation-title">Linear Regression Analysis</div>';
        html += '<div class="calculation-content">';
        html += 'Estimated skew: <span class="highlight-equation">' + regression.skew.toExponential(6) + ' s/s</span><br>';
        html += 'R-squared: <span class="highlight-equation">' + regression.rSquared.toFixed(4) + '</span><br>';
        html += 'Intercept: ' + regression.intercept.toFixed(6) + ' s';
        html += '</div>';
        html += '</div>';
        
        html += '<div class="special-analysis-step">';
        html += '<div class="calculation-title">Pairwise Difference Analysis</div>';
        html += '<div class="calculation-content">';
        html += 'Median skew: <span class="highlight-equation">' + pairwise.toExponential(6) + ' s/s</span><br>';
        html += 'Mean skew: ' + clockSkewAnalyzer.pairwiseStats.mean.toExponential(6) + ' s/s<br>';
        html += 'Standard deviation: ' + clockSkewAnalyzer.pairwiseStats.std.toExponential(6) + ' s/s<br>';
        html += 'Number of pairs analyzed: ' + clockSkewAnalyzer.pairwiseStats.nPairs;
        html += '</div>';
        html += '</div>';
        
        html += '<div class="special-analysis-step">';
        html += '<div class="calculation-title">Outlier Detection</div>';
        html += '<div class="calculation-content">';
        html += 'Method: ' + clockSkewAnalyzer.outliers.method + '<br>';
        html += 'Threshold: ' + clockSkewAnalyzer.outliers.threshold + '<br>';
        html += 'Outliers detected: <span class="special-highlight">' + clockSkewAnalyzer.outliers.indices.length + '</span><br>';
        const outlierPercentage = clockSkewAnalyzer.deltas.length > 0 ? 
            ((clockSkewAnalyzer.outliers.indices.length / clockSkewAnalyzer.deltas.length) * 100).toFixed(2) : '0.00';
        html += 'Outlier percentage: ' + outlierPercentage + '%';
        html += '</div>';
        html += '</div>';
        
        html += '<div class="special-analysis-step">';
        html += '<div class="calculation-title">True Parameters (Synthetic Data)</div>';
        html += '<div class="calculation-content">';
        html += 'True skew: ' + clockSkewAnalyzer.trueParams.skew.toExponential(6) + ' s/s<br>';
        html += 'Drift rate: ' + clockSkewAnalyzer.trueParams.drift.toExponential(6) + ' s/s<br>';
        html += 'Noise standard deviation: ' + clockSkewAnalyzer.trueParams.noiseStd.toExponential(6) + ' s';
        html += '</div>';
        html += '</div>';
        
        stepsContainer.innerHTML = html;
        analysisDiv.style.display = 'block';
        
        const analysisTitle = document.getElementById('sequential2-analysis-title');
        if (analysisTitle) {
            analysisTitle.textContent = 'Clock Skew Analysis Results';
        }
    }
    
    function displayReport(report) {
        const analysisDiv = document.getElementById('sequential2-analysis');
        const stepsContainer = document.getElementById('sequential2-steps-container');
        
        if (!analysisDiv || !stepsContainer) return;
        
        let html = '<div class="special-analysis-step active">';
        html += '<div class="calculation-title">Complete Analysis Report</div>';
        html += '<div class="calculation-content" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; max-height: 400px; overflow-y: auto;">';
        html += report;
        html += '</div>';
        html += '</div>';
        
        html += '<div class="special-analysis-step">';
        html += '<div class="calculation-title">Recommendations</div>';
        html += '<div class="calculation-content">';
        html += 'Based on the analysis:';
        html += getRecommendations();
        html += '</div>';
        html += '</div>';
        
        stepsContainer.innerHTML = html;
        analysisDiv.style.display = 'block';
        
        const analysisTitle = document.getElementById('sequential2-analysis-title');
        if (analysisTitle) {
            analysisTitle.textContent = 'Clock Skew Analysis Report';
        }
    }
    
    function getRecommendations() {
        if (!clockSkewAnalyzer) return '';
        
        let recommendations = '';
        
        if (clockSkewAnalyzer.statistics && clockSkewAnalyzer.statistics.stdDelta > 0.01) {
            recommendations += '<div class="gate-description mt-2">';
            recommendations += '<strong> High Jitter Detected:</strong><br>';
            recommendations += '- Improve clock source stability<br>';
            recommendations += '- Use hardware timestamping<br>';
            recommendations += '- Implement jitter buffers';
            recommendations += '</div>';
        }
        
        if (clockSkewAnalyzer.regressionResults) {
            const skewMagnitude = Math.abs(clockSkewAnalyzer.regressionResults.skew);
            
            if (skewMagnitude > 0.0001) {
                recommendations += '<div class="gate-description mt-2">';
                recommendations += '<strong> Significant Clock Skew (' + skewMagnitude.toExponential(2) + '):</strong><br>';
                recommendations += '- Implement clock synchronization (NTP/PTP)<br>';
                recommendations += '- Use hardware-assisted synchronization<br>';
                recommendations += '- Apply skew compensation algorithms';
                recommendations += '</div>';
            } else if (skewMagnitude < 0.000001) {
                recommendations += '<div class="gate-description mt-2">';
                recommendations += '<strong> Clock Skew Within Acceptable Limits</strong><br>';
                recommendations += 'No immediate action required';
                recommendations += '</div>';
            }
        }
        
        return recommendations || '<p>No specific recommendations based on current analysis.</p>';
    }
    
    function showMessage(type, text) {
        const resultsDiv = document.getElementById('sequential2-results');
        if (!resultsDiv) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'success' ? 'alert alert-success mt-3' : 'alert alert-danger mt-3';
        messageDiv.innerHTML = '<i class="fas ' + (type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle') + ' me-2"></i>' + text;
        
        resultsDiv.appendChild(messageDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(function() {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 5000);
    }
});
// Active-High vs Active-Low Decoders functionality
class ActiveHighLowDecoders {
    constructor() {
        this.decoderType = 'both';
        this.decoderSize = '3to8';
        this.inputBits = [0, 0, 0];
        this.enable = true;
        this.initializeEventListeners();
    }
    
    initializeEventListeners() {
        // Button click event
        document.getElementById('active-high-low-btn').addEventListener('click', () => {
            this.showDecoderInterface();
        });
        
        // Calculate button
        document.getElementById('calculate-active-high-low-btn').addEventListener('click', () => {
            this.performDecoderAnalysis();
        });
        
        // Show truth table button
        document.getElementById('show-truth-table-active-high-low-btn').addEventListener('click', () => {
            this.displayComprehensiveTruthTable();
        });
        
        // Reset button
        document.getElementById('reset-active-high-low-btn').addEventListener('click', () => {
            this.resetDecoderInterface();
        });
        
        // Close button
        document.getElementById('close-active-high-low-btn').addEventListener('click', () => {
            this.hideDecoderInterface();
        });
        
        // Decoder type change
        document.getElementById('decoder-type-select').addEventListener('change', (e) => {
            this.decoderType = e.target.value;
            this.updateInputConfiguration();
        });
        
        // Decoder size change
        document.getElementById('decoder-size-select').addEventListener('change', (e) => {
            this.decoderSize = e.target.value;
            this.updateInputConfiguration();
        });
        
        // Enable signal change
        document.getElementById('decoder-enable-input').addEventListener('change', (e) => {
            this.enable = e.target.checked;
        });
    }
    
    showDecoderInterface() {
        // Hide other MUX/Decoder sections
        this.hideAllMuxDecoderSections();
        
        // Show this section
        document.getElementById('active-high-low-inputs').style.display = 'block';
        
        // Update input configuration
        this.updateInputConfiguration();
        
        // Update right side display
        this.displayDecoderExplanation();
    }
    
    hideDecoderInterface() {
        document.getElementById('active-high-low-inputs').style.display = 'none';
        document.getElementById('mux-explanation').style.display = 'block';
        document.getElementById('mux-truth-table-container').style.display = 'none';
        document.getElementById('mux-calculation-steps').style.display = 'none';
    }
    
    hideAllMuxDecoderSections() {
        const sections = [
            'mux2-inputs', 'mux4-inputs', 'decoder-inputs',
            'demux-inputs', 'decoder3x8-inputs', 'priority-encoder-inputs',
            'decoder4x16-inputs', 'bcd-decoder-inputs'
        ];
        
        sections.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'none';
        });
    }
    
    updateInputConfiguration() {
        const container = document.getElementById('decoder-input-bits-container');
        container.innerHTML = '';
        
        let numBits;
        switch(this.decoderSize) {
            case '2to4': numBits = 2; break;
            case '3to8': numBits = 3; break;
            case '4to16': numBits = 4; break;
            default: numBits = 3;
        }
        
        this.inputBits = new Array(numBits).fill(0);
        
        for (let i = 0; i < numBits; i++) {
            const bitDiv = document.createElement('div');
            bitDiv.className = 'input-toggle mt-2';
            bitDiv.innerHTML = `
                <span class="input-label">Input ${String.fromCharCode(65 + i)} (${numBits - i - 1 === 0 ? 'LSB' : numBits - i - 1 === numBits - 1 ? 'MSB' : 'Bit ' + (numBits - i - 1)}):</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="decoder-bit-${i}" data-index="${i}">
                    <span class="toggle-slider"></span>
                </label>
                <span class="ms-2" id="decoder-bit-label-${i}">0 (OFF)</span>
            `;
            container.appendChild(bitDiv);
            
            // Add event listener for this bit
            const checkbox = document.getElementById(`decoder-bit-${i}`);
            checkbox.addEventListener('change', (e) => {
                this.inputBits[i] = e.target.checked ? 1 : 0;
                document.getElementById(`decoder-bit-label-${i}`).textContent = 
                    `${this.inputBits[i]} (${e.target.checked ? 'ON' : 'OFF'})`;
            });
        }
    }
    
    performDecoderAnalysis() {
        // Get current inputs
        for (let i = 0; i < this.inputBits.length; i++) {
            const checkbox = document.getElementById(`decoder-bit-${i}`);
            if (checkbox) {
                this.inputBits[i] = checkbox.checked ? 1 : 0;
            }
        }
        
        // Perform analysis
        const analysis = this.analyzeDecoders();
        
        // Display results
        this.displayStepByStepAnalysis(analysis);
    }
    
    analyzeDecoders() {
        const numInputs = this.inputBits.length;
        const numOutputs = Math.pow(2, numInputs);
        
        // Calculate decimal value of inputs
        let decimalValue = 0;
        for (let i = 0; i < numInputs; i++) {
            decimalValue += this.inputBits[i] * Math.pow(2, numInputs - i - 1);
        }
        
        // Generate outputs based on decoder type
        const results = {
            inputs: [...this.inputBits],
            decimal: decimalValue,
            enable: this.enable,
            numOutputs: numOutputs
        };
        
        if (this.decoderType === 'active-high' || this.decoderType === 'both') {
            results.activeHigh = this.generateActiveHighOutputs(numOutputs, decimalValue);
        }
        
        if (this.decoderType === 'active-low' || this.decoderType === 'both') {
            results.activeLow = this.generateActiveLowOutputs(numOutputs, decimalValue);
        }
        
        return results;
    }
    
    generateActiveHighOutputs(numOutputs, selectedIndex) {
        const outputs = new Array(numOutputs).fill(0);
        if (this.enable && selectedIndex < numOutputs) {
            outputs[selectedIndex] = 1;
        }
        return outputs;
    }
    
    generateActiveLowOutputs(numOutputs, selectedIndex) {
        const outputs = new Array(numOutputs).fill(1);
        if (this.enable && selectedIndex < numOutputs) {
            outputs[selectedIndex] = 0;
        }
        return outputs;
    }
    
    displayStepByStepAnalysis(analysis) {
        const stepsContainer = document.getElementById('mux-calculation-steps');
        const stepsContent = document.getElementById('mux-steps-container');
        
        stepsContainer.style.display = 'block';
        stepsContent.innerHTML = '';
        
        // Hide other displays
        document.getElementById('mux-truth-table-container').style.display = 'none';
        document.getElementById('mux-explanation').style.display = 'none';
        
        // Create steps
        const steps = this.createAnalysisSteps(analysis);
        
        steps.forEach((step, index) => {
            const stepDiv = document.createElement('div');
            stepDiv.className = `mux-step ${index === 0 ? 'active' : ''}`;
            stepDiv.innerHTML = step;
            stepsContent.appendChild(stepDiv);
        });
        
        // Animate steps
        this.animateAnalysisSteps();
    }
    
    createAnalysisSteps(analysis) {
        const steps = [];
        
        // Step 1: Input Analysis
        steps.push(`
            <div class="mux-operation-title">Step 1: Input Analysis</div>
            <div class="mt-2">
                <strong>Input Bits:</strong> ${analysis.inputs.join('')} 
                <span class="mux-bit mux-input">${analysis.inputs.map(bit => bit).join(' ')}</span>
            </div>
            <div class="mt-2">
                <strong>Decimal Equivalent:</strong> ${analysis.decimal}
                <span class="mux-formula">(Binary ${analysis.inputs.join('')} = Decimal ${analysis.decimal})</span>
            </div>
            <div class="mt-2">
                <strong>Enable Signal:</strong> ${analysis.enable ? 'HIGH (Active)' : 'LOW (Disabled)'}
            </div>
        `);
        
        // Step 2: Active-High Decoder Analysis
        if (analysis.activeHigh) {
            steps.push(`
                <div class="mux-operation-title">Step 2: Active-High Decoder Analysis</div>
                <div class="mt-2">
                    <strong>Principle:</strong> Selected output line = HIGH(1), All other outputs = LOW(0)
                </div>
                <div class="mt-2">
                    <strong>Output Pattern:</strong> 
                    <div class="decoder-outputs mt-2">
                        ${analysis.activeHigh.map((val, idx) => `
                            <div class="decoder-output ${val === 1 ? 'active' : 'inactive'}">
                                Y${idx} = ${val}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="mt-2">
                    <strong>Selected Output:</strong> Y${analysis.decimal} = ${analysis.activeHigh[analysis.decimal]}
                    <span class="mux-bit mux-output">Output Y${analysis.decimal} is ACTIVE HIGH</span>
                </div>
            `);
        }
        
        // Step 3: Active-Low Decoder Analysis
        if (analysis.activeLow) {
            steps.push(`
                <div class="mux-operation-title">Step 3: Active-Low Decoder Analysis</div>
                <div class="mt-2">
                    <strong>Principle:</strong> Selected output line = LOW(0), All other outputs = HIGH(1)
                </div>
                <div class="mt-2">
                    <strong>Output Pattern:</strong> 
                    <div class="decoder-outputs mt-2">
                        ${analysis.activeLow.map((val, idx) => `
                            <div class="decoder-output ${val === 0 ? 'active' : 'inactive'}">
                                Y${idx} = ${val}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="mt-2">
                    <strong>Selected Output:</strong> Y${analysis.decimal} = ${analysis.activeLow[analysis.decimal]}
                    <span class="mux-bit mux-output">Output Y${analysis.decimal} is ACTIVE LOW</span>
                </div>
            `);
        }
        
        // Step 4: Comparison
        if (analysis.activeHigh && analysis.activeLow) {
            steps.push(`
                <div class="mux-operation-title">Step 4: Comparison Analysis</div>
                <div class="mt-2">
                    <strong>Key Differences:</strong>
                    <div class="mt-2">
                        1. <strong>Active Level:</strong> Active-High uses HIGH(1) for selection, Active-Low uses LOW(0)
                    </div>
                    <div class="mt-2">
                        2. <strong>Output States:</strong> 
                        <span class="mux-bit mux-input">Active-High: Y${analysis.decimal}=1, Others=0</span>
                        <span class="mux-bit mux-select">Active-Low: Y${analysis.decimal}=0, Others=1</span>
                    </div>
                    <div class="mt-2">
                        3. <strong>Applications:</strong> Active-High for direct activation, Active-Low for chip select signals
                    </div>
                </div>
            `);
        }
        
        // Step 5: Enable Signal Impact
        steps.push(`
            <div class="mux-operation-title">Step 5: Enable Signal Impact Analysis</div>
            <div class="mt-2">
                <strong>Current Enable State:</strong> ${analysis.enable ? 'ENABLED' : 'DISABLED'}
            </div>
            <div class="mt-2">
                <strong>When Enabled:</strong> 
                ${analysis.enable ? 
                    'Decoder functions normally according to its type' : 
                    'All outputs are inactive (Active-High: all 0, Active-Low: all 1)'
                }
            </div>
        `);
        
        return steps;
    }
    
    animateAnalysisSteps() {
        const steps = document.querySelectorAll('#mux-steps-container .mux-step');
        steps.forEach((step, index) => {
            setTimeout(() => {
                // Remove active class from all steps
                steps.forEach(s => s.classList.remove('active'));
                // Add active class to current step
                step.classList.add('active');
                // Scroll to step
                step.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, index * 1500);
        });
    }
    
    displayComprehensiveTruthTable() {
        const tableContainer = document.getElementById('mux-truth-table-container');
        const table = document.getElementById('mux-truth-table');
        const title = document.getElementById('mux-truth-table-title');
        
        title.textContent = 'Active-High vs Active-Low Decoders Truth Table';
        tableContainer.style.display = 'block';
        
        // Hide other displays
        document.getElementById('mux-calculation-steps').style.display = 'none';
        document.getElementById('mux-explanation').style.display = 'none';
        
        // Generate truth table based on decoder size
        const numInputs = this.getNumInputsFromSize();
        const truthTable = this.generateTruthTable(numInputs);
        
        // Create table headers
        let headerHTML = '<tr>';
        
        // Input headers
        for (let i = 0; i < numInputs; i++) {
            headerHTML += `<th>${String.fromCharCode(65 + i)}</th>`;
        }
        
        headerHTML += '<th>Enable</th><th>Decimal</th>';
        
        // Output headers
        if (this.decoderType === 'active-high' || this.decoderType === 'both') {
            headerHTML += '<th>Active-High Outputs</th>';
        }
        if (this.decoderType === 'active-low' || this.decoderType === 'both') {
            headerHTML += '<th>Active-Low Outputs</th>';
        }
        
        headerHTML += '</tr>';
        
        // Create table rows
        let rowsHTML = '';
        truthTable.forEach(row => {
            rowsHTML += '<tr>';
            
            // Input bits
            row.inputs.forEach(bit => {
                rowsHTML += `<td class="${bit === 1 ? 'active' : 'inactive'}">${bit}</td>`;
            });
            
            // Enable
            rowsHTML += `<td class="${row.enable ? 'active' : 'inactive'}">${row.enable ? 1 : 0}</td>`;
            
            // Decimal value
            rowsHTML += `<td>${row.decimal}</td>`;
            
            // Active-High outputs
            if (this.decoderType === 'active-high' || this.decoderType === 'both') {
                const outputStr = row.activeHigh.join('');
                const activeIndex = row.enable ? row.decimal : -1;
                rowsHTML += `<td>`;
                for (let i = 0; i < row.activeHigh.length; i++) {
                    const isActive = i === activeIndex;
                    rowsHTML += `<span class="mux-bit ${isActive ? 'mux-output' : 'mux-input'}">${row.activeHigh[i]}</span>`;
                }
                rowsHTML += `</td>`;
            }
            
            // Active-Low outputs
            if (this.decoderType === 'active-low' || this.decoderType === 'both') {
                const outputStr = row.activeLow.join('');
                const activeIndex = row.enable ? row.decimal : -1;
                rowsHTML += `<td>`;
                for (let i = 0; i < row.activeLow.length; i++) {
                    const isActive = i === activeIndex;
                    rowsHTML += `<span class="mux-bit ${isActive ? 'mux-output' : 'mux-input'}">${row.activeLow[i]}</span>`;
                }
                rowsHTML += `</td>`;
            }
            
            rowsHTML += '</tr>';
        });
        
        table.innerHTML = headerHTML + rowsHTML;
    }
    
    getNumInputsFromSize() {
        switch(this.decoderSize) {
            case '2to4': return 2;
            case '3to8': return 3;
            case '4to16': return 4;
            default: return 3;
        }
    }
    
    generateTruthTable(numInputs) {
        const numOutputs = Math.pow(2, numInputs);
        const truthTable = [];
        
        // Generate all input combinations
        for (let i = 0; i < Math.pow(2, numInputs); i++) {
            // Convert i to binary array
            const binaryStr = i.toString(2).padStart(numInputs, '0');
            const inputs = binaryStr.split('').map(bit => parseInt(bit));
            
            // Calculate decimal value
            let decimalValue = 0;
            for (let j = 0; j < numInputs; j++) {
                decimalValue += inputs[j] * Math.pow(2, numInputs - j - 1);
            }
            
            // Test both enable states
            for (const enable of [true, false]) {
                const row = {
                    inputs: inputs,
                    enable: enable,
                    decimal: decimalValue,
                    activeHigh: this.generateActiveHighOutputs(numOutputs, decimalValue, enable),
                    activeLow: this.generateActiveLowOutputs(numOutputs, decimalValue, enable)
                };
                truthTable.push(row);
            }
        }
        
        return truthTable;
    }
    
    resetDecoderInterface() {
        // Reset inputs to all zeros
        this.inputBits.fill(0);
        
        // Update checkboxes
        for (let i = 0; i < this.inputBits.length; i++) {
            const checkbox = document.getElementById(`decoder-bit-${i}`);
            if (checkbox) {
                checkbox.checked = false;
                document.getElementById(`decoder-bit-label-${i}`).textContent = '0 (OFF)';
            }
        }
        
        // Reset enable
        document.getElementById('decoder-enable-input').checked = true;
        this.enable = true;
        
        // Reset type and size to default
        document.getElementById('decoder-type-select').value = 'both';
        document.getElementById('decoder-size-select').value = '3to8';
        this.decoderType = 'both';
        this.decoderSize = '3to8';
        
        // Update input configuration
        this.updateInputConfiguration();
        
        // Clear results
        document.getElementById('mux-truth-table-container').style.display = 'none';
        document.getElementById('mux-calculation-steps').style.display = 'none';
        document.getElementById('mux-explanation').style.display = 'block';
        
        // Display fresh explanation
        this.displayDecoderExplanation();
    }
    
    displayDecoderExplanation() {
        const explanation = document.getElementById('mux-operation-explanation');
        
        let sizeInfo = '';
        switch(this.decoderSize) {
            case '2to4': sizeInfo = '2-to-4 Decoder'; break;
            case '3to8': sizeInfo = '3-to-8 Decoder'; break;
            case '4to16': sizeInfo = '4-to-16 Decoder'; break;
        }
        
        explanation.innerHTML = `
            <h5>Active-High vs Active-Low Decoders Analysis</h5>
            <div class="mt-3">
                <strong>Current Configuration:</strong>
                <div class="mt-2">
                     <strong>Decoder Type:</strong> ${this.decoderType === 'both' ? 'Comparing Both' : this.decoderType === 'active-high' ? 'Active-High Only' : 'Active-Low Only'}
                </div>
                <div class="mt-2">
                     <strong>Decoder Size:</strong> ${sizeInfo}
                </div>
                <div class="mt-2">
                     <strong>Input Bits:</strong> ${this.inputBits.join('')}
                </div>
                <div class="mt-2">
                     <strong>Enable Signal:</strong> ${this.enable ? 'ENABLED' : 'DISABLED'}
                </div>
            </div>
            
            <div class="mt-3">
                <strong>Key Concepts:</strong>
                <div class="mt-2">
                    1. <strong>Active-High Decoder:</strong> Selected output = HIGH(1), All other outputs = LOW(0)
                </div>
                <div class="mt-2">
                    2. <strong>Active-Low Decoder:</strong> Selected output = LOW(0), All other outputs = HIGH(1)
                </div>
                <div class="mt-2">
                    3. <strong>Enable Signal:</strong> When LOW, all outputs are inactive (AH: all 0, AL: all 1)
                </div>
            </div>
            
            <div class="mt-3">
                <strong>Click "Calculate" for step-by-step analysis</strong>
            </div>
        `;
    }
}

// Initialize the decoders functionality when the page loads
document.addEventListener('DOMContentLoaded', function() {
    window.activeHighLowDecoders = new ActiveHighLowDecoders();
});
// Finite State Machine Implementation
class FiniteStateMachine {
    constructor() {
        this.states = [];
        this.inputs = [];
        this.outputs = [];
        this.transitions = {};
        this.current_state = null;
        this.state_bits = 0;
        this.input_bits = 0;
        this.output_bits = 0;
        this.transitionTable = [];
    }
    
    configure(states, inputs, outputs, initial_state) {
        this.states = states;
        this.inputs = inputs;
        this.outputs = outputs;
        this.current_state = initial_state;
        
        // Calculate bits needed
        this.state_bits = Math.max(1, Math.ceil(Math.log2(states.length)));
        this.input_bits = Math.max(1, Math.ceil(Math.log2(inputs.length)));
        this.output_bits = Math.max(1, Math.ceil(Math.log2(outputs.length)));
        
        this.transitions = {};
        this.transitionTable = [];
        
        return {
            states: this.states,
            inputs: this.inputs,
            outputs: this.outputs,
            bits: {
                state: this.state_bits,
                input: this.input_bits,
                output: this.output_bits
            }
        };
    }
    
    setTransition(fromState, input, toState, output) {
        this.transitions[`${fromState},${input}`] = {
            nextState: toState,
            output: output
        };
        
        // Add to transition table
        this.transitionTable.push({
            fromState,
            input,
            toState,
            output
        });
    }
    
    generateTruthTable() {
        const headers = [];
        
        // Input bits
        for (let i = 0; i < this.input_bits; i++) {
            headers.push(`I${i}`);
        }
        
        // Current state bits
        for (let i = 0; i < this.state_bits; i++) {
            headers.push(`S${i}`);
        }
        
        // Next state bits
        for (let i = 0; i < this.state_bits; i++) {
            headers.push(`NS${i}`);
        }
        
        // Output bits
        for (let i = 0; i < this.output_bits; i++) {
            headers.push(`O${i}`);
        }
        
        // Create binary mappings
        const stateBin = {};
        this.states.forEach((state, i) => {
            const binary = i.toString(2).padStart(this.state_bits, '0');
            stateBin[state] = binary;
        });
        
        const inputBin = {};
        this.inputs.forEach((input, i) => {
            const binary = i.toString(2).padStart(this.input_bits, '0');
            inputBin[input] = binary;
        });
        
        const outputBin = {};
        this.outputs.forEach((output, i) => {
            const binary = i.toString(2).padStart(this.output_bits, '0');
            outputBin[output] = binary;
        });
        
        // Generate truth table
        const table = [];
        
        this.transitionTable.forEach(transition => {
            const row = [];
            
            // Input bits
            const inputBits = inputBin[transition.input] || '0'.repeat(this.input_bits);
            row.push(...inputBits.split(''));
            
            // Current state bits
            const stateBits = stateBin[transition.fromState] || '0'.repeat(this.state_bits);
            row.push(...stateBits.split(''));
            
            // Next state bits
            const nextStateBits = stateBin[transition.toState] || '0'.repeat(this.state_bits);
            row.push(...nextStateBits.split(''));
            
            // Output bits
            const outputBits = outputBin[transition.output] || '0'.repeat(this.output_bits);
            row.push(...outputBits.split(''));
            
            table.push({
                binary: row,
                symbolic: {
                    state: transition.fromState,
                    input: transition.input,
                    nextState: transition.toState,
                    output: transition.output
                }
            });
        });
        
        return {
            headers: [...headers, 'State', 'Input', 'Next State', 'Output'],
            table: table
        };
    }
    
    simulate(sequence) {
        const states = [this.current_state];
        const outputs = [];
        const log = [];
        
        sequence.forEach((input, i) => {
            const key = `${states[states.length - 1]},${input}`;
            
            if (this.transitions[key]) {
                const transition = this.transitions[key];
                log.push({
                    time: i,
                    currentState: states[states.length - 1],
                    input: input,
                    nextState: transition.nextState,
                    output: transition.output
                });
                
                states.push(transition.nextState);
                outputs.push(transition.output);
            } else {
                log.push({
                    time: i,
                    currentState: states[states.length - 1],
                    input: input,
                    nextState: 'UNDEFINED',
                    output: 'X'
                });
                
                outputs.push('X');
                states.push(states[states.length - 1]); // Stay in current state
            }
        });
        
        // Remove last state (it's the next state after last input)
        states.pop();
        
        return {
            sequence: sequence,
            states: states,
            outputs: outputs,
            log: log
        };
    }
    
    // Create example 101 sequence detector
    createExample101() {
        this.configure(['S0', 'S1', 'S2', 'S3'], ['0', '1'], ['0', '1'], 'S0');
        
        // Define transitions for 101 sequence detector
        this.setTransition('S0', '0', 'S0', '0');
        this.setTransition('S0', '1', 'S1', '0');
        this.setTransition('S1', '0', 'S2', '0');
        this.setTransition('S1', '1', 'S1', '0');
        this.setTransition('S2', '0', 'S0', '0');
        this.setTransition('S2', '1', 'S3', '1'); // Pattern detected!
        this.setTransition('S3', '0', 'S0', '0');
        this.setTransition('S3', '1', 'S1', '0');
        
        return "101 Sequence Detector FSM configured";
    }
}

// Initialize FSM
let fsm = new FiniteStateMachine();

// Event Listeners for FSM
document.getElementById('finite-state-machine-btn').addEventListener('click', function() {
    // Hide all other input sections
    document.querySelectorAll('#sequential-circuit2-section .gate-description > div[id$="-inputs"]').forEach(div => {
        div.style.display = 'none';
    });
    
    // Show FSM inputs
    document.getElementById('finite-state-machine-inputs').style.display = 'block';
    
    // Update button state
    document.querySelectorAll('#sequential-circuit2-section .gate-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    this.classList.add('active');
    
    // Reset results display
    resetFSMResults();
});

document.getElementById('configure-fsm-btn').addEventListener('click', function() {
    const fsmType = document.getElementById('fsm-type-select').value;
    
    if (fsmType === 'example') {
        const result = fsm.createExample101();
        showFSMStatus(result, 'success');
        generateTransitionTable();
    } else if (fsmType === 'custom') {
        configureCustomFSM();
    }
    
    // Show transition matrix
    document.getElementById('transition-matrix').style.display = 'block';
});

document.getElementById('show-fsm-truth-table-btn').addEventListener('click', function() {
    if (fsm.transitionTable.length === 0) {
        showFSMStatus("Please configure FSM first", 'error');
        return;
    }
    
    const truthTable = fsm.generateTruthTable();
    displayTruthTable(truthTable);
});

document.getElementById('show-timing-diagram-btn').addEventListener('click', function() {
    if (fsm.transitionTable.length === 0) {
        showFSMStatus("Please configure FSM first", 'error');
        return;
    }
    
    const sequenceInput = document.getElementById('fsm-input-sequence').value;
    const sequence = sequenceInput.split(',').map(s => s.trim()).filter(s => s !== '');
    
    if (sequence.length === 0) {
        showFSMStatus("Please enter an input sequence", 'error');
        return;
    }
    
    const simulation = fsm.simulate(sequence);
    displayTimingDiagram(simulation);
});

document.getElementById('show-state-diagram-btn').addEventListener('click', function() {
    if (fsm.transitionTable.length === 0) {
        showFSMStatus("Please configure FSM first", 'error');
        return;
    }
    
    displayStateDiagram();
});

document.getElementById('simulate-fsm-btn').addEventListener('click', function() {
    if (fsm.transitionTable.length === 0) {
        showFSMStatus("Please configure FSM first", 'error');
        return;
    }
    
    const sequenceInput = document.getElementById('fsm-input-sequence').value;
    const sequence = sequenceInput.split(',').map(s => s.trim()).filter(s => s !== '');
    
    if (sequence.length === 0) {
        showFSMStatus("Please enter an input sequence", 'error');
        return;
    }
    
    const simulation = fsm.simulate(sequence);
    displaySimulationResults(simulation);
});

document.getElementById('reset-fsm-btn').addEventListener('click', function() {
    fsm = new FiniteStateMachine();
    document.getElementById('transition-table-container').innerHTML = '';
    document.getElementById('fsm-input-sequence').value = '1,0,1,0,1';
    document.getElementById('fsm-type-select').value = 'custom';
    showFSMStatus("FSM Reset to Initial Values", 'info');
    resetFSMResults();
});

document.getElementById('close-fsm-btn').addEventListener('click', function() {
    document.getElementById('finite-state-machine-inputs').style.display = 'none';
    document.getElementById('finite-state-machine-btn').classList.remove('active');
    resetFSMResults();
});

document.getElementById('save-fsm-config-btn').addEventListener('click', function() {
    if (fsm.transitionTable.length === 0) {
        showFSMStatus("No FSM configuration to save", 'error');
        return;
    }
    
    const config = {
        states: fsm.states,
        inputs: fsm.inputs,
        outputs: fsm.outputs,
        transitions: fsm.transitions,
        current_state: fsm.current_state,
        transitionTable: fsm.transitionTable
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'fsm_config.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showFSMStatus("FSM Configuration Saved as fsm_config.json", 'success');
});

// Helper Functions
function configureCustomFSM() {
    const numStates = parseInt(document.getElementById('num-states').value);
    const stateNamesInput = document.getElementById('state-names').value;
    const inputSymbolsInput = document.getElementById('input-symbols').value;
    const outputSymbolsInput = document.getElementById('output-symbols').value;
    const initialState = document.getElementById('initial-state').value;
    
    const stateNames = stateNamesInput.split(',').map(s => s.trim()).filter(s => s !== '');
    const inputSymbols = inputSymbolsInput.split(',').map(s => s.trim()).filter(s => s !== '');
    const outputSymbols = outputSymbolsInput.split(',').map(s => s.trim()).filter(s => s !== '');
    
    if (stateNames.length < numStates) {
        showFSMStatus(`Need ${numStates} state names, but got ${stateNames.length}`, 'error');
        return;
    }
    
    if (inputSymbols.length === 0) {
        showFSMStatus("Please provide at least one input symbol", 'error');
        return;
    }
    
    if (outputSymbols.length === 0) {
        showFSMStatus("Please provide at least one output symbol", 'error');
        return;
    }
    
    if (!stateNames.includes(initialState)) {
        showFSMStatus(`Initial state "${initialState}" not found in state names`, 'error');
        return;
    }
    
    fsm.configure(stateNames, inputSymbols, outputSymbols, initialState);
    generateTransitionTable();
    showFSMStatus("Custom FSM Configured Successfully", 'success');
}

function generateTransitionTable() {
    const container = document.getElementById('transition-table-container');
    container.innerHTML = '';
    
    if (fsm.states.length === 0 || fsm.inputs.length === 0) return;
    
    let html = '<table class="table table-bordered table-sm">';
    html += '<thead><tr><th>Current State</th>';
    
    fsm.inputs.forEach(input => {
        html += `<th>Input=${input}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    fsm.states.forEach(state => {
        html += `<tr><td><strong>${state}</strong></td>`;
        
        fsm.inputs.forEach(input => {
            const key = `${state},${input}`;
            html += '<td>';
            
            if (fsm.transitions[key]) {
                const trans = fsm.transitions[key];
                html += `<div class="small"> ${trans.nextState}</div>`;
                html += `<div class="small">/ ${trans.output}</div>`;
                
                // Add edit button
                html += `<button class="btn btn-sm btn-outline-primary mt-1" onclick="editTransition('${state}', '${input}')">Edit</button>`;
            } else {
                html += `<button class="btn btn-sm btn-outline-secondary" onclick="addTransition('${state}', '${input}')">Add</button>`;
            }
            
            html += '</td>';
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function addTransition(state, input) {
    const nextState = prompt(`Enter next state for ${state} with input ${input}:`, fsm.states[0]);
    const output = prompt(`Enter output for ${state} with input ${input}:`, fsm.outputs[0]);
    
    if (nextState && output && fsm.states.includes(nextState) && fsm.outputs.includes(output)) {
        fsm.setTransition(state, input, nextState, output);
        generateTransitionTable();
        showFSMStatus(`Transition added: ${state},${input}  ${nextState}/${output}`, 'success');
    }
}

function editTransition(state, input) {
    const key = `${state},${input}`;
    if (fsm.transitions[key]) {
        const current = fsm.transitions[key];
        const nextState = prompt(`Edit next state for ${state} with input ${input}:`, current.nextState);
        const output = prompt(`Edit output for ${state} with input ${input}:`, current.output);
        
        if (nextState && output && fsm.states.includes(nextState) && fsm.outputs.includes(output)) {
            fsm.setTransition(state, input, nextState, output);
            generateTransitionTable();
            showFSMStatus(`Transition updated: ${state},${input}  ${nextState}/${output}`, 'success');
        }
    }
}

function displayTruthTable(truthTable) {
    const resultsContainer = document.getElementById('sequential-circuit2-section').querySelector('.col-md-8');
    
    let html = `
        <div class="glass-card mt-3">
            <h4 class="text-center mb-4"><i class="fas fa-table me-2"></i>FSM Truth Table</h4>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
    `;
    
    truthTable.headers.forEach(header => {
        html += `<th>${header}</th>`;
    });
    
    html += `</tr></thead><tbody>`;
    
    truthTable.table.forEach(row => {
        html += '<tr>';
        
        // Binary values
        row.binary.forEach(bit => {
            html += `<td class="text-center ${bit === '1' ? 'table-success' : 'table-light'}">${bit}</td>`;
        });
        
        // Symbolic values
        html += `<td class="text-center"><strong>${row.symbolic.state}</strong></td>`;
        html += `<td class="text-center">${row.symbolic.input}</td>`;
        html += `<td class="text-center"><strong>${row.symbolic.nextState}</strong></td>`;
        html += `<td class="text-center">${row.symbolic.output}</td>`;
        
        html += '</tr>';
    });
    
    html += `</tbody></table></div>`;
    
    // Add FSM info
    html += `
        <div class="row mt-3">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-value">${fsm.states.length}</div>
                    <small>States</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-value">${fsm.state_bits}</div>
                    <small>State Bits</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-value">${fsm.transitionTable.length}</div>
                    <small>Transitions</small>
                </div>
            </div>
        </div>
    `;
    
    html += `</div>`;
    
    resultsContainer.innerHTML = html;
}

function displayTimingDiagram(simulation) {
    const resultsContainer = document.getElementById('sequential-circuit2-section').querySelector('.col-md-8');
    
    let html = `
        <div class="glass-card mt-3">
            <h4 class="text-center mb-4"><i class="fas fa-wave-square me-2"></i>FSM Timing Diagram</h4>
            
            <div class="mb-4">
                <h5>Input Sequence: ${simulation.sequence.join(', ')}</h5>
                <h5>Initial State: ${fsm.current_state}</h5>
            </div>
            
            <div class="table-responsive mb-4">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Time</th>
                            <th>Current State</th>
                            <th>Input</th>
                            <th>Next State</th>
                            <th>Output</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    simulation.log.forEach(log => {
        html += `
            <tr>
                <td class="text-center">${log.time}</td>
                <td class="text-center ${log.currentState === log.nextState ? 'table-warning' : ''}">
                    <strong>${log.currentState}</strong>
                </td>
                <td class="text-center">${log.input}</td>
                <td class="text-center ${log.nextState === 'UNDEFINED' ? 'table-danger' : 'table-success'}">
                    <strong>${log.nextState}</strong>
                </td>
                <td class="text-center ${log.output === 'X' ? 'table-danger' : 'table-info'}">
                    <strong>${log.output}</strong>
                </td>
            </tr>
        `;
    });
    
    html += `</tbody></table></div>`;
    
    // Visual timing representation
    html += `
        <div class="mb-4">
            <h5>Visual Timing Representation:</h5>
            <div class="timing-diagram-visual p-3 border rounded">
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-2"><strong>Input:</strong></div>
                        ${simulation.sequence.map((input, i) => 
                            `<span class="badge bg-secondary me-1">t${i}=${input}</span>`
                        ).join('')}
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-2"><strong>State:</strong></div>
                        ${simulation.states.map((state, i) => 
                            `<span class="badge bg-success me-1">t${i}=${state}</span>`
                        ).join('')}
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-2"><strong>Output:</strong></div>
                        ${simulation.outputs.map((output, i) => 
                            `<span class="badge ${output === '1' ? 'bg-danger' : 'bg-info'} me-1">t${i}=${output}</span>`
                        ).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Summary
    html += `
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>Simulation Summary:</h6>
            <ul class="mb-0">
                <li>Total Time Steps: ${simulation.sequence.length}</li>
                <li>Final State: ${simulation.states[simulation.states.length - 1]}</li>
                <li>Output Sequence: ${simulation.outputs.join(', ')}</li>
                ${simulation.outputs.includes('X') ? 
                    '<li class="text-danger"> Some transitions were undefined (marked as X)</li>' : ''}
            </ul>
        </div>
    `;
    
    html += `</div>`;
    
    resultsContainer.innerHTML = html;
}
function displayStateDiagram() {
    const resultsContainer = document.getElementById('sequential-circuit2-section').querySelector('.col-md-8');
    
    let html = `
        <div class="glass-card mt-3">
            <h4 class="text-center mb-4"><i class="fas fa-project-diagram me-2"></i>FSM State Transition Diagram</h4>
            
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle me-2"></i>
                This diagram shows all state transitions. Each arrow is labeled with input/output.
            </div>
            
            <!-- State Diagram with SVG for lines -->
            <div class="position-relative mb-4" style="min-height: 400px;">
                <svg class="position-absolute w-100 h-100" style="top: 0; left: 0; z-index: 0;" id="fsm-svg-lines"></svg>
                
                <!-- State Nodes -->
                <div class="position-relative" style="z-index: 1;">
    `;
    
    // Calculate positions for state nodes in a circle
    const radius = 150;
    const centerX = 300;
    const centerY = 200;
    
    // Create state nodes
    fsm.states.forEach((state, index) => {
        const angle = (2 * Math.PI * index) / fsm.states.length;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        
        const isCurrent = state === fsm.current_state;
        html += `
            <div class="state-circle position-absolute" 
                 style="
                    background: ${isCurrent ? 'linear-gradient(135deg, #28a745, #20c997)' : '#f8f9fa'};
                    color: ${isCurrent ? 'white' : 'var(--primary-color)'};
                    border-color: ${isCurrent ? '#28a745' : 'var(--primary-color)'};
                    left: ${x}px;
                    top: ${y}px;
                    transform: translate(-50%, -50%);
                    z-index: 2;
                 "
                 data-state="${state}">
                <div><strong>${state}</strong></div>
                ${isCurrent ? '<div class="small">Current</div>' : ''}
            </div>
        `;
    });
    
    html += `</div></div>`;
    
    // Transition Table
    html += `
        <div class="mb-4">
            <h5>Transition Table:</h5>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>From State</th>
                            <th>Input</th>
                            <th>To State</th>
                            <th>Output</th>
                            <th>Transition</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    fsm.transitionTable.forEach(trans => {
        const isSelfLoop = trans.fromState === trans.toState;
        html += `
            <tr>
                <td class="text-center"><strong>${trans.fromState}</strong></td>
                <td class="text-center">${trans.input}</td>
                <td class="text-center"><strong>${trans.toState}</strong></td>
                <td class="text-center">${trans.output}</td>
                <td class="text-center">
                    <span class="badge ${isSelfLoop ? 'bg-warning' : 'bg-primary'}">
                        ${trans.fromState} ${isSelfLoop ? '' : ''} ${trans.toState}
                    </span>
                    <div class="small">${trans.input}/${trans.output}</div>
                </td>
            </tr>
        `;
    });
    
    html += `</tbody></table></div></div>`;
    
    // FSM Properties
    html += `
        <div class="row">
            <div class="col-md-6">
                <div class="gate-description">
                    <h6>FSM Properties:</h6>
                    <ul>
                        <li>Type: ${fsm.states.length <= Math.pow(2, fsm.state_bits) ? 'Complete' : 'Incomplete'}</li>
                        <li>States: ${fsm.states.length} (${fsm.state_bits} bits)</li>
                        <li>Inputs: ${fsm.inputs.length} (${fsm.input_bits} bits)</li>
                        <li>Outputs: ${fsm.outputs.length} (${fsm.output_bits} bits)</li>
                        <li>Transitions: ${fsm.transitionTable.length}</li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="gate-description">
                    <h6>Binary Encoding:</h6>
                    <div class="small">
                        <strong>States:</strong><br>
                        ${fsm.states.map((state, i) => 
                            `${state}: ${i.toString(2).padStart(fsm.state_bits, '0')}`
                        ).join('<br>')}
                        <br><br>
                        <strong>Inputs:</strong><br>
                        ${fsm.inputs.map((input, i) => 
                            `${input}: ${i.toString(2).padStart(fsm.input_bits, '0')}`
                        ).join('<br>')}
                        <br><br>
                        <strong>Outputs:</strong><br>
                        ${fsm.outputs.map((output, i) => 
                            `${output}: ${i.toString(2).padStart(fsm.output_bits, '0')}`
                        ).join('<br>')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    html += `</div>`;
    
    resultsContainer.innerHTML = html;
    
    // Add separate script to draw SVG lines after the DOM is updated
    setTimeout(() => {
        drawStateDiagram();
    }, 10);
}

// Separate function to draw SVG lines
function drawStateDiagram() {
    const svg = document.getElementById('fsm-svg-lines');
    if (!svg) return;
    
    // Clear previous SVG content
    svg.innerHTML = '';
    
    const states = fsm.states;
    const transitions = fsm.transitionTable;
    const centerX = 300;
    const centerY = 200;
    const radius = 150;
    
    // Calculate state positions
    const statePositions = {};
    states.forEach((state, index) => {
        const angle = (2 * Math.PI * index) / states.length;
        statePositions[state] = {
            x: centerX + radius * Math.cos(angle),
            y: centerY + radius * Math.sin(angle)
        };
    });
    
    // Draw self-loop transitions first (so they appear behind regular transitions)
    transitions.forEach(trans => {
        if (trans.fromState === trans.toState) {
            drawSelfLoop(statePositions[trans.fromState], trans, svg);
        }
    });
    
    // Draw regular transitions
    transitions.forEach(trans => {
        if (trans.fromState !== trans.toState) {
            drawTransition(statePositions[trans.fromState], statePositions[trans.toState], trans, svg);
        }
    });
    
    function drawSelfLoop(position, trans, svg) {
        const loopRadius = 30;
        const startAngle = Math.PI / 4;
        const endAngle = 7 * Math.PI / 4;
        
        // Calculate control points for a nice loop
        const cp1x = position.x + loopRadius * Math.cos(startAngle + Math.PI/2);
        const cp1y = position.y + loopRadius * Math.sin(startAngle + Math.PI/2);
        const cp2x = position.x + loopRadius * Math.cos(endAngle - Math.PI/2);
        const cp2y = position.y + loopRadius * Math.sin(endAngle - Math.PI/2);
        
        // Draw curve
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 
            `M ${position.x + loopRadius * Math.cos(startAngle)} ${position.y + loopRadius * Math.sin(startAngle)}
             C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${position.x + loopRadius * Math.cos(endAngle)} ${position.y + loopRadius * Math.sin(endAngle)}`
        );
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', '#007bff');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('stroke-dasharray', '5,5');
        svg.appendChild(path);
        
        // Add arrowhead
        const arrowX = position.x + loopRadius * Math.cos(endAngle - 0.1);
        const arrowY = position.y + loopRadius * Math.sin(endAngle - 0.1);
        drawArrowhead(arrowX, arrowY, endAngle + Math.PI/2, svg);
        
        // Add label
        const labelX = position.x + (loopRadius + 10) * Math.cos((startAngle + endAngle) / 2);
        const labelY = position.y + (loopRadius + 10) * Math.sin((startAngle + endAngle) / 2);
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', labelX);
        text.setAttribute('y', labelY);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', '#333');
        text.setAttribute('font-size', '10px');
        text.setAttribute('font-weight', 'bold');
        text.textContent = `${trans.input}/${trans.output}`;
        
        // Add background rectangle for readability
        const textNode = text.cloneNode(true);
        const bbox = {x: labelX - 15, y: labelY - 8, width: 30, height: 16};
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', bbox.x - 2);
        rect.setAttribute('y', bbox.y - 2);
        rect.setAttribute('width', bbox.width + 4);
        rect.setAttribute('height', bbox.height + 4);
        rect.setAttribute('fill', 'white');
        rect.setAttribute('stroke', 'none');
        rect.setAttribute('rx', '3');
        svg.appendChild(rect);
        
        svg.appendChild(text);
    }
    
    function drawTransition(fromPos, toPos, trans, svg) {
        // Calculate direction
        const dx = toPos.x - fromPos.x;
        const dy = toPos.y - fromPos.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const unitDx = dx / distance;
        const unitDy = dy / distance;
        
        // Adjust start and end points to be on circle edges
        const startX = fromPos.x + 40 * unitDx;
        const startY = fromPos.y + 40 * unitDy;
        const endX = toPos.x - 40 * unitDx;
        const endY = toPos.y - 40 * unitDy;
        
        // Draw line
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', startX);
        line.setAttribute('y1', startY);
        line.setAttribute('x2', endX);
        line.setAttribute('y2', endY);
        line.setAttribute('stroke', '#007bff');
        line.setAttribute('stroke-width', '2');
        svg.appendChild(line);
        
        // Add arrowhead
        drawArrowhead(endX, endY, Math.atan2(unitDy, unitDx), svg);
        
        // Add label at midpoint
        const midX = (startX + endX) / 2;
        const midY = (startY + endY) / 2;
        
        // Offset perpendicular to line
        const offset = 15;
        const perpX = -unitDy * offset;
        const perpY = unitDx * offset;
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', midX + perpX);
        text.setAttribute('y', midY + perpY);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', '#333');
        text.setAttribute('font-size', '10px');
        text.setAttribute('font-weight', 'bold');
        text.textContent = `${trans.input}/${trans.output}`;
        
        // Add background rectangle for readability
        const bbox = {x: midX + perpX - 15, y: midY + perpY - 8, width: 30, height: 16};
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', bbox.x - 2);
        rect.setAttribute('y', bbox.y - 2);
        rect.setAttribute('width', bbox.width + 4);
        rect.setAttribute('height', bbox.height + 4);
        rect.setAttribute('fill', 'white');
        rect.setAttribute('stroke', 'none');
        rect.setAttribute('rx', '3');
        svg.appendChild(rect);
        
        svg.appendChild(text);
    }
    
    function drawArrowhead(x, y, angle, svg) {
        const arrowLength = 10;
        const arrowAngle = Math.PI / 6;
        
        const arrow1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        arrow1.setAttribute('x1', x);
        arrow1.setAttribute('y1', y);
        arrow1.setAttribute('x2', x - arrowLength * Math.cos(angle - arrowAngle));
        arrow1.setAttribute('y2', y - arrowLength * Math.sin(angle - arrowAngle));
        arrow1.setAttribute('stroke', '#007bff');
        arrow1.setAttribute('stroke-width', '2');
        svg.appendChild(arrow1);
        
        const arrow2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        arrow2.setAttribute('x1', x);
        arrow2.setAttribute('y1', y);
        arrow2.setAttribute('x2', x - arrowLength * Math.cos(angle + arrowAngle));
        arrow2.setAttribute('y2', y - arrowLength * Math.sin(angle + arrowAngle));
        arrow2.setAttribute('stroke', '#007bff');
        arrow2.setAttribute('stroke-width', '2');
        svg.appendChild(arrow2);
    }
}


function displaySimulationResults(simulation) {
    const resultsContainer = document.getElementById('sequential-circuit2-section').querySelector('.col-md-8');
    
    let html = `
        <div class="glass-card mt-3">
            <h4 class="text-center mb-4"><i class="fas fa-play-circle me-2"></i>FSM Simulation Results</h4>
            
            <div class="alert alert-success mb-4">
                <i class="fas fa-check-circle me-2"></i>
                Simulation completed for ${simulation.sequence.length} time steps.
            </div>
            
            <!-- Step-by-step simulation -->
            <div class="mb-4">
                <h5>Step-by-Step Execution:</h5>
                <div class="simulation-steps">
    `;
    
    simulation.log.forEach((log, index) => {
        const stepClass = log.nextState === 'UNDEFINED' ? 'border-danger' : 'border-success';
        const icon = log.nextState === 'UNDEFINED' ? 'fa-exclamation-triangle' : 'fa-arrow-right';
        const iconColor = log.nextState === 'UNDEFINED' ? 'text-danger' : 'text-success';
        
        html += `
            <div class="card mb-2 ${stepClass}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Step ${log.time}</h6>
                            <div class="d-flex align-items-center">
                                <div class="state-badge bg-primary text-white px-2 py-1 rounded me-2">
                                    ${log.currentState}
                                </div>
                                <i class="fas fa-long-arrow-alt-right me-2"></i>
                                <div class="input-badge bg-secondary text-white px-2 py-1 rounded me-2">
                                    Input: ${log.input}
                                </div>
                                <i class="fas fa-long-arrow-alt-right me-2"></i>
                                <div class="state-badge ${log.nextState === 'UNDEFINED' ? 'bg-danger' : 'bg-success'} text-white px-2 py-1 rounded me-2">
                                    ${log.nextState}
                                </div>
                                <i class="fas fa-equals me-2"></i>
                                <div class="output-badge bg-info text-white px-2 py-1 rounded">
                                    Output: ${log.output}
                                </div>
                            </div>
                        </div>
                        <div class="${iconColor}">
                            <i class="fas ${icon} fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `</div></div>`;
    
    // Summary Statistics
    const validTransitions = simulation.log.filter(log => log.nextState !== 'UNDEFINED').length;
    const invalidTransitions = simulation.log.filter(log => log.nextState === 'UNDEFINED').length;
    
    html += `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <div class="stats-value ${validTransitions === simulation.log.length ? 'text-success' : 'text-warning'}">
                        ${validTransitions}/${simulation.log.length}
                    </div>
                    <small>Valid Transitions</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <div class="stats-value ${invalidTransitions === 0 ? 'text-success' : 'text-danger'}">
                        ${invalidTransitions}
                    </div>
                    <small>Undefined Transitions</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <div class="stats-value">${simulation.outputs.filter(o => o === '1').length}</div>
                    <small>Output = 1 Count</small>
                </div>
            </div>
        </div>
    `;
    
    // Final state and sequence
    html += `
        <div class="alert alert-dark">
            <h6><i class="fas fa-flag-checkered me-2"></i>Final Results:</h6>
            <div class="row">
                <div class="col-md-6">
                    <strong>Final State:</strong> ${simulation.states[simulation.states.length - 1]}
                </div>
                <div class="col-md-6">
                    <strong>Output Sequence:</strong> ${simulation.outputs.join(', ')}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <strong>State Sequence:</strong> ${simulation.states.join('  ')}
                </div>
            </div>
        </div>
    `;
    
    // Action buttons for this simulation
    html += `
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-outline-primary me-2" onclick="displayTruthTable(fsm.generateTruthTable())">
                <i class="fas fa-table me-1"></i>View Truth Table
            </button>
            <button class="btn btn-outline-success me-2" onclick="displayTimingDiagram(${JSON.stringify(simulation)})">
                <i class="fas fa-wave-square me-1"></i>View Timing Diagram
            </button>
            <button class="btn btn-outline-info" onclick="displayStateDiagram()">
                <i class="fas fa-project-diagram me-1"></i>View State Diagram
            </button>
        </div>
    `;
    
    html += `</div>`;
    
    resultsContainer.innerHTML = html;
}

function showFSMStatus(message, type = 'info') {
    const statusElement = document.getElementById('fsm-status');
    let badgeClass = 'bg-secondary';
    
    switch(type) {
        case 'success':
            badgeClass = 'bg-success';
            break;
        case 'error':
            badgeClass = 'bg-danger';
            break;
        case 'warning':
            badgeClass = 'bg-warning';
            break;
        case 'info':
            badgeClass = 'bg-info';
            break;
    }
    
    statusElement.innerHTML = `<span class="badge ${badgeClass}">${message}</span>`;
    
    // Clear status after 3 seconds
    setTimeout(() => {
        if (statusElement.innerHTML.includes(message)) {
            statusElement.innerHTML = '<span class="badge bg-secondary">Ready</span>';
        }
    }, 3000);
}

function resetFSMResults() {
    const resultsContainer = document.getElementById('sequential-circuit2-section').querySelector('.col-md-8');
    resultsContainer.innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-robot fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <h4 class="mt-3">Finite State Machine Operations</h4>
            <p>Configure and simulate FSM operations</p>
            <p class="small text-muted">Supports truth table, timing diagram, state diagram generation and simulation</p>
        </div>
    `;
}

// Make functions available globally
window.addTransition = addTransition;
window.editTransition = editTransition;
window.displayTruthTable = displayTruthTable;
window.displayTimingDiagram = displayTimingDiagram;
window.displayStateDiagram = displayStateDiagram;

// ASCII Decoder Class
class ASCIIDecoder {
    constructor() {
        // Standard ASCII table (0-127)
        this.asciiTable = this.generateASCIITable();
    }
    
    generateASCIITable() {
        const table = [];
        for (let i = 0; i < 128; i++) {
            table.push({
                decimal: i,
                hex: i.toString(16).toUpperCase().padStart(2, '0'),
                octal: i.toString(8).padStart(3, '0'),
                binary: i.toString(2).padStart(7, '0'),
                character: i >= 32 && i <= 126 ? String.fromCharCode(i) : 
                          i === 10 ? 'LF' : 
                          i === 13 ? 'CR' : 
                          i === 9 ? 'TAB' : 
                          i === 27 ? 'ESC' : `CTRL-${String.fromCharCode(i + 64)}`,
                description: this.getASCIIDescription(i)
            });
        }
        return table;
    }
    
    getASCIIDescription(code) {
        if (code === 0) return 'Null character';
        if (code === 7) return 'Bell';
        if (code === 8) return 'Backspace';
        if (code === 9) return 'Horizontal tab';
        if (code === 10) return 'Line feed';
        if (code === 13) return 'Carriage return';
        if (code === 27) return 'Escape';
        if (code === 32) return 'Space';
        if (code >= 48 && code <= 57) return 'Digit';
        if (code >= 65 && code <= 90) return 'Uppercase letter';
        if (code >= 97 && code <= 122) return 'Lowercase letter';
        if (code < 32) return 'Control character';
        return 'Printable character';
    }
    
    charToASCII(char, format = 'decimal') {
        const code = char.charCodeAt(0);
        
        if (code > 127) {
            throw new Error('Character is not in standard ASCII range (0-127)');
        }
        
        const result = {
            input: char,
            decimal: code,
            hex: code.toString(16).toUpperCase().padStart(2, '0'),
            octal: code.toString(8).padStart(3, '0'),
            binary: code.toString(2).padStart(7, '0'),
            character: char,
            description: this.getASCIIDescription(code)
        };
        
        // Format the output based on selected format
        switch(format) {
            case 'binary':
                result.formatted = `Binary: ${result.binary}`;
                break;
            case 'hex':
                result.formatted = `Hex: 0x${result.hex}`;
                break;
            case 'octal':
                result.formatted = `Octal: 0${result.octal}`;
                break;
            default:
                result.formatted = `Decimal: ${result.decimal}`;
        }
        
        return result;
    }
    
    asciiToChar(code, format = 'decimal') {
        if (code < 0 || code > 127) {
            throw new Error('ASCII code must be between 0 and 127');
        }
        
        const char = String.fromCharCode(code);
        const result = {
            input: code,
            decimal: code,
            hex: code.toString(16).toUpperCase().padStart(2, '0'),
            octal: code.toString(8).padStart(3, '0'),
            binary: code.toString(2).padStart(7, '0'),
            character: char,
            description: this.getASCIIDescription(code)
        };
        
        return result;
    }
    
    stringToASCII(text, format = 'decimal') {
        const codes = [];
        const characters = text.split('');
        
        for (let char of characters) {
            const code = char.charCodeAt(0);
            if (code > 127) {
                throw new Error(`Character '${char}' is not in standard ASCII range`);
            }
            
            codes.push({
                character: char,
                decimal: code,
                hex: code.toString(16).toUpperCase().padStart(2, '0'),
                octal: code.toString(8).padStart(3, '0'),
                binary: code.toString(2).padStart(7, '0')
            });
        }
        
        return {
            string: text,
            length: text.length,
            codes: codes,
            format: format
        };
    }
    
    asciiToString(codes, format = 'decimal') {
        const chars = [];
        for (let code of codes) {
            if (code < 0 || code > 127) {
                throw new Error(`Invalid ASCII code: ${code}`);
            }
            chars.push(String.fromCharCode(code));
        }
        
        return {
            codes: codes,
            string: chars.join(''),
            length: chars.length
        };
    }
    
    getASCIITable() {
        return {
            table: this.asciiTable.slice(0, 128),
            categories: this.getASCIICategories()
        };
    }
    
    getASCIICategories() {
        return {
            control: this.asciiTable.slice(0, 32),
            printable: this.asciiTable.slice(32, 127),
            delete: this.asciiTable[127]
        };
    }
    
getStringConversionSteps(text, format) {
    const steps = [];
    
    steps.push(`<div class="number-system2-step active">
        <strong>Step 1: Input String Analysis</strong>
        <p>String: "<span class="special-highlight">${text}</span>"</p>
        <p>Length: ${text.length} characters</p>
        <p>Output Format: ${format}</p>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 2: Character-by-Character Processing</strong>
        <p>Processing each character sequentially:</p>
        <table class="position-table">
            <tr><th>Char</th><th>Position</th><th>ASCII Code</th></tr>
            ${text.split('').map((char, index) => `
                <tr>
                    <td>${char === ' ' ? '' : char}</td>
                    <td>${index + 1}</td>
                    <td>${char.charCodeAt(0)}</td>
                </tr>
            `).join('')}
        </table>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 3: Conversion to Selected Format</strong>
        <p>Converting each ASCII code to ${format}:</p>
        <table class="position-table">
            <tr><th>Char</th><th>Decimal</th><th>Hex</th><th>Binary</th></tr>
            ${text.split('').map(char => {
                const code = char.charCodeAt(0);
                return `
                    <tr>
                        <td>${char === ' ' ? '' : char}</td>
                        <td>${code}</td>
                        <td>0x${code.toString(16).toUpperCase().padStart(2, '0')}</td>
                        <td>${code.toString(2).padStart(7, '0')}</td>
                    </tr>
                `;
            }).join('')}
        </table>
    </div>`);
    
    return steps;
}
// Add this method to the ASCIIDecoder class
getConversionSteps(char, format = 'decimal') {
    const steps = [];
    const code = char.charCodeAt(0);
    
    steps.push(`<div class="number-system2-step active">
        <strong>Step 1: Character Input</strong>
        <p>Character: '<span class="special-highlight">${char}</span>'</p>
        <p>Output Format: ${format}</p>
        ${code > 127 ? '<p class="parity-error"> Character is beyond standard ASCII range (0-127)</p>' : ''}
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 2: Get Character Code</strong>
        <p>Using JavaScript charCodeAt(0) method:</p>
        <p><code>'${char}'.charCodeAt(0) = ${code}</code></p>
        <p>Decimal value: ${code}</p>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 3: Convert to Selected Format</strong>
        <p>Converting decimal ${code} to ${format}:</p>
        ${format === 'binary' ? `<p>${code}<sub>10</sub> = ${code.toString(2).padStart(7, '0')}<sub>2</sub></p>` : ''}
        ${format === 'hex' ? `<p>${code}<sub>10</sub> = 0x${code.toString(16).toUpperCase().padStart(2, '0')}<sub>16</sub></p>` : ''}
        ${format === 'octal' ? `<p>${code}<sub>10</sub> = 0${code.toString(8).padStart(3, '0')}<sub>8</sub></p>` : ''}
        ${format === 'decimal' ? `<p>Already in decimal format: ${code}</p>` : ''}
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 4: Character Properties</strong>
        <p>ASCII Category: ${this.getASCIIDescription(code)}</p>
        <p>Binary (7-bit): ${code.toString(2).padStart(7, '0')}</p>
        <p>Hexadecimal: 0x${code.toString(16).toUpperCase().padStart(2, '0')}</p>
        <p>Octal: 0${code.toString(8).padStart(3, '0')}</p>
        ${code < 32 || code === 127 ? 
            `<p class="parity-error">This is a control character (non-printable)</p>` : 
            `<p>This is a printable character</p>`}
    </div>`);
    
    return steps;
}
getCodesToStringSteps(codes, format) {
    const steps = [];
    
    steps.push(`<div class="number-system2-step active">
        <strong>Step 1: Input Analysis</strong>
        <p>ASCII Codes: <span class="special-highlight">${codes.join(', ')}</span></p>
        <p>Number of codes: ${codes.length}</p>
        <p>Format: ${format}</p>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 2: Validate ASCII Codes</strong>
        <p>Valid ASCII range: 0 to 127</p>
        ${codes.map((code, index) => `
            <p>Code ${index + 1}: ${code} - ${code >= 0 && code <= 127 ? ' Valid' : ' Invalid'}</p>
        `).join('')}
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 3: Convert Codes to Characters</strong>
        <p>Using String.fromCharCode() for each code:</p>
        <table class="position-table">
            <tr><th>Code</th><th>Character</th><th>Type</th></tr>
            ${codes.map(code => {
                const char = String.fromCharCode(code);
                return `
                    <tr>
                        <td>${code}</td>
                        <td>${char === ' ' ? '' : char}</td>
                        <td>${this.getASCIIDescription(code)}</td>
                    </tr>
                `;
            }).join('')}
        </table>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 4: Form Final String</strong>
        <p>Concatenating all characters:</p>
        <p class="special-highlight">"${codes.map(code => String.fromCharCode(code)).join('')}"</p>
        <p>Total length: ${codes.length} characters</p>
    </div>`);
    
    return steps;
}    
    getASCIIToCharSteps(code, format) {
        const steps = [];
        
        steps.push(`<div class="number-system2-step active">
            <strong>Step 1: Validate ASCII Code</strong>
            <p>Input ASCII code: <span class="special-highlight">${code}</span></p>
            <p>Valid range: 0 to 127</p>
            <p>${code >= 0 && code <= 127 ? ' Code is within valid range' : ' Invalid ASCII code'}</p>
        </div>`);
        
        steps.push(`<div class="number-system2-step">
            <strong>Step 2: Convert to Character</strong>
            <p>Using JavaScript String.fromCharCode(${code})</p>
            <p>Result: '<span class="special-highlight">${String.fromCharCode(code)}</span>'</p>
        </div>`);
        
        steps.push(`<div class="number-system2-step">
            <strong>Step 3: Number Formats</strong>
            <p>Binary (7-bit): ${code.toString(2).padStart(7, '0')}</p>
            <p>Hexadecimal: 0x${code.toString(16).toUpperCase().padStart(2, '0')}</p>
            <p>Octal: 0${code.toString(8).padStart(3, '0')}</p>
        </div>`);
        
        steps.push(`<div class="number-system2-step">
            <strong>Step 4: Character Properties</strong>
            <p>ASCII Category: ${this.getASCIIDescription(code)}</p>
            ${code < 32 || code === 127 ? 
                `<p class="parity-error">This is a control character (non-printable)</p>` : 
                `<p>This is a printable character</p>`}
        </div>`);
        
        return steps;
    }
getASCIITableSteps() {
    const steps = [];
    
    steps.push(`<div class="number-system2-step active">
        <strong>Step 1: ASCII Standard Overview</strong>
        <p> 7-bit character encoding (128 characters)</p>
        <p> Developed by ANSI in 1963</p>
        <p> Control characters: 0-31 and 127</p>
        <p> Printable characters: 32-126</p>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 2: Control Characters (0-31)</strong>
        <p>Non-printable characters used for device control:</p>
        <table class="position-table">
            <tr><th>Dec</th><th>Hex</th><th>Char</th><th>Description</th></tr>
            ${this.asciiTable.slice(0, 32).map(item => `
                <tr>
                    <td>${item.decimal}</td>
                    <td>0x${item.hex}</td>
                    <td>${item.character}</td>
                    <td>${item.description}</td>
                </tr>
            `).join('')}
        </table>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 3: Printable Characters (32-126)</strong>
        <p>Characters that can be displayed and printed:</p>
        <table class="position-table">
            <tr><th>Range</th><th>Category</th><th>Examples</th></tr>
            <tr><td>32-47</td><td>Special characters</td><td>Space, !, ", #, $, %, &, ', (, ), *, +, comma, -, ., /</td></tr>
            <tr><td>48-57</td><td>Digits 0-9</td><td>0, 1, 2, 3, 4, 5, 6, 7, 8, 9</td></tr>
            <tr><td>58-64</td><td>Special characters</td><td>:, ;, &lt;, =, &gt;, ?, @</td></tr>
            <tr><td>65-90</td><td>Uppercase A-Z</td><td>A, B, C, ... Z</td></tr>
            <tr><td>91-96</td><td>Special characters</td><td>[, \\, ], ^, _, \`</td></tr>
            <tr><td>97-122</td><td>Lowercase a-z</td><td>a, b, c, ... z</td></tr>
            <tr><td>123-126</td><td>Special characters</td><td>{, |, }, ~</td></tr>
        </table>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 4: Delete Character (127)</strong>
        <p> Decimal: 127</p>
        <p> Hex: 0x7F</p>
        <p> Binary: 1111111</p>
        <p> Character: DEL (Delete)</p>
        <p> Description: Delete character, originally used to delete/overprint</p>
    </div>`);
    
    return steps;
}
}
// Add this BCD Decoder class definition after other classes
class BCDToDecimalDecoder {
    constructor() {
        this.truthTable = {
            '0000': '1000000000',  // 0
            '0001': '0100000000',  // 1
            '0010': '0010000000',  // 2
            '0011': '0001000000',  // 3
            '0100': '0000100000',  // 4
            '0101': '0000010000',  // 5
            '0110': '0000001000',  // 6
            '0111': '0000000100',  // 7
            '1000': '0000000010',  // 8
            '1001': '0000000001',  // 9
            '1010': '0000000000',
            '1011': '0000000000',
            '1100': '0000000000',
            '1101': '0000000000',
            '1110': '0000000000',
            '1111': '0000000000'
        };
    }

    decode(bcdInput) {
        // Validate input
        if (!this._validateInput(bcdInput)) {
            throw new Error("Invalid input: must be 4-bit binary string");
        }
        
        const outputPattern = this.truthTable[bcdInput] || '0000000000';
        const decimalValue = outputPattern.indexOf('1');
        
        return {
            outputPattern,
            decimalValue: decimalValue !== -1 ? decimalValue : null,
            activeLine: decimalValue !== -1 ? `Y${decimalValue}` : 'None'
        };
    }

    simulateCircuit(A, B, C, D) {
        // Convert to boolean
        A = !!A; B = !!B; C = !!C; D = !!D;
        
        // Output equations (active-low logic)
        const outputs = {
            Y0: !(!A && !B && !C && !D),  // 0
            Y1: !(!A && !B && !C && D),   // 1
            Y2: !(!A && !B && C && !D),   // 2
            Y3: !(!A && !B && C && D),    // 3
            Y4: !(!A && B && !C && !D),   // 4
            Y5: !(!A && B && !C && D),    // 5
            Y6: !(!A && B && C && !D),    // 6
            Y7: !(!A && B && C && D),     // 7
            Y8: !(A && !B && !C && !D),   // 8
            Y9: !(A && !B && !C && D)     // 9
        };
        
        return Object.keys(outputs).reduce((acc, key) => {
            acc[key] = outputs[key] ? 1 : 0;
            return acc;
        }, {});
    }

    _validateInput(bcdInput) {
        if (typeof bcdInput !== 'string') return false;
        if (bcdInput.length !== 4) return false;
        return /^[01]+$/.test(bcdInput);
    }

    generateTruthTable() {
        const table = [];
        for (let i = 0; i <= 15; i++) {
            const bcd = i.toString(2).padStart(4, '0');
            const result = this.decode(bcd);
            table.push({
                bcd,
                decimal: result.decimalValue !== null ? result.decimalValue : 'Invalid',
                outputPattern: result.outputPattern,
                activeLine: result.activeLine
            });
        }
        return table;
    }
}

// Create decoder instance
const bcdDecoder = new BCDToDecimalDecoder();

// 7-Segment Decoder Class (Based on your Python code)
class SevenSegmentDecoder {
    constructor() {
        // Define 7-segment display patterns (common cathode - active high)
        // Segment order: A, B, C, D, E, F, G (top to bottom, left to right)
        this.segments = {
            // Digits
            '0': [1, 1, 1, 1, 1, 1, 0],
            '1': [0, 1, 1, 0, 0, 0, 0],
            '2': [1, 1, 0, 1, 1, 0, 1],
            '3': [1, 1, 1, 1, 0, 0, 1],
            '4': [0, 1, 1, 0, 0, 1, 1],
            '5': [1, 0, 1, 1, 0, 1, 1],
            '6': [1, 0, 1, 1, 1, 1, 1],
            '7': [1, 1, 1, 0, 0, 0, 0],
            '8': [1, 1, 1, 1, 1, 1, 1],
            '9': [1, 1, 1, 1, 0, 1, 1],
            
            // Uppercase Letters
            'A': [1, 1, 1, 0, 1, 1, 1],
            'B': [0, 0, 1, 1, 1, 1, 1],
            'C': [1, 0, 0, 1, 1, 1, 0],
            'D': [0, 1, 1, 1, 1, 0, 1],
            'E': [1, 0, 0, 1, 1, 1, 1],
            'F': [1, 0, 0, 0, 1, 1, 1],
            'G': [1, 0, 1, 1, 1, 1, 0],
            'H': [0, 1, 1, 0, 1, 1, 1],
            'I': [0, 1, 1, 0, 0, 0, 0],
            'J': [0, 1, 1, 1, 0, 0, 0],
            'K': [1, 0, 1, 0, 1, 1, 1],
            'L': [0, 0, 0, 1, 1, 1, 0],
            'M': [1, 0, 1, 0, 1, 0, 0],
            'N': [0, 0, 1, 0, 1, 0, 1],
            'O': [0, 0, 1, 1, 1, 0, 1],
            'P': [1, 1, 0, 0, 1, 1, 1],
            'Q': [1, 1, 1, 0, 0, 1, 1],
            'R': [0, 0, 0, 0, 1, 0, 1],
            'S': [1, 0, 1, 1, 0, 1, 1],
            'T': [0, 0, 0, 1, 1, 1, 1],
            'U': [0, 1, 1, 1, 1, 1, 0],
            'V': [0, 1, 1, 1, 1, 1, 0],
            'W': [0, 1, 0, 1, 0, 1, 0],
            'X': [0, 1, 1, 0, 1, 1, 1],
            'Y': [0, 1, 1, 1, 0, 1, 1],
            'Z': [1, 1, 0, 1, 1, 0, 1],
            
            // Lowercase Letters
            'a': [1, 1, 1, 0, 1, 1, 1],
            'b': [0, 0, 1, 1, 1, 1, 1],
            'c': [1, 0, 0, 1, 1, 1, 0],
            'd': [0, 1, 1, 1, 1, 0, 1],
            'e': [1, 0, 0, 1, 1, 1, 1],
            'f': [1, 0, 0, 0, 1, 1, 1],
            'g': [1, 0, 1, 1, 1, 1, 0],
            'h': [0, 1, 1, 0, 1, 1, 1],
            'i': [0, 1, 1, 0, 0, 0, 0],
            'j': [0, 1, 1, 1, 0, 0, 0],
            'k': [1, 0, 1, 0, 1, 1, 1],
            'l': [0, 0, 0, 1, 1, 1, 0],
            'm': [1, 0, 1, 0, 1, 0, 0],
            'n': [0, 0, 1, 0, 1, 0, 1],
            'o': [0, 0, 1, 1, 1, 0, 1],
            'p': [1, 1, 0, 0, 1, 1, 1],
            'q': [1, 1, 1, 0, 0, 1, 1],
            'r': [0, 0, 0, 0, 1, 0, 1],
            's': [1, 0, 1, 1, 0, 1, 1],
            't': [0, 0, 0, 1, 1, 1, 1],
            'u': [0, 1, 1, 1, 1, 1, 0],
            'v': [0, 1, 1, 1, 1, 1, 0],
            'w': [0, 1, 0, 1, 0, 1, 0],
            'x': [0, 1, 1, 0, 1, 1, 1],
            'y': [0, 1, 1, 1, 0, 1, 1],
            'z': [1, 1, 0, 1, 1, 0, 1],
            
            // Special characters
            ' ': [0, 0, 0, 0, 0, 0, 0],
            '-': [0, 0, 0, 0, 0, 0, 1],
            '_': [0, 0, 0, 1, 0, 0, 0],
            '=': [0, 0, 0, 1, 0, 0, 1],
        };
        
        this.defaultChar = '?';
        this.segmentNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
    }
    
    charToSevenSegment(char, displayType = 'common-cathode') {
        if (!char || char.length !== 1) {
            char = String(char)[0] || ' ';
        }
        
        let pattern;
        if (char in this.segments) {
            pattern = [...this.segments[char]];
        } else {
            const upperChar = char.toUpperCase();
            pattern = upperChar in this.segments ? [...this.segments[upperChar]] : [...this.segments[this.defaultChar]];
        }
        
        // Invert for common anode
        if (displayType === 'common-anode') {
            pattern = pattern.map(bit => bit === 1 ? 0 : 1);
        }
        
        const binaryPattern = pattern.join('');
        const decimalValue = parseInt(binaryPattern, 2);
        
        return {
            character: char,
            ascii: char.charCodeAt(0),
            pattern: pattern,
            binary: binaryPattern,
            decimal: decimalValue,
            hex: decimalValue.toString(16).toUpperCase().padStart(2, '0'),
            displayType: displayType,
            visual: this.createVisualPattern(pattern)
        };
    }
    
    asciiToSevenSegment(asciiValue, displayType = 'common-cathode') {
        const char = String.fromCharCode(asciiValue);
        return this.charToSevenSegment(char, displayType);
    }
    
    stringToSevenSegment(text, displayType = 'common-cathode') {
        const patterns = [];
        for (let char of text) {
            patterns.push(this.charToSevenSegment(char, displayType));
        }
        
        return {
            string: text,
            length: text.length,
            patterns: patterns,
            displayType: displayType
        };
    }
    
    binaryToCharacter(binaryPattern, displayType = 'common-cathode') {
        if (!/^[01]{7}$/.test(binaryPattern)) {
            throw new Error('Invalid 7-bit binary pattern');
        }
        
        // Convert to array of numbers
        const pattern = binaryPattern.split('').map(bit => parseInt(bit));
        
        // If common anode, invert the pattern for lookup
        let lookupPattern = displayType === 'common-anode' ? 
            pattern.map(bit => bit === 1 ? 0 : 1) : 
            pattern;
        
        // Find character that matches this pattern
        let foundChar = '?';
        for (const [char, segPattern] of Object.entries(this.segments)) {
            if (JSON.stringify(segPattern) === JSON.stringify(lookupPattern)) {
                foundChar = char;
                break;
            }
        }
        
        const decimalValue = parseInt(binaryPattern, 2);
        
        return {
            binary: binaryPattern,
            pattern: pattern,
            character: foundChar,
            ascii: foundChar.charCodeAt(0),
            decimal: decimalValue,
            hex: decimalValue.toString(16).toUpperCase().padStart(2, '0'),
            displayType: displayType,
            visual: this.createVisualPattern(pattern)
        };
    }
    
    createVisualDisplay(binaryPattern, displayType = 'common-cathode') {
        const result = this.binaryToCharacter(binaryPattern, displayType);
        
        // Create enhanced visual representation
        const pattern = result.pattern;
        const [a, b, c, d, e, f, g] = pattern;
        
        const visualHTML = `
            <div class="seven-seg-visual">
                <div class="segment-a ${a ? 'on' : 'off'}"></div>
                <div class="segment-f ${f ? 'on' : 'off'}"></div>
                <div class="segment-b ${b ? 'on' : 'off'}"></div>
                <div class="segment-g ${g ? 'on' : 'off'}"></div>
                <div class="segment-e ${e ? 'on' : 'off'}"></div>
                <div class="segment-c ${c ? 'on' : 'off'}"></div>
                <div class="segment-d ${d ? 'on' : 'off'}"></div>
            </div>
        `;
        
        result.enhancedVisual = visualHTML;
        return result;
    }
    
    createVisualPattern(pattern) {
        const [a, b, c, d, e, f, g] = pattern;
        
        // Create ASCII art representation
        const top =    " " + (a ? "" : " ") + " ";
        const middle = (f ? "" : " ") + (g ? "" : " ") + (b ? "" : " ");
        const bottom = (e ? "" : " ") + (d ? "" : " ") + (c ? "" : " ");
        
        return `${top}\n${middle}\n${bottom}`;
    }
    
    getConversionSteps(char, displayType) {
        const result = this.charToSevenSegment(char, displayType);
        const steps = [];
        
        steps.push(`<div class="number-system2-step active">
            <strong>Step 1: Input Character Analysis</strong>
            <p>Character: '<span class="special-highlight">${char}</span>'</p>
            <p>ASCII Code: ${result.ascii} (Decimal)</p>
            <p>Binary: ${result.ascii.toString(2).padStart(7, '0')}</p>
        </div>`);
        
        steps.push(`<div class="number-system2-step">
            <strong>Step 2: Lookup 7-Segment Pattern</strong>
            <p>Looking up pattern for character '${char}' in 7-segment mapping table</p>
            <p>Default pattern (Common Cathode): ${this.segments[char] ? this.segments[char].join('') : 'Not found'}</p>
            ${!this.segments[char] ? `<p>Using uppercase version: '${char.toUpperCase()}'</p>` : ''}
        </div>`);
        
        steps.push(`<div class="number-system2-step">
            <strong>Step 3: Apply Display Type</strong>
            <p>Display Type: <span class="special-highlight">${displayType}</span></p>
            <p>Common Cathode: 1 = ON, 0 = OFF</p>
            <p>Common Anode: 1 = OFF, 0 = ON (inverted logic)</p>
            <p>Final Pattern: ${result.pattern.join('')}</p>
        </div>`);
        
        steps.push(`<div class="number-system2-step">
            <strong>Step 4: Segment Mapping</strong>
            <table class="position-table">
                <tr><th>Segment</th><th>Position</th><th>State</th><th>Description</th></tr>
                <tr><td>A</td><td>Top</td><td>${result.pattern[0]}</td><td>${result.pattern[0] ? 'ON' : 'OFF'}</td></tr>
                <tr><td>B</td><td>Top Right</td><td>${result.pattern[1]}</td><td>${result.pattern[1] ? 'ON' : 'OFF'}</td></tr>
                <tr><td>C</td><td>Bottom Right</td><td>${result.pattern[2]}</td><td>${result.pattern[2] ? 'ON' : 'OFF'}</td></tr>
                <tr><td>D</td><td>Bottom</td><td>${result.pattern[3]}</td><td>${result.pattern[3] ? 'ON' : 'OFF'}</td></tr>
                <tr><td>E</td><td>Bottom Left</td><td>${result.pattern[4]}</td><td>${result.pattern[4] ? 'ON' : 'OFF'}</td></tr>
                <tr><td>F</td><td>Top Left</td><td>${result.pattern[5]}</td><td>${result.pattern[5] ? 'ON' : 'OFF'}</td></tr>
                <tr><td>G</td><td>Middle</td><td>${result.pattern[6]}</td><td>${result.pattern[6] ? 'ON' : 'OFF'}</td></tr>
            </table>
        </div>`);
        
        steps.push(`<div class="number-system2-step">
            <strong>Step 5: Binary Conversion</strong>
            <p>Binary Pattern: ${result.binary}</p>
            <p>Decimal Value: ${result.decimal}</p>
            <p>Hexadecimal: 0x${result.hex}</p>
            <p>Visual Representation:</p>
            <pre style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px;">${result.visual}</pre>
        </div>`);
        
        return steps;
    }
    
    getASCIITo7SegSteps(asciiValue, displayType) {
        const steps = [];
        
        steps.push(`<div class="number-system2-step active">
            <strong>Step 1: ASCII Code Validation</strong>
            <p>Input ASCII: <span class="special-highlight">${asciiValue}</span></p>
            <p>Valid Range: 0-127</p>
            <p>Character: '${String.fromCharCode(asciiValue)}'</p>
        </div>`);
        
        const char = String.fromCharCode(asciiValue);
        const result = this.charToSevenSegment(char, displayType);
        
        steps.push(`<div class="number-system2-step">
            <strong>Step 2: Character to 7-Segment Mapping</strong>
            <p>Character '${char}' mapped to segments:</p>
            <p>Default Pattern: ${this.segments[char] ? this.segments[char].join('') : 'Using fallback'}</p>
        </div>`);
        
        // Include the same steps as char conversion
        steps.push(`<div class="number-system2-step">
            <strong>Step 3: Display Type Application</strong>
            <p>Display Type: ${displayType}</p>
            <p>Final Binary Pattern: ${result.binary}</p>
        </div>`);
        
        return steps;
    }
    // Add these methods to the SevenSegmentDecoder class

getStringConversionSteps(text, displayType) {
    const steps = [];
    
    steps.push(`<div class="number-system2-step active">
        <strong>Step 1: Input String Analysis</strong>
        <p>String: "<span class="special-highlight">${text}</span>"</p>
        <p>Length: ${text.length} characters</p>
        <p>Display Type: ${displayType}</p>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 2: Character-by-Character Conversion</strong>
        <p>Converting each character to 7-segment pattern:</p>
        ${text.split('').map((char, index) => {
            const result = this.charToSevenSegment(char, displayType);
            return `
                <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Character ${index + 1}: '${char}'</strong>
                    <p>ASCII: ${result.ascii}</p>
                    <p>Binary Pattern: ${result.binary}</p>
                    <p>Hex: 0x${result.hex}</p>
                    <pre style="font-family: monospace; margin: 5px 0;">${result.visual}</pre>
                </div>
            `;
        }).join('')}
    </div>`);
    
    return steps;
}

getBinaryToCharSteps(binaryPattern, displayType) {
    const steps = [];
    
    steps.push(`<div class="number-system2-step active">
        <strong>Step 1: Input Binary Pattern</strong>
        <p>Binary: <span class="bit-value binary-bit-1">${binaryPattern}</span></p>
        <p>Length: ${binaryPattern.length} bits (must be 7)</p>
        <p>Display Type: ${displayType}</p>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 2: Validate Binary Pattern</strong>
        <p> Must be exactly 7 bits</p>
        <p> Each bit must be 0 or 1</p>
        <p>${/^[01]{7}$/.test(binaryPattern) ? ' Valid binary pattern' : ' Invalid binary pattern'}</p>
    </div>`);
    
    const pattern = binaryPattern.split('').map(bit => parseInt(bit));
    const lookupPattern = displayType === 'common-anode' ? 
        pattern.map(bit => bit === 1 ? 0 : 1) : 
        pattern;
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 3: Convert for Display Type</strong>
        <p>Display Type: ${displayType}</p>
        <p>${displayType === 'common-anode' ? 
            'Inverting bits (common anode uses active-low logic)' : 
            'Using direct mapping (common cathode uses active-high logic)'}</p>
        <p>Lookup Pattern: ${lookupPattern.join('')}</p>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 4: Pattern Lookup</strong>
        <p>Searching through 7-segment patterns database...</p>
        <p>Looking for pattern: ${lookupPattern.join('')}</p>
        <p>Found character: '${this.binaryToCharacter(binaryPattern, displayType).character}'</p>
    </div>`);
    
    const result = this.binaryToCharacter(binaryPattern, displayType);
    steps.push(`<div class="number-system2-step">
        <strong>Step 5: Result</strong>
        <p>Character: '${result.character}'</p>
        <p>ASCII Code: ${result.ascii}</p>
        <p>Decimal Value: ${result.decimal}</p>
        <p>Hexadecimal: 0x${result.hex}</p>
        <pre style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">${result.visual}</pre>
    </div>`);
    
    return steps;
}

getVisualDisplaySteps(binaryPattern, displayType) {
    const steps = [];
    
    steps.push(`<div class="number-system2-step active">
        <strong>Step 1: 7-Segment Display Layout</strong>
        <p>Segments are labeled A through G:</p>
        <pre style="font-family: monospace; text-align: center; margin: 10px 0;">
     A
    F B
     G
    E C
     D
        </pre>
        <p>Binary pattern order: A, B, C, D, E, F, G</p>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 2: Input Pattern Analysis</strong>
        <p>Binary Pattern: <span class="special-highlight">${binaryPattern}</span></p>
        <p>Display Type: ${displayType}</p>
        <p>Bit mapping:</p>
        <table class="position-table">
            <tr><th>Bit</th><th>Position</th><th>Segment</th><th>Value</th></tr>
            ${binaryPattern.split('').map((bit, index) => `
                <tr>
                    <td>${index}</td>
                    <td>${index + 1}</td>
                    <td>${this.segmentNames[index]}</td>
                    <td><span class="bit-value ${bit === '1' ? 'binary-bit-1' : 'binary-bit-0'}">${bit}</span></td>
                </tr>
            `).join('')}
        </table>
    </div>`);
    
    const result = this.binaryToCharacter(binaryPattern, displayType);
    steps.push(`<div class="number-system2-step">
        <strong>Step 3: Character Identification</strong>
        <p>This pattern represents character: '${result.character}'</p>
        <p>ASCII Code: ${result.ascii}</p>
        <p>Decimal Equivalent: ${result.decimal}</p>
        <p>Hexadecimal: 0x${result.hex}</p>
    </div>`);
    
    steps.push(`<div class="number-system2-step">
        <strong>Step 4: Visual Representation</strong>
        <p>Creating visual display...</p>
        <div style="text-align: center; margin: 20px 0;">
            ${this.createVisualDisplay(binaryPattern, displayType).enhancedVisual}
        </div>
    </div>`);
    
    return steps;
}
}

// Display advanced results
function displayAdvancedResults(results, steps) {
    const resultsContainer = document.getElementById('number-system2-results');
    const stepsContainer = document.getElementById('number-system2-steps-content');
    
    // Clear previous content
    stepsContainer.innerHTML = '';
    resultsContainer.innerHTML = '';
    
    // Display steps
    if (steps && steps.length > 0) {
        document.getElementById('number-system2-steps-container').style.display = 'block';
        steps.forEach((step, index) => {
            stepsContainer.innerHTML += step;
        });
    }
    
    // Display main results
    if (results) {
        resultsContainer.innerHTML = createAdvancedResultsHTML(results);
    }
}

// Create HTML for advanced results
function createAdvancedResultsHTML(results) {
    let html = '<div class="glass-card">';
    
    if (currentAdvancedOperations === 'ascii') {
        html += createASCIIResultsHTML(results);
    } else if (currentAdvancedOperations === 'seven-segment') {
        html += createSevenSegmentResultsHTML(results);
    }
    
    html += '</div>';
    return html;
}

// Create ASCII results HTML
function createASCIIResultsHTML(results) {
    let html = '<h5 class="text-center mb-3">ASCII Encoding Results</h5>';
    
    if (results.table) {
        // ASCII Table
        html += '<div class="ascii-table-container">';
        html += '<table class="position-table">';
        html += '<tr><th>Dec</th><th>Hex</th><th>Oct</th><th>Binary</th><th>Char</th><th>Description</th></tr>';
        
        results.table.forEach(item => {
            const charDisplay = item.character.length === 1 ? 
                (item.character === ' ' ? '' : item.character) : 
                item.character;
            
            html += `<tr>
                <td>${item.decimal}</td>
                <td>0x${item.hex}</td>
                <td>0${item.octal}</td>
                <td>${item.binary}</td>
                <td>${charDisplay}</td>
                <td>${item.description}</td>
            </tr>`;
        });
        
        html += '</table></div>';
    } else if (results.codes) {
        // String to ASCII
        html += `<p><strong>String:</strong> "${results.string}"</p>`;
        html += `<p><strong>Length:</strong> ${results.length} characters</p>`;
        html += '<table class="position-table">';
        html += '<tr><th>Char</th><th>ASCII</th><th>Hex</th><th>Binary</th></tr>';
        
        results.codes.forEach(item => {
            html += `<tr>
                <td>${item.character === ' ' ? '' : item.character}</td>
                <td>${item.decimal}</td>
                <td>0x${item.hex}</td>
                <td>${item.binary}</td>
            </tr>`;
        });
        
        html += '</table>';
    } else if (results.string) {
        // ASCII to String
        html += `<p><strong>ASCII Codes:</strong> ${results.codes.join(', ')}</p>`;
        html += `<p><strong>Resulting String:</strong> "${results.string}"</p>`;
        html += `<p><strong>Length:</strong> ${results.length} characters</p>`;
    } else {
        // Single character
        html += `<div class="text-center">
            <h6>Character: '${results.character === ' ' ? '' : results.character}'</h6>
            <div class="ascii-result-box">
                <p><strong>Decimal:</strong> ${results.decimal}</p>
                <p><strong>Hexadecimal:</strong> 0x${results.hex}</p>
                <p><strong>Octal:</strong> 0${results.octal}</p>
                <p><strong>Binary (7-bit):</strong> ${results.binary}</p>
                <p><strong>Category:</strong> ${results.description}</p>
            </div>
        </div>`;
    }
    
    return html;
}

// Create 7-Segment results HTML
function createSevenSegmentResultsHTML(results) {
    let html = '<h5 class="text-center mb-3">7-Segment Display Results</h5>';
    
    if (results.patterns) {
        // String conversion
        html += `<p><strong>String:</strong> "${results.string}"</p>`;
        html += `<p><strong>Length:</strong> ${results.length} characters</p>`;
        html += `<p><strong>Display Type:</strong> ${results.displayType}</p>`;
        
        results.patterns.forEach((item, index) => {
            html += `<div class="seven-seg-result">
                <h6>Character ${index + 1}: '${item.character}'</h6>
                <p><strong>ASCII:</strong> ${item.ascii}</p>
                <p><strong>Binary Pattern:</strong> ${item.binary}</p>
                <p><strong>Hex:</strong> 0x${item.hex}</p>
                <p><strong>Decimal:</strong> ${item.decimal}</p>
                <pre style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">${item.visual}</pre>
            </div>`;
        });
    } else if (results.enhancedVisual) {
        // Visual display
        html += `<div class="text-center">
            <h6>7-Segment Display Visualization</h6>
            <p><strong>Binary Input:</strong> ${results.binary}</p>
            <p><strong>Character:</strong> '${results.character}'</p>
            <p><strong>Display Type:</strong> ${results.displayType}</p>
            <div class="seven-seg-visual-container">
                ${results.enhancedVisual}
            </div>
            <p><strong>Hex Value:</strong> 0x${results.hex}</p>
            <p><strong>Decimal Value:</strong> ${results.decimal}</p>
        </div>`;
    } else {
        // Single character
        html += `<div class="text-center">
            <h6>Character: '${results.character}'</h6>
            <p><strong>ASCII Code:</strong> ${results.ascii}</p>
            <p><strong>Display Type:</strong> ${results.displayType}</p>
            <p><strong>Binary Pattern:</strong> ${results.binary}</p>
            <p><strong>Hex Value:</strong> 0x${results.hex}</p>
            <p><strong>Decimal Value:</strong> ${results.decimal}</p>
            <div class="seven-seg-pattern">
                <h6>Segment States:</h6>
                <table class="position-table">
                    <tr><th>Segment</th><th>State</th><th>Function</th></tr>
                    ${results.pattern.map((state, index) => `
                        <tr>
                            <td>${this.segmentNames ? this.segmentNames[index] : `Seg ${index}`}</td>
                            <td><span class="bit-value ${state ? 'binary-bit-1' : 'binary-bit-0'}">${state}</span></td>
                            <td>${state ? 'ON' : 'OFF'}</td>
                        </tr>
                    `).join('')}
                </table>
            </div>
            <div class="seven-seg-visual">
                <pre style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px auto; width: fit-content;">${results.visual}</pre>
            </div>
        </div>`;
    }
    
    return html;
}

// Add CSS for 7-segment display visualization
const sevenSegmentCSS = `
<style>
.seven-seg-visual {
    position: relative;
    width: 100px;
    height: 180px;
    margin: 20px auto;
    background: #222;
    border-radius: 10px;
    padding: 15px;
}

.segment-a, .segment-b, .segment-c, .segment-d, .segment-e, .segment-f, .segment-g {
    position: absolute;
    background: #444;
    color: #fff;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}

.segment-a.on, .segment-b.on, .segment-c.on, .segment-d.on, .segment-e.on, .segment-f.on, .segment-g.on {
    background: #ff0000;
    color: #fff;
    text-shadow: 0 0 5px #ff0000;
}

.segment-a {
    top: 10px;
    left: 20px;
    right: 20px;
    height: 10px;
}

.segment-b {
    top: 20px;
    right: 10px;
    width: 10px;
    height: 60px;
}

.segment-c {
    bottom: 50px;
    right: 10px;
    width: 10px;
    height: 60px;
}

.segment-d {
    bottom: 10px;
    left: 20px;
    right: 20px;
    height: 10px;
}

.segment-e {
    bottom: 50px;
    left: 10px;
    width: 10px;
    height: 60px;
}

.segment-f {
    top: 20px;
    left: 10px;
    width: 10px;
    height: 60px;
}

.segment-g {
    top: 80px;
    left: 20px;
    right: 20px;
    height: 10px;
}

.ascii-table-container {
    max-height: 400px;
    overflow-y: auto;
}

.seven-seg-result {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 3px solid var(--info-color);
}
</style>
`;

// Add the CSS to the document
document.head.insertAdjacentHTML('beforeend', sevenSegmentCSS);
// Update advanced operation description
function updateAdvancedOperationDescription() {
    const description = document.getElementById('code-description');
    
    switch(currentAdvancedOperations) {
        case 'ascii':
            description.innerHTML = `
                <strong>ASCII (American Standard Code for Information Interchange)</strong>
                <p> 7-bit character encoding (128 characters)</p>
                <p> Includes control characters (0-31, 127)</p>
                <p> Printable characters (32-126)</p>
                <p> Standard for text in computers and communication</p>
            `;
            break;
        case 'seven-segment':
            description.innerHTML = `
                <strong>7-Segment Display</strong>
                <p> 7 LED segments arranged as an '8'</p>
                <p> Can display digits 0-9 and some letters</p>
                <p> Common Cathode: LED cathodes connected to ground</p>
                <p> Common Anode: LED anodes connected to VCC</p>
                <p> Each segment controlled by one bit (A-G)</p>
            `;
            break;
    }
}

// Reset ASCII operation
function resetASCII() {
    document.getElementById('ascii-char-value').value = '';
    document.getElementById('ascii-decimal-value').value = '65';
    document.getElementById('ascii-string-value').value = 'HELLO';
    document.getElementById('ascii-codes-value').value = '72,69,76,76,79';
    document.getElementById('ascii-operation').value = 'char-to-ascii';
    document.getElementById('ascii-format-select').value = 'decimal';
    
    updateASCIIInterface();
    document.getElementById('number-system2-results').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-keyboard fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <h4 class="mt-3">ASCII Encoding</h4>
            <p>Configure your conversion and click Calculate</p>
        </div>
    `;
    document.getElementById('number-system2-steps-container').style.display = 'none';
    
    addLog('ASCII operation reset', 'info');
}

// Reset 7-Segment operation
function resetSevenSegment() {
    document.getElementById('7seg-char-value').value = 'A';
    document.getElementById('7seg-ascii-value').value = '65';
    document.getElementById('7seg-string-value').value = 'HELLO';
    document.getElementById('7seg-binary-value').value = '1110111';
    document.getElementById('seven-seg-operation').value = 'char-to-7seg';
    document.getElementById('7seg-display-type').value = 'common-cathode';
    
    updateSevenSegmentInterface();
    document.getElementById('number-system2-results').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-display fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <h4 class="mt-3">7-Segment Display</h4>
            <p>Configure your conversion and click Calculate</p>
        </div>
    `;
    document.getElementById('number-system2-steps-container').style.display = 'none';
    
    addLog('7-Segment operation reset', 'info');
}

// Test ASCII examples
function testASCIIExamples() {
    const examples = [
        {
            type: 'char-to-ascii',
            input: 'A',
            expected: { decimal: 65, binary: '1000001' }
        },
        {
            type: 'ascii-to-char',
            input: '97',
            expected: { char: 'a', binary: '1100001' }
        },
        {
            type: 'string-to-ascii',
            input: 'HELLO',
            expected: { codes: [72, 69, 76, 76, 79] }
        },
        {
            type: 'ascii-to-string',
            input: '72,69,76,76,79',
            expected: { string: 'HELLO' }
        }
    ];
    
    let resultsHTML = '<div class="glass-card"><h5>ASCII Test Examples</h5>';
    
    examples.forEach((example, index) => {
        try {
            let result;
            switch(example.type) {
                case 'char-to-ascii':
                    result = asciiDecoder.charToASCII(example.input, 'binary');
                    resultsHTML += `<div class="test-example ${result.binary === example.expected.binary ? 'test-pass' : 'test-fail'}">
                        <strong>Example ${index + 1}: Character to ASCII</strong>
                        <p>Input: '${example.input}'</p>
                        <p>Expected Binary: ${example.expected.binary}</p>
                        <p>Got Binary: ${result.binary}</p>
                        <p>Result: ${result.binary === example.expected.binary ? ' PASS' : ' FAIL'}</p>
                    </div>`;
                    break;
                    
                case 'ascii-to-char':
                    result = asciiDecoder.asciiToChar(parseInt(example.input), 'binary');
                    resultsHTML += `<div class="test-example ${result.character === example.expected.char ? 'test-pass' : 'test-fail'}">
                        <strong>Example ${index + 1}: ASCII to Character</strong>
                        <p>Input: ${example.input}</p>
                        <p>Expected Character: '${example.expected.char}'</p>
                        <p>Got Character: '${result.character}'</p>
                        <p>Result: ${result.character === example.expected.char ? ' PASS' : ' FAIL'}</p>
                    </div>`;
                    break;
            }
        } catch (error) {
            resultsHTML += `<div class="test-example test-fail">
                <strong>Example ${index + 1}: ERROR</strong>
                <p>Error: ${error.message}</p>
            </div>`;
        }
    });
    
    resultsHTML += '</div>';
    document.getElementById('number-system2-results').innerHTML = resultsHTML;
    
    addLog('Ran ASCII test examples', 'info');
}

// Test 7-Segment examples
function testSevenSegmentExamples() {
    const examples = [
        {
            type: 'char-to-7seg',
            input: '8',
            expected: { binary: '1111111', decimal: 127 }
        },
        {
            type: 'char-to-7seg',
            input: '0',
            expected: { binary: '1111110', decimal: 126 }
        },
        {
            type: 'binary-to-7seg',
            input: '0110000',
            expected: { char: '1', decimal: 48 }
        }
    ];
    
    let resultsHTML = '<div class="glass-card"><h5>7-Segment Test Examples</h5>';
    
    examples.forEach((example, index) => {
        try {
            let result;
            switch(example.type) {
                case 'char-to-7seg':
                    result = sevenSegmentDecoder.charToSevenSegment(example.input, 'common-cathode');
                    resultsHTML += `<div class="test-example ${result.binary === example.expected.binary ? 'test-pass' : 'test-fail'}">
                        <strong>Example ${index + 1}: Character to 7-Segment</strong>
                        <p>Input: '${example.input}'</p>
                        <p>Expected Binary: ${example.expected.binary}</p>
                        <p>Got Binary: ${result.binary}</p>
                        <p>Expected Decimal: ${example.expected.decimal}</p>
                        <p>Got Decimal: ${result.decimal}</p>
                        <p>Result: ${result.binary === example.expected.binary ? ' PASS' : ' FAIL'}</p>
                        <pre style="font-family: monospace; background: #f8f9fa; padding: 5px; border-radius: 3px;">${result.visual}</pre>
                    </div>`;
                    break;
                    
                case 'binary-to-7seg':
                    result = sevenSegmentDecoder.binaryToCharacter(example.input, 'common-cathode');
                    resultsHTML += `<div class="test-example ${result.character === example.expected.char ? 'test-pass' : 'test-fail'}">
                        <strong>Example ${index + 1}: Binary to Character</strong>
                        <p>Input: ${example.input}</p>
                        <p>Expected Character: '${example.expected.char}'</p>
                        <p>Got Character: '${result.character}'</p>
                        <p>Expected Decimal: ${example.expected.decimal}</p>
                        <p>Got Decimal: ${result.decimal}</p>
                        <p>Result: ${result.character === example.expected.char ? ' PASS' : ' FAIL'}</p>
                    </div>`;
                    break;
            }
        } catch (error) {
            resultsHTML += `<div class="test-example test-fail">
                <strong>Example ${index + 1}: ERROR</strong>
                <p>Error: ${error.message}</p>
            </div>`;
        }
    });
    
    resultsHTML += '</div>';
    document.getElementById('number-system2-results').innerHTML = resultsHTML;
    
    addLog('Ran 7-Segment test examples', 'info');
}

// Show ASCII table
function showASCIITable() {
    if (!asciiDecoder) {
        asciiDecoder = new ASCIIDecoder();
    }
    
    const asciiTable = asciiDecoder.getASCIITable();
    const steps = asciiDecoder.getASCIITableSteps();
    
    displayAdvancedResults(asciiTable, steps);
    addLog('Displayed ASCII table', 'info');
}

// Animate 7-segment display
function animateSevenSegmentDisplay() {
    const binaryPattern = document.getElementById('7seg-binary-value').value;
    const displayType = document.getElementById('7seg-display-type').value;
    
    if (!/^[01]{7}$/.test(binaryPattern)) {
        showError('Please enter a valid 7-bit binary pattern');
        return;
    }
    
    const result = sevenSegmentDecoder.createVisualDisplay(binaryPattern, displayType);
    
    // Create animation
    const visualContainer = document.createElement('div');
    visualContainer.className = 'seven-seg-animation';
    visualContainer.innerHTML = `
        <div class="text-center">
            <h5>7-Segment Display Animation</h5>
            <p>Binary Pattern: <span class="bit-value binary-bit-1">${binaryPattern}</span></p>
            <p>Character: '${result.character}'</p>
            <div id="animated-display" style="margin: 20px auto;">
                ${result.enhancedVisual}
            </div>
            <div class="animation-controls">
                <button class="btn-glow btn-sm" onclick="toggleSegmentAnimation()">
                    <i class="fas fa-play"></i> Animate Segments
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('number-system2-results').innerHTML = '';
    document.getElementById('number-system2-results').appendChild(visualContainer);
    
    addLog('Started 7-segment display animation', 'info');
}

// Add CSS for test examples
const testExampleCSS = `
<style>
.test-example {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid var(--info-color);
}

.test-pass {
    border-left-color: var(--success-color);
    background: rgba(34, 139, 34, 0.1);
}

.test-fail {
    border-left-color: var(--danger-color);
    background: rgba(220, 20, 60, 0.1);
}

.seven-seg-animation {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', testExampleCSS);
function showError(message) {
    const errorHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-exclamation-triangle fa-4x" style="color: var(--danger-color);"></i>
            <h4 class="mt-3" style="color: var(--danger-color);">Error</h4>
            <p>${message}</p>
        </div>
    `;
    
    document.getElementById('number-system2-results').innerHTML = errorHTML;
}
// Add to your existing JavaScript file or create a new section

// Binary Counter State
let binaryCounterState = {
    bits: 4,
    currentValue: 0,
    maxValue: 15,
    clockState: false,
    isRunning: false,
    sequenceInterval: null,
    counterValues: [0, 0, 0, 0] // For 4-bit initially
};

// Initialize Binary Counter
function initBinaryCounter() {
    // Set initial values based on bit selection
    updateCounterBits();
    updateDisplay();
}

// Update counter bits based on selection
function updateCounterBits() {
    const bits = parseInt(document.getElementById('counter-bits-select').value);
    binaryCounterState.bits = bits;
    binaryCounterState.maxValue = Math.pow(2, bits) - 1;
    binaryCounterState.counterValues = new Array(bits).fill(0);
    
    // Update initial value input max
    const initialInput = document.getElementById('counter-initial-value');
    initialInput.max = binaryCounterState.maxValue;
    
    // Reset to initial value
    const initialValue = parseInt(initialInput.value);
    binaryCounterState.currentValue = Math.min(initialValue, binaryCounterState.maxValue);
    
    // Update binary display
    updateBinaryDisplay();
}

// Update binary display
function updateBinaryDisplay() {
    const bits = binaryCounterState.bits;
    const currentValue = binaryCounterState.currentValue;
    
    // Update counter values array
    const binaryStr = currentValue.toString(2).padStart(bits, '0');
    for (let i = 0; i < bits; i++) {
        binaryCounterState.counterValues[i] = parseInt(binaryStr[bits - 1 - i]); // Q0 is LSB
    }
    
    // Update binary display
    document.getElementById('counter-initial-binary').textContent = binaryStr;
    document.getElementById('counter-current-value').value = 
        `${currentValue} (${binaryStr})`;
}

// Simulate a clock pulse
function simulateClockPulse() {
    if (binaryCounterState.isRunning) return;
    
    // Get current value
    let currentValue = binaryCounterState.currentValue;
    const bits = binaryCounterState.bits;
    
    // Increment counter (with overflow)
    currentValue = (currentValue + 1) % (binaryCounterState.maxValue + 1);
    binaryCounterState.currentValue = currentValue;
    
    // Update display
    updateBinaryDisplay();
    
    // Show step-by-step calculation
    showStepByStepAnalysis(currentValue);
    
    return currentValue;
}

// Run full sequence
// Enhanced run full sequence function
function runFullSequence() {
    if (binaryCounterState.isRunning) {
        stopSequence();
        return;
    }
    
    binaryCounterState.isRunning = true;
    let step = 0;
    const totalSteps = binaryCounterState.maxValue + 1;
    const bits = binaryCounterState.bits;
    
    // Update button text
    document.getElementById('simulate-full-sequence-btn').innerHTML = 
        '<i class="fas fa-stop me-2"></i>Stop Sequence';
    document.getElementById('simulate-full-sequence-btn').classList.remove('btn-success');
    document.getElementById('simulate-full-sequence-btn').classList.add('btn-danger');
    
    // Clear any existing results
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card mt-3">
            <h5 class="text-center mb-3">Running Full Sequence Simulation</h5>
            <div id="sequence-progress" style="min-height: 300px;">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Running ${bits}-bit counter sequence (0 to ${binaryCounterState.maxValue})...</p>
                    <div class="progress mt-3">
                        <div id="sequence-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="sequence-step-info" class="mt-2">Step 0/${totalSteps}</p>
                </div>
            </div>
        </div>
    `;
    
    // Create visualization container
    const resultsDiv = document.getElementById('sequential2-results');
    
    // Run sequence with visualization
    binaryCounterState.sequenceInterval = setInterval(() => {
        // Simulate the clock pulse
        const oldValue = binaryCounterState.currentValue;
        const newValue = (oldValue + 1) % (binaryCounterState.maxValue + 1);
        binaryCounterState.currentValue = newValue;
        
        // Update binary display
        updateBinaryDisplay();
        
        // Update progress
        step++;
        const progressPercent = (step / totalSteps) * 100;
        document.getElementById('sequence-progress-bar').style.width = `${progressPercent}%`;
        document.getElementById('sequence-step-info').textContent = 
            `Step ${step}/${totalSteps} - Value: ${newValue} (${newValue.toString(2).padStart(bits, '0')})`;
        
        // Update visualization every few steps
        if (step % Math.max(1, Math.floor(totalSteps / 10)) === 0 || step === totalSteps) {
            updateSequenceVisualization(step, totalSteps, newValue);
        }
        
        // Update display
        updateDisplay();
        
        // Check if sequence is complete
        if (step >= totalSteps) {
            setTimeout(() => {
                stopSequence();
                
                // Show completion message
                resultsDiv.innerHTML = `
                    <div class="glass-card mt-3">
                        <h5 class="text-center mb-3">Full Sequence Completed!</h5>
                        <div class="text-center">
                            <div class="overflow-indicator mb-3">
                                <i class="fas fa-check-circle me-2"></i>Counter Overflow Occurred!
                            </div>
                            <p>The ${bits}-bit counter has completed a full cycle from 0 to ${binaryCounterState.maxValue}.</p>
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="gate-description">
                                        <h6>Sequence Summary</h6>
                                        <p>Total steps: ${totalSteps}</p>
                                        <p>Final value: ${newValue} (${newValue.toString(2).padStart(bits, '0')})</p>
                                        <p>Overflow: Yes</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="gate-description">
                                        <h6>Counter State</h6>
                                        <div class="d-flex justify-content-center mt-3">
                                            ${generateBitVisualization(newValue, bits)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary mt-3" onclick="showStepByStepAnalysis(${newValue})">
                                <i class="fas fa-list-ol me-2"></i>View Detailed Analysis
                            </button>
                        </div>
                    </div>
                `;
                
                showNotification('Full sequence completed! Counter overflow occurred.', 'success');
            }, 500);
        }
    }, 600); // 0.6 seconds per step for better visibility
}// Enhanced run full sequence function
function runFullSequence() {
    if (binaryCounterState.isRunning) {
        stopSequence();
        return;
    }
    
    binaryCounterState.isRunning = true;
    let step = 0;
    const totalSteps = binaryCounterState.maxValue + 1;
    const bits = binaryCounterState.bits;
    
    // Update button text
    const sequenceBtn = document.getElementById('simulate-full-sequence-btn');
    sequenceBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Stop Sequence';
    sequenceBtn.classList.remove('btn-success');
    sequenceBtn.classList.add('btn-danger');
    
    // Clear any existing results
    document.getElementById('sequential2-results').innerHTML = `
        <div class="glass-card mt-3">
            <h5 class="text-center mb-3">Running Full Sequence Simulation</h5>
            <div id="sequence-progress" style="min-height: 300px;">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Running ${bits}-bit counter sequence (0 to ${binaryCounterState.maxValue})...</p>
                    <div class="progress mt-3">
                        <div id="sequence-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="sequence-step-info" class="mt-2">Step 0/${totalSteps}</p>
                </div>
            </div>
        </div>
    `;
    
    // Create visualization container
    const resultsDiv = document.getElementById('sequential2-results');
    
    // Initialize sequence
    function runStep() {
        if (!binaryCounterState.isRunning) return;
        
        // Calculate new value
        const oldValue = binaryCounterState.currentValue;
        const newValue = (oldValue + 1) % (totalSteps);
        binaryCounterState.currentValue = newValue;
        
        // Update binary display
        updateBinaryDisplay();
        
        // Update progress
        step++;
        const progressPercent = (step / totalSteps) * 100;
        
        // Update progress elements
        const progressBar = document.getElementById('sequence-progress-bar');
        const stepInfo = document.getElementById('sequence-step-info');
        
        if (progressBar) {
            progressBar.style.width = `${progressPercent}%`;
        }
        if (stepInfo) {
            stepInfo.textContent = 
                `Step ${step}/${totalSteps} - Value: ${newValue} (${newValue.toString(2).padStart(bits, '0')})`;
        }
        
        // Update visualization every few steps or on significant steps
        const updateVisualization = step % Math.max(1, Math.floor(totalSteps / 8)) === 0 || 
                                  step === 1 || 
                                  step === totalSteps ||
                                  step % 4 === 0;
        
        if (updateVisualization && document.getElementById('sequence-progress')) {
            updateSequenceVisualization(step, totalSteps, newValue);
        }
        
        // Update display stats
        updateDisplay();
        
        // Check if sequence is complete
        if (step >= totalSteps) {
            // Complete the sequence
            completeSequence(newValue, bits, totalSteps);
        } else {
            // Continue to next step
            binaryCounterState.sequenceInterval = setTimeout(runStep, 600);
        }
    }
    
    // Start the sequence
    binaryCounterState.sequenceInterval = setTimeout(runStep, 100);
}
// Function to complete the sequence
function completeSequence(finalValue, bits, totalSteps) {
    // Clear the interval
    if (binaryCounterState.sequenceInterval) {
        clearTimeout(binaryCounterState.sequenceInterval);
        binaryCounterState.sequenceInterval = null;
    }
    
    binaryCounterState.isRunning = false;
    
    // Reset button
    const sequenceBtn = document.getElementById('simulate-full-sequence-btn');
    sequenceBtn.innerHTML = '<i class="fas fa-play me-2"></i>Run Full Sequence';
    sequenceBtn.classList.remove('btn-danger');
    sequenceBtn.classList.add('btn-success');
    
    // Show completion message
    const resultsDiv = document.getElementById('sequential2-results');
    resultsDiv.innerHTML = `
        <div class="glass-card mt-3">
            <h5 class="text-center mb-3">
                <i class="fas fa-check-circle text-success me-2"></i>
                Full Sequence Completed!
            </h5>
            <div class="text-center">
                <div class="overflow-indicator mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>Counter Overflow Occurred!
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="gate-description">
                            <h6>Sequence Summary</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="stats-card">
                                        <div class="stats-value">${totalSteps}</div>
                                        <small>Total Steps</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-card">
                                        <div class="stats-value">${finalValue}</div>
                                        <small>Final Value</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-card">
                                        <div class="stats-value">${bits}</div>
                                        <small>Bits</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Final Counter State -->
                <div class="gate-description mt-3">
                    <h6>Final Counter State</h6>
                    <div class="d-flex justify-content-center mt-3">
                        ${generateBitVisualization(finalValue, bits)}
                    </div>
                    <p class="text-center mt-2">
                        <strong>Binary:</strong> ${finalValue.toString(2).padStart(bits, '0')} 
                        | <strong>Decimal:</strong> ${finalValue}
                    </p>
                </div>
                
                <!-- Complete Sequence Table -->
                <div class="gate-description mt-3">
                    <h6>Complete Sequence (First 10 and Last 10 steps)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Step</th>
                                    <th>Clock</th>
                                    <th>Binary</th>
                                    <th>Decimal</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generateCompleteSequenceTable(bits, totalSteps)}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="d-grid gap-2 col-md-8 mx-auto mt-4">
                    <button class="btn btn-primary" onclick="showStepByStepAnalysis(${finalValue})">
                        <i class="fas fa-list-ol me-2"></i>View Detailed Step-by-Step Analysis
                    </button>
                    <button class="btn btn-info" onclick="showTruthTable()">
                        <i class="fas fa-table me-2"></i>Show Complete Truth Table
                    </button>
                    <button class="btn btn-warning" onclick="resetCounter()">
                        <i class="fas fa-redo me-2"></i>Reset Counter
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Show notification
    showNotification(`Full sequence completed! ${totalSteps} steps executed. Counter overflow occurred.`, 'success');
}

// Generate complete sequence table
function generateCompleteSequenceTable(bits, totalSteps) {
    let html = '';
    
    // Show first 10 steps
    for (let i = 0; i < Math.min(10, totalSteps); i++) {
        const binaryStr = i.toString(2).padStart(bits, '0');
        const isStart = i === 0;
        const isEnd = i === totalSteps - 1;
        
        html += `
            <tr class="${isStart ? 'table-success' : ''}">
                <td>${i}</td>
                <td>${i}</td>
                <td>${binaryStr}</td>
                <td>${i}</td>
                <td>${isStart ? '<span class="badge bg-success">Start</span>' : ''}</td>
            </tr>
        `;
    }
    
    // Add separator if there are more than 20 steps
    if (totalSteps > 20) {
        html += `
            <tr>
                <td colspan="5" class="text-center">
                    <i class="fas fa-ellipsis-h"></i> ... ${totalSteps - 20} steps hidden ... <i class="fas fa-ellipsis-h"></i>
                </td>
            </tr>
        `;
    }
    
    // Show last 10 steps
    const startLast = Math.max(10, totalSteps - 10);
    for (let i = startLast; i < totalSteps; i++) {
        const binaryStr = i.toString(2).padStart(bits, '0');
        const isMax = i === totalSteps - 1;
        
        html += `
            <tr class="${isMax ? 'table-danger' : ''}">
                <td>${i}</td>
                <td>${i}</td>
                <td>${binaryStr}</td>
                <td>${i}</td>
                <td>${isMax ? '<span class="badge bg-danger">Overflow</span>' : ''}</td>
            </tr>
        `;
    }
    
    return html;
}

// Stop sequence
function stopSequence() {
    if (binaryCounterState.sequenceInterval) {
        clearInterval(binaryCounterState.sequenceInterval);
        binaryCounterState.sequenceInterval = null;
    }
    binaryCounterState.isRunning = false;
    
    // Reset button text
    document.getElementById('simulate-full-sequence-btn').innerHTML = 
        '<i class="fas fa-play me-2"></i>Run Full Sequence';
}
// Helper function to generate bit visualization
function generateBitVisualization(value, bits) {
    const binaryStr = value.toString(2).padStart(bits, '0');
    let html = '';
    
    for (let i = bits - 1; i >= 0; i--) {
        const bit = binaryStr[bits - 1 - i];
        html += `
            <div class="text-center mx-1">
                <div class="counter-bit ${bit === '1' ? 'active' : 'inactive'}">
                    ${bit}
                </div>
                <div class="counter-bit-label">Q${i}</div>
            </div>
        `;
    }
    
    return html;
}

// Update sequence visualization
// Update the updateSequenceVisualization function to show ripple effect
function updateSequenceVisualization(step, totalSteps, currentValue) {
    const bits = binaryCounterState.bits;
    const progressPercent = (step / totalSteps) * 100;
    const binaryStr = currentValue.toString(2).padStart(bits, '0');
    
    // Calculate which bits changed (ripple effect)
    const oldValue = (currentValue === 0 ? binaryCounterState.maxValue : currentValue - 1);
    const oldBinary = oldValue.toString(2).padStart(bits, '0');
    const changedBits = [];
    
    for (let i = 0; i < bits; i++) {
        if (oldBinary[bits - 1 - i] !== binaryStr[bits - 1 - i]) {
            changedBits.push(i);
        }
    }
    
    const visualizationHTML = `
        <div class="glass-card mt-3">
            <h5 class="text-center mb-3">
                <i class="fas fa-sync-alt fa-spin text-primary me-2"></i>
                Sequence in Progress
            </h5>
            
            <!-- Progress Bar -->
            <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                     role="progressbar" style="width: ${progressPercent}%">
                    ${progressPercent.toFixed(1)}%
                </div>
            </div>
            
            <!-- Ripple Effect Visualization -->
            <div class="gate-description mt-3">
                <h6>Ripple Effect (Bit Changes)</h6>
                <div class="d-flex justify-content-center mt-2">
                    ${generateBitVisualizationWithRipple(currentValue, bits, changedBits)}
                </div>
                <p class="text-center mt-2">
                    <strong>Changed bits:</strong> ${changedBits.length > 0 ? 'Q' + changedBits.join(', Q') : 'None'}
                </p>
            </div>
            
            <!-- Current Step Info -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>Step Information</h6>
                        <p><strong>Step:</strong> ${step} of ${totalSteps}</p>
                        <p><strong>Progress:</strong> ${progressPercent.toFixed(1)}%</p>
                        <p><strong>Time elapsed:</strong> ${(step * 0.6).toFixed(1)}s</p>
                        <p><strong>Current Value:</strong> ${currentValue} (${binaryStr})</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="gate-description">
                        <h6>Next Expected</h6>
                        <p><strong>Next Value:</strong> ${(currentValue + 1) % (binaryCounterState.maxValue + 1)}</p>
                        <p><strong>Next Binary:</strong> ${((currentValue + 1) % (binaryCounterState.maxValue + 1)).toString(2).padStart(bits, '0')}</p>
                        <p><strong>Remaining Steps:</strong> ${totalSteps - step}</p>
                        <p><strong>Estimated Time:</strong> ${((totalSteps - step) * 0.6).toFixed(1)}s</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Steps -->
            <div class="mt-3">
                <h6>Recent Steps</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Binary</th>
                                <th>Decimal</th>
                                <th>Bit Changes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateRecentStepsWithRipple(step, currentValue, bits)}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    const progressContainer = document.getElementById('sequence-progress');
    if (progressContainer) {
        progressContainer.innerHTML = visualizationHTML;
    }
}
// Generate recent steps with ripple info
function generateRecentStepsWithRipple(currentStep, currentValue, bits) {
    let html = '';
    const startStep = Math.max(0, currentStep - 6);
    const endStep = Math.min(currentStep, binaryCounterState.maxValue + 1);
    
    for (let i = startStep; i <= endStep; i++) {
        const value = i % (binaryCounterState.maxValue + 1);
        const prevValue = (value === 0 ? binaryCounterState.maxValue : value - 1);
        const binaryStr = value.toString(2).padStart(bits, '0');
        const prevBinary = prevValue.toString(2).padStart(bits, '0');
        const isCurrent = i === currentStep;
        
        // Find changed bits
        const changedBits = [];
        for (let j = 0; j < bits; j++) {
            if (prevBinary[bits - 1 - j] !== binaryStr[bits - 1 - j]) {
                changedBits.push(j);
            }
        }
        
        html += `
            <tr class="${isCurrent ? 'table-primary' : ''}">
                <td>${i}</td>
                <td>${binaryStr}</td>
                <td>${value}</td>
                <td>
                    ${changedBits.length > 0 ? 
                      '<span class="badge bg-info">Q' + changedBits.join('</span> <span class="badge bg-info">Q') + '</span>' : 
                      '<span class="badge bg-secondary">None</span>'}
                </td>
            </tr>
        `;
    }
    
    return html;
}

// Add this CSS for better ripple animation
const rippleStyle = document.createElement('style');
rippleStyle.textContent = `
    .ripple-animation {
        animation: rippleEffect 0.6s ease-out;
    }
    
    @keyframes rippleEffect {
        0% { 
            transform: scale(0.9); 
            opacity: 0.7; 
            box-shadow: 0 0 0 0 rgba(34, 139, 34, 0.7);
        }
        50% { 
            transform: scale(1.2); 
            opacity: 1; 
            box-shadow: 0 0 0 10px rgba(34, 139, 34, 0);
        }
        100% { 
            transform: scale(1); 
            opacity: 1; 
            box-shadow: 0 0 0 0 rgba(34, 139, 34, 0);
        }
    }
    
    .sequence-step-highlight {
        background: linear-gradient(45deg, #ffd700, #ff8c00);
        color: white;
        font-weight: bold;
    }
    
    .counter-sequence-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 5px;
        margin: 15px 0;
    }
    
    .counter-sequence-item {
        padding: 8px;
        text-align: center;
        border-radius: 5px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .counter-sequence-item.current {
        background: #007bff;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
    }
    
    .counter-sequence-item.completed {
        background: #28a745;
        color: white;
    }
`;
document.head.appendChild(rippleStyle);

// Generate bit visualization with ripple effect
function generateBitVisualizationWithRipple(value, bits, changedBits) {
    const binaryStr = value.toString(2).padStart(bits, '0');
    let html = '';
    
    for (let i = bits - 1; i >= 0; i--) {
        const bit = binaryStr[bits - 1 - i];
        const isChanged = changedBits.includes(i);
        const animationDelay = changedBits.indexOf(i) * 100; // Stagger animation
        
        html += `
            <div class="text-center mx-1">
                <div class="counter-bit ${bit === '1' ? 'active' : 'inactive'} 
                     ${isChanged ? 'ripple-animation' : ''}" 
                     style="${isChanged ? `animation-delay: ${animationDelay}ms` : ''}">
                    ${bit}
                </div>
                <div class="counter-bit-label">Q${i}</div>
            </div>
        `;
    }
    
    return html;
}

// Generate recent steps table
function generateRecentStepsTable(currentStep, currentValue, bits) {
    let html = '';
    const startStep = Math.max(0, currentStep - 5);
    const endStep = Math.min(currentStep, binaryCounterState.maxValue + 1);
    
    for (let i = startStep; i <= endStep; i++) {
        const value = i % (binaryCounterState.maxValue + 1);
        const binaryStr = value.toString(2).padStart(bits, '0');
        const isCurrent = i === currentStep;
        
        html += `
            <tr class="${isCurrent ? 'table-primary' : ''}">
                <td>${i}</td>
                <td>${binaryStr}</td>
                <td>${value}</td>
                <td>${isCurrent ? '<span class="badge bg-info">Current</span>' : 
                     (i === binaryCounterState.maxValue ? '<span class="badge bg-warning">Max</span>' : 
                     (i === 0 ? '<span class="badge bg-secondary">Start</span>' : ''))}</td>
            </tr>
        `;
    }
    
    return html;
}

// Enhanced stop sequence function
function stopSequence() {
    if (binaryCounterState.sequenceInterval) {
        clearInterval(binaryCounterState.sequenceInterval);
        binaryCounterState.sequenceInterval = null;
    }
    binaryCounterState.isRunning = false;
    
    // Reset button text and style
    const btn = document.getElementById('simulate-full-sequence-btn');
    btn.innerHTML = '<i class="fas fa-play me-2"></i>Run Full Sequence';
    btn.classList.remove('btn-danger');
    btn.classList.add('btn-success');
}

// Also need to update the event listener for the clock toggle to work properly
document.getElementById('counter-clock-input').addEventListener('change', function() {
    const isOn = this.checked;
    document.getElementById('counter-clock-status').textContent = isOn ? 'ON' : 'OFF';
    document.getElementById('counter-clock-status').className = 
        isOn ? 'badge bg-success' : 'badge bg-secondary';
    
    if (isOn) {
        // Don't run if sequence is already running
        if (!binaryCounterState.isRunning) {
            simulateClockPulse();
        }
        // Auto-toggle off after simulation
        setTimeout(() => {
            this.checked = false;
            document.getElementById('counter-clock-status').textContent = 'OFF';
            document.getElementById('counter-clock-status').className = 'badge bg-secondary';
        }, 300);
    }
});

// Add CSS for sequence animation
const style = document.createElement('style');
style.textContent = `
    .sequence-step {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.9);
        border-left: 3px solid var(--info-color);
        transition: all 0.3s ease;
    }
    
    .sequence-step.current {
        border-left: 3px solid var(--success-color);
        background: rgba(34, 139, 34, 0.1);
        font-weight: bold;
    }
    
    .sequence-step.completed {
        border-left: 3px solid var(--primary-color);
        opacity: 0.7;
    }
    
    .ripple-animation {
        animation: rippleEffect 0.5s ease-out;
    }
    
    @keyframes rippleEffect {
        0% { transform: scale(0.8); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .counter-sequence {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 15px 0;
    }
    
    .counter-step {
        width: 50px;
        height: 50px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid var(--primary-color);
        transition: all 0.3s ease;
    }
    
    .counter-step.active {
        background: var(--success-color);
        color: white;
        transform: scale(1.1);
        box-shadow: 0 0 10px var(--success-color);
    }
    
    .counter-step.inactive {
        background: #f8f9fa;
        color: var(--dark-color);
    }
    
    .counter-step.current {
        border-color: var(--warning-color);
        box-shadow: 0 0 15px var(--warning-color);
    }
`;
document.head.appendChild(style);

// Show truth table
function showTruthTable() {
    const bits = binaryCounterState.bits;
    const maxValue = binaryCounterState.maxValue;
    
    let html = `
        <div class="glass-card mt-3">
            <h5 class="text-center mb-3">${bits}-bit Asynchronous Counter Truth Table</h5>
            <div class="table-responsive">
                <table class="table table-bordered truth-table">
                    <thead class="table-dark">
                        <tr>
                            <th>Clock Cycle</th>
    `;
    
    // Add column headers for each bit (MSB to LSB)
    for (let i = bits - 1; i >= 0; i--) {
        html += `<th>Q${i}</th>`;
    }
    html += `<th>Decimal</th></tr></thead><tbody>`;
    
    // Add rows for each value
    for (let i = 0; i <= maxValue; i++) {
        const binaryStr = i.toString(2).padStart(bits, '0');
        const binaryDigits = binaryStr.split('').join(' ');
        
        html += `<tr>
            <td class="fw-bold">${i}</td>
            <td>${binaryDigits.replace(/ /g, '</td><td>')}</td>
            <td class="fw-bold">${i}</td>
        </tr>`;
    }
    
    html += `</tbody></table></div></div>`;
    
    // Display in the right side results section
    document.getElementById('sequential2-results').innerHTML = html;
    document.getElementById('sequential2-results').style.display = 'block';
}

// Show circuit diagram
function showCircuitDiagram() {
    const bits = binaryCounterState.bits;
    
    let html = `
        <div class="glass-card mt-3">
            <h5 class="text-center mb-3">Asynchronous (Ripple) Counter Circuit Diagram</h5>
            <div class="circuit-diagram-container">
                <div class="text-center">
                    <p class="mb-3"><strong>${bits}-bit Ripple Counter (Q0 is LSB)</strong></p>
                    
                    <div class="mux-circuit">
                        <div class="flipflop-circuit">
    `;
    
    // Generate circuit diagram based on number of bits
    for (let i = 0; i < bits; i++) {
        html += `
            <div class="flipflop-body" style="top: ${30 + i * 70}px; left: 50%;">
                <div style="font-size: 0.8rem; text-align: center;">
                    <div>T-FF Q${i}</div>
                    <div class="small">T=1, CLK=${i === 0 ? 'CLK' : 'Q' + (i-1) + ''}</div>
                </div>
            </div>
            <div class="sequential-input-line" style="top: ${30 + i * 70}px; left: -60px; width: 60px;"></div>
            <div class="sequential-output-line" style="top: ${30 + i * 70}px; right: -60px; width: 60px;"></div>
            <div class="circuit-node" style="top: ${30 + i * 70}px; right: -90px;">
                Q${i}
            </div>
        `;
        
        if (i > 0) {
            html += `
                <div class="circuit-line" style="top: ${30 + (i-1) * 70}px; right: -60px; width: 30px; height: 6px; transform: rotate(90deg);"></div>
                <div class="circuit-line" style="top: ${30 + (i-1) * 70}px; right: -30px; width: 120px; height: 6px;"></div>
                <div class="circuit-line" style="top: ${30 + i * 70}px; left: -60px; width: 30px; height: 6px; transform: rotate(90deg);"></div>
            `;
        }
    }
    
    // Add clock input
    html += `
                        </div>
                        <div class="circuit-node" style="top: 30px; left: -90px; background: var(--danger-color);">
                            CLK
                        </div>
                        <div class="clock-symbol" style="top: 30px; left: -120px;">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
                <div class="gate-description mt-3">
                    <p><strong>Operation:</strong></p>
                    <ul class="mb-0">
                        <li>All T flip-flops have T=1 (toggle mode)</li>
                        <li>Q0 toggles on every falling edge of CLK</li>
                        <li>Q${bits > 1 ? '1' : ''} toggles on falling edge of Q${bits > 1 ? '0' : ''}</li>
                        <li>Ripple effect continues through all stages</li>
                        <li>Maximum count: ${binaryCounterState.maxValue} (${bits} bits)</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    
    // Display in the right side results section
    document.getElementById('sequential2-results').innerHTML = html;
    document.getElementById('sequential2-results').style.display = 'block';
}

// Show step-by-step analysis
function showStepByStepAnalysis(newValue) {
    const bits = binaryCounterState.bits;
    const oldValue = (newValue === 0 ? binaryCounterState.maxValue : newValue - 1);
    const oldBinary = oldValue.toString(2).padStart(bits, '0');
    const newBinary = newValue.toString(2).padStart(bits, '0');
    
    // Find which bits changed
    const changedBits = [];
    for (let i = 0; i < bits; i++) {
        if (oldBinary[bits - 1 - i] !== newBinary[bits - 1 - i]) {
            changedBits.push(i);
        }
    }
    
    let html = `
        <div class="glass-card mt-3">
            <h5 class="text-center mb-3">Step-by-Step Analysis</h5>
            <div class="calculation-step active">
                <div class="calculation-title">Clock Pulse Applied</div>
                <div class="calculation-content">
                    <p><strong>Previous Value:</strong> ${oldValue} (${oldBinary})</p>
                    <p><strong>New Value:</strong> ${newValue} (${newBinary})</p>
                    
                    <div class="bit-visualization mt-3">
                        <div class="d-flex justify-content-center mb-2">
    `;
    
    // Show old bits
    for (let i = bits - 1; i >= 0; i--) {
        const bit = oldBinary[bits - 1 - i];
        const isChanged = changedBits.includes(i);
        html += `
            <div class="text-center mx-2">
                <div class="register-bit ${bit === '1' ? 'active' : 'inactive'} ${isChanged ? 'shift-animation' : ''}">
                    ${bit}
                </div>
                <div class="register-bit-label">Q${i}</div>
            </div>
        `;
    }
    
    html += `
                        </div>
                        <div class="text-center mb-3">
                            <i class="fas fa-arrow-down"></i>
                            <span class="mx-3">Clock Pulse</span>
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="d-flex justify-content-center">
    `;
    
    // Show new bits
    for (let i = bits - 1; i >= 0; i--) {
        const bit = newBinary[bits - 1 - i];
        const isChanged = changedBits.includes(i);
        html += `
            <div class="text-center mx-2">
                <div class="register-bit ${bit === '1' ? 'active' : 'inactive'}">
                    ${bit}
                </div>
                <div class="register-bit-label">Q${i}</div>
            </div>
        `;
    }
    
    // Explain ripple effect
    if (changedBits.length > 0) {
        html += `
                        </div>
                        <div class="mt-3 gate-description">
                            <p><strong>Ripple Effect Analysis:</strong></p>
                            <ol class="mb-0">
        `;
        
        for (const bit of changedBits) {
            if (bit === 0) {
                html += `<li>Q0 toggled on falling edge of CLK</li>`;
            } else {
                html += `<li>Q${bit} toggled on falling edge of Q${bit-1}</li>`;
            }
        }
        
        html += `
                            </ol>
                        </div>
        `;
    }
    
    html += `
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Display in the right side results section
    document.getElementById('sequential2-results').innerHTML = html;
    document.getElementById('sequential2-results').style.display = 'block';
}

// Reset counter
function resetCounter() {
    stopSequence();
    
    // Get initial value
    const initialValue = parseInt(document.getElementById('counter-initial-value').value);
    binaryCounterState.currentValue = Math.min(initialValue, binaryCounterState.maxValue);
    
    // Reset display
    updateBinaryDisplay();
    
    // Clear results
    document.getElementById('sequential2-results').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-sort-numeric-up fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <h4 class="mt-3">Binary Asynchronous Counter</h4>
            <p>Counter has been reset to initial state</p>
            <p class="small text-muted">Click buttons on the left to perform operations</p>
        </div>
    `;
    
    showNotification('Counter reset to initial state', 'info');
}

// Close binary counter interface
function closeBinaryCounter() {
    stopSequence();
    document.getElementById('binary-counter-inputs').style.display = 'none';
    document.getElementById('sequential2-results').innerHTML = `
        <div class="text-center mt-5">
            <i class="fas fa-share-alt fa-4x" style="color: var(--primary-color); opacity: 0.3;"></i>
            <h4 class="mt-3">Advanced Sequential Circuit Operations</h4>
            <p>Select a component from the left to get started</p>
            <p class="small text-muted">Supports T Flip-Flop, Shift Register, Binary Counter, and other sequential components</p>
        </div>
    `;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Binary Counter button click
    document.getElementById('binary-counter-btn').addEventListener('click', function() {
        // Hide other inputs
        document.querySelectorAll('#sequential-circuit2-section .gate-description > div[id$="inputs"]').forEach(el => {
            el.style.display = 'none';
        });
        
        // Show binary counter inputs
        document.getElementById('binary-counter-inputs').style.display = 'block';
        
        // Initialize counter
        initBinaryCounter();
        
        // Update description
        document.getElementById('sequential2-description').innerHTML = `
            <strong>Asynchronous (Ripple) Binary Counter:</strong><br>
            A ${binaryCounterState.bits}-bit counter where each flip-flop toggles on the falling edge of the previous stage.
            Ripple effect causes propagation delay but requires fewer connections.
        `;
    });
    
    // Bit selection change
    document.getElementById('counter-bits-select').addEventListener('change', function() {
        updateCounterBits();
        updateDisplay();
    });
    
    // Initial value change
    document.getElementById('counter-initial-value').addEventListener('input', function() {
        binaryCounterState.currentValue = Math.min(
            parseInt(this.value) || 0, 
            binaryCounterState.maxValue
        );
        updateBinaryDisplay();
    });
    
    // Clock input toggle
    document.getElementById('counter-clock-input').addEventListener('change', function() {
        const isOn = this.checked;
        document.getElementById('counter-clock-status').textContent = isOn ? 'ON' : 'OFF';
        document.getElementById('counter-clock-status').className = 
            isOn ? 'badge bg-success' : 'badge bg-secondary';
        
        if (isOn) {
            simulateClockPulse();
            // Auto-toggle off after simulation
            setTimeout(() => {
                this.checked = false;
                document.getElementById('counter-clock-status').textContent = 'OFF';
                document.getElementById('counter-clock-status').className = 'badge bg-secondary';
            }, 300);
        }
    });
    
    // Simulate clock pulse button
    document.getElementById('simulate-clock-pulse-btn').addEventListener('click', simulateClockPulse);
    
    // Run full sequence button
    document.getElementById('simulate-full-sequence-btn').addEventListener('click', runFullSequence);
    
    // Show truth table button
    document.getElementById('show-counter-truth-table-btn').addEventListener('click', showTruthTable);
    
    // Show circuit diagram button
    document.getElementById('show-circuit-diagram-btn').addEventListener('click', showCircuitDiagram);
    
    // Step-by-step analysis button
    document.getElementById('step-by-step-analysis-btn').addEventListener('click', function() {
        showStepByStepAnalysis(binaryCounterState.currentValue);
    });
    
    // Reset counter button
    document.getElementById('reset-counter-btn').addEventListener('click', resetCounter);
    
    // Close button
    document.getElementById('close-counter-btn').addEventListener('click', closeBinaryCounter);
});

// Update display
function updateDisplay() {
    const bits = binaryCounterState.bits;
    
    // Update description
    document.getElementById('sequential2-description').innerHTML = `
        <strong>Asynchronous (Ripple) Binary Counter:</strong><br>
        A ${bits}-bit counter where each flip-flop toggles on the falling edge of the previous stage.
        Count range: 0 to ${binaryCounterState.maxValue}<br>
        Current value: ${binaryCounterState.currentValue}
    `;
    
    // Update result
    document.getElementById('sequential2-result').textContent = 
        `${binaryCounterState.currentValue} (${binaryCounterState.currentValue.toString(2).padStart(bits, '0')})`;
}
// Add this after the state variables section
class BooleanFunction {
    constructor(variables) {
        this.variables = variables;
        this.numVars = variables.length;
        this.minterms = [];
        this.maxterms = [];
    }
    
    setFromTruthTable(outputs) {
        if (outputs.length !== 2 ** this.numVars) {
            throw new Error(`Expected ${2 ** this.numVars} outputs for ${this.numVars} variables`);
        }
        
        this.minterms = [];
        this.maxterms = [];
        
        for (let i = 0; i < outputs.length; i++) {
            if (outputs[i] === 1) {
                this.minterms.push(i);
            } else if (outputs[i] === 0) {
                this.maxterms.push(i);
            } else {
                throw new Error(`Output must be 0 or 1, got ${outputs[i]} at index ${i}`);
            }
        }
    }
    
    setFromMinterms(minterms) {
        this.minterms = [...new Set(minterms)].sort((a, b) => a - b);
        const allTerms = new Set([...Array(2 ** this.numVars).keys()]);
        const mintermSet = new Set(this.minterms);
        this.maxterms = [...allTerms].filter(term => !mintermSet.has(term)).sort((a, b) => a - b);
    }
    
    setFromMaxterms(maxterms) {
        this.maxterms = [...new Set(maxterms)].sort((a, b) => a - b);
        const allTerms = new Set([...Array(2 ** this.numVars).keys()]);
        const maxtermSet = new Set(this.maxterms);
        this.minterms = [...allTerms].filter(term => !maxtermSet.has(term)).sort((a, b) => a - b);
    }
    
    getSOPExpression(useComplements = true) {
        if (this.minterms.length === 0) return "0";
        
        const terms = [];
        for (const minterm of this.minterms) {
            const termParts = [];
            for (let i = 0; i < this.numVars; i++) {
                const bit = (minterm >> (this.numVars - 1 - i)) & 1;
                if (bit === 1) {
                    termParts.push(this.variables[i]);
                } else {
                    termParts.push(useComplements ? `${this.variables[i]}'` : `NOT(${this.variables[i]})`);
                }
            }
            terms.push(termParts.join(""));
        }
        return terms.join(" + ");
    }
    
    getPOSExpression(useComplements = true) {
        if (this.maxterms.length === 0) return "1";
        
        const terms = [];
        for (const maxterm of this.maxterms) {
            const termParts = [];
            for (let i = 0; i < this.numVars; i++) {
                const bit = (maxterm >> (this.numVars - 1 - i)) & 1;
                if (bit === 0) {
                    termParts.push(this.variables[i]);
                } else {
                    termParts.push(useComplements ? `${this.variables[i]}'` : `NOT(${this.variables[i]})`);
                }
            }
            terms.push("(" + termParts.join(" + ") + ")");
        }
        return terms.join("  ");
    }
    
    getTruthTable() {
        const table = [];
        
        for (let i = 0; i < 2 ** this.numVars; i++) {
            const binary = i.toString(2).padStart(this.numVars, '0');
            const row = {};
            
            // Add variable values
            for (let j = 0; j < this.numVars; j++) {
                row[this.variables[j]] = parseInt(binary[j]);
            }
            
            // Check if this is a minterm
            row['Output'] = this.minterms.includes(i) ? 1 : 0;
            table.push(row);
        }
        
        return table;
    }
    
    generateTruthTableHTML() {
        const table = this.getTruthTable();
        let html = '<div class="kmap-table"><table class="table table-bordered">';
        
        // Header
        html += '<thead><tr>';
        this.variables.forEach(v => html += `<th>${v}</th>`);
        html += '<th>Output</th></tr></thead><tbody>';
        
        // Rows
        table.forEach(row => {
            html += '<tr>';
            this.variables.forEach(v => {
                const val = row[v];
                html += `<td class="${val ? 'table-success' : ''}">${val}</td>`;
            });
            html += `<td class="${row.Output ? 'table-success fw-bold' : ''}">${row.Output}</td></tr>`;
        });
        
        html += '</tbody></table></div>';
        return html;
    }
}
function clearMinimization() {
    document.getElementById('minterms-input').value = '';
    document.getElementById('dontcare-input').value = '';
    document.getElementById('boolean-expression-input').value = '';
    document.getElementById('minimization-result').textContent = 'Enter minterms or expression and click Minimize';
    document.getElementById('solution-steps').innerHTML = '';
    document.getElementById('kmap-visualization').style.display = 'none';
    document.getElementById('grouping-visualization').style.display = 'none';
    document.getElementById('canonical-forms-results').style.display = 'none';
    document.getElementById('kmap-container').innerHTML = '';
    document.getElementById('grouping-container').innerHTML = '';
    document.getElementById('sop-pos-container').innerHTML = '';
    
    addLog('Cleared all inputs and results', 'info');
}
// K-map Minimizer Class
class KMapMinimizer {
    constructor(variables = ['A', 'B', 'C']) {
        this.variables = variables;
        this.numVars = variables.length;
        this.minterms = [];
        this.dontCares = [];
    }
    
    setMinterms(minterms, dontCares = []) {
        this.minterms = minterms;
        this.dontCares = dontCares;
    }
    
    getGrayCode(n) {
        if (n === 0) return [''];
        const smaller = this.getGrayCode(n - 1);
        const sequence = [];
        for (const code of smaller) sequence.push('0' + code);
        for (const code of smaller.reverse()) sequence.push('1' + code);
        return sequence;
    }
    
    generateKmap() {
        const rows = 2 ** Math.floor(this.numVars / 2);
        const cols = 2 ** Math.ceil(this.numVars / 2);
        const rowCodes = this.getGrayCode(Math.floor(this.numVars / 2));
        const colCodes = this.getGrayCode(Math.ceil(this.numVars / 2));
        
        const grid = [];
        for (let i = 0; i < rows; i++) {
            const row = [];
            for (let j = 0; j < cols; j++) {
                const rowBits = rowCodes[i];
                const colBits = colCodes[j];
                const bits = rowBits + colBits;
                const minterm = parseInt(bits, 2);
                
                if (this.minterms.includes(minterm)) {
                    row.push('1');
                } else if (this.dontCares.includes(minterm)) {
                    row.push('X');
                } else {
                    row.push('0');
                }
            }
            grid.push(row);
        }
        
        return { grid, rows, cols, rowCodes, colCodes };
    }
    
    findPrimeImplicants() {
        const allTerms = [...this.minterms, ...this.dontCares];
        const binaryTerms = allTerms.map(m => format(m.toString(2).padStart(this.numVars, '0')));
        
        // Group by number of 1s
        const groups = {};
        binaryTerms.forEach((binary, idx) => {
            const ones = binary.count('1');
            if (!groups[ones]) groups[ones] = [];
            groups[ones].push({ binary, minterms: [allTerms[idx]] });
        });
        
        return this._combineImplicants(groups);
    }
    
    _combineImplicants(groups) {
        const primeImplicants = [];
        
        while (true) {
            const newGroups = {};
            const used = new Set();
            
            const sortedKeys = Object.keys(groups).map(Number).sort((a, b) => a - b);
            for (let i = 0; i < sortedKeys.length - 1; i++) {
                const key1 = sortedKeys[i];
                const key2 = sortedKeys[i + 1];
                
                if (Math.abs(key1 - key2) !== 1) continue;
                
                for (const term1 of groups[key1]) {
                    for (const term2 of groups[key2]) {
                        let diffCount = 0;
                        let diffPos = -1;
                        
                        for (let k = 0; k < this.numVars; k++) {
                            if (term1.binary[k] !== term2.binary[k]) {
                                diffCount++;
                                diffPos = k;
                            }
                        }
                        
                        if (diffCount === 1) {
                            const newBinary = term1.binary.split('');
                            newBinary[diffPos] = '-';
                            const newBinaryStr = newBinary.join('');
                            const newMinterms = [...new Set([...term1.minterms, ...term2.minterms])].sort((a, b) => a - b);
                            
                            const ones = newBinaryStr.count('1');
                            if (!newGroups[ones]) newGroups[ones] = [];
                            newGroups[ones].push({ binary: newBinaryStr, minterms: newMinterms });
                            
                            used.add(term1);
                            used.add(term2);
                        }
                    }
                }
            }
            
            // Add unused terms as prime implicants
            Object.values(groups).forEach(group => {
                group.forEach(term => {
                    if (!used.has(term)) {
                        primeImplicants.push(term);
                    }
                });
            });
            
            if (Object.keys(newGroups).length === 0) break;
            groups = newGroups;
        }
        
        return primeImplicants;
    }
    
    findEssentialImplicants(primeImplicants) {
        // Simplified essential implicant finding
        const essential = [];
        const covered = new Set();
        
        primeImplicants.forEach(imp => {
            const expression = this.binaryToExpression(imp.binary);
            essential.push({
                binary: imp.binary,
                expression: expression,
                minterms: imp.minterms
            });
            
            imp.minterms.forEach(m => covered.add(m));
        });
        
        return essential;
    }
    
    binaryToExpression(binary) {
        const parts = [];
        for (let i = 0; i < this.numVars; i++) {
            if (binary[i] === '0') {
                parts.push(`${this.variables[i]}'`);
            } else if (binary[i] === '1') {
                parts.push(this.variables[i]);
            }
        }
        return parts.join('');
    }
    
    getSimplifiedExpression() {
        const primeImplicants = this.findPrimeImplicants();
        const essential = this.findEssentialImplicants(primeImplicants);
        
        if (essential.length === 0) {
            return this.minterms.length === 0 ? '0' : '1';
        }
        
        const expressions = essential.map(imp => imp.expression).filter(exp => exp !== '');
        
        if (expressions.length === 0) {
            return '1';
        }
        
        // Remove duplicates and sort
        const uniqueExpressions = [...new Set(expressions)].sort();
        
        // Check if expression is always true
        const totalMinterms = 2 ** this.numVars;
        if (this.minterms.length === totalMinterms) {
            return '1';
        }
        
        return uniqueExpressions.join(' + ');
    }
}

// Boolean Algebra Simplifier Class
class BooleanAlgebraSimplifier {
    simplify(expression) {
        // Remove spaces and convert to uppercase
        let expr = expression.replace(/\s+/g, '').toUpperCase();
        
        // Split by OR operations
        const terms = expr.split('+').filter(term => term !== '');
        
        if (terms.length === 0) return '0';
        
        // Simplify each term
        const simplifiedTerms = [];
        for (const term of terms) {
            const simplified = this._simplifyTerm(term);
            if (simplified && !simplifiedTerms.includes(simplified)) {
                simplifiedTerms.push(simplified);
            }
        }
        
        // Apply absorption law
        const finalTerms = this._applyAbsorption(simplifiedTerms);
        
        if (finalTerms.length === 0) return '0';
        if (finalTerms.length === 1 && finalTerms[0] === '') return '1';
        
        return finalTerms.join(' + ');
    }
    
    _simplifyTerm(term) {
        const variables = new Set();
        const complements = new Set();
        
        let i = 0;
        while (i < term.length) {
            const char = term[i];
            if (i + 1 < term.length && term[i + 1] === "'") {
                // Complemented variable
                if (variables.has(char)) {
                    return ''; // A.A' = 0
                }
                complements.add(char);
                i += 2;
            } else {
                // Regular variable
                if (complements.has(char)) {
                    return ''; // A.A' = 0
                }
                variables.add(char);
                i += 1;
            }
        }
        
        // Build the simplified term
        const result = [];
        for (const v of Array.from(variables).sort()) {
            result.push(v);
        }
        for (const v of Array.from(complements).sort()) {
            result.push(v + "'");
        }
        
        return result.join('');
    }
    
    _applyAbsorption(terms) {
        const result = [];
        
        for (let i = 0; i < terms.length; i++) {
            let isAbsorbed = false;
            for (let j = 0; j < terms.length; j++) {
                if (i !== j && this._isSubset(terms[j], terms[i])) {
                    isAbsorbed = true;
                    break;
                }
            }
            if (!isAbsorbed && terms[i] !== '' && !result.includes(terms[i])) {
                result.push(terms[i]);
            }
        }
        
        return result;
    }
    
    _isSubset(term1, term2) {
        if (!term1 || !term2) return false;
        
        const vars1 = this._extractVariables(term1);
        const vars2 = this._extractVariables(term2);
        
        // Check if all variables in term1 are in term2
        for (const v of vars1) {
            if (!vars2.has(v)) {
                return false;
            }
        }
        return true;
    }
    
    _extractVariables(term) {
        const vars = new Set();
        let i = 0;
        
        while (i < term.length) {
            const char = term[i];
            if (i + 1 < term.length && term[i + 1] === "'") {
                vars.add(char + "'");
                i += 2;
            } else {
                vars.add(char);
                i += 1;
            }
        }
        
        return vars;
    }
}

// Helper function to add count method to String prototype
if (!String.prototype.count) {
    String.prototype.count = function(char) {
        return this.split(char).length - 1;
    };
}

// Helper function for formatting
function format(binary) {
    return binary;
}

        // Add entry to operation log
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('operation-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            logContainer.appendChild(logEntry);
            
            // Scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Limit log entries
            const logEntries = logContainer.querySelectorAll('.log-entry');
            if (logEntries.length > 10) {
                logEntries[0].remove();
            }
        }
    </script>
</body>
</html>